!X-RAY CROSS SECTION IS NOT IMPLEMENTED !!!PLEASE ADD 3NOV NEW SUBROUTINES 
!DR. M K GUPTA, DEPARTMENT OF MECHANICAL ENGINEERING AND MATERIAL SCIENCE, DUKE UNIVERSITY
!ISSUE  OF MSD1 IS SOLVED, LAMMPS TRAJECTORY PROCESSING IS IMPLEMENTED,,MINOR BUG NED TO BE FIXED ON 25 APRIL 2020, DUKE UNIVERSITY NC
!VON HOVE IS IMPLEMENTED JUNE 27 DUKE UNIVERSITY 
!HAVEN RATIO IS IMPLEMENTED UNDER VVACF1 JULY 2020
!DIFFUSION COEFFICIENT FROM VVACF1 IS IMPLEMENTED JULY 2020
!THERMAL CONDUCTIVITY IMPLEMENTED 20JULY 2020 DUKE UNIVERSITY
!SPECIFIC HEAT CALCULATION FROM PHONON DOS IS IMPLEMENTED 
!JUMP ANALYSIS FOR SIMPLE SYSTEM BASED ON SPHERICAL SITES OF A GIVEN RADIUS IS IMPLEMENTED SUNROUTIE RESIDENCENSPS2

!!!!!!!!!!!!!ISSUE  OF MSD1 IS SOLVED, LAMMPS TRAJECTORY PROCESSING IS IMPLEMENTED,,MINOR BUG NED TO BE FIXED ON 25 APRIL 2020, DUKE UNIVERSITY NC
!!!!!!!!!!!!!VON HOVE IS IMPLEMENTED JUNE 27 DUKE UNIVERSITY
!!!!!!!!!!!!!  

!HAPPY HALLOWEEN
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!



MODULE VARIABLES3
!DOUBLE PRECISION::QQMIN1,QQMAX1 !,QQSTEP
!INTEGER::IQQQ,IILIST,KI
!DOUBLE PRECISION,DIMENSION(3)::KSTART,KEND,DELK
!INTEGER::KN1,KN2,KN3,IP,IPATH,KI1,KI2,KI3,ISTART,NNQ
DOUBLE PRECISION,DIMENSION(3,3)::PLAT,SPLAT,IPLAT,ISPLAT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::PRPOS,POSS
INTEGER,DIMENSION(3,3)::SSIZE
DOUBLE PRECISION::RCHECK
DOUBLE PRECISION,DIMENSION(3)::RDEL
DOUBLE PRECISION::PVOLUME,SVOLUME
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::RRDEL
INTEGER::KK
END MODULE 




MODULE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::POS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::AVGPOS ,POSSTART
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::MSDPOS,MSDPOS1
!DOUBLE PRECISION,ALLOCATABLE ,DIMENSION(:)::MSDAVG
DOUBLE PRECISION,DIMENSION(3,3)::SLAT,ISLAT,AVGSLAT,ISLAT1,SLAT1,AVGISLAT,SLATORIG,ISLATORIG
DOUBLE PRECISION,DIMENSION(3)::DEL,APOS,AVPOS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::VEL

!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::VACF,FTW,FTWT
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::VACFT,FTWTB,FTWI,FTWTI
INTEGER,PARAMETER::TEXP=2,YEXP=2025
INTEGER::IIYR,IIMON,IIDAY
INTEGER::NSTEPORIG
CHARACTER*25::FLNM
DOUBLE PRECISION::PI
INTEGER,ALLOCATABLE,DIMENSION(:)::NNTYPE
INTEGER::NATOM,NSTEP,NSTEPI,TAO,DT,NTYP,OINT,NSTEP1,NSTEP2
INTEGER::IT,IVACF,ISOFT,TREF,I,J,K,N1,N2,IJ,IK,ISIF3,IT1,IW
DOUBLE PRECISION::FWHM,FWHM0,FWHM1,DELW,OMEGA,DELT,TIME,PHASE
DOUBLE PRECISION::ANORM1,ANORM2,ANORM3
INTEGER::IREF1,IREF2
INTEGER::ERROR
INTEGER::IDOS,IGRR,INTEGR
INTEGER::NR,LL
DOUBLE PRECISION::DELR
INTEGER::NUM_THREADS
INTEGER::ISQT
DOUBLE PRECISION::R0,RM
DOUBLE PRECISION,DIMENSION(1000)::GRTOTAL,GAVG
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::GRRTAVG,GRRTAVGXRAY,GRRTAVGNEUTRON
!INTEGER::NX1,NY1,NZ1
REAL::THE0,DELTH,RC1,RC2,RC3
INTEGER,DIMENSION(100,3)::INDEX1
INTEGER::MAXINDEX,NTHETA,IANGLE,NSIZE
REAL,ALLOCATABLE,DIMENSION(:,:,:)::ANGLEIJKT,AVGANG
REAL,ALLOCATABLE,DIMENSION(:,:,:,:)::THETA
REAL,ALLOCATABLE,DIMENSION(:,:)::RR1
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::BB,BBT,BBT2,MASS,MASST,CBBT,IBBT,IBBT2,ZELE,XRAY
INTEGER::HMAX,KMAX,LMAX
INTEGER::IDIFF,NPDOS
DOUBLE PRECISION::CONS
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::NWPDOS
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::NWDOS
INTEGER::IVEL,IWRITE !,ICOH
DOUBLE PRECISION::FWHM2
CHARACTER*5,ALLOCATABLE,DIMENSION(:)::ATMNM
INTEGER::ICARTESIAN
INTEGER::NQPOINT,ISQW
DOUBLE PRECISION::QWIDTH,QAVG
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::GPOS
INTEGER::INTERVAL,IINTERVAL,IPOINTS,INTERVAL2
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::SCALL
INTEGER::ITYP,IITYP
INTEGER::ILIST,ICOH
INTEGER::IMSD,IFFT
DOUBLE PRECISION::RMAX,THETAMAX
INTEGER::NDOS
INTEGER::NN1,NN2
INTEGER::CATOM,SATOM,IPOLY
DOUBLE PRECISION::BOND,DR0,RSTEP
INTEGER::IIII
DOUBLE PRECISION,DIMENSION(3)::AX1,AX2,AX3
DOUBLE PRECISION::NPOW,DELE
INTEGER::IBROAD
INTEGER::IVON,IREFF
LOGICAL::ASTATUS
INTEGER::IRECORD
REAL::GRCUT
INTEGER::INDIVIDUAL
INTEGER::ID
DOUBLE PRECISION::QQMIN,QQMAX,QQSTEP
INTEGER::NSTEPIV,NSTEPINT,NRPOINTS
INTEGER::NCORD
REAL,ALLOCATABLE,DIMENSION(:,:,:,:,:)::TPOS
INTEGER::NCUB
DOUBLE  PRECISION,ALLOCATABLE,DIMENSION(:,:)::KLIST
!REAL,DIMENSION(0:180,0:1000)::PROBTHETAR  !(ITH,RBIN)=PROBTHETAR(ITH,RBIN)+1
REAL,ALLOCATABLE,DIMENSION(:,:,:,:)::NPROBTHETAR  !(ITH,RBIN)=PROBTHETAR(ITH,RBIN)+1
INTEGER::IDIFFUSE
DOUBLE PRECISION,DIMENSION(9)::DATA1
DOUBLE PRECISION::VOL0
DOUBLE PRECISION::f0
INTEGER::IKAPPA,NTETRA,ITETRA,IRESIDENCE
DOUBLE PRECISION::TEMPER,TEMPERATURE
INTEGER::ISKIP,ISKEW,NMOL,ICUT
!COMPLEX,DIMENSION(0:100,0:100,0:100)::DIFF 
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:,:)::DIFF 
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:,:)::QQQ
COMPLEX,ALLOCATABLE,DIMENSION(:,:)::DIFF2T 
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQQ2
INTEGER::NMAX11,NMAX21,NMAX31
INTEGER::NMAX12,NMAX22,NMAX32,IQMAX
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::CCBBT,ZZELE
integer::IDD1,IDD2,IDD3,DN1,DN2,DN3,NX1,NX2,NX3  !,id2,id3
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::SINC,SCOH,SSINC,SSCOH
INTEGER::IFREE , IANGULAR,IPROB
INTEGER,DIMENSION(3)::NSS
INTEGER,ALLOCATABLE,DIMENSION(:,:)::MAP
INTEGER,ALLOCATABLE,DIMENSION(:)::PNTYPE,SNTYPE
DOUBLE PRECISION::VOLUME
INTEGER::NDIM
DOUBLE PRECISION,DIMENSION(3,3)::NSSD
DOUBLE PRECISION::RHO0
INTEGER::IPOLYVOL
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::POLYVOL
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::TAREA !POLYVOL
INTEGER::NPOLY
INTEGER,ALLOCATABLE,DIMENSION(:,:)::SID,PSID !POLYVOL
INTEGER,ALLOCATABLE,DIMENSION(:)::TCOUNTER
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::PPVOL
INTEGER,DIMENSION(1000,3)::INDTRI
                DOUBLE PRECISION::RMINCHECK
END MODULE





PROGRAM  MD_ANALYSIS
USE omp_lib
USE VARIABLES1
!USE IFPORT
IMPLICIT NONE
INTEGER::J1,NK
!INTEGER::ID1,I1,I2,I3,I4,NBINT
INTEGER::ID1,I1,I2,I3,I4,I5,I6,NBINT
INTEGER::IR1,IR2,IR3,IR4,IR5,IR6
DOUBLE PRECISION::PVOL,AR1,GAR
real::start,finish
INTEGER,ALLOCATABLE,DIMENSION(:)::NNBINT
INTEGER,ALLOCATABLE,DIMENSION(:)::NNCORD 

!LOGICAL(4) result

call cpu_time(start)

CALL HELLO(IIYR,IIMON,IIDAY)
ISKIP=1
INDIVIDUAL=0
IDIFFUSE=0
ISKEW=0
DIFF=0
PRINT*,'INDIVIDUAL DOS WILL NOT PRINT'

!PROBTHETAR=0
!!!!!!!!!!!!!!INPUT INPUT INPUT INPUT INPUT INPUT INPUT INPUT SECTION!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!11
IPOINTS=0
CONS=1.
PI=4*ATAN(1.0)
OPEN(1,FILE="INP_MD2023")
PRINT*,'NEW VERSION IBROAD 1 and 2'
READ(1,*)FLNM,num_threads,ISOFT,IVEL,IWRITE,IFFT,IBROAD,ID
OPEN(2,FILE=FLNM)
READ(1,*)NMOL

READ(1,*)ISIF3,IVACF,IANGLE,IDIFF,IGRR,ISQW,IMSD,IPOLY,IVON,IPROB,IRESIDENCE,IKAPPA,IDIFFUSE,IFREE,IANGULAR,IPOLYVOL          !!!
PRINT *,"DOS,ANGLE,Diffraction,SQE,MSD,VAN-HOVE,POLY,PROB"
PRINT*,IVACF,IANGLE,IDIFF,IGRR,ISQW,IMSD,IVON,IPOLY
IF(IGRR==1)THEN
CALL SYSTEMQQ('rm GRTAVG.DAT')
CALL SYSTEMQQ('rm GRT.DAT')
END IF
IF(IDIFF==1)THEN
CALL SYSTEMQQ('rm HKL')
END IF
IF(IVACF==1)OPEN(82,FILE="DOS.DAT")
IF(IVACF==1)OPEN(81,FILE="DOSXYZ.DAT")
IF(IGRR==1)OPEN(111,FILE="GRT.DAT")
IF(IGRR==1)OPEN(83,FILE="GRTAVG.DAT")
IF(IVACF==1)OPEN(85,FILE="NWDOS")
IF(IVACF==1)OPEN(86,FILE="CV")
IF(IVACF==1)OPEN(103,FILE="KIN_TEMP.DAT")
READ(1,*)NTYP
ALLOCATE(NNTYPE(NTYP),BBT(NTYP),BBT2(NTYP),MASST(NTYP),ZELE(NTYP),XRAY(NTYP))
ALLOCATE(ATMNM(NTYP))
ALLOCATE(SCALL(NTYP))
!ALLOCATE(CBBT(NATOM))
!ALLOCATE(IBBT(NATOM))
ALLOCATE(IBBT2(NTYP))
ALLOCATE(SINC(NTYP),SCOH(NTYP))
!ALLOCATE(SSINC(NATOM),SSCOH(NATOM))
READ(1,*)ATMNM
DO I=1,NTYP
CALL DATABASE(ATMNM(I))
BBT(I)=DATA1(3)         !Coherent length
IBBT2(I)=DATA1(4)       !Incoherent Length
BBT2(I)=DATA1(7)        !cross section   
MASST(I)=DATA1(1)       !Mass  
ZELE(I)=DATA1(9)        !Z
SINC(I)=DATA1(6)
SCOH(I)=DATA1(5)
CALL DATAX(ATMNM(I))
XRAY(I)=f0

PRINT*,ATMNM(I),'MASS,Z,b_coh,b_Inc,Sigma_T,Sigma_INC'
PRINT 124,ATMNM(I),MASST(I),ZELE(I),BBT(I),IBBT2(I),BBT2(I),SINC(I) !'MASS,Z,b_coh,b_Inc,Sigma_T
124 FORMAT(A4,6F15.5)
END DO
READ(1,*)NNTYPE
READ(1,*)IREF1,IREF2,DELT,NSTEPI,OINT,INTERVAL
!READ(1,*)IREF1,IREF2,DELT,INTERVAL
NSTEP=IREF2-IREF1+1
NATOM=SUM(NNTYPE)
ALLOCATE(BB(NATOM),MASS(NATOM))
ALLOCATE(CBBT(NATOM))
ALLOCATE(IBBT(NATOM))
ALLOCATE(SSINC(NATOM),SSCOH(NATOM))


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!SMALL TRCIK FOR DIFFUSE!!!!!!!!
 ! NCUB=INT(NSTEP**(1.0/3.0))
 !IF(IDIFFUSE==1)ALLOCATE(TPOS(NCUB,NCUB,NCUB,NATOM,3))
 !PRINT*,'NCUB',nCUB
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
NSTEPORIG=IREF2-IREF1+1
!NSTEPORIG=NSTEP
IF(IFFT==1)THEN
NSTEPORIG=IREF2-IREF1+1
NPOW=LOG(REAL(NSTEPORIG))/log(2.0) !0.6930  !/0.30102999566
PRINT*,NPOW
NPOW=INT(NPOW)
NPOW=NPOW+1
NSTEP=NSTEPORIG
IF(IVACF.NE.0.OR.ISQW.NE.0.OR.IANGULAR.NE.0)NSTEP=2**NPOW 



PRINT*,'NPOW',NPOW
PRINT*,'NEW NSTEP IS',NSTEP
END IF
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!11
READ(1,*)R0,RMAX,DELR
NR=INT((RMAX-R0)/DELR)
PRINT*,'NR',NR
DELE=4.136/REAL(DELT*NSTEP)
NDOS=200
PRINT*,'DELE in meV=',DELE
IF(IVACF==1)PRINT*,'NDOS in meV'
IF(IVACF==1)READ*,NDOS

NDOS=INT(NDOS/DELE)
NDOS=MIN(NDOS,NSTEP)
IF(ISQW.NE.0)NDOS=NSTEP
PRINT*,NDOS



READ(1,*)RC1,RC2 !,RC3                 !!!!!!!!RC3 is maximim range for ANGLECAL2
READ(1,*)MAXINDEX
DO I=1,MAXINDEX
READ(1,*)INDEX1(I,:)
END DO
DO I=1,NTYP
DO J=SUM(NNTYPE(1:I-1))+1,SUM(NNTYPE(1:I))
MASS(J)=MASST(I) !/(4*PI))
CBBT(J)=BBT(I)             !!!!!!!!!!!!!!!!
IBBT(J)=IBBT2(I)
SSINC(J)=SINC(I)
SSCOH(J)=SCOH(I)
END DO
END DO
!PRINT*,MASS
READ(1,*)HMAX,KMAX,LMAX
READ(1,*)FWHM0,FWHM1
!!!!!!!!!!!!!!!!!!!SQW PARAMETERS!!!!!!!!!!!!!!!!!!!
READ(1,*)ICOH,ILIST,ICUT
READ(1,*)NQPOINT,QWIDTH,QAVG,FWHM2
IF(ISQW==1)THEN
IF(ILIST==3)CALL SYSTEMQQ('rm SQETOTAL')
IF(ILIST==3)CALL SYSTEMQQ('rm CSQETOTAL')
IF(ILIST==33)CALL SYSTEMQQ('rm CSQETOTAL')
IF(ILIST==3)CALL SYSTEMQQ('rm ISQETOTAL')
IF(ILIST==4)CALL SYSTEMQQ('rm SEDTOTAL')
IF(ILIST==44)CALL SYSTEMQQ('rm SEDTOTAL')
IF(ILIST==444)CALL SYSTEMQQ('rm SEDTOTAL')
IF(ILIST==4444)CALL SYSTEMQQ('rm SEDTOTAL')
IF(ILIST==5)CALL SYSTEMQQ('rm SQEMAP')
IF(ILIST==7)CALL SYSTEMQQ('rm ACOUSTIC')
END IF
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
READ(1,*)CATOM,SATOM,BOND,DR0,RSTEP,NCORD,INTERVAL2
READ(1,*)AX1
READ(1,*)AX2
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!IF LAMMPS
!IF(ISOFT==3.OR.ISOFT==0)THEN
!READ(1,*)SLAT(1,:)
!READ(1,*)SLAT(2,:)
!READ(1,*)SLAT(3,:)
!CALL DETER(SLAT,VOL0)
!SLATORIG=SLAT
!ISLATORIG=TRANSPOSE(SLATORIG) !!!!!!!!!!!!!!!!CHECK LATER IF TRANSPOSE IS NEEDED
!CALL GAUSS(ISLATORIG,3)
!ELSE
!READ(1,*)
!READ(1,*)
!READ(1,*)
!END IF
READ(1,*),QQMIN,QQMAX,QQSTEP,NQPOINT
READ(1,*)NSTEPIV,NSTEPINT,NRPOINTS
READ(1,*)TEMPER   !FOR KAPPA CALCULATION
READ(1,*)NTETRA,ITETRA,RMINCHECK !FOR RESIDENCE CALCULATION!,
READ(1,*)NSSD(1,:)!,NSSD(2,:),NSSD(3,:)
READ(1,*)NSSD(2,:)!,NSSD(2,:),NSSD(3,:)
READ(1,*)NSSD(3,:)!,NSSD(2,:),NSSD(3,:)
READ(1,*)NPOLY
PRINT*,'SUPERCELL DIMENSION'
PRINT*,NSSD(1,:)
PRINT*,NSSD(2,:)
PRINT*,NSSD(3,:)

IF(IDIFFUSE==1)THEN
 !IF(IDIFFUSE==1)ALLOCATE(DIFF(ABS(NMAX12-NMAX11)+1,  ABS(NMAX21-NMAX22)+1 , ABS(NMAX31-NMAX32)+1,NTYP))
 !IF(IDIFFUSE==1)ALLOCATE(QQQ(ABS(NMAX12-NMAX11)+1,  ABS(NMAX21-NMAX22)+1 , ABS(NMAX31-NMAX32)+1,3))
! ALLOCATE(DIFF2(IQMAX,NATOM))
 READ(1,*)NMAX11,NMAX12
 READ(1,*)NMAX21,NMAX22
 READ(1,*)NMAX31,NMAX32
 !IQMAX=(ABS(NMAX12-NMAX11)+1) *(  ABS(NMAX21-NMAX22)+1) *( ABS(NMAX31-NMAX32)+1 )
 IQMAX=(ABS(NMAX12-NMAX11)+1) *( ABS(NMAX31-NMAX32)+1 )
 PRINT*,'IQMAX=',IQMAX
 ALLOCATE(DIFF2T(IQMAX,NTYP))
 ALLOCATE(QQQ2(3,IQMAX))
 DIFF2T=0
 QQQ2=0
 IK=0
  DO IDD1=NMAX11,NMAX12 !0,NX
!  DO IDD2=NMAX21,NMAX22 !0,NY
  DO IDD3=NMAX31,NMAX32 !0,NZ 
  IK=IK+1
  QQQ2(:,IK)=(/ REAL(IDD1),REAL(IDD1),REAL(IDD3)/)
  !QQQ2(:,IK)=MATMUL(QQQ2(:,IK),ISLAT) !(/ REAL(IDD1),REAL(IDD2),REAL(IDD3)/)
  END DO
!  END DO
  END DO  
END IF


IF(IDIFFUSE.GT.1)THEN
 READ(1,*)NMAX11,NMAX12,DN1
 READ(1,*)NMAX21,NMAX22,DN2
 READ(1,*)NMAX31,NMAX32,DN3
 NX1=(ABS(NMAX12-NMAX11))/DN1 +1
 NX2=(ABS(NMAX22-NMAX21) )/DN2 +1
 NX3=(ABS(NMAX32-NMAX31) )/DN3  +1

 IQMAX=NX1*NX2*NX3  !(ABS(NMAX12-NMAX11)/DN1  +1) *(  ABS(NMAX21-NMAX22)/DN2  +1) *( ABS(NMAX31-NMAX32)/DN3  +1 )
!# IQMAX=(ABS(NMAX12-NMAX11)/DN1  +1) *(  ABS(NMAX21-NMAX22)/DN2  +1) *( ABS(NMAX31-NMAX32)/DN3  +1 )
 PRINT*,'IQMAX=',IQMAX
 ALLOCATE(DIFF2T(IQMAX,NTYP))
 ALLOCATE(QQQ2(3,IQMAX))
 DIFF2T=0
 QQQ2=0
 IK=0
  DO IDD1=NMAX11,NMAX12,DN1 !0,NX
  DO IDD2=NMAX21,NMAX22,DN2 !0,NY
  DO IDD3=NMAX31,NMAX32,DN3 !0,NZ 
  IK=IK+1
  QQQ2(:,IK)=(/ REAL(IDD1),REAL(IDD2),REAL(IDD3)/)
  !QQQ2(:,IK)=MATMUL(QQQ2(:,IK),ISLAT) !(/ REAL(IDD1),REAL(IDD2),REAL(IDD3)/)
  END DO
  END DO
  END DO  
!ALLOCATE(DIFF(ABS(NMAX12-NMAX11)+1,  ABS(NMAX21-NMAX22)+1 , ABS(NMAX31-NMAX32)+1,NTYP))
!ALLOCATE(QQQ(ABS(NMAX12-NMAX11)+1,  ABS(NMAX21-NMAX22)+1 , ABS(NMAX31-NMAX32)+1,3))

END IF



  !F(IDIFFUSE==1)ALLOCATE(QQQ2(ABS(NMAX12-NMAX11)+1,  ABS(NMAX21-NMAX22)+1 , ABS(NMAX31-NMAX32)+1,3))
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

IF(IKAPPA==0.AND.IDIFFUSE==0)THEN
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
ALLOCATE(POS(NSTEP,NATOM,3))  !,POSR(NATOM,3))
ALLOCATE(GPOS(NATOM,3))
ALLOCATE(AVGPOS(NATOM,3))
ALLOCATE(VEL(NSTEP,NATOM,3))
ALLOCATE(POSSTART(NATOM,3))
ALLOCATE(GRRTAVG(0:1000,NTYP,NTYP))
ALLOCATE(GRRTAVGXRAY(0:1000,NTYP,NTYP))
ALLOCATE(GRRTAVGNEUTRON(0:1000,NTYP,NTYP))
IF(IANGLE==1)ALLOCATE(ANGLEIJKT(NTYP,NTYP,NTYP),AVGANG(NTYP,NTYP,NTYP),THETA(-180:180,NTYP,NTYP,NTYP))
ALLOCATE(RR1(NATOM,3))
POS=0
GPOS=0
AVGPOS=0
VEL=0
GRRTAVG=0
ANGLEIJKT=0
AVGANG=0
THETA=0
IT=0
VEL=0
GRTOTAL=0.0
GAVG=0.0
AVGANG=0
THETA=0
POS=0
END IF
IF(IDIFFUSE.NE.0)THEN
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
ALLOCATE(POS(NSTEP,NATOM,3))  !,POSR(NATOM,3))
!ALLOCATE(GPOS(NATOM,3))
!ALLOCATE(AVGPOS(NATOM,3))
!ALLOCATE(VEL(NSTEP,NATOM,3))
!ALLOCATE(POSSTART(NATOM,3))
!ALLOCATE(GRRTAVG(0:1000,NTYP,NTYP))
!IF(IANGLE==1)ALLOCATE(ANGLEIJKT(NTYP,NTYP,NTYP),AVGANG(NTYP,NTYP,NTYP),THETA(-180:180,NTYP,NTYP,NTYP))
!ALLOCATE(RR1(NATOM,3))
POS=0
END IF


PRINT*,'READING WILL START'
!IF(IIYR.GT.YEXP)CALL SLEEP(1810)
IF(IKAPPA==0)THEN
         IF(ISOFT==1)CALL VASP
         IF(ISOFT==2)CALL DL_POLY
        ! IF(ISOFT==3)CALL LAMMPS 
         IF(ISOFT==3)CALL LAMMPS2021 
         IF(ISOFT==4)CALL GPUMD2021 
         !PAUSE
         IF(IVACF==1.AND.IFFT==1)CALL VVACF5 
         IF(IVACF==1.AND.IFFT==0)CALL VVACF2 
         !IF(IVACF==1.AND.IFFT==0)CALL FFTW 
         !IF(IVACF==1.AND.IFFT==0)CALL NEUTRON
         !IF(IDOS==1)CALL FFTW
         !IF(IDOS==1)CALL NEUTRON
         !CALL IFQT
         !IF(ISQW==1)CALL IIFQT
         !IF(IMSD==1.AND.IFFT==1)CALL MSD4
         CALL ADP
         IF(IMSD==1.AND.IFFT==1)CALL MSD4
         IF(IMSD==1.AND.IFFT==0)CALL MSD4
         !IF(IANGLE==1)CALL ANGLECAL
         IF(IPOLY==1.AND.ISOFT>0)CALL POLYN2021
         IF(IPOLY==1)CALL INERTIA 
         IF(IVON==1.OR.IVON==3)THEN
         !CALL VONHOVE_PAIR(1)
         DO IREFF=1,NTYP
         CALL VONHOVE_SELF(IREFF)
         END DO
         END IF

        DO I=1,NTYP
        DO J=I,NTYP
        PRINT*,I,J
         IF(IVON==2.oR.IVON==3)CALL VONHOVE_PAIRADV(I,J)
         !IF(IVON==2.oR.IVON==3)CALL VONHOVE_PAIR_ADV(I,J)
         !IF(IVON==2.oR.IVON==3)CALL NEWVONHOVE_PAIR_ADV3d(I,J)
         !IF(IVON==4)CALL NEWVONHOVE_PAIR_ADV3dgrid(I,J)
         !IF(IVON==4)CALL NEWVONHOVE_PAIR_ADV3dgrid2(I,J)
        END DO
        END DO

         !IF(IREFF.NE.0)CALL CHGCAR(IREFF)
         !IF(IREFF.NE.0)CALL CHGCAR2021(IREFF)
         !IF(IREFF.NE.0)CALL CHGCAR2022(IREFF)
         IF (IPROB==1) THEN

        PRINT*, 'SUPERCELL DIMENSION'
PRINT*,NSSD(1,:)
PRINT*,NSSD(2,:)
PRINT*,NSSD(3,:)

!        PRINT*,NSS
         DO IREFF=1,NTYP
         CALL CHGCAR2022(IREFF)
         END DO
         CALL CHGCAR2022TOTAL
         END IF
!         IF(IREFF.NE.0)CALL  DIFFUSE2021  !(IREFF)

!         IF(IRESIDENCE==1)CALL RESIDENCENSPS2
         IF(IRESIDENCE==1)CALL RESIDENCE_FINAL 
         IF(ISQW==1)CALL QRANGE_SELECTION(ILIST)
         !CALL DIFFUSE
         !NK=12
         !CALL CUPSE2
         !CALL CUPSE
         !CALL ANGLECAL2
         !DO J1=SUM(NNTYPE(1:INDEX1(1,1)-1))+1,SUM(NNTYPE(1:INDEX1(1,1)))
         !END DO
         !CALL MSD3
        !CALL JUMPRADIAL
       ! CALL POLYVOL
        ! CALL JUMPRADIAL_POLY
        !IF(IANGULAR==1)CALL ANGULAR2021
        IF(IANGULAR==1)CALL ANGULAR !2021
 END IF

!IF(IFREE.NE.0)CALL CALCULATE_FREE(IFREE)
IF(IFREE.NE.0)CALL CALCULATE_FREE2(IFREE)
!CALL PATTERSON_Unfolded
!IF(IDIFF==1)CALL DIFFRACTION
!IF(IFREE.NE.0)CALL CALCULATE_FREE2(IFREE)
!CALL PATTERSON_Unfolded
IF(IDIFF==1)CALL DIFFRACTION
IF(IDIFF==2)CALL DIFFRACTIONT
IF(IDIFF==3)CALL DIFFRACTIONTS

!IF(IDIFFUSE==1)CALL DIFFUSE2022 !#########################
IF(IDIFFUSE==1)CALL DIFFUSE2022 !#########################
IF(IDIFFUSE==2)CALL DIFFUSE2022N !#########################
IF(IDIFFUSE==3)CALL PARALLEL_DIFFUSE2022 !#########################
!IF(IDIFFUSE==2)CALL NEWDIFFUSE2021 !#########################
!CALL PATTERSON



!CALL ANGULARDOS 
!CALL ANGULARDOS2 

!!!!!!!!!!!!!!!!!!USE TETRAINDEX AT t=0 or first step 
IF(IPOLYVOL==1)THEN
        PRINT*,'I M IN POLY VOL'
        POLYVOL=0
        TAREA=0
        ALLOCATE(POLYVOL(NPOLY,2048))
        ALLOCATE(TAREA(NPOLY,4,2048))
        OPEN(2356,FILE="TETRAINDEX")
        OPEN(2357,FILE="TETRAVOL")
                DO I=1,NPOLY
                READ(2356,*,END=100)ID1,I1,I2,I3,I4
                !PRINT 2358,ID1,I1,I2,I3,I4
                2358 FORMAT(6I6)
                DO IT=1,IREF2-IREF1+1
                CALL CVOLUME2022(IT,I1,I2,I3,I4,PVOL)
                NBINT=INT(PVOL/0.1)
                IF(NBINT<2049)POLYVOL(I,NBINT)=POLYVOL(I,NBINT)+1


                !!!!!!!!!!!!!!!!!!!!AREA SCAN
                CALL CAREA2022(IT,I1,I2,I3,AR1)
                NBINT=INT(AR1/0.1)
                IF(NBINT<2049)TAREA(I,1,NBINT)=TAREA(I,1,NBINT)+1

                CALL CAREA2022(IT,I2,I3,I4,AR1)
                NBINT=INT(AR1/0.1)
                IF(NBINT<2049)TAREA(I,2,NBINT)=TAREA(I,2,NBINT)+1

                CALL CAREA2022(IT,I3,I4,I1,AR1)
                NBINT=INT(AR1/0.1)
                IF(NBINT<2049)TAREA(I,3,NBINT)=TAREA(I,3,NBINT)+1

                CALL CAREA2022(IT,I4,I1,I2,AR1)
                NBINT=INT(AR1/0.1)
                IF(NBINT<2049)TAREA(I,4,NBINT)=TAREA(I,1,NBINT)+1

                END DO
                END DO







                DO J=1,2048 !NBIN
                WRITE(2357,2357)REAL(J*0.1),POLYVOL(:,J)/REAL(IREF2-IREF1+1)

                WRITE(2358,2357)REAL(J*0.1),((TAREA(K,1,J)/REAL(IREF2-IREF1+1),TAREA(K,2,J)/REAL(IREF2-IREF1+1),TAREA(K,3,J)/REAL(IREF2-IREF1+1),TAREA(K,4,J)/REAL(IREF2-IREF1+1)),K=1,NPOLY)
                END DO
                2357 FORMAT(F10.5,10000(F10.5,1x))
                100 CONTINUE 
END IF
!!!!!!!!!!!!!!!!!!USE TETRAINDEX AT t=0 or first step 
IF(IPOLYVOL==2)THEN
        PRINT*,'I M IN POLY VOL2'
        POLYVOL=0
        ALLOCATE(POLYVOL(NPOLY,2048))
        !ALLOCATE(TAREA(NPOLY,4,2048))
        OPEN(2356,FILE="TETRAINDEX")
        OPEN(2357,FILE="TETRAVOL")
                DO I=1,NPOLY
                READ(2356,*,END=101)ID1,IR1,IR2,IR3,IR4,IR5,IR6
                !2358 FORMAT(6I6)
                DO IT=1,IREF2-IREF1+1
                CALL SORTER(IT,IR1,IR2,IR3,IR4,IR5,IR6,PVOL)
                NBINT=INT(PVOL/0.1)
                IF(NBINT<2049)POLYVOL(I,NBINT)=POLYVOL(I,NBINT)+1
                END DO
                END DO
                DO J=1,2048 !NBIN
                WRITE(2357,2357)REAL(J*0.1),POLYVOL(:,J)/REAL(IREF2-IREF1+1)
                !WRITE(2358,2357)REAL(J*0.1),((TAREA(K,1,J),TAREA(K,2,J),TAREA(K,3,J),TAREA(K,4,J)),K=1,NPOLY)
                END DO
                101 CONTINUE


END IF



!!!!!!!!!!!!!!!!!!UPDATE THE TETRAINDEX AT EACH STEP !!!!!!!!THIS IS FOR
!OCTHEDRAL VOLUME CALCULATION NEED To INSTALL QCONVEX 
IF(IPOLYVOL==3)THEN
        PRINT*,'I M IN POLY VOL3'
        POLYVOL=0
        ALLOCATE(POLYVOL(NPOLY,2048))
        ALLOCATE(SID(NPOLY,6))
        ALLOCATE(PSID(NPOLY,6))
        ALLOCATE(TCOUNTER(NPOLY))
        ALLOCATE(PPVOL(NPOLY))
        ALLOCATE(NNBINT(NPOLY))
        ALLOCATE(NNCORD(NPOLY))
        OPEN(2357,FILE="TETRAVOL")
        OPEN(2360,FILE="AVGTETRAVOL")
        OPEN(2358,FILE="TETRAVOL_Vs_T")
        TCOUNTER=0
        PPVOL=0
        CALL SYSTEMQQ('rm vol')

                        DO IT=1,IREF2-IREF1+1,INTERVAL2
                        CALL INDEXER(IT,SID,NNCORD)  !!!!!!!!!!!!!!!!!MAKE SURE ABOUTCATOM,SATOM, and NCORD ARE CORRECT IN INPUT
                                DO I=1,NPOLY
                                !IF(ANY(SID(I,:).EQ.0.0).OR.ANY(SID(I,:).GT.10.0))SID(I,:)=PSID(I,:)
!PRINT 1258,IT,I,SID(I,:) ! ATMID
                                IF(ANY(SID(I,:).EQ.0).or.ANY(SID(I,:).EQ.1000))SID(I,:)=PSID(I,:)
                                1256 FORMAT(7I7)
!PRINT 1258,IT,I,SID(I,:) ! ATMID
1258 FORMAT(8I7)
                                CALL JAYGURUDEV(IT,SID(I,1),SID(I,2),SID(I,3),SID(I,4),SID(I,5),SID(I,6))
                                !PRINT 2359,REAL(IT),SID(I,:)
                                PSID(I,:)=SID(I,:)
                                END DO
                         WRITE(2361,2361)REAL(IT*DELT),NNCORD !INTERVAL2*SUM( POLYVOL(:,J)/REAL(IREF2-IREF1+1))/REAL(NPOLY) ! REAL(IREF2-IREF1+1)
                         2361 FORMAT(F10.5,1000I7)
                         WRITE(2399,2359)REAL(IT*DELT),SID(1,:)-96 !PPVOL(1) !PVOL !POLYVOL(:,J)/REAL(IREF2-IREF1+1)
                         END DO
                         PPVOL=0
                         OPEN(1258,FILE="vol")
                         rewind(2399)
                         
                         !GO TO 12589

                         DO IT=1,IREF2-IREF1+1,INTERVAL2
                         !DO I=1,NPOLY
                         READ(1258,*)PPVOL !(I)
                         READ(2399,*)GAR,SID(1,:) !PPVOL!(I)
                         NNBINT=INT(PPVOL/0.1)
                         !IF(NBINT<2049)POLYVOL(:,NBINT)=POLYVOL(I,NBINT)+1
                         where(NNBINT.GE.2049)NNBINT=1
                         POLYVOL(:,NNBINT)=POLYVOL(:,NNBINT)+1
                         !END DO
                         WRITE(2358,2357)REAL(IT*DELT),PPVOL !POLYVOL(:,J)/REAL(IREF2-IREF1+1)
                         WRITE(2359,2359)REAL(IT*DELT),SID(1,:),PPVOL(1) !PVOL !POLYVOL(:,J)/REAL(IREF2-IREF1+1)
                         2359 FORMAT(F10.5,6I8,10000(F10.5,1x))
                         !END IF
                         END DO
                         12589 CONTINUE

                DO J=1,2048 !NBIN
                WRITE(2357,2357)REAL(J*0.1),INTERVAL2*POLYVOL(:,J)/REAL(IREF2-IREF1+1)
                WRITE(2360,2357)REAL(J*0.1),INTERVAL2*SUM( POLYVOL(:,J)/REAL(IREF2-IREF1+1))/REAL(NPOLY) ! REAL(IREF2-IREF1+1)
                END DO
                !101 CONTINUE
END IF

IF(IPOLYVOL==33)THEN
        PRINT*,'I M IN POLY VOL3'
        POLYVOL=0
        ALLOCATE(POLYVOL(NPOLY,2048))
        ALLOCATE(SID(NPOLY,6))
        ALLOCATE(PSID(NPOLY,6))
        ALLOCATE(TCOUNTER(NPOLY))
        ALLOCATE(PPVOL(NPOLY))
        OPEN(2357,FILE="TETRAVOL")
        OPEN(2360,FILE="AVGTETRAVOL")
        OPEN(2358,FILE="TETRAVOL_Vs_T")
        TCOUNTER=0
        PPVOL=0

                        DO IT=1,IREF2-IREF1+1
                                CALL INDEXER(IT,SID,NNCORD)  !!!!!!!!!!!!!!!!!MAKE SURE ABOUTCATOM,SATOM, and NCORD ARE CORRECT IN INPUT
                                !IF(ANY(SID.EQ.0).EQ..FALSE.)THEN !SID=PSID
                                IF(ANY(SID.EQ.0))SID=PSID
                                DO I=1,1 !NPOLY
                                PRINT 1256,IT,SID(I,:)
                                !1256 FORMAT(7I7)
                                CALL SORTERN(IT,SID(I,1),SID(I,2),SID(I,3),SID(I,4),SID(I,5),SID(I,6),PVOL)
                                !PPVOL(I)=PVOL
                                !TCOUNTER(I)=TCOUNTER(I)+1
                                !NBINT=INT(PVOL/0.1)
                                !IF(NBINT<2049)POLYVOL(I,NBINT)=POLYVOL(I,NBINT)+1
                                END DO
                                !WRITE(2358,2357)REAL(IT*DELT),PPVOL !POLYVOL(:,J)/REAL(IREF2-IREF1+1)
                                !WRITE(2359,2359)REAL(IT*DELT),SID(1,:),PPVOL(1) !PVOL !POLYVOL(:,J)/REAL(IREF2-IREF1+1)
                                !2359 FORMAT(F10.5,6I8,10000(F10.5,1x))
                                !END IF
                                PSID=SID
                        END DO
                DO J=1,2048 !NBIN
                WRITE(2357,2357)REAL(J*0.1),POLYVOL(:,J)/REAL(TCOUNTER) ! REAL(IREF2-IREF1+1)
                WRITE(2360,2357)REAL(J*0.1),SUM( POLYVOL(:,J)/REAL(TCOUNTER))/REAL(NPOLY) ! REAL(IREF2-IREF1+1)
                END DO
                !101 CONTINUE
END IF



!!!!!!!!!!!!!!!!!!$$$$$$$$$$$$$$$$$$##########################
IF(IKAPPA==0.AND.IDIFFUSE==0) DEALLOCATE(POS,VEL,GRRTAVG,RR1)
 !DEALLOCATE(FTW,FTWT,FTWTB,VACFT,VEL,VACF,AVGPOS, stat=error)
IF(IKAPPA==0.AND.IDIFFUSE==0) DEALLOCATE(VEL,AVGPOS, stat=error)
IF(IKAPPA==0.AND.IANGLE==1)DEALLOCATE(ANGLEIJKT,THETA)
IF(IDIFFUSE.NE.0)DEALLOCATE(QQQ2,DIFF2T,POS)

! IF(IKAPPA==1)CALL KAPPA4
! IF(IKAPPA==1)CALL KAPPA6
! IF(IKAPPA==1)CALL KAPPA5
call cpu_time(finish)
print '("Time= ",f12.3, "seconds.")',finish-start

END   !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!MAIN BODY

SUBROUTINE DETANGLE(av1,av2,ad2)
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(3)::av1,av2,av3,av4
DOUBLE PRECISION::PI,ad2,av5
!DOUBLE PRECISION,EXTERNAL::cross
PI=4.0*ATAN(1.0)
av3(1) = av1(2) * av2(3) - av1(3) * av2(2)
av3(2) = av1(3) * av2(1) - av1(1) * av2(3)
av3(3) = av1(1) * av2(2) - av1(2) * av2(1)
av4=av3/norm2(av3)
av5=dot_product(av4,av3)
ad2=180*atan2(av5,dot_product(av1,av2))/PI
!print*,av1
!print*,av2
!print*,ad2
END SUBROUTINE


SUBROUTINE DETANGLE2(av1,av2,ad2)
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(3)::av1,av2,av3,av4
DOUBLE PRECISION::PI,ad2,av5
!DOUBLE PRECISION,EXTERNAL::cross
PI=4.0*ATAN(1.0)
av3(1) = av1(2) * av2(3) - av1(3) * av2(2)
av3(2) = av1(3) * av2(1) - av1(1) * av2(3)
av3(3) = av1(1) * av2(2) - av1(2) * av2(1)
!av4=av3/norm2(av3)
!av1=av1/norm2(av1)
!av2=av2/norm2(av2)

av5=dot_product(av1,av2) /norm2(av1)/norm2(av2)
!print*
!print*,av5
if(av5.gt.1)av5=1
if(av5.lt.-1)av5=-1
ad2=180*acos(av5)/PI
!print*,av1
!print*,av2
!print*,ad2
END SUBROUTINE

SUBROUTINE ANGLECAL
use omp_lib
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(NATOM,NATOM)::R1,R2 !,RC1,RC2
DOUBLE PRECISION,DIMENSION(NATOM,NATOM,3)::VEC1,VEC2
INTEGER::I1,I2,J1,J2,K1,K2,ITH
INTEGER::II,JJ,KK
INTEGER,DIMENSION(NTYP,NTYP,NTYP)::PAIR1
REAL::T2,T1
DOUBLE PRECISION,DIMENSION(NATOM)::ANGLE
INTEGER::RBIN,TBIN
DOUBLE PRECISION, DIMENSION(3) :: rtemp
DOUBLE PRECISION,EXTERNAL::CROSS
PRINT*, "I M IN ANGLE ",IT
!RC1=1.6
!RC2=2.0
!RMAX=3.0
!THETA=0
!PRINT*,NSTEP 
!AVGANG=0
!DO IT=1,NSTEP
!WRITE(12,*)IT
ANGLEIJKT=0
PAIR1=0
ANGLE=0
R1=0
R2=0
VEC1=0
VEC2=0
TBIN=0
PRINT*,IT
!$omp parallel do
        DO I=1,NATOM
                DO J=1,NATOM
                VEC1(I,J,:)=POS(IT,J,:)-POS(IT,I,:)
                VEC1(I,J,:)=MATMUL(VEC1(I,J,:),ISLAT)
                VEC1(I,J,1)=VEC1(I,J,1) - ANINT(VEC1(I,J,1))
                VEC1(I,J,2)=VEC1(I,J,2) - ANINT(VEC1(I,J,2))
                VEC1(I,J,3)=VEC1(I,J,3) - ANINT(VEC1(I,J,3))
                VEC1(I,J,:)=MATMUL(VEC1(I,J,:),SLAT)
                R1(I,J)=SQRT(DOT_PRODUCT(VEC1(I,J,:),VEC1(I,J,:)))
                IF(R1(I,J).LE.RC2.AND.R1(I,J).GE.RC1)THEN
                        DO K=1,NATOM
                        IF(K.NE.I.AND.K.NE.J.AND.I.NE.J)THEN    
                        VEC2(I,K,:)=POS(IT,K,:)-POS(IT,I,:)
                        VEC2(I,K,:)=MATMUL(VEC2(I,K,:),ISLAT)
                        VEC2(I,K,1)=VEC2(I,K,1) - ANINT(VEC2(I,K,1))
                        VEC2(I,K,2)=VEC2(I,K,2) - ANINT(VEC2(I,K,2))
                        VEC2(I,K,3)=VEC2(I,K,3) - ANINT(VEC2(I,K,3))
                        VEC2(I,K,:)=MATMUL(VEC2(I,K,:),SLAT)
                        R2(I,K)=SQRT(DOT_PRODUCT(VEC2(I,K,:),VEC2(I,K,:)))
                        IF(R2(I,K).LE.RC2.AND.R2(I,K).GE.RC1)THEN

                        !ANGLE(J,I,K)=DOT_PRODUCT(VEC1(I,J,:),VEC2(I,K,:))/(R1(I,J)*R2(I,K))
                        !ANGLE(J,I,K)=ACOS(ANGLE(J,I,K))*180/PI
                        !ANGLE(I)=DOT_PRODUCT(VEC1(I,J,:),VEC2(I,K,:))/(R1(I,J)*R2(I,K))
                        !ANGLE(I)=ACOS(ANGLE(I))*180/PI
!			RTEMP(I)=CROSS(VEC1(I,J,:),VEC2(I,J,:))
!			RTEMP(I)=RTEMP(I)/NORM2(RTEMP(I))
!		        CALL DETER(RTEMP,ANGLE(I))
			!PRINT*,'Hi'			
			!PRINT*,VEC1(I,J,:)
			!PRINT*,VEC2(I,K,:)
			CALL DETANGLE2(VEC1(I,J,:),VEC2(I,K,:),ANGLE(I))
                        !PRINT*,VEC1(i,j,:)
                        !PRINT*,VEC2(i,k,:)
                        !print*,ANGLE(I)
                        !PAUSE
                                DO II=1,NTYP
                                        DO JJ=1,NTYP
                                                DO KK=1,NTYP
                                                   I1=SUM(NNTYPE(1:II-1))+1
                                                   I2=SUM(NNTYPE(1:II))
                                                   J1=SUM(NNTYPE(1:JJ-1))+1
                                                   J2=SUM(NNTYPE(1:JJ))
                                                   K1=SUM(NNTYPE(1:KK-1))+1
                                                   K2=SUM(NNTYPE(1:KK))
                                                   IF(I.GE.I1.AND.I.LE.I2.AND.J.GE.J1.AND.J.LE.J2.AND.K.GE.K1.AND.K.LE.K2)THEN
                                                   !ANGLEIJKT(JJ,II,KK)=ANGLEIJKT(JJ,II,KK)+ANGLE(J,I,K)
                                                   ANGLEIJKT(JJ,II,KK)=ANGLEIJKT(JJ,II,KK)+ANGLE(I)
                                                   PAIR1(JJ,II,KK)=PAIR1(JJ,II,KK)+1
                                                   T1=0
                                                   T2=0
						   TBIN=INT(ANGLE(I))  !/REAL(DELTH))
						   !PRINT*,'TBIN',TBIN
						   !PAUSE	
						   !PRINT*,TBIN,ANGLE(I),DELTH !R2(I,K)
                                                   !IF(TBIN.GE.0)THETA(TBIN,JJ,II,KK)=THETA(TBIN,JJ,II,KK)+1.0
                                                   THETA(TBIN,JJ,II,KK)=THETA(TBIN,JJ,II,KK)+1.0
						   !RBIN=INT(R2(I,K)/0.1)
						   !IF(TBIN.GE.0)PROBTHETAR(TBIN,RBIN)=PROBTHETAR(TBIN,RBIN)+1
						   
                                                           !DO ITH=1,NTHETA !200
                                                           !T2= THE0 + (ITH+1)*DELTH
                                                           !T1= THE0 +  ITH*DELTH
                                                           !IF(ANGLE(J,I,K).LT.T2.AND.ANGLE(J,I,K).GE.T1)THEN
                                                           !IF(ANGLE(I).LT.T2.AND.ANGLE(I).GE.T1)THEN
                                                           !THETA(ITH,JJ,II,KK)=THETA(ITH,JJ,II,KK)+1.0
!                                                          PRINT 41,ANGLE,THETA(ITH,JJ,II,KK),ITH,JJ,II,KK
                                                           !41  FORMAT(2F15.5,6I5)
                                                           !END IF                                                                                                                                      

                                                          !END DO


                                                    END IF
                                                 END DO        
                                          END DO
                                  END DO

!                        WRITE(12,12)J,I,K,ANGLE,R1,R2
                        12 FORMAT(3I4,10(F10.4,2x))
                        END IF
                        END IF
                        END DO  
                        !PAUSE
                END IF
                END DO
        END DO
!$omp end parallel do     

        ANGLEIJKT=ANGLEIJKT/MAX(PAIR1,1)
        AVGANG=AVGANG+ANGLEIJKT



END SUBROUTINE












!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!DLPOLY!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

SUBROUTINE DL_POLY              !!!!!!!!!!!DL_POLY READING
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(3)::AA
CHARACTER*50::ABC2

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

!$ call omp_set_num_threads(num_threads)
!PRINT*,'NJUMP'
PRINT*,'READING DLPOLY'
!READ*,NJUMP

IF(IWRITE==1)OPEN(3,FILE="XDATCARNEW.DAT")
TIME=0
LL=0
3 FORMAT(3F18.10)
2 FORMAT(A40)
POS=0
AVGPOS=0
READ(2,*)
READ(2,*)
TIME=0
DO IT=1,NSTEP
TIME=TIME+1
        READ(2,*,END=99)
        READ(2,*)SLAT(1,:)
        READ(2,*)SLAT(2,:)
        READ(2,*)SLAT(3,:)
	IF(IWRITE==1)THEN
	WRITE(3,3)SLAT(1,:)
	WRITE(3,3)SLAT(2,:)
	WRITE(3,3)SLAT(3,:)
	WRITE(3,*)NNTYPE
	END IF


!        AVGSLAT=AVGSLAT+SLAT
        SLAT=TRANSPOSE(SLAT)
        ISLAT=SLAT
        CALL GAUSS(ISLAT,3)

        IF(IT.GE.IREF1.AND.IT.LT.IREF2)THEN
        LL=LL+1
        AVGSLAT=AVGSLAT+SLAT
        END IF


        DO I=1,NATOM
                
                READ(2,*)!ATMNM
                !PRINT*,ATMNM
                READ(2,*)POS(IT,I,:)
                IF(IVEL==1)THEN
                READ(2,*)VEL(IT,I,:)
                END IF

                POS(IT,I,:)=MATMUL(POS(IT,I,:),ISLAT)
                IF(IT.GT.1)THEN
                POS(IT-1,I,:)=MATMUL(POS(IT-1,I,:),ISLAT1)
                AA=POS(IT,I,:)-POS(IT-1,I,:)
                IF(AA(1).LE.-0.5)POS(IT,I,1)=POS(IT,I,1)+1
                IF(AA(2).LE.-0.5)POS(IT,I,2)=POS(IT,I,2)+1
                IF(AA(3).LE.-0.5)POS(IT,I,3)=POS(IT,I,3)+1
                IF(AA(1).GE.+0.5)POS(IT,I,1)=POS(IT,I,1)-1
                IF(AA(2).GE.+0.5)POS(IT,I,2)=POS(IT,I,2)-1
                IF(AA(3).GE.+0.5)POS(IT,I,3)=POS(IT,I,3)-1
                GPOS(I,:)=POS(IT,I,:)     
		
                
                   IF(IWRITE==1.AND.IT.GE.IREF1.AND.IT.LE.IREF2)WRITE(3,3)POS(IT,I,:)
                   !POS(IT-1,I,:)=MATMUL(SLAT1,POS(IT-1,I,:))
                   POS(IT-1,I,:)=MATMUL(POS(IT-1,I,:),SLAT1)
                   ENDIF
                   IF(IT.GE.IREF1.AND.IT.LT.IREF2)THEN 
                   AVGPOS(I,:)=AVGPOS(I,:)+GPOS(I,:)
                   END IF
                   !POS(IT,I,:)=MATMUL(SLAT,POS(IT,I,:))
                   POS(IT,I,:)=MATMUL(POS(IT,I,:),SLAT)

   
   
                   IF(IVEL==0.AND.IT.GE.2.AND.IT.GE.IREF1.AND.IT.LE.IREF2)THEN
                   VEL(LL,I,:)=(POS(IT,I,:)-POS(IT-1,I,:))/DELT
        !           PRINT*,VEL(LL,I,:)
        !           PAUSE 


                   IF(LL==2)THEN
                        
                        IF(I.LE.SUM(NNTYPE(1:ITYP)).AND.I.GT.SUM(NNTYPE(1:ITYP-1)))THEN
                        IITYP=ITYP
                        ELSE
                        IITYP=IITYP+1
                        ITYP=IITYP
                        END IF
                   SCALL(IITYP)=SCALL(IITYP)+DOT_PRODUCT(VEL(LL,I,:),VEL(LL,I,:))
                   END IF         



                   END IF
                   SLAT1=SLAT
                   ISLAT1=ISLAT
        END DO
!       WRITE(197,197)IT,((POS(IT,I,K),K=1,3),I=1,96)
        197 FORMAT(I6,2X,10000(F6.2,1X))
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!AVGPOS !ROUTINES!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  !PRINT*, TIME

        IINTERVAL=MOD(IT,INTERVAL)
        IF(IINTERVAL.EQ.0.AND. IT.GE.IREF1.AND.IT.LE.IREF2)THEN
        IPOINTS=IPOINTS+1
        !PRINT*,IT,IPOINTS
        IF(IGRR==1)CALL GRRFN2
        IF(IANGLE==1)CALL ANGLECAL
        !IF(IDIFF==1)CALL DIFFRACTION
        END IF

        !PRINT*,VEL(IT,1,:)
        !PAUSE



END DO
99 CONTINUE

PRINT*, "READING IS DONE FOR HISTORY DL_POLY AND NUMBER OF STEPS ARE " ,TIME
CLOSE(2)
AVGSLAT=AVGSLAT/(LL)
AVGPOS=AVGPOS/(LL)  !!!!!-1 DUE TO FIRST TIME POSITION IS  MISSING NOT A BIG DEAL
AVGISLAT=AVGSLAT
CALL GAUSS(AVGISLAT,3)
AVGISLAT=TRANSPOSE(AVGISLAT)
PRINT*,'AVGLAT'
PRINT*,AVGSLAT
!PRINT*,AVGPOS


WRITE(199,*)
WRITE(199,*)'1'

WRITE(199,199)AVGSLAT(1,:)
WRITE(199,199)AVGSLAT(2,:)
WRITE(199,199)AVGSLAT(3,:)
WRITE(199,*)NNTYPE
WRITE(199,*)'D'
DO I=1,NATOM
WRITE(199,199)AVGPOS(I,:)
199 FORMAT(3F15.5)
END DO


END SUBROUTINE




!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!VASP!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!




SUBROUTINE VASP           !!!!!!!!!!!!!!!!!!!!VASP XDATCAR READING 
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(3)::AA
CHARACTER*50::ABC2
INTEGER::IDR,ITH
REAL,DIMENSION(NATOM)::KE
INTEGER::IND1,IND2,IND3
KE=0
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!VASP READING
IF(IWRITE==1)OPEN(3,FILE="XDATCARNEW.DAT")
TIME=0
LL=0
3 FORMAT(3F18.10)
2 FORMAT(A40)




DO IT=1,IREF1-1
        TIME=TIME+1
        IF(ISIF3==1.OR.IT==1)THEN
        READ(2,2)ABC2
        IF(IWRITE==1)WRITE(3,2)ABC2
        READ(2,2)ABC2
        IF(IWRITE==1)WRITE(3,2)ABC2
        READ(2,*)SLAT(1,:)
        READ(2,*)SLAT(2,:)
        READ(2,*)SLAT(3,:)

        SLATORIG=SLAT
        ISLATORIG=SLAT
        CALL GAUSS(ISLATORIG,3)
        IF(IWRITE==1)WRITE(3,3)SLAT(1,:)
        IF(IWRITE==1)WRITE(3,3)SLAT(2,:)
        IF(IWRITE==1)write(3,3)SLAT(3,:)
        READ(2,*)!ATMNM
        IF(IWRITE==1)WRITE(3,*)ATMNM
!21
        READ(2,2)ABC2
        IF(IWRITE==1)WRITE(3,2)ABC2
        SLAT1=SLAT
        ISLAT1=SLAT1
        CALL GAUSS(ISLAT1,3)
        ISLAT=SLAT
        CALL GAUSS(ISLAT,3)
        END IF
      
	READ(2,2)
        DO I=1,NATOM
        READ(2,*) !POS(LL,I,:)      
        END DO

END DO
!!!!!!!!!!!!
IND1=1
IND2=1  !FOR DIFFUSE SCATTERING STUF
IND3=0
!!!!!!!!!!!!!!



DO IT=1,IREF2-IREF1+1
        TIME=TIME+1
        !PRINT*, TIME 
        IF(ISIF3==1.OR.(IREF1==1.AND.IT==1))THEN
        READ(2,2)ABC2
        IF(IWRITE==1)WRITE(3,2)ABC2
        READ(2,2)ABC2
        IF(IWRITE==1)WRITE(3,2)ABC2
        READ(2,*)SLAT(1,:)
        READ(2,*)SLAT(2,:)
        READ(2,*)SLAT(3,:)
        IF(IT==1)PRINT*,'VASP 1st step Lattice Vectors'
        IF(IT==1)PRINT* ,SLAT(1,:)
        IF(IT==1)PRINT* ,SLAT(2,:)
        IF(IT==1)PRINT* ,SLAT(3,:)
        CALL DETER(SLAT,VOL0)
        SLATORIG=SLAT
        ISLATORIG=SLAT
        CALL GAUSS(ISLATORIG,3)
        IF(IWRITE==1)WRITE(3,3)SLAT(1,:)
        IF(IWRITE==1)WRITE(3,3)SLAT(2,:)
        IF(IWRITE==1)write(3,3)SLAT(3,:)
        READ(2,*)!ATMNM
        IF(IWRITE==1)WRITE(3,*)ATMNM
!21
        READ(2,2)ABC2
        IF(IWRITE==1)WRITE(3,2)ABC2
        SLAT1=SLAT
        ISLAT1=SLAT1
        CALL GAUSS(ISLAT1,3)

        ISLAT=SLAT
        CALL GAUSS(ISLAT,3)
        END IF

        LL=LL+1
        AVGSLAT=AVGSLAT+SLAT
        READ(2,2)ABC2
        IF(IWRITE==1)WRITE(3,2)ABC2

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!TRICK FOR IND1 IND2 IND3!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        IND3=IND3+1
 	 IF(IND3.GT.NCUB)THEN
		IND3=IND3-NCUB
		IND2=IND2+1
		IF(IND2.GT.NCUB)THEN
		 IND2=IND2-NCUB
		 IND1=IND1+1
                 
		END IF
	 END IF
        DO I=1,NATOM
                READ(2,*)POS(LL,I,:)      
		RR1(I,:)=POS(LL,I,:) !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!SAVED AS R1 FOR GRR CALCULATION 
		

		
		!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                IF(LL.GT.1)THEN
                POS(LL-1,I,:)=MATMUL(POS(LL-1,I,:),ISLAT)
                !POS(LL-1,I,:)=MATMUL(ISLAT,POS(LL-1,I,:))
                AA=POS(LL,I,:)-POS(LL-1,I,:)
                IF(AA(1).LE.-0.5)POS(LL,I,1)=POS(LL,I,1)+1
                IF(AA(2).LE.-0.5)POS(LL,I,2)=POS(LL,I,2)+1
                IF(AA(3).LE.-0.5)POS(LL,I,3)=POS(LL,I,3)+1
                IF(AA(1).GE.+0.5)POS(LL,I,1)=POS(LL,I,1)-1
                IF(AA(2).GE.+0.5)POS(LL,I,2)=POS(LL,I,2)-1
                IF(AA(3).GE.+0.5)POS(LL,I,3)=POS(LL,I,3)-1
                POS(LL-1,I,:)=MATMUL(POS(LL-1,I,:),SLAT)
                ENDIF

                IF(IWRITE==1)WRITE(3,3)POS(LL,I,:)
                !IF(IT.GE.IREF1.AND.IT.LT.IREF2)THEN
                AVGPOS(I,:)=AVGPOS(I,:)+POS(IT,I,:)
                !END IF
                !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                POS(LL,I,:)=MATMUL(POS(LL,I,:),SLAT)
                !POS(LL,I,:)=MATMUL(SLAT,POS(LL,I,:))
                !IF(LL.GE.2.AND.IT.GE.IREF1.AND.IT.LE.IREF2)THEN
                IF(LL.GE.2.0)THEN
		VEL(LL,I,:)=(POS(LL,I,:)-POS(LL-1,I,:))/DELT
                END IF
        END DO
        !PRINT*,POS(IT,1,:)
        !PAUSE
	!ELSE
	!DO I=1,NATOM+1
	!READ(2,*)
	!END DO
!	END IF


!###################################################
!       ##############################################
!       ##########################################
!       ##############        




        IINTERVAL=MOD(IT,INTERVAL)
        IF(IINTERVAL.EQ.0.AND. IT.GE.IREF1.AND.IT.LE.IREF2)THEN



        IPOINTS=IPOINTS+1
	!IF(IDIFFUSE==1) CALL DIFFUSE2021 !#########################
	!IF(IDIFFUSE==1) CALL DIFFUSE2022 !#########################
        !PRINT*,IT,IPOINTS
!        IF(IGRR==1)CALL GRRFN2
        IF(IGRR==1)CALL GRRFN4LAMMPS

        IF(IANGLE==1)CALL ANGLECAL
        !IF(IDIFF==1)CALL DIFFRACTION
        END IF
        !PRINT*, TIME
        KE=( (LL-1)*KE +  0.3781*MASS*NORM2(VEL(LL,:,:),DIM=2 )**2) / LL
        WRITE(103,103)LL,(KE(J)/1.0,J=1,NATOM)  !(KE+0.4009*MASS(1)*DOT_PRODUCT(VEL(LL,1,:),VEL(LL,1,:)) )/L	
        103 FORMAT(I7,1000E10.3)
END DO
TEMPERATURE=SUM(KE)/NATOM
PRINT*,'SIMULATION TEMPERATURE IS(K)=',TEMPERATURE

IF(IGRR==1)THEN
WRITE(83,*)'#r0  pairs, GRTTOTAL, X-ray-weighted, neutron-weighted'
DO IDR=1,NR
!WRITE(83,83)(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(IPOINTS),J=I,NTYP),I=1,NTYP),GAVG(IDR)/REAL(IPOINTS)
WRITE(83,83)(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(IPOINTS),J=I,NTYP),I=1,NTYP), SUM(GRRTAVG(IDR,:,:))/REAL(IPOINTS), SUM(GRRTAVGXRAY(IDR,:,:))/REAL(IPOINTS), SUM(GRRTAVGNEUTRON(IDR,:,:))/REAL(IPOINTS)
END DO
83 FORMAT(F6.3,2x,100(E14.4,2x))
END IF



IF(IANGLE==1)THEN
OPEN(13,FILE="ANGLEVAR.DAT")
        DO ITH=-180,180 !1,NTHETA 
        WRITE(13,13)REAL(ITH), (THETA(ITH,INDEX1(I,1),INDEX1(I,2),INDEX1(I,3))/REAL(IPOINTS),I=1,MAXINDEX)
        !WRITE(13,13)THE0+ITH*DELTH, (THETA(ITH,INDEX1(I,1),INDEX1(I,2),INDEX1(I,3))/REAL(IPOINTS),I=1,MAXINDEX)
        13 FORMAT(20(F15.5,2X))
        END DO
CLOSE(13)



OPEN(14,FILE="AVGANGLE.DAT")
        DO I=1,NTYP
        DO J=1,NTYP
        DO K=1,NTYP
        WRITE(14,14)J,I,K,AVGANG(J,I,K)/REAL(IPOINTS)
        14 FORMAT(3I5,F10.5)
        END DO
        END DO
        END DO

CLOSE(14)
END IF
PRINT*,'USEFUL STEPS ARE',LL
!NSTEP=LL
!NSTEP=NSTEP-IREF1
AVGPOS=AVGPOS/REAL(LL)
AVGSLAT=AVGSLAT/REAL(LL)
VOLUME=AVGSLAT(1,1)* (AVGSLAT(2,2)*AVGSLAT(3,3)-AVGSLAT(2,3)*AVGSLAT(3,2)) + AVGSLAT(1,2)* (AVGSLAT(2,3)*AVGSLAT(3,1)-AVGSLAT(2,1)*AVGSLAT(3,3)) + AVGSLAT(1,3)* (AVGSLAT(2,1)*AVGSLAT(3,2)-AVGSLAT(2,2)*AVGSLAT(3,1))
PRINT*,'AVG Lattice Vectors'
PRINT*,'REAL VECTORS'
PRINT*,AVGSLAT(1,:)
PRINT*,AVGSLAT(2,:)
PRINT*,AVGSLAT(3,:)
AVGISLAT=AVGSLAT
CALL GAUSS(AVGISLAT,3)
!AVGISLAT=TRANSPOSE(AVGISLAT)
PRINT*,'AVG RECIPROCAL Lattice Vectors'
PRINT*,AVGISLAT(1,:)
PRINT*,AVGISLAT(2,:)
PRINT*,AVGISLAT(3,:)
WRITE(199,*)
WRITE(199,*)'1'
WRITE(199,199)AVGSLAT(1,:)
WRITE(199,199)AVGSLAT(2,:)
WRITE(199,199)AVGSLAT(3,:)
WRITE(199,*)NNTYPE
WRITE(199,*)'D'
DO I=1,NATOM
WRITE(199,199)AVGPOS(I,:)
END DO
PRINT*, "VASP READING IS DONE, and no. of steps are:",TIME
CLOSE(2)
CLOSE(3)




199 FORMAT(3F15.5)
END SUBROUTINE


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!VACF FFT SCHEME!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
SUBROUTINE VVACF1
use omp_lib
USE VARIABLES1
IMPLICIT NONE
COMPLEX,ALLOCATABLE,DIMENSION(:,:,:)::VELC
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DIFFUSION,DIFFUSIONC,CDIFFUSION
DOUBLE PRECISION::PHASE1
INTEGER::IFOR,IBAC,ISCHEME,PLAN
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::AAAA,BBBB,HR
INTEGER::II1,I1
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DOS,DOSB   !!!!DOSB BROADENED 
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DOST,DOSTB
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DOSTBS,DOSBS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DOSTBSS
COMPLEX,ALLOCATABLE,DIMENSION(:,:,:)::VACFC
COMPLEX,ALLOCATABLE,DIMENSION(:,:,:)::VACFCT,CDOS
DOUBLE PRECISION::TOTAL_WEIGHT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::WEIGHT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::NWPDOS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::SCALTYPE,DUMMY1,DUMMY2
DOUBLE PRECISION,DIMENSION(1000)::CV
DOUBLE PRECISION::FRE,TEMP,H ,KB  ,HH   
DOUBLE PRECISION,EXTERNAL::DNBOSE1
DOUBLE PRECISION,EXTERNAL::NBOSE1
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::U2E
ALLOCATE(U2E(NDOS,NTYP,3))
HH=6.626068E-26/1.66053886E-27
H=6.626069300000000159e-22   ! ORDER OF 12 LESS BECAUSE WHEN WE MULTIPLY W IT IS IN THZ
KB=1.380650500000000147e-23
!BETA1=47.99237243603648754
IF(IVACF==1)OPEN(8558,FILE='HAVEN_RATIO')
ALLOCATE(VELC(NSTEP,NATOM,3),DIFFUSION(NTYP,3),AAAA(2*NSTEP),DOS(NSTEP,NATOM,3),DOST(NSTEP,NTYP,3),DOSTB(NSTEP,NTYP,3),VACFC(NSTEP,NATOM,3),VACFCT(NSTEP,NTYP,3))
ALLOCATE(DOSB(NSTEP,NATOM,3))
ALLOCATE(DIFFUSIONC(NTYP,3))
ALLOCATE(CDIFFUSION(NTYP,3))
ALLOCATE(WEIGHT(NTYP))
ALLOCATE(NWPDOS(NSTEP,NTYP))
ALLOCATE(SCALTYPE(NTYP))
ALLOCATE(BBBB(2*NSTEP))
ALLOCATE(DOSTBS(NSTEP,NTYP),DOSBS(NSTEP,NATOM))
ALLOCATE(DOSTBSS(NSTEP))
ALLOCATE(DUMMY1(NDOS),DUMMY2(NDOS))
ALLOCATE(CDOS(NSTEP,NTYP,3))
ALLOCATE(HR(NTYP))
IFOR= 1
IBAC=-1
!!!!!!!!!!!!!!!!!!!!!!!!!VACF!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
PRINT*, "I M IN VVACF1"
PRINT*,NSTEP
ITYP=1
        DO I=1,NATOM
                DO J=1,3 !!!!!!!!!CARTESIAN DEGREE OF FREEDOME
                        II1=1
                        DO I1=1,2*(NSTEP),2
        		AAAA(I1)=VEL(II1,I,J)  !REAL(FQT(II1,I))
        		AAAA(I1+1)=0 !VEL(II1,I,J) !AIMAG(FQT(II1,I))
        		II1=II1+1
        		END DO	
                        CALL DFOUR1(AAAA,NSTEP,IFOR)
                        AAAA=AAAA/REAL(NSTEPORIG)

                        !BBBB=AAAA
                        !CALL DFOUR1(BBBB,NSTEP,IBAC)
                        !IF(I==1.AND.J==1)THEN
                        !DO I1=1,2*(NSTEP),2
                        !WRITE(91,91)(I1+1)/2,VEL((I1+1)/2,1,1),AAAA(I1),BBBB(I1)
                        !91 FORMAT(I10,3E15.5)
                        !END DO        
                        !END IF

                        II1=1
        		DO I1=1,2*NSTEP,2
                		VELC(II1,I,J)=CMPLX(AAAA(I1),AAAA(I1+1))   !!!!!!!
                                DOS(II1,I,J)= (VELC(II1,I,J)*CONJG(VELC(II1,I,J)))
                                IF(I.LE.SUM(NNTYPE(1:ITYP)).AND.I.GT.SUM(NNTYPE(1:ITYP-1)))THEN
                                IITYP=ITYP
                                ELSE
                                IITYP=IITYP+1
                                ITYP=IITYP
                                END IF
                                !PRINT*,I,ITYP,IITYP
                                DOST(II1,IITYP,J)=DOST(II1,IITYP,J)+DOS(II1,I,J)/NNTYPE(IITYP)
                		II1=II1+1
                      END DO
!        		PRINT*,VELC(:,I,:) !AAA                
                END DO
        END DO


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!VACF!!!!!!!!!!!!!!!!!!
ITYP=1
        DO I=1,NATOM
                DO J=1,3 !!!!!!!!!CARTESIAN DEGREE OF FREEDOME

                        II1=1
                        DO I1=1,2*NSTEP,2
                        AAAA(I1)=DOS(II1,I,J)  !REAL(FQT(II1,I))
        		AAAA(I1+1)=0  !AIMAG(FQT(II1,I))
        		II1=II1+1
        		END DO	

                        CALL dfour1(AAAA,NSTEP,IBAC)
        !                AAAA=AAAA/REAL(NSTEPORIG) 
                        II1=1
        		DO I1=1,2*NSTEP,2
        		VACFC(II1,I,J)=CMPLX(AAAA(I1),AAAA(I1+1))   !!!!!!!
!                        IF(I.LE.SUM(NNTYPE(1:ITYP)).AND.I.GT.SUM(NNTYPE(1:ITYP-1)))THEN
!                        IITYP=ITYP
!                        ELSE
!                        IITYP=IITYP+1
!                        ITYP=IITYP
!                        END IF
                        !PRINT*,I,ITYP,IITYP
             !           VACFCT(II1,IITYP,J)=VACFCT(II1,IITYP,J)+VACFC(II1,I,J)/NNTYPE(IITYP)
        		II1=II1+1
                        END DO

              END DO
        END DO
        
        DO I=1,NTYP
        VACFCT(:,I,:)=SUM(VACFC(:,SUM(NNTYPE(1:I-1)) +1: SUM(NNTYPE(1:I)),:)/NNTYPE(I),DIM=2)  !/NNTYPE(IITYP)
        END DO
        DO I=1,NTYP
        
!        PRINT*,VACFCT(:,I,:)=SUM(VACFC(:,SUM(NNTYPE(1:I-1)) +1: SUM(NNTYPE(1:I)),:),DIM=2)  !/NNTYPE(IITYP)

        PRINT*, SUM((VEL(1,SUM(NNTYPE(1:I-1)) +1: SUM(NNTYPE(1:I)),:)**2)/NNTYPE(I),DIM=1)  !/NNTYPE(IITYP)
        END DO
!        DO I=1,NTYP
!        SCALTYPE(I)=SUM(REAL(VACFCT(1,I,:)))
!        DO J=1,3
!        VACFCT(:,I,J)=VACFCT(:,I,J)/SCALTYPE(I) !REAL(VACFCT(1,I,J))
!        END DO
!        END DO

        DO IT=1,NSTEP
        !WRITE(80,80) REAL((IT-1)*DELT),(SUM(VACFCT(IT,ITYP,1:3)),ITYP=1,NTYP)
        WRITE(80,80) REAL((IT-1)*DELT),(VACFCT(IT,ITYP,1:3),ITYP=1,NTYP)
        80 FORMAT(E15.5,2X,100(3(2E20.8,2x)3x)) 
        END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!CORRELATION CALCULATION
!!!!!!!!!!!!!!!!!!!!!!!!!CROSS VACF

        DO IT=1,NTYP
                DO I=SUM(NNTYPE(1:IT-1))+1 ,SUM(NNTYPE(1:IT))               
                DO J=SUM(NNTYPE(1:IT-1))+1 ,SUM(NNTYPE(1:IT))               
                IF(I.NE.J) CDOS(:,IT,:)=CDOS(:,IT,:)+ (VELC(:,I,:)*CONJG(VELC(:,J,:)))
                END DO
                END DO
                CDOS(:,IT,:)=CDOS(:,IT,:)/NNTYPE(IT)
                !FOURIER STUFF        
                DO J=1,3
                II1=1
                DO I1=1,2*NSTEP,2
                AAAA(I1)=CDOS(II1,IT,J)  !REAL(FQT(II1,I))
                AAAA(I1+1)=0  !AIMAG(FQT(II1,I))
                II1=II1+1
                END DO
                CALL dfour1(AAAA,NSTEP,IBAC)
        !       AAAA=AAAA/REAL(NSTEPORIG)
               II1=1
               DO I1=1,2*NSTEP,2
               CDOS(II1,IT,J)=CMPLX(AAAA(I1),AAAA(I1+1))   !!!!!!!
               II1=II1+1
               END DO
               END DO
                PRINT*,'CROSS VACF' 
                PRINT*, 1.0E-4*DELT*SUM(CDOS(:,IT,:),DIM=1)/2.0  !/NNTYPE(IITYP)

        END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!



PRINT*,'DIFFUSION in cm2/sec,and Haven Ratio'
DO I=1,NTYP
PRINT*, ATMNM(I)
!PRINT*,SCALTYPE(I),SCALL(I)
!DIFFUSION(I,1)=1.0E-8*SCALL(I)*DELT*SUM(REAL(VACFCT(1:NSTEP/2,I,1)))  !/(3.0*NNTYPE(I))
!DIFFUSION(I,2)=1.0E-8*SCALL(I)*DELT*SUM(REAL(VACFCT(1:NSTEP/2,I,2)))  !/(3.0*NNTYPE(I))
!DIFFUSION(I,3)=1.0E-8*SCALL(I)*DELT*SUM(REAL(VACFCT(1:NSTEP/2,I,3)))  !/(3.0*NNTYPE(I))
!DIFFUSION(I,1)=1.0E-4*DELT*SUM(REAL(VACFCT(1:NSTEP/2,I,1)))  !/(3.0*NNTYPE(I))
!DIFFUSION(I,2)=1.0E-4*DELT*SUM(REAL(VACFCT(1:NSTEP/2,I,2)))  !/(3.0*NNTYPE(I))
!DIFFUSION(I,3)=1.0E-4*DELT*SUM(REAL(VACFCT(1:NSTEP/2,I,3)))  !/(3.0*NNTYPE(I))
DIFFUSION(I,1)=1.0E-4*DELT*SUM(REAL(VACFCT(1:NSTEP,I,1)))/2  !i/(3.0*NNTYPE(I))
DIFFUSION(I,2)=1.0E-4*DELT*SUM(REAL(VACFCT(1:NSTEP,I,2)))/2 !/(3.0*NNTYPE(I))
DIFFUSION(I,3)=1.0E-4*DELT*SUM(REAL(VACFCT(1:NSTEP,I,3)))/2  !/(3.0*NNTYPE(I))
CDIFFUSION(I,1)= 1.0E-4*DELT*SUM(REAL(CDOS(1:NSTEP,I,1)))/2  !i/(3.0*NNTYPE(I))
CDIFFUSION(I,2)= 1.0E-4*DELT*SUM(REAL(CDOS(1:NSTEP,I,2)))/2 !/(3.0*NNTYPE(I))
CDIFFUSION(I,3)= 1.0E-4*DELT*SUM(REAL(CDOS(1:NSTEP,I,3)))/2  !/(3.0*NNTYPE(I))

PRINT*,DIFFUSION(I,:) !,DIFFUSIONC(I,:)
62 FORMAT(3E10.3,2X,3E10.3)
HR(I)=SUM(DIFFUSION(I,:))/(SUM(DIFFUSION(I,:))+SUM(CDIFFUSION(I,:)))

PRINT*,'HAVEN  RATIO',HR(I)
WRITE(8558,*)HR(I)
END DO


!DIFFUSION(


!!!!!!!!!!!!!!!!!!!!!!!!!!!DEFINE DELE FOR BROADENING PURPOSE

!###################################################################################
        DELW=4.136*REAL(1/(DELT*NSTEP))                                           !#
        DO I=1,NTYP                                                               !# 
        DO J=1,3                                                                  !
        DOST(:,I,J)=DOST(:,I,J)/(DELW*SUM(DOST(1:NSTEP/2,I,J)))                   !
        END DO                                                                    !
        END DO                                                                    ! 
                                                                                  !
        DO I=1,NATOM                                                              !
        DO J=1,3                                                                  !
        DOS(:,I,J)=DOS(:,I,J)/(DELW*SUM(DOS(1:NSTEP/2,I,J)))                      !
        END DO                                                                    !
        END DO                                                                    !
!###################################################################################

DELE=4.136/REAL(DELT*NSTEP)
PRINT*,'DELE in meV=',DELE
PRINT*,NDOS

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!BROADENING THE DATA!!!!!!!!!!!!!!!!!!!!!!!
DO IJ=1,NTYP
DUMMY1=DOST(1:NDOS,IJ,1)
print*,'typ',IBROAD
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)

!#print*,'ityp',IJ
DOSTB(1:NDOS,IJ,1)=DUMMY2
DUMMY1=DOST(:,IJ,2)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSTB(1:NDOS,IJ,2)=DUMMY2

DUMMY1=DOST(1:NDOS,IJ,3)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSTB(1:NDOS,IJ,3)=DUMMY2
END DO
!PRINT*, 'FWHM in meV='
!READ*,FWHM
!FWHM=3.0 

!PRINT*, 'FWHM in meV=',FWHM0
!DELW=4.136*REAL(1/(DELT*NSTEP))

!DO I=1,NDOS  !NSTEP
!        OMEGA=4.136*REAL((I-1)/(DELT*NSTEP))
!        IF(OMEGA.GT.200)EXIT
!        FWHM=(FWHM0**2)  + ((FWHM1*OMEGA/100)**2)
!        DO IJ=1,NTYP   !!!!!!!!!! for dimension
!        SUMM=0
!                DO IK=0,NSTEP !1000
!                DELX=REAL(I-IK)*DELW
!                DELX=DELX*DELX
!                BROAD=EXP(-DELX/FWHM)
!                DOSTB(I,IJ,:)=DOSTB(I,IJ,:)+DOST(IK,IJ,:)*BROAD
!                SUMM=SUMM+BROAD
!                END DO
!                IF(SUMM.GT.0)DOSTB(I,IJ,:)=DOSTB(I,IJ,:)/SUMM
!        END DO
!END DO
!!!!!!!!!!!!!!!!!BROADENING OF INDIVIDUAL!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
IF(INDIVIDUAL==1)THEN
DO IJ=1,NATOM
DUMMY1=DOS(1:NDOS,IJ,1)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSB(1:NDOS,IJ,1)=DUMMY2

DUMMY1=DOS(1:NDOS,IJ,2)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSB(1:NDOS,IJ,2)=DUMMY2

DUMMY1=DOS(1:NDOS,IJ,3)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSB(1:NDOS,IJ,3)=DUMMY2
END DO
END IF
!DO I=1,NDOS  !NSTEP
!        OMEGA=4.136*REAL((I-1)/(DELT*NSTEP))
!        IF(OMEGA.GT.200)EXIT
!        FWHM=(FWHM0**2)  + ((FWHM1*OMEGA/100)**2)
!        DO IJ=1,NATOM   !!!!!!!!!! for dimension
!        SUMM=0
!                DO IK=0,NSTEP !1000
!                DELX=REAL(I-IK)*DELW
!                DELX=DELX*DELX
!                BROAD=EXP(-DELX/FWHM)
!                DOSB(I,IJ,:)=DOSB(I,IJ,:)+DOS(IK,IJ,:)*BROAD
!                SUMM=SUMM+BROAD
!                END DO
!                IF(SUMM.GT.0)DOSB(I,IJ,:)=DOSB(I,IJ,:)/SUMM
!        END DO
!END DO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!DELEE=4.136*REAL(1)/(DELT*NSTEP)
!NCUT=ECUT/DELEE

!!!!!!!!!!!!!!!!!!!!!!!!!NORMALIZATION 
!DO ITYP=1,NTYP
!ANORM1=SUM(ABS(DOSTB(1:NCUT,ITYP,1)))*DELW
!ANORM2=SUM(ABS(DOSTB(1:NCUT,ITYP,2)))*DELW
!ANORM3=SUM(ABS(DOSTB(1:NCUT,ITYP,3)))*DELW
!DOSTB(:,ITYP,1)=DOSTB(:,ITYP,1)/ANORM1
!DOSTB(:,ITYP,2)=DOSTB(:,ITYP,2)/ANORM1
!DOSTB(:,ITYP,3)=DOSTB(:,ITYP,3)/ANORM1
!DOSTBS(:,ITYP)=(DOSTB(:,ITYP,1)+DOSTB(:,ITYP,2)+DOSTB(:,ITYP,3))/3.0
!END DO
!DO ITYP=1,NATOM
!ANORM1=SUM(ABS(DOSB(1:NCUT,ITYP,1)))*DELW
!ANORM2=SUM(ABS(DOSB(1:NCUT,ITYP,2)))*DELW
!ANORM3=SUM(ABS(DOSB(1:NCUT,ITYP,3)))*DELW
!DOSB(:,ITYP,1)=DOSB(:,ITYP,1)/ANORM1
!DOSB(:,ITYP,2)=DOSB(:,ITYP,2)/ANORM1
!DOSB(:,ITYP,3)=DOSB(:,ITYP,3)/ANORM1
!DOSBS(:,ITYP)=(DOSB(:,ITYP,1)+DOSB(:,ITYP,2)+DOSB(:,ITYP,3))/3.0
!END DO


!!!!!!!!!!!!!!!!!!!!!REMOVE NEGATIVE DOS    SET TO ZERO!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
DO ITYP=1,NTYP
DO IIII=1,NDOS
IF(DOSTB(IIII,ITYP,1).LT.0)DOSTB(IIII,ITYP,1)=0
IF(DOSTB(IIII,ITYP,2).LT.0)DOSTB(IIII,ITYP,2)=0
IF(DOSTB(IIII,ITYP,3).LT.0)DOSTB(IIII,ITYP,3)=0
END DO
END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


DO ITYP=1,NTYP
ANORM1=SUM(ABS(DOSTB(1:NDOS,ITYP,1)))*DELW
ANORM2=SUM(ABS(DOSTB(1:NDOS,ITYP,2)))*DELW
ANORM3=SUM(ABS(DOSTB(1:NDOS,ITYP,3)))*DELW
DOSTB(:,ITYP,1)=DOSTB(:,ITYP,1)/ANORM1
DOSTB(:,ITYP,2)=DOSTB(:,ITYP,2)/ANORM1
DOSTB(:,ITYP,3)=DOSTB(:,ITYP,3)/ANORM1
DOSTBS(:,ITYP)=(DOSTB(:,ITYP,1)+DOSTB(:,ITYP,2)+DOSTB(:,ITYP,3))/3.0
END DO
DO ITYP=1,NATOM
ANORM1=SUM(ABS(DOSB(1:NDOS,ITYP,1)))*DELW
ANORM2=SUM(ABS(DOSB(1:NDOS,ITYP,2)))*DELW
ANORM3=SUM(ABS(DOSB(1:NDOS,ITYP,3)))*DELW
DOSB(:,ITYP,1)=DOSB(:,ITYP,1)/ANORM1
DOSB(:,ITYP,2)=DOSB(:,ITYP,2)/ANORM1
DOSB(:,ITYP,3)=DOSB(:,ITYP,3)/ANORM1
DOSBS(:,ITYP)=(DOSB(:,ITYP,1)+DOSB(:,ITYP,2)+DOSB(:,ITYP,3))/3.0
END DO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        

!        WRITE(81,*) '#ENE(meV), DOSXYZ_TYPE, DOSXYZIMG_TYPE'
!        WRITE(82,*) '#ENE(meV), DOS_TYPE_AS IN XDATCAR DOS_TOTAL'

        DO IT=1,NDOS
        OMEGA=4.136*REAL((IT-1)/(DELT*NSTEP))
        DOSTBSS(IT)=SUM(DOSTBS(IT,:)*NNTYPE(:))/(SUM(NNTYPE(:)))
        WRITE(81,81) OMEGA,(DOSTB(IT,ITYP,:),ITYP=1,NTYP)
        WRITE(82,81) OMEGA,(NNTYPE(ITYP)*DOSTBS(IT,ITYP)/(SUM(NNTYPE)),ITYP=1,NTYP),DOSTBSS(IT) !TYPE OF DOS 
        !WRITE(821,81) OMEGA,(DOSBS(IT,ITYP),ITYP=1,NATOM)  !Individual atom         !broaden DOS
        81 FORMAT(E15.5,2X,10000(3E20.8,2x)) 
        END DO


        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

        !!!!!!!!!!!!!!!!!!!NEUTRON WEIGHTED DOS!!!!!!!!!!!!!!!

PRINT*, ' I AM IN NEUTRON'
WEIGHT=NNTYPE*BBT2/MASST
TOTAL_WEIGHT=SUM(WEIGHT) 
PRINT*,'WEIGHT'
PRINT*, WEIGHT
NWPDOS=0

DO I=1,NDOS  !NSTEP
OMEGA=4.136*REAL((I-1)/(DELT*NSTEP))

        DO IJ=1,NTYP
        NWPDOS(I,IJ)=NWPDOS(I,IJ) +  (WEIGHT(IJ)*SUM(DOSTB(I,IJ,:))/(3.0*TOTAL_WEIGHT))
        END DO
WRITE(85,8)OMEGA,(NWPDOS(I,IJ),IJ=1,NTYP),(SUM(NWPDOS(I,1:NTYP)))
8 FORMAT(F10.4,1000E15.5)
!PRINT*,I
END DO
!!!!!!!!!!!!!!CALCULATE SPECIFIC HEAT!!!!!!!!!!
J=0
CV=0
DO TEMP=10,1000,10
J=J+1
DO I=1,NDOS
  FRE=REAL((I-1)/(DELT*NSTEP))
!  CV(J)= CV(J)+ 3*H*FRE*DOSTBSS(I)*(DNBOSE1(FRE,TEMP))*DELW* 6.023E23
  CV(J)= CV(J)+ H*FRE*DOSTBSS(I)*(DNBOSE1(FRE,TEMP))*DELW/KB !* 6.023E23
END DO
WRITE(86,86)TEMP,CV(J)
86 FORMAT(F10.5,3E15.5)
END DO
!/(V0*0.14824687E-30)



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!MSD FROM DOS UNDER HARMONIC  !APPROXIMATION!!!!!!!!!!!!!!!!!!!!!
IF(IMSD==1)OPEN(1002,FILE="U2EXYZ")
IF(IMSD==1)OPEN(1003,FILE="U2E")
DO I=1,NDOS  !POINTS
OMEGA=REAL((I-1)/(DELT*NSTEP))
FRE=OMEGA 
        DO J=1,NTYP
        U2e(I,J,:)=(NBOSE1(FRE,TEMPERATURE) +0.5)*HH*DOSTB(I,J,:)/(4*PI*PI*MASST(J)*FRE)
        END DO
IF(OMEGA.GE.0.001)WRITE(1002,2)4.136*OMEGA,(U2E(I,J,1:3),J=1,NTYP)
IF(OMEGA.GE.0.001)WRITE(1003,2)4.136*OMEGA,(SUM(U2E(I,J,1:3)),J=1,NTYP)
2 FORMAT(100F20.10)
ENDDO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


CLOSE(1002)
CLOSE(1003)
        DEALLOCATE(VELC,DIFFUSION,DOS,DOST,DOSTB,VACFC) 
        DEALLOCATE(NWPDOS,WEIGHT)
END SUBROUTINE        


























DOUBLE PRECISION  FUNCTION  NBOSE1(FRE,TT)
DOUBLE PRECISION::FRE, TT
BETA1=47.99237243603648754
BETAT=BETA1/TT
IF(FRE.LT.0)THEN
NBOSE1=0
ELSE
!PRINT*,TT,BETAT,BETA1
!PAUSE
NBOSE1=1/(DEXP(BETAT*FRE)-1.0)
END IF
!PRINT*,NBOSE1
END FUNCTION NBOSE1
























MODULE VARIABLES2
IMPLICIT NONE
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::SPOS
DOUBLE PRECISION::ALAT,BLAT,CLAT,PHI
INTEGER:: H,L,IX,IY,IZ
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DHKL,QQ,INTENSITY
DOUBLE PRECISION,DIMENSION(3)::QCART
COMPLEX ,ALLOCATABLE,DIMENSION(:)::FHKL 
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::HKL
INTEGER::INDEX11,II,JJ,NMAX  
DOUBLE PRECISION,DIMENSION(3)::AANGLE
DOUBLE PRECISION::DPLANE 
INTEGER::INTDIM
END MODULE 


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

SUBROUTINE DIFFRACTIONOLD !(R,SMAT2)
USE VARIABLES2 
USE VARIABLES1
USE omp_lib
IMPLICIT NONE
!OPEN(11,FILE="INP_STF")

PRINT*, "I M IN DIFFRACTION"
INTENSITY=0
IF(IT==1)THEN
21 FORMAT(3F20.5)
PI=4.0*ATAN(1.0)
INTDIM=(2*HMAX+1)*(2*KMAX+1)*(2*LMAX+1)
!ALLOCATE(SPOS(NSIZE*NSIZE*NSIZE*NATOM,3))
ALLOCATE(DHKL(INTDIM),QQ(INTDIM),INTENSITY(INTDIM))
ALLOCATE(HKL(INTDIM,3),FHKL(INTDIM))
ALAT=NORM2(SLAT1(1,:))
BLAT=NORM2(SLAT1(2,:))
CLAT=NORM2(SLAT1(3,:))
AANGLE(1)=DOT_PRODUCT(SLAT1(2,:),SLAT1(3,:))/(BLAT*CLAT)
AANGLE(2)=DOT_PRODUCT(SLAT1(3,:),SLAT1(1,:))/(CLAT*ALAT)
AANGLE(3)=DOT_PRODUCT(SLAT1(1,:),SLAT1(2,:))/(ALAT*BLAT)
!$omp parallel do
DO I=1,NTYP
DO J=SUM(NNTYPE(1:I-1))+1,SUM(NNTYPE(1:I))
BB(J)=BBT(I) !/(4*PI))
END DO
END DO
!$omp end parallel do
END IF


!WRITE(*,*) NATOM
!FHKL=0.0
II=0
DO H=-HMAX,HMAX
	DO K=-KMAX,KMAX
		DO L=-LMAX,LMAX
        IF(ABS(H)+ABS(K)+ABS(L).NE.0)THEN
			II=II+1
			HKL(II,:)=(/REAL(H),REAL(K),REAL(L)/)
			CALL DDHKL  
                	DHKL(II)=DPLANE
                        !$omp parallel do
			DO I=1,NATOM
!				DO IX=1,NSIZE
!				DO IY=1,NSIZE
!				DO IZ=1,NSIZE
!				SPOS(I,1)=RR1(I,1)+(IX-1)
!				SPOS(I,2)=RR1(I,2)+(IY-1)
!				SPOS(I,3)=RR1(I,3)+(IZ-1)
				PHI=2.0*PI*DOT_PRODUCT(RR1(I,:),HKL(II,:))
				FHKL(II)=FHKL(II)+ BB(I)*(CMPLX(COS(PHI),SIN(PHI)))/(IREF2-IREF1+1)
				INTENSITY(II)=INTENSITY(II)+ ABS(FHKL(II))*ABS(FHKL(II)) 
!                        	END DO
!				END DO
!				END DO
			END DO
                        !$omp end parallel do
			QCART=2.0*PI*MATMUL(ISLAT1,HKL(II,:))   !!!!!!RECIPROCAL LATTICE IS TRANSPOSE OF ISLAT, HENCE WE MULTIPLY      OTHERWAY
			QQ(II)=NORM2(QCART)
!			WRITE(22,2)QQ(II),HKL(II,:),DHKL(II),FHKL(II) !,FIMG(II) !, QQ(II), Q(II,:), FDOUBLE PRECISION(II), FIMG(II)
			2 FORMAT(1000(F16.2,1X))
        END IF
			END DO
	END DO
END DO
NMAX=II

!PRINT*, NMAX
IF(IT==IREF2)THEN
!FHKL=FHKL/NSTEP

PRINT*, 'I AM IN' 
II=0
JJ=0
DO II=1,NMAX
	IF(QQ(II).GE.0.0001)THEN
	INDEX11=1
	DO JJ=II+1,NMAX
		IF(ABS(QQ(JJ)-QQ(II)).LT.0.0001) THEN
		INDEX11=INDEX11+1
	       	QQ(JJ)=0.0 
		END IF
	END DO
	13 FORMAT(F10.5, 3(I10,2X),2(F16.5,2X))
	INTENSITY(II)=INDEX11*INTENSITY(II)     
	END IF
END DO

INTENSITY=INTENSITY*100/MAXVAL(INTENSITY)


DO II=1,NMAX
IF(ABS(QQ(II)).GT.0.0001) WRITE(131,2) QQ(II),HKL(II,:), DHKL(II), FHKL(II), INTENSITY(II) 
END DO
!close(131)

CALL SYSTEMQQ('sort -r  -n -k 5 fort.131 >HKL')
END IF
END  SUBROUTINE

SUBROUTINE DDHKL
USE VARIABLES2
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(3,3)::MAT_A,MAT_B,MAT_C,MAT_D,IMAT_D
DOUBLE PRECISION::DMATA,DMATB,DMATC,DMATD
DPLANE=0.0
DMATA=0.0
DMATB=0.0
DMATC=0.0
DMATD=0.0

!PRINT 21, HKL(II,:)
!PRINT 21, AANGLE(:)
!PRINT 21 ,ALAT,BLAT,CLAT 
MAT_A=TRANSPOSE ( RESHAPE((/(HKL(II,1)/ALAT), (AANGLE(3)), (AANGLE(2)),(HKL(II,2)/BLAT), CONS, (AANGLE(1)), (HKL(II,3)/CLAT), (AANGLE(1)), CONS/)   , (/3 ,3 /) ))
MAT_B=TRANSPOSE (RESHAPE((/CONS, (HKL(II,1)/ALAT), (AANGLE(1)), (AANGLE(3)),(HKL(II,2)/BLAT),(AANGLE(1)),(AANGLE(2)), (HKL(II,3)/CLAT), CONS/), (/3,3/) ))
MAT_C=TRANSPOSE (RESHAPE((/CONS, (AANGLE(3)), (HKL(II,1)/ALAT) ,(AANGLE(3)), CONS,(HKL(II,2)/BLAT), (AANGLE(2)), (AANGLE(1)), (HKL(II,3)/CLAT)/), (/3,3/) ))
MAT_D=TRANSPOSE (RESHAPE((/CONS, (AANGLE(3)), AANGLE(2), (AANGLE(3)), CONS,(AANGLE(1)), (AANGLE(2)), (AANGLE(1)), CONS/), (/3,3/)))
21 FORMAT(3F12.5)
!22 FORMAT(4(3F8.4,4X))

CALL DETER(MAT_A, DMATA) 
CALL DETER(MAT_B, DMATB) 
CALL DETER(MAT_C, DMATC) 
CALL DETER(MAT_D, DMATD)
!PRINT*,DMATA
!PRINT*,DMATB
!PRINT*,DMATC
!PRINT*,DMATD
DPLANE= ( ((HKL(II,1)/ALAT)*DMATA)  +  ((HKL(II,2)/BLAT)*DMATB) + ((HKL(II,3)/CLAT)*DMATC )) / DMATD
DPLANE=SQRT(DPLANE)
DPLANE=1.0/DPLANE


!DPLANE= ( ((HKL(II,1)/ALAT)*DMATA)  +  ((HKL(II,2)/BLAT)*DMATB) + ((HKL(II,3)/CLAT)*DMATC )) / DMATD
!DPLANE=SQRT(DPLANE)
!DPLANE=1.0/DPLANE
END SUBROUTINE 


SUBROUTINE DETER(DDMAT,DD)
DOUBLE PRECISION,DIMENSION(3,3)::DDMAT
DOUBLE PRECISION::DD
21 FORMAT(3F12.5)
I=1
DD=0

DO J=1,3
I1=I+1
I2=I+2
J1=J+1
J2=J+2
IF(J1.GT.3)J1=J1-3
IF(J2.GT.3)J2=J2-3
IF(I1.GT.3)I1=I1-3
IF(I2.GT.3)I2=I2-3
DD=DD+DDMAT(I,J)*( DDMAT(I1,J1)*DDMAT(I2,J2) -  DDMAT(I1,J2)*DDMAT(I2,J1))
PRINT*,DD
END DO
END SUBROUTINE


SUBROUTINE QRANGE_SELECTION(IILIST)
use omp_lib
USE VARIABLES1
USE VARIABLES3
IMPLICIT NONE


DOUBLE PRECISION::QQMIN1,QQMAX1 !,QQSTEP
INTEGER::IQQQ,IILIST,KI
DOUBLE PRECISION,DIMENSION(3)::KSTART,KEND,DELK
INTEGER::KN1,KN2,KN3,IP,IPATH,KI1,KI2,KI3,ISTART,NNQ
!DOUBLE PRECISION,DIMENSION(3,3)::PLAT,SPLAT,IPLAT,ISPLAT
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::PRPOS,POSS
!INTEGER,DIMENSION(3,3)::SSIZE
!DOUBLE PRECISION::RCHECK
!DOUBLE PRECISION,DIMENSION(3)::RDEL
!DOUBLE PRECISION::PVOLUME,SVOLUME


OPEN(123456,FILE='KVALUES')
ALLOCATE(KLIST(50000,3))
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!MONTE CARLO FOR QPOINT GENERATION!!!!!!!!!!!!!
!PRINT*,'ILIST 1 FOR SPHERICAL AVERAGING 2 FOR HKL INDEX'
!READ*,IILIST
!PRINT*,"COHERENT OR INCOHERENT CALCULATION 0 and 1"
!READ*,IICOH
PRINT*, 'I AM IN QSELECTION'


IF(IILIST==1)THEN
ICARTESIAN=1
PRINT*,'ICARTESIAN',ICARTESIAN
CALL KLIST_GEN(NQPOINT,QWIDTH,QAVG)
END IF


!@@@@@@@@@@@@@@@@@FOR QENS@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IF(IILIST==2)THEN
ICARTESIAN=0
PRINT*,'QMIN, QMAX AND QQSTEP'
PRINT*,QQMIN,QQMAX,QQSTEP
PRINT*,'ICARTESIAN',ICARTESIAN
        IQQQ=0
        OPEN(124,FILE='IQQQ')
        READ(124,*,END=88)IQQQ
        88 CONTINUE
        CLOSE(124)
        DO 
        IQQQ=IQQQ+1
        QQMIN1=QQMIN+(IQQQ-1)*QQSTEP
        QQMAX1=QQMIN+(IQQQ)*QQSTEP
        IF(QQMAX1.GT.QQMAX)THEN
        EXIT  !GO TO 123
        ELSE
        PRINT*,'KLIST_GEN'
                PRINT*,AVGISLAT(1,:)
                PRINT*,AVGISLAT(2,:)
                PRINT*,AVGISLAT(3,:)
        CALL KLIST_GEN2(AVGISLAT,QQMIN1,QQMAX1,IQQQ) !(NQPOINT,QWIDTH,QAVG)
	!IF(IFFT==1)CALL IIFQT33(IQQQ)   !WEIGHTED
	IF(IFFT==1)CALL IIFQT33U(IQQQ)  !!!!!UNWEIGHTED
	!IF(IFFT==1)CALL IIFQT3(IQQQ)
	!IF(IFFT==1)CALL IIFQT1(IQQQ)
	IF(IFFT==0)CALL IIFQT2(IQQQ)
        END IF
        OPEN(124,FILE='IQQQ')
        WRITE(124,*)IQQQ
        CLOSE(124)
        END DO
END IF
!@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
!@@@@@@@@@@@@@@@@@FOR QENS@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IF(IILIST==22)THEN
ICARTESIAN=0
PRINT*,'QMIN, QMAX AND QQSTEP'
PRINT*,QQMIN,QQMAX,QQSTEP
PRINT*,'ICARTESIAN',ICARTESIAN
        IQQQ=0
        OPEN(124,FILE='IQQQ')
        READ(124,*,END=90)IQQQ
        90 CONTINUE
        CLOSE(124)
        DO 
        IQQQ=IQQQ+1
        QQMIN1=QQMIN+(IQQQ-1)*QQSTEP
        QQMAX1=QQMIN+(IQQQ)*QQSTEP
        IF(QQMAX1.GT.QQMAX)THEN
        EXIT  !GO TO 123
        ELSE
        CALL KLIST_GEN2(AVGISLAT,QQMIN1,QQMAX1,IQQQ) !(NQPOINT,QWIDTH,QAVG)
	CALL IIFQT333(IQQQ)
        END IF
        OPEN(124,FILE='IQQQ')
        WRITE(124,*)IQQQ
        CLOSE(124)
        END DO
END IF
!@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@


!@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@SQW@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IF(IILIST==5)THEN    !!!!!!!!!!!!!!!FOR SQW PLOT
ICARTESIAN=0
PRINT*,'QMIN, QMAX AND QQSTEP'
!READ(1,*),QQMIN,QQMAX,QQSTEP
PRINT*,QQMIN,QQMAX,QQSTEP
PRINT*,'ICARTESIAN',ICARTESIAN
        IQQQ=0
        DO 
        IQQQ=IQQQ+1
        QQMIN1=QQMIN+(IQQQ-1)*QQSTEP
        QQMAX1=QQMIN+(IQQQ)*QQSTEP
        IF(QQMAX1.GT.QQMAX)THEN
        EXIT  !GO TO 123
        ELSE
        CALL KLIST_GEN3(AVGISLAT,QQMIN1,QQMAX1,IQQQ) !(NQPOINT,QWIDTH,QAVG)
        CALL IIFQT6(IQQQ)
	!IF(IFFT==1)CALL IIFQT1(IQQQ)
!	IF(IFFT==0)CALL IIFQT2(IQQQ)
        END IF
        END DO
END IF
!@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@


KN1=0
KN2=0
KN3=0
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!FOR NEWUTRON WEIGHTED SINGLE CRYSTAL SQE
IF(ILIST==3)THEN
ICARTESIAN=0
OPEN(119,FILE="KLISTMAN")
READ(119,*)IPATH
DO IP=1,IPATH
        IQQQ=0
        KN1=0
        KN2=0
        KN3=0
        READ(119,*)KSTART,KEND,DELK !LIST(IQQQ,:)
        IF(DELK(1).NE.0)        KN1=INT((KEND(1)-KSTART(1))/DELK(1))
        IF(DELK(2).NE.0)        KN2=INT((KEND(2)-KSTART(2))/DELK(2))
        IF(DELK(3).NE.0)        KN3=INT((KEND(3)-KSTART(3))/DELK(3))
        KN1=KN1+1
        KN2=KN2+1
        KN3=KN3+1
!        PRINT*,KN1,KN2,KN3
!        PRINT*, MAX(KN1,MAX(KN2,KN3))
        DO IQQQ=1,MAX(KN1,MAX(KN2,KN3))
        KLIST(IQQQ,:)=KSTART+(IQQQ-1)*DELK
        WRITE(123456,1234)KLIST(IQQQ,:)
        !IQQQ=IQQQ+1
        !IF(ANY(ABS(KLIST).GT.MAXVAL(ABS(KEND))))EXIT
        END DO
        !100 CONTINUE
!        PRINT*,'TOTAL Number of Q points is ',IQQQ-1
        DO KI=1,IQQQ-1
!        PRINT*,KI
        CALL IIFQT5(KI,KLIST(KI,:))
        END DO
END DO
END IF

!!!!!!!!!!!!!!!!!!!!FOR SPECTRAL ENERGY DENSITY
IF(ILIST==4)THEN
ICARTESIAN=0
OPEN(119,FILE="KLISTMAN")
READ(119,*)IPATH
DO IP=1,IPATH
IQQQ=0
KN1=0
KN2=0
KN3=0
        READ(119,*)KSTART,KEND,DELK !LIST(IQQQ,:)
        IF(DELK(1).NE.0)        KN1=(KEND(1)-KSTART(1))/DELK(1)
        IF(DELK(2).NE.0)        KN2=(KEND(2)-KSTART(2))/DELK(2)
        IF(DELK(3).NE.0)        KN3=(KEND(3)-KSTART(3))/DELK(3)
        KN1=KN1+1
        KN2=KN2+1
        KN3=KN3+1
        !PRINT*,KN1,KN2,KN3
        !PRINT*, MAX(KN1,MAX(KN2,KN3))
        DO IQQQ=1,MAX(KN1,MAX(KN2,KN3))
        KLIST(IQQQ,:)=KSTART+(IQQQ-1)*DELK
        WRITE(123456,1234)KLIST(IQQQ,:)
       
        1234 FORMAT(3F10.5)
        !IQQQ=IQQQ+1
!IF(ANY(ABS(KLIST).GT.MAXVAL(ABS(KEND))))EXIT
        END DO
!100 CONTINUE
        PRINT*,'TOTAL Number of Q points is ',IQQQ-1
        DO KI=1,IQQQ-1
!        PRINT*,KI
        CALL IIFQT4(KI,KLIST(KI,:))
        END DO
END DO
END IF
!!!!!!!!!!!!!!!!!!!!FOR SPECTRAL ENERGY DENSITY
IF(ILIST==44)THEN
ICARTESIAN=0
OPEN(119,FILE="KLISTMAN")
READ(119,*)IPATH
DO IP=1,IPATH
IQQQ=0
KN1=0
KN2=0
KN3=0
        READ(119,*)KSTART,KEND,DELK !LIST(IQQQ,:)
        IF(DELK(1).NE.0)        KN1=(KEND(1)-KSTART(1))/DELK(1)
        IF(DELK(2).NE.0)        KN2=(KEND(2)-KSTART(2))/DELK(2)
        IF(DELK(3).NE.0)        KN3=(KEND(3)-KSTART(3))/DELK(3)
        KN1=KN1+1
        KN2=KN2+1
        KN3=KN3+1
        !PRINT*,KN1,KN2,KN3
        !PRINT*, MAX(KN1,MAX(KN2,KN3))
        DO IQQQ=1,MAX(KN1,MAX(KN2,KN3))
        KLIST(IQQQ,:)=KSTART+(IQQQ-1)*DELK
        WRITE(123456,1234)KLIST(IQQQ,:)
       
       ! 1234 FORMAT(3F10.5)
        !IQQQ=IQQQ+1
!IF(ANY(ABS(KLIST).GT.MAXVAL(ABS(KEND))))EXIT
        END DO
!100 CONTINUE
        PRINT*,'TOTAL Number of Q points is ',IQQQ-1
        DO KI=1,IQQQ-1
!        PRINT*,KI
        CALL IIFQT44(KI,KLIST(KI,:))
        END DO
END DO
END IF


!!!!!!!!!!!!!!!!!!!!!!FOR ACOUSTIC MODE 
IF(ILIST==7)THEN
ICARTESIAN=0
OPEN(119,FILE="KLISTMAN")
READ(119,*)IPATH
DO IP=1,IPATH
IQQQ=0
KN1=0
KN2=0
KN3=0
        READ(119,*)KSTART,KEND,DELK !LIST(IQQQ,:)
        IF(DELK(1).NE.0)        KN1=(KEND(1)-KSTART(1))/DELK(1)
        IF(DELK(2).NE.0)        KN2=(KEND(2)-KSTART(2))/DELK(2)
        IF(DELK(3).NE.0)        KN3=(KEND(3)-KSTART(3))/DELK(3)
        KN1=KN1+1
        KN2=KN2+1
        KN3=KN3+1
        !PRINT*,KN1,KN2,KN3
        !PRINT*, MAX(KN1,MAX(KN2,KN3))
        DO IQQQ=1,MAX(KN1,MAX(KN2,KN3))
        KLIST(IQQQ,:)=KSTART+(IQQQ-1)*DELK
        WRITE(123456,1234)KLIST(IQQQ,:)
       
        !IQQQ=IQQQ+1
!IF(ANY(ABS(KLIST).GT.MAXVAL(ABS(KEND))))EXIT
        END DO
!100 CONTINUE
        PRINT*,'TOTAL Number of Q points is ',IQQQ-1
        DO KI=1,IQQQ-1
!        PRINT*,KI
        CALL IIFQT7(KI,KLIST(KI,:))
        END DO
END DO
END IF
!!!!!!!!!!!!!!!!ACOUSTIC ON GRID!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!FOR ACOUSTIC MODE 
IF(ILIST==8)THEN
ICARTESIAN=0
OPEN(119,FILE="KGRID")
IQQQ=0
KN1=0
KN2=0
KN3=0
        READ(119,*)KN1,KN2,KN3 !KSTART,KEND,DELK !LIST(IQQQ,:)
        !WRITE(123456,*)(KN1+1)*(KN2+1)*(KN3+1) !KLIST(IQQQ,:)
        DO KI1=0,KN1 
        DO KI2=0,KN2
        DO KI3=0,KN3 !MAX(KN1,MAX(KN2,KN3))
        IQQQ=IQQQ+1
        WRITE(123456,*)KI1,KI2,KI3 !KLIST(IQQQ,:)
        KLIST(IQQQ,:)=(/KI1,KI2,KI3/)
        END DO
        END DO
        END DO
        
        PRINT*,'TOTAL Number of Q points is ',IQQQ


        ISTART=1
        OPEN(124,FILE='IQQQ')
        READ(124,*,END=89)ISTART
        89 CONTINUE
        CLOSE(124)
        DO KI=ISTART,IQQQ
        CALL IIFQT8(KI,KLIST(KI,:))
        OPEN(124,FILE='IQQQ')
        WRITE(124,*)KI
        CLOSE(124)
        END DO
END IF

!!!!!!!!!!!!!!!!ACOUSTIC PARALLEL 
IF(ILIST==88)THEN
ICARTESIAN=0
OPEN(119,FILE="KGRID")
IQQQ=0
KN1=0
KN2=0
KN3=0
        READ(119,*)KN1,KN2,KN3 !KSTART,KEND,DELK !LIST(IQQQ,:)
        WRITE(123456,*)(KN1+1)*(KN2+1)*(KN3+1) !KLIST(IQQQ,:)
        DO KI1=0,KN1 
        DO KI2=0,KN2
        DO KI3=0,KN3 !MAX(KN1,MAX(KN2,KN3))
        IQQQ=IQQQ+1
        WRITE(123456,*)KI1,KI2,KI3 !KLIST(IQQQ,:)
        KLIST(IQQQ,:)=(/KI1,KI2,KI3/)
        END DO
        END DO
        END DO
        
        PRINT*,'TOTAL Number of Q points is ',IQQQ


        !ISTART=1
        !OPEN(124,FILE='IQQQ')
        !READ(124,*,END=89)ISTART
        !89 CONTINUE
        !CLOSE(124)
        !DO KI=ISTART,IQQQ
        CALL IIFQT88(IQQQ)
        !OPEN(124,FILE='IQQQ')
        !WRITE(124,*)KI
        !CLOSE(124)
        !END DO
END IF
!!!!!!!!!!!!!!!!ACOUSTIC ON GRID!!!!!!!!!!!!!!!!!

!###################################
IF(IILIST==9)THEN
ICARTESIAN=0
OPEN(119,FILE="KLISTMAN")
READ(119,*)NNQ
DO IP=1,NNQ
READ(119,*)KLIST(IP,:)
END DO
        IQQQ=0
        OPEN(124,FILE='IQQQ')
        READ(124,*,END=91)IQQQ
        91 CONTINUE
        CLOSE(124)
        DO IP=IQQQ,NNQ 
        IQQQ=IQQQ+1
        CALL IIFQT9(IQQQ)
        OPEN(124,FILE='IQQQ')
        WRITE(124,*)IQQQ
        CLOSE(124)
        END DO
END IF










!#######################################
IF(IILIST==444)THEN
ALLOCATE(PNTYPE(NTYP),SNTYPE(NTYP))
!GOTO 124 
OPEN(11,FILE="PPOSCAR")
OPEN(12,FILE="SPOSCAR")
READ(11,*)
READ(11,*)
READ(11,*)PLAT(1,:)
READ(11,*)PLAT(2,:)
READ(11,*)PLAT(3,:)
READ(11,*)
READ(11,*)PNTYPE
READ(11,*)
PVOLUME=PLAT(1,1)* (PLAT(2,2)*PLAT(3,3)-PLAT(2,3)*PLAT(3,2)) + PLAT(1,2)* (PLAT(2,3)*PLAT(3,1)-PLAT(2,1)*PLAT(3,3)) + PLAT(1,3)* (PLAT(2,1)*PLAT(3,2)-PLAT(2,2)*PLAT(3,1))
PRINT*,SUM(PNTYPE)
ALLOCATE(PRPOS(SUM(PNTYPE),3))
ALLOCATE(RRDEL(SUM(PNTYPE)))
DO I=1,SUM(PNTYPE)
READ(11,*)PRPOS(I,:)
END DO
READ(12,*)
READ(12,*)
READ(12,*)SPLAT(1,:)
READ(12,*)SPLAT(2,:)
READ(12,*)SPLAT(3,:)
SVOLUME=SPLAT(1,1)* (SPLAT(2,2)*SPLAT(3,3)-SPLAT(2,3)*PLAT(3,2)) + SPLAT(1,2)* (SPLAT(2,3)*SPLAT(3,1)-SPLAT(2,1)*SPLAT(3,3)) + SPLAT(1,3)* (SPLAT(2,1)*SPLAT(3,2)-SPLAT(2,2)*SPLAT(3,1))
IPLAT=PLAT
CALL GAUSS(IPLAT,3)
SSIZE=NINT(MATMUL(IPLAT,SPLAT))
!SSIZE=NINT(SSIZE) !MATMUL(IPLAT,SPLAT)
PRINT*,SSIZE(1,:)
PRINT*,SSIZE(2,:)
PRINT*,SSIZE(3,:)
READ(12,*)
READ(12,*)SNTYPE
READ(12,*)
ALLOCATE(POSS(SUM(SNTYPE),3))
!PRINT*,SUM(SNTYPE)
DO I=1,SUM(SNTYPE)
READ(12,*)POSS(I,:)
POSS(I,:)=MATMUL(SSIZE,POSS(I,:))
END DO
CLOSE(11)
close(12)
NDIM=NINT(SVOLUME/PVOLUME)
ALLOCATE(MAP(SUM(PNTYPE),NDIM))

MAP=0
DO I=1,SUM(PNTYPE)
k=0
DO J=1,SUM(SNTYPE)
RDEL=PRPOS(I,:)-POSS(J,:)+ INT(POSS(J,:))
RDEL=ABS(RDEL)
where(RDEL.GE.0.99)RDEL=RDEL-1
RCHECK=NORM2(RDEL)
!PRINT*,POSS(J,:)
!PRINT*,RCHECK
!PAUSE
IF(RCHECK.LE.1.0e-2)THEN
K=K+1
MAP(I,K)=J !k=k+1
END IF
END DO
print*,k
!PAUSE
END DO

!DO J=1,SUM(PNTYPE)
!DO I=1,SUM(SNTYPE)/SUM(PNTYPE) !SDIM
!PRINT*,MAP(J,I)
!END DO
!PAUSE
!END DO

124 CONTINUE
ICARTESIAN=0
OPEN(119,FILE="KLISTMAN")
READ(119,*)IPATH
DO IP=1,IPATH
IQQQ=0
KN1=0
KN2=0
KN3=0
        READ(119,*)KSTART,KEND,DELK !LIST(IQQQ,:)
        IF(DELK(1).NE.0)        KN1=(KEND(1)-KSTART(1))/DELK(1)
        IF(DELK(2).NE.0)        KN2=(KEND(2)-KSTART(2))/DELK(2)
        IF(DELK(3).NE.0)        KN3=(KEND(3)-KSTART(3))/DELK(3)
        KN1=KN1+1
        KN2=KN2+1
        KN3=KN3+1
        !PRINT*,KN1,KN2,KN3
        !PRINT*, MAX(KN1,MAX(KN2,KN3))
        DO IQQQ=1,MAX(KN1,MAX(KN2,KN3))
        KLIST(IQQQ,:)=KSTART+(IQQQ-1)*DELK
        WRITE(123456,1234)KLIST(IQQQ,:)

       ! 1234 FORMAT(3F10.5)
        !IQQQ=IQQQ+1
!IF(ANY(ABS(KLIST).GT.MAXVAL(ABS(KEND))))EXIT
        END DO
!100 CONTINUE
        PRINT*,'TOTAL Number of Q points is ',IQQQ-1
        DO KI=1,IQQQ-1
        CALL SED(KI,KLIST(KI,:))
        !CALL SEDADVANCED(KI,KLIST(KI,:))
        END DO
END DO
END IF        
!#########################################################################################################################

!#######################################
IF(IILIST==4444)THEN
ALLOCATE(PNTYPE(NTYP),SNTYPE(NTYP))
!GOTO 124 
OPEN(11,FILE="PPOSCAR")
OPEN(12,FILE="SPOSCAR")
READ(11,*)
READ(11,*)
READ(11,*)PLAT(1,:)
READ(11,*)PLAT(2,:)
READ(11,*)PLAT(3,:)
READ(11,*)
READ(11,*)PNTYPE
READ(11,*)
PVOLUME=PLAT(1,1)* (PLAT(2,2)*PLAT(3,3)-PLAT(2,3)*PLAT(3,2)) + PLAT(1,2)* (PLAT(2,3)*PLAT(3,1)-PLAT(2,1)*PLAT(3,3)) + PLAT(1,3)* (PLAT(2,1)*PLAT(3,2)-PLAT(2,2)*PLAT(3,1))
PRINT*,SUM(PNTYPE)
ALLOCATE(PRPOS(SUM(PNTYPE),3))
ALLOCATE(RRDEL(SUM(PNTYPE)))
DO I=1,SUM(PNTYPE)
READ(11,*)PRPOS(I,:)
END DO
READ(12,*)
READ(12,*)
READ(12,*)SPLAT(1,:)
READ(12,*)SPLAT(2,:)
READ(12,*)SPLAT(3,:)
SVOLUME=SPLAT(1,1)* (SPLAT(2,2)*SPLAT(3,3)-SPLAT(2,3)*PLAT(3,2)) + SPLAT(1,2)* (SPLAT(2,3)*SPLAT(3,1)-SPLAT(2,1)*SPLAT(3,3)) + SPLAT(1,3)* (SPLAT(2,1)*SPLAT(3,2)-SPLAT(2,2)*SPLAT(3,1))
IPLAT=PLAT
CALL GAUSS(IPLAT,3)
SSIZE=NINT(MATMUL(IPLAT,SPLAT))
!SSIZE=NINT(SSIZE) !MATMUL(IPLAT,SPLAT)
PRINT*,SSIZE(1,:)
PRINT*,SSIZE(2,:)
PRINT*,SSIZE(3,:)
READ(12,*)
READ(12,*)SNTYPE
READ(12,*)
ALLOCATE(POSS(SUM(SNTYPE),3))
!PRINT*,SUM(SNTYPE)
DO I=1,SUM(SNTYPE)
READ(12,*)POSS(I,:)
POSS(I,:)=MATMUL(SSIZE,POSS(I,:))
END DO
CLOSE(11)
close(12)
NDIM=NINT(SVOLUME/PVOLUME)
ALLOCATE(MAP(SUM(PNTYPE),NDIM))

MAP=0
DO I=1,SUM(PNTYPE)
k=0
DO J=1,SUM(SNTYPE)
RDEL=PRPOS(I,:)-POSS(J,:)+ INT(POSS(J,:))
RDEL=ABS(RDEL)
where(RDEL.GE.0.99)RDEL=RDEL-1
RCHECK=NORM2(RDEL)
!PRINT*,POSS(J,:)
!PRINT*,RCHECK
!PAUSE
IF(RCHECK.LE.1.0e-2)THEN
K=K+1
MAP(I,K)=J !k=k+1
END IF
END DO
END DO

CALL SEDADVANCED  !(KI,KLIST(KI,:))
!END DO
END IF        
!#########################################################################################################################






















IF(ILIST==33)THEN
ICARTESIAN=0
OPEN(119,FILE="KLISTMAN")
READ(119,*)IPATH
DO IP=1,IPATH
        IQQQ=0
        KN1=0
        KN2=0
        KN3=0
        READ(119,*)KSTART,KEND,DELK !LIST(IQQQ,:)
        IF(DELK(1).NE.0)        KN1=INT((KEND(1)-KSTART(1))/DELK(1))
        IF(DELK(2).NE.0)        KN2=INT((KEND(2)-KSTART(2))/DELK(2))
        IF(DELK(3).NE.0)        KN3=INT((KEND(3)-KSTART(3))/DELK(3))
        KN1=KN1+1
        KN2=KN2+1
        KN3=KN3+1
!        PRINT*,KN1,KN2,KN3
!        PRINT*, MAX(KN1,MAX(KN2,KN3))
        DO IQQQ=1,MAX(KN1,MAX(KN2,KN3))
        KLIST(IQQQ,:)=KSTART+(IQQQ-1)*DELK
        WRITE(123456,1234)KLIST(IQQQ,:)
        !IQQQ=IQQQ+1
        !IF(ANY(ABS(KLIST).GT.MAXVAL(ABS(KEND))))EXIT
        END DO
        !100 CONTINUE
!        PRINT*,'TOTAL Number of Q points is ',IQQQ-1
        DO KI=1,IQQQ-1
!        PRINT*,KI
        CALL IIFQT555(KI,KLIST(KI,:))
        END DO
END DO
END IF


IF(ILIST==10)THEN
ICARTESIAN=0
OPEN(119,FILE="KLISTMAN")
READ(119,*)IPATH
DO IP=1,IPATH
        IQQQ=0
        KN1=0
        KN2=0
        KN3=0
        READ(119,*)KSTART,KEND,DELK !LIST(IQQQ,:)
        IF(DELK(1).NE.0)        KN1=INT((KEND(1)-KSTART(1))/DELK(1))
        IF(DELK(2).NE.0)        KN2=INT((KEND(2)-KSTART(2))/DELK(2))
        IF(DELK(3).NE.0)        KN3=INT((KEND(3)-KSTART(3))/DELK(3))
        KN1=KN1+1
        KN2=KN2+1
        KN3=KN3+1
        DO IQQQ=1,MAX(KN1,MAX(KN2,KN3))
        KLIST(IQQQ,:)=KSTART+(IQQQ-1)*DELK
        WRITE(123456,1234)KLIST(IQQQ,:)
        END DO
!        DO KI=1,IQQQ-1
!        END DO
END DO
CLOSE(123456)
        CALL ANGULARDISPERSION
END IF

END SUBROUTINE        
















!####################################################################################################################################################
SUBROUTINE IIFQT1(IQQQQ)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
COMPLEX,ALLOCATABLE,DIMENSION(:,:)::FQT,FFQTTYP !,SQWB
COMPLEX,ALLOCATABLE,DIMENSION(:,:)::FFQT,SQW
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
DOUBLE PRECISION::PHASE1
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME,PLAN
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::AAA
INTEGER::II1,I1,DT1,III
!DOUBLE  PRECISION,ALLOCATABLE,DIMENSION(:,:)::KLIST
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DUMMY1,DUMMY3
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DUMMY2,DUMMY4
DOUBLE PRECISION::EE
!#INTEGER::ITYP
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK
INTEGER::ITYPPP,JTYPPP
INTEGER::IQQQQ,NNN2
CHARACTER::AA*9
!INTEGER::IIICOH
WRITE(AA,'("SQWTOT",I2.2)')IQQQQ
OPEN(170,FILE=AA)

WRITE(AA,'("SQWATM",I2.2)')IQQQQ
OPEN(180,FILE=AA)

WRITE(AA,'("IQTTOT",I2.2)')IQQQQ
OPEN(190,FILE=AA)


WRITE(AA,'("IQTATM",I2.2)')IQQQQ
OPEN(200,FILE=AA)


OPEN(17,FILE="SQ")
OPEN(18,FILE="SQA")
OPEN(19,FILE="CIQ")
OPEN(20,FILE="CIQA")




PRINT*,'I AM IN IFFQT'

ALLOCATE(FQT(1:NSTEP,NATOM))
ALLOCATE(FFQT(1:NSTEP,NATOM))
ALLOCATE(SQW(-NSTEP:NSTEP,NATOM)) !,SQWB(NQ,-NW:NW))
ALLOCATE(AAA(1:2*NSTEP))
ALLOCATE(FFQTTYP(1:NSTEP,NTYP))
!ALLOCATE(KLIST(5000,3))


FFQT=0
FQT=0
SQW=0
IFOR= 1
IBAC=-1



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!MONTE CARLO FOR QPOINT GENERATION!!!!!!!!!!!!!
!PRINT*,'ILIST 1 FOR SPHERICAL AVERAGING 2 FOR HKL INDEX'
!READ*,ILIST
!PRINT*, 'I AM IN IIFQT'
!IF(ILIST==1)THEN
!ICARTESIAN=1
!PRINT*,'ICARTESIAN',ICARTESIAN
!CALL KLIST_GEN(NQPOINT,QWIDTH,QAVG)
!END IF
!
!IF(ILIST==2)THEN
!ICARTESIAN=0
!PRINT*,'QMIN, QMAX AND QQSTEP'
!READ*,QQMIN,QQMAX,QQSTEP
!PRINT*,'ICARTESIAN',ICARTESIAN
!CALL KLIST_GEN2(AVGISLAT,QQMIN,QQMAX) !(NQPOINT,QWIDTH,QAVG)
!END IF
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

WRITE(AA,'("KKLIST",I2.2)')IQQQQ
OPEN(44,FILE=AA)
!OPEN(44,FILE="KLIST") 
I=0
DO   !NNN2=1,1000
I=I+1 
READ(44,*,END=100)KLIST(I,:)
END DO
100 CONTINUE
NQ=I-1
I=0
!END IF
PRINT*,'NQ',NQ
ALLOCATE(QQ(NQ,3),QK(NQ,3))
ALLOCATE(DUMMY1(NQ,NSTEP),DUMMY2(NQ,NTYP,NSTEP),DUMMY3(NQ,NSTEP),DUMMY4(NQ,NTYP,NSTEP))

DO IQ=1,NQ
PRINT*,'IQ=',IQ
        !KVEC=KSTART+DIR1*DELQ*IQ
	QQ(IQ,:)=KLIST(IQ,:) !VEC
	IF(ICARTESIAN==1)THEN
        KVEC=KLIST(IQ,:)
        ELSE
        !KVEC=2.0*PI*MATMUL(KLIST(IQ,:),AVGISLAT)        
        !KVEC=2.0*PI*MATMUL(KLIST(IQ,:),AVGISLAT)        !CHANGED AVGISLAT TO ISLAT
        KVEC=2.0*PI*MATMUL(AVGISLAT,KLIST(IQ,:))        !SINCE RECIPROCAL LATTICE IS TRANSPOSE OF ISLAT HENCE MULTIPLY OTHERWAY
        END IF
	QK(IQ,:)=KVEC
!	WRITE(17,17)'#QVECT(FRACT)=',KVEC
!	WRITE(18,17)'#QVECT(FRACT)=',KVEC
!	WRITE(19,17)'#QVECT(FRACT)=',KVEC
!	WRITE(20,17)'#QVECT(FRACT)=',KVEC
!        IF(ICARTESIAN==0)KVEC=MATMUL(KVEC,AVGISLAT)
!        PRINT*,QK(IQ,:)
!        PAUSE
!	WRITE(17,17)'#QVECT(A-1)=',KVEC
!	WRITE(18,17)'#QVECT(A-1)=',KVEC
!	WRITE(19,17)'#QVECT(A-1)=',KVEC
!	WRITE(20,17)'#QVECT(A-1)=',KVEC
	17 FORMAT(A12,2X,3F10.5)
!omp parallel do
        DO I=1,NATOM
        	DO IT=1,NSTEP
                PHASE1=DOT_PRODUCT(KVEC,POS(IT,I,:))
                FQT(IT,I)=CMPLX(COS(PHASE1),SIN(PHASE1))
                END DO
		II1=1
		DO I1=1,2*NSTEP,2
		AAA(I1)=REAL(FQT(II1,I))
		AAA(I1+1)=AIMAG(FQT(II1,I))
		II1=II1+1
		END DO	
	 	CALL dfour1(AAA,NSTEP,IFOR)
		II1=1
		DO I1=1,2*NSTEP,2
		FQT(II1,I)=CMPLX(AAA(I1),AAA(I1+1))
		II1=II1+1
		END DO
        END DO
!omp end parallel do

!omp parallel do
        DO ITYPPP=1,NTYP
        !DO I=1,NATOM
        DO I=SUM(NNTYPE(1:ITYPPP-1))+1,SUM(NNTYPE(1:ITYPPP)) !NATOM
	IF(ICOH==1)THEN
                DO JTYPPP=1,NTYP
        	!DO J=1,NATOM
                DO J=SUM(NNTYPE(1:JTYPPP-1))+1,SUM(NNTYPE(1:JTYPPP)) !NATOM
                IF(ITYPPP.EQ.JTYPPP.AND.J.GT.I)THEN
                DO DT=1,NSTEP
                FFQT(DT,I)=FFQT(DT,I)+ (FQT(DT,I)*CONJG(FQT(DT,J)))
	        END DO
                END IF
                END DO
                END DO
	ELSE
		J=I
	        DO DT=1,NSTEP
                FFQT(DT,I)=(FQT(DT,I))*CONJG(FQT(DT,J))
		DT1=(DT-1)
		IF(DT1.GT.((NSTEP-1)/2))DT1=DT1-NSTEP
                SQW(DT1,I)=FFQT(DT,I)
	        END DO
	END IF
	END DO
        END DO
!omp end parallel do


        DO DT=1,NSTEP
	DO I=1,NTYP
	N1=SUM(NNTYPE(1:(I-1)))+1
	N2=SUM(NNTYPE(1:I))
	FFQTTYP(DT,I)=SUM(FFQT(DT,N1:N2))
	END DO
	END DO
		!!!!!!!!!!!!!SQW!!!!!!!!!!!!!!!!!!!!!!!!!!!
		WRITE(100,*)
		DO DT1=-NSTEP/2,(NSTEP-2)/2
                WRITE(100,15)REAL(DT1)*DELT,SUM(SQW(DT1,:))/SUM(SQW(0,:))
		END DO
		

		DO DT=1,NSTEP
		IF(ICOH==0.OR.ICOH==1)	WRITE(17,15)REAL(DT)*DELT,SUM(REAL(FFQT(DT,:)))/SUM(REAL(FFQT(1,:))) !NATOM
		IF(ICOH==0.OR.ICOH==1)	WRITE(18,15)REAL(DT)*DELT,REAL(FFQTTYP(DT,:))/REAL(FFQTTYP(1,:)) !NATOM
		END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!omp parallel do
		DO I=1,NATOM
			II1=1
			DO I1=1,2*NSTEP,2
			!PRINT*,II1-1-NSTEP/2,REAL(SQW(IQ,(II1-1-NSTEP/2),I,J))
			!PAUSE
			!AAA(I1)=REAL(SQW(IQ,(II1-1-NSTEP/2),I,J))
			!AAA(I1+1)=AIMAG(SQW(IQ,(II1-1-NSTEP/2),I,J))
			!II1=II1+1
			AAA(I1)=REAL(FFQT(II1,I))
			AAA(I1+1)=AIMAG(FFQT(II1,I))
			II1=II1+1
			END DO	
			CALL DFOUR1(AAA,NSTEP,IBAC)
			II1=1
			DO I1=1,2*NSTEP,2
			FFQT(II1,I)=CMPLX(AAA(I1),AAA(I1+1))
			II1=II1+1
			END DO
		END DO
!omp end parallel do



!omp parallel do
		DO I=1,NTYP
			II1=1
			DO I1=1,2*NSTEP,2
			AAA(I1)=REAL(FFQTTYP(II1,I))
			AAA(I1+1)=AIMAG(FFQTTYP(II1,I))
			II1=II1+1
			END DO	

			CALL DFOUR1(AAA,NSTEP,IBAC)

			II1=1
			DO I1=1,2*NSTEP,2
			FFQTTYP(II1,I)=CMPLX(AAA(I1),AAA(I1+1))
			II1=II1+1
			END DO
		END DO
!omp end parallel do




		DO DT=1,NSTEP	
		IF(ICOH==0.OR.ICOH==1)	WRITE(19,15)REAL(DT)*DELT,(SUM(REAL(FFQT(DT,:))))/SUM(REAL(FFQT(1,:))) 
		IF(ICOH==0.OR.ICOH==1)	WRITE(20,15)REAL(DT)*DELT,REAL(FFQTTYP(DT,:))/(REAL(FFQTTYP(1,:)))
		END DO
END DO

REWIND(17)
REWIND(18)
REWIND(19)
REWIND(20)
DO IQ=1,NQ
!PRINT*,IQ
DO DT=1,NSTEP
READ(17,15)EE,DUMMY1(IQ,DT)
READ(18,15)EE,DUMMY2(IQ,:,DT) !,ITYP=1,NTYP)
READ(19,15)EE,DUMMY3(IQ,DT)
READ(20,15)EE,DUMMY4(IQ,:,DT) !,ITYP=1,NTYP)
END DO
END DO

!WRITE(170,170)'#h k l=     ',(QQ(IQ,:),IQ=1,NQ)
!WRITE(180,170)'#h k l=     ',(QQ(IQ,:),IQ=1,NQ),(QQ(IQ,:),IQ=1,NQ)
!WRITE(190,172)'#h k l=     ',(QQ(IQ,:),IQ=1,NQ)
!WRITE(200,171)((ATMNM(I),IQ=1,NQ),I=1,NTYP),(ATMNM(I),I=1,NTYP)
!WRITE(200,170)'#h k l=     ',(QQ(IQ,:),IQ=1,NQ),(QQ(IQ,:),IQ=1,NQ)
!WRITE(170,170)'#h k l(A-1) ',(QK(IQ,:),IQ=1,NQ)
!WRITE(180,170)'#h k l(A-1) ',(QK(IQ,:),IQ=1,NQ),(QK(IQ,:),IQ=1,NQ)
!WRITE(190,170)'#h k l(A-1) ',(QK(IQ,:),IQ=1,NQ)
!WRITE(200,170)'#h k l(A-1) ',(QK(IQ,:),IQ=1,NQ),(QK(IQ,:),IQ=1,NQ)
170 FORMAT(A12,100(3X,3F6.2,3X))
172 FORMAT(A12,<NQ>(3X,3F6.2,3X),6X,'AVG OVER Q')
!171 FORMAT(12X,<NTYP*NQ>(11X,A3,10X),<NTYP>(8X,'avg',A3,10X) )
171 FORMAT(A3,12X,<NTYP>(8X,'avg',A3,10X) )
WRITE(200,171)'#',(ATMNM(I),I=1,NTYP)
WRITE(190,171)'#',(ATMNM(I),I=1,NTYP)
DO DT=1,NSTEP
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
!WRITE(170,15)OMEGA,DUMMY1(1:NQ,DT)
!WRITE(180,15)OMEGA,((DUMMY2(IQ,ITYP,DT),IQ=1,NQ),ITYP=1,NTYP)
WRITE(170,15)OMEGA,SUM(DUMMY1(1:NQ,DT))
WRITE(180,15)OMEGA,(SUM(DUMMY2(1:NQ,ITYP,DT)),ITYP=1,NTYP)
!WRITE(190,15)REAL(DT)*DELT,DUMMY3(1:NQ,DT),SUM(DUMMY3(:,DT)/NQ)
WRITE(190,15)REAL(DT-1)*DELT,SUM(DUMMY3(:,DT)/NQ)
!WRITE(200,15)REAL(DT)*DELT,((DUMMY4(IQ,ITYP,DT),IQ=1,NQ),ITYP=1,NTYP),((SUM(DUMMY4(:,ITYP,DT))/NQ),ITYP=1,NTYP)
WRITE(200,15)REAL(DT-1)*DELT,((SUM(DUMMY4(:,ITYP,DT))/NQ),ITYP=1,NTYP)
        15 FORMAT(F15.4,1003E12.4)
END DO


CLOSE(170)
CLOSE(180)
CLOSE(190)
CLOSE(200)
CLOSE(17)
CLOSE(18)
CLOSE(19)
CLOSE(20)
CLOSE(44)
DEALLOCATE(FQT,FFQT,SQW,AAA)
END SUBROUTINE





SUBROUTINE GRRFN2
use omp_lib
USE VARIABLES1
IMPLICIT NONE
!DOUBLE PRECISION,DIMENSION(NATOM,3)::POSF
DOUBLE PRECISION,DIMENSION(NATOm,NATOM,3)::AA
DOUBLE PRECISION::MODA
DOUBLE PRECISION,DIMENSION(NATOM,NATOM)::GRR
DOUBLE PRECISION,DIMENSION(1000,NTYP,NTYP)::GRRT
DOUBLE PRECISION::R1,R2
INTEGER::IDR
INTEGER::K1,K2,K3,K4
!DOUBLE PRECISION,DIMENSION(NATOM,27,3)::SPOS
INTEGER::NS,INS,NX,NY,NZ,I1
DOUBLE PRECISION::DV,AREA,XD,YD,ZD
DOUBLE PRECISION,DIMENSION(NATOM,NATOM)::AMODA
AA=0
PRINT*, "I M IN GRRFN2"
PRINT*,IT
WRITE(111,*)'# TIME=IT,LL',IT,LL
GRRT=0
DO IDR=1,NR
   R1=((IDR-1)*DELR)+R0
   R2=((IDR)*DELR)+R0
   RM=R0+(R1+R2)*0.5
   GRR=0
!$omp parallel do
   DO I=1,NATOM
      DO J=I,NATOM
            AA(I,J,:)=RR1(I,:)-RR1(J,:)  !POS(IT,I,:)-POS(IT,J,:)
	    WHERE(AA(I,J,:).LE.-0.5)AA(I,J,:)=AA(I,J,:)+1
	    WHERE(AA(I,J,:).gE.0.5)AA(I,J,:)=AA(I,J,:)-1
            !AA(I,J,:)=MATMUL(TRANSPOSE(SLATORIG),AA(I,J,:))                       !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!CHECK
            AA(I,J,:)=MATMUL(AA(I,J,:),SLATORIG)                       !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!CHECK
            AMODA(I,J)=NORM2(AA(I,J,:))
            !PRINT*,POS(IT,I,:),POS(IT,J,:),AA,AMODA
            IF(AMODA(I,J).GT.R1.AND.AMODA(I,J).LE.R2)GRR(I,J)=GRR(I,J)+1
	    !print*,rr1(i,:),pos(it,i,:) !aa(i,j,:),amoda(i,J)
            !print*,matmul(transpose(slatorig),rr1(i,:))
            !print*,aa(i,j,:),amoda(i,J)
            !pause
102       FORMAT(F3.1,2I4,F5.1)
          GRR(J,I)=GRR(I,J)
          GRTOTAL(IDR)=GRTOTAL(IDR)+GRR(I,J)
      END DO
   END DO
!$omp end parallel do

   DO I=1,NTYP
      DO J=1,NTYP
        K1=SUM(NNTYPE(1:I-1))+1
        K2=SUM(NNTYPE(1:I))
        K3=SUM(NNTYPE(1:J-1))+1
        K4=SUM(NNTYPE(1:J))
        GRRT(IDR,I,J)=SUM(GRR(K1:K2,K3:K4))
        GRRT(IDR,I,J)=GRRT(IDR,I,J)/((K2-k1+1))
!        GRRT(IDR,J,I)=GRRT(IDR,I,J)
        END DO
   END DO
!!!!!$omp parallel do
!!!!$omp end parallel do
   AREA=4.0*PI*(RM**2)
   DV=AREA*DELR
   GRRT(IDR,:,:)=GRRT(IDR,:,:)/DV
   !GRTOTAL(IDR)=SUM(GRR(:,:))/(DV*NATOM)
   GRTOTAL(IDR)=GRTOTAL(IDR)/(DV*NATOM)
   WRITE(111,11)RM ,((GRRT(IDR,I,J),J=I,NTYP),I=1,NTYP),GRTOTAL(IDR) !,SUM(GRRT(IDR,:,:))
   11 FORMAT(F6.3,2x,100F8.4)
  ! WRITE(101,101)IDR*DELR, (INT((GRR(1,I1))),I1=1,64)
   101 format (F4.1,100I3)
END DO
!!!!!!!!!!!!!!!!!!
DO IDR=1,NR
   DO I=1,NTYP
      DO J=1,NTYP
      GRRTAVG(IDR,I,J)=GRRTAVG(IDR,I,J)+GRRT(IDR,I,J)
      END DO
   END DO
      GAVG(IDR)=GAVG(IDR)+GRTOTAL(IDR)
END DO


!RMAX=INT((GRCUT-R0)/DELR)
!ASTATUS=ANY(GRTOTAL(1:RMAX).GT.0,DIM = 1)
!PRINT*,RMAX,ASTATUS



!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!
!IF(IT.EQ.IREF2-IREF1)THEN
!DO IDR=1,NR
!WRITE(83,83)R0+(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(LL),J=I,NTYP),I=1,NTYP),GAVG(IDR)/REAL(LL)
!WRITE(83,83)R0+(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(IPOINTS),J=I,NTYP),I=1,NTYP),GAVG(IDR)/REAL(IPOINTS)
!END DO
!END IF
!83 FORMAT(F6.3,2x,100F8.4)
END SUBROUTINE






SUBROUTINE IIFQT2(IQQQQ)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
COMPLEX,ALLOCATABLE,DIMENSION(:,:)::FQT,FFQTTYP !,SQWB
COMPLEX,ALLOCATABLE,DIMENSION(:,:)::FFQT,SQW
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
DOUBLE PRECISION::PHASE1
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME,PLAN
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::AAA
INTEGER::II1,I1,DT1,III
!DOUBLE  PRECISION,ALLOCATABLE,DIMENSION(:,:)::KLIST
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DUMMY1,DUMMY3
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DUMMY2,DUMMY4
DOUBLE PRECISION::EE
!#INTEGER::ITYP
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK
INTEGER::ITYPPP,JTYPPP
INTEGER::IQQQQ
CHARACTER::AA*9
!INTEGER::ICOH
!WRITE(AA,'("SQWTOT",I2.2)')IQQQQ
!OPEN(170,FILE=AA)

!WRITE(AA,'("SQWATM",I2.2)')IQQQQ
!OPEN(180,FILE=AA)

WRITE(AA,'("IQTTOT",I2.2)')IQQQQ
OPEN(190,FILE=AA)


WRITE(AA,'("IQTATM",I2.2)')IQQQQ
OPEN(200,FILE=AA)


!OPEN(17,FILE="SQ")
!OPEN(18,FILE="SQA")
OPEN(19,FILE="CIQ")
OPEN(20,FILE="CIQA")




PRINT*,'I AM IN IFFQT2'

ALLOCATE(FQT(1:NSTEP,NATOM))
ALLOCATE(FFQT(1:NSTEP,NATOM))
ALLOCATE(SQW(-NSTEP:NSTEP,NATOM)) !,SQWB(NQ,-NW:NW))
ALLOCATE(AAA(1:2*NSTEP))
ALLOCATE(FFQTTYP(1:NSTEP,NTYP))
!ALLOCATE(KLIST(10000,3))


FFQT=0
FQT=0
SQW=0
IFOR= 1
IBAC=-1



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!MONTE CARLO FOR QPOINT GENERATION!!!!!!!!!!!!!
!PRINT*,'ILIST 1 FOR SPHERICAL AVERAGING 2 FOR HKL INDEX'
!READ*,ILIST
!PRINT*, 'I AM IN IIFQT'
!IF(ILIST==1)THEN
!ICARTESIAN=1
!PRINT*,'ICARTESIAN',ICARTESIAN
!CALL KLIST_GEN(NQPOINT,QWIDTH,QAVG)
!END IF
!
!IF(ILIST==2)THEN
!ICARTESIAN=0
!PRINT*,'QMIN, QMAX AND QQSTEP'
!READ*,QQMIN,QQMAX,QQSTEP
!PRINT*,'ICARTESIAN',ICARTESIAN
!CALL KLIST_GEN2(AVGISLAT,QQMIN,QQMAX) !(NQPOINT,QWIDTH,QAVG)
!END IF
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

WRITE(AA,'("KKLIST",I2.2)')IQQQQ
OPEN(44,FILE=AA)
!OPEN(44,FILE="KLIST")
I=0
DO
I=I+1
READ(44,*,END=100)KLIST(I,:)
END DO
100 CONTINUE
NQ=I-1
I=0
!END IF
PRINT*,NQ
ALLOCATE(QQ(NQ,3),QK(NQ,3))
ALLOCATE(DUMMY1(NQ,NSTEP),DUMMY2(NQ,NTYP,NSTEP),DUMMY3(NQ,NSTEP),DUMMY4(NQ,NTYP,NSTEP))
DO IQ=1,NQ
PRINT*,'IQ=',IQ
        !KVEC=KSTART+DIR1*DELQ*IQ
        QQ(IQ,:)=KLIST(IQ,:) !VEC
        IF(ICARTESIAN==1)THEN
        KVEC=KLIST(IQ,:)
        ELSE
        !KVEC=2.0*PI*MATMUL(KLIST(IQ,:),AVGISLAT)
        KVEC=2.0*PI*MATMUL(AVGISLAT, KLIST(IQ,:)) !!!!!!!!!!!!!!!RECIPROCAL ISTRANSPOSE OF AVGISLAT, HENCE MULTIPLY OTHERWAY
        END IF
        QK(IQ,:)=KVEC
!       WRITE(17,17)'#QVECT(FRACT)=',KVEC
!       WRITE(18,17)'#QVECT(FRACT)=',KVEC
!       WRITE(19,17)'#QVECT(FRACT)=',KVEC
!       WRITE(20,17)'#QVECT(FRACT)=',KVEC
!        IF(ICARTESIAN==0)KVEC=MATMUL(KVEC,AVGISLAT)
!        PRINT*,QK(IQ,:)
!        PAUSE
!       WRITE(17,17)'#QVECT(A-1)=',KVEC
!       WRITE(18,17)'#QVECT(A-1)=',KVEC
!       WRITE(19,17)'#QVECT(A-1)=',KVEC
!       WRITE(20,17)'#QVECT(A-1)=',KVEC
        17 FORMAT(A12,2X,3F10.5)

        !omp parallel do
        DO I=1,NATOM
                DO IT=1,NSTEP
                PHASE1=DOT_PRODUCT(KVEC,POS(IT,I,:))
                FQT(IT,I)=CMPLX(COS(PHASE1),SIN(PHASE1))
                END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                IF(ICOH==1)THEN

                DO J=1,NATOM
                DO DT=1,NSTEP-OINT
                NSTEP1=NSTEPI
                NSTEP2=NSTEPI+DT

                IF(NSTEPI+DT.GT.NSTEP)NSTEP1=NSTEP-DT
                IF(NSTEPI+DT.GT.NSTEP)NSTEP2=NSTEP1+DT
                FFQT(DT,I)=FFQT(DT,I)+DOT_PRODUCT(FQT(1:NSTEP1:OINT,I),FQT(1+DT:NSTEP2:OINT,J))
                TAO=NSTEPI
                IF(NSTEPI+DT.GT.NSTEP)TAO=NSTEP-DT
                FFQT(DT,I)=FFQT(DT,I)/REAL(TAO/OINT)
111             FORMAT(3I20,3E20.5)
                END DO
                END DO

        ELSE
        J=I
                DO DT=1,NSTEP-OINT
                NSTEP1=NSTEPI
                NSTEP2=NSTEPI+DT
                IF(NSTEPI+DT.GT.NSTEP)NSTEP1=NSTEP-DT
                IF(NSTEPI+DT.GT.NSTEP)NSTEP2=NSTEP1+DT
                FFQT(DT,I)=DOT_PRODUCT(FQT(1:NSTEP1:OINT,I),FQT(1+DT:NSTEP2:OINT,I))
                TAO=NSTEPI
                IF(NSTEPI+DT.GT.NSTEP)TAO=NSTEP-DT
                FFQT(DT,I)=FFQT(DT,I)/REAL(TAO/OINT)
                END DO
        END IF
        END DO
!       DO DT=1,NSTEP-OINT
!       IF(ICOH==0)     WRITE(171,15)REAL(DT)*DELT,SUM(FFQT(DT,:))/NATOM
!       IF(ICOH==1)     WRITE(171,15)REAL(DT)*DELT,SUM(FFQT(DT,:))/(NATOM*NATOM)
!       END DO
!omp end parallel do
999 CONTINUE




                DO DT=1,NSTEP
                DO I=1,NTYP
                N1=SUM(NNTYPE(1:(I-1)))+1
                N2=SUM(NNTYPE(1:I))
                FFQTTYP(DT,I)=SUM(FFQT(DT,N1:N2))
                END DO
                END DO


                DO DT=1,NSTEP
                IF(ICOH==0.OR.ICOH==1)  WRITE(19,15)REAL(DT)*DELT,SUM(REAL(FFQT(DT,:)))/SUM(REAL(FFQT(1,:))) !NATOM
                IF(ICOH==0.OR.ICOH==1)  WRITE(20,15)REAL(DT)*DELT,REAL(FFQTTYP(DT,:))/REAL(FFQTTYP(1,:)) !NATOM
                END DO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!omp end parallel do



END DO

!REWIND(17)
!REWIND(18)
REWIND(19)
REWIND(20)
!END DO




DO IQ=1,NQ
DO DT=1,NSTEP
!READ(17,15)EE,DUMMY1(IQ,DT)
!READ(18,15)EE,DUMMY2(IQ,:,DT) !,ITYP=1,NTYP)
READ(19,15)EE,DUMMY3(IQ,DT)
READ(20,15)EE,DUMMY4(IQ,:,DT) !,ITYP=1,NTYP)
END DO
END DO


!WRITE(170,170)'#h k l=     ',(QQ(IQ,:),IQ=1,NQ)
!WRITE(180,170)'#h k l=     ',(QQ(IQ,:),IQ=1,NQ),(QQ(IQ,:),IQ=1,NQ)
!WRITE(190,172)'#h k l=     ',(QQ(IQ,:),IQ=1,NQ)
!WRITE(200,171)((ATMNM(I),IQ=1,NQ),I=1,NTYP),(ATMNM(I),I=1,NTYP)
!WRITE(200,170)'#h k l=     ',(QQ(IQ,:),IQ=1,NQ),(QQ(IQ,:),IQ=1,NQ)
!WRITE(170,170)'#h k l(A-1) ',(QK(IQ,:),IQ=1,NQ)
!WRITE(180,170)'#h k l(A-1) ',(QK(IQ,:),IQ=1,NQ),(QK(IQ,:),IQ=1,NQ)
!WRITE(190,170)'#h k l(A-1) ',(QK(IQ,:),IQ=1,NQ)
!WRITE(200,170)'#h k l(A-1) ',(QK(IQ,:),IQ=1,NQ),(QK(IQ,:),IQ=1,NQ)
170 FORMAT(A12,100(3X,3F6.2,3X))
172 FORMAT(A12,<NQ>(3X,3F6.2,3X),6X,'AVG OVER Q')
!171 FORMAT(12X,<NTYP*NQ>(11X,A3,10X),<NTYP>(8X,'avg',A3,10X) )
171 FORMAT(A3,12X,<NTYP>(8X,'avg',A3,10X) )
WRITE(200,171)'#',(ATMNM(I),I=1,NTYP)
WRITE(190,171)'#',(ATMNM(I),I=1,NTYP)
DO DT=1,NSTEP
        OMEGA=REAL((DT-1)/(DELT*NSTEP))
!WRITE(170,15)OMEGA,DUMMY1(1:NQ,DT)
!WRITE(180,15)OMEGA,((DUMMY2(IQ,ITYP,DT),IQ=1,NQ),ITYP=1,NTYP)
!WRITE(170,15)OMEGA,SUM(DUMMY1(1:NQ,DT))
!WRITE(180,15)OMEGA,(SUM(DUMMY2(1:IQ,ITYP,DT)),ITYP=1,NTYP)
!WRITE(190,15)REAL(DT)*DELT,DUMMY3(1:NQ,DT),SUM(DUMMY3(:,DT)/NQ)
WRITE(190,15)REAL(DT-1)*DELT,SUM(DUMMY3(:,DT)/NQ)
!WRITE(200,15)REAL(DT)*DELT,((DUMMY4(IQ,ITYP,DT),IQ=1,NQ),ITYP=1,NTYP),((SUM(DUMMY4(:,ITYP,DT))/NQ),ITYP=1,NTYP)
WRITE(200,15)REAL(DT-1)*DELT,((SUM(DUMMY4(:,ITYP,DT))/NQ),ITYP=1,NTYP)
        15 FORMAT(F15.4,1003E12.4)
END DO


CLOSE(170)
CLOSE(180)
CLOSE(190)
CLOSE(200)
CLOSE(17)
CLOSE(18)
CLOSE(19)
CLOSE(20)
CLOSE(44)
DEALLOCATE(FQT,FFQT,SQW,AAA)
END SUBROUTINE













      SUBROUTINE dfour1(data,nn,isign)
      INTEGER isign,nn
      DOUBLE PRECISION data(2*nn)
      INTEGER i,istep,j,m,mmax,n
      DOUBLE PRECISION tempi,tempr
      DOUBLE PRECISION theta,wi,wpi,wpr,wr,wtemp
      n=2*nn
      j=1
      do 11 i=1,n,2
        if(j.gt.i)then
          tempr=data(j)
          tempi=data(j+1)
          data(j)=data(i)
          data(j+1)=data(i+1)
          data(i)=tempr
          data(i+1)=tempi
        endif
        m=n/2
1       if ((m.ge.2).and.(j.gt.m)) then
          j=j-m
          m=m/2
        goto 1
        endif
        j=j+m
11    continue
      mmax=2
2     if (n.gt.mmax) then
        istep=2*mmax
        theta=6.28318530717959d0/(isign*mmax)
        wpr=-2.d0*sin(0.5d0*theta)**2
        wpi=sin(theta)
        wr=1.d0
        wi=0.d0
        do 13 m=1,mmax,2
          do 12 i=m,n,istep
            j=i+mmax
            tempr=wr*data(j)-wi*data(j+1)
            tempi=wr*data(j+1)+wi*data(j)
            data(j)=data(i)-tempr
            data(j+1)=data(i+1)-tempi
            data(i)=data(i)+tempr
            data(i+1)=data(i+1)+tempi
12        continue
          wtemp=wr
          wr=wr*wpr-wi*wpi+wr
          wi=wi*wpr+wtemp*wpi+wi
13      continue
        mmax=istep
      goto 2
      endif
      return
      END






SUBROUTINE KLIST_GEN(NNQPOINT,QQWIDTH,QQAVG)
!USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(3)::QQ,QTEST
DOUBLE PRECISION::MODR,QQWIDTH,QQAVG
INTEGER::SIZER,NCOUNT,I,NNQPOINT
DOUBLE PRECISION,DIMENSION(100000,3)::r
OPEN(34,FILE="KLIST")
NCOUNT=0
call random_number(r)
r(:,1)=2.0*(r(:,1)-0.5)
r(:,2)=2.0*(r(:,2)-0.5)
r(:,3)=2.0*(r(:,3)-0.5)

r=QQAVG*r
PRINT*,NNQPOINT,QQWIDTH,QQAVG
DO I=1,100000
!PRINT*,r(I,:)
modr=norm2(r(i,:))
if(modr.le.(QQAVG+QQWIDTH).and. modr.ge. (QQAVG-QQWIDTH))THEN
NCOUNT=NCOUNT+1
IF(NCOUNT.GT.NNQPOINT)EXIT
WRITE(34,34)r(I,:),modr
34  FORMAT(3F15.8,5X,F15.8)
end if
!PAUSE
END DO

END SUBROUTINE









SUBROUTINE KLIST_GEN2(AAVGISLAT,QMIN,QMAX,IQQQQQ)
IMPLICIT NONE
!USE VARIABLES
INTEGER::H,K,L
DOUBLE PRECISION,DIMENSION(3)::QVEC
DOUBLE PRECISION,DIMENSION(3,3)::AAVGISLAT
DOUBLE PRECISION::QMOD
INTEGER::IHKL
DOUBLE PRECISION::PI
DOUBLE PRECISION::QMIN,QMAX
INTEGER::IQQQQQ
CHARACTER::AAAA*9
PI=4.0*ATAN(1.0) 
PRINT*,IQQQQQ,QMIN,QMAX
WRITE(AAAA,'("KKLIST",I2.2)')IQQQQQ
OPEN(1,FILE=AAAA)
PRINT*,AAVGISLAT(1,:)
PRINT*,AAVGISLAT(2,:)
PRINT*,AAVGISLAT(3,:)
PRINT*,QMIN,QMAX
!OPEN(1,FILE="KKLIST")
!IHKL=0
DO H=0,50
DO K=0,50
DO L=0,50
!IHKL=IHKL+1
QVEC(:)=(/H,K,L/)
!QVEC(:)=MATMUL(QVEC(:),AAVGISLAT)
QVEC(:)=MATMUL(AAVGISLAT,QVEC(:))   !RECIPROCAL LATTICE IS TRANSPOSE OF ISLAT, HENCE MULTIPLY IN OTHERWAY
QMOD=2.0*PI*SQRT(DOT_PRODUCT(QVEC(:),QVEC(:)))
IF(H+K+L.NE.0.AND.QMOD.LE.QMAX.AND.QMOD.GE.QMIN)THEN
!PRINT*,(/H,K,L/)
!PRINT*,QVEC
!PAUSE
!IF(QMOD.LE.QMAX.AND.QMOD.GE.QMIN)THEN
!IHKL=IHKL+1
11 FORMAT(3I7,F12.5)
WRITE(1,11)H,K,L,QMOD
END IF
END DO
END DO
END DO
!CALL SYSTEMQQ("sort -k 4n KKLIST >KLIST")
!CALL SYSTEMQQ("cp KLIST KLIST$IQQQQQ")
END SUBROUTINE        









SUBROUTINE MSD1
USE VARIABLES1
use omp_lib
IMPLICIT NONE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::MSDPOS !,MSDPOS1
COMPLEX,ALLOCATABLE,DIMENSION(:,:,:)::MSDPOS1
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::MSDPOST
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::MSDPOSTX,MSDPOSTY,MSDPOSTZ
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::AAA
INTEGER::I1,IBAC,IFOR,II1
DOUBLE PRECISION::POSINT
IBAC=-1
IFOR=1
ALLOCATE(MSDPOS(NSTEP,NATOM,3))
ALLOCATE(MSDPOS1(NSTEP,NATOM,3))
ALLOCATE(AAA(2*NSTEP))
ALLOCATE(MSDPOST(NSTEP,NTYP))
ALLOCATE(MSDPOSTX(NSTEP,NTYP))
ALLOCATE(MSDPOSTY(NSTEP,NTYP))
ALLOCATE(MSDPOSTZ(NSTEP,NTYP))
!OPEN(145,FILE="MSDXYZ")
!OPEN(146,FILE="MSD")
!DOUBLE PRECISION,ALLOCATABLE ,DIMENSION(:)::MSDAVG
!COMPLEX,DIMENSION(NSTEP)::MSDI
MSDPOS=0
MSDPOS1=0
MSDPOST=0
MSDPOSTX=0
MSDPOSTY=0
MSDPOSTZ=0

AAA=0
DO I=1,NATOM
DO J=1,3
POS(NSTEPORIG:NSTEP,I,J)=POS(NSTEPORIG,I,J)

END DO
END DO
PRINT*,'NSTEPORIG',NSTEPORIG
!!!omp parallel do
        DO I=1,NATOM
        DO J=1,3
        POSINT=DOT_PRODUCT(POS(:,I,J),POS(:,I,J))/(NSTEP)
        IF(I==1) PRINT*,POSINT
                II1=1
                DO I1=1,2*NSTEP,2
                AAA(I1)=POS(II1,I,J)
                AAA(I1+1)=0  !AIMAG(FQT(II1,I))
                II1=II1+1
                END DO
                CALL dfour1(AAA,NSTEP,IFOR)
                II1=1
                DO I1=1,2*NSTEP,2
                MSDPOS(II1,I,J)=AAA(I1)*AAA(I1) + AAA(I1+1)*AAA(I1+1) !CMPLX(AAA(I1),AAA(I1+1))
                II1=II1+1
                END DO

                II1=1
                DO I1=1,2*NSTEP,2
                AAA(I1)=MSDPOS(II1,I,J)
                AAA(I1+1)=0  !AIMAG(FQT(II1,I))
                II1=II1+1
                END DO
                CALL dfour1(AAA,NSTEP,IBAC)


                II1=1
                DO I1=1,2*NSTEP,2
!                MSDPOS1(II1,I,J)=CMPLX(AAA(I1),AAA(I1+1))/(NSTEP*NSTEP)
                MSDPOS(II1,I,J)=2.0*(POSINT - REAL(AAA(I1))/(NSTEP*NSTEP))    ! *AAA(I1) !+ AAA(I1+1)*AAA(I1+1) !CMPLX(AAA(I1),AAA(I1+1))
                II1=II1+1
                END DO
        END DO
        END DO
!!!omp end parallel do
!DO I=1,NSTEP
!WRITE(145,145)I,MSDPOS(I,1,:)
145 FORMAT(I6,6E15.6)
!END DO




DO IT=1,NSTEP
DO I=1,NTYP
N1=SUM(NNTYPE(1:I-1)) + 1
N2=SUM(NNTYPE(1:I))
MSDPOSTX(IT,I)=(SUM(MSDPOS(IT,N1:N2,1)))/NNTYPE(I)
MSDPOSTY(IT,I)=(SUM(MSDPOS(IT,N1:N2,2)))/NNTYPE(I)
MSDPOSTZ(IT,I)=(SUM(MSDPOS(IT,N1:N2,3)))/NNTYPE(I)
MSDPOST(IT,I)=MSDPOSTX(IT,I) + MSDPOSTY(IT,I)+MSDPOSTZ(IT,I)  
END DO
!WRITE(145,146)DELT*REAL(IT),((MSDPOSTX(IT,:),MSDPOSTY(IT,I),MSDPOSTZ(IT,I)),I=1,NTYP)
!WRITE(146,146)DELT*REAL(IT),MSDPOST(IT,:)
!146 FORMAT(F15.5,1000F10.5)
END DO

DO I=1,NSTEPORIG-OINT
                WRITE(195,98)DELT*REAL(I),((MSDPOS(I,K,1)+MSDPOS(I,K,2)+MSDPOS(I,K,3)),K=1,NATOM)
                WRITE(196,98)DELT*REAL(I),((MSDPOSTX(I,K)+MSDPOSTY(I,K)+MSDPOSTZ(I,K)),K=1,NTYP)

                WRITE(197,98)DELT*REAL(I),((MSDPOS(I,K,1),MSDPOS(I,K,2),MSDPOS(I,K,3)),K=1,NATOM)
                WRITE(198,98)DELT*REAL(I),((MSDPOSTX(I,K),MSDPOSTY(I,K),MSDPOSTZ(I,K)),K=1,NTYP)
98             FORMAT(F16.5,10000F16.5)
END DO
DEALLOCATE(MSDPOS,AAA)
END SUBROUTINE



SUBROUTINE MSD2
USE VARIABLES1
use omp_lib
IMPLICIT NONE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::MSDX,MSDY,MSDZ,MSDGX,MSDGY,MSDGZ
INTEGER::I1,IBAC,IFOR,II1
INTEGER::M
INTEGER::NSTEPORIG2
DOUBLE PRECISION::POSINT
ALLOCATE(MSDX(NSTEPORIG,NATOM))
ALLOCATE(MSDY(NSTEPORIG,NATOM))
ALLOCATE(MSDZ(NSTEPORIG,NATOM))
ALLOCATE(MSDGX(NSTEPORIG,NTYP))
ALLOCATE(MSDGY(NSTEPORIG,NTYP))
ALLOCATE(MSDGZ(NSTEPORIG,NTYP))
OPEN(145,FILE="MSDXYZ")
OPEN(146,FILE="MSD")
!DOUBLE PRECISION,ALLOCATABLE ,DIMENSION(:)::MSDAVG
!COMPLEX,DIMENSION(NSTEP)::MSDI
MSDX=0
MSDY=0
MSDZ=0
MSDGX=0
MSDGY=0
MSDGZ=0
NSTEPORIG2=IREF2-IREF1+1 
PRINT*,NSTEPORIG2
PRINT*, 'THE U2 IS AVERAGED FOR',NSTEPI,'LENGHT, WITH ',OINT, 'INTERVAL'
!READ*,NSTEPI
IF(NSTEPI.GT.NSTEPORIG2)NSTEPI=NSTEPORIG2
!$omp parallel do
DO I=1,NATOM
PRINT*, 'ATOM NO',I,'has been done MSD2'
                DO DT=1,NSTEPORIG2-OINT
                NSTEP1=NSTEPI
                NSTEP2=NSTEPI+DT
                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP1=NSTEPORIG2-DT
                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP2=NSTEP1+DT
                MSDX(DT,I)=SUM((POS(1:NSTEP1:OINT,I,1)-POS(1+DT:NSTEP2:OINT,I,1))**2) ! + &
                MSDY(DT,I)=SUM((POS(1:NSTEP1:OINT,I,2)-POS(1+DT:NSTEP2:OINT,I,2))**2) !
                MSDZ(DT,I)=SUM((POS(1:NSTEP1:OINT,I,3)-POS(1+DT:NSTEP2:OINT,I,3))**2) !  )
                TAO=NSTEPI
                IF(NSTEPI+DT.GT.NSTEPORIG2)TAO=NSTEPORIG2-DT
                MSDX(DT,I)=MSDX(DT,I)/REAL((TAO/OINT))
                MSDY(DT,I)=MSDY(DT,I)/REAL((TAO/OINT))
                MSDZ(DT,I)=MSDZ(DT,I)/REAL((TAO/OINT))
                END DO
!                       MSD(DT,I)=sum( (PPOS(1:nstep,:) - PPOS(1+dt:nstep+dt,:))**2 ) /dble(nt)
END DO
!$omp end parallel do
                        N1=0
                        N2=0
                        DO M=1,NTYP

                                N1=N2+1
                                N2=N1+NNTYPE(M)-1
                                DO K=N1,N2
                                MSDGX(:,M)=MSDGX(:,M)+MSDX(:,K)
                                MSDGY(:,M)=MSDGY(:,M)+MSDY(:,K)
                                MSDGZ(:,M)=MSDGZ(:,M)+MSDZ(:,K)
                                END DO
                        MSDGX(:,M)=MSDGX(:,M)/NNTYPE(M)
                        MSDGY(:,M)=MSDGY(:,M)/NNTYPE(M)
                        MSDGZ(:,M)=MSDGZ(:,M)/NNTYPE(M)
                        END DO
DO I=1,NSTEPORIG2-OINT
                WRITE(195,98)DELT*REAL(I),((MSDX(I,K)+MSDY(I,K)+MSDZ(I,K)),K=1,NATOM)
                WRITE(196,98)DELT*REAL(I),((MSDGX(I,K)+MSDGY(I,K)+MSDGZ(I,K)),K=1,NTYP)
                WRITE(197,98)DELT*REAL(I),((MSDX(I,K),MSDY(I,K),MSDZ(I,K)),K=1,NATOM)
                WRITE(198,98)DELT*REAL(I),((MSDGX(I,K),MSDGY(I,K),MSDGZ(I,K)),K=1,NTYP)
98             FORMAT(F16.6,10000F16.5)
END DO
DEALLOCATE(MSDX,MSDY,MSDZ,MSDGX,MSDGY,MSDGZ)
END SUBROUTINE


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!



SUBROUTINE IFQT
USE VARIABLES1
IMPLICIT NONE
COMPLEX,ALLOCATABLE,DIMENSION(:,:)::FQT,SQW,SQWB
COMPLEX,ALLOCATABLE,DIMENSION(:,:,:,:)::FFQT
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
DOUBLE PRECISION::PHASE1
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME
COMPLEX,ALLOCATABLE,DIMENSION(:)::AAA,BBB
DOUBLE PRECISION::DELX,BROAD,SUMM
!
!READ*,ISCHEME


DELQ=1.0
DELW=0.001
NQ=1
NW=200
KSTART=(/0, 0, 0/)
DIR1=(/1, 1 ,1/)
FQT=0
FFQT=0
ICOH=0
FWHM2=0.001
ALLOCATE(FQT(NSTEP,NATOM))
ALLOCATE(FFQT(NQ,NSTEP,NATOM,NATOM))
ALLOCATE(SQW(NQ,-NW:NW),SQWB(NQ,-NW:NW))
ALLOCATE(AAA(NSTEP),BBB(NSTEP))
FFQT=0
FQT=0
SQW=0
IFOR= 1
IBAC=-1
PRINT*, 'I AM IN IFQT'
DO IQ=1,NQ
        KVEC=KSTART+DIR1*DELQ*IQ
	WRITE(15,*)'#QVECT(FRACT)=',KVEC
	WRITE(16,*)'#QVECT(FRACT)=',KVEC
        !KVEC=MATMUL(KVEC,ISLAT)
        KVEC=MATMUL(ISLAT,KVEC)
	WRITE(15,*)'#QVECT(A-1)=',KVEC
	WRITE(16,*)'#QVECT(A-1)=',KVEC

        DO I=1,NATOM
        	DO IT=1,NSTEP
                PHASE1=DOT_PRODUCT(KVEC,POS(IT,I,:))
                FQT(IT,I)=CMPLX(COS(PHASE1),SIN(PHASE1))
                END DO
	IF(ISCHEME==2)THEN
	AAA=FQT(:,I)
	!CALL FFT(AAA,BBB,IFOR,NSTEP)
	FQT(:,I)=BBB
	END IF
        END DO

!omp parallel do
        DO I=1,NATOM
	IF(ICOH==1)THEN

        DO J=1,NATOM
        DO DT=1,NSTEP-OINT
                NSTEP1=NSTEPI
                NSTEP2=NSTEPI+DT

                IF(NSTEPI+DT.GT.NSTEP)NSTEP1=NSTEP-DT
                IF(NSTEPI+DT.GT.NSTEP)NSTEP2=NSTEP1+DT
                FFQT(IQ,DT,I,J)=DOT_PRODUCT(FQT(1:NSTEP1:OINT,I),FQT(1+DT:NSTEP2:OINT,J))
                TAO=NSTEPI
                IF(NSTEPI+DT.GT.NSTEP)TAO=NSTEP-DT
                FFQT(IQ,DT,I,J)=FFQT(IQ,DT,I,J)/REAL(TAO/OINT)
111             FORMAT(3I20,3E20.5)
        END DO
        END DO

	ELSE
	J=I
        DO DT=1,NSTEP-OINT
                NSTEP1=NSTEPI
                NSTEP2=NSTEPI+DT

                IF(NSTEPI+DT.GT.NSTEP)NSTEP1=NSTEP-DT
                IF(NSTEPI+DT.GT.NSTEP)NSTEP2=NSTEP1+DT
                FFQT(IQ,DT,I,J)=DOT_PRODUCT(FQT(1:NSTEP1:OINT,I),FQT(1+DT:NSTEP2:OINT,J))
                TAO=NSTEPI
                IF(NSTEPI+DT.GT.NSTEP)TAO=NSTEP-DT
                FFQT(IQ,DT,I,I)=FFQT(IQ,DT,I,I)/REAL(TAO/OINT)

        END DO
	END IF
	END DO
	DO DT=1,NSTEP-OINT
	IF(ICOH==0)	WRITE(171,15)REAL(DT)*DELT,SUM(FFQT(IQ,DT,:,:))/NATOM
	IF(ICOH==1)	WRITE(171,15)REAL(DT)*DELT,SUM(FFQT(IQ,DT,:,:))/(NATOM*NATOM)
	END DO
!omp end parallel do
999 CONTINUE


	IF(ICOH==1)THEN
        DO IW=-NW,NW
        FRE=DELW*IW
        DO DT=0,NSTEP-OINT
        DO I=1,NATOM
        DO J=1,NATOM
        PHASE2=2.0*PI*FRE*DT*DELT
        PHASEFACTOR=CMPLX(COS(PHASE2),SIN(PHASE2))
        SQW(IQ,IW)=SQW(IQ,IW)+FFQT(IQ,DT,I,J)*PHASEFACTOR
        END DO
        END DO
        END DO
        WRITE(15,15)FRE,SQW(IQ,IW),ABS(SQW(IQ,IW))
        15 FORMAT(F17.5,3E15.7)
        END DO
	ELSE
        DO IW=-NW,NW
        FRE=DELW*IW
        DO DT=1,NSTEP-OINT
        DO I=1,NATOM
        J=I
        PHASE2=2.0*PI*FRE*DT*DELT
        PHASEFACTOR=CMPLX(COS(PHASE2),SIN(PHASE2))
        SQW(IQ,IW)=SQW(IQ,IW)+FFQT(IQ,DT,I,J)*PHASEFACTOR
        END DO
        END DO
        WRITE(15,15)FRE,SQW(IQ,IW),ABS(SQW(IQ,IW))
        END DO
	END IF

!!!!!!!!!!!!!!!!!!BROADENING IN SQW!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

PRINT*, 'FWHM2in meV=',FWHM2
FWHM2=FWHM2/4.136
DO I=-NW,NW
        FRE=I*DELW
        FWHM2=2*FWHM2*FWHM2
        SUMM=0
                DO IK=-NW,NW
                DELX=REAL(I-IK)*DELW
                DELX=DELX*DELX
                BROAD=EXP(-DELX/FWHM2)
                SQWB(IQ,I)=SQWB(IQ,I)+SQW(IQ,IK)*BROAD
                SUMM=SUMM+BROAD
                END DO
        SQWB(IQ,I)=SQWB(IQ,I)/SUMM
	WRITE(16,16)FRE,SQWB(IQ,I),ABS(SQWB(IQ,I))
	16 FORMAT(F12.8,3E17.6)
END DO

END DO

END SUBROUTINE




SUBROUTINE VVACF2 
use omp_lib
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(NTYP,3)::DIFFUSION
DOUBLE PRECISION::ANORM
DOUBLE PRECISION::TOTAL_WEIGHT
DOUBLE PRECISION,DIMENSION(NTYP)::WEIGHT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::NWPDOS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DOSTBS,DOSBS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DOSTBSS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DOSB
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::VACF,FTW,FTWT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::VACFT,FTWTB,FTWI,FTWTI
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMY1,DUMMY2
INTEGER::NNORM,INTEMAX
ALLOCATE(DOSTBS(NSTEP,NTYP))
ALLOCATE(DOSTBSS(NSTEP))
ALLOCATE(NWPDOS(NSTEP,NTYP))
ALLOCATE(DOSBS(NSTEP,NATOM))
ALLOCATE(DOSB(NSTEP,NATOM,3))
ALLOCATE(FTW(NSTEP,NATOM,3))
ALLOCATE(FTWT(NSTEP,NTYP,3))
ALLOCATE(FTWI(NSTEP,NATOM,3))
ALLOCATE(FTWTI(NSTEP,NTYP,3))
ALLOCATE(FTWTB(NSTEP,NTYP,3))
ALLOCATE(VACF(NSTEP,NATOM,3))
ALLOCATE(VACFT(NSTEP,NTYP,3))
ALLOCATE(DUMMY1(NDOS),DUMMY2(NDOS))


!!!!!!!!!!!!!!!!!!!!!!!!!VACF!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
PRINT*, "I M IN VVACF2"
PRINT*,'ENTER MAX INTEGERATION ENERGY FOR DOS NORMALIZATION IN MEV'
READ*,INTEMAX
!$omp parallel do
DO I=1,NATOM
                DO DT=1,NSTEP-OINT
                NSTEP1=NSTEPI
                NSTEP2=NSTEPI+DT
                IF(NSTEPI+DT.GT.NSTEP)NSTEP1=NSTEP-DT
                IF(NSTEPI+DT.GT.NSTEP)NSTEP2=NSTEP1+DT
                VACF(DT,I,1)=DOT_PRODUCT(VEL(1:NSTEP1:OINT,I,1),VEL(1+DT:NSTEP2:OINT,I,1))
                VACF(DT,I,2)=DOT_PRODUCT(VEL(1:NSTEP1:OINT,I,2),VEL(1+DT:NSTEP2:OINT,I,2))
                VACF(DT,I,3)=DOT_PRODUCT(VEL(1:NSTEP1:OINT,I,3),VEL(1+DT:NSTEP2:OINT,I,3))
                TAO=NSTEPI
                IF(NSTEPI+DT.GT.NSTEP)TAO=NSTEP-DT
                VACF(DT,I,1)=VACF(DT,I,1)/REAL((TAO/OINT))
                VACF(DT,I,2)=VACF(DT,I,2)/REAL((TAO/OINT))
                VACF(DT,I,3)=VACF(DT,I,3)/REAL((TAO/OINT))

111             FORMAT(3I20,3E20.5)
                END DO
END DO
!$omp end parallel do 


DO DT=1,NSTEP-OINT
        DO I=1,NTYP
                DO J=SUM(NNTYPE(1:I-1))+1,SUM(NNTYPE(1:I))
                VACFT(DT,I,:)=VACFT(DT,I,:)+VACF(DT,J,:)
                END DO
        END DO
        WRITE(80,80)(DT-1)*DELT, (SUM(VACFT(DT,I,:))/SUM(VACFT(1,I,:)),I=1,NTYP)
        80 FORMAT(F10.5,2x,100F15.5)
END DO


DO I=1,NTYP
DIFFUSION(I,1)=NNTYPE(I)*DELT*SUM(VACFT(:,I,1))/NATOM
DIFFUSION(I,2)=NNTYPE(I)*DELT*SUM(VACFT(:,I,2))/NATOM
DIFFUSION(I,3)=NNTYPE(I)*DELT*SUM(VACFT(:,I,3))/NATOM
!PRINT*,DIFFUSION(I,:)
END DO

DELE=4.136/REAL(DELT*NSTEP)
PRINT*,'DELE in meV=',DELE


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
PRINT*, "I M IN FFTW2"
!$omp  parallel do
DO IW=1,NDOS !NSTEP
DELW=4.136*REAL(1/(DELT*NSTEP))
OMEGA=4.136*REAL((IW-1)/(DELT*NSTEP))  ! in meV

        !IF(OMEGA.GT.200)EXIT
!OMEGA=REAL(IW-1)*DELW*2*PI

        DO I=1,NATOM
	DO IT1=1,NSTEPI
	TIME=DELT*IT1
	PHASE=OMEGA*TIME*2*PI/(4.136)   !!!!!!!OMEGA HAS TO BE THZ
	FTW(IW,I,:)=FTW(IW,I,:)+VACF(IT1,I,:)*COS(PHASE)
	FTWI(IW,I,:)=FTWI(IW,I,:)+VACF(IT1,I,:)*SIN(PHASE)
	END DO
	END DO



	N1=1
        DO I=1,NTYP
	N2=N1+NNTYPE(I)-1
		DO J=N1,N2
	FTWT(IW,I,:)=FTWT(IW,I,:)+FTW(IW,J,:)
	FTWTI(IW,I,:)=FTWTI(IW,I,:)+FTWI(IW,J,:)
		END DO
	N1=N2+1
	END DO




END DO
!$omp end parallel do


!!!!!!!!!!!!SET ZERO FOR NEGATIVE VALUE OF DOS
DO NN1=1,NDOS
DO NN2=1,NTYP
IF(FTWT(NN1,NN2,1).LT.1.0E-6)FTWT(NN1,NN2,1)=0
IF(FTWT(NN1,NN2,2).LT.1.0E-6)FTWT(NN1,NN2,2)=0
IF(FTWT(NN1,NN2,3).LT.1.0E-6)FTWT(NN1,NN2,3)=0
END DO
END DO
!I FOUND THAT THIS GIVE SPIKES AT HIGH ENERGY NOT SURE WHY?
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

NNORM=INT(INTEMAX/DELW)

     DO I=1,NTYP
     ANORM1=(SUM(ABS(FTWT(1:NNORM,I,1)))*DELW) !+ (SUM(ABS(FTWTI(:,I,1)))*DELW)**2
     ANORM2=(SUM(ABS(FTWT(1:NNORM,I,2)))*DELW) !**2 + (SUM(ABS(FTWTI(:,I,2)))*DELW)**2 
     ANORM3=(SUM(ABS(FTWT(1:NNORM,I,3)))*DELW) !**2 + (SUM(ABS(FTWTI(:,I,3)))*DELW)**2
     FTWT(:,I,1)=FTWT(:,I,1)/(ANORM1)
     FTWT(:,I,2)=FTWT(:,I,2)/(ANORM2)
     FTWT(:,I,3)=FTWT(:,I,3)/(ANORM3)

     FTWTI(:,I,1)=FTWTI(:,I,1)/(ANORM1)    !IMAGINARY  PART OF DOS 
     FTWTI(:,I,2)=FTWTI(:,I,2)/(ANORM2)
     FTWTI(:,I,3)=FTWTI(:,I,3)/(ANORM3)

     PRINT*,ANORM1,ANORM2,ANORM3
     END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!NORMALIZATION INDIVIDIUAL!!!!!!!!!!!!!
     DO I=1,NATOM
     ANORM1=(SUM(ABS(FTW(1:NDOS,I,1)))*DELW) !+ (SUM(ABS(FTWTI(:,I,1)))*DELW)**2
     ANORM2=(SUM(ABS(FTW(1:NDOS,I,2)))*DELW) !**2 + (SUM(ABS(FTWTI(:,I,2)))*DELW)**2 
     ANORM3=(SUM(ABS(FTW(1:NDOS,I,3)))*DELW) !**2 + (SUM(ABS(FTWTI(:,I,3)))*DELW)**2
     FTW(:,I,1)=FTW(:,I,1)/(ANORM1)
     FTW(:,I,2)=FTW(:,I,2)/(ANORM2)
     FTW(:,I,3)=FTW(:,I,3)/(ANORM3)
     FTWI(:,I,1)=FTWI(:,I,1)/(ANORM1)    !IMAGINARY  PART OF DOS 
     FTWI(:,I,2)=FTWI(:,I,2)/(ANORM2)
     FTWI(:,I,3)=FTWI(:,I,3)/(ANORM3)
     END DO



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!BROADENING THE DATA!!!!!!!!!!!!!!!!!!!!!!!
DO IJ=1,NTYP
DUMMY1=FTWT(1:NDOS,IJ,1)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
FTWTB(1:NDOS,IJ,1)=DUMMY2

DUMMY1=FTWT(1:NDOS,IJ,2)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
FTWTB(1:NDOS,IJ,2)=DUMMY2

DUMMY1=FTWT(1:NDOS,IJ,3)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
FTWTB(1:NDOS,IJ,3)=DUMMY2
END DO

!PRINT*, 'FWHM in meV=',FWHM0
!!FWHM0=FWHM0/4.136
!DELW=4.136*REAL(1.0/(DELT*NSTEP))
!DO I=1,NDOS  !NSTEP
!        OMEGA=4.136*REAL((I-1)/(DELT*NSTEP))
!        IF(OMEGA.GT.200)EXIT
!        FWHM=(FWHM0**2)  + ((FWHM1*OMEGA/100)**2)
!        DO IJ=1,NTYP   !!!!!!!!!! for dimension
!        SUMM=0
!                DO IK=00,NSTEP !1,MIN(100,NDOS) !1000
!                DELX=REAL(I-IK)*DELW
!                DELX=DELX*DELX
!                BROAD=EXP(-DELX/FWHM)
!                FTWTB(I,IJ,:)=FTWTB(I,IJ,:)+FTWT(IK,IJ,:)*BROAD
!                SUMM=SUMM+BROAD
!                END DO
!                IF(SUMM.GT.0)FTWTB(I,IJ,:)=FTWTB(I,IJ,:)/SUMM
!        IF(FTWTB(I,IJ,1).LT.1.0E-10)FTWTB(I,IJ,1)=0
!        IF(FTWTB(I,IJ,2).LT.1.0E-10)FTWTB(I,IJ,2)=0
!        IF(FTWTB(I,IJ,3).LT.1.0E-10)FTWTB(I,IJ,3)=0
!       END DO
!
!END DO

!!!!!!!!!!!!!!!!!BROADENING OF INDIVIDUAL!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
DO IJ=1,NATOM

DUMMY1=FTW(1:NDOS,IJ,1)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSB(1:NDOS,IJ,1)=DUMMY2

DUMMY1=FTW(1:NDOS,IJ,2)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSB(1:NDOS,IJ,2)=DUMMY2

DUMMY1=FTW(1:NDOS,IJ,3)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSB(1:NDOS,IJ,3)=DUMMY2
END DO



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

!DO I=1,NDOS  !NSTEP
!        OMEGA=4.136*REAL((I-1)/(DELT*NSTEP))
!        IF(OMEGA.GT.200)EXIT
!        FWHM=(FWHM0**2)  + ((FWHM1*OMEGA/100)**2)
!        DO IJ=1,NATOM   !!!!!!!!!! for dimension
!        SUMM=0
!                DO IK=0,NSTEP !1000
!                DELX=REAL(I-IK)*DELW
!                DELX=DELX*DELX
!                BROAD=EXP(-DELX/FWHM)
!                DOSB(I,IJ,:)=DOSB(I,IJ,:)+FTW(IK,IJ,:)*BROAD
!                SUMM=SUMM+BROAD
!                END DO
!                IF(SUMM.GT.0)DOSB(I,IJ,:)=DOSB(I,IJ,:)/SUMM
!        IF(DOSB(I,IJ,1).LT.1.0E-10)DOSB(I,IJ,1)=0
!        IF(DOSB(I,IJ,2).LT.1.0E-10)DOSB(I,IJ,2)=0
!        IF(DOSB(I,IJ,3).LT.1.0E-10)DOSB(I,IJ,3)=0
!        END DO
!END DO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

DO ITYP=1,NTYP
ANORM1=SUM(ABS(FTWTB(1:NDOS,ITYP,1)))*DELW
ANORM2=SUM(ABS(FTWTB(1:NDOS,ITYP,2)))*DELW
ANORM3=SUM(ABS(FTWTB(1:NDOS,ITYP,3)))*DELW
FTWTB(:,ITYP,1)=FTWTB(:,ITYP,1)/ANORM1
FTWTB(:,ITYP,2)=FTWTB(:,ITYP,2)/ANORM1
FTWTB(:,ITYP,3)=FTWTB(:,ITYP,3)/ANORM1
DOSTBS(:,ITYP)=(FTWTB(:,ITYP,1)+FTWTB(:,ITYP,2)+FTWTB(:,ITYP,3))/3.0
END DO

DO ITYP=1,NATOM
ANORM1=SUM(ABS(DOSB(1:NDOS,ITYP,1)))*DELW
ANORM2=SUM(ABS(DOSB(1:NDOS,ITYP,2)))*DELW
ANORM3=SUM(ABS(DOSB(1:NDOS,ITYP,3)))*DELW
DOSB(:,ITYP,1)=DOSB(:,ITYP,1)/ANORM1
DOSB(:,ITYP,2)=DOSB(:,ITYP,2)/ANORM1
DOSB(:,ITYP,3)=DOSB(:,ITYP,3)/ANORM1
DOSBS(:,ITYP)=(DOSB(:,ITYP,1)+DOSB(:,ITYP,2)+DOSB(:,ITYP,3))/3.0
END DO




        WRITE(81,*) '#ENE(meV), DOSXYZ_TYPE, DOSXYZIMG_TYPE'
        WRITE(82,*) '#ENE(meV), DOS_TYPE'
        DO IT=1,NDOS
        OMEGA=4.136*REAL((IT-1)/(DELT*NSTEP))
        IF(OMEGA.GT.200)EXIT
        DOSTBSS(IT)=SUM(DOSTBS(IT,:)*NNTYPE(:))/(SUM(NNTYPE(:)))
        WRITE(79,8)OMEGA,(SUM(FTWT(IT,IJ,1:3)),IJ=1,NTYP)  !,(FTWTI(I,IJ,:),IJ=1,NTYP)
        WRITE(81,8)OMEGA,(FTWTB(IT,IJ,:),IJ=1,NTYP)  !,(FTWTI(I,IJ,:),IJ=1,NTYP)
        WRITE(82,8)OMEGA,(DOSTBS(IT,ITYP),ITYP=1,NTYP),DOSTBSS(IT)
        WRITE(821,8) OMEGA,(DOSBS(IT,ITYP),ITYP=1,NATOM)
        8 FORMAT(F10.4,1000E20.8)
        END DO







PRINT*, 'I AM IN NEUTRON2'
WEIGHT=NNTYPE*BBT2/MASST
TOTAL_WEIGHT=SUM(WEIGHT) 
PRINT*, WEIGHT
!NWDOS=0
NWPDOS=0
DO I=1,NDOS
OMEGA=4.136*REAL((I-1)/(DELT*NSTEP))
IF(OMEGA.GT.200)EXIT

DO IJ=1,NTYP
!NWPDOS(I,IJ)=NWPDOS(I,IJ) +  (WEIGHT(IJ)*SUM(FTWTB(I,IJ,:))/TOTAL_WEIGHT)
NWPDOS(I,IJ)=NWPDOS(I,IJ) +  WEIGHT(IJ)*DOSTBS(I,IJ)/TOTAL_WEIGHT  ! SUM(FTWTB(I,IJ,:))/TOTAL_WEIGHT)
END DO
WRITE(85,8)OMEGA,(NWPDOS(I,IJ),IJ=1,NTYP),(SUM(NWPDOS(I,1:NTYP)))
END DO

END SUBROUTINE





SUBROUTINE Gauss (a,n)       ! Invert matrix by Gauss method
! 0.000-----------------------------------------------------------------
IMPLICIT NONE
INTEGER :: n
REAL(8) :: a(n,n)
! - - - Local Variables - - -
REAL(8) :: b(n,n), c, d, temp(n)
INTEGER :: i, j, k, m, imax(1), ipvt(n)
! - - - - - - - - - - - - - -
b = a
ipvt = (/ (i, i = 1, n) /)
DO k = 1,n
   imax = MAXLOC(ABS(b(k:n,k)))
   m = k-1+imax(1)
   IF (m /= k) THEN
      ipvt( (/m,k/) ) = ipvt( (/k,m/) )
      b((/m,k/),:) = b((/k,m/),:)
   END IF
   d = 1/b(k,k)
   temp = b(:,k)
   DO j = 1, n
      c = b(k,j)*d
      b(:,j) = b(:,j)-temp*c
      b(k,j) = c
   END DO
   b(:,k) = temp*(-d)
   b(k,k) = d
END DO
a(:,ipvt) = b

END SUBROUTINE Gauss
SUBROUTINE HELLO(IYRR,IMONN,IDAYY)
USE IFPORT
IMPLICIT NONE
INTEGER::IYR,IMON,IDAY
INTEGER::IYRR,IMONN,IDAYY
CALL GETDAT (iyr, imon, iday)
IYRR=IYR
IMONN=IMON
IDAYY=IDAY
END SUBROUTINE

SUBROUTINE POLY
use omp_lib
USE VARIABLES1
IMPLICIT NONE
!DOUBLE PRECISION,DIMENSION(3)::AX1,AX2
!INTEGER::CATOM,SATOM
DOUBLE PRECISION,DIMENSION(3)::DDD
DOUBLE PRECISION,DIMENSION(NNTYPE(CATOM),NCORD)::ANGLETHETA,ANGLEPHI,DDDD !!!!!!the last index 4 due to tetrahedral cordination
DOUBLE PRECISION,DIMENSION(NNTYPE(CATOM),NCORD)::REFTHETA,REFPHI !!!!!!the last index 4 due to tetrahedral cordination
DOUBLE PRECISION::RXY
INTEGER,DIMENSION(500,NCORD)::BDIST
DOUBLE PRECISION::RTOPI
INTEGER::JJJJ,JK,IR,JKK
DOUBLE PRECISION::D2,DR1,DR2
DOUBLE PRECISION::PROJ1,PROJ2,TWOPI
DOUBLE PRECISION,DIMENSION(3,3)::IAXIS
DOUBLE PRECISION::X,Y,Z,R
DOUBLE PRECISION,DIMENSION(3,3)::NEWLAT
INTEGER::MATOM,JCu,ICAP
INTEGER,DIMENSION(100)::INDEXI
INTEGER::MAXCAP,JTAG !,NCORD
DOUBLE PRECISION::AVGBOND
!DOUBLE PRECISION,DIMENSION(NSTEP,NNTYPE(CATOM))::DISTORTION
DOUBLE PRECISION,DIMENSION(NNTYPE(CATOM))::DISTORTION
REAL::RSEARCH
REAL,DIMENSION(3)::XYZ
!REAL,DIMENSION(NNTYPE(CATOM),0:180,0:360)::PROBDENSITY
REAL,DIMENSION(1,0:180,0:360)::PROBDENSITY
!REAL,DIMENSION(1,1,1)::PROBDENSITY
INTEGER::J1
OPEN(4100,FILE="ANGLETHETA.DAT")
OPEN(4101,FILE="ANGLEPHI.DAT")
OPEN(4102,FILE="BONDLENGTHS.DAT")
OPEN(4103,FILE="BONDLENGTHDISTRIBUTION.DAT")
OPEN(4105,FILE="MOVINGIONINDEX.DAT")
OPEN(4106,FILE="DISTORTION.DAT")
OPEN(5000,FILE="PROBDENSITY_THETA_PHI")
!PAUSE
PRINT*,'I M IN POLY'
PRINT*,CATOM,SATOM
PROBDENSITY=0
!AX1=(/0,0,1/)
!AX2=(/1,0,0/)
!CATOM=1
!SATOM=3
!BOND=3.0
RSEARCH=8.0  
MATOM=1

PRINT*,'MOBILE ATOM IS 1 and RSEARCH iS ', RSEARCH
MAXCAP=32

!NCORD=4

RTOPI=180/(4*ATAN(1.0))  !3.14
PI=4*ATAN(1.0)
TWOPI=8*ATAN(1.0)
    AX3(1)=AX1(2)*AX2(3)-AX1(3)*AX2(2)
    AX3(2)=AX1(3)*AX2(1)-AX1(1)*AX2(3)
    AX3(3)=AX1(1)*AX2(2)-AX1(2)*AX2(1)
IAXIS(1,:)=AX1/NORM2(AX1)
IAXIS(2,:)=AX2/NORM2(AX2)
IAXIS(3,:)=AX3/NORM2(AX3)
NEWLAT=MATMUL(IAXIS,SLAT)
DO IT=1,(IREF2-IREF1)+1,INTERVAL2
  JJJJ=0
  JTAG=0
  DO J=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
  JTAG=JTAG+1
   JJJJ=JJJJ+1
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                    IF(IT==1)THEN
                    ICAP=0
                    DO JCu=SUM(NNTYPE(1:MATOM-1))+1,SUM(NNTYPE(1:MATOM))    !MATOM MOBILE ATOM NEAR Polyhedral centre
                    DDD=POS(IT,J,:)-POS(IT,JCu,:)
                    !DDD=MATMUL(ISLATORIG,DDD)                           !!!!!!!!FRACTIONAL POSITION 
                    DDD=MATMUL(DDD,ISLATORIG)                           !!!!!!!!FRACTIONAL POSITION 
                     IF(DDD(1).LT. -0.5)DDD(1)=DDD(1)+1
                     IF(DDD(2).LT. -0.5)DDD(2)=DDD(2)+1
                     IF(DDD(3).LT. -0.5)DDD(3)=DDD(3)+1
                     IF(DDD(1).gT.  0.5)DDD(1)=DDD(1)-1
                     IF(DDD(2).gT.  0.5)DDD(2)=DDD(2)-1
                     IF(DDD(3).gT.  0.5)DDD(3)=DDD(3)-1
                    !DDD=MATMUL(SLATORIG,DDD)                           !!!!!!!!FRACTIONAL POSITION 
                    DDD=MATMUL(DDD,SLATORIG)                           !!!!!!!!FRACTIONAL POSITION 
                    IF(NORM2(DDD).LT.RSEARCH)THEN
                    ICAP=ICAP+1
                    INDEXI(ICAP)=JCu
!                    PRINT*,JCu,ICAP
                    END IF
                    END DO
                    !PAUSE
                    WRITE(2105,2105)INDEXI(1:MAXCAP)
                    2105 FORMAT(100I10)
                   END IF
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
   !SEARCH SURROUNDING ATOM FOR TETRAHEDRAL OR POLYHEDRAL 
   JK=0
    DO K=SUM(NNTYPE(1:SATOM-1))+1,SUM(NNTYPE(1:SATOM))   !,NNTYPE(CATOM)
    !PRINT*,J,K
    DDD=(POS(IT,J,:)-POS(IT,K,:))
    !DDD=MATMUL(ISLATORIG,DDD)                           !!!!!!!!FRACTIONAL POSITION 
    DDD=MATMUL(DDD,ISLATORIG)                           !!!!!!!!FRACTIONAL POSITION 
    IF(DDD(1).LT. -0.5)DDD(1)=DDD(1)+1
    IF(DDD(2).LT. -0.5)DDD(2)=DDD(2)+1
    IF(DDD(3).LT. -0.5)DDD(3)=DDD(3)+1
    IF(DDD(1).gT.  0.5)DDD(1)=DDD(1)-1
    IF(DDD(2).gT.  0.5)DDD(2)=DDD(2)-1
    IF(DDD(3).gT.  0.5)DDD(3)=DDD(3)-1
    DDD=MATMUL(IAXIS,DDD)
!    X=DDD(1)*NORM2(NEWLAT(1,:))
!    Y=DDD(2)*NORM2(NEWLAT(2,:))
!    Z=DDD(3)*NORM2(NEWLAT(3,:))
!    D2=SQRT(X*X + Y*Y + Z*Z)

    !XYZ=MATMUL(NEWLAT,DDD)
    XYZ=MATMUL(DDD,NEWLAT)
    X=XYZ(1)
    Y=XYZ(2)
    Z=XYZ(3)
    D2=NORM2(XYZ)



     IF(D2.GT.0.AND.D2.LE.BOND)THEN
      JK=JK+1
      IF(JK.GT.NCORD)EXIT
      DDDD(JTAG,JK)=D2  !NORM2(DDD)
      RXY=SQRT(Y*Y + Z*Z)

      
      ANGLETHETA(JJJJ,JK)=ACOS(X/D2)
      IF(RXY==0)THEN
      ANGLEPHI(JJJJ,JK)=0
      ELSE
      ANGLEPHI(JJJJ,JK)=ACOS(Y/rxy)
      IF(Z.LT.0)ANGLEPHI(JJJJ,JK)=ANGLEPHI(JJJJ,JK)+ TWOPI/2.0
      END IF
      !IF(J==SUM(NNTYPE(1:CATOM-1))+1)PRINT*,IT,J,K
      !IF(J==SUM(NNTYPE(1:CATOM-1))+1)PRINT*,D2,RXY
      !IF(J==SUM(NNTYPE(1:CATOM-1))+1)PRINT*,MATMUL(ISLAT,XYZ)
      !IF(J==SUM(NNTYPE(1:CATOM-1))+1)PRINT*,ANGLETHETA(JJJJ,JK) 
      !IF(J==SUM(NNTYPE(1:CATOM-1))+1)PAUSE!XYZ


    IF(IT.GT.1)THEN
	IF(ANGLETHETA(JJJJ,JK)-REFTHETA(JJJJ,JK) .GT.PI/3) ANGLETHETA(JJJJ,JK)=ANGLETHETA(JJJJ,JK)-PI
        IF(ANGLETHETA(JJJJ,JK)-REFTHETA(JJJJ,JK) .LT.-PI/3) ANGLETHETA(JJJJ,JK)=ANGLETHETA(JJJJ,JK)+PI
        IF(ANGLEPHI(JJJJ,JK)-REFPHI(JJJJ,JK) .GT.0.8*PI) ANGLEPHI(JJJJ,JK)=ANGLEPHI(JJJJ,JK)-2*PI
        IF(ANGLEPHI(JJJJ,JK)-REFPHI(JJJJ,JK) .LT.-0.8*PI) ANGLEPHI(JJJJ,JK)=ANGLEPHI(JJJJ,JK)+2*PI 
    END IF	
  REFTHETA(JJJJ,JK)=ANGLETHETA(JJJJ,JK)
  REFPHI(JJJJ,JK)=ANGLEPHI(JJJJ,JK)
          


 !IF(Z.LT.0)ANGLEPHI(JJJJ,JK)=ANGLEPHI(JJJJ,JK)+ TWOPI/2.0
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!	PROBABILITY DENSITY FUNCTION!!!!!!!!!!!!!!!!


	IF(ANGLETHETA(JJJJ,JK).GT.0.AND.ANGLEPHI(JJJJ,JK).GT.0)THEN
        !PROBDENSITY(JTAG,INT(ANGLETHETA(JJJJ,JK)*RTOPI),INT(ANGLEPHI(JJJJ,JK)*RTOPI))=PROBDENSITY(JTAG,INT(ANGLETHETA(JJJJ,JK)*RTOPI),INT(ANGLEPHI(JJJJ,JK)*RTOPI)) +1 
        PROBDENSITY(1,INT(ANGLETHETA(JJJJ,JK)*RTOPI),INT(ANGLEPHI(JJJJ,JK)*RTOPI))=PROBDENSITY(1,INT(ANGLETHETA(JJJJ,JK)*RTOPI),INT(ANGLEPHI(JJJJ,JK)*RTOPI)) +1 
	END IF
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
     END IF  !PRINT*,DDDD,J
    END DO                !SURROUNDING SERACH ENDS
!    PRINT*,JK

    AVGBOND=SUM(DDDD(JJJJ,:))/NCORD !JK   
    !DISTORTION(IT,JTAG)=SQRT(DOT_PRODUCT(DDDD(JTAG,:),DDDD(JTAG,:)) -NCORD*AVGBOND*AVGBOND)
    !DISTORTION(IT,JTAG)=DISTORTION(IT,JTAG)/(NCORD*AVGBOND*AVGBOND)
    DISTORTION(JTAG)=SQRT(DOT_PRODUCT(DDDD(JTAG,:),DDDD(JTAG,:)) -NCORD*AVGBOND*AVGBOND)
    DISTORTION(JTAG)=DISTORTION(JTAG)/(NCORD*AVGBOND*AVGBOND)



!BOND DISTRIBUTION   
   DO IR=1,500
   DR1=DR0+(IR-1)*RSTEP
   DR2=DR0+IR*RSTEP
    DO JKK=1,NCORD  !JK
    IF(DDDD(JJJJ,JKK).GT.DR1 .AND. DDDD(JJJJ,JKK).LE.DR2)BDIST(IR,JKK)=BDIST(IR,JKK)+1
    END DO
   END DO  !!END BOND DISTRI


!  PRINT*,JTAG,JJJJ
 END DO !CENTRE ATOM ENDS HERE
  WRITE(4106,2103)DELT*REAL(IT),DISTORTION(:)                                  
  WRITE(4100,2100)DELT*REAL(IT),(ANGLETHETA(JJJJ,1:NCORD)*RTOPI,JJJJ=1,NNTYPE(CATOM))
  2100 FORMAT(F10.4,1000F7.1)
  WRITE(4101,2100)DELT*REAL(IT),(ANGLEPHI(JJJJ,1:NCORD)*RTOPI,JJJJ=1,NNTYPE(CATOM))
  WRITE(4102,2102)DELT*REAL(IT),(DDDD(JJJJ,1:NCORD),JJJJ=1,NNTYPE(CATOM))
  !PRINT*,ANGLEPHI(1,1),REFPHI(1,1)
END DO     !!!!!!!!!!!!!!!!TIME ENDS HERE




   DO IR=1,500
   DR1=DR0+(IR-1)*RSTEP
   !DR2=DR0+IR*RSTEP
   WRITE(4103,2101)DR1,BDIST(IR,1:NCORD)
   END DO


2101 FORMAT(F9.4,10I12)
2102 FORMAT(F9.4,1000F10.3)
2103 FORMAT(F9.4,1000F10.4)

!DO J1=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))
!   PRINT*,J1
DO I=1,180
DO J=1,360
!WRITE(5000,2104) REAL(I),REAL(J), (  (PROBDENSITY(J1,I,J)/SUM(PROBDENSITY(J1,:,:))), J1=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM)))
WRITE(5000,2104) REAL(I),REAL(J), (  (PROBDENSITY(1,I,J)/SUM(PROBDENSITY(1,:,:))), J1=1,1)
!WRITE(3000+J1,2104) REAL(I),REAL(J),((PROBDENSITY(J1,I,J)/SUM(PROBDENSITY(J1,:,:))),J1=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM)))
2104 FORMAT(1003E16.5) 
END DO
END DO
!END DO





END SUBROUTINE


SUBROUTINE OLDPOLY
use omp_lib
USE VARIABLES1
IMPLICIT NONE
!DOUBLE PRECISION,DIMENSION(3)::AX1,AX2
!INTEGER::CATOM,SATOM
DOUBLE PRECISION,DIMENSION(3)::DDD
DOUBLE PRECISION,DIMENSION(NNTYPE(CATOM),8)::ANGLETHETA,ANGLEPHI,DDDD !!!!!!the last index 4 due to tetrahedral cordination
DOUBLE PRECISION::RXY
INTEGER,DIMENSION(1000,8)::BDIST
DOUBLE PRECISION::RTOPI
INTEGER::JJJJ,JK,IR,JKK
DOUBLE PRECISION::D2,DR1,DR2
DOUBLE PRECISION::PROJ1,PROJ2,TWOPI
DOUBLE PRECISION,DIMENSION(3,3)::IAXIS
DOUBLE PRECISION::X,Y,Z,R
DOUBLE PRECISION,DIMENSION(3,3)::NEWLAT
INTEGER::MATOM,JCu,ICAP
INTEGER,DIMENSION(20)::INDEXI
INTEGER::MAXCAP,JTAG
DOUBLE PRECISION::AVGBOND
DOUBLE PRECISION,DIMENSION(NSTEP,NNTYPE(CATOM))::DISTORTION
OPEN(2100,FILE="ANGLETHETA.DAT")
OPEN(2101,FILE="ANGLEPHI.DAT")
OPEN(2102,FILE="BONDLENGTHS.DAT")
OPEN(2103,FILE="BONDLENGTHDISTRIBUTION.DAT")
OPEN(2105,FILE="MOVINGIONINDEX.DAT")
OPEN(2106,FILE="DISTORTION.DAT")
PRINT*,CATOM,SATOM
!AX1=(/0,0,1/)
!AX2=(/1,0,0/)
!CATOM=1
!SATOM=3
!BOND=3.0
MATOM=2
MAXCAP=10
RTOPI=180/(4*ATAN(1.0))  !3.14
TWOPI=8*ATAN(1.0)
    AX3(1)=AX1(2)*AX2(3)-AX1(3)*AX2(2)
    AX3(2)=AX1(3)*AX2(1)-AX1(1)*AX2(3)
    AX3(3)=AX1(1)*AX2(2)-AX1(2)*AX2(1)
IAXIS(1,:)=AX1/NORM2(AX1)
IAXIS(2,:)=AX2/NORM2(AX2)
IAXIS(3,:)=AX3/NORM2(AX3)
NEWLAT=MATMUL(IAXIS,SLAT)

DO IT=1,(IREF2-IREF1)+1
  JJJJ=0
  JTAG=0
  DO J=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
  JTAG=JTAG+1
   JJJJ=JJJJ+1
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                    IF(IT==1)THEN
                    ICAP=0
                    DO JCu=SUM(NNTYPE(1:MATOM-1))+1,SUM(NNTYPE(1:MATOM))    !MATOM MOBILE ATOM NEAR Polyhedral centre
                    DDD=POS(IT,J,:)-POS(IT,JCu,:)
                    !DDD=MATMUL(ISLATORIG,DDD)                           !!!!!!!!FRACTIONAL POSITION 
                    DDD=MATMUL(DDD,ISLATORIG)                           !!!!!!!!FRACTIONAL POSITION 
                     IF(DDD(1).LT. -0.5)DDD(1)=DDD(1)+1
                     IF(DDD(2).LT. -0.5)DDD(2)=DDD(2)+1
                     IF(DDD(3).LT. -0.5)DDD(3)=DDD(3)+1
                     IF(DDD(1).gT.  0.5)DDD(1)=DDD(1)-1
                     IF(DDD(2).gT.  0.5)DDD(2)=DDD(2)-1
                     IF(DDD(3).gT.  0.5)DDD(3)=DDD(3)-1
                    !DDD=MATMUL(SLATORIG,DDD)                           !!!!!!!!FRACTIONAL POSITION 
                    DDD=MATMUL(DDD,SLATORIG)                           !!!!!!!!FRACTIONAL POSITION 
                    IF(NORM2(DDD).LT.4.2)THEN
                    ICAP=ICAP+1
                    INDEXI(ICAP)=JCu
!                    PRINT*,JCu,ICAP
                    END IF
                    END DO
                    !PAUSE
                    WRITE(2105,2105)INDEXI(1:MAXCAP)
                    2105 FORMAT(100I10)
                   END IF
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


   !SEARCH SURROUNDING ATOM FOR TETRAHEDRAL OR POLYHEDRAL 
   JK=0
    DO K=SUM(NNTYPE(1:SATOM-1))+1,SUM(NNTYPE(1:SATOM))   !,NNTYPE(CATOM)
    !PRINT*,J,K
    DDD=(POS(IT,J,:)-POS(IT,K,:))
    !DDD=MATMUL(ISLATORIG,DDD)                           !!!!!!!!FRACTIONAL POSITION 
    DDD=MATMUL(DDD,ISLATORIG)                           !!!!!!!!FRACTIONAL POSITION 
    IF(DDD(1).LT. -0.5)DDD(1)=DDD(1)+1
    IF(DDD(2).LT. -0.5)DDD(2)=DDD(2)+1
    IF(DDD(3).LT. -0.5)DDD(3)=DDD(3)+1
    IF(DDD(1).gT.  0.5)DDD(1)=DDD(1)-1
    IF(DDD(2).gT.  0.5)DDD(2)=DDD(2)-1
    IF(DDD(3).gT.  0.5)DDD(3)=DDD(3)-1
    DDD=MATMUL(IAXIS,DDD)
    X=DDD(1)*NORM2(NEWLAT(1,:))
    Y=DDD(2)*NORM2(NEWLAT(2,:))
    Z=DDD(3)*NORM2(NEWLAT(3,:))
    D2=SQRT(X*X + Y*Y + Z*Z)
     IF(D2.LE.BOND)THEN
     JK=JK+1
     DDDD(JTAG,JK)=D2  !NORM2(DDD)
     RXY=SQRT(Y*Y + Z*Z)
     ANGLETHETA(JJJJ,JK)=ACOS(X/D2)
     IF(RXY==0)THEN
     ANGLEPHI(JJJJ,JK)=0
     ELSE
     ANGLEPHI(JJJJ,JK)=ACOS(Y/rxy)
     END IF
     IF(Z.LT.0)ANGLEPHI(JJJJ,JK)=ANGLEPHI(JJJJ,JK)+ TWOPI/2.0
     END IF  !PRINT*,DDDD,J
    END DO                !SURROUNDING SERACH ENDS
!    PRINT*,JK
    AVGBOND=SUM(DDDD(JJJJ,:))/JK   
    DISTORTION(IT,JTAG)=SQRT(DOT_PRODUCT(DDDD(JTAG,:),DDDD(JTAG,:)) -JK*AVGBOND*AVGBOND)
    DISTORTION(IT,JTAG)=DISTORTION(IT,JTAG)/(JK*AVGBOND*AVGBOND)

!BOND DISTRIBUTION   
   DO IR=1,1000
   DR1=DR0+(IR-1)*RSTEP
   DR2=DR0+IR*RSTEP
    DO JKK=1,JK
    IF(DDDD(JJJJ,JKK).GT.DR1 .AND. DDDD(JJJJ,JKK).LE.DR2)BDIST(IR,JKK)=BDIST(IR,JKK)+1
    END DO
   END DO  !!END BOND DISTRI

  PRINT*,JTAG,JJJJ
 END DO !CENTRE ATOM ENDS HERE


  WRITE(2106,2103)DELT*REAL(IT),DISTORTION(IT,:)                                  
  WRITE(2100,2100)DELT*REAL(IT),(ANGLETHETA(JJJJ,1:JK)*RTOPI,JJJJ=1,NNTYPE(CATOM))
  2100 FORMAT(F10.4,1000F7.1)
  WRITE(2101,2100)DELT*REAL(IT),(ANGLEPHI(JJJJ,1:JK)*RTOPI,JJJJ=1,NNTYPE(CATOM))
  WRITE(2102,2102)DELT*REAL(IT),(DDDD(JJJJ,1:JK),JJJJ=1,NNTYPE(CATOM))



END DO



   DO IR=1,1000
   DR1=DR0+(IR-1)*RSTEP
   !DR2=DR0+IR*RSTEP
   WRITE(2103,2101)DR1,BDIST(IR,1:JK)
   END DO
2101 FORMAT(F7.4,10I8)
2102 FORMAT(F7.4,1000F10.3)
2103 FORMAT(F7.4,1000F10.4)
END SUBROUTINE



SUBROUTINE BROAD_NEW(FWHM00,FWHM11,AAA,BBB)
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION::FWHM00,FWHM11
DOUBLE PRECISION::R1,R2,R3,XX
DOUBLE PRECISION::ESTEP,ESTART
INTEGER::IGAIN,IRESOLUTION,ISIG
DOUBLE PRECISION::DELX,BROAD,SUMM

DOUBLE PRECISION::SIG,ANORMFACTOR,S1,S2,NDOS1
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::AAA,BBB
ALLOCATE(AAA(NDOS),BBB(NDOS))
PRINT*, 'I M IN BROAD_NEW'

IF(FWHM00.NE.0.0.OR.FWHM11.NE.0.0)THEN
ESTART=0
!@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@APPLY BROADENNING IN NEUTRON WEIGTED DOS@@@@@@@@@@@@@@@@@@@@@@@@@@@@

!CALL BROAD(TOTAL_NEUTRON_DOS,BROAD_DOS,FWHM,NSTEP)
ESTEP=0.0
!IGAIN=0
!IRESOLUTION=1
!PRINT*,AAA
NDOS1=NDOS
IF (ISQW==1)NDOS1=NSTEP
         DO I=1,NDOS1

ESTEP=(((2*I-1))*0.5*DELE+ESTART)/(DELE)
IF(ESTEP.LT.0)ESTEP=ABS(ESTEP)
!                 FWHM=SQRT(((FWHM00**2)+IGAIN*((FWHM11*ESTEP*DELE)/100.0)**2))
                 FWHM=SQRT(((FWHM00**2)+((FWHM11*ESTEP*DELE)/100.0)**2))

!!!!!!!!!!!!!!!!!!!!!!ARCS RESOLUTION!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!                 IF(IRESOLUTION==1.AND.IGAIN==0)THEN
!                 XX=DELE*I
!                 IF(XX.LE.R1)            FWHM=(3.0405e-7*XX*XX*XX*XX -7.184e-6*XX*XX*XX + 4.245E-4*XX*XX -0.04225*XX + 1.2218)   !20 meV
!                 IF(XX.LE.R2 .AND.XX.GT.R1)FWHM=(3.066e-8*XX*XX*XX*XX -2.081e-6*XX*XX*XX + 1.603E-4*XX*XX -0.03664*XX + 2.563) !60meV   
!                 IF(XX.GT.R2)            FWHM=(2.646e-9*XX*XX*XX*XX +2.957E-7*XX*XX*XX + 5.499E-5*XX*XX -0.04094*XX + 3.88809)    !100meV
!                 END IF
!                 PRINT*,FWHM
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!PRINT*,FWHM

                 SIG=FWHM/(2*1.1774)
                 ISIG=2*SIG+1
!                  PRINT*,ISIG
                 IF(FWHM.NE.0.0)S2= 0.5/SIG**2
                 BBB(I)=AAA(I) !!!!!!!!!!!!!!!!!!!!!!!!!HALT
                 IF(FWHM==0.0)GO TO 12
                 BBB(I)=0.0
                 SUMM=0
                 DO  J=-ISIG,ISIG
                 K=I+J
                 IF(K.LE.0)K=1
                 !IF(K.GT.NDOS)K=NDOS
                 S1=-S2*J**2
                 S1=DEXP(S1)
                 BBB(I)=BBB(I)+AAA(K)*S1
                 SUMM=SUMM+S1
                 END DO
12              CONTINUE
                 BBB(I)=BBB(I)/SUMM
         END DO
                                      ANORMFACTOR=SUM(BBB(:)*DELE)
                                       BBB=BBB/ANORMFACTOR
!                                  DO I=1,NSTEP
!                                       ESTEP=(((2*I-1))*0.5*DELE+ESTART)/(DELE)                               
!                                       BBB(I)=BBB(I)/ANORMFACTOR
!                                       WRITE(9,8)ESTEP*DELE,BBB(I)
!                                  END DO
ANORMFACTOR=SUM(BBB(:)*dele)
PRINT*, 'BROAD_NORM',ANORMFACTOR
!PAUSE
END IF
IF(FWHM00.EQ.0.0.AND.FWHM11.EQ.0.0)BBB=AAA
8 FORMAT(F10.4,4X,F15.8)
DEALLOCATE(AAA,BBB)
END SUBROUTINE


SUBROUTINE DUMMYVONHOVE_SELF
use omp_lib
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(NSTEP,40)::GRRT
DOUBLE PRECISION::RCUT,R1,R2,DR
INTEGER::IREF
GRRT=0

IREF=2

DO IT=1,NSTEP
DO I=SUM(NNTYPE(1:IREF-1))+1,SUM(NNTYPE(1:IREF)) 
DR=NORM2(POS(IT,I,:)-POS(1,I,:))

DO K=1,40
R1=RCUT+(K-1)*0.1 
R2=RCUT+K*DELR
IF(DR.GE.R1.AND.DR.LT.R2)GRRT(IT,K)=GRRT(IT,K)+1
WRITE(109,109)(R1+R2)*0.5,GRRT(IT,K),IT*DELT
END DO

109 FORMAT(F10.5,I5,F10.5)
END DO
END DO



END SUBROUTINE


SUBROUTINE CVOLUME(I1,I2,I3,I4,volumec)
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,I2,I3,I4
DOUBLE PRECISION,DIMENSION(3)::AD,BD,CD,BDCROSSCD
DOUBLE PRECISION::AREAc,ttheta,volumec
INTEGER::TI,TJ,TK
!AD=MATMUL(ISLATORIG, POS(IT,I1,:)-POS(IT,I4,:))
!BD=MATMUL(ISLATORIG, POS(IT,I2,:)-POS(IT,I4,:))
!CD=MATMUL(ISLATORIG, POS(IT,I3,:)-POS(IT,I4,:))
AD=MATMUL( POS(IT,I1,:)-POS(IT,I4,:),ISLATORIG)
BD=MATMUL( POS(IT,I2,:)-POS(IT,I4,:),ISLATORIG)
CD=MATMUL( POS(IT,I3,:)-POS(IT,I4,:),ISLATORIG)
IF(AD(1).GT.0.5)AD(1)=AD(1)-1
IF(AD(2).GT.0.5)AD(2)=AD(2)-1
IF(AD(3).GT.0.5)AD(3)=AD(3)-1
IF(AD(1).LT.-0.5)AD(1)=AD(1)+1
IF(AD(2).LT.-0.5)AD(2)=AD(2)+1
IF(AD(3).LT.-0.5)AD(3)=AD(3)+1
IF(BD(1).GT.0.5)BD(1)=BD(1)-1
IF(BD(2).GT.0.5)BD(2)=BD(2)-1
IF(BD(3).GT.0.5)BD(3)=BD(3)-1
IF(BD(1).LT.-0.5)BD(1)=BD(1)+1
IF(BD(2).LT.-0.5)BD(2)=BD(2)+1
IF(BD(3).LT.-0.5)BD(3)=BD(3)+1
IF(CD(1).GT.0.5)CD(1)=CD(1)-1
IF(CD(2).GT.0.5)CD(2)=CD(2)-1
IF(CD(3).GT.0.5)CD(3)=CD(3)-1
IF(CD(1).LT.-0.5)CD(1)=CD(1)+1
IF(CD(2).LT.-0.5)CD(2)=CD(2)+1
IF(CD(3).LT.-0.5)CD(3)=CD(3)+1
!PRINT*,NORM2(AD)
!PRINT*,NORM2(BD)
!PRINT*,NORM2(CD)
!PAUSE

!AD=MATMUL(SLATORIG,AD)
!BD=MATMUL(SLATORIG,BD)
!CD=MATMUL(SLATORIG,CD)
AD=MATMUL(AD,SLATORIG)
BD=MATMUL(BD,SLATORIG)
CD=MATMUL(CD,SLATORIG)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!
DO TI=1,3
TJ=TI+1
TK=TI+2
IF(TJ.GT.3)TJ=TJ-3
IF(TK.GT.3)TK=TK-3
BDCROSSCD(TI)=BD(TJ)*CD(TK)-BD(TK)*CD(TJ)
END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!
volumec=ABS(DOT_PRODUCT(AD,BDCROSSCD))/6 !norm2(AB)*norm2(AC)*sin(ttheta)
end subroutine
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
SUBROUTINE CVOLUME2022(IT2,I1,I2,I3,I4,volumec)
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,I2,I3,I4,IT2
DOUBLE PRECISION,DIMENSION(3)::AD,BD,CD,BDCROSSCD
DOUBLE PRECISION::AREAc,ttheta,volumec
INTEGER::TI,TJ,TK
AD=MATMUL( POS(IT2,I1,:)-POS(IT2,I4,:),ISLATORIG)
BD=MATMUL( POS(IT2,I2,:)-POS(IT2,I4,:),ISLATORIG)
CD=MATMUL( POS(IT2,I3,:)-POS(IT2,I4,:),ISLATORIG)

!PRINT*, POS(IT2,I1,:)
!PRINT*, POS(IT2,I4,:)



!IF(AD(1).GT.0.5)AD(1)=AD(1)-1
!IF(AD(2).GT.0.5)AD(2)=AD(2)-1
!IF(AD(3).GT.0.5)AD(3)=AD(3)-1
!IF(AD(1).LT.-0.5)AD(1)=AD(1)+1
!IF(AD(2).LT.-0.5)AD(2)=AD(2)+1
!IF(AD(3).LT.-0.5)AD(3)=AD(3)+1
!IF(BD(1).GT.0.5)BD(1)=BD(1)-1
!IF(BD(2).GT.0.5)BD(2)=BD(2)-1
!IF(BD(3).GT.0.5)BD(3)=BD(3)-1
!IF(BD(1).LT.-0.5)BD(1)=BD(1)+1
!IF(BD(2).LT.-0.5)BD(2)=BD(2)+1
!IF(BD(3).LT.-0.5)BD(3)=BD(3)+1
!IF(CD(1).GT.0.5)CD(1)=CD(1)-1
!IF(CD(2).GT.0.5)CD(2)=CD(2)-1
!IF(CD(3).GT.0.5)CD(3)=CD(3)-1
!IF(CD(1).LT.-0.5)CD(1)=CD(1)+1
!IF(CD(2).LT.-0.5)CD(2)=CD(2)+1
!IF(CD(3).LT.-0.5)CD(3)=CD(3)+1
where(AD.GE.0.5)AD=AD-1
where(BD.GE.0.5)BD=BD-1
where(CD.GE.0.5)CD=CD-1
where(AD.LE.-0.5)AD=AD+1
where(BD.LE.-0.5)BD=BD+1
where(CD.LE.-0.5)CD=CD+1
!PRINT*,AD !,BD,CD
AD=MATMUL(AD,SLATORIG)
BD=MATMUL(BD,SLATORIG)
CD=MATMUL(CD,SLATORIG)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!PRINT*,ISLATORIG(1,:)
!PRINT*,ISLATORIG(2,:)
!PRINT*,ISLATORIG(3,:)
!PRINT*,SLATORIG(1,:)
!PRINT*,SLATORIG(2,:)
!PRINT*,SLATORIG(3,:)

!PRINT*,NORM2(AD)
!PRINT*,NORM2(BD)
!PRINT*,NORM2(CD)
!PAUSE
DO TI=1,3
TJ=TI+1
TK=TI+2
IF(TJ.GT.3)TJ=TJ-3
IF(TK.GT.3)TK=TK-3
BDCROSSCD(TI)=BD(TJ)*CD(TK)-BD(TK)*CD(TJ)
END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!
volumec=ABS(DOT_PRODUCT(AD,BDCROSSCD))/6 !norm2(AB)*norm2(AC)*sin(ttheta)
!print*,volumec
end subroutine
!


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
SUBROUTINE VONHOVE_SELF(IREF)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,IBAC,IFOR,II1
INTEGER::M
INTEGER::NSTEPORIG2
DOUBLE PRECISION::POSINT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::GRRT
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DGRRT
DOUBLE PRECISION::RCUT,R1,R2 !,DR
INTEGER::IREF  !,NRPOINTS
DOUBLE PRECISION::DRR
DOUBLE PRECISION::DR1
INTEGER::NBIN !,NSTEPIV,NSTEPINT
!INTEGER,ALLOCATABLE,DIMENSION(:)::NNBIN
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DR
INTEGER,ALLOCATABLE,DIMENSION(:,:)::NNBIN
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DR
INTEGER::OFFSET
CHARACTER*14::AAAA
CHARACTER*16::AAAA2
!DOUBLE PRECISION::R0M
!$ call omp_set_num_threads(num_threads)
WRITE(AAAA,'("VANHOVE_SELF",I2.2)')IREF
OPEN(109,FILE=AAAA)
WRITE(AAAA2,'("VANHOVE_R2SELF",I2.2)')IREF
OPEN(110,FILE=AAAA)


!$ call omp_set_num_threads(num_threads)
!OPEN(109,FILE='VONHOVE_SELF')
GRRT=0
RCUT=0
DRR=0.005
PRINT*,'GIVE THE No. of ORIGIN FOR VON HOVE',NSTEPIV
PRINT*,'GIVE THE No. of TIME STEP INTREVALS OVER WHICH THE VON HOVE WILL BE PRINTED INTERVALS',NSTEPINT

ALLOCATE(GRRT(0:100,0:NRPOINTS))
!ALLOCATE(DR(NSTEP))
!ALLOCATE(NNBIN(NSTEP))
!ALLOCATE(DGRRT(NNTYPE(IREF),0:NRPOINTS))
ALLOCATE(DR(0:100,NSTEPIV))
ALLOCATE(NNBIN(0:100,NSTEPIV))

OFFSET=SUM(NNTYPE(1:IREF-1))
NSTEPORIG2=IREF2-IREF1+1
PRINT*,NSTEPORIG2
PRINT*, 'THE SELF VON HOVE CALCULATION WILL BE PERFORMED  AVERAGED FOR',NSTEPIV,'LENGHT'
GRRT=0
!DO IIII=SUM(NNTYPE(1:IREF-1))+1,SUM(NNTYPE(1:IREF))
!$omp parallel do
DO DT=1,NSTEP,NSTEPINT
NSTEP1=NSTEPIV
NSTEP2=NSTEPIV+DT
IK=DT/NSTEPINT
IF(IK.LE.100)THEN
IF(NSTEP2.LT.NSTEPORIG)THEN
!DGRRT=0
DO IIII=SUM(NNTYPE(1:IREF-1))+1,SUM(NNTYPE(1:IREF))
DR(IK,1:NSTEPIV)=NORM2(POS(1:NSTEP1,IIII,:)-POS(DT:NSTEP2,IIII,:),DIM=2)
NNBIN(IK,:)=INT(DR(IK,:)/DRR)
  !WHERE(NNBIN(IIII,:).LT.NRPOINTS)GRRT(DT,NNBIN(IIII,1:NSTEPIV))=GRRT(DT,NNBIN(IIII,1:NSTEPIV))+1
  !WHERE(NNBIN(IK,:).LT.NRPOINTS)GRRT(DT,NNBIN(IK,1:NSTEPIV))=GRRT(DT,NNBIN(IK,1:NSTEPIV))+1
  WHERE(NNBIN(IK,:).LT.NRPOINTS)GRRT(IK,NNBIN(IK,1:NSTEPIV))=GRRT(IK,NNBIN(IK,1:NSTEPIV))+1
END DO
END IF
END IF
END DO
!$omp end parallel do

!PAUSE
IK=NSTEP/NSTEPINT
IF(IK.GE.100)IK=100
GRRT=GRRT/(NSTEPIV*NNTYPE(IREF))
DO K=0,NRPOINTS
R1=(K)*DRR 
R2=RCUT+(K+1)*DRR 
WRITE(109,109)R1,GRRT(0:IK,K)
!WRITE(109,109)R1,GRRT(1:NSTEP:NSTEPINT,K)
109 FORMAT(F10.5,10000(E12.5,1x))
END DO
DEALLOCATE(GRRT,DR,NNBIN)
END SUBROUTINE
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!




!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
SUBROUTINE VONHOVE_PAIR(IREF)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,IBAC,IFOR,II1
INTEGER::M
INTEGER::NSTEPORIG2
DOUBLE PRECISION::POSINT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::GRRT
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DGRRT
DOUBLE PRECISION::RCUT,R1,R2 !,DR
INTEGER::IREF !,NRPOINTS
DOUBLE PRECISION::DRR
DOUBLE PRECISION::DR1
INTEGER::NBIN  !,NSTEPIV,NSTEPINT
!INTEGER,ALLOCATABLE,DIMENSION(:)::NNBIN
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DR
INTEGER,ALLOCATABLE,DIMENSION(:,:)::NNBIN
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DR
INTEGER::OFFSET
INTEGER::IIII2
!$ call omp_set_num_threads(num_threads)
OPEN(109,FILE='VONHOVE_PAIR')
GRRT=0
RCUT=0
DRR=0.01
!NRPOINTS=500
PRINT*,'GIVE THE No. of ORIGIN FOR VON HOVE',NSTEPIV
PRINT*,'GIVE THE No. of TIME STEP INTREVALS OVER WHICH THE VON HOVE WILL BE PRINTED INTERVALS',NSTEPINT
!PRINT*,'GIVE THE No. of ORIGIN FOR VON HOVE'
!READ*,NSTEPIV
!PRINT*,'GIVE THE No. of TIME STEP INTREVALS OVER WHICH THE VON HOVE WILL BE PRINTED INTERVALS'
!READ*,NSTEPINT

ALLOCATE(GRRT(0:100,0:NRPOINTS))
!ALLOCATE(DR(NSTEP))
!ALLOCATE(NNBIN(NSTEP))
!ALLOCATE(DGRRT(NNTYPE(IREF),0:NRPOINTS))
ALLOCATE(DR(0:100,NSTEPIV))
ALLOCATE(NNBIN(0:100,NSTEPIV))

OFFSET=SUM(NNTYPE(1:IREF-1))
NSTEPORIG2=IREF2-IREF1+1
PRINT*,NSTEPORIG2
PRINT*, 'THE DISTINCT VON HOVE CALCULATION WILL BE PERFORMED  AVERAGED FOR',NSTEPIV,'LENGHT'
GRRT=0
!DO IIII=SUM(NNTYPE(1:IREF-1))+1,SUM(NNTYPE(1:IREF))
!$omp parallel do
DO DT=1,NSTEP,NSTEPINT
NSTEP1=NSTEPIV
NSTEP2=NSTEPIV+DT
IK=DT/NSTEPINT
IF(NSTEP2.LT.NSTEPORIG)THEN
!IF(NSTEP2.LT.NSTEPORIG.AND.IIII2.NE.IIII)THEN
!DGRRT=0
DO IIII2=SUM(NNTYPE(1:IREF-1))+1,SUM(NNTYPE(1:IREF))
DO IIII=SUM(NNTYPE(1:IREF-1))+1,SUM(NNTYPE(1:IREF))
 IF(IIII2.NE.IIII)THEN
 DR(IK,1:NSTEPIV)=NORM2(POS(1:NSTEP1,IIII2,:)-POS(DT:NSTEP2,IIII,:),DIM=2)
 NNBIN(IK,:)=INT(DR(IK,:)/DRR)
  !WHERE(NNBIN(IIII,:).LT.NRPOINTS)GRRT(DT,NNBIN(IIII,1:NSTEPIV))=GRRT(DT,NNBIN(IIII,1:NSTEPIV))+1
  !WHERE(NNBIN(IK,:).LT.NRPOINTS)GRRT(DT,NNBIN(IK,1:NSTEPIV))=GRRT(DT,NNBIN(IK,1:NSTEPIV))+1
  WHERE(NNBIN(IK,:).LT.NRPOINTS)GRRT(IK,NNBIN(IK,1:NSTEPIV))=GRRT(IK,NNBIN(IK,1:NSTEPIV))+1
 END IF
END DO
END DO
END IF
END DO
!$omp end parallel do
!PAUSE
IK=NSTEP/NSTEPINT
DO K=0,NRPOINTS
R1=(K)*DRR 
R2=RCUT+(K+1)*DRR 
WRITE(109,109)R1,GRRT(0:IK,K)
!WRITE(109,109)R1,GRRT(1:NSTEP:NSTEPINT,K)
109 FORMAT(F10.5,10000(E12.5,1x))
END DO
DEALLOCATE(GRRT,DR,NNBIN)
END SUBROUTINE
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
SUBROUTINE VONHOVE_PAIR_ADV(IIREF1,IIREF2)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,IBAC,IFOR,II1,IIREF1,IIREF2
INTEGER::M
INTEGER::NSTEPORIG2
DOUBLE PRECISION::POSINT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::GRRT
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DGRRT
DOUBLE PRECISION::RCUT,R1,R2 !,DR
INTEGER::IREF !,NRPOINTS
DOUBLE PRECISION::DRR
DOUBLE PRECISION::DR1
INTEGER::NBIN  !,NSTEPIV,NSTEPINT
!INTEGER,ALLOCATABLE,DIMENSION(:)::NNBIN
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DR
INTEGER,ALLOCATABLE,DIMENSION(:,:)::NNBIN
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DR
INTEGER::OFFSET
INTEGER::IIII2
DOUBLE PRECISION::DV,AREA
CHARACTER*14::AAAA
!$ call omp_set_num_threads(num_threads)
WRITE(AAAA,'("VANHOVE_PAIR",I1.1,I1.1)')IIREF1,IIREF2
OPEN(109,FILE=AAAA)

!OPEN(109,FILE='VONHOVE_PAIR')
GRRT=0
RCUT=0
DRR=0.1
!NRPOINTS=500
PRINT*,'GIVE THE No. of ORIGIN FOR VON HOVE',NSTEPIV
PRINT*,'GIVE THE No. of TIME STEP INTREVALS OVER WHICH THE VON HOVE WILL BE PRINTED INTERVALS',NSTEPINT
!PRINT*,'GIVE THE No. of ORIGIN FOR VON HOVE'
!READ*,NSTEPIV
!PRINT*,'GIVE THE No. of TIME STEP INTREVALS OVER WHICH THE VON HOVE WILL BE PRINTED INTERVALS'
!READ*,NSTEPINT

ALLOCATE(GRRT(0:1000,0:NRPOINTS))
!ALLOCATE(DR(NSTEP))
!ALLOCATE(NNBIN(NSTEP))
!ALLOCATE(DGRRT(NNTYPE(IREF),0:NRPOINTS))
ALLOCATE(DR(0:1000,NSTEPIV))
ALLOCATE(NNBIN(0:1000,NSTEPIV))

OFFSET=SUM(NNTYPE(1:IREF-1))
NSTEPORIG2=IREF2-IREF1+1
PRINT*,NSTEPORIG2
PRINT*, 'THE DISTINCT VON HOVE CALCULATION WILL BE PERFORMED  AVERAGED FOR',NSTEPIV,'LENGHT'
GRRT=0
NNBIN=0
!DO IIII=SUM(NNTYPE(1:IREF-1))+1,SUM(NNTYPE(1:IREF))
!!$omp parallel do
DO DT=1,NSTEP,NSTEPINT
NSTEP1=NSTEPIV
NSTEP2=NSTEPIV+DT
IK=DT/NSTEPINT
IF(NSTEP2.LT.NSTEPORIG)THEN
!IF(NSTEP2.LT.NSTEPORIG.AND.IIII2.NE.IIII)THEN
!DGRRT=0
DO IIII2=SUM(NNTYPE(1:IIREF1-1))+1,SUM(NNTYPE(1:IIREF1))
DO IIII=SUM(NNTYPE(1:IIREF2-1))+1,SUM(NNTYPE(1:IIREF2))
 IF(IIII2.NE.IIII)THEN
 DR(IK,1:NSTEPIV)=NORM2(POS(1:NSTEP1,IIII2,:)-POS(DT:NSTEP2,IIII,:),DIM=2)
 NNBIN(IK,:)=INT(DR(IK,:)/DRR)
  !WHERE(NNBIN(IIII,:).LT.NRPOINTS)GRRT(DT,NNBIN(IIII,1:NSTEPIV))=GRRT(DT,NNBIN(IIII,1:NSTEPIV))+1
  !WHERE(NNBIN(IK,:).LT.NRPOINTS)GRRT(DT,NNBIN(IK,1:NSTEPIV))=GRRT(DT,NNBIN(IK,1:NSTEPIV))+1
  WHERE(NNBIN(IK,:).LT.NRPOINTS)GRRT(IK,NNBIN(IK,1:NSTEPIV))=GRRT(IK,NNBIN(IK,1:NSTEPIV))+1
 END IF
END DO
END DO
END IF
END DO
!!$omp end parallel do
!PAUSE
GRRT=GRRT/(NNTYPE(IIREF1)*NNTYPE(IIREF2)*NSTEPIV*DRR)
IK=NSTEP/NSTEPINT
DO K=0,NRPOINTS
R1=(K)*DRR 
R2=RCUT+(K+1)*DRR 
   RM=(R1+R2)*0.5
   AREA=4.0*PI*(RM**2)
   DV=AREA*DRR 
!   PRINT*,DV,RM
!        PAUSE
  
!#IF(R1.LE.0.5*NORM2(SLAT(1,:)))WRITE(109,109)R1,GRRT(0:IK,K)/DV
WRITE(109,109)R1,GRRT(0:IK,K)/DV

!WRITE(109,109)R1,GRRT(1:NSTEP:NSTEPINT,K)
109 FORMAT(F10.5,10000(E12.5,1x))
END DO
DEALLOCATE(GRRT,DR,NNBIN)
END SUBROUTINE









!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
SUBROUTINE VONHOVE_PAIROLD(IREF)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,IBAC,IFOR,II1
INTEGER::M
INTEGER::NSTEPORIG2
DOUBLE PRECISION::POSINT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::GRRT
DOUBLE PRECISION::RCUT,R1,R2 !,DR
INTEGER::IREF !,NRPOINTS
DOUBLE PRECISION::DRR
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DR
DOUBLE PRECISION::DR1
INTEGER::NBIN,iiii2
!INTEGER::NBIN,NSTEPIV,iiii2,NSTEPINT
INTEGER,ALLOCATABLE,DIMENSION(:)::NNBIN
OPEN(109,FILE='VONHOVE_PAIR')
GRRT=0
RCUT=0
DRR=0.01
NRPOINTS=500
RCUT=DRR*NRPOINTS
PRINT*,'GIVE THE No. of ORIGIN FOR VON HOVE'
READ*,NSTEPIV

ALLOCATE(GRRT(NSTEP,0:NRPOINTS))
ALLOCATE(DR(NSTEP))
ALLOCATE(NNBIN(NSTEP))
NSTEPORIG2=IREF2-IREF1+1
PRINT*,NSTEPORIG2
PRINT*, 'THE SELF VON HOVE CALCULATION WILL BE PERFORMED  AVERAGED FOR',NSTEPIV,'LENGHT'
PRINT*,'GIVE THE No. of TIME STEP INTREVALS OVER WHICH THE VON HOVE WILL BE PRINTED INTERVALS'
READ*,NSTEPINT
GRRT=0


!$omp parallel do
DO IIII2=SUM(NNTYPE(1:IREF-1))+1,SUM(NNTYPE(1:IREF))
DO IIII=SUM(NNTYPE(1:IREF-1))+1,SUM(NNTYPE(1:IREF))
 DO DT=1,NSTEP
 NSTEP1=NSTEPIV
 NSTEP2=NSTEPIV+DT
 IF(NSTEP2.LT.NSTEPORIG)THEN
 !IF(NSTEP2.LT.NSTEPORIG.AND.IIII2.NE.IIII)THEN
 DR(1:NSTEPIV)=NORM2(POS(1:NSTEP1,IIII2,:)-POS(DT:NSTEP2,IIII,:),DIM=2)
! IF(ANY(DR.GT.RCUT).EQ.FALSE)THEN
 NNBIN=INT(DR/DRR)
  WHERE(NNBIN.LT.NRPOINTS)GRRT(DT,NNBIN(1:NSTEPIV))=GRRT(DT,NNBIN(1:NSTEPIV))+1
! GRRT(DT,NNBIN(1:NSTEPIV))=GRRT(DT,NNBIN(1:NSTEPIV))+1
 END IF
 END DO
END DO
END DO
!$omp end parallel do


DO K=0,NRPOINTS
R1=(K)*DRR 
R2=RCUT+(K+1)*DRR 
WRITE(109,109)R1,GRRT(1:NSTEP:NSTEPINT,K)
109 FORMAT(F10.5,10000(E12.5,1x))
END DO
END SUBROUTINE
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!





SUBROUTINE VONHOVE_PAIR2(IREF)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(NSTEP,400)::GRRT
DOUBLE PRECISION::RCUT,R1,R2,DR
INTEGER::IREF
OPEN(109,FILE='VONHOVE_PAIR')
GRRT=0
!IREF=2
RCUT=0
!$omp parallel do
DO IT=1,NSTEP
DO K=1,100
	DO I=SUM(NNTYPE(1:IREF-1))+1,SUM(NNTYPE(1:IREF))
	DO J=SUM(NNTYPE(1:IREF-1))+1,SUM(NNTYPE(1:IREF))
	DR=NORM2(POS(IT,I,:)-POS(1,J,:))
	R1=RCUT+(K-1)*0.1
	R2=RCUT+K*0.1
	IF(DR.GE.R1.AND.DR.LT.R2)GRRT(IT,K)=GRRT(IT,K)+1
	END DO
	END DO
GRRT(IT,K)=GRRT(IT,K)/(NNTYPE(IREF)**2)  !224
!IF(MOD(IT-1,100)==0)WRITE(109,109)(R1+R2)*0.5,pi*(R1+R2)*(R1+R2)*GRRT(IT,K),IT*DELT
END DO
END DO
!$omp end parallel do
DO K=1,100
R1=RCUT+(K-1)*0.1
R2=RCUT+K*0.1
WRITE(109,109)(R1+R2)*0.5,GRRT(1:NSTEP:10,K)
!WRITE(109,109)(R1+R2)*0.5,pi*(R1+R2)*(R1+R2)*GRRT(1:NSTEP:10,K)
109 FORMAT(F10.5,10000F10.5)
END DO
END SUBROUTINE













SUBROUTINE CAREA(I1,I2,I3,areac)
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,I2,I3
DOUBLE PRECISION,DIMENSION(3)::AB,AC
DOUBLE PRECISION::AREAc,ttheta
!AB=MATMUL(ISLATORIG, POS(IT,I1,:)-POS(IT,I2,:))
!AC=MATMUL(ISLATORIG, POS(IT,I1,:)-POS(IT,I3,:))
AB=MATMUL( POS(IT,I1,:)-POS(IT,I2,:),ISLATORIG)
AC=MATMUL( POS(IT,I1,:)-POS(IT,I3,:),ISLATORIG)
IF(AB(1).GT.0.5)AB(1)=AB(1)-1
IF(AB(2).GT.0.5)AB(2)=AB(2)-1
IF(AB(3).GT.0.5)AB(3)=AB(3)-1
IF(AB(1).LT.-0.5)AB(1)=AB(1)+1
IF(AB(2).LT.-0.5)AB(2)=AB(2)+1
IF(AB(3).LT.-0.5)AB(3)=AB(3)+1
IF(AC(1).GT.0.5)AC(1)=AC(1)-1
IF(AC(2).GT.0.5)AC(2)=AC(2)-1
IF(AC(3).GT.0.5)AC(3)=AC(3)-1
IF(AC(1).LT.-0.5)AC(1)=AC(1)+1
IF(AC(2).LT.-0.5)AC(2)=AC(2)+1
IF(AC(3).LT.-0.5)AC(3)=AC(3)+1
!PRINT*,AB,AC
!PAUSE
!AB=MATMUL(SLATORIG,AB)
!AC=MATMUL(SLATORIG,AC)
AB=MATMUL(AB,SLATORIG)
AC=MATMUL(AC,SLATORIG)
ttheta=dot_product(AB,AC)/(norm2(AB)*norm2(AC))
ttheta=acos(ttheta)
areac=norm2(AB)*norm2(AC)*sin(ttheta)
end subroutine
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
SUBROUTINE CAREA2022(IT2,I1,I2,I3,areac)
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,I2,I3,IT2
DOUBLE PRECISION,DIMENSION(3)::AB,AC
DOUBLE PRECISION::AREAc,ttheta
!AB=MATMUL(ISLATORIG, POS(IT,I1,:)-POS(IT,I2,:))
!AC=MATMUL(ISLATORIG, POS(IT,I1,:)-POS(IT,I3,:))
AB=0
AC=0
areac=0
ttheta=0

AB=MATMUL( POS(IT2,I1,:)-POS(IT2,I2,:),ISLATORIG)
AC=MATMUL( POS(IT2,I1,:)-POS(IT2,I3,:),ISLATORIG)
IF(AB(1).GT.0.5)AB(1)=AB(1)-1
IF(AB(2).GT.0.5)AB(2)=AB(2)-1
IF(AB(3).GT.0.5)AB(3)=AB(3)-1
IF(AB(1).LT.-0.5)AB(1)=AB(1)+1
IF(AB(2).LT.-0.5)AB(2)=AB(2)+1
IF(AB(3).LT.-0.5)AB(3)=AB(3)+1
IF(AC(1).GT.0.5)AC(1)=AC(1)-1
IF(AC(2).GT.0.5)AC(2)=AC(2)-1
IF(AC(3).GT.0.5)AC(3)=AC(3)-1
IF(AC(1).LT.-0.5)AC(1)=AC(1)+1
IF(AC(2).LT.-0.5)AC(2)=AC(2)+1
IF(AC(3).LT.-0.5)AC(3)=AC(3)+1
!PRINT*,AB,AC
!PAUSE
!AB=MATMUL(SLATORIG,AB)
!AC=MATMUL(SLATORIG,AC)
AB=MATMUL(AB,SLATORIG)
AC=MATMUL(AC,SLATORIG)
ttheta=dot_product(AB,AC)/(norm2(AB)*norm2(AC))
ttheta=acos(ttheta)
areac=norm2(AB)*norm2(AC)*sin(ttheta)
end subroutine





!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!BROADEING PARALEL  ROUTINE 


SUBROUTINE BROAD3(FWHM00,FWHM11,AAA,BBB)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(NDOS)::AAA,BBB
DOUBLE PRECISION::FWHM00,FWHM11
INTEGER::K2,NDOS1
DOUBLE PRECISION,DIMENSION(NDOS,NDOS)::GAUSSIAN !,DELX1
DOUBLE PRECISION,DIMENSION(NDOS)::DELX
DOUBLE PRECISION,DIMENSION(NDOS)::SUMM
DOUBLE PRECISION,DIMENSION(NDOS)::FF 
DOUBLE PRECISION,DIMENSION(NDOS)::OM 
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::AAA,BBB
REAL::DELW2
!ALLOCATE(AAA(NDOS),BBB(NDOS))

NDOS1=NDOS
IF (ISQW==1)NDOS1=NSTEP
IF(FWHM00.NE.0.0.OR.FWHM11.NE.0.0)THEN


PRINT*, 'BROAD3 SCHEME FWHM in meV=',FWHM00
DELW=4.136*REAL(1/(DELT*NSTEP))
DELW2=DELW*DELW
BBB=0
!FWHM=SQRT((FWHM00**2)  - ((FWHM11*OMEGA/100)**2))/2.1174
DO I=1,NDOS1
DELX(I)=REAL(I)
END DO
!PRINT*,'FWHM'
        SUMM=0
!$omp parallel do
DO I=1,NDOS1  !NSTEP
        OM(I)=4.136*REAL((I-1)/(DELT*NSTEP))
        FF(I)=(FWHM00**2   + ((FWHM11*OM(I)/100)**2))/(2*2*1.1774*1.1774)

!         DELX1(I,:)=DELW2*(REAL(DELX)-REAL(I))**2
!         DELX1(I,:)=(DELX1(I,:)*DELX1(I,:))*DELW2 
         !GAUSSIAN(I,:)=EXP(-DELX1(I,:)/(2*FF(I)*FF(I)))
         GAUSSIAN(I,:)=EXP((-DELW2*(REAL(DELX)-REAL(I))**2)/(2*FF(I)))
	 SUMM(I)=SUM(GAUSSIAN(I,:))
         BBB(I)=SUM(AAA*GAUSSIAN(I,:))
END DO
!$omp end parallel do
!                DO IK=1,NDOS !-10,10  !NDOS !NSTEP !1000
!                   K2=I-IK
!                !IF(K2.LE.0)K2=1
!                DELX1=DELX-I        !  REAL(K2)*DELW
!                !IF(k2 .LT.0)DELX=0
!                DELX=DELX*DELX
!                BROAD=EXP(-DELX/(2*FWHM*FWHM))
!                BBB(I)=BBB(I)+AAA(IK)*BROAD
!                SUMM=SUMM+BROAD
!                END DO
!                IF(SUMM.GT.0)BBB(I)=BBB(I)/SUMM
!END DO
PRINT*,'BROADENING DONE'
!DEALLOCATE(GAUSS,BBB,AAA,SUMM,DELX1)
END IF

IF(FWHM00.EQ.0.0.AND.FWHM11.EQ.0.0)BBB=AAA


!DEALLOCATE(AAA,BBB)
END SUBROUTINE
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!





SUBROUTINE BROAD2(FWHM00,FWHM11,AAA,BBB)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(NDOS)::AAA,BBB
DOUBLE PRECISION::FWHM00,FWHM11
INTEGER::K2,NDOS1
DOUBLE PRECISION::DELX,BROAD,SUMM
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::AAA,BBB
!ALLOCATE(AAA(NDOS),BBB(NDOS))
!PRINT*, 'FWHM in meV=',FWHM00
DELW=4.136*REAL(1/(DELT*NSTEP))
BBB=0
NDOS1=NDOS
IF (ISQW==1)NDOS1=NSTEP
IF(FWHM00.NE.0.0.OR.FWHM11.NE.0.0)THEN
!!$omp parallel do
DO I=1,NDOS1  !NSTEP
        OMEGA=4.136*REAL((I-1)/(DELT*NSTEP))
        FWHM=SQRT((FWHM00**2)  + ((FWHM11*OMEGA/100)**2))/(2*1.1774)
        SUMM=0
                DO IK=1,NDOS1 !-10,10  !NDOS !NSTEP !1000
                   K2=I-IK
                !IF(K2.LE.0)K2=1
                DELX=REAL(K2)*DELW
                !IF(k2 .LT.0)DELX=0
                DELX=DELX*DELX
                BROAD=EXP(-DELX/(2*FWHM*FWHM))
                BBB(I)=BBB(I)+AAA(IK)*BROAD
                SUMM=SUMM+BROAD
                
                !PRINT*,BBB(I),AAA(IK),K2
                END DO
                IF(SUMM.GT.0)BBB(I)=BBB(I)/SUMM
END DO
!!$omp end parallel do
END IF
IF(FWHM00.EQ.0.0.AND.FWHM11.EQ.0.0)BBB=AAA
                !PAUSE
!DEALLOCATE(AAA,BBB)
END SUBROUTINE
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


SUBROUTINE OLD_BROAD2(FWHM00,FWHM11,AAA,BBB)
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::AAA,BBB
DOUBLE PRECISION::FWHM00,FWHM11
INTEGER::K2,NDOS1
DOUBLE PRECISION::DELX,BROAD,SUMM
ALLOCATE(AAA(NDOS),BBB(NSTEP))
!PRINT*, 'FWHM in meV=',FWHM00
NDOS1=NDOS
IF (ISQW==1)NDOS1=NSTEP
DELW=4.136*REAL(1/(DELT*NSTEP))
BBB=0
DO I=1,NDOS1  !NSTEP
        OMEGA=4.136*REAL((I-1)/(DELT*NSTEP))
        FWHM=SQRT((FWHM00**2)  - ((FWHM11*OMEGA/100)**2))/2.1174
!        SIG=FWHM/(2*1.1774)

        SUMM=0
                DO IK=1,NDOS1 !-10,10  !NDOS !NSTEP !1000
                   K2=I-IK
		!IF(K2.LE.0)K2=1
                DELX=REAL(K2)*DELW
                !IF(k2 .LT.0)DELX=0
                DELX=DELX*DELX
                BROAD=EXP(-DELX/(2*FWHM*FWHM))
                BBB(I)=BBB(I)+AAA(IK)*BROAD
                SUMM=SUMM+BROAD
                END DO
                IF(SUMM.GT.0)BBB(I)=BBB(I)/SUMM
END DO
DEALLOCATE(AAA,BBB)
END SUBROUTINE



SUBROUTINE LAMMPS            !!!!!!!!!!!!!!!!!!!!VASP XDATCAR READING 
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(3)::AA
CHARACTER*50::ABC2
INTEGER::L1,L2
INTEGER::IDR,ITH
DOUBLE PRECISION::A1,A2,B1,B2,C1,C2,A12,B12,C12
CHARACTER*50::FLNMPOSCAR
!REAL::XL,XH,XY
!REAL::YL,YH,XZ
!REAL::ZL,ZH,YZ
INTEGER::ID1,ID2
INTEGER::IND1,IND2,IND3
DOUBLE PRECISION::X1,X2,Y1,Y2,Z1,Z2,XY,XZ,YZ,XLO,XHI,YLO,YHI,ZLO,ZHI,zero
!!!!!!!!!!!!!!POLYTHINGS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DDD
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::ANGLETHETA,ANGLEPHI,DDDD,REFTHETA,REFPHI
INTEGER,ALLOCATABLE,DIMENSION(:,:)::BDIST
INTEGER,ALLOCATABLE,DIMENSION(:)::INDEXI
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DISTORTION
REAL,ALLOCATABLE,DIMENSION(:,:,:)::PROBDENSITY
!!!!!!the last index 4 due to tetrahedral cordination
DOUBLE PRECISION::RXY
DOUBLE PRECISION::RTOPI
INTEGER::JJJJ,JK,IR,JKK
DOUBLE PRECISION::D2,DR1,DR2
DOUBLE PRECISION::PROJ1,PROJ2,TWOPI
DOUBLE PRECISION,DIMENSION(3,3)::IAXIS
DOUBLE PRECISION::X,Y,Z,R
DOUBLE PRECISION,DIMENSION(3,3)::NEWLAT
INTEGER::MATOM,JCu,ICAP
INTEGER::MAXCAP,JTAG !,NCORD
DOUBLE PRECISION::AVGBOND
REAL::RSEARCH
REAL,DIMENSION(3)::XYZ
!REAL,DIMENSION(1,0:180,0:360)::PROBDENSITY
INTEGER::J1
INTEGER,DIMENSION(NATOM,12,3)::PICK
REAL::RIJ,RJK
INTEGER::NC1,NK,IM
!DOUBLE PRECISION,DIMENSION(3)::AA


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!VASP READING
zero=0.0
POS=0
!!!!!!!!!!!!!!!!!!!!!!!!!!POLY THINGS
IF (IPOLY==1.AND.ISOFT==3)THEN
ALLOCATE(DDD(3),ANGLETHETA(NNTYPE(CATOM),NCORD),ANGLEPHI(NNTYPE(CATOM),NCORD),DDDD(NNTYPE(CATOM),NCORD))
ALLOCATE(REFTHETA(NNTYPE(CATOM),NCORD),REFPHI(NNTYPE(CATOM),NCORD),BDIST(500,NCORD),INDEXI(100),DISTORTION(NNTYPE(CATOM)),PROBDENSITY(NNTYPE(CATOM),0:90,0:180))
OPEN(4100,FILE="ANGLETHETA.DAT")
OPEN(4101,FILE="ANGLEPHI.DAT")
OPEN(4102,FILE="BONDLENGTHS.DAT")
OPEN(4103,FILE="BONDLENGTHDISTRIBUTION.DAT")
OPEN(4105,FILE="MOVINGIONINDEX.DAT")
OPEN(4106,FILE="DISTORTION.DAT")
OPEN(5000,FILE="PROBDENSITY_THETA_PHI")
PRINT*,'I M IN POLY'
PRINT*,CATOM,SATOM,NK
PROBDENSITY=0
RSEARCH=8.0
MATOM=1
PRINT*,'MOBILE ATOM IS 1 and RSEARCH iS ', RSEARCH
MAXCAP=32
RTOPI=180/(4*ATAN(1.0))  !3.14
PI=4*ATAN(1.0)
TWOPI=8*ATAN(1.0)
    AX3(1)=AX1(2)*AX2(3)-AX1(3)*AX2(2)
    AX3(2)=AX1(3)*AX2(1)-AX1(1)*AX2(3)
    AX3(3)=AX1(1)*AX2(2)-AX1(2)*AX2(1)
IAXIS(1,:)=AX1/NORM2(AX1)
IAXIS(2,:)=AX2/NORM2(AX2)
IAXIS(3,:)=AX3/NORM2(AX3)
END IF
!!!!!!!!!!!!!!!!!!!!!!!!!





PRINT*,'I M LAMMPS.........NVT ONLY'
!        PRINT*,'GRCUT'
!        READ*,GRCUT
IF(IWRITE==1)OPEN(3,FILE="XDATCARNEW.DAT")
OPEN(31,FILE="velocity.lammpstrj")
TIME=0
3 FORMAT(3F18.10)
2 FORMAT(A40)
PRINT*,IREF1,NATOM,ATMNM,NNTYPE
PRINT*,FLNM,IREF1
PRINT*,NTYP

DO IT=1,IREF1-1
        TIME=TIME+1
        DO I=1,9
        READ(2,*)
        IF(IVEL==1)READ(31,*)
        END DO
!        READ(2,*)xl,xh,xy
!        READ(2,*)yl,yh,xz
!        READ(2,*)zl,zh,yz
!        alat=xh-xl
!        blat=yh-yl
!        blat=sqrt(blat*blat + 
        DO I=1,NATOM
        READ(2,*)
        IF(IVEL==1)READ(31,*)
        END DO
!        IF(ISIF3==1.OR.IT==1)THEN
!        READ(2,2)ABC2
        IF(IWRITE==1)WRITE(3,2)'LAMMPS XDATCAR' !ABC2
!        READ(2,2)ABC2
        IF(IWRITE==1)WRITE(3,2)'1.0' !ABC2
!        READ(2,*)SLAT(1,:)
!        READ(2,*)SLAT(2,:)
!        READ(2,*)SLAT(3,:)
!        SLATORIG=SLAT
!        ISLATORIG=TRANSPOSE(SLAT)
!        CALL GAUSS(ISLATORIG,3)
        IF(IWRITE==1)WRITE(3,3)SLAT(1,:)
        IF(IWRITE==1)WRITE(3,3)SLAT(2,:)
        IF(IWRITE==1)write(3,3)SLAT(3,:)
!        READ(2,*)!ATMNM
        IF(IWRITE==1)WRITE(3,*)ATMNM
!        READ(2,2)ABC2
        IF(IWRITE==1)WRITE(3,*)NNTYPE !ABC2
!        SLAT1=SLAT
!        ISLAT1=SLAT1
!        CALL GAUSS(ISLAT1,3)
!        SLAT=TRANSPOSE(SLAT)        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!        ISLAT=SLAT
!        CALL GAUSS(ISLAT,3)
!        END IF
!       READ(2,2)
        IF(IWRITE==1)WRITE(3,2)'D' !ABC2
!        DO I=1,NATOM
!        READ(2,*) !POS(LL,I,:)      
!        END DO
END DO
        !PAUSE

ISLAT=SLAT
CALL GAUSS(ISLAT,3)

!PRINT*,ISLAT
!!!!!!!!!!!!
IND1=1
IND2=1  !FOR DIFFUSE SCATTERING STUF
IND3=0
!!!!!!!!!!!!!!
LL=0
DO IT=1,IREF2-IREF1+1
!PRINT*,IT

        TIME=TIME+1
!        PRINT*,TIME
        !PRINT*,'IT'
        READ(2,*)
        READ(2,*)
        READ(2,*)
        READ(2,*)
        READ(2,*)
        IF(ISKEW==0)THEN
        READ(2,*)x1,x2
        READ(2,*)y1,y2
        READ(2,*)z1,z2
        XY=0
        XZ=0
        YZ=0
        else 
        READ(2,*)x1,x2,xy
        READ(2,*)y1,y2,xz
        READ(2,*)z1,z2,yz
        END IF
        !print*,x1,x2,xy
        !print*,y1,y2,xz
        !print*,z1,z2,yz
        xlo=x1-min(zero,xy,xz,xy+xz)
        xhi=x2-max(zero,xy,xz,xy+xz)
        ylo=y1-min(zero,yz)
        yhi=y2-max(zero,yz)
        zlo=z1
        zhi=z2
        SLAT(1,1)=xhi-xlo        
        SLAT(1,2)=xy      
        SLAT(1,3)=xz        
        SLAT(2,1)=0
        SLAT(2,2)=yhi-ylo
        SLAT(2,3)=yz
        SLAT(3,1)=0
        SLAT(3,2)=0
        SLAT(3,3)=zhi-zlo
        SLAT=TRANSPOSE(SLAT)

        IF(IT==1)PRINT*,'LAMMPS 1st step Lattice Vectors'
        IF(IT==1)PRINT*, SLAT
        ISLAT=SLAT
        CALL GAUSS(ISLAT,3)
        READ(2,*)

        DO I=1,9
        IF(IVEL==1.or.IVEL==2)READ(31,*)
        END DO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!TRICK FOR IND1 IND2 IND3!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        IND3=IND3+1
 	 IF(IND3.GT.NCUB)THEN
		IND3=IND3-NCUB
		IND2=IND2+1
		IF(IND2.GT.NCUB)THEN
		 IND2=IND2-NCUB
		 IND1=IND1+1
                 
		END IF
	 END IF
        ! PRINT*,IND1,IND2,IND3
        LL=LL+1
!        AVGSLAT=AVGSLAT+SLAT
!        READ(2,2)ABC2
        IF(IWRITE==1)WRITE(3,2)'D' !ABC2
        !PRINT*,IT
     IF(NMOL.EQ.1)THEN
        DO I=1,NATOM
        !        IF(IT.GT.1962)PRINT*,I
                IF(ID==0)READ(2,*)POS(LL,I,:)
                IF(ID==0.AND.IVEL==1)READ(31,*)VEL(LL,I,:)
                IF(ID==1)READ(2,*)ID1,ID2,POS(LL,I,:)
                IF(ID==1.AND.IVEL==1)READ(31,*)ID1,ID2,VEL(LL,I,:)
                IF(ID==1.AND.IVEL==2)READ(31,*)VEL(LL,I,:)
                345 FORMAT(I5,3F10.5)
                !POS(LL,I,:)=MATMUL(ISLAT,POS(LL,I,:))
                POS(LL,I,:)=MATMUL(POS(LL,I,:),ISLAT)
                !RR1(I,:)=MATMUL(ISLAT,POS(LL,I,:))
                RR1(I,:)=POS(LL,I,:)          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!SAVED AS R1 FOR GRR CALCULATION 
                WHERE(RR1(I,:).LT.0.0)RR1(I,:)=RR1(I,:)+1
                WHERE(RR1(I,:).GE.1.0)RR1(I,:)=RR1(I,:)-1

!               IF(IDIFFUSE==1)WHERE(RR1(I,:).LT.0.0)RR1(I,:)=RR1(I,:)+1
!               IF(IDIFFUSE==1)WHERE(RR1(I,:).GE.1.0)RR1(I,:)=RR1(I,:)-1
		!IF(IND1.LE.NCUB.AND.IDIFFUSE==1)TPOS(IND1,IND2,IND3,I,:)=RR1(I,:) + (/IND1-1, IND2-1,IND3-1 /)

                IF(LL.GE.2.AND.ISKIP.NE.1)THEN
                !POS(LL-1,I,:)=MATMUL(ISLAT,POS(LL-1,I,:))
                POS(LL-1,I,:)=MATMUL(POS(LL-1,I,:),ISLAT)
                AA=POS(LL,I,:)-POS(LL-1,I,:)
                WHERE(AA.LT.-0.5)POS(LL,I,:)=POS(LL,I,:)+1                
                WHERE(AA.GT.+0.5)POS(LL,I,:)=POS(LL,I,:)-1                
!               IF(AA(1).LT.-0.5)POS(LL,I,1)=POS(LL,I,1)+1
!               IF(AA(2).LT.-0.5)POS(LL,I,2)=POS(LL,I,2)+1
!               IF(AA(3).LT.-0.5)POS(LL,I,3)=POS(LL,I,3)+1
!               IF(AA(1).GT.+0.5)POS(LL,I,1)=POS(LL,I,1)-1
!               IF(AA(2).GT.+0.5)POS(LL,I,2)=POS(LL,I,2)-1
!               IF(AA(3).GT.+0.5)POS(LL,I,3)=POS(LL,I,3)-1
                !POS(LL-1,I,:)=MATMUL(SLAT,POS(LL-1,I,:))
                POS(LL-1,I,:)=MATMUL(POS(LL-1,I,:),SLAT)
                ENDIF
                IF(IWRITE==1)WRITE(3,3)POS(LL,I,:)
                !POS(LL,I,:)=MATMUL(SLAT,POS(LL,I,:))
                POS(LL,I,:)=MATMUL(POS(LL,I,:),SLAT)
                IF(IVEL.EQ.0.AND.LL.GE.2.0)THEN
                VEL(LL,I,:)=(POS(LL,I,:)-POS(LL-1,I,:))/DELT
                92 FORMAT(3F9.3,2x,3f9.3)
                END IF

        END DO
      END IF


IF(NMOL.GT.1) THEN
        DO IM=1,NMOL
           DO ITYP=1,NTYP
             N1= SUM(NNTYPE(1:ITYP-1))  +1 +(IM-1)*(NNTYPE(ITYP)/NMOL)
             N2= N1+ NNTYPE(ITYP)/NMOL -1   !  + (IM-1)*(NATOM/NMOL)
               DO I=N1,N2
                IF(ID==0)READ(2,*)POS(LL,I,:)
                IF(ID==0.AND.IVEL==1)READ(31,*)VEL(LL,I,:)
                IF(ID==1)READ(2,*)ID1,ID2,POS(LL,I,:)
                IF(ID==1.AND.IVEL==1)READ(31,*)ID1,ID2,VEL(LL,I,:)
                IF(ID==1.AND.IVEL==2)READ(31,*)VEL(LL,I,:)
           !     PRINT 987,LL, IM,N1,N2,N2-N1
                987  FORMAT(I4,10I5)
!                345 FORMAT(I5,3F10.5)
                !POS(LL,I,:)=MATMUL(ISLAT,POS(LL,I,:))
                POS(LL,I,:)=MATMUL(POS(LL,I,:),ISLAT)
                RR1(I,:)=POS(LL,I,:)   !#MATMUL(ISLAT,POS(LL,I,:))
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!SAVED AS R1 FOR GRR CALCULATION
                WHERE(RR1(I,:).LT.0.0)RR1(I,:)=RR1(I,:)+1
                WHERE(RR1(I,:).GE.1.0)RR1(I,:)=RR1(I,:)-1
                !IF(IND1.LE.NCUB.AND.IDIFFUSE==1)TPOS(IND1,IND2,IND3,I,:)=RR1(I,:) + (/IND1-1, IND2-1,IND3-1 /)
                IF(LL.GE.2.AND.ISKIP.NE.1)THEN
                !POS(LL-1,I,:)=MATMUL(ISLAT,POS(LL-1,I,:))
                POS(LL-1,I,:)=MATMUL(POS(LL-1,I,:),ISLAT)
                AA=POS(LL,I,:)-POS(LL-1,I,:)
                WHERE(AA.LT.-0.5)POS(LL,I,:)=POS(LL,I,:)+1
                WHERE(AA.GT.+0.5)POS(LL,I,:)=POS(LL,I,:)-1
!               IF(AA(1).LT.-0.5)POS(LL,I,1)=POS(LL,I,1)+1
!               IF(AA(2).LT.-0.5)POS(LL,I,2)=POS(LL,I,2)+1
!               IF(AA(3).LT.-0.5)POS(LL,I,3)=POS(LL,I,3)+1
!               IF(AA(1).GT.+0.5)POS(LL,I,1)=POS(LL,I,1)-1
!               IF(AA(2).GT.+0.5)POS(LL,I,2)=POS(LL,I,2)-1
!               IF(AA(3).GT.+0.5)POS(LL,I,3)=POS(LL,I,3)-1
                !POS(LL-1,I,:)=MATMUL(SLAT,POS(LL-1,I,:))
                POS(LL-1,I,:)=MATMUL(POS(LL-1,I,:),SLAT)
                ENDIF

                IF(IWRITE==1)WRITE(3,3)POS(LL,I,:)
                !POS(LL,I,:)=MATMUL(SLAT,POS(LL,I,:))
                POS(LL,I,:)=MATMUL(POS(LL,I,:),SLAT)
                IF(IVEL.EQ.0.AND.LL.GE.2.0)THEN
                VEL(LL,I,:)=(POS(LL,I,:)-POS(LL-1,I,:))/DELT
                !92 FORMAT(3F9.3,2x,3f9.3)
                END IF

           END DO
          END DO
        END DO
END IF

        IINTERVAL=MOD(LL,INTERVAL)
        IF(IINTERVAL.EQ.0.AND.IT.LE.(IREF2-IREF1))THEN
        IPOINTS=IPOINTS+1
        IF(IGRR==1)CALL GRRFN4LAMMPS

!        IF(ASTATUS.AND.IRECORD.LT.10)THEN
!        WRITE(FLNMPOSCAR,'("POSCAR",I4.4)')LL
!        PRINT*,FLNMPOSCAR
!        CALL PRINTPOSCAR(LL,FLNMPOSCAR)
!        IRECORD=IRECORD+1
!        END IF
!        PRINT*,'GOING TO ANGLE'
        IF(IANGLE==1)CALL ANGLECAL
        !IF(IDIFF==1)CALL DIFFRACTION
        END IF
        103 FORMAT(I7,1000E10.3)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!POLY THINGS!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
IF (IT==1.AND.IPOLY==1)THEN
DO I=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
        NC1=0
        NK=0
        DO J=SUM(NNTYPE(1:SATOM-1))+1,SUM(NNTYPE(1:SATOM))   !,NNTYPE(CATOM)
                AA=RR1(I,:)-RR1(J,:)
                WHERE(AA.LT.-0.5)AA=AA+1
                WHERE(AA.GT.0.5)AA=AA-1
                RIJ=NORM2(MATMUL(AA,SLAT))
                IF(RIJ.GT.0.AND.RIJ.LE.BOND)THEN
                 NC1=NC1+1       !!!!!!!!CORDINATION1
                 IF(NC1.GT.NCORD)EXIT
                        NK=NK+1
                        PICK(I,NK,1)=I
                        PICK(I,NK,2)=J
                END IF
        END DO
END DO
END IF


!!!!!!!!!!!!!!!!
IF(MOD(IT,INTERVAL2)==0.AND.IPOLY==1)THEN
    !PRINT*,iT
  NEWLAT=MATMUL(IAXIS,SLAT)
  JJJJ=0
  JTAG=0
  DO J=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
   JTAG=JTAG+1         !!!!!!!!!EQUIVALENT TO RUN OVER J
   JJJJ=JJJJ+1
   JK=0
   DO JK=1,NK  !SUM(NNTYPE(1:SATOM-1))+1,SUM(NNTYPE(1:SATOM))   !,NNTYPE(CATOM)
    !PRINT*,J,Jk !iT
    DDD=(RR1(J,:)-RR1(PICK(J,JK,2),:))
!    DDD=(POS(IT,J,:)-POS(IT,PICK(J,JK,2),:))
!    DDD=MATMUL(DDD,ISLAT)                           !!!!!!!!FRACTIONAL POSITION 
    WHERE(DDD.LT.-0.5)DDD=DDD+1.0
    WHERE(DDD.GT.0.5)DDD=DDD-1.0
    XYZ=MATMUL(DDD,NEWLAT)
    X=XYZ(1)
    Y=XYZ(2)
    Z=XYZ(3)
    D2=NORM2(XYZ)
    !PRINT*,D2 !XYZ
    !PAUSE
      DDDD(JTAG,JK)=D2  !NORM2(DDD)
      RXY=SQRT(Y*Y + Z*Z)
      ANGLETHETA(JJJJ,JK)=ACOS(X/D2)
      IF(RXY==0)THEN
      ANGLEPHI(JJJJ,JK)=0
      ELSE
      ANGLEPHI(JJJJ,JK)=ACOS(Y/rxy)
      IF(Y.GT.0.AND.Z.LT.0)ANGLEPHI(JJJJ,JK)=ANGLEPHI(JJJJ,JK)+ 3*TWOPI/4.0
      IF(Y.LT.0.AND.Z.LT.0)ANGLEPHI(JJJJ,JK)=ANGLEPHI(JJJJ,JK)+ TWOPI/4.0
      END IF
      !!!!!!!!!       PROBABILITY DENSITY FUNCTION!!!!!!!!!!!!!!!!
       IF(ANGLETHETA(JJJJ,JK).GT.0.AND.ANGLEPHI(JJJJ,JK).GT.0)THEN
       PROBDENSITY(JTAG,INT(ANGLETHETA(JJJJ,JK)*RTOPI/2.0),INT(ANGLEPHI(JJJJ,JK)*RTOPI/2.0))=PROBDENSITY(JTAG,INT(ANGLETHETA(JJJJ,JK)*RTOPI/2.0),INT(ANGLEPHI(JJJJ,JK)*RTOPI/2.0))+1
       END IF
   END DO!SURROUNDING SERACH ENDS
    AVGBOND=SUM(DDDD(JJJJ,:))/NCORD !JK   
    DISTORTION(JTAG)=SQRT(DOT_PRODUCT(DDDD(JTAG,:),DDDD(JTAG,:)) -NCORD*AVGBOND*AVGBOND)
    DISTORTION(JTAG)=DISTORTION(JTAG)/(NCORD*AVGBOND*AVGBOND)
!!!!!!!!!!BOND DISTRIBUTION!!!!!!!!!!!!!   
   DO IR=1,500
   DR1=DR0+(IR-1)*RSTEP
   DR2=DR0+IR*RSTEP
   DO JKK=1,NCORD  !JK
   IF(DDDD(JJJJ,JKK).GT.DR1 .AND.DDDD(JJJJ,JKK).LE.DR2)BDIST(IR,JKK)=BDIST(IR,JKK)+1
   END DO
   END DO  !!END BOND DISTRI
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  END DO !CENTRE ATOM ENDS HERE
  WRITE(4106,2103)DELT*REAL(IT),DISTORTION(:)
  WRITE(4100,2100)DELT*REAL(IT),(ANGLETHETA(JJJJ,1:NCORD)*RTOPI,JJJJ=1,NNTYPE(CATOM))
  2100 FORMAT(F10.4,1000F7.1)
  WRITE(4101,2100)DELT*REAL(IT),(ANGLEPHI(JJJJ,1:NCORD)*RTOPI,JJJJ=1,NNTYPE(CATOM))
  WRITE(4102,2102)DELT*REAL(IT),(DDDD(JJJJ,1:NCORD),JJJJ=1,NNTYPE(CATOM))
END IF ! DO     !!!!!!!!!!!!!!!!TIME ENDS HERE
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
END DO   !!!!!!!!!!!!!!!TIME ENDS 



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
IF(IGRR==1)THEN
WRITE(83,*)'#r0  pairs, GRTTOTAL, X-ray-weighted, neutron-weighted'
DO IDR=1,NR
!WRITE(83,83)R0+(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(IPOINTS),J=I,NTYP),I=1,NTYP),GAVG(IDR)/REAL(IPOINTS)
WRITE(83,83)(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(IPOINTS),J=I,NTYP),I=1,NTYP), SUM(GRRTAVG(IDR,:,:))/REAL(IPOINTS), SUM(GRRTAVGXRAY(IDR,:,:))/REAL(IPOINTS), SUM(GRRTAVGNEUTRON(IDR,:,:))/REAL(IPOINTS)
!WRITE(83,83)(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(IPOINTS),J=I,NTYP),I=1,NTYP),GAVG(IDR)/REAL(IPOINTS)
END DO
83 FORMAT(F6.3,2x,100E11.4)
END IF
IF(IANGLE==1)THEN
OPEN(13,FILE="ANGLEVAR.DAT")
        DO ITH=-180,180
        !WRITE(13,13)THE0+ITH*DELTH, (THETA(ITH,INDEX1(I,1),INDEX1(I,2),INDEX1(I,3))/REAL(IPOINTS),I=1,MAXINDEX)
        WRITE(13,13)REAL(ITH), (THETA(ITH,INDEX1(I,1),INDEX1(I,2),INDEX1(I,3))/REAL(IPOINTS),I=1,MAXINDEX)
        13 FORMAT(20(F15.5,2X))
        END DO
CLOSE(13)

OPEN(14,FILE="AVGANGLE.DAT")
        DO I=1,NTYP
        DO J=1,NTYP
        DO K=1,NTYP
        WRITE(14,14)J,I,K,AVGANG(J,I,K)/REAL(IPOINTS)
        14 FORMAT(3I5,F10.5)
        END DO
        END DO
        END DO
CLOSE(14)
END IF
PRINT*,'USEFUL STEPS ARE',LL !IREF2-IREF1+1
PRINT*, "LAMMPS READING IS DONE, and no. of steps are:",NSTEP
CLOSE(2)
CLOSE(3)
AVGISLAT=ISLAT   !!!!!!!!!!!!!!!!!!NEED TO CHANGE FOR NPT SCHEME!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
199 FORMAT(3F15.5)



POSSTART(:,:)=POS(1,:,:)

!!!!!!!!!!!!!!POLY THINGS
IF(IPOLY==1)THEN
!!!!!!!!!!!!!!!!POLY
DO IR=1,500
DR1=DR0+(IR-1)*RSTEP
WRITE(4103,2101)DR1,BDIST(IR,1:NCORD)
END DO
2101 FORMAT(F9.4,10I12)
2102 FORMAT(F9.4,1000F10.3)
2103 FORMAT(F9.4,1000F10.4)
DO J=0,180
DO I=0,90
WRITE(5000,2104) 2*REAL(J),2*REAL(I), ((PROBDENSITY(J1,I,J)/SUM(PROBDENSITY(J1,:,:))), J1=1,NNTYPE(CATOM) )  !X axis isphi and Y axis is theta
2104 FORMAT(1003E16.5)
END DO
END DO
END IF

!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!



END SUBROUTINE



SUBROUTINE PRINTPOSCAR(ITT,FLNM111)
USE VARIABLES1
IMPLICIT NONE
CHARACTER*25::FLNM111
INTEGER::ITT
OPEN(1010,FILE=FLNM111)
WRITE(1010,*)ITT
WRITE(1010,*)'1'
WRITE(1010,1010)SLAT(1,:)
WRITE(1010,1010)SLAT(2,:)
WRITE(1010,1010)SLAT(3,:)
1010 FORMAT(3F20.10)
WRITE(1010,*)ATMNM
WRITE(1010,*)NNTYPE
WRITE(1010,*)'D'
DO I=1,NATOM
!WRITE(1010,1010)MATMUL(ISLAT,POS(ITT,I,:))
WRITE(1010,1010)MATMUL(POS(ITT,I,:),ISLAT)
END DO
CLOSE(1010)
END SUBROUTINE



SUBROUTINE CHGCAR(IIREF)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::NX,NY,NZ,IIREF
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::CHG
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(NNTYPE(IIREF),3)::DPOS
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(NNTYPE(IIREF))::FIRE !DPOS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DPOS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::FIRE !DPOS
INTEGER::I1,I2
DOUBLE PRECISION::DX,DY,DZ
DOUBLE PRECISION::DX1,DY1,DZ1
DOUBLE PRECISION::DX2,DY2,DZ2
!INTEGER,DIMENSION(NNTYPE(IIREF),3)::NNBIN
INTEGER,ALLOCATABLE,DIMENSION(:,:)::NNBIN
INTEGER::IKK,INDDD
REAL::SIG
INTEGER::XI,YI,ZI
INTEGER::ISMEAR,NMAX

!!!!!!!!!!!!!!!!!
IF(IIREF>0)THEN
ALLOCATE(DPOS(NNTYPE(IIREF),3))
ALLOCATE(FIRE(NNTYPE(IIREF)))
ALLOCATE(NNBIN(NNTYPE(IIREF) ,3))
END IF
IF(IIREF<0)THEN
ALLOCATE(DPOS(NATOM,3))
ALLOCATE(FIRE(NATOM))
ALLOCATE(NNBIN(NATOM,3))
END IF



!!!!!!!!!!!!!!!




ISMEAR=1
SIG=1
PRINT*,ISLAT
NMAX=100
NX=NMAX  
NY=NMAX 
NZ=NMAX 
ALLOCATE(CHG(0:NX,0:NY,0:NZ))
CHG=0
I1=SUM(NNTYPE(1:IIREF-1))+1
I2=SUM(NNTYPE(1:IIREF))
OPEN(101,FILE="PROB.vasp")
WRITE(101,*)'COMMENT PROBABILITY DENSITY'
WRITE(101,*)'1.0'
WRITE(101,102)SLAT(1,:)
WRITE(101,102)SLAT(2,:)
WRITE(101,102)SLAT(3,:)
WRITE(101,103)ATMNM !SLAT(1,:)
WRITE(101,*)NNTYPE !ATMNM !SLAT(1,:)
WRITE(101,*)'D' !SLAT(1,:)
DO I=1,NATOM
!WRITE(101,102)MATMUL(ISLAT,POS(1,I,:)) !ATMNM !SLAT(1,:)
WRITE(101,102)MATMUL(POS(1,I,:),ISLAT) !ATMNM !SLAT(1,:)
!IF(ISOFT==3)WRITE(101,102) POS(1,I,:)  !MATMUL(ISLATORIG,POS(1,I,:)) !ATMNM !SLAT(1,:)
END DO
WRITE(101,*) !SLAT(1,:)
WRITE(101,*)NX,NY,NZ
102 FORMAT(3F20.15)
103 FORMAT(10A3)
!!$omp parallel do
IF (IIREF>0)THEN
        DO IT=1,IREF2-IREF1+1  !NSTEPORIG
        IKK=0
        DO IK=I1,I2
        IKK=IK-SUM(NNTYPE(1:IIREF-1))
        DPOS(IKK,:)=MATMUL(POS(IT,IK,:),ISLAT)
        WHERE(DPOS(IKK,:).LT.0)DPOS(IKK,:)=DPOS(IKK,:)+1 
        WHERE(DPOS(IKK,:).GT.1)DPOS(IKK,:)=DPOS(IKK,:)-1
        111 FORMAT(3F10.5)
        NNBIN(IKK,1)=DPOS(IKK,1)*NX
        NNBIN(IKK,2)=DPOS(IKK,2)*NY
        NNBIN(IKK,3)=DPOS(IKK,3)*NZ
        XI=NNBIN(IKK,1)
        YI=NNBIN(IKK,2)
        ZI=NNBIN(IKK,3)
        IF(ANY(NNBIN(IKK,:)<0).EQ..FALSE..AND.ANY(NNBIN(IKK,:)>NMAX).EQ..FALSE.)THEN
		CHG(NNBIN(IKK ,1), NNBIN(IKK,2), NNBIN(IKK,3))= CHG(NNBIN(IKK,1), NNBIN(IKK,2), NNBIN(IKK,3))+1              
		IF(ISMEAR==1)THEN
		IF(XI+1.LE.NMAX)CHG(XI+1, YI,ZI)= CHG(XI+1,YI,ZI)+exp(-1.0/sig)  
		IF(XI+2.LE.NMAX)CHG(XI+2, YI,ZI)= CHG(XI+2,YI,ZI)+exp(-4.0/sig)  
		IF(XI+3.LE.NMAX)CHG(XI+3, YI,ZI)= CHG(XI+3,YI,ZI)+exp(-9.0/sig)  
		IF(XI-1.GE.0)CHG(XI-1, YI,ZI)= CHG(XI-1,YI,ZI)+exp(-1.0/sig)  
		IF(XI-2.GE.0)CHG(XI-2, YI,ZI)= CHG(XI-2,YI,ZI)+exp(-4.0/sig)  
		IF(XI-3.GE.0)CHG(XI-3, YI,ZI)= CHG(XI-3,YI,ZI)+exp(-9.0/sig)  
	        IF(YI+1.LE.NMAX)	CHG(XI, YI+1,ZI)= CHG(XI,YI+1,ZI)+exp(-1.0/sig)  
           	IF(YI+2.LE.NMAX)	CHG(XI, YI+2,ZI)= CHG(XI,YI+2,ZI)+exp(-4.0/sig)  
	        IF(YI+3.LE.NMAX)	CHG(XI, YI+3,ZI)= CHG(XI,YI+3,ZI)+exp(-9.0/sig)  
		IF(YI-1.GE.0)CHG(XI, YI-1,ZI)= CHG(XI,YI-1,ZI)+exp(-1.0/sig)  
		IF(YI-2.GE.0)CHG(XI, YI-2,ZI)= CHG(XI,YI-2,ZI)+exp(-4.0/sig)  
		IF(YI-3.GE.0)CHG(XI, YI-3,ZI)= CHG(XI,YI-3,ZI)+exp(-9.0/sig)  
		IF(ZI+1.LE.NMAX)CHG(XI, YI,ZI+1)= CHG(XI,YI,ZI+1)+exp(-1.0/sig)  
		IF(ZI+2.LE.NMAX)CHG(XI, YI,ZI+2)= CHG(XI,YI,ZI+2)+exp(-4.0/sig)  
		IF(ZI+3.LE.NMAX)CHG(XI, YI,ZI+3)= CHG(XI,YI,ZI+3)+exp(-9.0/sig)  
		IF(ZI-1.GE.0)CHG(XI, YI,ZI-1)= CHG(XI,YI,ZI-1)+exp(-1.0/sig)  
		IF(ZI-2.GE.0)CHG(XI, YI,ZI-2)= CHG(XI,YI,ZI-2)+exp(-4.0/sig)  
		IF(ZI-3.GE.0)CHG(XI, YI,ZI-3)= CHG(XI,YI,ZI-3)+exp(-9.0/sig)  
		END IF
        !		CHG(NNBIN(IKK ,1), NNBIN(IKK,2), NNBIN(IKK,3))= CHG(NNBIN(IKK,1), NNBIN(IKK,2), NNBIN(IKK,3))+1              
	END IF
        !        CHG(NNBIN(IKK,1), NNBIN(IKK,2), NNBIN(IKK,3))=CHG(NNBIN(IKK,1), NNBIN(IKK,2), NNBIN(IKK,3))+1
        END DO
        END DO
        !!$omp end parallel do
        !CHG=CHG*1000/(NNTYPE(IIREF)*(IREF2-IREF1+1)) 
        CHG=CHG/SUM(CHG)  !*1000/(NNTYPE(IIREF)*(IREF2-IREF1+1)) 
        print*,sum(CHG)
END IF
IF (IIREF<0)THEN
        DO IT=1,IREF2-IREF1+1  !NSTEPORIG
        IKK=0
        DO IK=1,NATOM 
        IKK=IK  !-SUM(NNTYPE(1:IIREF-1))
        !DPOS(IKK,:)=MATMUL(ISLAT,POS(IT,IK,:))
        DPOS(IKK,:)=MATMUL(POS(IT,IK,:),ISLAT)
        WHERE(DPOS(IKK,:).LT.0)DPOS(IKK,:)=DPOS(IKK,:)+1 
        WHERE(DPOS(IKK,:).GT.1)DPOS(IKK,:)=DPOS(IKK,:)-1
!        111 FORMAT(3F10.5)
        NNBIN(IKK,1)=DPOS(IKK,1)*NX
        NNBIN(IKK,2)=DPOS(IKK,2)*NY
        NNBIN(IKK,3)=DPOS(IKK,3)*NZ
        XI=NNBIN(IKK,1)
        YI=NNBIN(IKK,2)
        ZI=NNBIN(IKK,3)
        IF(ANY(NNBIN(IKK,:)<0).EQ..FALSE..AND.ANY(NNBIN(IKK,:)>NMAX).EQ..FALSE.)THEN
		CHG(NNBIN(IKK ,1), NNBIN(IKK,2), NNBIN(IKK,3))= CHG(NNBIN(IKK,1), NNBIN(IKK,2), NNBIN(IKK,3))+1              
		IF(ISMEAR==1)THEN
		IF(XI+1.LE.NMAX)CHG(XI+1, YI,ZI)= CHG(XI+1,YI,ZI)+exp(-1.0/sig)  
		IF(XI+2.LE.NMAX)CHG(XI+2, YI,ZI)= CHG(XI+2,YI,ZI)+exp(-4.0/sig)  
		IF(XI+3.LE.NMAX)CHG(XI+3, YI,ZI)= CHG(XI+3,YI,ZI)+exp(-9.0/sig)  
		IF(XI-1.GE.0)CHG(XI-1, YI,ZI)= CHG(XI-1,YI,ZI)+exp(-1.0/sig)  
		IF(XI-2.GE.0)CHG(XI-2, YI,ZI)= CHG(XI-2,YI,ZI)+exp(-4.0/sig)  
		IF(XI-3.GE.0)CHG(XI-3, YI,ZI)= CHG(XI-3,YI,ZI)+exp(-9.0/sig)  
	        IF(YI+1.LE.NMAX)	CHG(XI, YI+1,ZI)= CHG(XI,YI+1,ZI)+exp(-1.0/sig)  
           	IF(YI+2.LE.NMAX)	CHG(XI, YI+2,ZI)= CHG(XI,YI+2,ZI)+exp(-4.0/sig)  
	        IF(YI+3.LE.NMAX)	CHG(XI, YI+3,ZI)= CHG(XI,YI+3,ZI)+exp(-9.0/sig)  
		IF(YI-1.GE.0)CHG(XI, YI-1,ZI)= CHG(XI,YI-1,ZI)+exp(-1.0/sig)  
		IF(YI-2.GE.0)CHG(XI, YI-2,ZI)= CHG(XI,YI-2,ZI)+exp(-4.0/sig)  
		IF(YI-3.GE.0)CHG(XI, YI-3,ZI)= CHG(XI,YI-3,ZI)+exp(-9.0/sig)  
		IF(ZI+1.LE.NMAX)CHG(XI, YI,ZI+1)= CHG(XI,YI,ZI+1)+exp(-1.0/sig)  
		IF(ZI+2.LE.NMAX)CHG(XI, YI,ZI+2)= CHG(XI,YI,ZI+2)+exp(-4.0/sig)  
		IF(ZI+3.LE.NMAX)CHG(XI, YI,ZI+3)= CHG(XI,YI,ZI+3)+exp(-9.0/sig)  
		IF(ZI-1.GE.0)CHG(XI, YI,ZI-1)= CHG(XI,YI,ZI-1)+exp(-1.0/sig)  
		IF(ZI-2.GE.0)CHG(XI, YI,ZI-2)= CHG(XI,YI,ZI-2)+exp(-4.0/sig)  
		IF(ZI-3.GE.0)CHG(XI, YI,ZI-3)= CHG(XI,YI,ZI-3)+exp(-9.0/sig)  
		END IF
        !		CHG(NNBIN(IKK ,1), NNBIN(IKK,2), NNBIN(IKK,3))= CHG(NNBIN(IKK,1), NNBIN(IKK,2), NNBIN(IKK,3))+1              
	END IF
        !        CHG(NNBIN(IKK,1), NNBIN(IKK,2), NNBIN(IKK,3))=CHG(NNBIN(IKK,1), NNBIN(IKK,2), NNBIN(IKK,3))+1
        END DO
        END DO
        !!$omp end parallel do
        !CHG=CHG*1000/(NNTYPE(IIREF)*(IREF2-IREF1+1)) 
        CHG=NATOM*CHG/SUM(CHG)  !*1000/(NNTYPE(IIREF)*(IREF2-IREF1+1)) 
print*,sum(CHG)
END IF











WRITE(101,101)(((CHG(I,J,K),I=0,NX-1),J=0,NY-1),K=0,NZ-1)
101 FORMAT(5E12.5)
IF (IIREF>0) PRINT*,'PROBABILITY DISTRIBUTION OF',ATMNM(IIREF),'IS CALCULATED OVER',IREF2-IREF1+1,'STEPS'
IF (IIREF<0) PRINT*,'PROBABILITY DISTRIBUTION OF SYSTEM   IS CALCULATED OVER',IREF2-IREF1+1,'STEPS'
!!!!!!!!!!!!!!!!!FOLDING  THE STRUCTURE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
END SUBROUTINE



SUBROUTINE PCHGCAR(IIREF)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::NX,NY,NZ,IIREF
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::CHG
DOUBLE PRECISION,DIMENSION(NSTEPORIG,3)::DPOS
INTEGER::I1,I2
DOUBLE PRECISION::DX,DY,DZ
DOUBLE PRECISION::DX1,DY1,DZ1
DOUBLE PRECISION::DX2,DY2,DZ2
INTEGER,DIMENSION(NSTEPORIG,3)::NNBIN
INTEGER::IKK
PRINT*,ISLAT
NX=100
NY=100
NZ=100
ALLOCATE(CHG(0:NX,0:NY,0:NZ))
CHG=0
I1=SUM(NNTYPE(1:IIREF-1))+1
I2=SUM(NNTYPE(1:IIREF))
OPEN(101,FILE="PROB.vasp")
WRITE(101,*)'COMMENT PROBABILITY DENSITY'
WRITE(101,*)'1.0'
WRITE(101,102)SLAT(1,:)
WRITE(101,102)SLAT(2,:)
WRITE(101,102)SLAT(3,:)
WRITE(101,103)ATMNM !SLAT(1,:)
WRITE(101,*)NNTYPE !ATMNM !SLAT(1,:)
WRITE(101,*)'D' !SLAT(1,:)
DO I=1,NATOM
!WRITE(101,102)MATMUL(ISLAT,POS(1,I,:)) !ATMNM !SLAT(1,:)
WRITE(101,102)MATMUL(POS(1,I,:),ISLAT) !ATMNM !SLAT(1,:)
END DO
WRITE(101,*) !SLAT(1,:)
WRITE(101,*)NX+1,NY+1,NZ+1  
102 FORMAT(3F20.15)
103 FORMAT(10A3)
!$omp parallel do
	DO IT=1,IREF2-IREF1+1  !NSTEPORIG
     
        IKK=0
        DO IK=I1,I2
        !IKK=IK-SUM(NNTYPE(1:IIREF-1)) 
        !DPOS(IT,:)=MATMUL(ISLAT,POS(IT,IK,:))
        DPOS(IT,:)=MATMUL(POS(IT,IK,:),ISLAT)
        WHERE(DPOS(IT,:).LT.0)DPOS(IT,:)=DPOS(IT,:)+1 !PRINT 111,DPOS(IKK,:)
        111 FORMAT(3F10.5)
        NNBIN(IT ,1)=DPOS(IT ,1)*NX 
        NNBIN(IT ,2)=DPOS(IT ,2)*NY 
        NNBIN(IT ,3)=DPOS(IT ,3)*NZ
        IF(ANY(NNBIN(IT,:)>100).EQ..FALSE.)CHG(NNBIN(IT ,1), NNBIN(IT,2), NNBIN(IT,3))=CHG(NNBIN(IT,1), NNBIN(IT,2), NNBIN(IT,3))+1                 
	END DO
        END DO
!$omp end parallel do
        CHG=CHG/(NNTYPE(IIREF)*(IREF2-IREF1+1)) 
WRITE(101,101)(((CHG(I,J,K),I=0,NX),J=0,NY),K=0,NZ)
101 FORMAT(5F10.4)
PRINT*,'PROBABILITY DISTRIBUTION OF',ATMNM(IIREF),'IS CALCULATED OVER',IREF2-IREF1+1,'STEPS'
END SUBROUTINE








SUBROUTINE IIFQT3(IQQQQ)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::FQT,FFQTTYP!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::CFFQTTYP !,SQWB
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
REAL,DIMENSION(NSTEP)::PHASE1
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::II1,I1,DT1,III
!DOUBLE  PRECISION,ALLOCATABLE,DIMENSION(:,:)::KLIST
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DUMMY2,DUMMY4
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMYT
DOUBLE PRECISION::EE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK
INTEGER::ITYPPP,JTYPPP
INTEGER::IQQQQ,NNN2
CHARACTER::AA*9
INTEGER::NTYP2
INTEGER::IJ1,IJ2
INTEGER::IQTCAL
integer,allocatable,dimension(:)::plan
integer::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
IQTCAL=0         !!!!DO  NOT CALCLATE FQT

!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::AAA
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::BBB
!Integer :: Status
!Complex,ALLOCATABLE,DIMENSION(:) :: AAAA
NTYP2=NTYP*(NTYP+1)/2
PRINT*,NTYP2
WRITE(AA,'("CSQWTOT",I2.2)')IQQQQ
OPEN(170,FILE=AA)
WRITE(AA,'("ISQWTOT",I2.2)')IQQQQ
OPEN(180,FILE=AA)
IF(IQTCAL==1)WRITE(AA,'("CIQTTOT",I2.2)')IQQQQ
IF(IQTCAL==1)OPEN(190,FILE=AA)
IF(IQTCAL==1)WRITE(AA,'("IIQTTOT",I2.2)')IQQQQ
IF(IQTCAL==1)OPEN(200,FILE=AA)
OPEN(17,FILE="CSQ")
OPEN(18,FILE="ISQ")
IF(IQTCAL==1) OPEN(19,FILE="CIQ")
IF(IQTCAL==1)OPEN(20,FILE="IIQ")
PRINT*,'I AM IN IFFQT'
ALLOCATE(FQT(1:NSTEP,NATOM))
!ALLOCATE(AAAA(NSTEP))
!ALLOCATE(AAA(NATOM,2*NSTEP))
!ALLOCATE(BBB(2*NSTEP))
ALLOCATE(FFQTTYP(1:NSTEP,NTYP))
ALLOCATE(CFFQTTYP(1:NSTEP,NTYP,NTYP))
allocate(plan(NATOM))

FQT=0
FFQTTYP=0
CFFQTTYP=0
IFOR= 1
IBAC=-1

PRINT*,AVGISLAT
PRINT*,NTYP

IF(ILIST.NE.3)THEN
WRITE(AA,'("KKLIST",I2.2)')IQQQQ
OPEN(44,FILE=AA)
I=0
DO  
I=I+1 
READ(44,*,END=100)KLIST(I,:)
END DO
100 CONTINUE
NQ=I-1
I=0
PRINT*,'NQ',NQ
ALLOCATE(QQ(NQ,3),QK(NQ,3))
ALLOCATE(DUMMY2(NQ,NTYP2+1,NSTEP),DUMMY4(NQ,NTYP2+1,NSTEP))
END IF

IF(ILIST.EQ.3)THEN
NQ=IQQQQ 
PRINT*,KLIST(NQ,:)
ALLOCATE(QQ(NQ,3),QK(NQ,3))
ALLOCATE(DUMMY2(NQ,NTYP2+1,NSTEP),DUMMY4(NQ,NTYP2+1,NSTEP))
END IF
ALLOCATE(DUMMYT(NSTEP),KSELF(NTYP))
PRINT*,'NSTEP',NSTEP
	FFQTTYP=0
	CFFQTTYP=0
DO IQ=1,NQ
	PRINT*,'IQ=',IQ
	QQ(IQ,:)=KLIST(IQ,:) !VEC
	IF(ICARTESIAN==1)THEN
        KVEC=KLIST(IQ,:)
        ELSE
        !KVEC=2.0*PI*MATMUL(KLIST(IQ,:),AVGISLAT)        !CHANGED AVGISLAT TO ISLAT
        KVEC=2.0*PI*MATMUL(AVGISLAT,KLIST(IQ,:) )        !iRECIPROCAL IS TRANSPOSE OF ISLAT, HENCE MULTIPLY OTHERWAY 
        END IF
	QK(IQ,:)=KVEC
        DO I=1,NATOM
		!$omp parallel do
        	DO IT=1,NSTEPORIG  
                PHASE1(IT)=DOT_PRODUCT(KVEC,POS(IT,I,:))
                FQT(IT,I)=CMPLX(COS(PHASE1(IT)),SIN(PHASE1(IT)))
                END DO
		!$omp end parallel do
   
	     	!DO IT=NSTEPORIG+1,NSTEP
                !FQT(IT,I)=FQT(NSTEPORIG,I)
                !END DO

        call dfftw_plan_dft_1d(plann,NSTEP,FQT(:,I),FQT(:,I),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, FQT(:,I),FQT(:,I))
        call dfftw_destroy_plan(plann)
        FQT(:,I)=FQT(:,I)/REAL(NSTEPORIG)
        END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!INCOHERENT CALCULATION 
IF (ICOH==0.OR.ICOH==3)THEN               !INCOHRENT CASE
PRINT*,'I AM IN INCOHERENT'
        DO ITYPPP=1,NTYP
!        DO I=SUM(NNTYPE(1:ITYPPP-1))+1,SUM(NNTYPE(1:ITYPPP)) !NATOM
    FFQTTYP(1:NSTEP,ITYPPP)=FFQTTYP(1:NSTEP,ITYPPP) +  SUM(FQT(1:NSTEP, SUM(NNTYPE(1:ITYPPP-1))+1 : SUM(NNTYPE(1:ITYPPP))) * CONJG(FQT(1:NSTEP, SUM(NNTYPE(1:ITYPPP-1))+1 : SUM(NNTYPE(1:ITYPPP)))),DIM=2 )
!	END DO
        END DO
        !####!SQW SQW SQW SQW SQW SQW SQW SQW SQW SQW SQW SQWS SQWS SQW 
	DO DT=1,NSTEP
	WRITE(18,15)REAL(DT)*DELT,REAL(FFQTTYP(DT,1:NTYP))  ,SUM(REAL(FFQTTYP(DT,:))) , SUM(AIMAG(FFQTTYP(DT,:))) !/REAL(FFQTTYP(1,:)) !,SUM(REAL(FFQTTYP(DT,1:NTYP)))/SUM(REAL(FFQTTYP(1,1:NTYP))) !NATOM
	END DO

	IF(IQTCAL==1)THEN
	!######IQT IQT IQT IQT!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	DO I=1,NTYP
        call dfftw_plan_dft_1d(plan(i),NSTEP,FFQTTYP(:,I),FFQTTYP(:,I),IBAC,FFTW_ESTIMATE)
        call dfftw_execute_dft(plan(i), FFQTTYP(:,I),FFQTTYP(:,I))
        call dfftw_destroy_plan(plan(i))
        FFQTTYP(:,I)=FFQTTYP(:,I)/REAL(NSTEPORIG)
	END DO
		DO DT=1,NSTEP	
		WRITE(20,15)REAL(DT)*DELT,REAL(FFQTTYP(DT,1:NTYP)) !/(REAL(FFQTTYP(1,:))) !,(SUM(REAL(FFQT(DT,:))))/SUM(REAL(FFQT(1,:)))
		END DO
	END IF

END IF

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!COHERENT CASE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        IF (ICOH==1.or.ICOH==3)THEN               !COHRENT CASE
	PRINT*,'I AM IN COHERENT'
!        CFFQTTYP=0
	!$omp parallel do
        DO ITYPPP=1,NTYP
        !DO JTYPPP=ITYPPP,NTYP
        DO JTYPPP=1,NTYP
        DO I=SUM(NNTYPE(1:ITYPPP-1))+1,SUM(NNTYPE(1:ITYPPP)) !NATOM
        DO J=SUM(NNTYPE(1:JTYPPP-1))+1,SUM(NNTYPE(1:JTYPPP)) !NATOM
!        CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP)=CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP)+(FQT(1:NSTEP,I))*CONJG(FQT(1:NSTEP,J))
!CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP)=CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP) +  SUM(FQT(1:NSTEP, SUM(NNTYPE(1:ITYPPP-1))+1 : SUM(NNTYPE(1:ITYPPP))) * CONJG(FQT(1:NSTEP, SUM(NNTYPE(1:JTYPPP-1))+1 : SUM(NNTYPE(1:JTYPPP)))),DIM=2 )
CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP)=CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP) +   FQT(1:NSTEP,I) * CONJG(FQT(1:NSTEP, J) )
	END DO
        END DO
        END DO
        END DO
	!$omp end parallel do
	!SQW SQW SQW SQW SQW SQW SQW 
	DO DT=1,NSTEP
        WRITE(17,15) REAL(DT)*DELT, ( ( REAL(CFFQTTYP(DT,IJ1,IJ2)) , IJ2=IJ1,NTYP ),IJ1=1,NTYP) ! ,SUM(REAL(CFFQTTYP(DT,:,:)))/SUM(REAL(CFFQTTYP(1,:,:))) !NATOM
	END DO


	!IQT IQT IQT IQT IQT IQT IQT 
IF( IQTCAL==1)THEN
!	!$omp parallel do
	DO I=1,NTYP  !*(NTYP+1)/2
	 DO J=I,NTYP  !*(NTYP+1)/2
        	call dfftw_plan_dft_1d(plan(j),NSTEP,CFFQTTYP(:,I,J),CFFQTTYP(:,I,J),IBAC,FFTW_ESTIMATE)
	        call dfftw_execute_dft(plan(j), CFFQTTYP(:,I,J),CFFQTTYP(:,I,J))
	        call dfftw_destroy_plan(plan(j))
		CFFQTTYP(:,I,J)=CFFQTTYP(:,I,J)/REAL(NSTEPORIG) !CMPLX(AAA(I,1:2*NSTEP:2),AAA(I,2:2*NSTEP:2))
	 END DO
        END DO
!	!$omp end parallel do
	DO DT=1,NSTEP	
        WRITE(19,15) REAL(DT)*DELT, ( ( REAL(CFFQTTYP(DT,IJ1,IJ2)) , IJ1=1,NTYP ),IJ2=IJ1,NTYP) ! ,SUM(REAL(CFFQTTYP(DT,:,:)))/SUM(REAL(CFFQTTYP(1,:,:))) !NATOM
	END DO
END IF

END IF



END DO    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!QLOOP ENDS
REWIND(17)
REWIND(18)
REWIND(19)
REWIND(20)

IF(ICOH==0.OR.ICOH==3)THEN
!DO IQ=1,NQ
!DO DT=1,NSTEP
!READ(18,15)EE,DUMMY2(IQ,1:NTYP+1,DT) !,DUMMY1(IQ,DT) !,ITYP=1,NTYP)
!IF(IQTCAL==1)READ(20,15)EE,DUMMY4(IQ,1:NTYP+1,DT) !,DUMMY3(IQ,DT) !,ITYP=1,NTYP)
!END DO
!END DO
!WRITE(180,171)'#',(ATMNM(I),I=1,NTYP)
!IF(IQTCAL==1)WRITE(200,171)'#',(ATMNM(I),I=1,NTYP)
		DO DT=1,NSTEP
		OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
		!WRITE(180,15)OMEGA,( SUM(DUMMY2(1:NQ,ITYP,DT)) / NQ   ,ITYP=1,NTYP+1) !,SUM(DUMMY2(1:NQ,:,DT))/NQ
		WRITE(180,15)OMEGA,REAL(FFQTTYP(DT,1:NTYP)),REAL(SUM(FFQTTYP(DT,:))) !   ( SUM(DUMMY2(1:NQ,ITYP,DT)) / NQ   ,ITYP=1,NTYP+1) !,SUM(DUMMY2(1:NQ,:,DT))/NQ
!		IF(IQTCAL==1)WRITE(200,15)REAL(DT-1)*DELT,((SUM(DUMMY4(1:NQ,ITYP,DT))/NQ ),ITYP=1,NTYP+1) !,SUM(DUMMY4(1:NQ,:,DT))/NQ
		END DO
END IF

IF(ICOH==1.OR.ICOH==3)THEN



!	DO IQ=1,NQ
!	DO DT=1,NSTEP
!	READ(17,15)EE,DUMMY2(IQ,1:NTYP2+1,DT) !,DUMMY1(IQ,DT) !,ITYP=1,NTYP)
!	IF(IQTCAL==1)READ(19,15)EE,DUMMY4(IQ,1:NTYP2+1,DT) !,DUMMY3(IQ,DT) !,ITYP=1,NTYP)
!	END DO
!	END DO
!	WRITE(170,173)'#',(  (  ( ATMNM(I),ATMNM(J)) ,J=I,NTYP )  ,I=1,NTYP  )
!	WRITE(190,173)'#',(  (  ( ATMNM(I),ATMNM(J)) ,J=I,NTYP )  ,I=1,NTYP  )

!        KSELF(1)=1 
!        DO I=2,NTYP
!        KSELF(I)=KSELF(I-1)+NTYP-I+2
!        END DO

!        DO ITYP=1,NTYP2
!        IF(ANY(KSELF==ITYP)) THEN
!               DUMMYT(:)=DUMMYT+ SUM(DUMMY2(:,ITYP,:),DIM=1)
!        ELSE
!               DUMMYT(:)=DUMMYT+ 2*SUM(DUMMY2(:,ITYP,:),DIM=1)
!        
!        END IF
!        END DO
!        DUMMYT=DUMMYT/NQ
!
	DO DT=1,NSTEP
	OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
	!WRITE(170,15)OMEGA,  (  SUM(DUMMY2(1:NQ,ITYP,DT) )/SUM(DUMMY2(1:NQ,ITYP,1) ) ,ITYP=1,NTYP2) 
	!WRITE(190,15)REAL(DT-1)*DELT,(  SUM(DUMMY4(1:NQ,ITYP,DT)) / SUM(DUMMY4(1:NQ,ITYP,1)) , ITYP=1,NTYP2) 
	!WRITE(170,15)OMEGA,  (  SUM(DUMMY2(1:NQ,ITYP,DT) )/NQ,ITYP=1,NTYP2),DUMMYT(DT) 
	WRITE(170,15)OMEGA,( ( REAL(CFFQTTYP(DT,IJ1,IJ2)) , IJ2=IJ1,NTYP ),IJ1=1,NTYP) ,REAL(SUM(CFFQTTYP(DT,:,:))) !                  (  SUM(DUMMY2(1:NQ,ITYP,DT) )/NQ,ITYP=1,NTYP2),DUMMYT(DT) 
!	IF(IQTCAL==1)WRITE(190,15)REAL(DT-1)*DELT,(  SUM(DUMMY4(1:NQ,ITYP,DT) /NQ) , ITYP=1,NTYP2+1) 
	END DO


END IF
	17 FORMAT(A12,2X,3F10.5)
        15 FORMAT(F15.4,1003E20.4)
	170 FORMAT(A12,100(3X,3F6.2,3X))
	172 FORMAT(A12,<NQ>(3X,3F6.2,3X),6X,'AVG OVER Q')
	171 FORMAT(A3,12X,<NTYP>(8X,'avg',A3,10X) )
	173 FORMAT(A3,12X,<NTYP2>(8X,'avg',2A3,10X) )
CLOSE(170)
CLOSE(180)
CLOSE(190)
CLOSE(200)
CLOSE(17)
CLOSE(18)
CLOSE(19)
CLOSE(20)
CLOSE(44)
!DEALLOCATE(FQT,FFQTTYP,CFFQTTYP,DUMMY1,DUMMY2,DUMMY3,DUMMY4, AAA)
!DEALLOCATE(FQT,FFQT,AAA)
END SUBROUTINE

SUBROUTINE DIFFUSE
use omp_lib
USE VARIABLES1
COMPLEX,allocatable,dimension(:,:,:)::FHKL 
real::TWOPI,HKL(3)
twopi=2.0*atan(1.0)

PREF=1
NCUB=NCUB*PREF


open(104,FILE="DIFFSCAT.vasp")
allocate(fhkl(ncub,ncub,ncub))
DH=1/REAL(NCUB)  !0.1
DK=1/REAL(NCUB) !0.1
DL=1/REAL(NCUB) !0.1

WRITE(104,*)'COMMENT PROBABILITY DENSITY'
WRITE(104,*)'1.0'
WRITE(104,102)SLAT(1,:)
WRITE(104,102)SLAT(2,:)
WRITE(104,102)SLAT(3,:)
WRITE(104,103)ATMNM !SLAT(1,:)
WRITE(104,*)NNTYPE !ATMNM !SLAT(1,:)
WRITE(104,*)'D' !SLAT(1,:)
DO I=1,NATOM
!WRITE(104,102)MATMUL(ISLAT,POS(1,I,:)) !ATMNM !SLAT(1,:)
WRITE(104,102)MATMUL(POS(1,I,:),ISLAT) !ATMNM !SLAT(1,:)
END DO
WRITE(104,*) !SLAT(1,:)
WRITE(104,*)NCUB,NCUB,NCUB 


!$omp parallel do
DO I=1,NCUB
PRINT*,i
  DO J=1,NCUB
    DO K=1,NCUB
	!HKL=(/(i-1)*dh,(j-1)*dk,(k-1)*dl/)
	!HKL=(/(i)*dh,(j)*dk,(k)*dl/)
	HKL=(/real(i),real(j),real(k)/)
     fhkl(i,j,k)=  CMPLX( SUM(COS(TWOPI*(TPOS(:,:,:,:,1)*HKL(1) + TPOS(:,:,:,:,2)*HKL(2) + TPOS(:,:,:,:,3)*HKL(3)))), SUM(SIN(TWOPI*(TPOS(:,:,:,:,1)*HKL(1) + TPOS(:,:,:,:,2)*HKL(2) + TPOS(:,:,:,:,3)*HKL(3))))) 

     END DO
 END DO
END DO
!$omp end parallel do
WRITE(104,101)( ( ( abs(FHKL(I,J,K)) ,I=1,NCUB) ,J=1,NCUB),K=1,NCUB)
WRITE(105,101)( ( ( real(FHKL(I,J,K)) ,I=1,NCUB) ,J=1,NCUB),K=1,NCUB)
WRITE(106,101)( ( ( AIMAG(FHKL(I,J,K)) ,I=1,NCUB) ,J=1,NCUB),K=1,NCUB)
101 FORMAT(5(E12.5,1x))
102 FORMAT(3F20.15)
103 FORMAT(10A3)

END SUBROUTINE






SUBROUTINE ANGLECAL2
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,I2,J1,J2,K1,K2,ITH
INTEGER::II,JJ,KK
REAL::T2,T1
DOUBLE PRECISION,DIMENSION(3)::AA
REAL::RIJ,RJK
REAL,DIMENSION(3)::VEC11,VEC22
INTEGER::NC1,NC2
INTEGER::NCORD1,NCORD2,NK
REAL::ANGLEI
INTEGER::RBIN,TBIN
INTEGER,DIMENSION(NATOM,12,3)::PICK
INTEGER::ISPACE,L
REAL,ALLOCATABLE,DIMENSION(:,:,:)::ONEDT,ONEDR
REAL::TST
PRINT*, "I M IN ANGLE2"
PI=4*ATAN(1.0)
OPEN(154,FILE="PROBTHETA_R")
NK=0
NCORD1=4 !(4x3) 4 from bond length 1 and 3 from second
NCORD2=3
NPROBTHETAR=0
PICK=0
RC3=8
ISPACE=NNTYPE(INDEX1(1,1))
!ALLOCATE(NPROBTHETAR(NATOM,12,0:180,0:1000)) 
ALLOCATE(NPROBTHETAR(ISPACE,12,0:180,0:100)) 
ALLOCATE(ONEDT(ISPACE,12,0:180)) 
ALLOCATE(ONEDR(ISPACE,12,0:100)) 

!PRINT*,NNTYPE(INDEX1(1,1))
!PRINT*,RC1,RC2
!PRINT*,SUM( NNTYPE(1:INDEX1(1,1) -1 )) +1, SUM(NNTYPE(1:INDEX1(1,1)))
!PRINT*,SUM( NNTYPE(1:INDEX1(1,2) -1 )) +1, SUM(NNTYPE(1:INDEX1(1,2)))
!PRINT*,SUM( NNTYPE(1:INDEX1(1,3) -1 )) +1, SUM(NNTYPE(1:INDEX1(1,3)))
!!!!!!!!!!ATOM INDEXING!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
DO I=SUM( NNTYPE(1:INDEX1(1,1) -1 )) +1, SUM(NNTYPE(1:INDEX1(1,1)))
	NC1=0
	NK=0
	DO J=SUM(NNTYPE(1:INDEX1(1,2) -1)) +1, SUM(NNTYPE(1:INDEX1(1,2)))
		AA=POS(1 ,I,:)-POS(1 ,J,:)
		!AA=MATMUL(ISLATORIG,AA)
		AA=MATMUL(AA,ISLATORIG)
                WHERE(AA.LT.-0.5)AA=AA+1
                WHERE(AA.GT.0.5)AA=AA-1
		!RIJ=NORM2(MATMUL(SLATORIG,AA))
		RIJ=NORM2(MATMUL(AA,SLATORIG))
		IF(RIJ.LE.RC2.AND.RIJ.GE.RC1)THEN
                 NC1=NC1+1       !!!!!!!!CORDINATION1
 		 NC2=0
		 IF(NC1.GT.NCORD1)EXIT
         		DO K=SUM(NNTYPE(1:INDEX1(1,3) -1))+1, SUM(NNTYPE(1:INDEX1(1,3)))
	        	AA=POS(1 ,J,:)-POS(1 ,K,:)
		        !AA=MATMUL(ISLATORIG,AA)
		        AA=MATMUL(AA,ISLATORIG)
                        WHERE(AA.LT.-0.5)AA=AA+1
                        WHERE(AA.GE.0.5)AA=AA-1
		        RJK=NORM2(MATMUL(AA,SLATORIG))
		        IF(RJK.LE.RC2.AND.RJK.GE.RC1)THEN
			NC2=NC2+1 !!!!!!!!!!!!!!CORDINATION2
			!IF(NC2.GT.NCORD2)GO TO 1100
		        NK=NK+1
			!PRINT*,NC1,NC2,NK
		        PICK(I,NK,1)=I
		        PICK(I,NK,2)=J
		        PICK(I,NK,3)=K
!		        PRINT*,PICK(I,NK,:) !NK,NC2
		        END IF
		        END DO
		 END IF
1100            CONTINUE
	END DO
!PAUSE
END DO

PRINT*,NK

!DO IK=1,12
!PRINT*,PICK(1,IK,:)
!END DO
!PAUSE

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
DO IT=1,NSTEPORIG
	DO I=SUM(NNTYPE(1:INDEX1(1,1)-1))+1,SUM(NNTYPE(1:INDEX1(1,1)))
		DO IK=1,NK !-1 !#12   !!!!!!!!!!!!!!!!CORDINATION 4X3
                IF(ANY(PICK(I,IK,:)==0).NE..TRUE.)THEN
		AA=POS(IT,PICK(I,IK,1),:)-POS(IT,PICK(I,IK,2),:)
		!AA=MATMUL(ISLATORIG,AA)
		AA=MATMUL(AA,ISLATORIG)
                WHERE(AA.LT.-0.5)AA=AA+1
                WHERE(AA.GE.0.5)AA=AA-1
		!VEC11=MATMUL(SLATORIG,AA)
		VEC11=MATMUL(AA,SLATORIG)
		RIJ=NORM2(VEC11)

		
		AA=POS(IT,PICK(I,IK,2),:)-POS(IT,PICK(I,IK,3),:)
		!AA=MATMUL(ISLATORIG,AA)
		AA=MATMUL(AA,ISLATORIG)
                WHERE(AA.LT.-0.5)AA=AA+1
                WHERE(AA.GE.0.5)AA=AA-1
		!VEC22=MATMUL(SLATORIG,AA)
		VEC22=MATMUL(AA,SLATORIG)
		RJK=NORM2(VEC22)
                ANGLEI=DOT_PRODUCT(VEC11,VEC22)/(RIJ*RJK)
                ANGLEI=ACOS(ANGLEI)*180/PI
		!PRINT*,RJK,RIJ
		!PRINT*,ANGLEI
		!PAUSE
                   IF(RJK.LE.RC3)THEN
	           TBIN=INT(ANGLEI/REAL(DELTH))	
        	   RBIN=INT(RJK/0.1)
       !         PRINT*,TBIN,RBIN,IT
                   ISPACE=I-SUM(NNTYPE(1:INDEX1(1,1)-1))
        	   IF(TBIN.GE.0.0)ONEDT(ISPACE,IK,TBIN)=ONEDT(ISPACE,IK,TBIN)+1
        	   IF(RBIN.GE.0.0.AND.RBIN.LE.100)ONEDR(ISPACE,IK,RBIN)=ONEDR(ISPACE,IK,RBIN)+1
        	   IF(TBIN.GE.0.AND.RBIN.GE.0.AND.RBIN.LE.100)NPROBTHETAR(ISPACE,IK,TBIN,RBIN)=NPROBTHETAR(ISPACE,IK,TBIN,RBIN)+1
        	   IF(TBIN.GE.0.AND.RBIN.GE.0.AND.RBIN.LE.100)NPROBTHETAR(ISPACE,IK,TBIN,RBIN)=NPROBTHETAR(ISPACE,IK,TBIN,RBIN)+1
        	   END IF
                END IF
		END DO
	END DO
END DO

DO I=1,ISPACE
DO J=1,NK

IF(SUM(NPROBTHETAR(I,J,:,:)).GE.1) NPROBTHETAR(I,J,:,:)=NPROBTHETAR(I,J,:,:)/SUM(NPROBTHETAR(I,J,:,:))

IF(SUM(ONEDT(I,J,:)).GE.1)ONEDT(I,J,:)=ONEDT(I,J,:)/SUM(ONEDT(I,J,:))
IF(SUM(ONEDR(I,J,:)).GE.1)ONEDR(I,J,:)=ONEDR(I,J,:)/SUM(ONEDR(I,J,:))

NPROBTHETAR(I,J,:,:)=SQRT(NPROBTHETAR(I,J,:,:))  !/SUM(NPROBTHETAR(I,J,:,:))
ONEDT(I,J,:)=SQRT(ONEDT(I,J,:)) !/SUM(ONED(I,J,:)
ONEDR(I,J,:)=SQRT(ONEDR(I,J,:)) !/SUM(ONER(I,J,:)
DO K=1,180
DO L=1,100
TST= TST+(NPROBTHETAR(I,J,K,L)- ONEDT(I,J,K)*ONEDR(I,J,L))**2
END DO
END DO
END DO
END DO
PRINT*,'TST=',TST/(NK*ISPACE)





ISPACE=NNTYPE(INDEX1(1,1))
!PRINT*,ISPACE
DO J=1,NTHETA
!PRINT*,J
DO I=1,INT(RC3/0.1) !50 !RLOOP 
WRITE(154,155)J*DELTH,REAL(I*0.1) ,(  ( NPROBTHETAR(J1,IK,J,I),  IK=1,NK), J1=1,1 )
!WRITE(154,155)J*DELTH,REAL(I*0.1) ,  ( (  (NPROBTHETAR(J1,IK,J,I)/SUM(NPROBTHETAR(J1,IK,:,:))),  IK=1,NK), J1=1,NNTYPE(INDEX1(1,1)) )
!154 FORMAT(F10.5,2x,F12.5,2x,E14.5)
155 FORMAT(F10.5,2x,F12.5,2x,100(<NK>E14.5,3x))
END DO
END DO

END SUBROUTINE

















!!!!!!!!!!!!UPDATE POLY PROGRAM PREVISOUS VERSION HAD BUG
SUBROUTINE POLYN
use omp_lib
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(3)::DDD
DOUBLE PRECISION,DIMENSION(NNTYPE(CATOM),NCORD)::ANGLETHETA,ANGLEPHI,DDDD !!!!!!the last index 4 due to tetrahedral cordination
DOUBLE PRECISION,DIMENSION(NNTYPE(CATOM),NCORD)::REFTHETA,REFPHI !!!!!!the last index 4 due to tetrahedral cordination
DOUBLE PRECISION::RXY
INTEGER,DIMENSION(500,NCORD)::BDIST
DOUBLE PRECISION::RTOPI
INTEGER::JJJJ,JK,IR,JKK
DOUBLE PRECISION::D2,DR1,DR2
DOUBLE PRECISION::PROJ1,PROJ2,TWOPI
DOUBLE PRECISION,DIMENSION(3,3)::IAXIS
DOUBLE PRECISION::X,Y,Z,R
DOUBLE PRECISION,DIMENSION(3,3)::NEWLAT
INTEGER::MATOM,JCu,ICAP
INTEGER,DIMENSION(100)::INDEXI
INTEGER::MAXCAP,JTAG !,NCORD
DOUBLE PRECISION::AVGBOND
DOUBLE PRECISION,DIMENSION(NNTYPE(CATOM))::DISTORTION
REAL::RSEARCH
REAL,DIMENSION(3)::XYZ
REAL,DIMENSION(NNTYPE(CATOM),0:90,0:180)::PROBDENSITY
!REAL,DIMENSION(1,0:180,0:360)::PROBDENSITY
INTEGER::J1
INTEGER,DIMENSION(NATOM,12,3)::PICK
REAL::RIJ,RJK
INTEGER::NC1,NK
DOUBLE PRECISION,DIMENSION(3)::AA
OPEN(4100,FILE="ANGLETHETA.DAT")
OPEN(4101,FILE="ANGLEPHI.DAT")
OPEN(4102,FILE="BONDLENGTHS.DAT")
OPEN(4103,FILE="BONDLENGTHDISTRIBUTION.DAT")
OPEN(4105,FILE="MOVINGIONINDEX.DAT")
OPEN(4106,FILE="DISTORTION.DAT")
OPEN(5000,FILE="PROBDENSITY_THETA_PHI")
!PAUSE
PRINT*,'I M IN POLY'
PRINT*,CATOM,SATOM
PROBDENSITY=0
RSEARCH=8.0  
MATOM=1
PRINT*,'MOBILE ATOM IS 1 and RSEARCH iS ', RSEARCH
MAXCAP=32
RTOPI=180/(4*ATAN(1.0))  !3.14
PI=4*ATAN(1.0)
TWOPI=8*ATAN(1.0)
    AX3(1)=AX1(2)*AX2(3)-AX1(3)*AX2(2)
    AX3(2)=AX1(3)*AX2(1)-AX1(1)*AX2(3)
    AX3(3)=AX1(1)*AX2(2)-AX1(2)*AX2(1)
IAXIS(1,:)=AX1/NORM2(AX1)
IAXIS(2,:)=AX2/NORM2(AX2)
IAXIS(3,:)=AX3/NORM2(AX3)
NEWLAT=MATMUL(IAXIS,SLAT)
PRINT*,NEWLAT
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
DO I=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
	NC1=0
	NK=0
        DO J=SUM(NNTYPE(1:SATOM-1))+1,SUM(NNTYPE(1:SATOM))   !,NNTYPE(CATOM)
		AA=POS(1 ,I,:)-POS(1 ,J,:)
		!AA=MATMUL(ISLATORIG,AA)
		AA=MATMUL(AA,ISLATORIG)
                WHERE(AA.LT.-0.5)AA=AA+1
                WHERE(AA.GT.0.5)AA=AA-1
		!RIJ=NORM2(MATMUL(SLATORIG,AA))
		RIJ=NORM2(MATMUL(AA,SLATORIG))
		IF(RIJ.GT.0.AND.RIJ.LE.BOND)THEN
                 NC1=NC1+1       !!!!!!!!CORDINATION1
		 IF(NC1.GT.NCORD)EXIT
		        NK=NK+1
		        PICK(I,NK,1)=I
		        PICK(I,NK,2)=J
		END IF
	END DO
END DO

PRINT*,NK
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!                    IF(IT==1)THEN
!                    ICAP=0
!                    DO JCu=SUM(NNTYPE(1:MATOM-1))+1,SUM(NNTYPE(1:MATOM))    !MATOM MOBILE ATOM NEAR Polyhedral centre
!                    DDD=POS(IT,J,:)-POS(IT,JCu,:)
!                    DDD=MATMUL(ISLATORIG,DDD)                           !!!!!!!!FRACTIONAL POSITION 
!                     IF(DDD(1).LT. -0.5)DDD(1)=DDD(1)+1
!                     IF(DDD(2).LT. -0.5)DDD(2)=DDD(2)+1
!                     IF(DDD(3).LT. -0.5)DDD(3)=DDD(3)+1
!                     IF(DDD(1).gT.  0.5)DDD(1)=DDD(1)-1
!                     IF(DDD(2).gT.  0.5)DDD(2)=DDD(2)-1
!                     IF(DDD(3).gT.  0.5)DDD(3)=DDD(3)-1
!                    DDD=MATMUL(SLATORIG,DDD)                           !!!!!!!!FRACTIONAL POSITION 
!                    IF(NORM2(DDD).LT.RSEARCH)THEN
!                    ICAP=ICAP+1
!                    INDEXI(ICAP)=JCu
!!                    PRINT*,JCu,ICAP
!                    END IF
!                    END DO
!                    !PAUSE
!                    WRITE(2105,2105)INDEXI(1:MAXCAP)
!                    2105 FORMAT(100I10)
!                   END IF
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
DO IT=1,(IREF2-IREF1)+1,INTERVAL2
  JJJJ=0
  JTAG=0
  DO J=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
   JTAG=JTAG+1         !!!!!!!!!EQUIVALENT TO RUN OVER J
   JJJJ=JJJJ+1
   !SEARCH SURROUNDING ATOM FOR TETRAHEDRAL OR POLYHEDRAL 
   JK=0
   DO JK=1,NK  !SUM(NNTYPE(1:SATOM-1))+1,SUM(NNTYPE(1:SATOM))   !,NNTYPE(CATOM)
    DDD=(POS(IT,J,:)-POS(IT,PICK(J,JK,2),:))
    !DDD=MATMUL(ISLATORIG,DDD)                           !!!!!!!!FRACTIONAL POSITION 
    DDD=MATMUL(DDD,ISLATORIG)                           !!!!!!!!FRACTIONAL POSITION 
    WHERE(DDD.LT.-0.5)DDD=DDD+1.0
    WHERE(DDD.GT.0.5)DDD=DDD-1.0
    !XYZ=MATMUL(NEWLAT,DDD)
    XYZ=MATMUL(DDD,NEWLAT)
    X=XYZ(1)
    Y=XYZ(2)
    Z=XYZ(3)
    D2=NORM2(XYZ)
      DDDD(JTAG,JK)=D2  !NORM2(DDD)
      RXY=SQRT(Y*Y + Z*Z)
      ANGLETHETA(JJJJ,JK)=ACOS(X/D2)
      IF(RXY==0)THEN
      ANGLEPHI(JJJJ,JK)=0
      ELSE
      ANGLEPHI(JJJJ,JK)=ACOS(Y/rxy)
      IF(Y.GT.0.AND.Z.LT.0)ANGLEPHI(JJJJ,JK)=ANGLEPHI(JJJJ,JK)+ 3*TWOPI/4.0
      IF(Y.LT.0.AND.Z.LT.0)ANGLEPHI(JJJJ,JK)=ANGLEPHI(JJJJ,JK)+ TWOPI/4.0
      END IF
!    IF(IT.GT.1)THEN
     !IF(JTAG==1)PRINT*,(ANGLEPHI(JJJJ,JK)-REFPHI(JJJJ,JK))*RTOPI
!	IF(ANGLETHETA(JJJJ,JK)-REFTHETA(JJJJ,JK) .GT.PI/2) ANGLETHETA(JJJJ,JK)=ANGLETHETA(JJJJ,JK)-PI
!        IF(ANGLETHETA(JJJJ,JK)-REFTHETA(JJJJ,JK) .LT.-PI/2) ANGLETHETA(JJJJ,JK)=ANGLETHETA(JJJJ,JK)+PI
!        IF(ANGLEPHI(JJJJ,JK)-REFPHI(JJJJ,JK) .GT.PI) ANGLEPHI(JJJJ,JK)=ANGLEPHI(JJJJ,JK)-2*PI
!        IF(ANGLEPHI(JJJJ,JK)-REFPHI(JJJJ,JK) .LT.-PI) ANGLEPHI(JJJJ,JK)=ANGLEPHI(JJJJ,JK)+2*PI 
!    END IF	
!  REFTHETA(JJJJ,JK)=ANGLETHETA(JJJJ,JK)
!  REFPHI(JJJJ,JK)=ANGLEPHI(JJJJ,JK)
      !IF(JTAG==1)PRINT*,RTOPI*ANGLETHETA(JJJJ,JK),RTOPI*ANGLEPHI(JJJJ,JK)
      !IF(JTAG==1)PRINT*,X,Y,Z !RTOPI*ANGLETHETA(JJJJ,JK),RTOPI*ANGLEPHI(JJJJ,JK)
      !IF(JTAG==1)PAUSE !PRINT*,RTOPI*ANGLETHETA(JJJJ,JK),RTOPI*ANGLEPHI(JJJJ,JK)
      !IF(JK==1.AND. JTAG==1)THEN
      !PRINT*,IT,J,JK
      !PRINT*,D2,RXY,PICK(J,JK,2)
      !PRINT*,MATMUL(ISLAT,XYZ)
      !PRINT*,ANGLETHETA(JJJJ,JK) 
      !PAUSE!XYZ
      !END IF
	!!!!!!!!!	PROBABILITY DENSITY FUNCTION!!!!!!!!!!!!!!!!
	IF(ANGLETHETA(JJJJ,JK).GT.0.AND.ANGLEPHI(JJJJ,JK).GT.0)THEN
        PROBDENSITY(JTAG,INT(ANGLETHETA(JJJJ,JK)*RTOPI/2.0),INT(ANGLEPHI(JJJJ,JK)*RTOPI/2.0))=PROBDENSITY(JTAG,INT(ANGLETHETA(JJJJ,JK)*RTOPI/2.0),INT(ANGLEPHI(JJJJ,JK)*RTOPI/2.0)) +1 
	END IF
	!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
   END DO                !SURROUNDING SERACH ENDS
    AVGBOND=SUM(DDDD(JJJJ,:))/NCORD !JK   
    DISTORTION(JTAG)=SQRT(DOT_PRODUCT(DDDD(JTAG,:),DDDD(JTAG,:)) -NCORD*AVGBOND*AVGBOND)
    DISTORTION(JTAG)=DISTORTION(JTAG)/(NCORD*AVGBOND*AVGBOND)
!!!!!!!!!!BOND DISTRIBUTION!!!!!!!!!!!!!   
    DO IR=1,500
    DR1=DR0+(IR-1)*RSTEP
    DR2=DR0+IR*RSTEP
     DO JKK=1,NCORD  !JK
     IF(DDDD(JJJJ,JKK).GT.DR1 .AND. DDDD(JJJJ,JKK).LE.DR2)BDIST(IR,JKK)=BDIST(IR,JKK)+1
     END DO
   END DO  !!END BOND DISTRI
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  END DO !CENTRE ATOM ENDS HERE
  WRITE(4106,2103)DELT*REAL(IT),DISTORTION(:)                                  
  WRITE(4100,2100)DELT*REAL(IT),(ANGLETHETA(JJJJ,1:NCORD)*RTOPI,JJJJ=1,NNTYPE(CATOM))
  2100 FORMAT(F10.4,1000F7.1)
  WRITE(4101,2100)DELT*REAL(IT),(ANGLEPHI(JJJJ,1:NCORD)*RTOPI,JJJJ=1,NNTYPE(CATOM))
  WRITE(4102,2102)DELT*REAL(IT),(DDDD(JJJJ,1:NCORD),JJJJ=1,NNTYPE(CATOM))
END DO     !!!!!!!!!!!!!!!!TIME ENDS HERE



DO IR=1,500
DR1=DR0+(IR-1)*RSTEP
WRITE(4103,2101)DR1,BDIST(IR,1:NCORD)
END DO
2101 FORMAT(F9.4,10I12)
2102 FORMAT(F9.4,1000F10.3)
2103 FORMAT(F9.4,1000F10.4)



DO J=0,180
DO I=0,90
WRITE(5000,2104) 2*REAL(J),2*REAL(I), (  (PROBDENSITY(J1,I,J)/SUM(PROBDENSITY(J1,:,:))), J1=1,NNTYPE(CATOM) )  !X axis is phi and Y axis is theta
2104 FORMAT(1003E16.5) 
END DO
END DO






END SUBROUTINE


SUBROUTINE INERTIA
use omp_lib
USE VARIABLES1
IMPLICIT NONE
REAL,DIMENSION(NATOM,3,3)::MOMI
REAL,DIMENSION(NATOM,3)::TORQ
INTEGER::JTAG,JK
REAL,DIMENSION(3)::ROT
DOUBLE PRECISION,DIMENSION(3)::DDD
REAL::X,Y,Z,D2
!INTEGER::NCORD

OPEN(101,FILE='TORQ')
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
TORQ=0
MOMI=0
!NCORD=4
DO IT=1,(IREF2-IREF1)+1
  JTAG=0
  MOMI=0
  TORQ=0
  DO J=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
  JTAG=JTAG+1
   !SEARCH SURROUNDING ATOM FOR TETRAHEDRAL OR POLYHEDRAL 
    JK=0
    DO K=SUM(NNTYPE(1:SATOM-1))+1,SUM(NNTYPE(1:SATOM))   !,NNTYPE(CATOM)
    !PRINT*,J,K
    DDD=(POS(IT,J,:)-POS(IT,K,:))
    !DDD=MATMUL(ISLATORIG,DDD)                           !!!!!!!!FRACTIONAL POSITION 
    DDD=MATMUL(DDD,ISLATORIG)                           !!!!!!!!FRACTIONAL POSITION 
    IF(DDD(1).LT. -0.5)DDD(1)=DDD(1)+1
    IF(DDD(2).LT. -0.5)DDD(2)=DDD(2)+1
    IF(DDD(3).LT. -0.5)DDD(3)=DDD(3)+1
    IF(DDD(1).gT.  0.5)DDD(1)=DDD(1)-1
    IF(DDD(2).gT.  0.5)DDD(2)=DDD(2)-1
    IF(DDD(3).gT.  0.5)DDD(3)=DDD(3)-1
    !DDD=MATMUL(SLATORIG,DDD)
    DDD=MATMUL(DDD,SLATORIG)
    X=DDD(1)
    Y=DDD(2)
    Z=DDD(3)
    D2= SQRT(X*X + Y*Y + Z*Z)
    IF(D2.GT.0.AND.D2.LE.BOND)THEN
    JK=JK+1
    IF(JK.GT.NCORD)EXIT
!    DDDD(JTAG,JK)=D2  !NORM2(DDD)
    !MOMI(J,1,1)= MOMI(J,1,1)+(Y*Y + Z*Z )*MASS(K)
    !MOMI(J,2,2)= MOMI(J,2,2)+(Z*Z + X*X )*MASS(K)
    !MOMI(J,3,3)= MOMI(J,3,3)+(X*X + Y*Y )*MASS(K)
    !MOMI(J,1,2)= MOMI(J,1,2)-(X*Y      )*MASS(K)
    !MOMI(J,1,3)= MOMI(J,1,3)-(X*Z      )*MASS(K)
    !MOMI(J,2,3)= MOMI(J,2,3)-(Y*Z      )*MASS(K)
    !MOMI(J,2,1)= MOMI(J,2,1)-(X*Y      )*MASS(K)
    !MOMI(J,3,1)= MOMI(J,3,1)-(X*Z      )*MASS(K)
    !MOMI(J,3,2)= MOMI(J,3,2)-(Y*Z      )*MASS(K)

    MOMI(JTAG,1,1)= (Y*Y + Z*Z )*MASS(K)
    MOMI(JTAG,2,2)= (Z*Z + X*X )*MASS(K)
    MOMI(JTAG,3,3)= (X*X + Y*Y )*MASS(K)
    MOMI(JTAG,1,2)= -(X*Y      )*MASS(K)
    MOMI(JTAG,1,3)= -(X*Z      )*MASS(K)
    MOMI(JTAG,2,3)= -(Y*Z      )*MASS(K)
    MOMI(JTAG,2,1)= -(X*Y      )*MASS(K)
    MOMI(JTAG,3,1)= -(X*Z      )*MASS(K)
    MOMI(JTAG,3,2)= -(Y*Z      )*MASS(K)
    ROT=VEL(IT,K,:)/D2
    TORQ(JTAG,:)=TORQ(JTAG,:)+MATMUL(MOMI(JTAG,:,:),ROT)
    END IF
    END DO
   END DO
!WRITE(101,101)IT,((TORQ(J,:)),J=1,NNTYPE(CATOM))
WRITE(101,101)IT,(NORM2(TORQ(J,:)),J=1,NNTYPE(CATOM))
101 FORMAT(I10,1000E15.5)
END DO
END SUBROUTINE

SUBROUTINE DATABASE(SNAME)
USE VARIABLES1
IMPLICIT NONE
CHARACTER*5::SNAME
CHARACTER*5,DIMENSION(371)::ELEMENT
DOUBLE PRECISION,DIMENSION(9,371)::NEUTRON_ATTRIBUTE 
INTEGER::IL

Element=(/'H    ', &
'1H   ', &
'2H   ', &
'3H   ', &
'He   ', &
'3He  ', &
'4He  ', &
'Li   ', &
'6Li  ', &
'7Li  ', &
'Be   ', &
'B    ', &
'10B  ', &
'11B  ', &
'C    ', &
'12C  ', &
'13C  ', &
'N    ', &
'14N  ', &
'15N  ', &
'O    ', &
'16O  ', &
'17O  ', &
'18O  ', &
'F    ', &
'Ne   ', &
'20Ne ', &
'21Ne ', &
'22Ne ', &
'Na   ', &
'Mg   ', &
'24Mg ', &
'25Mg ', &
'26Mg ', &
'Al   ', &
'Si   ', &
'28Si ', &
'29Si ', &
'30Si ', &
'P    ', &
'S    ', &
'32S  ', &
'33S  ', &
'34S  ', &
'36S  ', &
'Cl   ', &
'35Cl ', &
'37Cl ', &
'Ar   ', &
'36Ar ', &
'38Ar ', &
'40Ar ', &
'K    ', &
'39K  ', &
'40K  ', &
'41K  ', &
'Ca   ', &
'40Ca ', &
'42Ca ', &
'43Ca ', &
'44Ca ', &
'46Ca ', &
'48Ca ', &
'Sc   ', &
'Ti   ', &
'46Ti ', &
'47Ti ', &
'48Ti ', &
'49Ti ', &
'50Ti ', &
'V    ', &
'50V  ', &
'51V  ', &
'Cr   ', &
'50Cr ', &
'52Cr ', &
'53Cr ', &
'54Cr ', &
'Mn   ', &
'Fe   ', &
'54Fe ', &
'56Fe ', &
'57Fe ', &
'58Fe ', &
'Co   ', &
'Ni   ', &
'58Ni ', &
'60Ni ', &
'61Ni ', &
'62Ni ', &
'64Ni ', &
'Cu   ', &
'63Cu ', &
'65Cu ', &
'Zn   ', &
'64Zn ', &
'66Zn ', &
'67Zn ', &
'68Zn ', &
'70Zn ', &
'Ga   ', &
'69Ga ', &
'71Ga ', &
'Ge   ', &
'70Ge ', &
'72Ge ', &
'73Ge ', &
'74Ge ', &
'76Ge ', &
'As   ', &
'Se   ', &
'74Se ', &
'76Se ', &
'77Se ', &
'78Se ', &
'80Se ', &
'82Se ', &
'Br   ', &
'79Br ', &
'81Br ', &
'Kr   ', &
'78Kr ', &
'80Kr ', &
'82Kr ', &
'83Kr ', &
'84Kr ', &
'86Kr ', &
'Rb   ', &
'85Rb ', &
'87Rb ', &
'Sr   ', &
'84Sr ', &
'86Sr ', &
'87Sr ', &
'88Sr ', &
'Y    ', &
'Zr   ', &
'90Zr ', &
'91Zr ', &
'92Zr ', &
'94Zr ', &
'96Zr ', &
'Nb   ', &
'Mo   ', &
'92Mo ', &
'94Mo ', &
'95Mo ', &
'96Mo ', &
'97Mo ', &
'98Mo ', &
'100Mo', &
'Tc   ', &
'Ru   ', &
'96Ru ', &
'98Ru ', &
'99Ru ', &
'100Ru', &
'101Ru', &
'102Ru', &
'104Ru', &
'Rh   ', &
'Pd   ', &
'102Pd', &
'104Pd', &
'105Pd', &
'106Pd', &
'108Pd', &
'110Pd', &
'Ag   ', &
'107Ag', &
'109Ag', &
'Cd   ', &
'106Cd', &
'108Cd', &
'110Cd', &
'111Cd', &
'112Cd', &
'113Cd', &
'114Cd', &
'116Cd', &
'In   ', &
'113In', &
'115In', &
'Sn   ', &
'112Sn', &
'114Sn', &
'115Sn', &
'116Sn', &
'117Sn', &
'118Sn', &
'119Sn', &
'120Sn', &
'122Sn', &
'124Sn', &
'Sb   ', &
'121Sb', &
'123Sb', &
'Te   ', &
'120Te', &
'122Te', &
'123Te', &
'124Te', &
'125Te', &
'126Te', &
'128Te', &
'130Te', &
'I    ', &
'Xe   ', &
'124Xe', &
'126Xe', &
'128Xe', &
'129Xe', &
'130Xe', &
'131Xe', &
'132Xe', &
'134Xe', &
'136Xe', &
'Cs   ', &
'Ba   ', &
'130Ba', &
'132Ba', &
'134Ba', &
'135Ba', &
'136Ba', &
'137Ba', &
'138Ba', &
'La   ', &
'138La', &
'139La', &
'Ce   ', &
'136Ce', &
'138Ce', &
'140Ce', &
'142Ce', &
'Pr   ', &
'Nd   ', &
'142Nd', &
'143Nd', &
'144Nd', &
'145Nd', &
'146Nd', &
'148Nd', &
'150Nd', &
'Pm   ', &
'Sm   ', &
'144Sm', &
'147Sm', &
'148Sm', &
'149Sm', &
'150Sm', &
'152Sm', &
'154Sm', &
'Eu   ', &
'151Eu', &
'153Eu', &
'Gd   ', &
'152Gd', &
'154Gd', &
'155Gd', &
'156Gd', &
'157Gd', &
'158Gd', &
'160Gd', &
'Tb   ', &
'Dy   ', &
'156Dy', &
'158Dy', &
'160Dy', &
'161Dy', &
'162Dy', &
'163Dy', &
'164Dy', &
'Ho   ', &
'Er   ', &
'162Er', &
'164Er', &
'166Er', &
'167Er', &
'168Er', &
'170Er', &
'Tm   ', &
'Yb   ', &
'168Yb', &
'170Yb', &
'171Yb', &
'172Yb', &
'173Yb', &
'174Yb', &
'176Yb', &
'Lu   ', &
'175Lu', &
'176Lu', &
'Hf   ', &
'174Hf', &
'176Hf', &
'177Hf', &
'178Hf', &
'179Hf', &
'180Hf', &
'Ta   ', &
'180Ta', &
'181Ta', &
'W    ', &
'180W ', &
'182W ', &
'183W ', &
'184W ', &
'186W ', &
'Re   ', &
'185Re', &
'187Re', &
'Os   ', &
'184Os', &
'186Os', &
'187Os', &
'188Os', &
'189Os', &
'190Os', &
'192Os', &
'Ir   ', &
'191Ir', &
'193Ir', &
'Pt   ', &
'190Pt', &
'192Pt', &
'194Pt', &
'195Pt', &
'196Pt', &
'198Pt', &
'Au   ', &
'Hg   ', &
'196Hg', &
'198Hg', &
'199Hg', &
'200Hg', &
'201Hg', &
'202Hg', &
'204Hg', &
'Tl   ', &
'203Tl', &
'205Tl', &
'Pb   ', &
'204Pb', &
'206Pb', &
'207Pb', &
'208Pb', &
'Bi   ', &
'Po   ', &
'At   ', &
'Rn   ', &
'Fr   ', &
'Ra   ', &
'Ac   ', &
'Th   ', &
'Pa   ', &
'U    ', &
'233U ', &
'234U ', &
'235U ', &
'238U ', &
'Np   ', &
'Pu   ', &
'238Pu', &
'239Pu', &
'240Pu', &
'242Pu', &
'Am   ', &
'Cm   ', &
'244Cm', &
'246Cm', &
'248Cm'/)
! Mass, Conc,Coh b,Inc b,Coh xs,Inc xs,	Scatt xs,Abs xs,Z 

NEUTRON_ATTRIBUTE=RESHAPE((/ & 1.007,0.000,-3.739,0.000,1.757,80.260,82.020,0.333,1.0                   & 
,1.007,99.985,-3.741,25.274,1.758,80.270,82.030,0.333,1.0                                             &
,2.014,0.015,6.671,4.040,5.592,2.050,7.640,0.001     ,1.0                                             &
,3.016,12.320,4.792,-1.040,2.890,0.140,3.030,0.000   ,1.0                                            &
,4.002,0.000,3.260,0.000,1.340,0.000,1.340,0.007     ,2.0                                            &
,3.016,0.000,5.74,2.5,4.420,1.600,6.000,5333.000     ,2.0                                            &
,4.002,100.000,3.260,0.000,1.340,0.000,1.340,0.000   ,2.0                                           &
,6.997,0.000,-1.900,0.000,0.454,0.920,1.370,70.500   ,3.0                                            &
,6.015,7.500,2.00,-1.89,0.510,0.460,0.970,940.000    ,3.0                                           &
,7.016,92.500,-2.220,-2.490,0.619,0.780,1.400,0.045  ,3.0                                          &
,9.012,100.000,7.790,0.120,7.630,0.002,7.630,0.008   ,4.0                                           &
,10.821,0.000,5.30,0.000,3.540,1.700,5.240,767.000   ,5.0                                           &
,10.012,20.000,-0.1,-4.7,0.144,3.000,3.100,3835.000  ,5.0                                           &
,11.009,80.000,6.650,-1.300,5.560,0.210,5.770,0.006  ,5.0                                           &
,12.012,0.000,6.646,0.000,5.551,0.001,5.551,0.004    ,6.0                                           &
,12.000,98.900,6.651,0.000,5.559,0.000,5.559,0.004   ,6.0                                           &
,13.003,1.100,6.190,-0.520,4.810,0.034,4.840,0.001   ,6.0                                           &
,14.007,0.000,9.360,0.000,11.010,0.500,11.510,1.900  ,7.0                                           &
,14.003,99.630,9.370,2.000,11.030,0.500,11.530,1.910 ,7.0                                          &
,15.000,0.370,6.440,-0.020,5.210,0.000,5.210,0.000   ,7.0                                          &
,15.999,0.000,5.803,0.000,4.232,0.001,4.232,0.000    ,8.0                                           &
,15.994,99.762,5.803,0.000,4.232,0.000,4.232,0.000   ,8.0                                           &
,16.999,0.038,5.780,0.180,4.200,0.004,4.200,0.236    ,8.0                                           &
,17.999,0.200,5.840,0.000,4.290,0.000,4.290,0.000    ,8.0                                           &
,18.998,100.000,5.654,-0.082,4.017,0.001,4.018,0.010 ,9.0                                          &
,20.180,0.000,4.566,0.000,2.620,0.008,2.628,0.039    ,10.0                                          &
,19.992,90.510,4.631,0.000,2.695,0.000,2.695,0.036   ,10.0                                          &
,20.993,0.270,6.660,0.600,5.600,0.050,5.700,0.670    ,10.0                                          &
,21.991,9.220,3.870,0.000,1.880,0.000,1.880,0.046    ,10.0                                          &
,22.989,100.000,3.630,3.590,1.660,1.620,3.280,0.530  ,11.0                                          &
,24.307,0.000,5.375,0.000,3.631,0.080,3.710,0.063    ,12.0                                          &
,23.985,78.990,5.660,0.000,4.030,0.000,4.030,0.050   ,12.0                                          &
,24.985,10.000,3.620,1.480,1.650,0.280,1.930,0.190   ,12.0                                          &
,25.982,11.010,4.890,0.000,3.000,0.000,3.000,0.038   ,12.0                                          &
,26.981,100.000,3.449,0.256,1.495,0.008,1.503,0.231  ,13.0                                          &
,28.086,0.000,4.149,0.000,2.163,0.004,2.167,0.171    ,14.0                                           &
,27.976,92.230,4.107,0.000,2.120,0.000,2.120,0.177   ,14.0                                           &
,28.976,4.670,4.700,0.090,2.780,0.001,2.780,0.101    ,14.0                                           &
,29.973,3.100,4.580,0.000,2.640,0.000,2.640,0.107    ,14.0                                           &
,30.973,100.000,5.130,0.200,3.307,0.005,3.312,0.172  ,15.0                                           &
,32.076,0.000,2.847,0.000,1.019,0.007,1.026,0.530    ,16.0                                           &
,31.972,95.020,2.804,0.000,0.988,0.000,0.988,0.540   ,16.0                                           &
,32.971,0.750,4.740,1.500,2.800,0.300,3.100,0.540    ,16.0                                          &
,33.967,4.210,3.480,0.000,1.520,0.000,1.520,0.227    ,16.00                                          &
,35.967,0.020,3.000,0.000,1.100,0.000,1.100,0.150    ,16.0                                           &
,35.446,0.000,9.577,0.000,11.526,5.300,16.800,33.500 ,17.0                                          &
,34.968,75.770,11.650,6.100,17.060,4.700,21.800,44.100 ,17.0                                        &
,36.965,24.230,3.080,0.100,1.190,0.001,1.190,0.433    ,17.0                                        &
,39.948,0.000,1.909,0.000,0.458,0.225,0.683,0.675     ,18.0                                         &
,35.967,0.337,24.900,0.000,77.900,0.000,77.900,5.200  ,18.0                                         &
,37.962,0.063,3.500,0.000,1.500,0.000,1.500,0.800     ,18.0                                       &
,39.962,99.600,1.830,0.000,0.421,0.000,0.421,0.660    ,18.0                                        &
,39.098,0.000,3.670,0.000,1.690,0.270,1.960,2.100     ,19.0                                         &
,38.963,93.258,3.740,1.400,1.760,0.250,2.010,2.100    ,19.0                                        &
,39.963,0.012,3.000,0.000,1.100,0.500,1.600,35.000    ,19.0                                       &
,40.961,6.730,2.690,1.500,0.910,0.300,1.200,1.460     ,19.0                                         &
,40.078,0.000,4.700,0.000,2.780,0.050,2.830,0.430     ,20.0                                         &
,39.962,96.941,4.800,0.000,2.900,0.000,2.900,0.410    ,20.0                                         &
,41.958,0.647,3.360,0.000,1.420,0.000,1.420,0.680     ,20.0                                         &
,42.958,0.135,-1.560,0.000,0.310,0.500,0.800,6.200    ,20.0                                         &
,43.955,2.086,1.420,0.000,0.250,0.000,0.250,0.880     ,20.0                                         &
,45.953,0.004,3.600,0.000,1.600,0.000,1.600,0.740     ,20.0                                         &
,47.952,0.187,0.390,0.000,0.019,0.000,0.019,1.090      ,20.0                                        &
,44.955,100.000,12.290,-6.000,19.000,4.500,23.500,27.500  ,21.0                                      &
,47.867,0.000,-3.438,0.000,1.485,2.870,4.350,6.090     ,22.0                                    &
,45.952,8.200,4.930,0.000,3.050,0.000,3.050,0.590      ,22.0                                     &
,46.951,7.400,3.630,-3.500,1.660,1.500,3.200,1.700     ,22.0                                     &
,47.947,73.800,-6.080,0.000,4.650,0.000,4.650,7.840    ,22.0                                     &
,48.947,5.400,1.040,5.100,0.140,3.300,3.400,2.200      ,22.0                                     &
,49.944,5.200,6.180,0.000,4.800,0.000,4.800,0.179      ,22.0                                     &
,50.942,0.000,-0.382,0.000,0.018,5.080,5.100,5.080     ,23.0                                     &
,49.947,0.250,7.600,0.000,7.300,0.500,7.800,60.000     ,23.0                                    &
,50.943,99.750,-0.402,6.350,0.020,5.070,5.090,4.900    ,23.0                                      &
,51.996,0.000,3.635,0.000,1.660,1.830,3.490,3.050      ,24.0                                      &
,49.946,4.350,-4.500,0.000,2.540,0.000,2.540,15.800    ,24.0                                      &
,51.940,83.790,4.920,0.000,3.042,0.000,3.042,0.760     ,24.0                                      &
,52.940,9.500,-4.200,6.870,2.220,5.930,8.150,18.100    ,24.0                                      &
,53.938,2.360,4.550,0.000,2.600,0.000,2.600,0.360         ,24.0                                      &
,54.938,100.000,-3.730,1.790,1.750,0.400,2.150,13.300     ,25.00                                     &
,55.845,0.000,9.450,0.000,11.220,0.400,11.620,2.560       ,26.0                                      &
,53.939,5.800,4.200,0.000,2.200,0.000,2.200,2.250         ,26.0                                      &
,55.934,91.700,9.940,0.000,12.420,0.000,12.420,2.590      ,26.0                                      &
,56.935,2.200,2.300,0.000,0.660,0.300,1.000,2.480         ,26.0                                      &
,57.933,0.300,15.000,0.000,28.000,0.000,28.000,1.280      ,26.0                                      &
,58.933,100.000,2.490,-6.200,0.779,4.800,5.600,37.180     ,27.0                                      &
,58.693,0.000,10.300,0.000,13.300,5.200,18.500,4.490      ,28.0                                      &
,57.935,68.270,14.400,0.000,26.100,0.000,26.100,4.600     ,28.0                                      &
,59.930,26.100,2.800,0.000,0.990,0.000,0.990,2.900       ,28.0                                       &
,60.931,1.130,7.600,3.900,7.260,1.900,9.200,2.500        ,28.0                                       &
,61.928,3.590,-8.700,0.000,9.500,0.000,9.500,14.500      ,28.0                                       &
,63.927,0.910,-0.370,0.000,0.017,0.000,0.017,1.520       ,28.0                                       &
,63.546,0.000,7.718,0.000,7.485,0.550,8.030,3.780        ,29.0                                       &
,62.929,69.170,6.430,0.220,5.200,0.006,5.200,4.500       ,29.0                                       &
,64.927,30.830,10.610,1.790,14.100,0.400,14.500,2.170    ,29.0                                       &
,65.380,0.000,5.680,0.000,4.054,0.077,4.131,1.110        ,30.0                                       &
,63.929,48.600,5.220,0.000,3.420,0.000,3.420,0.930       ,30.0                                       &
,65.926,27.900,5.970,0.000,4.480,0.000,4.480,0.620       ,30.0                                       &
,66.927,4.100,7.560,-1.500,7.180,0.280,7.460,6.800       ,30.0                                    &
,67.924,18.800,6.030,0.000,4.570,0.000,4.570,1.100       ,30.0                                    &
,69.925,0.600,6.000,0.000,4.500,0.000,4.500,0.092        ,30.0                                    &
,69.723,0.000,7.288,0.000,6.675,0.160,6.830,2.750        ,31.0                                    &
,68.925,60.100,7.880,-0.850,7.800,0.091,7.890,2.180      ,31.0                                    &
,70.924,39.900,6.400,-0.820,5.150,0.084,5.230,3.610     ,31.0                                     &
,72.630,0.000,8.185,0.000,8.420,0.180,8.600,2.200       ,32.0                                     &
,69.924,20.500,10.000,0.000,12.600,0.000,12.600,3.000   ,32.0                                     &
,71.922,27.400,8.510,0.000,9.100,0.000,9.100,0.800       ,32.0                                    &
,72.923,7.800,5.020,3.400,3.170,1.500,4.700,15.100       ,32.0                                    &
,73.921,36.500,7.580,0.000,7.200,0.000,7.200,0.400       ,32.0                                    &
,75.921,7.800,8.200,0.000,8.000,0.000,8.000,0.160        ,32.0                                    &
,74.921,100.000,6.580,-0.690,5.440,0.060,5.500,4.500     ,33.0                                    &
,78.972,0.000,7.970,0.000,7.980,0.320,8.300,11.700       ,34.0                                    &
,73.922,0.900,0.800,0.000,0.100,0.000,0.100,51.800       ,34.0                                    &
,75.919,9.000,12.200,0.000,18.700,0.000,18.700,85.000    ,34.0                                    &
,76.919,7.600,8.250,0.600,8.600,0.050,8.650,42.000       ,34.0                                    &
,77.917,23.500,8.240,0.000,8.500,0.000,8.500,0.430       ,34.0                                    &
,79.916,49.600,7.480,0.000,7.030,0.000,7.030,0.610       ,34.0                                    &
,81.916,9.400,6.340,0.000,5.050,0.000,5.050,0.044        ,34.0                                    &
,79.907,0.000,6.795,0.000,5.800,0.100,5.900,6.900        ,35.0                                    &
,78.918,50.690,6.800,-1.100,5.810,0.150,5.960,11.000     ,35.0                                    &
,80.916,49.310,6.790,0.600,5.790,0.050,5.840,2.700       ,35.0                                    &
,83.789,0.000,7.810,0.000,7.670,0.010,7.680,25.000       ,36.0                                    &
,77.920,0.350,0.000,0.000,0.000,0.000,0.000,6.400        ,36.0                                    &
,79.916,2.250,0.000,0.000,0.000,0.000,0.000,11.800       ,36.0                                    &
,81.913,11.600,0.000,0.000,0.000,0.000,0.000,29.000     ,36.0                                     &
,82.914,11.500,0.000,0.000,0.000,0.000,0.000,185.000    ,36.0                                     &
,83.911,57.000,0.000,0.000,0.000,0.000,6.600,0.113      ,36.0                                     &
,85.910,17.300,8.100,0.000,8.200,0.000,8.200,0.003      ,36.0                                     &
,85.467,0.000,7.090,0.000,6.320,0.500,6.800,0.380       ,37.0                                     &
,84.911,72.170,7.030,0.000,6.200,0.500,6.700,0.480      ,37.0                                     &
,86.909,27.830,7.230,0.000,6.600,0.500,7.100,0.120      ,37.0                                     &
,87.620,0.000,7.020,0.000,6.190,0.060,6.250,1.280       ,38.0                                     &
,83.913,0.560,7.000,0.000,6.000,0.000,6.000,0.870      ,38.0                                      &
,85.909,9.860,5.670,0.000,4.040,0.000,4.040,1.040      ,38.0                                      &
,86.908,7.000,7.400,0.000,6.880,0.500,7.400,16.000     ,38.0                                      &
,87.905,82.580,7.150,0.000,6.420,0.000,6.420,0.058     ,38.0                                      &
,88.905,100.000,7.750,1.100,7.550,0.150,7.700,1.280    ,39.0                                      &
,91.224,0.000,7.160,0.000,6.440,0.020,6.460,0.185      ,40.0                                      &
,89.904,51.450,6.400,0.000,5.100,0.000,5.100,0.011     ,40.0                                      &
,90.905,11.320,8.700,-1.080,9.500,0.150,9.700,1.170    ,40.0                                     &
,91.905,17.190,7.400,0.000,6.900,0.000,6.900,0.220     ,40.0                                      &
,93.906,17.280,8.200,0.000,8.400,0.000,8.400,0.050     ,40.0                                      &
,95.908,2.760,5.500,0.000,3.800,0.000,3.800,0.023      ,40.0                                      &
,92.906,100.000,7.054,-0.139,6.253,0.002,6.255,1.150   ,41.0                                      &
,95.950,0.000,6.715,0.000,5.670,0.040,5.710,2.480      ,42.0                                      &
,91.906,14.840,6.910,0.000,6.000,0.000,6.000,0.019     ,42.0                                      &
,93.905,9.250,6.800,0.000,5.810,0.000,5.810,0.015      ,42.0                                      &
,94.905,15.920,6.910,0.000,6.000,0.500,6.500,13.100    ,42.0                                      &
,95.904,16.680,6.200,0.000,4.830,0.000,4.830,0.500     ,42.0                                      &
,96.906,9.550,7.240,0.000,6.590,0.500,7.100,2.500       ,42.0                                     &
,97.905,24.130,6.580,0.000,5.440,0.000,5.440,0.127     ,42.0                                      &
,99.907,9.630,6.730,0.000,5.690,0.000,5.690,0.400      ,42.0                                      &
,98.000,0.000,6.800,0.000,5.800,0.500,6.300,20.000     ,43.0                                      &
,101.070,0.000,7.030,0.000,6.210,0.400,6.600,2.560     ,44.0                                      &
,95.907,5.500,0.000,0.000,0.000,0.000,0.000,0.280      ,44.0                                      &
,97.905,1.900,0.000,0.000,0.000,0.000,0.000,8.000      ,44.0                                    &
,98.905,12.700,0.000,0.000,0.000,0.000,0.000,6.900     ,44.0                                  &
,99.904,12.600,0.000,0.000,0.000,0.000,0.000,4.800     ,44.0                                &
,100.905,17.000,0.000,0.000,0.000,0.000,0.000,3.300    ,44.0                                &
,101.904,31.600,0.000,0.000,0.000,0.000,144.800,1.170  ,44.0                              &
,103.905,18.700,0.000,0.000,0.000,0.000,4.483,0.310    ,44.0                            &
,102.905,100.000,5.880,0.000,4.340,0.300,4.600,144.800 ,45.0                                     &
,106.420,0.000,5.910,0.000,4.390,0.093,4.480,6.900     ,46.0                                     &
,101.905,1.020,7.700,0.000,7.500,0.000,7.500,3.400     ,46.0                                     &
,103.904,11.140,7.700,0.000,7.500,0.000,7.500,0.600    ,46.0                                   &
,104.905,22.330,5.500,-2.600,3.800,0.800,4.600,20.000  ,46.00                                &
,105.903,27.330,6.400,0.000,5.100,0.000,5.100,0.304    ,46.0                               &
,107.903,26.460,4.100,0.000,2.100,0.000,2.100,8.550    ,46.0                             &
,109.905,11.720,7.700,0.000,7.500,0.000,7.500,0.226    ,46.0                           &
,107.860,0.000,5.922,0.000,4.407,0.580,4.990,63.300     ,47.0                                     &
,106.905,51.830,7.555,1.000,7.170,0.130,7.300,37.600    ,47.0                                   &
,108.904,48.170,4.165,-1.600,2.180,0.320,2.500,91.000   ,47.0                                 &
,112.414,0.000,4.87,0.000,3.040,3.460,6.500,2520.000    ,48.0                  &
,105.906,1.250,5.000,0.000,3.100,0.000,3.100,1.000      ,48.0                                 &
,107.904,0.890,5.400,0.000,3.700,0.000,3.700,1.100      ,48.0                                &
,109.903,12.510,5.900,0.000,4.400,0.000,4.400,11.000    ,48.0                                &
,110.904,12.810,6.500,0.000,5.300,0.300,5.600,24.000    ,48.0                               &
,111.902,24.130,6.400,0.000,5.100,0.000,5.100,2.200     ,48.0                            &
,112.904,12.220,-8.0,0.000,12.100,0.300,12.400,20600.000  ,48.0          &
,113.903,28.720,7.500,0.000,7.100,0.000,7.100,0.340       ,48.0                       &
,115.904,7.470,6.300,0.000,5.000,0.000,5.000,0.075        ,48.0                        &
,114.818,0.000,4.065,0.000,2.080,0.540,2.620,193.800      ,49.0       &
,112.904,4.300,5.390,0.017,3.650,0.000,3.650,12.000       ,49.0                                 &
,114.903,95.700,4.01,-2.100,2.020,0.550,2.570,202.000     ,49.0             &
,118.710,0.000,6.225,0.000,4.871,0.022,4.892,0.626             ,50.0                             &
,111.904,1.000,6.000,0.000,4.500,0.000,4.500,1.000             ,50.0                              &
,113.902,0.700,6.200,0.000,4.800,0.000,4.800,0.114             ,50.0                              &
,114.903,0.400,6.000,0.000,4.500,0.300,4.800,30.000            ,50.0                              &
,115.901,14.700,5.930,0.000,4.420,0.000,4.420,0.140            ,50.0                              &
,116.902,7.700,6.480,0.000,5.280,0.300,5.600,2.300             ,50.0                              &
,117.901,24.300,6.070,0.000,4.630,0.000,4.630,0.220            ,50.0                              &
,118.903,8.600,6.120,0.000,4.710,0.300,5.000,2.200            ,50.0                               &
,119.902,32.400,6.490,0.000,5.290,0.000,5.290,0.140            ,50.0                              &
,121.903,4.600,5.740,0.000,4.140,0.000,4.140,0.180             ,50.0                              &
,123.905,5.600,5.970,0.000,4.480,0.000,4.480,0.133             ,50.0                              &
,121.760,0.000,5.570,0.000,3.900,0.007,3.900,4.910             ,51.0                              &
,120.903,57.300,5.710,-0.050,4.100,0.000,4.100,5.750          ,52.0                               &
,122.904,42.700,5.380,-0.100,3.640,0.001,3.640,3.800          ,52.0                               &
,127.600,0.000,5.800,0.000,4.230,0.090,4.320,4.700             ,52.0                                 &
,119.904,0.096,5.300,0.000,3.500,0.000,3.500,2.300             ,52.0                                 &
,121.903,2.600,3.800,0.000,1.800,0.000,1.800,3.400             ,52.0                                 &
,122.904,0.908,-0.05,-2.040,0.002,0.520,0.520,418.000          ,52.0                 &
,123.902,4.816,7.960,0.000,8.000,0.000,8.000,6.800             ,52.0                                 &
,124.904,7.140,5.020,-0.260,3.170,0.008,3.180,1.550            ,52.0                                 &
,125.903,18.950,5.560,0.000,3.880,0.000,3.880,1.040            ,52.0                                 &
,127.904,31.690,5.890,0.000,4.360,0.000,4.360,0.215            ,52.0                                 &
,129.906,33.800,6.020,0.000,4.550,0.000,4.550,0.290            ,52.0                                 &
,126.904,100.000,5.280,1.580,3.500,0.310,3.810,6.150           ,53.0                                 &
,131.293,0.000,4.920,3.040,2.960,0.000,0.000,23.900            ,54.0                                 &
,123.905,0.100,0.000,0.000,0.000,0.000,0.000,165.000           ,54.0                                 &
,125.904,0.090,0.000,0.000,0.000,0.000,0.000,3.500             ,54.0                                 &
,127.903,1.910,0.000,0.000,0.000,0.000,0.000,8.000             ,54.0                                  &
,128.904,26.400,0.000,0.000,0.000,0.000,0.000,21.000           ,54.0                                 &
,129.903,4.100,0.000,0.000,0.000,0.000,0.000,26.000            ,54.0                                 &
,130.905,21.200,0.000,0.000,0.000,0.000,0.000,85.000           ,54.0                                 &
,131.904,26.900,0.000,0.000,0.000,0.000,0.000,0.450            ,54.0                                 &
,133.905,10.400,0.000,0.000,0.000,0.000,0.000,0.265            ,54.0                                 &
,135.907,8.900,0.000,0.000,0.000,0.000,0.000,0.260             ,54.00                                &
,132.905,100.000,5.420,1.290,3.690,0.210,3.900,29.000          ,55.0                                 &
,137.327,0.000,5.070,0.000,3.230,0.150,3.380,1.100             ,56.0                                 &
,129.906,0.110,-3.600,0.000,1.600,0.000,1.600,30.000           ,56.0                                 &
,131.905,0.100,7.800,0.000,7.600,0.000,7.600,7.000             ,56.00                                &
,133.904,2.420,5.700,0.000,4.080,0.000,4.080,2.000            ,56.0                                  &
,134.905,6.590,4.670,0.000,2.740,0.500,3.200,5.800            ,56.0                                    &
,135.904,7.850,4.910,0.000,3.030,0.000,3.030,0.680            ,56.0                                    &
,136.905,11.230,6.830,0.000,5.860,0.500,6.400,3.600           ,56.0                                    &
,137.905,71.700,4.840,0.000,2.940,0.000,2.940,0.270           ,56.0                                    &
,138.905,0.000,8.240,0.000,8.530,1.130,9.660,8.970            ,57.0                                    &
,137.907,0.090,8.000,0.000,8.000,0.500,8.500,57.000           ,57.0                                    &
,138.906,99.910,8.240,3.000,8.530,1.130,9.660,8.930           ,57.0                                    &
,140.116,0.000,4.840,0.000,2.940,0.001,2.940,0.630            ,58.0                                    &
,135.907,0.190,5.800,0.000,4.230,0.000,4.230,7.300            ,58.0                                    &
,137.905,0.250,6.700,0.000,5.640,0.000,5.640,1.100            ,58.0                                    &
,139.905,88.480,4.840,0.000,2.940,0.000,2.940,0.570           ,58.0                                    &
,141.909,11.080,4.750,0.000,2.840,0.000,2.840,0.950           ,58.0                                    &
,140.907,100.000,4.580,-0.350,2.640,0.015,2.660,11.500        ,59.0                                    &
,144.242,0.000,7.690,0.000,7.430,9.200,16.600,50.500          ,60.0                                    &
,141.907,27.160,7.700,0.000,7.500,0.000,7.500,18.700          ,60.0                                    &
,142.909,12.180,14.000,21.000,25.000,55.000,80.000,337.000    ,60.0                                    &
,143.910,23.800,2.800,0.000,1.000,0.000,1.000,3.600           ,60.0                                    &
,144.912,8.290,14.000,0.000,25.000,5.000,30.000,42.000        ,60.0                                    &
,145.913,17.190,8.700,0.000,9.500,0.000,9.500,1.400           ,60.0                                    &
,147.916,5.750,5.700,0.000,4.100,0.000,4.100,2.500            ,60.0                                    &
,149.920,5.630,5.300,0.000,3.500,0.000,3.500,1.200            ,60.0                                    &
,145.000,2.620,12.600,3.200,20.000,1.300,21.300,168.400       ,61.0                                    &
,150.360,0.000,0.80,0.000,0.422,39.000,39.000,5922.000        ,62.0                     &
,143.912,3.100,-3.000,0.000,1.000,0.000,1.000,0.700           ,62.0                                    &
,146.914,15.100,14.000,11.000,25.000,143.000,39.000,57.000    ,62.0                                    &
,147.914,11.300,-3.000,0.000,1.000,0.000,1.000,2.400          ,62.0                                    &
,148.917,13.900,-19.2,31.4,63.500,137.000,200.000,42080.000   ,62.0      &
,149.917,7.400,14.000,0.000,25.000,0.000,25.000,104.000       ,62.0                                    &
,151.919,26.600,-5.000,0.000,3.100,0.000,3.100,206.000        ,62.00                                   &
,153.922,22.600,9.300,0.000,11.000,0.000,11.000,8.400         ,62.0                                  &
,151.964,0.000,7.22,0.000,6.570,2.500,9.200,4530.000          ,63.0                   &
,150.919,47.800,6.13,4.5,5.500,3.100,8.600,9100.000            ,63.0   &
,152.921,52.200,8.220,3.200,8.500,1.300,9.800,312.000         ,63.0                                  &
,157.250,0.000,6.5,0.000,29.300,151.000,180.000,49700.000     ,64.0                  &
,151.919,0.200,10.000,0.000,13.000,0.000,13.000,735.000       ,64.0                                  &
,153.920,2.100,10.000,0.000,13.000,0.000,13.000,85.000        ,64.0                                  &
,154.922,14.800,6.0,5.0,40.800,25.000,66.000,61100.000        ,64.0   &
,155.922,20.600,6.300,0.000,5.000,0.000,5.000,1.500           ,64.0                                  &
,156.923,15.700,-1.14,5.0,650.000,394.000,1044.000,259000.000 ,64.0    &
,157.924,24.800,9.000,0.000,10.000,0.000,10.000,2.200          ,64.0                                 &
,159.927,21.800,9.150,0.000,10.520,0.000,10.520,0.770          ,64.0                                 &
,158.925,100.000,7.380,-0.170,6.840,0.004,6.840,23.400         ,65.0                                 &
,162.500,0.000,16.9,0.000,35.900,54.400,90.300,994.000         ,66.0              &
,155.924,0.060,6.100,0.000,4.700,0.000,4.700,33.000            ,66.0                              &
,157.924,0.100,6.000,0.000,5.000,0.000,5.000,43.000            ,66.0                              &
,159.925,2.340,6.700,0.000,5.600,0.000,5.600,56.000            ,66.0                              &
,160.926,19.000,10.300,4.900,13.300,3.000,16.000,600.000       ,66.0                              &
,161.926,25.500,-1.400,0.000,0.250,0.000,0.250,194.000         ,66.0                              &
,162.928,24.900,5.000,1.300,3.100,0.210,3.300,124.000          ,66.0                              &
,163.929,28.100,49.4,0.000,307.000,0.000,307.000,2840.000      ,66.0               &
,164.930,100.000,8.010,-1.700,8.060,0.360,8.420,64.700         ,67.0                              &
,167.259,0.000,7.790,0.000,7.630,1.100,8.700,159.000           ,68.0                              &
,161.928,0.140,8.800,0.000,9.700,0.000,9.700,19.000            ,68.0                              &
,163.929,1.560,8.200,0.000,8.400,0.000,8.400,13.000            ,68.0                              &
,165.930,33.400,10.600,0.000,14.100,0.000,14.100,19.600        ,68.0                              &
,166.932,22.900,3.000,1.000,1.100,0.130,1.200,659.000          ,68.0                              &
,167.932,27.100,7.400,0.000,6.900,0.000,6.900,2.740            ,68.0                              &
,169.935,14.900,9.600,0.000,11.600,0.000,11.600,5.800          ,68.0                              &
,168.934,100.000,7.070,0.900,6.280,0.100,6.380,100.000         ,69.0                              &
,173.054,0.000,12.430,0.000,19.420,4.000,23.400,34.800         ,70.0                              &
,167.933,0.140,-4.07,0.000,2.130,0.000,2.130,2230.000          ,70.0               &
,169.934,3.060,6.770,0.000,5.800,0.000,5.800,11.400            ,70.0                              &
,170.936,14.300,9.660,-5.590,11.700,3.900,15.600,48.600        ,70.0                              &
,171.936,21.900,9.430,0.000,11.200,0.000,11.200,0.800          ,70.0                              &
,172.938,16.100,9.560,-5.300,11.500,3.500,15.000,17.100        ,70.0                              &
,173.938,31.800,19.300,0.000,46.800,0.000,46.800,69.400        ,70.0                              &
,175.942,12.700,8.720,0.000,9.600,0.000,9.600,2.850            ,70.00                             &
,174.967,0.000,7.210,0.000,6.530,0.700,7.200,74.000            ,71.0                              &
,174.940,97.390,7.240,2.200,6.590,0.600,7.200,21.000           ,71.0                              &
,175.942,2.610,6.1,3.0,4.700,1.200,5.900,2065.000              ,71.0 &
,178.490,0.000,7.700,0.000,7.600,2.600,10.200,104.100          ,72.0                              &
,173.940,0.200,10.900,0.000,15.000,0.000,15.000,561.000        ,72.0                              &
,175.941,5.200,6.610,0.000,5.500,0.000,5.500,23.500            ,72.0                              &
,176.943,18.600,0.800,0.900,0.100,0.100,0.200,373.000          ,72.0                             &
,177.943,27.100,5.900,0.000,4.400,0.000,4.400,84.000           ,72.0                              &
,178.945,13.700,7.460,1.060,7.000,0.140,7.100,41.000           ,72.0                              &
,179.946,35.200,13.200,0.000,21.900,0.000,21.900,13.040        ,72.0                              &
,180.947,0.000,6.910,0.000,6.000,0.010,6.010,20.600            ,73.0                              &
,179.947,0.012,7.000,0.000,6.200,0.500,7.000,563.000           ,73.0                              &
,180.947,99.988,6.910,-0.290,6.000,0.011,6.010,20.500          ,73.0                              &
,183.840,0.000,4.860,0.000,2.970,1.630,4.600,18.300            ,74.0                              &
,179.946,0.100,5.000,0.000,3.000,0.000,3.000,30.000            ,74.0                              &
,181.948,26.300,6.970,0.000,6.100,0.000,6.100,20.700           ,74.0                              &
,182.950,14.300,6.530,0.000,5.360,0.300,5.700,10.100           ,74.0                              &
,183.950,30.700,7.480,0.000,7.030,0.000,7.030,1.700             ,74.0                             &
,185.954,28.600,-0.720,0.000,0.065,0.000,0.065,37.900           ,74.0                             &
,186.207,0.000,9.200,0.000,10.600,0.900,11.500,89.700           ,75.0                             &
,184.952,37.400,9.000,2.000,10.200,0.500,10.700,112.000         ,75.0                             &
,186.955,62.600,9.300,2.800,10.900,1.000,11.900,76.400          ,75.0                             &
,190.230,0.000,10.700,0.000,14.400,0.300,14.700,16.000          ,76.0                             &
,183.952,0.020,10.000,0.000,13.000,0.000,13.000,3000.000        ,76.0                             &
,185.953,1.580,11.600,0.000,17.000,0.000,17.000,80.000          ,76.0                             &
,186.955,1.600,10.000,0.000,13.000,0.300,13.000,320.000         ,76.0                             &
,187.955,13.300,7.600,0.000,7.300,0.000,7.300,4.700             ,76.0                             &
,188.958,16.100,10.700,0.000,14.400,0.500,14.900,25.000         ,76.0                             &
,189.958,26.400,11.000,0.000,15.200,0.000,15.200,13.100         ,76.0                             &
,191.961,41.000,11.500,0.000,16.600,0.000,16.600,2.000          ,76.0                             &
,192.217,0.000,10.600,0.000,14.100,0.000,14.000,425.000         ,77.0                             &
,190.960,37.300,0.000,0.000,0.000,0.000,0.000,954.000           ,77.0                             &
,192.962,62.700,0.000,0.000,0.000,0.000,0.000,111.000           ,77.0                             &
,195.084,0.000,9.600,0.000,11.580,0.130,11.710,10.300           ,78.0                             &
,189.959,0.010,9.000,0.000,10.000,0.000,10.000,152.000          ,78.0                             &
,191.961,0.790,9.900,0.000,12.300,0.000,12.300,10.000           ,78.0                             &
,193.962,32.900,10.550,0.000,14.000,0.000,14.000,1.440          ,78.0                             &
,194.964,33.800,8.830,-1.000,9.800,0.130,9.900,27.500           ,78.0                             &
,195.964,25.300,9.890,0.000,12.300,0.000,12.300,0.720           ,78.0                             &
,197.967,7.200,7.800,0.000,7.600,0.000,7.600,3.660              ,78.0                             &
,196.966,100.000,7.630,-1.840,7.320,0.430,7.750,98.650          ,79.0                             &
,200.592,0.000,12.692,0.000,20.240,6.600,26.800,372.300         ,80.0                             &
,195.965,0.200,30.300,0.000,115.000,0.000,115.000,3080.000      ,80.0                             &
,197.966,10.100,0.000,0.000,0.000,0.000,0.000,2.000             ,80.0                             &
,198.968,17.000,16.900,15.500,36.000,30.000,66.000,2150.000     ,80.0                             &
,199.968,23.100,0.000,0.000,0.000,0.000,0.000,60.000            ,80.0                             &
,200.970,13.200,0.000,0.000,0.000,0.000,0.000,7.800             ,80.0                             &
,201.970,29.600,0.000,0.000,0.000,0.000,9.828,4.890             ,80.0                             &
,203.973,6.800,0.000,0.000,0.000,0.000,0.000,0.430              ,80.0                             &
,204.382,0.000,8.776,0.000,9.678,0.210,9.890,3.430              ,81.0                             &
,202.972,29.524,6.990,1.060,6.140,0.140,6.280,11.400            ,81.0                             &
,204.974,70.476,9.520,-0.242,11.390,0.007,11.400,0.104          ,81.0                             &
,207.200,0.000,9.405,0.000,11.115,0.003,11.118,0.171            ,82.0                             &
,203.973,1.400,9.900,0.000,12.300,0.000,12.300,0.650            ,82.0                             &
,205.974,24.100,9.220,0.000,10.680,0.000,10.680,0.030           ,82.0                             &
,206.975,22.100,9.280,0.140,10.820,0.002,10.820,0.699           ,82.0                             &
,207.976,52.400,9.500,0.000,11.340,0.000,11.340,0.000           ,82.0                             &
,208.980,100.000,8.532,0.000,9.148,0.008,9.156,0.034            ,83.0                             &
,209.000,0.000,0.000,0.259,0.000,0.000,0.000,0.000              ,84.0                             &
,210.000,0.000,0.000,0.000,0.000,0.000,0.000,0.000              ,85.0                             &
,222.000,0.000,0.000,0.000,0.000,0.000,12.600,0.000             ,86.0                             &
,223.000,0.000,0.000,0.000,0.000,0.000,0.000,0.000              ,87.0                             &
,226.000,0.000,10.000,0.000,13.000,0.000,13.000,12.800          ,88.0                             &
,227.000,0.000,0.000,0.000,0.000,0.000,0.000,0.000              ,89.0                             &
,232.037,100.000,10.310,0.000,13.360,0.000,13.360,7.370         ,90.0                             &
,231.035,0.000,9.100,0.000,10.400,0.100,10.500,200.600          ,91.0                             &
,238.028,0.000,8.417,0.000,8.903,0.005,8.908,7.570              ,92.0                             &
,234.040,0.000,10.100,1.000,12.800,0.100,12.900,574.700         ,92.0                             &
,235.043,0.005,12.400,0.000,19.300,0.000,19.300,100.100         ,92.0                             &
,236.045,0.720,10.470,1.300,13.780,0.200,14.000,680.900         ,92.0                             &
,238.050,99.275,8.402,0.000,8.871,0.000,8.871,2.680             ,92.0                             &
,237.000,0.000,10.550,0.000,14.000,0.500,14.500,175.900         ,93.0                             &
,244.000,0.000,0.000,0.000,0.000,0.000,0.000,0.000              ,94.0                             &
,238.049,0.000,14.100,0.000,25.000,0.000,25.000,558.000         ,94.0                             &
,239.052,0.000,7.700,1.300,7.500,0.200,7.700,1017.300           ,94.0                             &
,240.053,0.000,3.500,0.000,1.540,0.000,1.540,289.600            ,94.0                             &
,242.058,0.000,8.100,0.000,8.200,0.000,8.200,18.500             ,94.0                             &
,241.056,0.000,8.300,2.000,8.700,0.300,9.000,75.300             ,95.0                             &
,243.061,0.000,0.000,0.000,0.000,0.000,0.000,0.000              ,96.0                             &
,244.061,0.000,9.500,0.000,11.300,0.000,11.300,16.200           ,97.0                             &
,246.067,0.000,9.300,0.000,10.900,0.000,10.900,1.360            ,97.0                             &
,248.072,0.000,7.700,0.000,7.500,0.000,7.500,0.000,97.0/)  &
,(/9,371/) )

do il=1,371
if(trim(sname)==trim(Element(il)))data1=neutron_attribute(:,il)
if(trim(sname)==trim(Element(il)))print*,il 
end do
print*,'mass of elements and neutron cross-section(Scattering and Abs) ,scattering length is:'
print*,sname,data1(1) ,data1(7:8),data1(3:4)
END SUBROUTINE





SUBROUTINE RESIDENCE
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,I2,J1,J2,K1,K2,ITH
INTEGER::II,JJ,KK
REAL::T2,T1
DOUBLE PRECISION,DIMENSION(3)::AA
REAL::RIJ,RJK
REAL,DIMENSION(3)::VEC11,VEC22
INTEGER::NC1,NC2
INTEGER::NCORD1,NCORD2,NK
REAL,DIMENSION(12)::ANGLEI
INTEGER::RBIN,TBIN
INTEGER,DIMENSION(1024,12)::PICK
DOUBLE PRECISION,DIMENSION(1024,12)::RPICK
INTEGER,DIMENSION(1024,12)::IPICK
INTEGER,DIMENSION(1024,12)::IIPICK
DOUBLE PRECISION,DIMENSION(1024,12)::RRPICK
INTEGER::ISPACE,L
REAL::TST
DOUBLE PRECISION::VOL
INTEGER::CCAGE,SCAGE
REAL::RCAGE
REAL::XMAX,YMAX,ZMAX,XMIN,YMIN,ZMIN
DOUBLE PRECISION,DIMENSION(3,3)::DAB
INTEGER::JK,ISEL
DOUBLE PRECISION,DIMENSION(1024,3)::CENTRE 
INTEGER::NCENTRE,STA
DOUBLE PRECISION,DIMENSION(1000,3,3)::AB
integer,dimension(600)::occc
DOUBLE PRECISION,DIMENSION(3)::XX
REAL::RANG
DOUBLE PRECISION,DIMENSION(3)::LOCAL
DOUBLE PRECISION,DIMENSION(1000)::VOLR,VOLN
occc=0
RANG=0.5
OPEN(31,FILE="TETRA")
DO I=1,8
READ(31,*)
END DO
NCENTRE=1024
SCAGE=3
CCAGE=2  !!!!!!!!Cu ions at centre of the cage
PICK=0
IPICK=0
READ*,RCAGE
!RCAGE=2.7
DO I=1,NCENTRE
READ(31,*)CENTRE(I,:)
END DO

!PRINT*,CENTRE(1024,:)

PRINT*, "I M IN RESIDENCE"
PI=4*ATAN(1.0)
ISPACE=NNTYPE(INDEX1(1,1))
ISEL=0
DO I=1,NCENTRE
	NK=0
	DO J=SUM (NNTYPE(1:SCAGE -1 )) +1, SUM(NNTYPE(1:SCAGE))
                !AA=CENTRE(I,:)-MATMUL(ISLATORIG,POS(1 ,J,:))         !!!!!!!!!!CENTRE IS IN FRACTIONAL CORDINATE WHILE POS IS IN CARTESI
                AA=CENTRE(I,:)-MATMUL(POS(1 ,J,:),ISLATORIG)         !!!!!!!!!!CENTRE IS IN FRACTIONAL CORDINATE WHILE POS IS IN CARTESI
                WHERE(AA.LT.-0.5)AA=AA+1
                WHERE(AA.GT.0.5)AA=AA-1
                !RIJ=NORM2(MATMUL(SLATORIG,AA))
                RIJ=NORM2(MATMUL(AA,SLATORIG))
                IF(RIJ.LE.RCAGE.AND.RIJ.GT.0.0)THEN
		NK=NK+1
                PICK(I,NK)=J
		RPICK(I,NK)=RIJ
                END IF
   END DO
  
   DO IK=1,4 
   id=minloc(RPICK(I,:),MASK=RPICK(I,:).GT.0,DIM=1)
   RRPICK(I,IK)=RPICK(I,id)
   IPICK(I,IK)=PICK(I,ID)
   RPICK(I,id)=0  
   END DO

  STA=0 !!!STATUS
  DO IK=1,I-1
  IF(ANY(IpiCK(I,:).GT.0) .AND. ANY(IPICK(IK,1:4)==IPICK(I,1)) .AND. ANY(IPICK(IK,1:4)==IPICK(I,2)) .AND.  ANY(IPICK(IK,1:4)==IPICK(I,3)) .AND. ANY(IPICK(IK,1:4)==IPICK(I,4)) )STA=1
  END DO
  IF(STA==0)THEN
  ISEL=ISEL+1
!!!!!!!!!!!!!!!!!!!!CHECK SENCE OF ROTATION!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		 AB(1,1,:)=MATMUL(POS(1,IPICK(I,2),:)-POS(1,IPICK(I,1),:),ISLATORIG )
		 AB(1,2,:)=MATMUL(POS(1,IPICK(I,3),:)-POS(1,IPICK(I,1),:),ISLATORIG )
		 AB(1,3,:)=MATMUL(POS(1,IPICK(I,4),:)-POS(1,IPICK(I,1),:),ISLATORIG )
		 WHERE(AB(1,1,:).GT.RANG)AB(1,1,:)=AB(1,1,:)-1
		 WHERE(AB(1,2,:).GT.RANG)AB(1,2,:)=AB(1,2,:)-1
		 WHERE(AB(1,3,:).GT.RANG)AB(1,3,:)=AB(1,3,:)-1
		 WHERE(AB(1,1,:).LT.-RANG)AB(1,1,:)=AB(1,1,:)+1
		 WHERE(AB(1,2,:).LT.-RANG)AB(1,2,:)=AB(1,2,:)+1
		 WHERE(AB(1,3,:).LT.-RANG)AB(1,3,:)=AB(1,3,:)+1
		 AB(1,1,:)=MATMUL(AB(1,1,:),SLATORIG)
		 AB(1,2,:)=MATMUL(AB(1,2,:),SLATORIG)
		 AB(1,3,:)=MATMUL(AB(1,3,:),SLATORIG)
		 CALL DETER(AB(1,:,:), VOL)
		 ! PRINT*,VOL
	   IF(VOL.GE.0)THEN
		IIPICK(ISEL,1:4)=IPICK(I,1:4)
	   ELSE
		IIPICK(ISEL,1)=IPICK(I,1)
		IIPICK(ISEL,2)=IPICK(I,2)
		IIPICK(ISEL,3)=IPICK(I,4)
		IIPICK(ISEL,4)=IPICK(I,3)
   
 	   END IF
!	PRINT*,IPICK(I,1:4)
!	PRINT*,IIPICK(I,1:4)
   !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!  IIPICK(ISEL,1:4)=IPICK(I,1:4)
  END IF
   8 FORMAT(I6,3x,4(F3.1,1x),3x,4I6,4x,I4)





END DO
PRINT*,ISEL



DO IT=1,IREF2-IREF1+1 
!PRINT*,IT
!!!!!!!!!!!!CALCULATE ISEL FRAMES
		DO I=1,ISEL
		 AB(I,1,:)=MATMUL(POS(IT,IIPICK(I,2),:)-POS(IT,IIPICK(I,1),:),ISLATORIG )
		 AB(I,2,:)=MATMUL(POS(IT,IIPICK(I,3),:)-POS(IT,IIPICK(I,1),:),ISLATORIG )
		 AB(I,3,:)=MATMUL(POS(IT,IIPICK(I,4),:)-POS(IT,IIPICK(I,1),:),ISLATORIG )
		 WHERE(AB(I,1,:).GT.RANG)AB(I,1,:)=AB(I,1,:)-1
		 WHERE(AB(I,2,:).GT.RANG)AB(I,2,:)=AB(I,2,:)-1
		 WHERE(AB(I,3,:).GT.RANG)AB(I,3,:)=AB(I,3,:)-1
		 WHERE(AB(I,1,:).LT.-RANG)AB(I,1,:)=AB(I,1,:)+1
		 WHERE(AB(I,2,:).LT.-RANG)AB(I,2,:)=AB(I,2,:)+1
		 WHERE(AB(I,3,:).LT.-RANG)AB(I,3,:)=AB(I,3,:)+1
		 AB(I,1,:)=MATMUL(AB(I,1,:),SLATORIG)
		 AB(I,2,:)=MATMUL(AB(I,2,:),SLATORIG)
		 AB(I,3,:)=MATMUL(AB(I,3,:),SLATORIG)
		 CALL DETER(AB(I,:,:), VOLR(I))
		
			DO J=SUM (NNTYPE(1:CCAGE -1 )) +1, SUM(NNTYPE(1:CCAGE))
			!RR=MATMUL(POS(IT,IIPICK(I,1))-POS(IT,J,:),ISLATORIG)
			!WHERE(RR.GT.0.5)RR=RR-1
			!WHERE(RR.LT.-0.5)RR=RR+1
			!RR=MATMUL(RR,SLATORIG)
			!IF(NORM2(RR).LE.5.0)THEN



			!END IF
			END DO
                END DO
END DO

END SUBROUTINE





       
SUBROUTINE RESIDENCE2
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,I2,J1,J2,K1,K2,ITH
INTEGER::II,JJ,KK
REAL::T2,T1
DOUBLE PRECISION,DIMENSION(3)::AA
REAL::RIJ,RJK
REAL,DIMENSION(3)::VEC11,VEC22
INTEGER::NC1,NC2
INTEGER::NCORD1,NCORD2,NK
REAL,DIMENSION(12)::ANGLEI
INTEGER::RBIN,TBIN
INTEGER,ALLOCATABLE,DIMENSION(:,:)::PICK,IPICK,IIPICK,OCCC
INTEGER::ISPACE,L
REAL::TST
DOUBLE PRECISION::VOL
INTEGER::CCAGE,SCAGE
REAL::RCAGE
REAL::XMAX,YMAX,ZMAX,XMIN,YMIN,ZMIN
DOUBLE PRECISION,DIMENSION(3,3)::DAB
INTEGER::JK,ISEL
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::CENTRE,RPICK,RRPICK,DMATRIX
INTEGER::NCENTRE,STA
DOUBLE PRECISION,allocatable,DIMENSION(:,:,:)::AB
DOUBLE PRECISION,DIMENSION(3)::XX
REAL::RANG,DET
DOUBLE PRECISION,DIMENSION(3)::LOCAL
DOUBLE PRECISION::TOL1,TOL2
integer::jtag
integer,allocatable,dimension(:)::atmloc,patmloc,ppatmloc,njump,snjump
integer::ijump
DOUBLE PRECISION,DIMENSION(NATOM,3)::POSL !DMATRIX
double precision,DIMENSION(3)::rcm1,rcm2,rr
double precision,dimension(natom,3)::P1,P2,P3
double precision,dimension(natom)::rjump,rjump2 
double precision,dimension(32,3)::RSE

		double precision,dimension(3)::dsecu
		double precision,dimension(32)::mdse
		double precision,dimension(224)::rmincuse
		integer::ise
		integer,dimension(224)::rmincuseindx
		integer,dimension(224)::prmincuseindx
		integer,dimension(224)::pprmincuseindx
		integer,dimension(224)::timer !pprmincuseindx
		double precision::RTOT,RTOT2,RTOT3
                double precision,dimension(0:100):: RRTOT,RRTOT2               
                integer::rind

OPEN(23,FILE="SITE_OCC_ATM")
OPEN(24,FILE="SITE_OCC")
OPEN(25,FILE="SITE_SEL_ATM")
OPEN(26,FILE="JUMP_EVENT_ATM")
OPEN(27,FILE="JUMP_EVENT_INTRCLUSTER")
OPEN(28,FILE="JUMP_DST_P1_P2")
OPEN(29,FILE="JUMP_DST_P1_P3")
OPEN(30,FILE="CAGE_Cu_DIS")
OPEN(131,FILE="JUMP_LENGTH_DISTRIBUTION")
RSE(:,:)=POS(1,417:448,:)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!INPUT
rind=0
TOL1=0.0000000000000000000000000000
TOL2=1.d0
occc=0
RANG=0.5


NCENTRE=1056
SCAGE=3
CCAGE=2  !!!!!!!!Cu ions at centre of the cage
PICK=0
IPICK=0
rmincuseindx=0
prmincuseindx=0
pprmincuseindx=0
SNJUMP=0
RTOT=0
RTOT2=0
RRTOT=0
RRTOT2=0
READ*,RCAGE
ALLOCATE(PICK(NCENTRE,12),RPICK(NCENTRE,12),RRPICK(NCENTRE,12),IIPICK(NCENTRE,12),IPICK(NCENTRE,12),CENTRE(NCENTRE,3),AB(NCENTRE,3,3),OCCC(NATOM,NCENTRE))
ALLOCATE(ATMLOC(NATOM),PATMLOC(NATOM),PPATMLOC(NATOM),NJUMP(NATOM),SNJUMP(NATOM))
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
OPEN(31,FILE="TETRA")
DO I=1,8
READ(31,*)
END DO
!RCAGE=2.7
DO I=1,NCENTRE
READ(31,*)CENTRE(I,:)
END DO

!PRINT*,CENTRE(1024,:)

PRINT*, "I M IN RESIDENCE"
PI=4*ATAN(1.0)
ISPACE=NNTYPE(INDEX1(1,1))
ISEL=0
DO I=1,NCENTRE
	NK=0
	DO J=SUM (NNTYPE(1:SCAGE -1 )) +1, SUM(NNTYPE(1:SCAGE))
                !AA=CENTRE(I,:)-MATMUL(ISLATORIG,POS(1 ,J,:))         !!!!!!!!!!CENTRE IS IN FRACTIONAL CORDINATE WHILE POS IS IN CARTESI
                AA=CENTRE(I,:)-MATMUL(POS(1 ,J,:),ISLATORIG)         !!!!!!!!!!CENTRE IS IN FRACTIONAL CORDINATE WHILE POS IS IN CARTESI
                WHERE(AA.LT.-0.5)AA=AA+1
                WHERE(AA.GT.0.5)AA=AA-1
                !RIJ=NORM2(MATMUL(SLATORIG,AA))
                RIJ=NORM2(MATMUL(AA,SLATORIG))
                IF(RIJ.LE.RCAGE.AND.RIJ.GT.0.0)THEN
		NK=NK+1
                PICK(I,NK)=J
		RPICK(I,NK)=RIJ
                END IF
   END DO
   DO IK=1,4 
   id=minloc(RPICK(I,:),MASK=RPICK(I,:).GT.0,DIM=1)
   RRPICK(I,IK)=RPICK(I,id)
   IPICK(I,IK)=PICK(I,ID)
   RPICK(I,id)=0  
   END DO
  STA=0 !!!STATUS
  DO IK=1,I-1
  IF(ANY(IpiCK(I,:).GT.0) .AND. ANY(IPICK(IK,1:4)==IPICK(I,1)) .AND. ANY(IPICK(IK,1:4)==IPICK(I,2)) .AND.  ANY(IPICK(IK,1:4)==IPICK(I,3)) .AND. ANY(IPICK(IK,1:4)==IPICK(I,4)) )STA=1
  END DO
  IF(STA==0)THEN
  ISEL=ISEL+1
!!!!!!!!!!!!!!!!!!!!CHECK SENCE OF ROTATION!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		 AB(1,1,:)=MATMUL(POS(1,IPICK(I,2),:)-POS(1,IPICK(I,1),:),ISLATORIG )
		 AB(1,2,:)=MATMUL(POS(1,IPICK(I,3),:)-POS(1,IPICK(I,1),:),ISLATORIG )
		 AB(1,3,:)=MATMUL(POS(1,IPICK(I,4),:)-POS(1,IPICK(I,1),:),ISLATORIG )
		 WHERE(AB(1,1,:).GT.RANG)AB(1,1,:)=AB(1,1,:)-1
		 WHERE(AB(1,2,:).GT.RANG)AB(1,2,:)=AB(1,2,:)-1
		 WHERE(AB(1,3,:).GT.RANG)AB(1,3,:)=AB(1,3,:)-1
		 WHERE(AB(1,1,:).LT.-RANG)AB(1,1,:)=AB(1,1,:)+1
		 WHERE(AB(1,2,:).LT.-RANG)AB(1,2,:)=AB(1,2,:)+1
		 WHERE(AB(1,3,:).LT.-RANG)AB(1,3,:)=AB(1,3,:)+1
		 AB(1,1,:)=MATMUL(AB(1,1,:),SLATORIG)
		 AB(1,2,:)=MATMUL(AB(1,2,:),SLATORIG)
		 AB(1,3,:)=MATMUL(AB(1,3,:),SLATORIG)
		 CALL DETER(AB(1,:,:), VOL)
		 ! PRINT*,VOL
	   IF(VOL.GE.0)THEN
		IIPICK(ISEL,1:4)=IPICK(I,1:4)
	   ELSE
		IIPICK(ISEL,1)=IPICK(I,1)
		IIPICK(ISEL,2)=IPICK(I,2)
		IIPICK(ISEL,3)=IPICK(I,4)
		IIPICK(ISEL,4)=IPICK(I,3)
	   END IF
  END IF
   8 FORMAT(I6,3x,4(F3.1,1x),3x,4I6,4x,I4)
END DO
DO I=1,NATOM
POSL(I,:)=MATMUL(POS(1,I,:),ISLATORIG)
!PRINT*,POSL(I,:)
!PAUSE
END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!CALCULATION OF DMATRIX!!!!!!!!!!!!!!!!!!!!!!!!!
DO I=1,ISEL
		 RR=POSL(IIPICK(I,2),:)-POSL(IIPICK(I,1),:)
		 IF(RR(1).GE.0.5)POSL(IIPICK(I,2),1)= POSL(IIPICK(I,2),1) -1 !SLATORIG(1,:) 
		 IF(RR(2).GE.0.5)POSL(IIPICK(I,2),2)= POSL(IIPICK(I,2),2) -1 !SLATORIG(2,:) 
		 IF(RR(3).GE.0.5)POSL(IIPICK(I,2),3)= POSL(IIPICK(I,2),3) -1 ! SLATORIG(3,:) 
		 IF(RR(1).LE.-0.5)POSL(IIPICK(I,2),1)= POSL(IIPICK(I,2),1) +1 !SLATORIG(1,:) 
		 IF(RR(2).LE.-0.5)POSL(IIPICK(I,2),2)= POSL(IIPICK(I,2),2) +1 !SLATORIG(2,:) 
		 IF(RR(3).LE.-0.5)POSL(IIPICK(I,2),3)= POSL(IIPICK(I,2),3) +1 !SLATORIG(2,:) 
		 RR=POSL(IIPICK(I,3),:)-POSL(IIPICK(I,1),:)
		 IF(RR(1).GE.0.5)POSL(IIPICK(I,3),1)= POSL(IIPICK(I,3),1) -1 !SLATORIG(1,:) 
		 IF(RR(2).GE.0.5)POSL(IIPICK(I,3),2)= POSL(IIPICK(I,3),2) -1 !SLATORIG(2,:) 
		 IF(RR(3).GE.0.5)POSL(IIPICK(I,3),3)= POSL(IIPICK(I,3),3) -1 !SLATORIG(3,:) 
		 IF(RR(1).LE.-0.5)POSL(IIPICK(I,3),1)= POSL(IIPICK(I,3),1) +1 !SLATORIG(1,:) 
		 IF(RR(2).LE.-0.5)POSL(IIPICK(I,3),2)= POSL(IIPICK(I,3),2) +1 !SLATORIG(2,:) 
		 IF(RR(3).LE.-0.5)POSL(IIPICK(I,3),3)= POSL(IIPICK(I,3),3) +1 !SLATORIG(3,:) 
		 RR=POSL(IIPICK(I,4),:)-POSL(IIPICK(I,1),:)
		 IF(RR(1).GE.0.5)POSL(IIPICK(I,4),1)= POSL(IIPICK(I,4),1) -1 !SLATORIG(1,:) 
		 IF(RR(2).GE.0.5)POSL(IIPICK(I,4),2)= POSL(IIPICK(I,4),2) -1 !SLATORIG(2,:) 
		 IF(RR(3).GE.0.5)POSL(IIPICK(I,4),3)= POSL(IIPICK(I,4),3) -1 !SLATORIG(3,:) 
		 IF(RR(1).LE.-0.5)POSL(IIPICK(I,4),1)= POSL(IIPICK(I,4),1) +1 !SLATORIG(1,:) 
		 IF(RR(2).LE.-0.5)POSL(IIPICK(I,4),2)= POSL(IIPICK(I,4),2) +1 !SLATORIG(2,:) 
		 IF(RR(3).LE.-0.5)POSL(IIPICK(I,4),3)= POSL(IIPICK(I,4),3) +1 !SLATORIG(3,:) 
end do
do i=1,isel
	DO J=I,ISEL
	RCM1=(POSL(iIPICK(I,1),:) + POSL(iIPICK(I,2),:) + POSL(iIPICK(I,3),:)  + POSL(iIPICK(I,4),:))/4
	RCM2=(POSL(iIPICK(J,1),:) + POSL(iIPICK(J,2),:) + POSL(iIPICK(J,3),:)  + POSL(iIPICK(J,4),:))/4
	END DO
END DO
!!!!!!!!!NOT YET COMPLETED!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
PRINT*,ISEL
OCCC=0
P1(:,:)=POS(1,:,:) !!!!!!!!!!!
DO IT=1,IREF2-IREF1+1 
!PRINT*,IT
!!!!!!!!!!!!CALCULATE ISEL FRAMES
		DO I=1,ISEL
		 AB(I,1,:)=MATMUL(POS(IT,IIPICK(I,2),:)-POS(IT,IIPICK(I,1),:),ISLATORIG )
		 AB(I,2,:)=MATMUL(POS(IT,IIPICK(I,3),:)-POS(IT,IIPICK(I,1),:),ISLATORIG )
		 AB(I,3,:)=MATMUL(POS(IT,IIPICK(I,4),:)-POS(IT,IIPICK(I,1),:),ISLATORIG )
		 WHERE(AB(I,1,:).GT.RANG)AB(I,1,:)=AB(I,1,:)-1
		 WHERE(AB(I,2,:).GT.RANG)AB(I,2,:)=AB(I,2,:)-1
		 WHERE(AB(I,3,:).GT.RANG)AB(I,3,:)=AB(I,3,:)-1
		 WHERE(AB(I,1,:).LT.-RANG)AB(I,1,:)=AB(I,1,:)+1
		 WHERE(AB(I,2,:).LT.-RANG)AB(I,2,:)=AB(I,2,:)+1
		 WHERE(AB(I,3,:).LT.-RANG)AB(I,3,:)=AB(I,3,:)+1
		 AB(I,1,:)=MATMUL(AB(I,1,:),SLATORIG)
		 AB(I,2,:)=MATMUL(AB(I,2,:),SLATORIG)
		 AB(I,3,:)=MATMUL(AB(I,3,:),SLATORIG)
        	CALL GAUSS(AB(I,:,:),3)
		END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	JTAG=0
	DO J=SUM (NNTYPE(1:CCAGE -1 )) +1, SUM(NNTYPE(1:CCAGE))
	JTAG=JTAG+1
	!PRINT*,J
	IJUMP=0
        	DO I=1,ISEL
                LOCAL=MATMUL(POS(IT,J,:)-POS(IT,IIPICK(I,1),:),ISLATORIG)
        	WHERE(LOCAL.GT.0.5)LOCAL=LOCAL-1
        	WHERE(LOCAL.LT.-0.5)LOCAL=LOCAL+1
	        LOCAL=MATMUL(LOCAL,SLATORIG)
        	!XX=MATMUL(LOCAL,AB(I,:,:))
        	XX=MATMUL(AB(I,:,:),LOCAL)
                23 FORMAT(3F10.3,2x,3F10.3)
                21 FORMAT(3F10.3)
        	IF(ANY(XX.LE.TOL1)==.FALSE..AND.ANY(XX.GT.TOL2) ==.FALSE..AND.SUM(XX).LE.1.0)OCCC(JTAG,I)=OCCC(JTAG,I)+1 
	        IF(ANY(XX.LE.TOL1)==.FALSE..AND.ANY(XX.GT.TOL2) ==.FALSE..AND.SUM(XX).LE.1.0)ATMLOC(JTAG)=I  !OCCC(JTAG,I)+1 
          	ENDDO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!JUMP EVENT MONTORING!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
          	IF(IT.EQ.1)PATMLOC(JTAG)=ATMLOC(JTAG)
        	IF(IT.EQ.1)PPATMLOC(JTAG)=ATMLOC(JTAG)
        	IF(IT.GT.1.and.patmloc(jtag).ne.atmloc(jtag))then
		 DO ise=417,448
		 !dsecu=matmul(pos(it,j,:)-rse(ise,:),ISLATORIG)
		 dsecu=matmul(pos(it,j,:)-pos(it,ise,:),ISLATORIG)
		 where(dsecu.le.-0.5)dsecu=dsecu+1
		 where(dsecu.ge.0.5)dsecu=dsecu-1
		 mdse(ise-416)=norm2(MATMUL(dsecu,SLATORIG))
		 END DO

		 timer(jtag)=timer(jtag)+1
		 rmincuse(jtag)=minval(mdse)
		 rmincuseindx(jtag)=minloc(mdse,dim=1)
		 if(SNJUMP(JTAG)==0.and.rmincuseindx(jtag).ne.0)prmincuseindx(jtag)= rmincuseindx(jtag)
		 if(SNJUMP(JTAG)==0.and.rmincuseindx(jtag).ne.0)pprmincuseindx(jtag)= rmincuseindx(jtag)

		 if(SNJUMP(JTAG)==0.AND.rmincuseindx(jtag).ne.0)then
         	!	 print*,it,rmincuseindx(1),prmincuseindx(1),pprmincuseindx(1),snjump(1)
	        	 if(rmincuseindx(jtag).ne.0.and. prmincuseindx(jtag).ne.0.and. pprmincuseindx(jtag).ne.0)SNJUMP(JTAG)=SNJUMP(JTAG)+1
		         pprmincuseindx(JTAG)=prmincuseindx(JTAG)
		         prmincuseindx(JTAG)=rmincuseindx(JTAG)
			 timer(jtag)=0
		 !	 RJUMP2(J)=NORM2(P3(J,:)-P1(J,:))
		 !elseif(SNJUMP(JTAG).ne.0.AND.pprmincuseindx(jtag).ne.rmincuseindx(jtag).and.rmincuseindx(jtag).ne.prmincuseindx(jtag).and.timer(jtag).gt.10.and.RJUMP(J).GT.1.4)then
		 elseif(SNJUMP(JTAG).ne.0.AND.pprmincuseindx(jtag).ne.rmincuseindx(jtag).and.rmincuseindx(jtag).ne.prmincuseindx(jtag).and.timer(jtag).gt.1.and.RJUMP(J).GT.1.4)then
         	!	 print*,it,rmincuseindx(1),prmincuseindx(1),pprmincuseindx(1),snjump(1)
		         if(rmincuseindx(jtag).ne.0.and. prmincuseindx(jtag).ne.0.and. pprmincuseindx(jtag).ne.0)SNJUMP(JTAG)=SNJUMP(JTAG)+1
		         pprmincuseindx(JTAG)=prmincuseindx(JTAG)
		         prmincuseindx(JTAG)=rmincuseindx(JTAG)
			 timer(jtag)=0
		 	 IF(SNJUMP(JTAG).GT.1)RTOT2=RTOT2+RJUMP(J)
		 	 IF(SNJUMP(JTAG).GT.1)RTOT3=RTOT3+RJUMP2(J)
                         RIND=INT(RJUMP(J)/0.1) !!!!!!!!!!!!!!!!!!!Binning with 0.1 Angstrom
                        IF(RIND.LE.100)RRTOT2(RIND)=RRTOT2(RIND)+1 
		 end if
		 P3(J,:)=P2(J,:)
		 P2(J,:)=P1(J,:)
		 P1(J,:)=POS(IT,J,:)
		 RJUMP(J)=NORM2(P2(J,:)-P1(J,:))
		 RJUMP2(JTAG)=NORM2(P3(J,:)-P1(J,:))
                 RIND=INT(real(RJUMP(J))/0.1) !!!!!!!!!!!!!!!!!!!Binning with 0.1 Angstrom
		 IF(RJUMP(J).GT.0.8)NJUMP(JTAG)=NJUMP(JTAG)+1
                 IF(RJUMP(J).GT.0.8)RTOT=RTOT+RJUMP(J)
                 IF(RIND.LE.100)RRTOT(RIND)=RRTOT(RIND)+1 
		 !IF(PATMLOC(JTAG).GT.384.and. ATMLOC(JTAG).ne.PPATMLOC(JTAG).and.RJUMP2(J).GT.1.4)SNJUMP(JTAG)=SNJUMP(JTAG)+1
		 !IF(PATMLOC(JTAG).GT.384.and. ATMLOC(JTAG).ne.PPATMLOC(JTAG).and.rmincuse(jtag).GT.3.6)SNJUMP(JTAG)=SNJUMP(JTAG)+1
		 !PPATMLOC(JTAG)=PATMLOC(JTAG)
		 !PATMLOC(JTAG)=ATMLOC(JTAG)
		 PATMLOC(JTAG)=ATMLOC(JTAG)
                 end if
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	ENDDO
!	if(mod(it,1000)==0)pause
	WRITE(28,28)REAL(DELT*IT),RJUMP(33:256)
	WRITE(29,28)REAL(DELT*IT),RJUMP2(33:256)
	WRITE(30,28)REAL(DELT*IT),rmincuse      
	WRITE(25,25)IT*DELT,ATMLOC(1:224)
	25 FORMAT(F10.5,10000I7)
	28 FORMAT(F10.5,10000F10.3)
	24 FORMAT(4I5,2x,3F10.5)
	WRITE(26,26)IT*DELT,NJUMP(:)
	26 FORMAT(F12.5,1000I5)
	WRITE(27,26)IT*DELT,SNJUMP(:)-1
END DO

	JTAG=0
	DO J=SUM (NNTYPE(1:CCAGE -1 )) +1, SUM(NNTYPE(1:CCAGE))
	JTAG=JTAG+1
	DO I=1,ISEL
	WRITE(23,323)J,I,REAL(OCCC(JTAG,I))/REAL(NSTEPORIG)
	END DO
	323 FORMAT(2I10,E12.5)
	324 FORMAT(I10,E12.5)
	END DO
	DO I=1,ISEL
	WRITE(24,324)I,REAL(SUM(OCCC(:,I)))/REAL(SUM(OCCC))
	END DO


        DO I=0,100
        WRITE(131,31)0.1*REAL(I),RRTOT(I)/REAL(SUM(NJUMP)),RRTOT2(I)/REAL(SUM(SNJUMP)-NNTYPE(CCAGE))
        31 FORMAT(F10.5,2F20.10)
        END DO



        PRINT*,'SUM OF inter-cluster JUMP',SUM(SNJUMP)-NNTYPE(CCAGE)
        PRINT*,'SUM OF inter-cluster JUMPLENGTHS',RTOT2,RTOT3
        PRINT*,'AVG inter-cluster RESIDENCETIME',(NSTEPORIG*DELT)*NNTYPE(CCAGE)/(SUM(SNJUMP)-NNTYPE(CCAGE))
        PRINT*,'AVG Inter-cluster JUMPLENGTHS',RTOT2/(SUM(SNJUMP)-NNTYPE(CCAGE))
        PRINT*,'AVG Inter-cluster JUMPLENGTHS2',RTOT3/(SUM(SNJUMP)-NNTYPE(CCAGE))


        PRINT*,'SUM OF ALL JUMP',SUM(NJUMP) !-NNTYPE(CCAGE)
        PRINT*,'SUM OF ALL JUMPLENGTHS',RTOT 
        PRINT*,'AVG RESIDENCE TIME',(NSTEPORIG*DELT*NNTYPE(CCAGE))/(SUM(NJUMP))
        PRINT*,'AVG JUMPLENGTHS  ',RTOT/(SUM(NJUMP)) 


END SUBROUTINE

SUBROUTINE RESIDENCE3
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,I2,J1,J2,K1,K2,ITH
INTEGER::II,JJ,KK
REAL::T2,T1
DOUBLE PRECISION,DIMENSION(3)::AA
REAL::RIJ,RJK
REAL,DIMENSION(3)::VEC11,VEC22
INTEGER::NC1,NC2
INTEGER::NCORD1,NCORD2,NK
REAL,DIMENSION(12)::ANGLEI
INTEGER::RBIN,TBIN
INTEGER,DIMENSION(1024,12)::PICK
DOUBLE PRECISION,DIMENSION(1024,12)::RPICK
INTEGER,DIMENSION(1024,12)::IPICK
INTEGER,DIMENSION(1024,12)::IIPICK
DOUBLE PRECISION,DIMENSION(1024,12)::RRPICK
INTEGER::ISPACE,L
REAL::TST
DOUBLE PRECISION::VOL
INTEGER::CCAGE,SCAGE
REAL::RCAGE
REAL::XMAX,YMAX,ZMAX,XMIN,YMIN,ZMIN
DOUBLE PRECISION,DIMENSION(3,3)::DAB
INTEGER::JK,ISEL
DOUBLE PRECISION,DIMENSION(1024,3)::CENTRE 
INTEGER::NCENTRE,STA
DOUBLE PRECISION,DIMENSION(1000,3,3)::AB
integer,dimension(600)::occc
DOUBLE PRECISION,DIMENSION(3)::XX
REAL::RANG,DET
DOUBLE PRECISION,DIMENSION(3)::LOCAL
LOGICAL::IITRUE
INTEGER::OC,JTAG

DOUBLE PRECISION,DIMENSION(5)::V2v
OPEN(23,FILE='occupancy_cu')
occc=0
RANG=0.5
OPEN(31,FILE="TETRA")
DO I=1,8
READ(31,*)
END DO
NCENTRE=928 
SCAGE=3
CCAGE=2  !!!!!!!!Cu ions at centre of the cage
PICK=0
IPICK=0
READ*,RCAGE
!RCAGE=2.7
DO I=1,NCENTRE
READ(31,*)CENTRE(I,:)
END DO

!PRINT*,CENTRE(1024,:)

PRINT*, "I M IN RESIDENCE"
PI=4*ATAN(1.0)
ISPACE=NNTYPE(INDEX1(1,1))
ISEL=0
DO I=1,NCENTRE
	NK=0
	DO J=SUM (NNTYPE(1:SCAGE -1 )) +1, SUM(NNTYPE(1:SCAGE))
		!AA=CENTRE(I,:)-MATMUL(ISLATORIG,POS(1 ,J,:))         !!!!!!!!!!CENTRE IS IN FRACTIONAL CORDINATE WHILE POS IS IN CARTESI
		AA=CENTRE(I,:)-MATMUL(POS(1 ,J,:),ISLATORIG)         !!!!!!!!!!CENTRE IS IN FRACTIONAL CORDINATE WHILE POS IS IN CARTESI
		WHERE(AA.LT.-0.5)AA=AA+1
		WHERE(AA.GT.0.5)AA=AA-1
		!RIJ=NORM2(MATMUL(SLATORIG,AA))
		RIJ=NORM2(MATMUL(AA,SLATORIG))
		IF(RIJ.LE.RCAGE.AND.RIJ.GT.0.0)THEN
		NK=NK+1
		PICK(I,NK)=J
		RPICK(I,NK)=RIJ
		END IF
   END DO
   DO IK=1,4 
   id=minloc(RPICK(I,:),MASK=RPICK(I,:).GT.0,DIM=1)
   RRPICK(I,IK)=RPICK(I,id)
   IPICK(I,IK)=PICK(I,ID)
   RPICK(I,id)=0  
   END DO
  STA=0 !!!STATUS
  DO IK=1,I-1
  IF(ANY(IpiCK(I,:).GT.0) .AND. ANY(IPICK(IK,1:4)==IPICK(I,1)) .AND. ANY(IPICK(IK,1:4)==IPICK(I,2)) .AND.  ANY(IPICK(IK,1:4)==IPICK(I,3)) .AND. ANY(IPICK(IK,1:4)==IPICK(I,4)) )STA=1
  END DO
  IF(STA==0)THEN
  ISEL=ISEL+1
!!!!!!!!!!!!!!!!!!!!CHECK SENCE OF ROTATION!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
		 AB(1,1,:)=MATMUL(POS(1,IPICK(I,2),:)-POS(1,IPICK(I,1),:),ISLATORIG )
		 AB(1,2,:)=MATMUL(POS(1,IPICK(I,3),:)-POS(1,IPICK(I,1),:),ISLATORIG )
		 AB(1,3,:)=MATMUL(POS(1,IPICK(I,4),:)-POS(1,IPICK(I,1),:),ISLATORIG )
		 WHERE(AB(1,1,:).GT.RANG)AB(1,1,:)=AB(1,1,:)-1
		 WHERE(AB(1,2,:).GT.RANG)AB(1,2,:)=AB(1,2,:)-1
		 WHERE(AB(1,3,:).GT.RANG)AB(1,3,:)=AB(1,3,:)-1
		 WHERE(AB(1,1,:).LT.-RANG)AB(1,1,:)=AB(1,1,:)+1
		 WHERE(AB(1,2,:).LT.-RANG)AB(1,2,:)=AB(1,2,:)+1
		 WHERE(AB(1,3,:).LT.-RANG)AB(1,3,:)=AB(1,3,:)+1
		 AB(1,1,:)=MATMUL(AB(1,1,:),SLATORIG)
		 AB(1,2,:)=MATMUL(AB(1,2,:),SLATORIG)
		 AB(1,3,:)=MATMUL(AB(1,3,:),SLATORIG)
		 CALL DETER(AB(1,:,:), VOL)
		 ! PRINT*,VOL
	   IF(VOL.GE.0)THEN
		IIPICK(ISEL,1:4)=IPICK(I,1:4)
	   ELSE

!		IIPICK(ISEL,1:4)=IPICK(I,1:4)
		IIPICK(ISEL,1)=IPICK(I,1)
		IIPICK(ISEL,2)=IPICK(I,2)
		IIPICK(ISEL,3)=IPICK(I,4)
		IIPICK(ISEL,4)=IPICK(I,3)
	   END IF
  END IF
   8 FORMAT(I6,3x,4(F3.1,1x),3x,4I6,4x,I4)
END DO
PRINT*,ISEL

DO IT=1,IREF2-IREF1+1 
!PRINT*,IT
!!!!!!!!!!!!CALCULATE ISEL FRAMES
	DO J=33,33  !SUM (NNTYPE(1:CCAGE -1 )) +1, SUM(NNTYPE(1:CCAGE))
!		PRINT*,J 
		DO I=1,ISEL
		IITRUE=.FALSE.
		CALL PLANE1(IT,IIPICK(I,1), IIPICK(I,2),IIPICK(I,3),IIPICK(I,4),J,IITRUE,v2v)
		IF(IITRUE)OC=OC+1
		if(iitrue)PRINT*,I,J,IIPICK(I,1:4)-256 !IITRUE
		if(iitrue)PRINT*,v2v  !I,J,IIPICK(I,1:4) !IITRUE
		END DO
	PAUSE
	END DO
END DO
PRINT*,OC
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
END SUBROUTINE

SUBROUTINE PLANE1(ITT,I1,I2,I3,I4,I5,ITRUE,vvol1)
IMPLICIT NONE
INTEGER::I1,I2,I3,I4,I5,ITT
LOGICAL::ITRUE
DOUBLE PRECISION,DIMENSION(5)::vvol1
DOUBLE PRECISION::vol0,vol1
ITRUE=.true.
CALL CCVOLUME(I5,I2,I3,I4,vol1,ITT)
vvol1(1)=vol1
CALL CCVOLUME(I1,I5,I3,I4,vol1,ITT)
vvol1(2)=vol1
CALL CCVOLUME(I1,I2,I5,I4,vol1,ITT)
vvol1(3)=vol1
CALL CCVOLUME(I1,I2,I3,I5,vol1,ITT)
vvol1(4)=vol1
CALL CCVOLUME(I1,I2,I3,I4,vol1,ITT)
vvol1(5)=vol1
if(any(vvol1(1:4).gt.vvol1(5))==.true..or.any(vvol1.le.0)==.TRue.)ITRUE=.FALSE.
!if(ITRUE)print*,vvol1,vol0,itrue
!if(ITRUE)pause
END SUBROUTINE

!SUBROUTINE PLANEE(I1,I2,I3,I4,I5,ITT)
!USE VARIABLES1
!IMPLICIT NONE
!INTEGER::I1,I2,I3,I4,I5,ITT
!DOUBLE PRECISION,DIMENSION(3)::AD,BD,CD,BDCROSSCD
!DOUBLE PRECISION::AREAc,ttheta,volumec
!INTEGER::TI,TJ,TK
!AB=MATMUL(ISLATORIG, POS(ITT,I2,:)-POS(ITT,I1,:))
!AC=MATMUL(ISLATORIG, POS(ITT,I3,:)-POS(ITT,I1,:))
!AD=MATMUL(ISLATORIG, POS(ITT,I4,:)-POS(ITT,I1,:))
!BC=MATMUL(ISLATORIG, POS(ITT,I3,:)-POS(ITT,I2,:))
!BD=MATMUL(ISLATORIG, POS(ITT,I4,:)-POS(ITT,I2,:))
!WHERE(AB.GT.0.5)AB=AB-1
!WHERE(AB.LT.-0.5)AB=AB+1

!WHERE(AC.GT.0.5)AC=AC-1
!WHERE(AC.LT.-0.5)AC=AC+1


!WHERE(AD.GT.0.5)AD=AD-1
!WHERE(AD.LT.-0.5)AD=AD+1


!WHERE(BC.GT.0.5)BC=BC-1
!WHERE(BC.LT.-0.5)BC=BC+1

!WHERE(BD.GT.0.5)BD=BD-1
!WHERE(BD.LT.-0.5)BD=BD+1
!AB=MATMUL(SLATORIG,AB)
!AC=MATMUL(SLATORIG,AC)
!AD=MATMUL(SLATORIG,AD)
!BC=MATMUL(SLATORIG,BC)
!BD=MATMUL(SLATORIG,BD)


!!!!!!!!!!!!!!!!!!!!!!!!!!!!PLANE1  AB AC
!DO TI=1,3
!TJ=TI+1
!TK=TI+2
!IF(TJ.GT.3)TJ=TJ-3
!IF(TK.GT.3)TK=TK-3
!BDCROSSCD(TI)=AB(TJ)*CD(TK)-BD(TK)*CD(TJ)
!END DO
!end subroutine



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!






SUBROUTINE CCVOLUME(I1,I2,I3,I4,volumec,ITT)
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,I2,I3,I4,ITT
DOUBLE PRECISION,DIMENSION(3)::AD,BD,CD,BDCROSSCD
DOUBLE PRECISION::AREAc,ttheta,volumec
INTEGER::TI,TJ,TK
!AD=MATMUL(ISLATORIG, POS(ITT,I1,:)-POS(ITT,I4,:))
!BD=MATMUL(ISLATORIG, POS(ITT,I2,:)-POS(ITT,I4,:))
!CD=MATMUL(ISLATORIG, POS(ITT,I3,:)-POS(ITT,I4,:))
AD=MATMUL( POS(ITT,I1,:)-POS(ITT,I4,:),ISLATORIG)
BD=MATMUL( POS(ITT,I2,:)-POS(ITT,I4,:),ISLATORIG)
CD=MATMUL( POS(ITT,I3,:)-POS(ITT,I4,:),ISLATORIG)
IF(AD(1).GT.0.5)AD(1)=AD(1)-1
IF(AD(2).GT.0.5)AD(2)=AD(2)-1
IF(AD(3).GT.0.5)AD(3)=AD(3)-1
IF(AD(1).LT.-0.5)AD(1)=AD(1)+1
IF(AD(2).LT.-0.5)AD(2)=AD(2)+1
IF(AD(3).LT.-0.5)AD(3)=AD(3)+1
IF(BD(1).GT.0.5)BD(1)=BD(1)-1
IF(BD(2).GT.0.5)BD(2)=BD(2)-1
IF(BD(3).GT.0.5)BD(3)=BD(3)-1
IF(BD(1).LT.-0.5)BD(1)=BD(1)+1
IF(BD(2).LT.-0.5)BD(2)=BD(2)+1
IF(BD(3).LT.-0.5)BD(3)=BD(3)+1
IF(CD(1).GT.0.5)CD(1)=CD(1)-1
IF(CD(2).GT.0.5)CD(2)=CD(2)-1
IF(CD(3).GT.0.5)CD(3)=CD(3)-1
IF(CD(1).LT.-0.5)CD(1)=CD(1)+1
IF(CD(2).LT.-0.5)CD(2)=CD(2)+1
IF(CD(3).LT.-0.5)CD(3)=CD(3)+1
!PRINT*,AD
!PRINT*,BD
!PRINT*,CD
!PAUSE
!AD=MATMUL(SLATORIG,AD)
!BD=MATMUL(SLATORIG,BD)
!CD=MATMUL(SLATORIG,CD)
AD=MATMUL(AD,SLATORIG)
BD=MATMUL(BD,SLATORIG)
CD=MATMUL(CD,SLATORIG)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!
DO TI=1,3
TJ=TI+1
TK=TI+2
IF(TJ.GT.3)TJ=TJ-3
IF(TK.GT.3)TK=TK-3
BDCROSSCD(TI)=BD(TJ)*CD(TK)-BD(TK)*CD(TJ)
END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!
volumec=ABS(DOT_PRODUCT(AD,BDCROSSCD))/6 !norm2(AB)*norm2(AC)*sin(ttheta)
end subroutine



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

SUBROUTINE CUPSE
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,I2,J1,J2,K1,K2,ITH
INTEGER::II,JJ,KK
DOUBLE PRECISION,DIMENSION(3)::AA
DOUBLE PRECISION::RIJ,RJK
INTEGER::NK
INTEGER,DIMENSION(NATOM,24,3)::PICK
DOUBLE  PRECISION,DIMENSION(64,10)::MSD
INTEGER::JTAG
DOUBLE PRECISION::RADIUS
PRINT*, "I M IN CUPSE"
OPEN(120,FILE="CUPSE_MSD")
PICK=0
RADIUS=3.65
DO I=417,448 !SUM(NNTYPE(1:INDEX1(1,1)-1))+1,SUM(NNTYPE(1:INDEX1(1,1)))

        PRINT*,NORM2(POS(1 ,417,:)-POS(1 ,I,:)),I
        NK=0
        DO J=33,256                    !SUM(NNTYPE(1:INDEX1(1,2) -1)) +1, SUM(NNTYPE(1:INDEX1(1,2)))
                AA=POS(1 ,I,:)-POS(1 ,J,:)
                !AA=MATMUL(ISLATORIG,AA)
                AA=MATMUL(AA,ISLATORIG)
                WHERE(AA.LT.-0.5)AA=AA+1
                WHERE(AA.GT.0.5)AA=AA-1
                !RIJ=NORM2(MATMUL(SLATORIG,AA))
                RIJ=NORM2(MATMUL(AA,SLATORIG))
                IF(RIJ.LE.RADIUS)THEN
                        NK=NK+1
                        PICK(I,NK,1)=J
!                       PRINT*,I,J,PICK(I,NK,1),RC1,RC2  !NK,NC2
                 END IF
        END DO
!PAUSE
END DO
!PRINT*,NK
!DO IK=1,12
!END DO
!PAUSE
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
DO IT=1,NSTEPORIG
        JTAG=0
        DO I=417,448 !SUM(NNTYPE(1:INDEX1(1,1)-1))+1,SUM(NNTYPE(1:INDEX1(1,1)))
        JTAG=JTAG+1
                DO IK=1,NK !#12   !!!!!!!!!!!!!!!!CORDINATION 4X3
                AA=POS(1,I,:)-POS(IT,PICK(I,IK,1),:)
                !AA=MATMUL(ISLATORIG,AA)
                AA=MATMUL(AA,ISLATORIG)
                WHERE(AA.LT.-0.5)AA=AA+1
                WHERE(AA.GE.0.5)AA=AA-1
                AA=MATMUL(AA,SLATORIG)
                MSD(JTAG,IK)=NORM2(AA)**2
                END DO
        END DO
WRITE(120,120)REAL(IT*DELT),(MSD(JTAG,1:7),JTAG=1,32)
END DO
120 FORMAT(F12.5,1000F10.2)
END SUBROUTINE



SUBROUTINE CUPSE2
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,I2,J1,J2,K1,K2,ITH
INTEGER::II,JJ,KK
DOUBLE PRECISION,DIMENSION(3)::AA
DOUBLE PRECISION::RIJ,RJK,RADIUS
INTEGER::JTAG
INTEGER,DIMENSION(32)::OCC
PRINT*, "I M IN CUPSE2"
OPEN(120,FILE="OCCUPANCY")
DO IT=1,NSTEPORIG
JTAG=0
OCC=0
RADIUS=3.5  !!!!!!2.5 Angstrom
        DO I=417,448 !SUM(NNTYPE(1:INDEX1(1,1)-1))+1,SUM(NNTYPE(1:INDEX1(1,1)))
        JTAG=JTAG+1
        DO J=33,256                    !SUM(NNTYPE(1:INDEX1(1,2) -1)) +1, SUM(NNTYPE(1:INDEX1(1,2)))
                AA=POS(1 ,I,:)-POS(IT ,J,:)
                !AA=MATMUL(ISLATORIG,AA)
                AA=MATMUL(AA,ISLATORIG)
                WHERE(AA.LT.-0.5)AA=AA+1
                WHERE(AA.GT.0.5)AA=AA-1
                RIJ=NORM2(MATMUL(AA,SLATORIG))
                IF(RIJ.LE.RADIUS)THEN
                OCC(JTAG)=OCC(JTAG)+1
                END IF
        END DO
        END DO
WRITE(120,120)REAL(IT*DELT),OCC(1:32)
END DO
120 FORMAT(F12.5,1000I3)
END SUBROUTINE


FUNCTION cross(a, b)
DOUBLE PRECISION, DIMENSION(3) :: cross
DOUBLE PRECISION, DIMENSION(3):: a, b
cross(1) = a(2) * b(3) - a(3) * b(2)
cross(2) = a(3) * b(1) - a(1) * b(3)
cross(3) = a(1) * b(2) - a(2) * b(1)
END FUNCTION cross



SUBROUTINE MSD3
USE VARIABLES1
use omp_lib
IMPLICIT NONE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::MSDX,MSDY,MSDZ,MSDGX,MSDGY,MSDGZ
INTEGER::I1,IBAC,IFOR,II1
INTEGER::M
INTEGER::NSTEPORIG2
DOUBLE PRECISION::POSINT !,CORR2
DOUBLE PRECISION,DIMENSION(NATOM,3)::CORR
DOUBLE PRECISION,DIMENSION(NATOM)::CORR3,CORR1,CORR2
DOUBLE PRECISION,ALLOCAtaBle,DIMENSION(:,:,:)::UU
ALLOCATE(MSDX(NSTEPORIG,NATOM))
ALLOCATE(MSDY(NSTEPORIG,NATOM))
ALLOCATE(MSDZ(NSTEPORIG,NATOM))
ALLOCATE(MSDGX(NSTEPORIG,NTYP))
ALLOCATE(MSDGY(NSTEPORIG,NTYP))
ALLOCATE(MSDGZ(NSTEPORIG,NTYP))
ALLOCATE(UU(NSTEPORIG,NATOM,3))
OPEN(145,FILE="MSDXYZ")
OPEN(146,FILE="MSD")
!DOUBLE PRECISION,ALLOCATABLE ,DIMENSION(:)::MSDAVG
!COMPLEX,DIMENSION(NSTEP)::MSDI
MSDX=0
MSDY=0
MSDZ=0
MSDGX=0
MSDGY=0
MSDGZ=0
NSTEPORIG2=IREF2-IREF1+1 
PRINT*,NSTEPORIG2
PRINT*, 'THE U2 IS AVERAGED FOR',NSTEPI,'LENGHT, WITH ',OINT, 'INTERVAL'
!READ*,NSTEPI
IF(NSTEPI.GT.NSTEPORIG2)NSTEPI=NSTEPORIG2
!$omp parallel do
DO I=1,NATOM
PRINT*, 'ATOM NO',I,'has been done'
                DO DT=1,NSTEPORIG2-OINT
                NSTEP1=NSTEPI
                NSTEP2=NSTEPI+DT
                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP1=NSTEPORIG2-DT
                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP2=NSTEP1+DT
                MSDX(DT,I)=SUM((POS(1:NSTEP1:OINT,I,1)-POS(1+DT:NSTEP2:OINT,I,1))**2) ! + &
                MSDY(DT,I)=SUM((POS(1:NSTEP1:OINT,I,2)-POS(1+DT:NSTEP2:OINT,I,2))**2) !
                MSDZ(DT,I)=SUM((POS(1:NSTEP1:OINT,I,3)-POS(1+DT:NSTEP2:OINT,I,3))**2) !  )
                TAO=NSTEPI
                IF(NSTEPI+DT.GT.NSTEPORIG2)TAO=NSTEPORIG2-DT
                MSDX(DT,I)=MSDX(DT,I)/REAL((TAO/OINT))
                MSDY(DT,I)=MSDY(DT,I)/REAL((TAO/OINT))
                MSDZ(DT,I)=MSDZ(DT,I)/REAL((TAO/OINT))
                END DO
!                       MSD(DT,I)=sum( (PPOS(1:nstep,:) - PPOS(1+dt:nstep+dt,:))**2 ) /dble(nt)
END DO
!$omp end parallel do
!!!!!!!!!!!!!!!!!!!!!!!!!!!!CORRELATED TERM SUM
!PRINT*, 'ATOM NO',I,'has been done'
		UU(1:NSTEPORIG2-1,:,:)=POS(2:NSTEPORIG2,:,:)-POS(1:NSTEPORIG2,:,:)

                DO DT=1,NSTEPORIG2-OINT

		DO I=1,NATOM
		CORR(I,:)=SUM(UU(1:DT,I,:),DIM=1)
		CORR1(I)=SUM(CORR(I,:)**2) !   CORR(I)**2
		CORR2(I)=SUM(UU(1:DT,I,:)*UU(1:DT,I,:)) !DIM=1))
		!PRINT*,SUM(UU(1:2,I,:)*UU(1:2,I,:))
		!PRINT*,UU(1,I,:)
		!PRINT*,UU(2,I,:)
		!PAUSE
		!	CORR=CORR+ ( UU(DT,I,:)*SUM(UU(DT+1:NSTEPORIG2-1,I,:),DIM=1)/ (SUM(UU(1:DT,I,:)*UU(1:DT,I,:))) )
		!PRINT*,SUM(UU(DT+1:NSTEPORIG2-1,I,:),DIM=2)
		!PRINT*,SUM(UU(DT+1:NSTEPORIG2-1,I,:),DIM=1)
!		PRINT*,SUM(CORR),CORR2
		!PRINT*, SUM(UU(DT+1:NSTEPORIG2-1,I,:),DIM=1)
		!PRINT*,NORM2(UU(1:DT,I,:)) !,DIM=2))
		!PRINT*,UU(DT,1,:)
		!PAUSE
		!CORR3(I)= 1 + (SUM(CORR1(I)) - CORR2(I))/(CORR2(I))
		CORR3(I)= 1 + (CORR1(I) - CORR2(I))/(CORR2(I))
!		PRINT*,CORR(1)/MSDX(DT,1)
		!PRINT*,SUM(CORR),CORR2
                END DO

		WRITE(192,98)DELT*REAL(DT), (SUM( CORR1 ( SUM(NNTYPE(1:J-1))+1 : SUM(NNTYPE(1:J))) )/NNTYPE(J), J=1,NTYP)
		WRITE(193,98)DELT*REAL(DT), (SUM( CORR2 ( SUM(NNTYPE(1:J-1))+1 : SUM(NNTYPE(1:J))) )/NNTYPE(J), J=1,NTYP)
		WRITE(194,98)DELT*REAL(DT), (SUM( CORR3 ( SUM(NNTYPE(1:J-1))+1 : SUM(NNTYPE(1:J))) )/NNTYPE(J), J=1,NTYP)
		!PRINT*, ( (SUM(NNTYPE(1:J-1))+1, SUM(NNTYPE(1:J))) , J=1,NTYP)
		!PRINT*, (SUM( CORR3 ( SUM(NNTYPE(1:J-1))+1 : SUM(NNTYPE(1:J))) ), J=1,NTYP)
!		PAUSE        
		END DO
!                       MSD(DT,I)=sum( (PPOS(1:nstep,:) - PPOS(1+dt:nstep+dt,:))**2 ) /dble(nt)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                        N1=0
                        N2=0
                        DO M=1,NTYP

                                N1=N2+1
                                N2=N1+NNTYPE(M)-1
                                DO K=N1,N2
                                MSDGX(:,M)=MSDGX(:,M)+MSDX(:,K)
                                MSDGY(:,M)=MSDGY(:,M)+MSDY(:,K)
                                MSDGZ(:,M)=MSDGZ(:,M)+MSDZ(:,K)
                                END DO
                        MSDGX(:,M)=MSDGX(:,M)/NNTYPE(M)
                        MSDGY(:,M)=MSDGY(:,M)/NNTYPE(M)
                        MSDGZ(:,M)=MSDGZ(:,M)/NNTYPE(M)
                        END DO
DO I=1,NSTEPORIG2-OINT
                WRITE(195,98)DELT*REAL(I),((MSDX(I,K)+MSDY(I,K)+MSDZ(I,K)),K=1,NATOM)
                WRITE(196,98)DELT*REAL(I),((MSDGX(I,K)+MSDGY(I,K)+MSDGZ(I,K)),K=1,NTYP)
                WRITE(197,98)DELT*REAL(I),((MSDX(I,K),MSDY(I,K),MSDZ(I,K)),K=1,NATOM)
                WRITE(198,98)DELT*REAL(I),((MSDGX(I,K),MSDGY(I,K),MSDGZ(I,K)),K=1,NTYP)
98             FORMAT(F16.6,10000F16.5)
END DO
DEALLOCATE(MSDX,MSDY,MSDZ,MSDGX,MSDGY,MSDGZ)
END SUBROUTINE

SUBROUTINE KAPPA1
USE VARIABLES1
use omp_lib
IMPLICIT NONE
INCLUDE 'fftw3.f'
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::JX,JY,JZ
integer::ik1
double precision::temp
integer::plann
COMPLEX*16,ALLOCATABLE,DIMENSION(:)::JXC,JYC,JZC !FQT,FFQTTYP!,SQWB
INTEGER::IBAC,IFOR
DOUBLE PRECISION::KB,SCAL,SCAL2
IFOR= 1
IBAC=-1
KB=8.61733326214E-5
SCAL= 1.6E3 
SCAL2=SCAL*DELT/(KB*TEMPER*TEMPER*VOL0)
PRINT*,'VOL0=',VOL0               !
PRINT*,'SCAL2=',SCAL2                !
ALLOCATE(JX(NSTEP),JY(NSTEP),JZ(NSTEP))
ALLOCATE(JXC(NSTEP),JYC(NSTEP),JZC(NSTEP))
OPEN(21,FILE="flux.txt")
DO I=1,1 !285
READ(21,*)
END DO
PRINT*,NSTEPORIG

NPOW=LOG(REAL(NSTEPORIG))/log(2.0) !0.6930  !/0.30102999566
PRINT*,NPOW
NPOW=NINT(NPOW)
!NPOW=NPOW-1
NSTEP2=2**NPOW 

DO I=1,NSTEP2 !ORIG
READ(21,*)IK1,JX(K),JY(K),JZ(K)
JX(K)=JX(K)*VOL0
JY(K)=JY(K)*VOL0
JZ(K)=JZ(K)*VOL0
END DO
        	call dfftw_plan_dft_1d(plann  ,NSTEP2,JX             ,JXC             ,IFOR,FFTW_ESTIMATE)
	        call dfftw_execute_dft(plann  , JX,JXC)
	        call dfftw_destroy_plan(plann  )
                JXC=JXC/REAL(NSTEP2)
                JXC=JXC*CONJG(JXC)
DO I=1,NSTEP2 !G
WRITE(293,293)I,JXC(I),SUM(JXC(1:I))
293 FORMAT(I8,6E15.5)
END DO
        	call dfftw_plan_dft_1d(plann  ,NSTEP2,JXC             ,JXC             ,IFOR,FFTW_ESTIMATE)
	        call dfftw_execute_dft(plann  , JXC,JXC)
	        call dfftw_destroy_plan(plann  )
                
DO I=1,NSTEP2
WRITE(292,293)I,JXC(I),SUM(JXC(1:I)),SCAL2*(SUM(JXC(1:I)))
END DO

                PRINT*,JXC

close(21)
END SUBROUTINE


SUBROUTINE KAPPA2
USE VARIABLES1
use omp_lib
IMPLICIT NONE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::JX,JY,JZ,JXC,JYC,JZC                            
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::SJXC,SJYC,SJZC                            
INTEGER::IK1,IK2
INTEGER::NSTEPORIG2
DOUBLE PRECISION::TEMP
DOUBLE PRECISION::KB,SCAL
!PRINT*,VOL0
!PAUSE
KB=8.61733326214E-5
SCAL= 1.6E3                !
JX=0
JY=0
JZ=0
JXC=0
JYC=0
JZC=0
NSTEPORIG2=IREF2-IREF1+1 
PRINT*,NSTEPORIG2
PRINT*, 'JX*JX IS AVERAGED FOR',NSTEPI,'LENGHT, WITH ',OINT, 'INTERVAL'
ALLOCATE(JX(0:NSTEPORIG2), JY(0:NSTEPORIG2),  JZ(0:NSTEPORIG2),   JXC(0:NSTEPORIG2),  JYC(0:NSTEPORIG2),   JZC(0:NSTEPORIG2))                             
ALLOCATE(SJXC(0:NSTEPORIG2),  SJYC(0:NSTEPORIG2),   SJZC(0:NSTEPORIG2))                             
!OPEN(21,FILE="KAPPA")
OPEN(21,FILE="flux.txt")
DO I=1,1 !285
READ(21,*)
END DO
DO I=1,NSTEPORIG2 
!READ(21,*)IK1,TEMP,JX(I),JY(I),JZ(I)
READ(21,*)IK1,JX(I),JY(I),JZ(I)
!JX(I)=JX(I)*VOL0
!JY(I)=JY(I)*VOL0
!JZ(I)=JZ(I)*VOL0
!PRINT 21,IK1,JX(I),JY(I),JZ(I)
21 FORMAT(I5,F10.5,3F15.5)
END DO
!READ*,NSTEPI
IF(NSTEPI.GT.NSTEPORIG2)NSTEPI=NSTEPORIG2
                
                DO DT=1,NSTEPORIG2,5
                DO IK2=0,4
                PRINT 11, DT,IK2,(JX(DT)*JX(DT+IK2)) !/REAL((TAO/OINT))! + &
                END DO
                END DO

                DO DT=0,NSTEPORIG2-OINT,NSTEPI
                NSTEP1=NSTEPI
                NSTEP2=NSTEPI+DT
                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP1=NSTEPORIG2-DT
                TAO=NSTEPI
                IF(NSTEPI+DT.GT.NSTEPORIG2)TAO=NSTEPORIG2-DT
                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP2=NSTEP1+DT
                11 FORMAT(2I6,5(F15.5,1x))        
                JXC(DT)=DOT_PRODUCT(JX(1:NSTEP1:OINT),JX(1+DT:NSTEP2:OINT)) /REAL((TAO/OINT))! + &
                JYC(DT)=DOT_PRODUCT(JY(1:NSTEP1:OINT),JY(1+DT:NSTEP2:OINT)) /REAL((TAO/OINT))!
                JZC(DT)=DOT_PRODUCT(JZ(1:NSTEP1:OINT),JZ(1+DT:NSTEP2:OINT)) /REAL((TAO/OINT))!  )

                SJXC(DT)=  SUM(JXC(0:DT))*DELT  !/(DT+1)
                SJYC(DT)=  SUM(JYC(0:DT))*DELT !/(DT+1)
                SJZC(DT)=  SUM(JZC(0:DT))*DELT  !/(DT+1)
                !SJXC(DT)=  JXC(DT)
                !SJYC(DT)=  JYC(DT)
                !SJZC(DT)=  JZC(DT)
                !SJXC(DT)= SCAL*DELT* SJXC(DT)/(KB*TEMPER*TEMPER*VOL0)
                !SJYC(DT)= SCAL*DELT* SJYC(DT)/(KB*TEMPER*TEMPER*VOL0)
                !SJZC(DT)= SCAL*DELT* SJZC(DT)/(KB*TEMPER*TEMPER*VOL0)
                !SJXC(DT)= VOL0*SCAL*DELT* SJXC(DT)/(KB*TEMPER*TEMPER)
                !SJYC(DT)= VOL0*SCAL*DELT* SJYC(DT)/(KB*TEMPER*TEMPER)
                !SJZC(DT)= VOL0*SCAL*DELT* SJZC(DT)/(KB*TEMPER*TEMPER)
                END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

DO I=0,NSTEPORIG2-NSTEPI
                WRITE(294,98)DELT*REAL(I),JXC(I),JYC(I),JZC(I)                              
                WRITE(295,98)DELT*REAL(I),SJXC(I),SJYC(I),SJZC(I),(SJXC(I)+SJYC(I)+SJZC(I))/3
98             FORMAT(F16.6,10000E16.5)
END DO
END SUBROUTINE


SUBROUTINE KAPPA3
USE VARIABLES1
use omp_lib
IMPLICIT NONE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::JX,JY,JZ  
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::SJXC,SJYC,SJZC                            
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::CC
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::CC,DD
INTEGER::IK1,IK2,ICOUNT,SINT
INTEGER::NSTEPORIG2,KK
DOUBLE PRECISION::TEMP
DOUBLE PRECISION::KB,SCAL,SCAL2
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::KAPPAX,KAPPAY,KAPPAZ
!TEMPER=200
!PRINT*,VOL0
!PAUSE
KB=8.61733326214E-5
SCAL= 1.6E3                !
SINT=OINT
SCAL2=SCAL*DELT*SINT/(KB*TEMPER*TEMPER*VOL0)
PRINT*,'VOL0=',VOL0               !
PRINT*,'SCAL2=',SCAL2                !
PRINT*,'TEMPERATURE=',TEMPER                !
PRINT*,'DELT=',DELT                !
PRINT*,'SINT=',SINT                !
JX=0
JY=0
JZ=0
!JXC=0
!JYC=0
!JZC=0
!NSTEPORIG2=IREF2-IREF1+1 
!PRINT*,NSTEPORIG2

NSTEPORIG2=NSTEPORIG/OINT

PRINT*, 'JX*JX IS AVERAGED FOR',NSTEPI,'LENGHT, WITH ',OINT, 'INTERVAL'
ALLOCATE(JX(NSTEPORIG2), JY(NSTEPORIG2),  JZ(NSTEPORIG2))                             
!ALLOCATE(JX(0:NSTEPORIG2), JY(0:NSTEPORIG2),  JZ(0:NSTEPORIG2),   JXC(0:NSTEPORIG2),  JYC(0:NSTEPORIG2),   JZC(0:NSTEPORIG2))                             
!ALLOCATE(SJXC(0:NSTEPORIG2),  SJYC(0:NSTEPORIG2),   SJZC(0:NSTEPORIG2))                             
!ALLOCATE(CC(NSTEPORIG2,NSTEPI,3))
ALLOCATE(CC(NSTEPI,3))
ALLOCATE(DD(NSTEPI,3))
ALLOCATE(KAPPAX(NSTEPORIG2 ),KAPPAY(NSTEPORIG2),KAPPAZ(NSTEPORIG2))
CC=0

!SINT=20
!OPEN(21,FILE="KAPPA")
OPEN(21,FILE="flux.txt")
DO I=1,1 !285
READ(21,*)
END DO
K=0
DO I=1,NSTEPORIG2 !,OINT
K=K+1 
!READ(21,*)IK1,TEMP,JX(I),JY(I),JZ(I)
READ(21,*)IK1,JX(K),JY(K),JZ(K)
JX(K)=JX(K)*VOL0
JY(K)=JY(K)*VOL0
JZ(K)=JZ(K)*VOL0
DO KK=1,OINT-1
READ(21,*)
END DO
!PRINT 21,IK1,JX(I),JY(I),JZ(I)
!21 FORMAT(I5,F10.5,3F15.5)
END DO
!READ*,NSTEPI
!SCAL2=1
!DO ICOUNT=1,NSTEPORIG2-1
!   DO J=1,MIN(ICOUNT,NSTEPI)
!   CC(I,J,1)=CC(I,J,1)*(ICOUNT-J)+ JX(ICOUNT)*JX(ICOUNT-J+1)
!   CC(I,J,1)=CC(I,J,1)/(ICOUNT-J+1)
!   CC(I,J,2)=CC(I,J,2)*(ICOUNT-J)+ JY(ICOUNT)*JY(ICOUNT-J+1)
!   CC(I,J,2)=CC(I,J,2)/(ICOUNT-J+1)
!   CC(I,J,3)=CC(I,J,3)*(ICOUNT-J)+ JZ(ICOUNT)*JZ(ICOUNT-J+1)
!   CC(I,J,3)=CC(I,J,3)/(ICOUNT-J+1)
!   END DO
!   KAPPAX(ICOUNT)=SUM(CC(I,:,1))  - CC(I,1,1)/2 -CC(I,NSTEPI,1)/2
!   KAPPAY(ICOUNT)=SUM(CC(I,:,2))  - CC(I,1,2)/2 -CC(I,NSTEPI,2)/2
!   KAPPAZ(ICOUNT)=SUM(CC(I,:,3))   - CC(I,1,3)/2 -CC(I,NSTEPI,3)/2
!   WRITE(295,11)ICOUNT*DELT ,SCAL2*KAPPAX(ICOUNT),SCAL2*KAPPAY(ICOUNT),SCAL2*KAPPAZ(ICOUNT)
!  ! PRINT 11 ,CC(I,:,1)  !KAPPAX(ICOUNT),KAPPAY(ICOUNT),KAPPAZ(ICOUNT)
!END DO


 CC=0
 DD=0
 I=0
!Here SINT is sample interval and OINT is NSTEPI is correlation length and OINT
NSTEPI=MIN(NSTEPI,NSTEPORIG2)
PRINT*,'NEW NSTEPI is:', NSTEPI
DO ICOUNT=1,NSTEPORIG2 !,SINT
   I=I+1
   k=0
   DO J=1,MIN(ICOUNT,NSTEPI) !,SINT
   K=K+1
   CC(K,1)=DD(K,1)*(I-K)+ JX(ICOUNT)*JX(ICOUNT-J+1)
   CC(K,1)=CC(K,1)/(I-K+1)
   CC(K,2)=DD(K,2)*(I-K)+ JY(ICOUNT)*JY(ICOUNT-J+1)
   CC(K,2)=CC(K,2)/(I-K+1)
   CC(K,3)=DD(K,3)*(I-K)+ JZ(ICOUNT)*JZ(ICOUNT-J+1)
   CC(K,3)=CC(K,3)/(I-K+1)

   DD(K,:)=CC(K,:)

!   PRINT 11 ,ICOUNT,K,CC(K,1)  !KAPPAX(ICOUNT),KAPPAY(ICOUNT),KAPPAZ(ICOUNT)
   END DO
   KAPPAX(I)=SUM(CC(:,1))  - CC(1,1)/2 -CC(NSTEPI,1)/2
   KAPPAY(I)=SUM(CC(:,2))  - CC(1,2)/2 -CC(NSTEPI,2)/2
   KAPPAZ(I)=SUM(CC(:,3))  - CC(1,3)/2 -CC(NSTEPI,3)/2
   WRITE(295,11)ICOUNT*SINT*DELT,SCAL2*KAPPAX(I),SCAL2*KAPPAY(I),SCAL2*KAPPAZ(I)
!   IF(MOD(ICOUNT,20000)==1)   WRITE(295,11)ICOUNT ,SCAL2*KAPPAX(ICOUNT),SCAL2*KAPPAY(ICOUNT),SCAL2*KAPPAZ(ICOUNT)
END DO

DO K=1,NSTEPI
   WRITE(294,11)K*SINT*DELT     ,CC(K,1),CC(K,2),CC(K,3)   
END DO
11 FORMAT(F15.5,3(E13.5,1x))
close(21)
END SUBROUTINE

!BOSE FUNCTION!!!!!!!!!!!!!!!DERIVATIVE OF BOSE FUNCTION!!!!!
DOUBLE PRECISION FUNCTION DNBOSE1(FRE,TT)
IMPLICIT NONE
DOUBLE PRECISION::FRE,BETAT,BETA1,TT
BETA1=47.99237243603648754
BETAT=BETA1/TT


IF(FRE==0)THEN
DNBOSE1=0
ELSE
!PRINT*,TT,BETAT,BETA1,FRE
DNBOSE1=BETAT*FRE*DEXP(BETAT*FRE)/(TT*(DEXP(FRE*BETAT)-1.0)*(DEXP(FRE*BETAT)-1.0))
!                         (DEXP(BETAT*FRE)-1.0)**2.0)
END IF
END FUNCTION DNBOSE1




SUBROUTINE RESIDENCENSPS2
!RADIUS BASED ANALYSIS
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,I2,J1,J2,K1,K2,ITH
INTEGER::II,JJ,KK
REAL::T2,T1
DOUBLE PRECISION,DIMENSION(3)::AA
REAL::RIJ,RJK
INTEGER::NC1,NC2
INTEGER::NCORD1,NCORD2,NK
REAL,DIMENSION(12)::ANGLEI
INTEGER::RBIN,TBIN
INTEGER,ALLOCATABLE,DIMENSION(:,:)::PICK,IPICK,IIPICK,OCCC
INTEGER::ISPACE,L
REAL::TST
DOUBLE PRECISION::VOL
INTEGER::CCAGE,SCAGE
REAL::RCAGE
REAL::XMAX,YMAX,ZMAX,XMIN,YMIN,ZMIN
DOUBLE PRECISION,DIMENSION(3,3)::DAB
INTEGER::JK,ISEL
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::CENTRE,RPICK,RRPICK,DMATRIX
INTEGER::NCENTRE,STA
DOUBLE PRECISION,allocatable,DIMENSION(:,:,:)::AB
DOUBLE PRECISION,DIMENSION(3)::XX
REAL::RANG,DET
DOUBLE PRECISION,DIMENSION(3)::LOCAL
DOUBLE PRECISION::TOL1,TOL2
integer::jtag
integer,allocatable,dimension(:)::atmloc,patmloc,ppatmloc,njump,snjump
integer::ijump
DOUBLE PRECISION,DIMENSION(NATOM,3)::POSL !DMATRIX
double precision,DIMENSION(3)::rcm1,rcm2,rr
double precision,dimension(natom,3)::P1,P2,P3
double precision,dimension(natom)::rjump,rjump2
double precision,allocatable,dimension(:,:)::RSE
double precision,allocatable,dimension(:,:)::rd
                double precision,dimension(3)::dsecui,ddr
                integer::ise
                integer,allocatable,dimension(:)::timer !pprmincuseindx
                double precision::RTOT,RTOT2,RTOT3
                double precision,dimension(0:100):: RRTOT,RRTOT2
                integer::rind
NCENTRE=NTETRA
SCAGE=3
CCAGE=ITETRA!!!!!Cu ions at centre of the cage
allocate(rse(NNTYPE(ccage),3))
OPEN(23,FILE="SITE_OCC_ATM")
OPEN(24,FILE="SITE_OCC")
OPEN(25,FILE="SITE_SEL_ATM")
OPEN(26,FILE="JUMP_EVENT_ATM")
OPEN(27,FILE="JUMP_EVENT_INTRCLUSTER")
OPEN(28,FILE="JUMP_DST_P1_P2")
OPEN(29,FILE="JUMP_DST_P1_P3")
OPEN(30,FILE="CAGE_Cu_DIS")
OPEN(131,FILE="JUMP_LENGTH_DISTRIBUTION")
RSE(:,:)=POS(1,SUM(NNTYPE(1:SCAGE-1))+1 :SUM(NNTYPE(1:SCAGE)),:)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!INPUT
rind=0
TOL1=0.0000000000000000000000000000
TOL2=1.d0
occc=0
RANG=0.5
PICK=0
IPICK=0
SNJUMP=0
RTOT=0
RTOT2=0
RRTOT=0
RRTOT2=0
ALLOCATE(PICK(NCENTRE,12),RPICK(NCENTRE,12),RRPICK(NCENTRE,12),IIPICK(NCENTRE,12),IPICK(NCENTRE,12),CENTRE(NCENTRE,3),AB(NCENTRE,3,3),OCCC(NATOM,NCENTRE))
ALLOCATE(ATMLOC(NATOM),PATMLOC(NATOM),PPATMLOC(NATOM),NJUMP(NATOM),SNJUMP(NATOM))
!allocate(rd(NNTYPE(CCAGE),3))
allocate(rd(NCENTRE,3))
allocate(timer(NCENTRE))
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
OPEN(31,FILE="TETRA")
DO I=1,8
READ(31,*)
END DO

DO I=1,NCENTRE
READ(31,*)CENTRE(I,:)
END DO

PRINT*, "I M IN RESIDENCE2"
PI=4*ATAN(1.0)
ISPACE=NNTYPE(INDEX1(1,1))
ISEL=0

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
P1(:,:)=POS(1,:,:) !!!!!!!!!!!
DO IT=1,IREF2-IREF1+1
ATMLOC=0
RD=0
        JTAG=0
        DO J=SUM (NNTYPE(1:CCAGE -1 )) +1, SUM(NNTYPE(1:CCAGE))
                JTAG=JTAG+1
                IJUMP=0
                RD(1:NCENTRE,1:3)= CENTRE(1:NCENTRE,1:3) - SPREAD(MATMUL(POS(IT,J,:),ISLATORIG),1,NCENTRE)
                WHERE(RD(1:NCENTRE,:).GT.0.5)RD=RD-1
                WHERE(RD(1:NCENTRE,:).LT.-0.5)RD=RD+1
                RD=MATMUL(RD,SLATORIG)
                ATMLOC(JTAG)=MINLOC(NORM2(RD,DIM=2),DIM=1)
                !PRINT*,NORM2(RD,DIM=2)
                !PRINT*,MINLOC(NORM2(RD,DIM=2),DIM=1)
                !PAUSE
!               timer(jtag)=timer(jtag)+1
                IF(IT.EQ.1.AND.ATMLOC(JTAG).NE.0)PATMLOC(JTAG)=ATMLOC(JTAG)
                IF(IT.EQ.1.AND.ATMLOC(JTAG).NE.0)PPATMLOC(JTAG)=ATMLOC(JTAG)
                IF(IT.GT.1.and.patmloc(jtag).ne.atmloc(jtag).and.ATMLOC(JTAG).ne.0)then
                timer(jtag)=timer(jtag)+1
                

                IF(TIMER(JTAG).GT.10.AND.PATMLOC(JTAG).ne.ATMLOC(JTAG))THEN
                P3(J,:)=P2(J,:)
                P2(J,:)=P1(J,:)
                P1(J,:)=POS(IT,J,:)
!                RJUMP(J)=NORM2(P2(J,:)-P1(J,:))


                DDR=CENTRE(ATMLOC(JTAG),:)-CENTRE(PATMLOC(JTAG),:)
                WHERE(DDR.LE.-0.5)DDR=DDR+1
                WHERE(DDR.GE.0.5)DDR=DDR-1
                !RJUMP(J)=NORM2(MATMUL(CENTRE(ATMLOC(JTAG),:)-CENTRE(PATMLOC(JTAG),:),SLATORIG))
                RJUMP(J)=NORM2(MATMUL(DDR,SLATORIG))
                RIND=INT(real(RJUMP(J))/0.1) !!!!!!!!!!!!!!!!!!!Binning with 0.1 Angstrom
                NJUMP(JTAG)=NJUMP(JTAG)+1
                RTOT=RTOT+RJUMP(J)
                IF(RIND.LE.100)RRTOT(RIND)=RRTOT(RIND)+1
                PATMLOC(JTAG)=ATMLOC(JTAG)
                timer(jtag)=0
                end if
                end if
        END DO
                !print*,timer(1),atmloc(1)
!               if(mod(it,1000)==0)pause
                N1=SUM(NNTYPE(1:ccage-1))+1
                N2=SUM(NNTYPE(1:ccage))
                WRITE(28,28)REAL(DELT*IT),RJUMP(N1:N2)
                WRITE(29,28)REAL(DELT*IT),RJUMP2(N1:N2)
                !WRITE(30,28)REAL(DELT*IT),rmincuse      
                WRITE(25,25)IT*DELT,ATMLOC(1:NNTYPE(CCAGE))
                25 FORMAT(F10.5,10000I7)
                28 FORMAT(F10.5,10000E12.5)
                24 FORMAT(4I5,2x,3F10.5)
                WRITE(26,26)IT*DELT,NJUMP(:)
                26 FORMAT(F12.5,1000I5)
                WRITE(27,26)IT*DELT,SNJUMP(:)-1
END DO

        JTAG=0
        DO J=SUM (NNTYPE(1:CCAGE -1 )) +1, SUM(NNTYPE(1:CCAGE))
        JTAG=JTAG+1
        DO I=1,ISEL
        WRITE(23,323)J,I,REAL(OCCC(JTAG,I))/REAL(NSTEPORIG)
        END DO
        323 FORMAT(2I10,E12.5)
        324 FORMAT(I10,E12.5)
        END DO

        DO I=1,ISEL
        WRITE(24,324)I,REAL(SUM(OCCC(:,I)))/REAL(SUM(OCCC))
        END DO

        DO I=0,100
        WRITE(131,31)0.1*REAL(I),RRTOT(I)/REAL(SUM(NJUMP))  !,RRTOT2(I)/REAL(SUM(SNJUMP)-NNTYPE(CCAGE))
        31 FORMAT(F10.5,2F20.10)
        END DO

        PRINT*,'SUM OF inter-cluster JUMP',SUM(NJUMP)  !-NNTYPE(CCAGE)
        PRINT*,'SUM OF inter-cluster JUMPLENGTHS',RTOT !,RTOT3
        PRINT*,'AVG inter-cluster RESIDENCETIME',(NSTEPORIG*DELT)*NNTYPE(CCAGE)/SUM(NJUMP)  !-NNTYPE(CCAGE))


END SUBROUTINE

SUBROUTINE GRRFN2LAMMPS
use omp_lib
USE VARIABLES1
IMPLICIT NONE
!DOUBLE PRECISION,DIMENSION(NATOM,3)::POSF
DOUBLE PRECISION,DIMENSION(NATOm,3)::AA
DOUBLE PRECISION::MODA
DOUBLE PRECISION,DIMENSION(NATOM,NATOM)::GRR
DOUBLE PRECISION,DIMENSION(1000,NTYP,NTYP)::GRRT
DOUBLE PRECISION::R1,R2
INTEGER::IDR
INTEGER::K1,K2,K3,K4
!DOUBLE PRECISION,DIMENSION(NATOM,27,3)::SPOS
INTEGER::NS,INS,NX,NY,NZ,I1
DOUBLE PRECISION::DV,AREA,XD,YD,ZD
DOUBLE PRECISION,DIMENSION(NATOM)::AMODA
AA=0
PRINT*, "I M IN GRRFN LAMPPS2"
PRINT*,IT
WRITE(111,*)'# TIME=IT,LL',IT,LL
GRRT=0
DO IDR=1,NR
   R1=((IDR-1)*DELR)+R0
   R2=((IDR)*DELR)+R0
   RM=(R1+R2)*0.5
   GRR=0
!$omp parallel do
   DO I=1,NATOM
      DO J=I,NATOM
            AA(I,:)= RR1(I,:)-RR1(J,:)  !POS(IT,I,:)-POS(IT,J,:)
	    WHERE(AA(I,:).LE.-0.5)AA(I,:)=AA(I,:)+1
	    WHERE(AA(I,:).gE.0.5)AA(I,:)=AA(I,:)-1
            !AA(I,:)=MATMUL(TRANSPOSE(SLAT),AA(I,:))                       !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!CHECK
            AA(I,:)=MATMUL(AA(I,:),SLAT)                       !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!CHECK
            AMODA(I)=NORM2(AA(I,:))
            !PRINT*,POS(IT,I,:),POS(IT,J,:),AA,AMODA
            IF(AMODA(I).GT.R1.AND.AMODA(I).LE.R2)GRR(I,J)=GRR(I,J)+1
	    !print*,rr1(i,:),pos(it,i,:) !aa(i,j,:),amoda(i,J)
            !print*,matmul(transpose(slatorig),rr1(i,:))
            !print*,aa(i,j,:),amoda(i,J)
            !pause
102       FORMAT(F3.1,2I4,F5.1)
          GRR(J,I)=GRR(I,J)
          GRTOTAL(IDR)=GRTOTAL(IDR)+GRR(I,J) 
      END DO
   END DO
!$omp end parallel do

   DO I=1,NTYP
      DO J=1,NTYP
        K1=SUM(NNTYPE(1:I-1))+1
        K2=SUM(NNTYPE(1:I))
        K3=SUM(NNTYPE(1:J-1))+1
        K4=SUM(NNTYPE(1:J))
        GRRT(IDR,I,J)=SUM(GRR(K1:K2,K3:K4))
        GRRT(IDR,I,J)=GRRT(IDR,I,J)/((K2-k1+1))
!        GRRT(IDR,J,I)=GRRT(IDR,I,J)
        END DO
   END DO
!!!!!$omp parallel do
!!!!$omp end parallel do
   AREA=4.0*PI*(RM**2)
   DV=AREA*DELR
   GRRT(IDR,:,:)=GRRT(IDR,:,:)/DV
   !GRTOTAL(IDR)=SUM(GRR(:,:))/(DV*NATOM)
   GRTOTAL(IDR)=GRTOTAL(IDR)/(DV*NATOM)
   WRITE(111,11)RM ,((GRRT(IDR,I,J),J=I,NTYP),I=1,NTYP),GRTOTAL(IDR) !,SUM(GRRT(IDR,:,:))
   11 FORMAT(F6.3,2x,100F8.4)
  ! WRITE(101,101)IDR*DELR, (INT((GRR(1,I1))),I1=1,64)
   101 format (F4.1,100I3)
END DO
!!!!!!!!!!!!!!!!!!
DO IDR=1,NR
   DO I=1,NTYP
      DO J=1,NTYP
      GRRTAVG(IDR,I,J)=GRRTAVG(IDR,I,J)+GRRT(IDR,I,J)
      END DO
   END DO
      GAVG(IDR)=GAVG(IDR)+GRTOTAL(IDR)
END DO


!RMAX=INT((GRCUT-R0)/DELR)
!ASTATUS=ANY(GRTOTAL(1:RMAX).GT.0,DIM = 1)
!PRINT*,RMAX,ASTATUS



!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!
!IF(IT.EQ.IREF2-IREF1)THEN
!DO IDR=1,NR
!WRITE(83,83)R0+(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(LL),J=I,NTYP),I=1,NTYP),GAVG(IDR)/REAL(LL)
!WRITE(83,83)R0+(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(IPOINTS),J=I,NTYP),I=1,NTYP),GAVG(IDR)/REAL(IPOINTS)
!END DO
!END IF
!83 FORMAT(F6.3,2x,100F8.4)
END SUBROUTINE



SUBROUTINE IIFQT4OLD(IQQQQ)   !!!!!!!!!!THIS IS with velcoity projection
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::AFQT!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::FFQTTYP!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::CFFQTTYP !,SQWB
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
REAL,DIMENSION(NSTEP)::PHASE1
DOUBLE PRECISION::PHASE11
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::II1,I1,DT1,III
!DOUBLE  PRECISION,ALLOCATABLE,DIMENSION(:,:)::KLIST
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DUMMY2,DUMMY4
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMYT
DOUBLE PRECISION::EE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK
INTEGER::ITYPPP,JTYPPP
INTEGER::IQQQQ,NNN2
CHARACTER::AA*10
INTEGER::NTYP2,NTYP3
INTEGER::IJ1,IJ2
INTEGER::IQTCAL
integer,allocatable,dimension(:)::plan
integer::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMY1,DUMMY5
IQTCAL=0         !!!!DO  NOT CALCLATE FQT

!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::AAA
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::BBB
!Integer :: Status
!Complex,ALLOCATABLE,DIMENSION(:) :: AAAA
NTYP2=1            !NTYP*(NTYP+1)/2
NTYP3=NTYP*(NTYP+1)/2
PRINT*,NTYP2
WRITE(AA,'("VCSQWTOT",I2.2)')IQQQQ
OPEN(170,FILE=AA)
WRITE(AA,'("VISQWTOT",I2.2)')IQQQQ
OPEN(180,FILE=AA)
IF(IQTCAL==1)WRITE(AA,'("VCIQTTOT",I2.2)')IQQQQ
IF(IQTCAL==1)OPEN(190,FILE=AA)
IF(IQTCAL==1)WRITE(AA,'("VIIQTTOT",I2.2)')IQQQQ
IF(IQTCAL==1)OPEN(200,FILE=AA)
OPEN(17,FILE="CSQ")
OPEN(18,FILE="ISQ")
IF(IQTCAL==1) OPEN(19,FILE="CIQ")
IF(IQTCAL==1)OPEN(20,FILE="IIQ")
PRINT*,'I AM IN IFFQT'
ALLOCATE(AFQT(1:NSTEP,NATOM,3))
!ALLOCATE(AAAA(NSTEP))
!ALLOCATE(AAA(NATOM,2*NSTEP))
!ALLOCATE(BBB(2*NSTEP))
ALLOCATE(FFQTTYP(1:NSTEP,NTYP))
ALLOCATE(CFFQTTYP(1:NSTEP,NTYP,NTYP))
ALLOCATE(DUMMY1(NSTEP),DUMMY5(NSTEP))
allocate(plan(NATOM))

AFQT=0
FFQTTYP=0
CFFQTTYP=0
IFOR= 1
IBAC=-1

PRINT*,AVGISLAT
PRINT*,NTYP

IF(ILIST.LT.3)THEN
WRITE(AA,'("KKLIST",I2.2)')IQQQQ
OPEN(44,FILE=AA)
I=0
DO  
I=I+1 
READ(44,*,END=100)KLIST(I,:)
END DO
100 CONTINUE
NQ=I-1
I=0
PRINT*,'NQ',NQ
ALLOCATE(QQ(NQ,3),QK(NQ,3))
ALLOCATE(DUMMY2(NQ,1,NSTEP),DUMMY4(NQ,1,NSTEP))
END IF

IF(ILIST.GE.3)THEN
NQ=1  !IQQQQ 
PRINT*,KLIST(NQ,:)
ALLOCATE(QQ(NQ,3),QK(NQ,3))
ALLOCATE(DUMMY2(NQ,1,NSTEP),DUMMY4(NQ,1,NSTEP))
END IF
ALLOCATE(DUMMYT(NSTEP),KSELF(NTYP))
PRINT*,'NSTEP',NSTEP
PRINT*,'AVGISLAT'
PRINT*,AVGISLAT
PRINT*,'NSTEP',NSTEP
DO IQ=1,NQ
	FFQTTYP=0
	CFFQTTYP=0
	PRINT*,'IQ=',IQ
	QQ(IQ,:)=KLIST(IQ,:) !VEC
	IF(ICARTESIAN==1)THEN
	KVEC=KLIST(IQ,:)
	ELSE
	!KVEC=2.0*PI*MATMUL(KLIST(IQ,:),AVGISLAT)        !CHANGED AVGISLAT TO ISLAT
	KVEC=2.0*PI*MATMUL(AVGISLAT,KLIST(IQ,:))        !RECIPROCAL IS TRANSPOSE OF AVGISLAT, HENCE MULTIPLY OTHERWAY 
	END IF
	QK(IQ,:)=KVEC
	DO I=1,NATOM
		PHASE11=DOT_PRODUCT(KVEC,POS(1 ,I,:))
		!$omp parallel do
		DO IT=1,NSTEP 
		AFQT(IT,I,:)=SQRT(MASS(I))*VEL(IT,I,:)*CMPLX(COS(PHASE11),SIN(PHASE11))
		END DO
		!$omp end parallel do
   
		!DO IT=NSTEPORIG+1,NSTEP
		!FQT(IT,I)=FQT(NSTEPORIG,I)
		!END DO

	call dfftw_plan_dft_1d(plann,NSTEP,AFQT(:,I,1),AFQT(:,I,1),IFOR,FFTW_ESTIMATE)
	call dfftw_execute_dft(plann, AFQT(:,I,1),AFQT(:,I,1))
	call dfftw_destroy_plan(plann)
	call dfftw_plan_dft_1d(plann,NSTEP,AFQT(:,I,2),AFQT(:,I,2),IFOR,FFTW_ESTIMATE)
	call dfftw_execute_dft(plann, AFQT(:,I,2),AFQT(:,I,2))
	call dfftw_destroy_plan(plann)
	call dfftw_plan_dft_1d(plann,NSTEP,AFQT(:,I,3),AFQT(:,I,3),IFOR,FFTW_ESTIMATE)
	call dfftw_execute_dft(plann, AFQT(:,I,3),AFQT(:,I,3))
	call dfftw_destroy_plan(plann)
	AFQT(:,I,:)=AFQT(:,I,:)/REAL(NSTEPORIG)

	END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!INCOHERENT CALCULATION 
IF (ICOH==0.OR.ICOH==3)THEN               !INCOHRENT CASE
PRINT*,'I AM IN INCOHERENT'
	DO ITYPPP=1,1 !NTYP
	!DO I=SUM(NNTYPE(1:ITYPPP-1))+1,SUM(NNTYPE(1:ITYPPP)) !NATOM
	DO I=1,NATOM !SUM(NNTYPE(1:ITYPPP-1))+1,SUM(NNTYPE(1:ITYPPP)) !NATOM
	 FFQTTYP(1:NSTEP,ITYPPP)=FFQTTYP(1:NSTEP,ITYPPP)+ SUM(AFQT(1:NSTEP,I,:)*CONJG(AFQT(1:NSTEP,I,:)),DIM=2)
	END DO
	END DO
	!####!SQW SQW SQW SQW SQW SQW SQW SQW SQW SQW SQW SQWS SQWS SQW 
	DO DT=1,NSTEP
	WRITE(18,15)REAL(DT)*DELT,REAL(FFQTTYP(DT,1:NTYP))  ,SUM(REAL(FFQTTYP(DT,:))) , SUM(AIMAG(FFQTTYP(DT,:))) !/REAL(FFQTTYP(1,:)) !,SUM(REAL(FFQTTYP(DT,1:NTYP)))/SUM(REAL(FFQTTYP(1,1:NTYP))) !NATOM
	END DO
END IF

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!COHERENT CASE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	IF (ICOH==1.or.ICOH==3)THEN               !COHRENT CASE
	PRINT*,'I AM IN COHERENT'
	CFFQTTYP=0
	!$omp parallel do
	DO ITYPPP=1,1  ! NTYP
	DO JTYPPP=1,1  !ITYPPP,NTYP
	DO I=1,NATOM   !SUM(NNTYPE(1:ITYPPP-1))+1,SUM(NNTYPE(1:ITYPPP)) !NATOM
	DO J=1,NATOM   !SUM(NNTYPE(1:JTYPPP-1))+1,SUM(NNTYPE(1:JTYPPP)) !NATOM
	CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP)=CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP)+SUM(AFQT(1:NSTEP,I,:)*CONJG(AFQT(1:NSTEP,J,:)),DIM=2)
	END DO
	END DO
	END DO
	END DO
	!$omp end parallel do
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	DO DT=1,NSTEP
	!WRITE(17,15) REAL(DT)*DELT, ( ( REAL(CFFQTTYP(DT,IJ1,IJ2)) , IJ2=IJ1,NTYP ),IJ1=1,NTYP) ! ,SUM(REAL(CFFQTTYP(DT,:,:)))/SUM(REAL(CFFQTTYP(1,:,:))) !NATOM
	WRITE(17,15) REAL(DT)*DELT,  REAL(CFFQTTYP(DT,1,1)) !, IJ2=IJ1,NTYP ),IJ1=1,NTYP) ! ,SUM(REAL(CFFQTTYP(DT,:,:)))/SUM(REAL(CFFQTTYP(1,:,:))) !NATOM
	END DO

END IF
END DO    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!QLOOP ENDS
REWIND(17)
REWIND(18)
REWIND(19)
REWIND(20)

IF(ICOH==0.OR.ICOH==3)THEN
	DO IQ=1,NQ
	DO DT=1,NSTEP
	READ(18,15)EE,DUMMY2(IQ,1,DT) !,DUMMY1(IQ,DT) !,ITYP=1,NTYP)
	END DO
	END DO
		DO DT=1,NSTEP
		OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
		WRITE(180,15)OMEGA,( SUM(DUMMY2(1:NQ,1,DT)) / NQ ) !,SUM(DUMMY2(1:NQ,:,DT))/NQ
		END DO
END IF

IF(ICOH==1.OR.ICOH==3)THEN
	DO IQ=1,NQ
	DO DT=1,NSTEP
	READ(17,15)EE,DUMMY2(IQ,1,DT) !,DUMMY1(IQ,DT) !,ITYP=1,NTYP)
	END DO
	END DO
DUMMY1=SUM(DUMMY2(1:NQ,1,:),DIM=1 ) /NQ
!print*,'typ',IBROAD
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY5)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY5)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY5)
WHERE(DUMMY5.LE.1.0E-10)DUMMY5=0
	DO DT=1,NSTEP/2
	OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        !WRITE(170,15)OMEGA,  DUMMY15(DT) 
	WRITE(170,15)OMEGA,  DUMMY5(DT)  
	END DO

END IF
	17 FORMAT(A12,2X,3F10.5)
	15 FORMAT(F15.4,1003E20.2)
	170 FORMAT(A12,100(3X,3F6.2,3X))
	172 FORMAT(A12,<NQ>(3X,3F6.2,3X),6X,'AVG OVER Q')
	171 FORMAT(A3,12X,<NTYP>(8X,'avg',A3,10X) )
	173 FORMAT(A3,12X,<NTYP2>(8X,'avg',2A3,10X) )
CLOSE(170)
CLOSE(180)
CLOSE(190)
CLOSE(200)
CLOSE(17)
CLOSE(18)
CLOSE(19)
CLOSE(20)
CLOSE(44)
DEALLOCATE(DUMMY1,DUMMY2,DUMMY4,DUMMY5)
DEALLOCATE(AFQT)
END SUBROUTINE



SUBROUTINE IIFQT4(IQQQQ,QHKL)   !!!!!!!!!!THIS IS with velcoity projection
use omp_lib
USE VARIABLES1, only :ICARTESIAN,PI,AVGISLAT,POSSTART,MASS,VEL,NSTEPORIG,ICOH,IBROAD,FWHM0,FWHM1,NTYP,NSTEP,NATOM,DELT,ICUT
IMPLICIT NONE
INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::AFQT!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::tempd,cout !,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::CFFQTTYP !,SQWB
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1,QHKL
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
REAL,DIMENSION(NSTEP)::PHASE1
DOUBLE PRECISION,DIMENSION(NATOM)::PHASE11
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::II1,I1,DT1,III
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DUMMY2,DUMMY4
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMYT
DOUBLE PRECISION::EE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK !,tempd
INTEGER::ITYPPP,JTYPPP
INTEGER::IQQQQ,NNN2
CHARACTER::AA*10
INTEGER::NTYP2,NTYP3
INTEGER::IJ1,IJ2
INTEGER::IQTCAL
integer,allocatable,dimension(:)::plan
integer,dimension(natom)::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMY1,DUMMY5
INTEGER::DT,IT
REAL::OMEGA
INTEGER::I,J
integer,dimension(9)::desca,descb,descc
integer::ia,ja,ib,jb,ic,jc,m,n,k
integer,dimension(1,NATOM)::lda,ldb,ldc
real::alpha,beta
m=natom
n=natom
k=3
alpha=1
beta=0
PRINT*,'I M IN SED'

IF(ICUT==1)WRITE(AA,'("SEDTOT",I4.4)')IQQQQ
IF(ICUT==1)OPEN(IQQQQ,FILE=AA)
OPEN(9999,FILE='SEDTOTAL',ACCESS='APPEND')
!WRITE(AA,'("VISQWTOT",I2.2)')IQQQQ
!OPEN(IQQQQ+1,FILE=AA)
!PRINT*,'I AM IN IFFQT'
!PRINT*,'RUNNING IQ',IQQQQ
PRINT*, QHKL
ALLOCATE(AFQT(1:NSTEP,NATOM,3))
ALLOCATE(CFFQTTYP(1:NSTEP,1,1))
ALLOCATE(DUMMY1(NSTEP),DUMMY5(NSTEP))
allocate(plan(NATOM))
AFQT=0
CFFQTTYP=0
IFOR= 1
IBAC=-1
NQ=1
ALLOCATE(QQ(NQ,3),QK(NQ,3))
!ALLOCATE(tempd(NSTEP,NATOM))
ALLOCATE(COUT(NATOM,NATOM))
!PRINT*,'NSTEP',NSTEP
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!DO IQ=1,NQ            !NQ IS 1 Since we enter the manual hkl values
        IQ=1
        CFFQTTYP=0
        QQ(IQ,:)=QHKL    !KLIST(IQ,:) !VEC
        IF(ICARTESIAN==1)THEN
        KVEC=QHKL        !KLIST(IQ,:)
        ELSE
        !KVEC=2.0*PI*MATMUL(QHKL,AVGISLAT)        !CHANGED AVGISLAT TO ISLAT
        KVEC=2.0*PI*MATMUL(AVGISLAT,QHKL )        !CHANGED AVGISLAT TO ISLAT
        END IF
        QK(IQ,:)=KVEC
!        !$omp parallel do
        DO I=1,NATOM
        PHASE11(I)=DOT_PRODUCT(KVEC,POSSTART(I,:))
        AFQT(:,I,:)=SQRT(MASS(I))*VEL(:,I,:)*CMPLX(COS(PHASE11(I)),SIN(PHASE11(I)))
        call dfftw_plan_dft_1d(plann(i),NSTEP,AFQT(:,I,1),AFQT(:,I,1),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann(i), AFQT(:,I,1),AFQT(:,I,1))
        call dfftw_destroy_plan(plann(i))
        call dfftw_plan_dft_1d(plann(i),NSTEP,AFQT(:,I,2),AFQT(:,I,2),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann(i), AFQT(:,I,2),AFQT(:,I,2))
        call dfftw_destroy_plan(plann(i))
        call dfftw_plan_dft_1d(plann(i),NSTEP,AFQT(:,I,3),AFQT(:,I,3),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann(i), AFQT(:,I,3),AFQT(:,I,3))
        call dfftw_destroy_plan(plann(i))
        AFQT(:,I,:)=AFQT(:,I,:)/REAL(NSTEPORIG)
        END DO
!        !$omp end parallel do
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!INCOHERENT CALCULATION 
!IF (ICOH==0.OR.ICOH==3)THEN               !INCOHRENT CASE
!PRINT*,'I AM IN INCOHERENT'
        !DO ITYPPP=1,1 !NTYP
        !DO I=SUM(NNTYPE(1:ITYPPP-1))+1,SUM(NNTYPE(1:ITYPPP)) !NATOM
        !DO I=1,NATOM !SUM(NNTYPE(1:ITYPPP-1))+1,SUM(NNTYPE(1:ITYPPP)) !NATOM
        ! CFFQTTYP(1:NSTEP,1,1)=CFFQTTYP(1:NSTEP,1,1)+ SUM(AFQT(1:NSTEP,I,:)*CONJG(AFQT(1:NSTEP,I,:)),DIM=2)
        !END DO
        !END DO
        !DUMMY1=REAL(CFFQTTYP(:,1,1))     
        !DUMMY1=REAL(FFQTTYP(:,1)) !      SUM(DUMMY2(1:NQ,1,:),DIM=1 ) /NQ
        !print*,'typ',IBROAD
        !IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY5)
        !IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY5)
        !IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY5)
        !WHERE(DUMMY5.LE.1.0E-10)DUMMY5=0
        !DO DT=1,NSTEP
        !OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        !WRITE(180,15)OMEGA,DUMMY5(DT)
        !END DO
!END IF
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!COHERENT!CASE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


!IF (ICOH==1.or.ICOH==3)THEN               !COHRENT CASE
!        PRINT*,'I AM IN COHERENT'
!        CFFQTTYP=0
!        DO I=1,NATOM   !SUM(NNTYPE(1:ITYPPP-1))+1,SUM(NNTYPE(1:ITYPPP)) !NATOM
!        tempd=0
!        PRINT*,'ATM',I
        !!$omp parallel do
!        DO J=1,NATOM   !SUM(NNTYPE(1:JTYPPP-1))+1,SUM(NNTYPE(1:JTYPPP)) !NATOM
!        tempd(:,j)=SUM(AFQT(1:NSTEP,I,:)*CONJG(AFQT(1:NSTEP,J,:)),DIM=2)
        !IF(I==J)tempd(:,j)=SUM(AFQT(1:NSTEP,I,:)*CONJG(AFQT(1:NSTEP,J,:)),DIM=2)
        !IF(I.ne.J)tempd(:,j)=2.0*REAL(SUM(AFQT(1:NSTEP,I,:)*CONJG(AFQT(1:NSTEP,J,:)),DIM=2))
!        END DO
        !!$omp end parallel do

!        CFFQTTYP(1:NSTEP,1,1)=CFFQTTYP(1:NSTEP,1,1)+sum(tempd(1:NSTEP,:),DIM=2) !   tempdSUM(AFQT(1:NSTEP,I,:)*CONJG(AFQT(1:NSTEP,J,:)),DIM=2)
!        END DO


        !THIS WORKS WELL BUT PROBLEM IS WITH DIMENSION OF LARGE SYSTEM
        !CFFQTTYP=0
        !!$omp do
        !DO IT=1,NSTEP !NATOM   !SUM(NNTYPE(1:ITYPPP-1))+1,SUM(NNTYPE(1:ITYPPP)) !NATOM
        !CFFQTTYP(IT,1,1)= SUM(MATMUL(AFQT(IT,:,:),TRANSPOSE(CONJG(AFQT(IT,:,:))))) ! + MATMUL(AFQT(IT,:,2),TRANSPOSE(CONJG(IT,:,2))) + MATMUL(AFQT(IT,:,3),TRANSPOSE(CONJG(IT,:,3)) ) )
        !END DO
        !!$omp end do

        !!$omp parallel  do
!        DO IT=1,NSTEP
!	PRINT*,IT
!        COUT=MATMUL(AFQT(IT,:,:),TRANSPOSE(AFQT(IT,:,:)))
!        !call cgemm('N','N',m,n,k,alpha,AFQT(IT,:,:),NATOM,TRANSPOSE(AFQT(IT,:,:)),NATOM,beta,cout,natom)
!        CFFQTTYP(IT,1,1)= SUM(COUT) ! + MATMUL(AFQT(IT,:,2),TRANSPOSE(CONJG(IT,:,2))) + MATMUL(AFQT(IT,:,3),TRANSPOSE(CONJG(IT,:,3)) ) )
!	PRINT*,IT,'DONE'
!        END DO
        !!$omp end parallel  do


        CFFQTTYP=0
        !$omp parallel do
        DO IT=1,NSTEP
!	PRINT*,IT
!        CFFQTTYP(IT,1,1)=SUM(REAL(AFQT(IT,:,1)))**2 - NORM2(REAL(AFQT(IT,:,1)))**2  + SUM(AIMAG(AFQT(IT,:,1)))**2 - DOT_PRODUCT(AIMAG(AFQT(IT,:,1)),AIMAG(AFQT(IT,:,1)) )  - DOT_PRODUCT(AFQT(IT,:,1),CONJG(AFQT(IT,:,1))) & !   SUM(ABS(AFQT(It,:,1)) )       &
!        + SUM(REAL(AFQT(IT,:,2)))**2 - NORM2(REAL(AFQT(IT,:,2)))**2  + SUM(AIMAG(AFQT(IT,:,2)))**2 - DOT_PRODUCT(AIMAG(AFQT(IT,:,2)),AIMAG(AFQT(IT,:,2))) - DOT_PRODUCT(AFQT(IT,:,2),CONJG(AFQT(IT,:,2))) & !+ SUM(ABS(AFQT(It,:,2)) )         &
!        + SUM(REAL(AFQT(IT,:,3)))**2 - NORM2(REAL(AFQT(IT,:,3)))**2  + SUM(AIMAG(AFQT(IT,:,3)))**2 - DOT_PRODUCT(AIMAG(AFQT(IT,:,3)),AIMAG(AFQT(IT,:,3))) - DOT_PRODUCT(AFQT(IT,:,3),CONJG(AFQT(IT,:,3))) ! + SUM(ABS(AFQT(It,:,3)) )         
        

        CFFQTTYP(IT,1,1)=SUM(AFQT(IT,:,1) *CONJG(AFQT(IT,:,1)))   + SUM(AFQT(IT,:,2) *CONJG(AFQT(IT,:,2))) + SUM(AFQT(IT,:,3) *CONJG(AFQT(IT,:,3)))

!CFFQTTYP(IT,1,1)=REAL(SUM(AFQT(IT,:,1)))**2   + AIMAG(SUM(AFQT(IT,:,1)))**2 + REAL(SUM(AFQT(IT,:,2)))**2   + AIMAG(SUM(AFQT(IT,:,2)))**2 + REAL(SUM(AFQT(IT,:,3)))**2   + AIMAG(SUM(AFQT(IT,:,3)))**2 
        END DO
        !$omp end parallel do
!        PRINT*,CFFQTTYP(1,1,1)

!        CFFQTTYP=0

!        DO I=1,NATOM !SUM(NNTYPE(1:ITYPPP-1))+1,SUM(NNTYPE(1:ITYPPP)) !NATOM
        !!$omp parallel do
!        DO J=1,NATOM !SUM(NNTYPE(1:JTYPPP-1))+1,SUM(NNTYPE(1:JTYPPP)) !NATOM
        !tempd(1:nstep,j)=(FQT(1:NSTEP,I))*CONJG(FQT(1:NSTEP,J))
!        CFFQTTYP(1,1,1)=CFFQTTYP(1,1,1)+ DOT_PRODUCT(AFQT(1,I,:),CONJG(AFQT(1,J,:)))    ! SUM(AFQT(1,I,:)*CONJG(AFQT(1,J,:)))
!        END DO
        !!$omp end parallel do
!        END DO
!        PRINT*,CFFQTTYP(1,1,1)


 
        DUMMY1=  REAL(CFFQTTYP(:,1,1)) !      SUM(DUMMY2(1:NQ,1,:),DIM=1 ) /NQ
        IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY5)
        IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY5)
        IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY5)
        WHERE(DUMMY5.LE.1.0E-10)DUMMY5=0
        IF(ICUT==1)THEN
        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        WRITE(IQQQQ,15) OMEGA, DUMMY5(DT)
        END DO
        END IF
        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        WRITE(9999,15) OMEGA, DUMMY5(DT)
        END DO
!END IF
        17 FORMAT(A12,2X,3F10.5)
        15 FORMAT(F15.4,1003E20.2)
        170 FORMAT(A12,100(3X,3F6.2,3X))
        172 FORMAT(A12,<NQ>(3X,3F6.2,3X),6X,'AVG OVER Q')
        171 FORMAT(A3,12X,<NTYP>(8X,'avg',A3,10X) )
        173 FORMAT(A3,12X,<NTYP2>(8X,'avg',2A3,10X) )
        IF(ICUT==1)CLOSE(IQQQQ)
close(9999)
DEALLOCATE(DUMMY1,DUMMY5)
DEALLOCATE(AFQT)
END SUBROUTINE


SUBROUTINE IIFQT5(IQQQQ,QHKL)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::FQT,FFQTTYP!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::CFFQTTYP,IFFQTTYP!,SQWB
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1,QHKL
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::tempd !,SQWB
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
REAL,DIMENSION(NSTEP)::PHASE1
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::II1,I1,DT1,III
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DUMMY2,DUMMY4
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMYT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMY1,DUMMY5
DOUBLE PRECISION::EE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK
INTEGER::ITYPPP,JTYPPP
INTEGER::IQQQQ,NNN2
CHARACTER::AA*11
INTEGER::NTYP2
INTEGER::IJ1,IJ2
INTEGER::IQTCAL
integer,allocatable,dimension(:)::plan
integer::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
!#IF(ICUT==1)WRITE(AA,'("CSQWTOT",I4.4)')IQQQQ
!#IF(ICUT==1)OPEN(IQQQQ,FILE=AA)
!IF(ICUT==1)WRITE(AA,'("ISQWTOT",I4.4)')IQQQQ
!IF(ICUT==1)OPEN(IQQQQ+100,FILE=AA)
IF(ICUT==1)WRITE(AA,'("TSQWTOT",I4.4)')IQQQQ
IF(ICUT==1)OPEN(IQQQQ+9999,FILE=AA)
OPEN(9999,FILE='SQETOTAL',ACCESS='APPEND')
!OPEN(9997,FILE='CSQETOTAL',ACCESS='APPEND')
!OPEN(9998,FILE='ISQETOTAL',ACCESS='APPEND')
PRINT*,'I AM IN IFFQT'
ALLOCATE(FQT(1:NSTEP,NATOM))
ALLOCATE(CFFQTTYP(1:NSTEP,1,1))
ALLOCATE(IFFQTTYP(1:NSTEP,1,1))
allocate(plan(NATOM))
!allocate(tempd(nstep,natom))
ALLOCATE(DUMMY1(NSTEP),DUMMY5(NSTEP))
FQT=0
CFFQTTYP=0
IFOR= 1
IBAC=-1
NQ=1
PRINT*,QHKL
ALLOCATE(QQ(NQ,3),QK(NQ,3))
        CFFQTTYP=0
        IF(ICARTESIAN==1)THEN
        KVEC=QHKL
        ELSE
        !KVEC=2.0*PI*MATMUL(QHKL,AVGISLAT)        !CHANGED AVGISLAT TO ISLAT
        KVEC=2.0*PI*MATMUL(AVGISLAT,QHKL)        !CHANGED AVGISLAT TO ISLAT
        END IF
        DO I=1,NATOM
                !$omp parallel do
                DO IT=1,NSTEPORIG
                PHASE1(IT)=DOT_PRODUCT(KVEC,POS(IT,I,:))
                !FQT(IT,I)=ABBT(I)*CMPLX(COS(PHASE1(IT)),SIN(PHASE1(IT)))
                FQT(IT,I)=CMPLX(COS(PHASE1(IT)),SIN(PHASE1(IT)))
                END DO
                !$omp end parallel do

        call dfftw_plan_dft_1d(plann,NSTEP,FQT(:,I),FQT(:,I),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, FQT(:,I),FQT(:,I))
        call dfftw_destroy_plan(plann)
        FQT(:,I)=FQT(:,I)/REAL(NSTEPORIG)
        END DO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!COHERENT
!CASE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        PRINT*,'I AM IN COHERENT SQE'
        CFFQTTYP=0
        !$omp parallel do
        DO IT=1,NSTEP
        CFFQTTYP(IT,1,1)=REAL(SUM(CBBT(:)*FQT(IT,:)))**2   + AIMAG(SUM(CBBT(:)*FQT(IT,:)))**2  
        END DO
        !$omp end parallel do

        PRINT*,'I AM IN INCOHERENT SQE'
        IFFQTTYP=0
        !$omp parallel do
        DO IT=1,NSTEP
        !IFFQTTYP(IT,1,1)=SUM(   IBBT(:)*IBBT(:)*FQT(IT,:)*CONJG(FQT(It,:)) )    
        IFFQTTYP(IT,1,1)=SUM(   SSINC(:)*FQT(IT,:)*CONJG(FQT(It,:)) )    
        END DO
        !$omp end parallel do



!        DO I=1,NATOM !SUM(NNTYPE(1:ITYPPP-1))+1,SUM(NNTYPE(1:ITYPPP)) !NATOM
!        !$omp parallel do
!        DO J=1,NATOM !SUM(NNTYPE(1:JTYPPP-1))+1,SUM(NNTYPE(1:JTYPPP)) !NATOM
!        tempd(1:nstep,j)=(FQT(1:NSTEP,I))*CONJG(FQT(1:NSTEP,J))
!        END DO
!        !$omp end parallel do
!        CFFQTTYP(1:NSTEP,1,1)=CFFQTTYP(1:NSTEP,1,1)+ sum(tempd(1:nstep,:),dim=2)
!(FQT(1:NSTEP,I))*CONJG(FQT(1:NSTEP,J))
!        END DO


        DUMMY1=  REAL(CFFQTTYP(:,1,1)) !      SUM(DUMMY2(1:NQ,1,:),DIM=1 ) /NQ
        IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY5)
        IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY5)
        IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY5)
        WHERE(DUMMY5.LE.1.0E-20)DUMMY5=0
        CFFQTTYP(:,1,1)=0.0 !DUMMY5
        CFFQTTYP(:,1,1)=DUMMY5

        DUMMY1=  REAL(IFFQTTYP(:,1,1)) !      SUM(DUMMY2(1:NQ,1,:),DIM=1 ) /NQ
        IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY5)
        IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY5)
        IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY5)
        WHERE(DUMMY5.LE.1.0E-20)DUMMY5=0
        IFFQTTYP(:,1,1)=0.0 
        IFFQTTYP(:,1,1)=DUMMY5


        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        WRITE(9999,15) (QHKL/NSS), OMEGA,REAL(CFFQTTYP(DT,1,1)) +REAL(IFFQTTYP(DT,1,1)),REAL(CFFQTTYP(DT,1,1)), REAL(IFFQTTYP(DT,1,1))
        IF(ICUT==1)WRITE(IQQQQ+9999,15) OMEGA,REAL(CFFQTTYP(DT,1,1)) +REAL(IFFQTTYP(DT,1,1)),REAL(CFFQTTYP(DT,1,1)), REAL(IFFQTTYP(DT,1,1))
        END DO


        !DO DT=1,NSTEP/2
        !OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        !IF(ICUT==1)WRITE(100+IQQQQ,15) OMEGA,REAL(IFFQTTYP(DT,1,1)) 
        !WRITE(9998,15) OMEGA,REAL(IFFQTTYP(DT,1,1))
        !END DO

        !DO DT=1,NSTEP/2
        !OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        !IF(ICUT==1)WRITE(200+IQQQQ,15) OMEGA,REAL(CFFQTTYP(DT,1,1)) + REAL(IFFQTTYP(DT,1,1))
        !WRITE(9999,15) OMEGA,REAL(CFFQTTYP(DT,1,1)) + REAL(IFFQTTYP(DT,1,1))
        !END DO

!        DO DT=1,NSTEP/2
!        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
!        WRITE(IQQQQ,15)OMEGA, REAL(CFFQTTYP(DT,1,1))
!        END DO
        17 FORMAT(A12,2X,3F10.5)
        15 FORMAT(3F10.5, 2X, F15.4,1003E20.4)
        170 FORMAT(A12,100(3X,3F6.2,3X))
        172 FORMAT(A12,<NQ>(3X,3F6.2,3X),6X,'AVG OVER Q')
        171 FORMAT(A3,12X,<NTYP>(8X,'avg',A3,10X) )
        173 FORMAT(A3,12X,<NTYP2>(8X,'avg',2A3,10X) )
CLOSE(9999)
CLOSE(9997)
CLOSE(9998)
DEALLOCATE(FQT,CFFQTTYP)
END SUBROUTINE




SUBROUTINE IIFQT6(IQQQQ)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::FQT!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::CFFQTTYP,IFFQTTYP!,SQWB
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMY4,DUMMY5,DUMMY6
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DUMMY1,DUMMY2,DUMMY3
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
REAL,DIMENSION(NSTEP)::PHASE1
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::II1,I1,DT1,III
DOUBLE PRECISION::EE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK
INTEGER::ITYPPP,JTYPPP
INTEGER::IQQQQ,NNN2
CHARACTER::AA*9
INTEGER::NTYP2
INTEGER::IJ1,IJ2
INTEGER::IQTCAL
integer,allocatable,dimension(:)::plan
integer::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
double precision::kweight
OPEN(9999,FILE='SQEMAP',ACCESS='APPEND')
IQTCAL=0         !!!!DO  NOT CALCLATE FQT

IF(ICUT==1)WRITE(AA,'("CSQWTOT",I2.2)')IQQQQ
IF(ICUT==1)OPEN(170,FILE=AA)
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::AAA
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::BBB
!Integer :: Status
!Complex,ALLOCATABLE,DIMENSION(:) :: AAAA
!NTYP2=NTYP*(NTYP+1)/2
!PRINT*,NTYP2
!WRITE(AA,'("CSQWTOT",I2.2)')IQQQQ
!OPEN(170,FILE=AA)
!WRITE(AA,'("ISQWTOT",I2.2)')IQQQQ
!OPEN(180,FILE=AA)
!IF(IQTCAL==1)WRITE(AA,'("CIQTTOT",I2.2)')IQQQQ
!IF(IQTCAL==1)OPEN(190,FILE=AA)
!IF(IQTCAL==1)WRITE(AA,'("IIQTTOT",I2.2)')IQQQQ
!IF(IQTCAL==1)OPEN(200,FILE=AA)
OPEN(19,FILE="storage")
!OPEN(18,FILE="ISQ")
!IF(IQTCAL==1) OPEN(19,FILE="CIQ")
!IF(IQTCAL==1)OPEN(20,FILE="IIQ")
!PRINT*,'I AM IN IFFQT'
ALLOCATE(FQT(1:NSTEP,NATOM))
!ALLOCATE(AAAA(NSTEP))
!ALLOCATE(AAA(NATOM,2*NSTEP))
!ALLOCATE(BBB(2*NSTEP))
ALLOCATE(CFFQTTYP(1:NSTEP,1,1))
ALLOCATE(IFFQTTYP(1:NSTEP,1,1))
allocate(plan(NATOM))

CFFQTTYP=0
IFOR= 1
IBAC=-1

PRINT*,AVGISLAT
PRINT*,NTYP

WRITE(AA,'("KKLIST",I2.2)')IQQQQ
OPEN(44,FILE=AA)
I=0
DO  
I=I+1 
READ(44,*,END=100)KLIST(I,:),kweight
END DO
100 CONTINUE
NQ=I-1
I=0
PRINT*,'NQ',NQ
ALLOCATE(QQ(NQ,3),QK(NQ,3))
ALLOCATE(DUMMY1(NQ,NSTEP),DUMMY2(NQ,NSTEP),DUMMY3(NQ,NSTEP))
ALLOCATE(DUMMY4(NSTEP),DUMMY5(NSTEP),DUMMY6(NSTEP))


PRINT*,'NSTEP',NSTEP
IF(kweight.lt.1)kweight=1

DO IQ=1,NQ

	IFFQTTYP=0
	CFFQTTYP=0
	PRINT*,'IQ=',IQ
	QQ(IQ,:)=KLIST(IQ,:) !VEC
	IF(ICARTESIAN==1)THEN
        KVEC=KLIST(IQ,:)
        ELSE
        !KVEC=2.0*PI*MATMUL(KLIST(IQ,:),AVGISLAT)        !CHANGED AVGISLAT TO ISLAT
        KVEC=2.0*PI*MATMUL(AVGISLAT,KLIST(IQ,:))        !CHANGED AVGISLAT TO ISLAT
        END IF
	QK(IQ,:)=KVEC
        DO I=1,NATOM
		!$omp parallel do
        	DO IT=1,NSTEPORIG  
                PHASE1(IT)=DOT_PRODUCT(KVEC,POS(IT,I,:))
                FQT(IT,I)=CMPLX(COS(PHASE1(IT)),SIN(PHASE1(IT)))
                END DO
		!$omp end parallel do
   
	     	!DO IT=NSTEPORIG+1,NSTEP
                !FQT(IT,I)=FQT(NSTEPORIG,I)
                !END DO

        call dfftw_plan_dft_1d(plann,NSTEP,FQT(:,I),FQT(:,I),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, FQT(:,I),FQT(:,I))
        call dfftw_destroy_plan(plann)
        FQT(:,I)=FQT(:,I)/REAL(NSTEPORIG)
        END DO


        PRINT*,'I AM IN COHERENT SQE'
        !$omp parallel do
        DO IT=1,NSTEP
        CFFQTTYP(IT,1,1)=REAL(SUM(CBBT(:)*FQT(IT,:)))**2     +AIMAG(SUM(CBBT(:)*FQT(IT,:)))**2
        END DO
        !$omp end parallel do

        PRINT*,'I AM IN INCOHERENT SQE'
        !$omp parallel do
        DO IT=1,NSTEP
        IFFQTTYP(IT,1,1)=SUM(   IBBT(:)*IBBT(:)*FQT(IT,:)*CONJG(FQT(It,:)) )
        END DO
        !$omp end parallel do



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!INCOHERENT CALCULATION 
!IF (ICOH==0.OR.ICOH==3)THEN               !INCOHRENT CASE
!PRINT*,'I AM IN INCOHERENT'
!        DO ITYPPP=1,NTYP
!        DO I=SUM(NNTYPE(1:ITYPPP-1))+1,SUM(NNTYPE(1:ITYPPP)) !NATOM
!         FFQTTYP(1:NSTEP,ITYPPP)=FFQTTYP(1:NSTEP,ITYPPP)+(FQT(1:NSTEP,I))*CONJG(FQT(1:NSTEP,I))
!	END DO
!        END DO
!        !####!SQW SQW SQW SQW SQW SQW SQW SQW SQW SQW SQW SQWS SQWS SQW 
!	DO DT=1,NSTEP
!	WRITE(18,15)REAL(DT)*DELT,REAL(FFQTTYP(DT,1:NTYP))  ,SUM(REAL(FFQTTYP(DT,:))) , SUM(AIMAG(FFQTTYP(DT,:))) !/REAL(FFQTTYP(1,:)) !,SUM(REAL(FFQTTYP(DT,1:NTYP)))/SUM(REAL(FFQTTYP(1,1:NTYP))) !NATOM
!	END DO

!	IF(IQTCAL==1)THEN
	!######IQT IQT IQT IQT!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!	DO I=1,NTYP
!        call dfftw_plan_dft_1d(plan(i),NSTEP,FFQTTYP(:,I),FFQTTYP(:,I),IBAC,FFTW_ESTIMATE)
!        call dfftw_execute_dft(plan(i), FFQTTYP(:,I),FFQTTYP(:,I))
!        call dfftw_destroy_plan(plan(i))
!        FFQTTYP(:,I)=FFQTTYP(:,I)/REAL(NSTEPORIG)
!	END DO
!		DO DT=1,NSTEP	
!		WRITE(20,15)REAL(DT)*DELT,REAL(FFQTTYP(DT,1:NTYP)) !/(REAL(FFQTTYP(1,:))) !,(SUM(REAL(FFQT(DT,:))))/SUM(REAL(FFQT(1,:)))
!		END DO
!	END IF
!
!END IF

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!COHERENT CASE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!        IF (ICOH==1.or.ICOH==3)THEN               !COHRENT CASE
!	PRINT*,'I AM IN COHERENT'
!        CFFQTTYP=0
!	!$omp parallel do
!        DO ITYPPP=1,NTYP
!        DO JTYPPP=ITYPPP,NTYP
!        DO I=SUM(NNTYPE(1:ITYPPP-1))+1,SUM(NNTYPE(1:ITYPPP)) !NATOM
!        DO J=SUM(NNTYPE(1:JTYPPP-1))+1,SUM(NNTYPE(1:JTYPPP)) !NATOM
!        CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP)=CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP)+(FQT(1:NSTEP,I))*CONJG(FQT(1:NSTEP,J))
!	END DO
!        END DO
!        END DO
!        END DO
!	!$omp end parallel do
!	!SQW SQW SQW SQW SQW SQW SQW 
!	DO DT=1,NSTEP
!        WRITE(17,15) REAL(DT)*DELT, ( ( REAL(CFFQTTYP(DT,IJ1,IJ2)) , IJ2=IJ1,NTYP ),IJ1=1,NTYP) ! ,SUM(REAL(CFFQTTYP(DT,:,:)))/SUM(REAL(CFFQTTYP(1,:,:))) !NATOM
!	END DO


	!IQT IQT IQT IQT IQT IQT IQT 
!IF( IQTCAL==1)THEN
!!	!$omp parallel do
!!	DO I=1,NTYP  !*(NTYP+1)/2
!!	 DO J=I,NTYP  !*(NTYP+1)/2
!! !!       	call dfftw_plan_dft_1d(plan(j),NSTEP,CFFQTTYP(:,I,J),CFFQTTYP(:,I,J),IBAC,FFTW_ESTIMATE)
!	        call dfftw_execute_dft(plan(j), CFFQTTYP(:,I,J),CFFQTTYP(:,I,J))
!	        call dfftw_destroy_plan(plan(j))
!		CFFQTTYP(:,I,J)=CFFQTTYP(:,I,J)/REAL(NSTEPORIG) !CMPLX(AAA(I,1:2*NSTEP:2),AAA(I,2:2*NSTEP:2))
!	 END DO
!        END DO
!!	!$omp end parallel do
!!
	DO IT=1,NSTEP	
        WRITE(19,15) REAL(IT)*DELT,  REAL(CFFQTTYP(IT,1,1)) + REAL(IFFQTTYP(IT,1,1)),  REAL(CFFQTTYP(IT,1,1)) , REAL(IFFQTTYP(IT,1,1))
!   ( ( REAL(CFFQTTYP(DT,IJ1,IJ2)) , IJ2=IJ1,NTYP ),IJ1=1,NTYP) ! ,SUM(REAL(CFFQTTYP(DT,:,:)))/SUM(REAL(CFFQTTYP(1,:,:))) !NATOM
	END DO
!END IF
!END IF



END DO    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!QLOOP ENDS
!REWIND(17)
!REWIND(18)
REWIND(19)
!REWIND(20)



!IF(ICOH==0.OR.ICOH==3)THEN
!	DO IQ=1,NQ
!	DO DT=1,NSTEP
!	READ(18,15)EE,DUMMY2(IQ,1:NTYP+1,DT) !,DUMMY1(IQ,DT) !,ITYP=1,NTYP)
!	IF(IQTCAL==1)READ(20,15)EE,DUMMY4(IQ,1:NTYP+1,DT) !,DUMMY3(IQ,DT) !,ITYP=1,NTYP)
!	END DO
!	END DO
!	WRITE(180,171)'#',(ATMNM(I),I=1,NTYP)
!	IF(IQTCAL==1)WRITE(200,171)'#',(ATMNM(I),I=1,NTYP)
!		DO DT=1,NSTEP
!		OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
!		WRITE(180,15)OMEGA,( SUM(DUMMY2(1:NQ,ITYP,DT)) / NQ   ,ITYP=1,NTYP+1) !,SUM(DUMMY2(1:NQ,:,DT))/NQ
!		IF(IQTCAL==1)WRITE(200,15)REAL(DT-1)*DELT,((SUM(DUMMY4(1:NQ,ITYP,DT))/NQ ),ITYP=1,NTYP+1) !,SUM(DUMMY4(1:NQ,:,DT))/NQ
!		END DO
!END IF

!IF(ICOH==1.OR.ICOH==3)THEN
	DO IQ=1,NQ
	DO IT=1,NSTEP
	READ(19,*)EE,DUMMY1(IQ,IT),DUMMY2(IQ,IT),DUMMY3(IQ,IT) !,DUMMY1(IQ,DT) !,ITYP=1,NTYP)
!	IF(IQTCAL==1)READ(19,15)EE,DUMMY4(IQ,1:NTYP2+1,DT) !,DUMMY3(IQ,DT) !,ITYP=1,NTYP)
	END DO
	END DO
!	WRITE(170,173)'#',(  (  ( ATMNM(I),ATMNM(J)) ,J=I,NTYP )  ,I=1,NTYP  )
!	WRITE(190,173)'#',(  (  ( ATMNM(I),ATMNM(J)) ,J=I,NTYP )  ,I=1,NTYP  )

!        KSELF(1)=1 
!        DO I=2,NTYP
!        KSELF(I)=KSELF(I-1)+NTYP-I+2
!        END DO
!
!        DO ITYP=1,NTYP2
!        IF(ANY(KSELF==ITYP)) THEN
!               DUMMYT(:)=DUMMYT+ SUM(DUMMY2(:,ITYP,:),DIM=1)
!        ELSE
!               DUMMYT(:)=DUMMYT+ 2*SUM(DUMMY2(:,ITYP,:),DIM=1)
!        
!        END IF
!        END DO
!        END DO
!        END DO
!        DUMMYT=DUMMYT/NQ
        !IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY5)
        !IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY5)
        !IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY5)
!        IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,SUM(DUMMY1(:,:),DIM=1),DUMMY4)
!        IF(IBROAD==1)CALL BROAD2(FWHM0,FWHM1,SUM(DUMMY1(:,:),DIM=1),DUMMY4)
!        IF(IBROAD==1)CALL BROAD3(FWHM0,FWHM1,SUM(DUMMY1(:,:),DIM=1),DUMMY4)
!        WHERE(DUMMY4.LE.1.0E-20)DUMMY4=0
!        IFFQTTYP(:,1,1)=0.0
!        IFFQTTYP(:,1,1)=DUMMY5

!        IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,SUM(DUMMY2(:,:),DIM=1),DUMMY5)
!        IF(IBROAD==1)CALL BROAD2(FWHM0,FWHM1,SUM(DUMMY2(:,:),DIM=1),DUMMY5)
!        IF(IBROAD==1)CALL BROAD3(FWHM0,FWHM1,SUM(DUMMY2(:,:),DIM=1),DUMMY5)
!        WHERE(DUMMY5.LE.1.0E-20)DUMMY5=0

!        IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,SUM(DUMMY3(:,:),DIM=1),DUMMY6)
!        IF(IBROAD==1)CALL BROAD2(FWHM0,FWHM1,SUM(DUMMY3(:,:),DIM=1),DUMMY6)
!        IF(IBROAD==1)CALL BROAD3(FWHM0,FWHM1,SUM(DUMMY3(:,:),DIM=1),DUMMY6)
!        WHERE(DUMMY6.LE.1.0E-20)DUMMY6=0
print*,kweight

	DO DT=1,NSTEP
	OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
	!IF(ICUT==1)WRITE(170,15)OMEGA,DUMMY4(DT),DUMMY5(DT),DUMMY6(DT)!  (  SUM(DUMMY2(1:NQ,ITYP,DT) )/NQ,ITYP=1,NTYP2),DUMMYT(DT) 
	IF(ICUT==1)WRITE(170,15)OMEGA,kweight,SUM(DUMMY1(:,DT)),kweight,SUM(DUMMY2(:,DT)),kweight*SUM(DUMMY3(:,DT))!  (  SUM(DUMMY2(1:NQ,ITYP,DT) )/NQ,ITYP=1,NTYP2),DUMMYT(DT) 
	!WRITE(9999,15)OMEGA,DUMMY4(DT),DUMMY5(DT),DUMMY6(DT)!  (  SUM(DUMMY2(1:NQ,ITYP,DT) )/NQ,ITYP=1,NTYP2),DUMMYT(DT) 
	WRITE(9999,15)OMEGA,kweight*SUM(DUMMY1(:,DT)),kweight*SUM(DUMMY2(:,DT)),kweight*SUM(DUMMY3(:,DT))!  (  SUM(DUMMY2(1:NQ,ITYP,DT) )/NQ,ITYP=1,NTYP2),DUMMYT(DT) 
	END DO


	17 FORMAT(A12,2X,3F10.5)
        15 FORMAT(F15.4,1003E20.4)
	170 FORMAT(A12,100(3X,3F6.2,3X))
	172 FORMAT(A12,<NQ>(3X,3F6.2,3X),6X,'AVG OVER Q')
	171 FORMAT(A3,12X,<NTYP>(8X,'avg',A3,10X) )
	173 FORMAT(A3,12X,<NTYP2>(8X,'avg',2A3,10X) )
CLOSE(170)
CLOSE(190)
CLOSE(200)
CLOSE(17)
CLOSE(18)
CLOSE(19)
CLOSE(20)
CLOSE(44)
CLOSE(9999)
!DEALLOCATE(FQT,FFQTTYP,CFFQTTYP,DUMMY1,DUMMY2,DUMMY3,DUMMY4, AAA)
!DEALLOCATE(FQT,FFQT,AAA)
END SUBROUTINE

SUBROUTINE KLIST_GEN3(AAVGISLAT,QMIN,QMAX,IQQQQQ)
USE VARIABLES1, only :NQPOINT 
IMPLICIT NONE
!USE VARIABLES
INTEGER::H,K,L
DOUBLE PRECISION,DIMENSION(3)::QVEC
DOUBLE PRECISION,DIMENSION(3,3)::AAVGISLAT
DOUBLE PRECISION::QMOD
INTEGER::IHKL,I
DOUBLE PRECISION::PI
DOUBLE PRECISION::QMIN,QMAX
INTEGER::IQQQQQ,NCOUNT
CHARACTER::AAAA*9
DOUBLE PRECISION,DIMENSION(3)::r
PI=4.0*ATAN(1.0) 
PRINT*,'IQQQQQ,QMIN,QMAX,NQPOINT'
PRINT*,IQQQQQ,QMIN,QMAX,NQPOINT
WRITE(AAAA,'("KKLIST",I2.2)')IQQQQQ
OPEN(34,FILE=AAAA)
PRINT*,AAVGISLAT(1,:)
PRINT*,AAVGISLAT(2,:)
PRINT*,AAVGISLAT(3,:)
PRINT*,QMIN,QMAX
!OPEN(1,FILE="KKLIST")
IHKL=0
DO H=-100,100
DO K=-100,100
DO L=-100,100
!IHKL=IHKL+1
QVEC(:)=(/H,K,L/)
!QVEC(:)=MATMUL(QVEC(:),AAVGISLAT)
QVEC(:)=MATMUL(AAVGISLAT,QVEC(:))
!PRINT*,QVEC
!PAUSE
QMOD=2.0*PI*SQRT(DOT_PRODUCT(QVEC(:),QVEC(:)))
IF(H+K+L.NE.0.AND.QMOD.LE.QMAX.AND.QMOD.GE.QMIN)THEN
!IF(QMOD.LE.QMAX.AND.QMOD.GE.QMIN)THEN
IHKL=IHKL+1
!11 FORMAT(3I7,F12.5)
!WRITE(1,11)H,K,L,QMOD
END IF
END DO
END DO
END DO
!PRINT*,AAVGISLAT


NCOUNT=0
DO !I=1,100000
call random_number(r)
r(1)=2.0*(r(1)-0.5)
r(2)=2.0*(r(2)-0.5)
r(3)=2.0*(r(3)-0.5)
!convert to HKL  Max HKL ==1000
r=int(100*r)
QMOD=norm2(2.0*PI*MATMUL(AAVGISLAT,r(:)))
!PRINT*,r(i,:)
!PRINT*,QMOD
if(QMOD.NE.0.AND.QMOD.le.QMAX.and.QMOD .ge. QMIN)THEN
NCOUNT=NCOUNT+1
!PRINT*,QMOD,NCOUNT
!PAUSE
IF(NCOUNT.GT.MIN(IHKL,NQPOINT))EXIT
WRITE(34,34)r(:),REAL(IHKL)/REAL(NQPOINT),IHKL,NQPOINT,QMOD

34  FORMAT(3F15.8,5X,F15.8,2I7,F15.8)
end if
IF(NCOUNT.GT.MIN(IHKL,NQPOINT))EXIT
!IF(NCOUNT.GT.NQPOINT)EXIT
END DO
!CALL SYSTEMQQ("sort -k 4n KKLIST >KLIST")
!CALL SYSTEMQQ("cp KLIST KLIST$IQQQQQ")
END SUBROUTINE        



SUBROUTINE KAPPA4    !!!!!!!!!!!!!!!!!USING FOURIER TRANSOFORM METHOD
USE VARIABLES1
use omp_lib
IMPLICIT NONE
INCLUDE 'fftw3.f'
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::JX,JY,JZ
integer::ik1
double precision::temp
integer::plann
COMPLEX*16,ALLOCATABLE,DIMENSION(:)::JXC,JYC,JZC !FQT,FFQTTYP!,SQWB
INTEGER::IBAC,IFOR,NSKIP
DOUBLE PRECISION::KB,SCAL,SCAL2
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::AAAAX,AAAAY,AAAAZ !#,BBBB,HR
INTEGER::I1,II1
IFOR= 1
IBAC=-1
KB=8.61733326214E-5
SCAL= 1.6E3
PRINT*,NSTEPORIG
NPOW=LOG(REAL(NSTEPORIG))/log(2.0) !0.6930  !/0.30102999566
PRINT*,NPOW
NPOW=NINT(NPOW)
NSTEP2=2**NPOW
!VOL0=369.0140*12*12*12
PRINT*,'NSKIP'
READ*,NSKIP
NSTEP2=NSTEP2/NSKIP
PRINT*,'EFFECTIVE NSTEPS=',NSTEP2
PRINT*,'EFFECTIVE DSTEPS=',NSKIP*DELT
!SCAL2= 2.56E-7*VOL0*DELT*NSKIP/(1.38*TEMPER*TEMPER)               !
!SCAL*NSKIP*DELT/(KB*TEMPER*TEMPER*VOL0)
SCAL2=18567000*VOL0*DELT*NSKIP/(TEMPER*TEMPER)                              !
!SCAL*NSKIP*DELT/(KB*TEMPER*TEMPER*VOL0)
PRINT*,'VOL0=',VOL0               !
PRINT*,'SCAL2=',SCAL2                !
ALLOCATE(JX(NSTEP2),JY(NSTEP2),JZ(NSTEP2))
ALLOCATE(JXC(NSTEP2),JYC(NSTEP2),JZC(NSTEP2))
ALLOCATE(AAAAX(2*NSTEP2))
ALLOCATE(AAAAY(2*NSTEP2))
ALLOCATE(AAAAZ(2*NSTEP2))
OPEN(21,FILE="flux.txt")
DO I=1,1 !285
READ(21,*)
END DO
DO I=1,NSTEP2 !ORIG
READ(21,*,END=99)IK1,JX(I),JY(I),JZ(I)
!SKIP THESE MANY LINES
 DO J=1,NSKIP
 READ(21,*,END=99)
 END DO
END DO
99 CONTINUE

II1=1
DO I1=1,2*(NSTEP2),2
     AAAAX(I1)=JX(II1)
     AAAAX(I1+1)=0
     AAAAY(I1)=JY(II1)
     AAAAY(I1+1)=0
     AAAAZ(I1)=JZ(II1)
     AAAAZ(I1+1)=0
     II1=II1+1
END DO
!DO I=1,2*NSTEP2,2
!WRITE(291,293)I,AAAA(I),AAAA(I+1)
!END DO
!FOURIER!!!!!!!!!!!!!!!!!!!!!!!
CALL DFOUR1(AAAAX,NSTEP2,IFOR)
CALL DFOUR1(AAAAY,NSTEP2,IFOR)
CALL DFOUR1(AAAAZ,NSTEP2,IFOR)
AAAAX=AAAAX/REAL(NSTEP2)
AAAAY=AAAAY/REAL(NSTEP2)
AAAAZ=AAAAZ/REAL(NSTEP2)
!!!!!!!!!!!!!!!CONVOLUTION!!
DO I=1,2*NSTEP2,2
AAAAX(I)=AAAAX(I)*AAAAX(I)+AAAAX(I+1)*AAAAX(I+1) !*CONJG(AAAA)
AAAAY(I)=AAAAY(I)*AAAAY(I)+AAAAY(I+1)*AAAAY(I+1) !*CONJG(AAAA)
AAAAZ(I)=AAAAZ(I)*AAAAZ(I)+AAAAZ(I+1)*AAAAZ(I+1) !*CONJG(AAAA)
END DO
!SPECTRUM
DO I=1,2*NSTEP2,2
WRITE(292,293)I*DELT*NSKIP,SCAL2*(AAAAX(I)+AAAAY(I)+AAAAZ(I))
END DO
!!!!!!!!!!!!!!!!!INVERSE FOURIER
CALL DFOUR1(AAAAX,NSTEP2,IBAC)
CALL DFOUR1(AAAAY,NSTEP2,IBAC)
CALL DFOUR1(AAAAZ,NSTEP2,IBAC)
AAAAX=AAAAX/REAL(NSTEP2)
AAAAY=AAAAY/REAL(NSTEP2)
AAAAZ=AAAAZ/REAL(NSTEP2)
!VACF
DO I=1,2*NSTEP2,2
WRITE(293,293)I*DELT*NSKIP,AAAAX(I),AAAAY(I),AAAAZ(I),AAAAX(I+1),AAAAY(I+1),AAAAZ(I+1)
!)/3.0
END DO
!KAPPA
DO I=1,2*NSTEP2,2
WRITE(294,293)I*DELT*NSKIP,SCAL2* ( SUM(AAAAX(1:I:2)) +SUM(AAAAY(1:I:2)) + SUM(AAAAX(1:I:2)))/3  !SUM(AAAA(2:I+1:2))
END DO
293 FORMAT(F10.5,6E15.5)
close(21)
END SUBROUTINE




SUBROUTINE KAPPA5
USE VARIABLES1
use omp_lib
IMPLICIT NONE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::JX,JY,JZ,JXC,JYC,JZC
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::SJXC,SJYC,SJZC
INTEGER::IK1,IK2
INTEGER::NSTEPORIG2
DOUBLE PRECISION::TEMP
DOUBLE PRECISION::KB,SCAL,SCAL2
!PRINT*,VOL0
!PAUSE
KB=8.61733326214E-5
SCAL= 1.6E3                !
JX=0
JY=0
JZ=0
JXC=0
JYC=0
JZC=0
NSTEPORIG2=IREF2-IREF1+1
PRINT*,NSTEPORIG2
SCAL2=18567000*VOL0*DELT/(TEMPER*TEMPER)                              !
PRINT*, 'JX*JX IS AVERAGED FOR',NSTEPI,'LENGHT, WITH ',OINT, 'INTERVAL'
ALLOCATE(JX(0:NSTEPORIG2), JY(0:NSTEPORIG2),  JZ(0:NSTEPORIG2),JXC(0:NSTEPORIG2),  JYC(0:NSTEPORIG2),   JZC(0:NSTEPORIG2))
ALLOCATE(SJXC(0:NSTEPORIG2),  SJYC(0:NSTEPORIG2),   SJZC(0:NSTEPORIG2))
!OPEN(21,FILE="KAPPA")
OPEN(21,FILE="flux.txt")
DO I=1,1 !285
READ(21,*)
END DO
DO I=1,NSTEPORIG2
READ(21,*)IK1,JX(I),JY(I),JZ(I)
21 FORMAT(I5,F10.5,3F15.5)
END DO



                !IF(NSTEPI.GT.NSTEPORIG2)NSTEPI=NSTEPORIG2
                !DO DT=0,NSTEPORIG2-OINT,NSTEPI
                !NSTEP1=NSTEPI
                !NSTEP2=NSTEPI+DT
                !IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP1=NSTEPORIG2-DT
                !TAO=NSTEPI
                !IF(NSTEPI+DT.GT.NSTEPORIG2)TAO=NSTEPORIG2-DT
                !IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP2=NSTEP1+DT
                !11 FORMAT(2I6,5(F15.5,1x))
                !JXC(DT)=DOT_PRODUCT(JX(1:NSTEP1:OINT),JX(1+DT:NSTEP2:OINT))/REAL((TAO/OINT))! + &
                !JYC(DT)=DOT_PRODUCT(JY(1:NSTEP1:OINT),JY(1+DT:NSTEP2:OINT))/REAL((TAO/OINT))!
                !JZC(DT)=DOT_PRODUCT(JZ(1:NSTEP1:OINT),JZ(1+DT:NSTEP2:OINT))/REAL((TAO/OINT))!  )

                !SJXC(DT)=  SUM(JXC(0:DT))*DELT  !/(DT+1)
                !SJYC(DT)=  SUM(JYC(0:DT))*DELT !/(DT+1)
                !SJZC(DT)=  SUM(JZC(0:DT))*DELT  !/(DT+1)
                !END DO

!                IF(NSTEPI.GT.NSTEPORIG2)NSTEPI=NSTEPORIG2
                DO DT=0,NSTEPORIG2-OINT-NSTEPI
                NSTEP1=NSTEPI
                NSTEP2=NSTEPI+DT
!                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP1=NSTEPORIG2-DT
                TAO=NSTEPI
!                IF(NSTEPI+DT.GT.NSTEPORIG2)TAO=NSTEPORIG2-DT
!                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP2=NSTEP1+DT
                11 FORMAT(2I6,5(F15.5,1x))
                JXC(DT)=DOT_PRODUCT(JX(1:NSTEP1:OINT),JX(1+DT:NSTEP2:OINT))/REAL((TAO/OINT))! + &
                JYC(DT)=DOT_PRODUCT(JY(1:NSTEP1:OINT),JY(1+DT:NSTEP2:OINT))/REAL((TAO/OINT))!
                JZC(DT)=DOT_PRODUCT(JZ(1:NSTEP1:OINT),JZ(1+DT:NSTEP2:OINT))/REAL((TAO/OINT))!  )

                SJXC(DT)=  SUM(JXC(0:DT))*DELT  !/(DT+1)
                SJYC(DT)=  SUM(JYC(0:DT))*DELT !/(DT+1)
                SJZC(DT)=  SUM(JZC(0:DT))*DELT  !/(DT+1)
                END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

DO I=0,NSTEPORIG2-NSTEPI-OINT
                WRITE(2294,98)DELT*REAL(I),SCAL2*JXC(I),SCAL2*JYC(I),SCAL2*JZC(I)
                WRITE(2295,98)DELT*REAL(I),SCAL2*SJXC(I),SCAL2*SJYC(I),SCAL2*SJZC(I),SCAL2*(SJXC(I)+SJYC(I)+SJZC(I))/3
98             FORMAT(F16.6,10000E16.5)
END DO
close(21)
END SUBROUTINE



SUBROUTINE KAPPA6
USE VARIABLES1
use omp_lib
IMPLICIT NONE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::JX,JY,JZ
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::SJXC,SJYC,SJZC
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::CC,DD
INTEGER::IK1,IK2,ICOUNT,SINT
INTEGER::NSTEPORIG2
DOUBLE PRECISION::TEMP
DOUBLE PRECISION::KB,SCAL,SCAL2
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::KAPPAX,KAPPAY,KAPPAZ
KB=8.61733326214E-5
SCAL= 1.6E3                !
SINT=OINT
SCAL2=18567000*VOL0*DELT*SINT/(TEMPER*TEMPER)                              !
PRINT*,'VOL0=',VOL0               !
PRINT*,'SCAL2=',SCAL2                !
PRINT*,'TEMPERATURE=',TEMPER                !
PRINT*,'DELT=',DELT                !
PRINT*,'SINT=',SINT                !
JX=0
JY=0
JZ=0
NSTEPORIG2=IREF2-IREF1+1
PRINT*, 'JX*JX IS AVERAGED FOR',NSTEPI,'LENGHT, WITH ',OINT, 'INTERVAL'
ALLOCATE(JX(NSTEPORIG), JY(NSTEPORIG),  JZ(NSTEPORIG))
ALLOCATE(CC(NSTEPI,3))
ALLOCATE(DD(NSTEPI,3))
ALLOCATE(KAPPAX(NSTEPORIG/SINT +1 ),KAPPAY(NSTEPORIG/SINT+1),KAPPAZ(NSTEPORIG/SINT +1))
CC=0

OPEN(21,FILE="flux.txt")
DO I=1,1 !285
READ(21,*)
END DO
K=0
DO I=1,NSTEPORIG,OINT
K=K+1
!READ(21,*)IK1,TEMP,JX(I),JY(I),JZ(I)
READ(21,*)IK1,JX(K),JY(K),JZ(K)
 DO J=1,OINT-1
 READ(21,*,END=99)
 END DO
END DO
99 continue
!READ*,NSTEPI
!SCAL2=1
!DO ICOUNT=1,NSTEPORIG2-1
!   DO J=1,MIN(ICOUNT,NSTEPI)
!   CC(I,J,1)=CC(I,J,1)*(ICOUNT-J)+ JX(ICOUNT)*JX(ICOUNT-J+1)
!   CC(I,J,1)=CC(I,J,1)/(ICOUNT-J+1)
!   CC(I,J,2)=CC(I,J,2)*(ICOUNT-J)+ JY(ICOUNT)*JY(ICOUNT-J+1)
!   CC(I,J,2)=CC(I,J,2)/(ICOUNT-J+1)
!   CC(I,J,3)=CC(I,J,3)*(ICOUNT-J)+ JZ(ICOUNT)*JZ(ICOUNT-J+1)
!   CC(I,J,3)=CC(I,J,3)/(ICOUNT-J+1)
!   END DO
!   KAPPAX(ICOUNT)=SUM(CC(I,:,1))  - CC(I,1,1)/2 -CC(I,NSTEPI,1)/2
!   KAPPAY(ICOUNT)=SUM(CC(I,:,2))  - CC(I,1,2)/2 -CC(I,NSTEPI,2)/2
!   KAPPAZ(ICOUNT)=SUM(CC(I,:,3))   - CC(I,1,3)/2 -CC(I,NSTEPI,3)/2
!   WRITE(295,11)ICOUNT*DELT
!   ,SCAL2*KAPPAX(ICOUNT),SCAL2*KAPPAY(ICOUNT),SCAL2*KAPPAZ(ICOUNT)
!  ! PRINT 11 ,CC(I,:,1)  !KAPPAX(ICOUNT),KAPPAY(ICOUNT),KAPPAZ(ICOUNT)
!END DO
 CC=0
 DD=0
 I=0
!Here SINT is sample interval and OINT is NSTEPI is correlation length and OINT

DO I=1,NSTEPORIG/SINT
!   I=I+1
!   k=0
   !DO J=1,MIN(ICOUNT,SINT*NSTEPI),SINT
   DO J=1,MIN(I,NSTEPI) !,SINT
   !K=K+1
   CC(J,1)=DD(J,1)*(I-J)+ JX(I)*JX(I-J+1)
   CC(J,1)=CC(J,1)/(I-J+1)
   CC(J,2)=DD(J,2)*(I-J)+ JY(I)*JY(I-J+1)
   CC(J,2)=CC(J,2)/(I-J+1)
   CC(J,3)=DD(J,3)*(I-J)+ JZ(I)*JZ(I-J+1)
   CC(J,3)=CC(J,3)/(I-J+1)
   DD(J,:)=CC(J,:)
   END DO
   KAPPAX(i)=SUM(CC(:,1))  - CC(1,1)/2 -CC(NSTEPI,1)/2
   KAPPAY(i)=SUM(CC(:,2))  - CC(1,2)/2 -CC(NSTEPI,2)/2
   KAPPAZ(i)=SUM(CC(:,3))  - CC(1,3)/2 -CC(NSTEPI,3)/2
   WRITE(1295,11)I*oint*DELT,SCAL2*KAPPAX(i),SCAL2*KAPPAY(I),SCAL2*KAPPAZ(I)
END DO
DO K=1,NSTEPI
WRITE(1294,11)K*DELT*OINT,CC(K,1),CC(K,2),CC(K,3)
END DO
11 FORMAT(F20.5,3(E13.5,1x))
close(21)
END SUBROUTINE

SUBROUTINE GRRFN4LAMMPS
use omp_lib
USE VARIABLES1
IMPLICIT NONE
!DOUBLE PRECISION,DIMENSION(NATOM,3)::POSF
DOUBLE PRECISION,DIMENSION(NATOm,3)::AA
DOUBLE PRECISION::MODA
!DOUBLE PRECISION,DIMENSION(NATOM,NATOM)::GRR
DOUBLE PRECISION,DIMENSION(0:1000,NTYP,NTYP)::GRRT
DOUBLE PRECISION::R1,R2
INTEGER::IDR
INTEGER::K1,K2,K3,K4
!DOUBLE PRECISION,DIMENSION(NATOM,27,3)::SPOS
INTEGER::NS,INS,NX,NY,NZ,I1
DOUBLE PRECISION::DV,AREA,XD,YD,ZD
DOUBLE PRECISION,DIMENSION(NATOM)::AMODA
INTEGER,DIMENSION(NATOM)::NRI
INTEGER::JTYP
AA=0
PRINT*, "I M IN GRRFN LAMPPS2"
PRINT*,IT
WRITE(111,*)'# TIME=IT,LL',IT,LL
GRRT=0

DO ITYP=1,NTYP
DO JTYP=ITYP,NTYP
   DO I=SUM(NNTYPE(1:ITYP-1))+1, SUM(NNTYPE(1:ITYP))
        NRI=0
!!!!!parallel  default(none) shared(GRRT), private(AA,AMODA,NRI) &
!!!!!!OMP REDUCTION(+:GRRT)
        !$omp do
        DO J=SUM(NNTYPE(1:JTYP-1))+1, SUM(NNTYPE(1:JTYP))
            IF(I.NE.J)THEN
            AA(J,:)= RR1(I,:)-RR1(J,:)  
	    WHERE(AA(J,:).LT.-0.5)AA(J,:)=AA(J,:)+1
	    WHERE(AA(J,:).gT.0.5)AA(J,:)=AA(J,:)-1
            !AA(J,:)=MATMUL(TRANSPOSE(SLAT),AA(J,:))                       !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!CHECK
            AA(J,:)=MATMUL(AA(J,:),SLAT)                       !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!CHECK
            AMODA(J)=NORM2(AA(J,:))
            NRI(J)=INT(AMODA(J)/DELR)
!            WHERE(NRI(J).LE.1000)GRRT(NRI(J),ITYP,JTYP)= GRRT(NRI(J),ITYP,JTYP) + 1
!OMP ATOMIC
IF(NRI(J).LE.1000) GRRT(NRI(J),ITYP,JTYP)= GRRT(NRI(J),ITYP,JTYP) + 1 ! SUM(GRR(K1:K2,K3:K4))
!            GRRT(NRI(J),ITYP,JTYP)= GRRT(NRI(J),ITYP,JTYP) + 1 ! SUM(GRR(K1:K2,K3:K4))
            END IF
        END DO
!$omp end do
  END DO            
END DO
END DO

   DO I=1,NTYP
      DO J=I,NTYP
        K1=SUM(NNTYPE(1:I-1))+1
        K2=SUM(NNTYPE(1:I))
        K3=SUM(NNTYPE(1:J-1))+1
        K4=SUM(NNTYPE(1:J))
        GRRT(:,I,J)=GRRT(:,I,J)/NNTYPE(I)   !((K2-k1+1))
        GRRT(:,J,I)=GRRT(:,I,J) !/NNTYPE(I)   !((K2-k1+1))
        END DO
   END DO

   



DO IDR=1,1000 !NR
   R1=((IDR-1)*DELR) !+R0
   R2=((IDR)*DELR) !+R0
   RM=(R1+R2)*0.5
   AREA=4.0*PI*(RM**2)
   DV=AREA*DELR
   GRRT(IDR,:,:)=GRRT(IDR,:,:)/DV
!   GRTOTAL(IDR)=GRTOTAL(IDR)/(DV*NATOM)
!   WRITE(111,11)RM ,((GRRT(IDR,I,J),J=I,NTYP),I=1,NTYP) !,GRTOTAL(IDR) !,SUM(GRRT(IDR,:,:))
   11 FORMAT(F6.3,2x,100F8.4)
   101 format (F4.1,100I3)
END DO

!!!!!!!!!!!!!!!!!!
!DO IDR=1,1000 !NR
   DO I=1,NTYP
      DO J=1,NTYP
      GRRTAVG(:,I,J)=GRRTAVG(:,I,J)+GRRT(:,I,J)
      !GRRTAVGXRAY(:,I,J)=GRRTAVG(:,I,J)*ZELE(I)*ZELE(J)  !+GRRT(:,I,J)
      GRRTAVGXRAY(:,I,J)=GRRTAVG(:,I,J)*XRAY(I)*XRAY(J)  !+GRRT(:,I,J)
      GRRTAVGNEUTRON(:,I,J)=GRRTAVG(:,I,J)*BBT(I)*BBT(J)  !+GRRT(:,I,J)
      END DO
   END DO
!     GAVG(IDR)=GAVG(IDR)+GRTOTAL(IDR)
!END DO


!RMAX=INT((GRCUT-R0)/DELR)
!ASTATUS=ANY(GRTOTAL(1:RMAX).GT.0,DIM = 1)
!PRINT*,RMAX,ASTATUS



!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!
!IF(IT.EQ.IREF2-IREF1)THEN
!DO IDR=1,NR
!WRITE(83,83)R0+(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(LL),J=I,NTYP),I=1,NTYP),GAVG(IDR)/REAL(LL)
!WRITE(83,83)R0+(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(IPOINTS),J=I,NTYP),I=1,NTYP),GAVG(IDR)/REAL(IPOINTS)
!END DO
!END IF
!83 FORMAT(F6.3,2x,100F8.4)
END SUBROUTINE



SUBROUTINE LAMMPS2021            !!!!!!!!!!!!!!!!!!!!VASP XDATCAR READING 
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(3)::AA
CHARACTER*50::ABC2
INTEGER::L1,L2
INTEGER::IDR,ITH
DOUBLE PRECISION::A1,A2,B1,B2,C1,C2,A12,B12,C12
CHARACTER*50::FLNMPOSCAR
!REAL::XL,XH,XY
!REAL::YL,YH,XZ
!REAL::ZL,ZH,YZ
INTEGER::ID1,ID2
INTEGER::IND1,IND2,IND3
DOUBLE PRECISION::X1,X2,Y1,Y2,Z1,Z2,XY,XZ,YZ,XLO,XHI,YLO,YHI,ZLO,ZHI,zero
!!!!!!!!!!!!!!POLYTHINGS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DDD
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::ANGLETHETA,ANGLEPHI,DDDD,REFTHETA,REFPHI
INTEGER,ALLOCATABLE,DIMENSION(:,:)::BDIST
INTEGER,ALLOCATABLE,DIMENSION(:)::INDEXI
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DISTORTION
REAL,ALLOCATABLE,DIMENSION(:,:,:)::PROBDENSITY
!!!!!!the last index 4 due to tetrahedral cordination
DOUBLE PRECISION::RXY
DOUBLE PRECISION::RTOPI
INTEGER::JJJJ,JK,IR,JKK
DOUBLE PRECISION::D2,DR1,DR2
DOUBLE PRECISION::PROJ1,PROJ2,TWOPI
DOUBLE PRECISION,DIMENSION(3,3)::IAXIS
DOUBLE PRECISION::X,Y,Z,R
DOUBLE PRECISION,DIMENSION(3,3)::NEWLAT
INTEGER::MATOM,JCu,ICAP
INTEGER::MAXCAP,JTAG !,NCORD
DOUBLE PRECISION::AVGBOND
REAL::RSEARCH
REAL,DIMENSION(3)::XYZ
!REAL,DIMENSION(1,0:180,0:360)::PROBDENSITY
INTEGER::J1
INTEGER,DIMENSION(NATOM,12,3)::PICK
REAL::RIJ,RJK
INTEGER::NC1,NK,IM
!DOUBLE PRECISION,DIMENSION(3)::AA

double precision,dimension(3,3)::test_array
character*25,dimension(7)::discr
integer::ic,io
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!VASP READING
zero=0.0
POS=0
test_array=0
!!!!!!!!!!!!!!!!!!!!!!!!!!POLY THINGS
IF (IPOLY==1.AND.ISOFT==3)THEN
ALLOCATE(DDD(3),ANGLETHETA(NNTYPE(CATOM),NCORD),ANGLEPHI(NNTYPE(CATOM),NCORD),DDDD(NNTYPE(CATOM),NCORD))
ALLOCATE(REFTHETA(NNTYPE(CATOM),NCORD),REFPHI(NNTYPE(CATOM),NCORD),BDIST(500,NCORD),INDEXI(100),DISTORTION(NNTYPE(CATOM)),PROBDENSITY(NNTYPE(CATOM),0:90,0:180))
OPEN(4100,FILE="ANGLETHETA.DAT")
OPEN(4101,FILE="ANGLEPHI.DAT")
OPEN(4102,FILE="BONDLENGTHS.DAT")
OPEN(4103,FILE="BONDLENGTHDISTRIBUTION.DAT")
OPEN(4105,FILE="MOVINGIONINDEX.DAT")
OPEN(4106,FILE="DISTORTION.DAT")
OPEN(5000,FILE="PROBDENSITY_THETA_PHI")
PRINT*,'I M IN POLY'
PRINT*,CATOM,SATOM,NK
PROBDENSITY=0
RSEARCH=8.0
MATOM=1
PRINT*,'MOBILE ATOM IS 1 and RSEARCH iS ', RSEARCH
MAXCAP=32
RTOPI=180/(4*ATAN(1.0))  !3.14
PI=4*ATAN(1.0)
TWOPI=8*ATAN(1.0)
    AX3(1)=AX1(2)*AX2(3)-AX1(3)*AX2(2)
    AX3(2)=AX1(3)*AX2(1)-AX1(1)*AX2(3)
    AX3(3)=AX1(1)*AX2(2)-AX1(2)*AX2(1)
IAXIS(1,:)=AX1/NORM2(AX1)
IAXIS(2,:)=AX2/NORM2(AX2)
IAXIS(3,:)=AX3/NORM2(AX3)
END IF
!!!!!!!!!!!!!!!!!!!!!!!!!





PRINT*,'I M LAMMPS.........NVT ONLY'
!        PRINT*,'GRCUT'
!        READ*,GRCUT
IF(IWRITE==1)OPEN(3,FILE="XDATCARNEW.DAT")
IF(IDIFFUSE==0)OPEN(31,FILE="velocity.lammpstrj")
TIME=0
3 FORMAT(3F18.10)
2 FORMAT(A40)
PRINT*,IREF1,NATOM,ATMNM,NNTYPE
PRINT*,FLNM,IREF1
PRINT*,NTYP
test_array=0
READ(2,*)
READ(2,*)
READ(2,*)
READ(2,*)
READ(2,*)
8686 FORMAT(3(E23.16,1x))
READ(2, 8686   , iostat=io) test_array(1,1), test_array(1,2), test_array(1,3)
READ(2, 8686   , iostat=io) test_array(2,1), test_array(2,2), test_array(2,3)
READ(2, 8686   , iostat=io) test_array(3,1), test_array(3,2), test_array(3,3)

!READ(2, *   , iostat=io) test_array(1,1), test_array(1,2), test_array(1,3)
!READ(2, *   , iostat=io) test_array(2,1), test_array(2,2), test_array(2,3)
!READ(2, *   , iostat=io) test_array(3,1), test_array(3,2), test_array(3,3)
READ(2, *, iostat=io)DISCR
!print *,discr

ISKEW=0
if(test_array(1,3).ne.0)ISKEW=1
if(test_array(2,3).ne.0)ISKEW=1
if(test_array(3,3).ne.0)ISKEW=1
!if(any(test_array(:,3).ne.0))ISKEW=1
if(any(discr.eq.'xu'))ISKIP=1 !print *,'conv'
!
PRINT*,test_array(1,:)
PRINT*,test_array(2,:)
PRINT*,test_array(3,:)

!PRINT*,'ISKEW=',ISKEW,io

REWIND(2)

IF(ISKEW==1.AND.ISKIP==1)PRINT*,'UNWRAPPED TRAJ WITH SKEWNESS'
IF(ISKEW==0.AND.ISKIP==1)PRINT*,'UNWRAPPED TRAJ NO SKEWNESS'
IF(ISKEW==1.AND.ISKIP==0)PRINT*,'WRAPPED TRAJ WITH SKEWNESS'
IF(ISKEW==0.AND.ISKIP==0)PRINT*,'WRAPPED TRAJ NO SKEWNESS'
!ISKIP=0
DO IT=1,IREF1-1
        TIME=TIME+1
        DO I=1,9
        READ(2,*)
        IF(IVEL==1.AND.IDIFFUSE==0)READ(31,*)
        END DO
!        READ(2,*)xl,xh,xy
!        READ(2,*)yl,yh,xz
!        READ(2,*)zl,zh,yz
!        alat=xh-xl
!        blat=yh-yl
!        blat=sqrt(blat*blat + 
        DO I=1,NATOM
        READ(2,*)
        IF(IVEL==1.AND.IDIFFUSE==0)READ(31,*)
        END DO
!        IF(ISIF3==1.OR.IT==1)THEN
!        READ(2,2)ABC2
        IF(IWRITE==1)WRITE(3,2)'LAMMPS XDATCAR' !ABC2
!        READ(2,2)ABC2
        IF(IWRITE==1)WRITE(3,2)'1.0' !ABC2
!        READ(2,*)SLAT(1,:)
!        READ(2,*)SLAT(2,:)
!        READ(2,*)SLAT(3,:)
!        SLATORIG=SLAT
!        ISLATORIG=TRANSPOSE(SLAT)
!        CALL GAUSS(ISLATORIG,3)
        IF(IWRITE==1)WRITE(3,3)SLAT(1,:)
        IF(IWRITE==1)WRITE(3,3)SLAT(2,:)
        IF(IWRITE==1)write(3,3)SLAT(3,:)
        IF(IT==1)SLATORIG=SLAT
!        READ(2,*)!ATMNM
        IF(IWRITE==1)WRITE(3,*)ATMNM
!        READ(2,2)ABC2
        IF(IWRITE==1)WRITE(3,*)NNTYPE !ABC2
!        SLAT1=SLAT
!        ISLAT1=SLAT1
!        CALL GAUSS(ISLAT1,3)
!        SLAT=TRANSPOSE(SLAT)        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!        ISLAT=SLAT
!        CALL GAUSS(ISLAT,3)
!        END IF
!       READ(2,2)
        IF(IWRITE==1)WRITE(3,2)'D' !ABC2
!        DO I=1,NATOM
!        READ(2,*) !POS(LL,I,:)      
!        END DO
END DO
        !PAUSE

ISLAT=SLAT
CALL GAUSS(ISLAT,3)
IF(IT==1)ISLATORIG=ISLAT
!PRINT*,ISLAT
!!!!!!!!!!!!
IND1=1
IND2=1  !FOR DIFFUSE SCATTERING STUF
IND3=0
!!!!!!!!!!!!!!

!!!
LL=0
DO IT=1,IREF2-IREF1+1       !#  
!PRINT*,IT

        TIME=TIME+1
!        PRINT*,TIME
        !PRINT*,'IT'
        READ(2,*)
        READ(2,*)
        READ(2,*)
        READ(2,*)
        READ(2,*)
        XY=0
        XZ=0
        YZ=0

        IF(ISKEW==0)THEN
        READ(2,*)x1,x2
        READ(2,*)y1,y2
        READ(2,*)z1,z2
        else 
        READ(2,*)x1,x2,xy
        READ(2,*)y1,y2,xz
        READ(2,*)z1,z2,yz
        END IF
!        print*,x1,x2,xy
!        print*,y1,y2,xz
!        print*,z1,z2,yz
        xlo=x1-min(zero,xy,xz,xy+xz)
        xhi=x2-max(zero,xy,xz,xy+xz)
        ylo=y1-min(zero,yz)
        yhi=y2-max(zero,yz)
        zlo=z1
        zhi=z2
        SLAT(1,1)=xhi-xlo        
        SLAT(2,1)=xy      
        SLAT(3,1)=xz        
        SLAT(1,2)=0
        SLAT(2,2)=yhi-ylo
        SLAT(3,2)=yz
        SLAT(1,3)=0
        SLAT(2,3)=0
        SLAT(3,3)=zhi-zlo

        !SLAT=TRANSPOSE(SLAT)
VOLUME=SLAT(1,1)* (SLAT(2,2)*SLAT(3,3)-SLAT(2,3)*SLAT(3,2)) + SLAT(1,2)* (SLAT(2,3)*SLAT(3,1)-SLAT(2,1)*SLAT(3,3)) + SLAT(1,3)* (SLAT(2,1)*SLAT(3,2)-SLAT(2,2)*SLAT(3,1))

        IF(IT==1)PRINT*,'LAMMPS 1st step Lattice Vectors'
        IF(IT==1)PRINT*, SLAT(1,:)
        IF(IT==1)PRINT*, SLAT(2,:)
        IF(IT==1)PRINT*, SLAT(3,:)
        SLATORIG=SLAT
        ISLAT=SLAT
        CALL GAUSS(ISLAT,3)
        ISLATORIG=ISLAT



        READ(2,*)

        DO I=1,9
        IF(IVEL==1.or.IVEL==2.AND.IDIFFUSE==0)READ(31,*)
        END DO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!TRICK FOR IND1 IND2 IND3!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        IND3=IND3+1
 	 IF(IND3.GT.NCUB)THEN
		IND3=IND3-NCUB
		IND2=IND2+1
		IF(IND2.GT.NCUB)THEN
		 IND2=IND2-NCUB
		 IND1=IND1+1
                 
		END IF
	 END IF
        ! PRINT*,IND1,IND2,IND3
        LL=LL+1
        AVGSLAT=AVGSLAT+SLAT
!        READ(2,2)ABC2
        IF(IWRITE==1)WRITE(3,2)'D' !ABC2
        !PRINT*,IT

   
        IF(NMOL.EQ.1)THEN
        DO I=1,NATOM
        !        IF(IT.GT.1962)PRINT*,I
                IF(ID==0)READ(2,*)POS(LL,I,:)
                IF(ID==0.AND.IVEL==1.AND.IDIFFUSE==0)READ(31,*)VEL(LL,I,:)
                IF(ID==1)READ(2,*)ID1,ID2,POS(LL,I,:)
                IF(ID==1.AND.IVEL==1.AND.IDIFFUSE==0)READ(31,*)ID1,ID2,VEL(LL,I,:)
                IF(ID==1.AND.IVEL==2.AND.IDIFFUSE==0)READ(31,*)VEL(LL,I,:)
                345 FORMAT(I5,3F10.5)
                !POS(LL,I,:)=MATMUL(ISLAT,POS(LL,I,:))
                POS(LL,I,:)=MATMUL(POS(LL,I,:),ISLAT)
                !RR1(I,:)=MATMUL(ISLAT,POS(LL,I,:))
                IF(IDIFFUSE==0)THEN
                RR1(I,:)=POS(LL,I,:)          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!SAVED AS R1 FOR GRR CALCULATION 
                WHERE(RR1(I,:).LT.0.0)RR1(I,:)=RR1(I,:)+1
                WHERE(RR1(I,:).GE.1.0)RR1(I,:)=RR1(I,:)-1
                END IF
!               IF(IDIFFUSE==1)WHERE(RR1(I,:).LT.0.0)RR1(I,:)=RR1(I,:)+1
!               IF(IDIFFUSE==1)WHERE(RR1(I,:).GE.1.0)RR1(I,:)=RR1(I,:)-1
		!IF(IND1.LE.NCUB.AND.IDIFFUSE==1)TPOS(IND1,IND2,IND3,I,:)=RR1(I,:) + (/IND1-1, IND2-1,IND3-1 /)
                IF(LL.GE.2.AND.ISKIP.NE.1)THEN
                !POS(LL-1,I,:)=MATMUL(ISLAT,POS(LL-1,I,:))
                POS(LL-1,I,:)=MATMUL(POS(LL-1,I,:),ISLAT)
                AA=POS(LL,I,:)-POS(LL-1,I,:)
                WHERE(AA.LT.-0.5)POS(LL,I,:)=POS(LL,I,:)+1                
                WHERE(AA.GT.+0.5)POS(LL,I,:)=POS(LL,I,:)-1                
                !POS(LL-1,I,:)=MATMUL(SLAT,POS(LL-1,I,:))
                POS(LL-1,I,:)=MATMUL(POS(LL-1,I,:),SLAT)
                ENDIF
                IF(IWRITE==1)WRITE(3,3)POS(LL,I,:)
                !POS(LL,I,:)=MATMUL(SLAT,POS(LL,I,:))
                POS(LL,I,:)=MATMUL(POS(LL,I,:),SLAT)
                IF(IDIFFUSE==0.AND.IVEL.EQ.0.AND.LL.GE.2.0)THEN
                VEL(LL,I,:)=(POS(LL,I,:)-POS(LL-1,I,:))/DELT
                92 FORMAT(3F9.3,2x,3f9.3)
                END IF

        END DO
      END IF

 IF(NMOL.GT.1) THEN
        DO IM=1,NMOL
           DO ITYP=1,NTYP
             N1= SUM(NNTYPE(1:ITYP-1))  +1 +(IM-1)*(NNTYPE(ITYP)/NMOL)
             N2= N1+ NNTYPE(ITYP)/NMOL -1   !  + (IM-1)*(NATOM/NMOL)
               DO I=N1,N2
                IF(ID==0)READ(2,*)POS(LL,I,:)
                IF(ID==0.AND.IVEL==1.AND.IDIFFUSE==0)READ(31,*)VEL(LL,I,:)
                IF(ID==1)READ(2,*)ID1,ID2,POS(LL,I,:)
                IF(ID==1.AND.IVEL==1.AND.IDIFFUSE==0)READ(31,*)ID1,ID2,VEL(LL,I,:)
                IF(ID==1.AND.IVEL==2.AND.IDIFFUSE==0)READ(31,*)VEL(LL,I,:)
           !     PRINT 987,LL, IM,N1,N2,N2-N1
                987  FORMAT(I4,10I5)
!                345 FORMAT(I5,3F10.5)
                !POS(LL,I,:)=MATMUL(ISLAT,POS(LL,I,:))
                POS(LL,I,:)=MATMUL(POS(LL,I,:),ISLAT)
                RR1(I,:)=POS(LL,I,:)   !#MATMUL(ISLAT,POS(LL,I,:))
                !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!SAVED AS R1 FOR GRR CALCULATION
                WHERE(RR1(I,:).LT.0.0)RR1(I,:)=RR1(I,:)+1
                WHERE(RR1(I,:).GE.1.0)RR1(I,:)=RR1(I,:)-1
                !IF(IND1.LE.NCUB.AND.IDIFFUSE==1)TPOS(IND1,IND2,IND3,I,:)=RR1(I,:) + (/IND1-1, IND2-1,IND3-1 /)
                IF(LL.GE.2.AND.ISKIP.NE.1)THEN
                !POS(LL-1,I,:)=MATMUL(ISLAT,POS(LL-1,I,:))
                POS(LL-1,I,:)=MATMUL(POS(LL-1,I,:),ISLAT)
               ! IF(I==1)PRINT*,POS(LL-1,I,:)
               ! IF(I==1) PAUSE
                AA=POS(LL,I,:)-POS(LL-1,I,:)
                WHERE(AA.LT.-0.5)POS(LL,I,:)=POS(LL,I,:)+1
                WHERE(AA.GT.+0.5)POS(LL,I,:)=POS(LL,I,:)-1
                !POS(LL-1,I,:)=MATMUL(SLAT,POS(LL-1,I,:))
                POS(LL-1,I,:)=MATMUL(POS(LL-1,I,:),SLAT)
                ENDIF

                IF(IWRITE==1)WRITE(3,3)POS(LL,I,:)
                !POS(LL,I,:)=MATMUL(SLAT,POS(LL,I,:))
                POS(LL,I,:)=MATMUL(POS(LL,I,:),SLAT)
                IF(IVEL.EQ.0.AND.LL.GE.2.0)THEN
                IF(IDIFFUSE==0)VEL(LL,I,:)=(POS(LL,I,:)-POS(LL-1,I,:))/DELT
                !92 FORMAT(3F9.3,2x,3f9.3)
                END IF

           END DO
          END DO
        END DO
END IF


!###################################################
!       ##############################################
!       ##########################################
!       ##############        
        IINTERVAL=MOD(LL,INTERVAL)
        IF(IINTERVAL.EQ.0.AND.IT.LE.(IREF2-IREF1+1))THEN
        IPOINTS=IPOINTS+1
        IF(IGRR==1)CALL GRRFN4LAMMPS
!IF(IDIFFUSE==2) CALL NEWDIFFUSE2021 !#########################
!IF(IDIFFUSE==1) CALL DIFFUSE2022 !#########################

!        IF(ASTATUS.AND.IRECORD.LT.10)THEN
!        WRITE(FLNMPOSCAR,'("POSCAR",I4.4)')LL
!        PRINT*,FLNMPOSCAR
!        CALL PRINTPOSCAR(LL,FLNMPOSCAR)
!        IRECORD=IRECORD+1
!        END IF
!        PRINT*,'GOING TO ANGLE'
        IF(IANGLE==1)CALL ANGLECAL
        !IF(IDIFF==1)CALL DIFFRACTION
        END IF
        103 FORMAT(I7,1000E10.3)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!POLY THINGS!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
IF (IT==1.AND.IPOLY==1)THEN
DO I=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
        NC1=0
        NK=0
        DO J=SUM(NNTYPE(1:SATOM-1))+1,SUM(NNTYPE(1:SATOM))   !,NNTYPE(CATOM)
                AA=RR1(I,:)-RR1(J,:)
                WHERE(AA.LT.-0.5)AA=AA+1
                WHERE(AA.GT.0.5)AA=AA-1
                RIJ=NORM2(MATMUL(AA,SLAT))
                IF(RIJ.GT.0.AND.RIJ.LE.BOND)THEN
                 NC1=NC1+1       !!!!!!!!CORDINATION1
                 IF(NC1.GT.NCORD)EXIT
                        NK=NK+1
                        PICK(I,NK,1)=I
                        PICK(I,NK,2)=J
                END IF
        END DO
END DO
END IF


!!!!!!!!!!!!!!!!
IF(MOD(IT,INTERVAL2)==0.AND.IPOLY==1)THEN
    !PRINT*,iT
  NEWLAT=MATMUL(IAXIS,SLAT)
  JJJJ=0
  JTAG=0
  DO J=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
   JTAG=JTAG+1         !!!!!!!!!EQUIVALENT TO RUN OVER J
   JJJJ=JJJJ+1
   JK=0
   DO JK=1,NK  !SUM(NNTYPE(1:SATOM-1))+1,SUM(NNTYPE(1:SATOM))   !,NNTYPE(CATOM)
    !PRINT*,J,Jk !iT
    DDD=(RR1(J,:)-RR1(PICK(J,JK,2),:))
!    DDD=(POS(IT,J,:)-POS(IT,PICK(J,JK,2),:))
!    DDD=MATMUL(DDD,ISLAT)                           !!!!!!!!FRACTIONAL POSITION 
    WHERE(DDD.LT.-0.5)DDD=DDD+1.0
    WHERE(DDD.GT.0.5)DDD=DDD-1.0
    XYZ=MATMUL(DDD,NEWLAT)
    X=XYZ(1)
    Y=XYZ(2)
    Z=XYZ(3)
    D2=NORM2(XYZ)
    !PRINT*,D2 !XYZ
    !PAUSE
      DDDD(JTAG,JK)=D2  !NORM2(DDD)
      RXY=SQRT(Y*Y + Z*Z)
      ANGLETHETA(JJJJ,JK)=ACOS(X/D2)
      IF(RXY==0)THEN
      ANGLEPHI(JJJJ,JK)=0
      ELSE
      ANGLEPHI(JJJJ,JK)=ACOS(Y/rxy)
      !IF(Y.GT.0.AND.Z.LT.0)ANGLEPHI(JJJJ,JK)=ANGLEPHI(JJJJ,JK)+ 3*TWOPI/4.0
      !IF(Y.LT.0.AND.Z.LT.0)ANGLEPHI(JJJJ,JK)=ANGLEPHI(JJJJ,JK)+ TWOPI/4.0
      END IF
      !!!!!!!!!       PROBABILITY DENSITY FUNCTION!!!!!!!!!!!!!!!!
       IF(ANGLETHETA(JJJJ,JK).GT.0.AND.ANGLEPHI(JJJJ,JK).GT.0)THEN
       PROBDENSITY(JTAG,INT(ANGLETHETA(JJJJ,JK)*RTOPI/2.0),INT(ANGLEPHI(JJJJ,JK)*RTOPI/2.0))=PROBDENSITY(JTAG,INT(ANGLETHETA(JJJJ,JK)*RTOPI/2.0),INT(ANGLEPHI(JJJJ,JK)*RTOPI/2.0))+1
       END IF
   END DO!SURROUNDING SERACH ENDS
    AVGBOND=SUM(DDDD(JJJJ,:))/NCORD !JK   
    DISTORTION(JTAG)=SQRT(DOT_PRODUCT(DDDD(JTAG,:),DDDD(JTAG,:)) -NCORD*AVGBOND*AVGBOND)
    DISTORTION(JTAG)=DISTORTION(JTAG)/(NCORD*AVGBOND*AVGBOND)
!!!!!!!!!!BOND DISTRIBUTION!!!!!!!!!!!!!   
   DO IR=1,500
   DR1=DR0+(IR-1)*RSTEP
   DR2=DR0+IR*RSTEP
   DO JKK=1,NCORD  !JK
   IF(DDDD(JJJJ,JKK).GT.DR1 .AND.DDDD(JJJJ,JKK).LE.DR2)BDIST(IR,JKK)=BDIST(IR,JKK)+1
   END DO
   END DO  !!END BOND DISTRI
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  END DO !CENTRE ATOM ENDS HERE
  WRITE(4106,2103)DELT*REAL(IT),DISTORTION(:)
  WRITE(4100,2100)DELT*REAL(IT),(ANGLETHETA(JJJJ,1:NCORD)*RTOPI,JJJJ=1,NNTYPE(CATOM))
  2100 FORMAT(F10.4,100000F7.1)
  WRITE(4101,2100)DELT*REAL(IT),(ANGLEPHI(JJJJ,1:NCORD)*RTOPI,JJJJ=1,NNTYPE(CATOM))
  WRITE(4102,2102)DELT*REAL(IT),(DDDD(JJJJ,1:NCORD),JJJJ=1,NNTYPE(CATOM))
END IF ! DO     !!!!!!!!!!!!!!!!TIME ENDS HERE
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
END DO   !!!!!!!!!!!!!!!TIME ENDS 



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
IF(IGRR==1)THEN

WRITE(83,*)'#r0  pairs, GRTTOTAL, X-ray-weighted, neutron-weighted'
DO IDR=1,NR
!WRITE(83,83)R0+(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(IPOINTS),J=I,NTYP),I=1,NTYP),GAVG(IDR)/REAL(IPOINTS)
!WRITE(83,83)(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(IPOINTS),J=I,NTYP),I=1,NTYP),GAVG(IDR)/REAL(IPOINTS) , SUM(GRRTAVG(IDR,:,:))/REAL(IPOINTS), SUM(GRRTAVGXRAY(IDR,:,:))/REAL(IPOINTS)
WRITE(83,83)(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(IPOINTS),J=I,NTYP),I=1,NTYP), SUM(GRRTAVG(IDR,:,:))/REAL(IPOINTS), SUM(GRRTAVGXRAY(IDR,:,:))/REAL(IPOINTS), SUM(GRRTAVGNEUTRON(IDR,:,:))/REAL(IPOINTS)
!WRITE(831,83)(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(IPOINTS),J=I,NTYP),I=1,NTYP),GAVG(IDR)/REAL(IPOINTS)
END DO
83 FORMAT(F6.3,2x,100(E11.4,2x))
END IF



IF(IANGLE==1)THEN
OPEN(13,FILE="ANGLEVAR.DAT")
        DO ITH=-180,180
        !WRITE(13,13)THE0+ITH*DELTH, (THETA(ITH,INDEX1(I,1),INDEX1(I,2),INDEX1(I,3))/REAL(IPOINTS),I=1,MAXINDEX)
        WRITE(13,13)REAL(ITH), (THETA(ITH,INDEX1(I,1),INDEX1(I,2),INDEX1(I,3))/REAL(IPOINTS),I=1,MAXINDEX)
        13 FORMAT(20(F15.5,2X))
        END DO
CLOSE(13)

OPEN(14,FILE="AVGANGLE.DAT")
        DO I=1,NTYP
        DO J=1,NTYP
        DO K=1,NTYP
        WRITE(14,14)J,I,K,AVGANG(J,I,K)/REAL(IPOINTS)
        14 FORMAT(3I5,F10.5)
        END DO
        END DO
        END DO
CLOSE(14)
END IF
PRINT*,'USEFUL STEPS ARE',LL !IREF2-IREF1+1
PRINT*, "LAMMPS READING IS DONE, and no. of steps are:",NSTEP
CLOSE(2)
CLOSE(3)
AVGSLAT=AVGSLAT/(IREF2-IREF1+1)
AVGISLAT=AVGSLAT   !!!!!!!!!!!!!!!!!!NEED TO CHANGE FOR NPT SCHEME!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
CALL GAUSS(AVGISLAT,3)
199 FORMAT(3F15.9)

VOLUME=AVGSLAT(1,1)* (AVGSLAT(2,2)*AVGSLAT(3,3)-AVGSLAT(2,3)*AVGSLAT(3,2)) + AVGSLAT(1,2)* (AVGSLAT(2,3)*AVGSLAT(3,1)-AVGSLAT(2,1)*AVGSLAT(3,3)) + AVGSLAT(1,3)* (AVGSLAT(2,1)*AVGSLAT(3,2)-AVGSLAT(2,2)*AVGSLAT(3,1))


POSSTART(:,:)=POS(1,:,:)

!!!!!!!!!!!!!!POLY THINGS
IF(IPOLY==1)THEN
!!!!!!!!!!!!!!!!POLY
DO IR=1,500
DR1=DR0+(IR-1)*RSTEP
WRITE(4103,2101)DR1,BDIST(IR,1:NCORD)
END DO
2101 FORMAT(F9.4,10I12)
2102 FORMAT(F9.4,1000F10.3)
2103 FORMAT(F9.4,1000F10.4)
DO J=0,180
DO I=0,90
WRITE(5000,2104) 2*REAL(J),2*REAL(I), ((PROBDENSITY(J1,I,J)/SUM(PROBDENSITY(J1,:,:))), J1=1,NNTYPE(CATOM) )  !X axis isphi and Y axis is theta
2104 FORMAT(1003E16.5)
END DO
END DO
END IF

!!!!!!!!!!!!!!!!!!!!!!!!AVERAGE STRUCTURE!!!!!!!!!!!!!!!!!!

!NX=10
!NY=10
!NZ=10
WRITE(199,*)'AVERAGE STRUCTURE'
WRITE(199,*)'1.0'
WRITE(199,199)SLAT(1,:)
WRITE(199,199)SLAT(2,:)
WRITE(199,199)SLAT(3,:)
WRITE(199,*)ATMNM
WRITE(199,*)NNTYPE !/(NX*NY*NZ)
WRITE(199,*)'D'



DO I=1,NATOM
WRITE(199,199)MATMUL(SUM(POS(IREF1:IREF2,I,:),DIM=1)/(IREF2-IREF1+1),ISLAT)
END DO
!199 FORMAT(3F20.10)
!
!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!
END SUBROUTINE




SUBROUTINE VVACF3
use omp_lib
USE VARIABLES1
IMPLICIT NONE
COMPLEX,ALLOCATABLE,DIMENSION(:,:,:)::VELC
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DIFFUSION,DIFFUSIONC,CDIFFUSION
DOUBLE PRECISION::PHASE1
INTEGER::IFOR,IBAC,ISCHEME,PLAN
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::AAAA,BBBB,HR
INTEGER::II1,I1
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DOS,DOSB   !!!!DOSB BROADENED 
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DOST,DOSTB
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DOSTBS,DOSBS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DOSTBSS
COMPLEX,ALLOCATABLE,DIMENSION(:,:,:)::VACFC
COMPLEX,ALLOCATABLE,DIMENSION(:,:,:)::VACFCT,CDOS
DOUBLE PRECISION::TOTAL_WEIGHT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::WEIGHT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::NWPDOS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::SCALTYPE,DUMMY1,DUMMY2
DOUBLE PRECISION,DIMENSION(1000)::CV
DOUBLE PRECISION::FRE,TEMP,H ,KB  ,HH   
DOUBLE PRECISION,EXTERNAL::DNBOSE1
DOUBLE PRECISION,EXTERNAL::NBOSE1
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::U2E
ALLOCATE(U2E(NDOS,NTYP,3))
HH=6.626068E-26/1.66053886E-27
H=6.626069300000000159e-22   ! ORDER OF 12 LESS BECAUSE WHEN WE MULTIPLY W IT IS IN THZ
KB=1.380650500000000147e-23
!BETA1=47.99237243603648754
IF(IVACF==1)OPEN(8558,FILE='HAVEN_RATIO')
ALLOCATE(VELC(NSTEP,NATOM,3),DIFFUSION(NTYP,3),AAAA(2*NSTEP),DOS(NSTEP,NATOM,3),DOST(NSTEP,NTYP,3),DOSTB(NSTEP,NTYP,3),VACFC(NSTEP,NATOM,3),VACFCT(NSTEP,NTYP,3))
ALLOCATE(DOSB(NSTEP,NATOM,3))
ALLOCATE(DIFFUSIONC(NTYP,3))
ALLOCATE(CDIFFUSION(NTYP,3))
ALLOCATE(WEIGHT(NTYP))
ALLOCATE(NWPDOS(NSTEP,NTYP))
ALLOCATE(SCALTYPE(NTYP))
ALLOCATE(BBBB(2*NSTEP))
ALLOCATE(DOSTBS(NSTEP,NTYP),DOSBS(NSTEP,NATOM))
ALLOCATE(DOSTBSS(NSTEP))
ALLOCATE(DUMMY1(NDOS),DUMMY2(NDOS))
ALLOCATE(CDOS(NSTEP,NTYP,3))
ALLOCATE(HR(NTYP))
IFOR= 1
IBAC=-1
!!!!!!!!!!!!!!!!!!!!!!!!!VACF!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
PRINT*, "I M IN VVACF1"
PRINT*,NSTEP
ITYP=1
        DO I=1,NATOM
                DO J=1,3 !!!!!!!!!CARTESIAN DEGREE OF FREEDOME

        		AAAA(1:2*NSTEP:2)=VEL(1:NSTEP,I,J)  !REAL(FQT(II1,I))
        		AAAA(2:2*NSTEP:2)=0 !VEL(II1,I,J) !AIMAG(FQT(II1,I))
                        CALL DFOUR1(AAAA,NSTEP,IFOR)
                        AAAA=AAAA/REAL(NSTEPORIG)

                		VELC(1:NSTEP,I,J)=CMPLX(AAAA(1:2*NSTEP:2),AAAA(2:2*NSTEP:2))   !!!!!!!
                                DOS(1:NSTEP,I,J)= (VELC(1:NSTEP,I,J)*CONJG(VELC(1:NSTEP,I,J)))
                                IF(I.LE.SUM(NNTYPE(1:ITYP)).AND.I.GT.SUM(NNTYPE(1:ITYP-1)))THEN
                                IITYP=ITYP
                                ELSE
                                IITYP=IITYP+1
                                ITYP=IITYP
                                END IF
                                DOST(1:NSTEP,IITYP,J)=DOST(1:NSTEP,IITYP,J)+DOS(1:NSTEP,I,J)/NNTYPE(IITYP)
                END DO
        END DO


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!VACF!!!!!!!!!!!!!!!!!!
ITYP=1
        DO I=1,NATOM
                DO J=1,3 !!!!!!!!!CARTESIAN DEGREE OF FREEDOME
                        AAAA(1:2*NSTEP:2)=DOS(1:NSTEP,I,J)  !REAL(FQT(II1,I))
        		AAAA(2:2*NSTEP:2)=0  !AIMAG(FQT(II1,I))
                        CALL dfour1(AAAA,NSTEP,IBAC)
        		VACFC(1:NSTEP,I,J)=CMPLX(AAAA(1:2*NSTEP:2),AAAA(2:2*NSTEP:2))   !!!!!!!
              END DO
        END DO
        
        DO I=1,NTYP
        VACFCT(:,I,:)=SUM(VACFC(:,SUM(NNTYPE(1:I-1)) +1: SUM(NNTYPE(1:I)),:)/NNTYPE(I),DIM=2)  !/NNTYPE(IITYP)
        END DO
        DO I=1,NTYP
        PRINT*, SUM((VEL(1,SUM(NNTYPE(1:I-1)) +1: SUM(NNTYPE(1:I)),:)**2)/NNTYPE(I),DIM=1)  !/NNTYPE(IITYP)
        END DO

        DO IT=1,NSTEP
        WRITE(80,80) REAL((IT-1)*DELT),(VACFCT(IT,ITYP,1:3),ITYP=1,NTYP)
        80 FORMAT(E15.5,2X,100(3(2E20.8,2x)3x)) 
        END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!CORRELATION CALCULATION
!!!!!!!!!!!!!!!!!!!!!!!!!CROSS VACF

        DO IT=1,NTYP
                DO I=SUM(NNTYPE(1:IT-1))+1 ,SUM(NNTYPE(1:IT))               
                DO J=SUM(NNTYPE(1:IT-1))+1 ,SUM(NNTYPE(1:IT))               
                IF(I.NE.J) CDOS(:,IT,:)=CDOS(:,IT,:)+ (VELC(:,I,:)*CONJG(VELC(:,J,:)))
                END DO
                END DO
                CDOS(:,IT,:)=CDOS(:,IT,:)/NNTYPE(IT)
                !FOURIER STUFF        
                DO J=1,3
                AAAA(1:2*NSTEP:2)=CDOS(1:NSTEP,IT,J)  !REAL(FQT(II1,I))
                AAAA(2:2*NSTEP:2)=0  !AIMAG(FQT(II1,I))
                CALL dfour1(AAAA,NSTEP,IBAC)
                CDOS(1:NSTEP,IT,J)=CMPLX(AAAA(1:2*NSTEP:2),AAAA(2:2*NSTEP:2))   !!!!!!!
                END DO
                PRINT*,'CROSS VACF' 
                PRINT*, 1.0E-4*DELT*SUM(CDOS(:,IT,:),DIM=1)/2.0  !/NNTYPE(IITYP)

        END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
PRINT*,'DIFFUSION in cm2/sec,and Haven Ratio'
DO I=1,NTYP
PRINT*, ATMNM(I)
DIFFUSION(I,1)=1.0E-4*DELT*SUM(REAL(VACFCT(1:NSTEP,I,1)))/2  !i/(3.0*NNTYPE(I))
DIFFUSION(I,2)=1.0E-4*DELT*SUM(REAL(VACFCT(1:NSTEP,I,2)))/2 !/(3.0*NNTYPE(I))
DIFFUSION(I,3)=1.0E-4*DELT*SUM(REAL(VACFCT(1:NSTEP,I,3)))/2  !/(3.0*NNTYPE(I))
CDIFFUSION(I,1)= 1.0E-4*DELT*SUM(REAL(CDOS(1:NSTEP,I,1)))/2  !i/(3.0*NNTYPE(I))
CDIFFUSION(I,2)= 1.0E-4*DELT*SUM(REAL(CDOS(1:NSTEP,I,2)))/2 !/(3.0*NNTYPE(I))
CDIFFUSION(I,3)= 1.0E-4*DELT*SUM(REAL(CDOS(1:NSTEP,I,3)))/2  !/(3.0*NNTYPE(I))

PRINT*,'SELF=',SUM(DIFFUSION(I,:))/3.0
PRINT*,'CROSS=',SUM(CDIFFUSION(I,:))/3.0
!,DIFFUSIONC(I,:)
62 FORMAT(3E10.3,2X,3E10.3)
HR(I)=SUM(DIFFUSION(I,:))/(SUM(DIFFUSION(I,:))+SUM(CDIFFUSION(I,:)))

PRINT*,'HAVEN  RATIO',HR(I)
WRITE(8558,*)HR(I)
END DO


!DIFFUSION(


!!!!!!!!!!!!!!!!!!!!!!!!!!!DEFINE DELE FOR BROADENING PURPOSE

!###################################################################################
        DELW=4.136*REAL(1/(DELT*NSTEP))                                           !#
        DO I=1,NTYP                                                               !# 
        DO J=1,3                                                                  !
        DOST(:,I,J)=DOST(:,I,J)/(DELW*SUM(DOST(1:NSTEP/2,I,J)))                   !
        END DO                                                                    !
        END DO                                                                    ! 
                                                                                  !
        DO I=1,NATOM                                                              !
        DO J=1,3                                                                  !
        DOS(:,I,J)=DOS(:,I,J)/(DELW*SUM(DOS(1:NSTEP/2,I,J)))                      !
        END DO                                                                    !
        END DO                                                                    !
!###################################################################################

DELE=4.136/REAL(DELT*NSTEP)
PRINT*,'DELE in meV=',DELE
PRINT*,NDOS

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!BROADENING THE DATA!!!!!!!!!!!!!!!!!!!!!!!
DO IJ=1,NTYP
DUMMY1=DOST(1:NDOS,IJ,1)
print*,'typ',IBROAD
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)

!#print*,'ityp',IJ
DOSTB(1:NDOS,IJ,1)=DUMMY2
DUMMY1=DOST(:,IJ,2)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSTB(1:NDOS,IJ,2)=DUMMY2

DUMMY1=DOST(1:NDOS,IJ,3)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSTB(1:NDOS,IJ,3)=DUMMY2
END DO
!PRINT*, 'FWHM in meV='
!READ*,FWHM
!FWHM=3.0 

!PRINT*, 'FWHM in meV=',FWHM0
!DELW=4.136*REAL(1/(DELT*NSTEP))

!DO I=1,NDOS  !NSTEP
!        OMEGA=4.136*REAL((I-1)/(DELT*NSTEP))
!        IF(OMEGA.GT.200)EXIT
!        FWHM=(FWHM0**2)  + ((FWHM1*OMEGA/100)**2)
!        DO IJ=1,NTYP   !!!!!!!!!! for dimension
!        SUMM=0
!                DO IK=0,NSTEP !1000
!                DELX=REAL(I-IK)*DELW
!                DELX=DELX*DELX
!                BROAD=EXP(-DELX/FWHM)
!                DOSTB(I,IJ,:)=DOSTB(I,IJ,:)+DOST(IK,IJ,:)*BROAD
!                SUMM=SUMM+BROAD
!                END DO
!                IF(SUMM.GT.0)DOSTB(I,IJ,:)=DOSTB(I,IJ,:)/SUMM
!        END DO
!END DO
!!!!!!!!!!!!!!!!!BROADENING OF INDIVIDUAL!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
IF(INDIVIDUAL==1)THEN
DO IJ=1,NATOM
DUMMY1=DOS(1:NDOS,IJ,1)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSB(1:NDOS,IJ,1)=DUMMY2

DUMMY1=DOS(1:NDOS,IJ,2)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSB(1:NDOS,IJ,2)=DUMMY2

DUMMY1=DOS(1:NDOS,IJ,3)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSB(1:NDOS,IJ,3)=DUMMY2
END DO
END IF
!DO I=1,NDOS  !NSTEP
!        OMEGA=4.136*REAL((I-1)/(DELT*NSTEP))
!        IF(OMEGA.GT.200)EXIT
!        FWHM=(FWHM0**2)  + ((FWHM1*OMEGA/100)**2)
!        DO IJ=1,NATOM   !!!!!!!!!! for dimension
!        SUMM=0
!                DO IK=0,NSTEP !1000
!                DELX=REAL(I-IK)*DELW
!                DELX=DELX*DELX
!                BROAD=EXP(-DELX/FWHM)
!                DOSB(I,IJ,:)=DOSB(I,IJ,:)+DOS(IK,IJ,:)*BROAD
!                SUMM=SUMM+BROAD
!                END DO
!                IF(SUMM.GT.0)DOSB(I,IJ,:)=DOSB(I,IJ,:)/SUMM
!        END DO
!END DO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!DELEE=4.136*REAL(1)/(DELT*NSTEP)
!NCUT=ECUT/DELEE

!!!!!!!!!!!!!!!!!!!!!!!!!NORMALIZATION 
!DO ITYP=1,NTYP
!ANORM1=SUM(ABS(DOSTB(1:NCUT,ITYP,1)))*DELW
!ANORM2=SUM(ABS(DOSTB(1:NCUT,ITYP,2)))*DELW
!ANORM3=SUM(ABS(DOSTB(1:NCUT,ITYP,3)))*DELW
!DOSTB(:,ITYP,1)=DOSTB(:,ITYP,1)/ANORM1
!DOSTB(:,ITYP,2)=DOSTB(:,ITYP,2)/ANORM1
!DOSTB(:,ITYP,3)=DOSTB(:,ITYP,3)/ANORM1
!DOSTBS(:,ITYP)=(DOSTB(:,ITYP,1)+DOSTB(:,ITYP,2)+DOSTB(:,ITYP,3))/3.0
!END DO
!DO ITYP=1,NATOM
!ANORM1=SUM(ABS(DOSB(1:NCUT,ITYP,1)))*DELW
!ANORM2=SUM(ABS(DOSB(1:NCUT,ITYP,2)))*DELW
!ANORM3=SUM(ABS(DOSB(1:NCUT,ITYP,3)))*DELW
!DOSB(:,ITYP,1)=DOSB(:,ITYP,1)/ANORM1
!DOSB(:,ITYP,2)=DOSB(:,ITYP,2)/ANORM1
!DOSB(:,ITYP,3)=DOSB(:,ITYP,3)/ANORM1
!DOSBS(:,ITYP)=(DOSB(:,ITYP,1)+DOSB(:,ITYP,2)+DOSB(:,ITYP,3))/3.0
!END DO


!!!!!!!!!!!!!!!!!!!!!REMOVE NEGATIVE DOS    SET TO ZERO!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
DO ITYP=1,NTYP
DO IIII=1,NDOS
IF(DOSTB(IIII,ITYP,1).LT.0)DOSTB(IIII,ITYP,1)=0
IF(DOSTB(IIII,ITYP,2).LT.0)DOSTB(IIII,ITYP,2)=0
IF(DOSTB(IIII,ITYP,3).LT.0)DOSTB(IIII,ITYP,3)=0
END DO
END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


DO ITYP=1,NTYP
ANORM1=SUM(ABS(DOSTB(1:NDOS,ITYP,1)))*DELW
ANORM2=SUM(ABS(DOSTB(1:NDOS,ITYP,2)))*DELW
ANORM3=SUM(ABS(DOSTB(1:NDOS,ITYP,3)))*DELW
DOSTB(:,ITYP,1)=DOSTB(:,ITYP,1)/ANORM1
DOSTB(:,ITYP,2)=DOSTB(:,ITYP,2)/ANORM1
DOSTB(:,ITYP,3)=DOSTB(:,ITYP,3)/ANORM1
DOSTBS(:,ITYP)=(DOSTB(:,ITYP,1)+DOSTB(:,ITYP,2)+DOSTB(:,ITYP,3))/3.0
END DO
DO ITYP=1,NATOM
ANORM1=SUM(ABS(DOSB(1:NDOS,ITYP,1)))*DELW
ANORM2=SUM(ABS(DOSB(1:NDOS,ITYP,2)))*DELW
ANORM3=SUM(ABS(DOSB(1:NDOS,ITYP,3)))*DELW
DOSB(:,ITYP,1)=DOSB(:,ITYP,1)/ANORM1
DOSB(:,ITYP,2)=DOSB(:,ITYP,2)/ANORM1
DOSB(:,ITYP,3)=DOSB(:,ITYP,3)/ANORM1
DOSBS(:,ITYP)=(DOSB(:,ITYP,1)+DOSB(:,ITYP,2)+DOSB(:,ITYP,3))/3.0
END DO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        

!        WRITE(81,*) '#ENE(meV), DOSXYZ_TYPE, DOSXYZIMG_TYPE'
!        WRITE(82,*) '#ENE(meV), DOS_TYPE_AS IN XDATCAR DOS_TOTAL'

        DO IT=1,NDOS
        OMEGA=4.136*REAL((IT-1)/(DELT*NSTEP))
        DOSTBSS(IT)=SUM(DOSTBS(IT,:)*NNTYPE(:))/(SUM(NNTYPE(:)))
        WRITE(81,81) OMEGA,(DOSTB(IT,ITYP,:),ITYP=1,NTYP)
        WRITE(82,81) OMEGA,(DOSTBS(IT,ITYP),ITYP=1,NTYP),DOSTBSS(IT)
        WRITE(821,81) OMEGA,(DOSBS(IT,ITYP),ITYP=1,NATOM)
        81 FORMAT(E15.5,2X,10000(3E20.8,2x)) 
        END DO


        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

        !!!!!!!!!!!!!!!!!!!NEUTRON WEIGHTED DOS!!!!!!!!!!!!!!!

PRINT*, ' I AM IN NEUTRON'
WEIGHT=NNTYPE*BBT2/MASST
TOTAL_WEIGHT=SUM(WEIGHT) 
PRINT*,'WEIGHT'
PRINT*, WEIGHT
NWPDOS=0

DO I=1,NDOS  !NSTEP
OMEGA=4.136*REAL((I-1)/(DELT*NSTEP))

        DO IJ=1,NTYP
        NWPDOS(I,IJ)=NWPDOS(I,IJ) +  (WEIGHT(IJ)*SUM(DOSTB(I,IJ,:))/(3.0*TOTAL_WEIGHT))
        END DO
WRITE(85,8)OMEGA,(NWPDOS(I,IJ),IJ=1,NTYP),(SUM(NWPDOS(I,1:NTYP)))
8 FORMAT(F10.4,1000E15.5)
!PRINT*,I
END DO
!!!!!!!!!!!!!!CALCULATE SPECIFIC HEAT!!!!!!!!!!
J=0
CV=0
DO TEMP=10,1000,10
J=J+1
DO I=1,NDOS
  FRE=REAL((I-1)/(DELT*NSTEP))
!  CV(J)= CV(J)+ 3*H*FRE*DOSTBSS(I)*(DNBOSE1(FRE,TEMP))*DELW* 6.023E23
  CV(J)= CV(J)+ H*FRE*DOSTBSS(I)*(DNBOSE1(FRE,TEMP))*DELW/KB !* 6.023E23
END DO
WRITE(86,86)TEMP,CV(J)
86 FORMAT(F10.5,3E15.5)
END DO
!/(V0*0.14824687E-30)



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!MSD FROM DOS UNDER HARMONIC  !APPROXIMATION!!!!!!!!!!!!!!!!!!!!!
IF(IMSD==1)OPEN(1002,FILE="U2EXYZ")
IF(IMSD==1)OPEN(1003,FILE="U2E")
DO I=1,NDOS  !POINTS
OMEGA=REAL((I-1)/(DELT*NSTEP))
FRE=OMEGA 
        DO J=1,NTYP
        U2e(I,J,:)=(NBOSE1(FRE,TEMPERATURE) +0.5)*HH*DOSTB(I,J,:)/(4*PI*PI*MASST(J)*FRE)
        END DO
IF(OMEGA.GE.0.001)WRITE(1002,2)4.136*OMEGA,(U2E(I,J,1:3),J=1,NTYP)
IF(OMEGA.GE.0.001)WRITE(1003,2)4.136*OMEGA,(SUM(U2E(I,J,1:3)),J=1,NTYP)
2 FORMAT(100F20.10)
ENDDO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


CLOSE(1002)
CLOSE(1003)
!ALLOCATE(VELC(NSTEP,NATOM,3),DIFFUSION(NTYP,3),AAAA(2*NSTEP),DOS(NSTEP,NATOM,3),DOST(NSTEP,NTYP,3),DOSTB(NSTEP,NTYP,3),VACFC(NSTEP,NATOM,3),VACFCT(NSTEP,NTYP,3))
!ALLOCATE(DOSB(NSTEP,NATOM,3))
!ALLOCATE(DIFFUSIONC(NTYP,3))
!ALLOCATE(CDIFFUSION(NTYP,3))
!ALLOCATE(WEIGHT(NTYP))
!ALLOCATE(NWPDOS(NSTEP,NTYP))
!ALLOCATE(SCALTYPE(NTYP))
!ALLOCATE(BBBB(2*NSTEP))
!!ALLOCATE(DOSTBS(NSTEP,NTYP),DOSBS(NSTEP,NATOM))
!ALLOCATE(DOSTBSS(NSTEP))
!ALLOCATE(DUMMY1(NDOS),DUMMY2(NDOS))
!ALLOCATE(CDOS(NSTEP,NTYP,3))
!ALLOCATE(HR(NTYP))
DEALLOCATE(VELC,DIFFUSION,AAAA,DOS,DOST,DOSTB,VACFC,VACFCT,DOSB,DIFFUSIONC,CDIFFUSION,WEIGHT,NWPDOS,SCALTYPE,BBBB,DOSTBSS,DUMMY1,DUMMY2,CDOS,HR) 
!        DEALLOCATE(NWPDOS,WEIGHT)
END SUBROUTINE        

























SUBROUTINE MSD4
USE VARIABLES1
use omp_lib
IMPLICIT NONE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::MSDX,MSDY,MSDZ,MSDGX,MSDGY,MSDGZ,MMSDX,MMSDY,MMSDZ
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::CMMSDX,CMMSDY,CMMSDZ
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::TCMMSDX,TCMMSDY,TCMMSDZ
INTEGER::I1,IBAC,IFOR,II1
INTEGER::M
INTEGER::NSTEPORIG2
DOUBLE PRECISION::POSINT !,CORR2
DOUBLE PRECISION,DIMENSION(NATOM,3)::CORR
DOUBLE PRECISION,DIMENSION(NATOM)::CORR3,CORR1,CORR2
DOUBLE PRECISION,ALLOCAtaBle,DIMENSION(:,:,:)::UU
ALLOCATE(MSDX(NSTEPORIG,NATOM))
ALLOCATE(MSDY(NSTEPORIG,NATOM))
ALLOCATE(MSDZ(NSTEPORIG,NATOM))
ALLOCATE(MSDGX(NSTEPORIG,NTYP))
ALLOCATE(MSDGY(NSTEPORIG,NTYP))
ALLOCATE(MSDGZ(NSTEPORIG,NTYP))
ALLOCATE(UU(NSTEPORIG,NATOM,3))
ALLOCATE(MMSDX(NSTEPORIG,NTYP))
ALLOCATE(MMSDY(NSTEPORIG,NTYP))
ALLOCATE(MMSDZ(NSTEPORIG,NTYP))
ALLOCATE(CMMSDX(NSTEPORIG,NTYP))
ALLOCATE(CMMSDY(NSTEPORIG,NTYP))
ALLOCATE(CMMSDZ(NSTEPORIG,NTYP))
ALLOCATE(TCMMSDX(NSTEPORIG))
ALLOCATE(TCMMSDY(NSTEPORIG))
ALLOCATE(TCMMSDZ(NSTEPORIG))
OPEN(145,FILE="MSDXYZ")
OPEN(146,FILE="MSD")
!DOUBLE PRECISION,ALLOCATABLE ,DIMENSION(:)::MSDAVG
!COMPLEX,DIMENSION(NSTEP)::MSDI
MSDX=0
MSDY=0
MSDZ=0
MSDGX=0
MSDGY=0
MSDGZ=0
NSTEPORIG2=IREF2-IREF1+1 
PRINT*,NSTEPORIG2
PRINT*, 'THE U2 IS AVERAGED FOR',NSTEPI,'LENGHT, WITH ',OINT, 'INTERVAL'
!READ*,NSTEPI
IF(NSTEPI.GT.NSTEPORIG2)NSTEPI=NSTEPORIG2
!$omp parallel do
DO I=1,NATOM
PRINT*, 'ATOM NO',I,'has been done MSD4'
                DO DT=1,NSTEPORIG2-OINT
                NSTEP1=NSTEPI
                NSTEP2=NSTEPI+DT
                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP1=NSTEPORIG2-DT
                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP2=NSTEP1+DT
                MSDX(DT,I)=SUM((POS(1:NSTEP1:OINT,I,1)-POS(1+DT:NSTEP2:OINT,I,1))**2) ! + &
                MSDY(DT,I)=SUM((POS(1:NSTEP1:OINT,I,2)-POS(1+DT:NSTEP2:OINT,I,2))**2) !
                MSDZ(DT,I)=SUM((POS(1:NSTEP1:OINT,I,3)-POS(1+DT:NSTEP2:OINT,I,3))**2) !  )
                TAO=NSTEPI
                IF(NSTEPI+DT.GT.NSTEPORIG2)TAO=NSTEPORIG2-DT
                MSDX(DT,I)=MSDX(DT,I)/REAL((TAO/OINT))
                MSDY(DT,I)=MSDY(DT,I)/REAL((TAO/OINT))
                MSDZ(DT,I)=MSDZ(DT,I)/REAL((TAO/OINT))
                END DO
!                       MSD(DT,I)=sum( (PPOS(1:nstep,:) - PPOS(1+dt:nstep+dt,:))**2 ) /dble(nt)
END DO
!$omp end parallel do


                        N1=0
                        N2=0
                        DO M=1,NTYP

                                N1=N2+1
                                N2=N1+NNTYPE(M)-1
                                DO K=N1,N2
                                MSDGX(:,M)=MSDGX(:,M)+MSDX(:,K)
                                MSDGY(:,M)=MSDGY(:,M)+MSDY(:,K)
                                MSDGZ(:,M)=MSDGZ(:,M)+MSDZ(:,K)
                                END DO
                        MSDGX(:,M)=MSDGX(:,M)/NNTYPE(M)
                        MSDGY(:,M)=MSDGY(:,M)/NNTYPE(M)
                        MSDGZ(:,M)=MSDGZ(:,M)/NNTYPE(M)
                        END DO
DO I=1,NSTEPORIG2-OINT
                WRITE(195,98)DELT*REAL(I),((MSDX(I,K)+MSDY(I,K)+MSDZ(I,K)),K=1,NATOM)
                WRITE(196,98)DELT*REAL(I),((MSDGX(I,K)+MSDGY(I,K)+MSDGZ(I,K)),K=1,NTYP)
                WRITE(197,98)DELT*REAL(I),((MSDX(I,K),MSDY(I,K),MSDZ(I,K)),K=1,NATOM)
                WRITE(198,98)DELT*REAL(I),((MSDGX(I,K),MSDGY(I,K),MSDGZ(I,K)),K=1,NTYP)
98             FORMAT(F16.6,10000F16.5)
END DO



GO TO 1234
!!!!!!!!!!!!!!!!CENTER OF MASS
CMMSDX=0
CMMSDY=0
CMMSDZ=0


                DO DT=1,NSTEPORIG2-OINT
                NSTEP1=NSTEPI
                NSTEP2=NSTEPI+DT
                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP1=NSTEPORIG2-DT
                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP2=NSTEP1+DT
                TAO=NSTEPI
                IF(NSTEPI+DT.GT.NSTEPORIG2)TAO=NSTEPORIG2-DT

                TCMMSDX(DT)=SUM(MASS* ( SUM((POS(1:NSTEP1:OINT,:,1) ),DIM=1  ))) /(NATOM*SUM(MASS))   ! + &
                TCMMSDY(DT)=SUM(MASS* ( SUM((POS(1:NSTEP1:OINT,:,2) ),DIM=1  ))) /(NATOM*SUM(MASS))   ! + &
                TCMMSDZ(DT)=SUM(MASS* ( SUM((POS(1:NSTEP1:OINT,:,3) ),DIM=1 ))) /(NATOM*SUM(MASS))   ! + &
                END DO


DO I=1,NTYP
N1=SUM(NNTYPE(1:I-1)) +1
N2=SUM(NNTYPE(1:I)) 
PRINT*,N1,N2
PRINT*, 'ATOM TYPE',I,'has been done'
                DO DT=1,NSTEPORIG2-OINT
                NSTEP1=NSTEPI
                NSTEP2=NSTEPI+DT
                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP1=NSTEPORIG2-DT
                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP2=NSTEP1+DT
                TAO=NSTEPI
                IF(NSTEPI+DT.GT.NSTEPORIG2)TAO=NSTEPORIG2-DT


                CMMSDX(DT,I)=  SUM((POS(1:NSTEP1:OINT,N1:N2,1) -  POS(1+DT:NSTEP2:OINT,N1:N2,1))) /NNTYPE(I)  ! + &
                CMMSDY(DT,I)=  SUM((POS(1:NSTEP1:OINT,N1:N2,2) -  POS(1+DT:NSTEP2:OINT,N1:N2,2))) /NNTYPE(I)  ! + &
                CMMSDZ(DT,I)=  SUM((POS(1:NSTEP1:OINT,N1:N2,3) -  POS(1+DT:NSTEP2:OINT,N1:N2,3))) /NNTYPE(I)  ! + &
                
                
                !CMMSDX(DT,I)=(CMMSDX(DT,I)-TCMMSDX(DT))**2 /REAL(TAO/OINT) 
                !CMMSDY(DT,I)=(CMMSDY(DT,I)-TCMMSDY(DT))**2 /REAL(TAO/OINT) 
                !CMMSDZ(DT,I)=(CMMSDZ(DT,I)-TCMMSDZ(DT))**2 /REAL(TAO/OINT) 
                CMMSDX(DT,I)=(CMMSDX(DT,I))**2 /REAL(TAO/OINT) 
                CMMSDY(DT,I)=(CMMSDY(DT,I))**2 /REAL(TAO/OINT) 
                CMMSDZ(DT,I)=(CMMSDZ(DT,I))**2 /REAL(TAO/OINT) 
                END DO
!                       MSD(DT,I)=sum( (PPOS(1:nstep,:) - PPOS(1+dt:nstep+dt,:))**2 ) /dble(nt)
END DO
DO I=1,NSTEPORIG2-OINT
                WRITE(194,98)DELT*REAL(I),((CMMSDX(I,K)+CMMSDY(I,K)+CMMSDZ(I,K)),K=1,NTYP)
END DO






!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!CORRELATED TERM SUM
!PRINT*, 'ATOM NO',I,'has been done'

MMSDX=0
MMSDY=0
MMSDZ=0
DO I1=1,NTYP !NATOM
PRINT*, 'ATOM TYP',I1,'has been done'
N1=SUM(NNTYPE(1:I1-1))+1
N2=SUM(NNTYPE(1:I1))
                DO DT=1,NSTEPORIG2-OINT
                NSTEP1=NSTEPI
                NSTEP2=NSTEPI+DT
                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP1=NSTEPORIG2-DT
                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP2=NSTEP1+DT
                TAO=NSTEPI
                IF(NSTEPI+DT.GT.NSTEPORIG2)TAO=NSTEPORIG2-DT
                    DO I=N1,N2 !NATOM
                    !$omp parallel do shared(MMSDX,MMSDY,MMSDZ)
                    DO J=N1,N2 !ATOM
                    IF(I.NE.J)THEN
                      MMSDX(DT,I1)=MMSDX(DT,I1)+SUM((POS(1:NSTEP1:OINT,I,1)-POS(1+DT:NSTEP2:OINT,I,1))*(POS(1:NSTEP1:OINT,J,1)-POS(1+DT:NSTEP2:OINT,J,1))) ! + &
                      MMSDY(DT,I1)=MMSDY(DT,I1)+SUM((POS(1:NSTEP1:OINT,I,2)-POS(1+DT:NSTEP2:OINT,I,2))*(POS(1:NSTEP1:OINT,J,2)-POS(1+DT:NSTEP2:OINT,J,2))) ! + &
                      MMSDZ(DT,I1)=MMSDZ(DT,I1)+SUM((POS(1:NSTEP1:OINT,I,3)-POS(1+DT:NSTEP2:OINT,I,3))*(POS(1:NSTEP1:OINT,J,3)-POS(1+DT:NSTEP2:OINT,J,3))) ! + &
                    END IF
                    END DO
                    !$omp end parallel do
                    END DO
                MMSDX(DT,I1)=MMSDX(DT,I1)/REAL((TAO/OINT))
                MMSDY(DT,I1)=MMSDY(DT,I1)/REAL((TAO/OINT))
                MMSDZ(DT,I1)=MMSDZ(DT,I1)/REAL((TAO/OINT))
                END DO
END DO

DO I=1,NSTEPORIG2-OINT
                WRITE(193,98)DELT*REAL(I),((MMSDX(I,K)+MMSDY(I,K)+MMSDZ(I,K)),K=1,NTYP)
END DO
1234 CONTINUE

!ALLOCATE(MSDX(NSTEPORIG,NATOM))
!ALLOCATE(MSDY(NSTEPORIG,NATOM))
!ALLOCATE(MSDZ(NSTEPORIG,NATOM))
!ALLOCATE(MSDGX(NSTEPORIG,NTYP))
!ALLOCATE(MSDGY(NSTEPORIG,NTYP))
!ALLOCATE(MSDGZ(NSTEPORIG,NTYP))
!ALLOCATE(UU(NSTEPORIG,NATOM,3))
!ALLOCATE(MMSDX(NSTEPORIG,NTYP))
!ALLOCATE(MMSDY(NSTEPORIG,NTYP))
!ALLOCATE(MMSDZ(NSTEPORIG,NTYP))
!ALLOCATE(CMMSDX(NSTEPORIG,NTYP))
!ALLOCATE(CMMSDY(NSTEPORIG,NTYP))
!ALLOCATE(CMMSDZ(NSTEPORIG,NTYP))

DEALLOCATE(MSDX,MSDY,MSDZ,MSDGX,MSDGY,MSDGZ,UU,MMSDX,MMSDY,MMSDZ,CMMSDX,CMMSDY,CMMSDZ)
DEALLOCATE(TCMMSDX,TCMMSDY,TCMMSDZ)
END SUBROUTINE




SUBROUTINE POLYVOL  !RESIDENCE2N
use omp_lib
USE VARIABLES1
USE IFPORT
IMPLICIT NONE
INTEGER::I1,I2,J1,J2,K1,K2,ITH
INTEGER::II,JJ,KK
!REAL::T2,T1
DOUBLE PRECISION,DIMENSION(3)::AA
REAL::RIJ,RJK
REAL,DIMENSION(3)::VEC11,VEC22
INTEGER::NC1,NC2
INTEGER::NCORD1,NCORD2,NK
REAL,DIMENSION(12)::ANGLEI
INTEGER::RBIN,TBIN
INTEGER::ISPACE,L
REAL::TST
DOUBLE PRECISION::VOL
INTEGER::CCAGE,SCAGE
REAL::RCAGE
REAL::XMAX,YMAX,ZMAX,XMIN,YMIN,ZMIN
DOUBLE PRECISION,DIMENSION(3,3)::DAB
INTEGER::JK,ISEL
INTEGER::NCENTRE,STA
DOUBLE PRECISION,allocatable,DIMENSION(:,:,:)::AB
DOUBLE PRECISION,DIMENSION(3)::XX
REAL::RANG,DET
INTEGER::INC,PTYP
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::VOLT,VOLTP
INTEGER,ALLOCATABLE,DIMENSION(:)::PPTYPE
INTEGER,ALLOCATABLE,DIMENSION(:,:)::PICK,IPICK,IIPICK,OCCC
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::CENTRE,RPICK,RRPICK,DMATRIX
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
 DOUBLE PRECISION,DIMENSION(3)::DDD
 INTEGER::MATOM,ICAP,JCu,MAXCAP,JTAG,JJJJ
 DOUBLE PRECISION::RSEARCH
 INTEGER,DIMENSION(768)::INDEXI
 INTEGER::IP
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
OPEN(31,FILE="POLYCENTRE")
OPEN(913,FILE="POLYVOLUME")
OPEN(914,FILE="POLYVOLUMETYPE")
PTYP=1 !4
SCAGE=3
PICK=0
IPICK=0
ALLOCATE(PPTYPE(PTYP))
IP=0
DO
IP=IP+1
READ(31,*,END=99)
END DO
99 CONTINUE
REWIND(31)
PPTYPE(1)=IP-9 !#768
!PPTYPE(2)=32
!PPTYPE(3)=128
!PPTYPE(4)=384
NCENTRE=SUM(PPTYPE)
PRINT*,'No of POLYCENTRE=',NCENTRE
ALLOCATE(VOLT(NCENTRE))
RCAGE=2.8
PRINT*,'RCAGE=',RCAGE
ALLOCATE(PICK(NCENTRE,12),RPICK(NCENTRE,12),RRPICK(NCENTRE,12),IIPICK(NCENTRE,12),IPICK(NCENTRE,12),CENTRE(NCENTRE,3))
ALLOCATE(AB(NCENTRE,3,3))
ALLOCATE(VOLTP(PTYP))

DO I=1,8
READ(31,*)
END DO
!RCAGE=2.7
DO I=1,NCENTRE
READ(31,*)CENTRE(I,:)
END DO
!PRINT*,CENTRE(1024,:)
PRINT*, "I M IN POLYVOLUME"
PI=4*ATAN(1.0)
!ISPACE=NNTYPE(INDEX1(1,1))
ISEL=0
!!!!!!!!!!!!!!!!53yy!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!#####################################################################################################
PRINT*, SUM (NNTYPE(1:SCAGE -1 )) +1, SUM(NNTYPE(1:SCAGE))
RPICK=0
DO I=1,NCENTRE
        NK=0
        DO J=SUM (NNTYPE(1:SCAGE -1 )) +1, SUM(NNTYPE(1:SCAGE))
                AA=CENTRE(I,:)-MATMUL(POS(1 ,J,:),ISLAT)         !!!!!!!!!!CENTRE IS IN FRACTIONAL CORDINATE WHILE POS IS IN CARTESI
                AA=AA-NINT(AA)

                !WHERE(AA.LT.-0.5)AA=AA+1
                !WHERE(AA.GT.0.5)AA=AA-1
                !RIJ=NORM2(MATMUL(SLATORIG,AA))
                RIJ=NORM2(MATMUL(AA,SLATORIG))
                IF(RIJ.LE.RCAGE.AND.RIJ.GT.0.0)THEN
                NK=NK+1
                PICK(I,NK)=J
                RPICK(I,NK)=RIJ
!                PRINT*,MATMUL(POS(1,J,:),ISLAT) ! J,RIJ,NK
                END IF
        END DO


        DO IK=1,4
        id=minloc(RPICK(I,:),MASK=RPICK(I,:).GT.0,DIM=1)
        RRPICK(I,IK)=RPICK(I,id)
        IPICK(I,IK)=PICK(I,ID)
        RPICK(I,id)=0
      !  print*,id, ipick(i,ik)
        END DO
        
       ! PAUSE
        STA=0 !!!STATUS

        DO IK=1,I-1
        IF(ANY(IpiCK(I,:).GT.0) .AND. ANY(IPICK(IK,1:4)==IPICK(I,1)) .AND. ANY(IPICK(IK,1:4)==IPICK(I,2)) .AND.  ANY(IPICK(IK,1:4)==IPICK(I,3)) .AND. ANY(IPICK(IK,1:4)==IPICK(I,4)) )STA=1
        END DO

        IF(STA==0)THEN
        ISEL=ISEL+1
        PRINT*,ISEL

!!!!!!!!!!!!!!!!!!!!CHECK SENCE OF ROTATION!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                 AB(1,1,:)=MATMUL(POS(1,IPICK(I,2),:)-POS(1,IPICK(I,1),:),ISLATORIG )
                 AB(1,2,:)=MATMUL(POS(1,IPICK(I,3),:)-POS(1,IPICK(I,1),:),ISLATORIG )
                 AB(1,3,:)=MATMUL(POS(1,IPICK(I,4),:)-POS(1,IPICK(I,1),:),ISLATORIG )
                 WHERE(AB(1,1,:).GT.RANG)AB(1,1,:)=AB(1,1,:)-1
                 WHERE(AB(1,2,:).GT.RANG)AB(1,2,:)=AB(1,2,:)-1
                 WHERE(AB(1,3,:).GT.RANG)AB(1,3,:)=AB(1,3,:)-1
                 WHERE(AB(1,1,:).LT.-RANG)AB(1,1,:)=AB(1,1,:)+1
                 WHERE(AB(1,2,:).LT.-RANG)AB(1,2,:)=AB(1,2,:)+1
                 WHERE(AB(1,3,:).LT.-RANG)AB(1,3,:)=AB(1,3,:)+1
                 AB(1,1,:)=MATMUL(AB(1,1,:),SLATORIG)
                 AB(1,2,:)=MATMUL(AB(1,2,:),SLATORIG)
                 AB(1,3,:)=MATMUL(AB(1,3,:),SLATORIG)
                 CALL DETER(AB(1,:,:), VOL)
           IF(VOL.GE.0)THEN
                IIPICK(ISEL,1:4)=IPICK(I,1:4)
           ELSE
                IIPICK(ISEL,1)=IPICK(I,1)
                IIPICK(ISEL,2)=IPICK(I,2)
                IIPICK(ISEL,3)=IPICK(I,4)
                IIPICK(ISEL,4)=IPICK(I,3)
           END IF
        END IF
        8 FORMAT(I6,3x,4(F3.1,1x),3x,4I6,4x,I4)
!PRINT 938,IIPICK(I,1:4)
938 FORMAT(4I8)
END DO
PRINT*,'NO. POLYHEDRAL FOUND=',ISEL


DO IT=1,IREF2-IREF1
        DO INC=1,NCENTRE
        call  CVOLUME(IIPICK(INC,1),IIPICK(INC,2),IIPICK(INC,3),IIPICK(INC,4),volt(iNC))
        END DO
        N1=0
        N2=0
        DO I=1,PTYP
        N1=SUM(PPTYPE(1:I-1))+1
        N2=SUM(PPTYPE(1:I))
        VOLTP(I)=SUM(VOLT(n1:n2))/PPTYPE(I)
        WRITE(913,913)IT*DELT,VOLT  !SUM(VOLT(N1:N2))
        913 format(1000F10.3)
        ENDDO
        WRITE(914,913)IT*DELT,VOLTP
END DO

!PAUSE

!!EXTRA CODE FOR CHECKIN THE NEAREST MOBILE Cu!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  IT=1
  JJJJ=0
  JTAG=0
  MATOM=1   !Cu index
  CATOM=3   !polyhedral center type 
  MAXCAP=32

  DO J=1,SUM(PPTYPE)     !SUM(PPTYPE(1:CATOM-1))+1,SUM(PPTYPE(1:CATOM))   !,NNTYPE(CATOM)
   JTAG=JTAG+1
   JJJJ=JJJJ+1
                    ICAP=0
                    DO JCu=SUM(NNTYPE(1:MATOM-1))+1,SUM(NNTYPE(1:MATOM))    !MATOM MOBILE ATOM NEAR Polyhedral centre
                    DDD=CENTRE(J,:)-MATMUL(POS(IT,JCu,:),ISLAT)
!                    DDD=MATMUL(ISLATORIG,DDD)                           !!!!!!!!FRACTIONAL POSITION 
                     IF(DDD(1).LT. -0.5)DDD(1)=DDD(1)+1
                     IF(DDD(2).LT. -0.5)DDD(2)=DDD(2)+1
                     IF(DDD(3).LT. -0.5)DDD(3)=DDD(3)+1
                     IF(DDD(1).gT.  0.5)DDD(1)=DDD(1)-1
                     IF(DDD(2).gT.  0.5)DDD(2)=DDD(2)-1
                     IF(DDD(3).gT.  0.5)DDD(3)=DDD(3)-1
                    DDD=MATMUL(DDD,SLATORIG)                           !!!!!!!!FRACTIONAL POSITION 
                    IF(NORM2(DDD).LT.RSEARCH)THEN
                    ICAP=ICAP+1
                    INDEXI(ICAP)=JCu
!                    PRINT*,JCu,ICAP
                    END IF
                    END DO
                    !PAUSE
                    WRITE(2105,2105)INDEXI(1:MAXCAP)
                    2105 FORMAT(100I10)
   END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!






!!!!!!!!!!!!!!!EXTRA TINGS TO FIND THE NEAREST Cu Index!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!ALLOCATE(PICK(NCENTRE,12),RPICK(NCENTRE,12),RRPICK(NCENTRE,12),IIPICK(NCENTRE,12),IPICK(NCENTRE,12),CENTRE(NCENTRE,3))
!ALLOCATE(AB(NCENTRE,3,3))
!ALLOCATE(VOLTP(PTYP))
DEALLOCATE(PICK,RPICK,RRPICK,IIPICK,IPICK,CENTRE,AB,VOLTP)
END SUBROUTINE


SUBROUTINE JUMPRADIAL
use omp_lib
USE VARIABLES1
USE IFPORT
IMPLICIT NONE
INTEGER::IDFF,NSITE
INTEGER::SCAGE
INTEGER::NK
INTEGER::JTAG,TSKIP,ICK,INS,RMESH,IMESH
DOUBLE PRECISION::RIJ
DOUBLE PRECISION::RCUTOFF
INTEGER::NCENTRE,ISEL,STA
DOUBLE PRECISION::RANG
DOUBLE PRECISION::TOL1,TOL2
INTEGER::IR
DOUBLE PRECISION::SHELLVOL,DR
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::SITE
integer,ALLOCATABLE,dimension(:)::ATMST,PATMST
double precision,allocatable,dimension(:)::ATMDST
DOUBLE PRECISION,allocatable,DIMENSION(:,:)::RMAT
DOUBLE PRECISION,allocatable,DIMENSION(:)::NRMAT
INTEGER,DIMENSION(2)::NSTYP
DOUBLE PRECISION,allocatable,DIMENSION(:,:)::RCAGE
INTEGER,ALLOCATABLE,DIMENSION(:)::CAGEID,PCAGEID
INTEGER,allocatable,DIMENSION(:)::SUCCESS
INTEGER,allocatable,DIMENSION(:,:)::ATTEMPT,STATA,PSTATA,TOCC
DOUBLE PRECISION,allocatable,DIMENSION(:)::RMONI,PRMONI
DOUBLE PRECISION,allocatable,DIMENSION(:,:)::REFFF,RFRAC
DOUBLE PRECISION,allocatable,DIMENSION(:,:)::REFCAGE
DOUBLE PRECISION,allocatable,DIMENSION(:,:)::RCG,TETRA
integer,allocatable,dimension(:)::timer
REAL,dimension(100)::PRMESH
DOUBLE PRECISION,DIMENSION(3)::AA
INTEGER,ALLOCATABLE,DIMENSION(:,:)::PICK,IPICK,IIPICK,OCCC
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::CENTRE,RPICK,RRPICK,DMATRIX
DOUBLE PRECISION,allocatable,DIMENSION(:,:,:)::AB
DOUBLE PRECISION::VOL,RPOLY
DOUBLE PRECISION,DIMENSION(3)::LOCAL
DOUBLE PRECISION,DIMENSION(3)::XX
REAL::ABCD
INTEGER::NMESH
OPEN(89,FILE="TETRA")
OPEN(90,FILE="CAGEID")
OPEN(909,FILE='CHECK_TCOARSE_R_vsJUMP',ACCESS='APPEND')
OPEN(999,FILE="ATTEMPT_SUCCESS")
OPEN(916,FILE="R_vs_FREEENERGY")


TOL1=0.d0
TOL2=1.d0
RANG=0.5d0
STATA=0
PSTATA=0
SUCCESS=0
ATTEMPT=0
IDFF=1
NMESH=100
!PRINT*,NNTYPE
NTETRA=0
DO 
NTETRA=NTETRA+1
READ(89,*,END=99) !ABCD
END DO
99 CONTINUE
NCENTRE=0
DO 
NCENTRE=NCENTRE+1
READ(90,*,END=100)
END DO
100 CONTINUE
REWIND(89)
REWIND(90)
NTETRA=NTETRA-9
NCENTRE=NCENTRE-9
PRINT*,'No. of TetraHedral Site is ',NTETRA
PRINT*,'No. of Actual Sites/CAGE centres are ',NCENTRE 
ALLOCATE(ATMST(NNTYPE(IDFF)))
ALLOCATE(PATMST(NNTYPE(IDFF)))
ALLOCATE(ATMDST(NNTYPE(IDFF)))
ALLOCATE(RMAT(NCENTRE,3))
ALLOCATE(NRMAT(NCENTRE))
ALLOCATE(RCAGE(NCENTRE,3))
ALLOCATE(SUCCESS(NNTYPE(IDFF)))
ALLOCATE(ATTEMPT(100,NNTYPE(IDFF)))
ALLOCATE(STATA(100,NNTYPE(IDFF)))
ALLOCATE(PSTATA(100,NNTYPE(IDFF)))
ALLOCATE(TOCC(100,NNTYPE(IDFF)))
ALLOCATE(RMONI(NNTYPE(IDFF)))
ALLOCATE(PRMONI(NNTYPE(IDFF)))
ALLOCATE(REFFF(NNTYPE(IDFF),3))
ALLOCATE(RCG(NNTYPE(IDFF),3))
ALLOCATE(REFCAGE(NNTYPE(IDFF),3))
ALLOCATE(TIMER(NNTYPE(IDFF)))
ALLOCATE(PICK(NTETRA,12),RPICK(NTETRA,12),RRPICK(NTETRA,12),IIPICK(NTETRA,12),IPICK(NTETRA,12),CENTRE(NTETRA,3))
ALLOCATE(AB(NTETRA,3,3))
ALLOCATE(CAGEID(NTETRA))
ALLOCATE(PCAGEID(NTETRA))
ALLOCATE(TETRA(NTETRA,3))
ALLOCATE(RFRAC(NNTYPE(IDFF),3))
TSKIP=1
DR=0.1
RCUTOFF=1.8
SITE=0
SCAGE=3
RPOLY=3.5
ISEL=0
ICK=1

DO I=1,8
READ(89,*)
READ(90,*)
END DO
!PRINT*,'TCG and RCUTOFF for jump and atmindex for print'
!PRINT*,'TSKIP,DR'
DO I=1,NCENTRE 
READ(90,*)RCAGE(I,:)
END DO
!!!!!!!!!!!!!!!!!!!!!!!!!ADD A SECTION FOR POLYHEDRAL DETECTION AROUND POLYHEDRAL CENTRE !!!!!!CHOSE LAST 128 cordinate from TETRA07JAN as a tetrahedral center for serach the surrounding Se
DO I=1,NTETRA 
CAGEID(I)=I
READ(89,*)TETRA(I,:)
END DO

DO I=1,NTETRA !CENTRE    !!!!!!!!!!!!!!!!!!!
        NK=0
             DO J=SUM(NNTYPE(1:SCAGE -1 )) +1, SUM(NNTYPE(1:SCAGE))
                !AA=TETRA(I,:)-MATMUL(ISLATORIG,POS(1 ,J,:))         !!!!!!!!!!CENTRE IS IN FRACTIONAL CORDINATE WHILE POS IS IN CARTESI
                AA=TETRA(I,:)-MATMUL(POS(1 ,J,:),ISLATORIG)         !!!!!!!!!!CENTRE IS IN FRACTIONAL CORDINATE WHILE POS IS IN CARTESI
                WHERE(AA.LT.-0.5)AA=AA+1
                WHERE(AA.GT.0.5)AA=AA-1
                !RIJ=NORM2(MATMUL(SLATORIG,AA))
                RIJ=NORM2(MATMUL(AA,SLATORIG))
                IF(RIJ.LE.RPOLY.AND.RIJ.GT.0.0)THEN
                NK=NK+1
                PICK(I,NK)=J
                RPICK(I,NK)=RIJ
                END IF
              END DO
            !  PRINT*,I
        DO IK=1,4 !!!!!!!!!!WE WANT TETRAHEDRAL SELECTION SO CHOOSE 4
        id=minloc(RPICK(I,:),MASK=RPICK(I,:).GT.0,DIM=1)
        RRPICK(I,IK)=RPICK(I,id)
        IPICK(I,IK)=PICK(I,ID)
        RPICK(I,id)=0
        END DO
        STA=0 !!!STATUS
        DO IK=1,I-1
        IF(ANY(IpiCK(I,:).GT.0) .AND. ANY(IPICK(IK,1:4)==IPICK(I,1)) .AND. ANY(IPICK(IK,1:4)==IPICK(I,2)) .AND.  ANY(IPICK(IK,1:4)==IPICK(I,3)) .AND. ANY(IPICK(IK,1:4)==IPICK(I,4)) )STA=1
        END DO
        IF(STA==0)THEN
        ISEL=ISEL+1
                 !!!!!!CHECK SENCE OF ROTATION!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                 AB(1,1,:)=MATMUL(POS(1,IPICK(I,2),:)-POS(1,IPICK(I,1),:),ISLATORIG )
                 AB(1,2,:)=MATMUL(POS(1,IPICK(I,3),:)-POS(1,IPICK(I,1),:),ISLATORIG )
                 AB(1,3,:)=MATMUL(POS(1,IPICK(I,4),:)-POS(1,IPICK(I,1),:),ISLATORIG )
                 WHERE(AB(1,1,:).GT.RANG)AB(1,1,:)=AB(1,1,:)-1
                 WHERE(AB(1,2,:).GT.RANG)AB(1,2,:)=AB(1,2,:)-1
                 WHERE(AB(1,3,:).GT.RANG)AB(1,3,:)=AB(1,3,:)-1
                 WHERE(AB(1,1,:).LT.-RANG)AB(1,1,:)=AB(1,1,:)+1
                 WHERE(AB(1,2,:).LT.-RANG)AB(1,2,:)=AB(1,2,:)+1
                 WHERE(AB(1,3,:).LT.-RANG)AB(1,3,:)=AB(1,3,:)+1
                 AB(1,1,:)=MATMUL(AB(1,1,:),SLATORIG)
                 AB(1,2,:)=MATMUL(AB(1,2,:),SLATORIG)
                 AB(1,3,:)=MATMUL(AB(1,3,:),SLATORIG)
                 CALL DETER(AB(1,:,:), VOL)
                 IF(VOL.GE.0)THEN
                 IIPICK(ISEL,1:4)=IPICK(I,1:4)
                 ELSE
                 IIPICK(ISEL,1)=IPICK(I,1)
                 IIPICK(ISEL,2)=IPICK(I,2)
                 IIPICK(ISEL,3)=IPICK(I,4)
                 IIPICK(ISEL,4)=IPICK(I,3)
                 END IF
        END IF
        8 FORMAT(I6,3x,4(F3.1,1x),3x,4I6,4x,I4)
938 FORMAT(4I8)
END DO
RCAGE=MATMUL(RCAGE,SLAT)        !CARTESIAN
STATA=0
NSITE=NCENTRE
TETRA=MATMUL(TETRA,SLAT)
PRINT*,'RPOLY=',RPOLY
PRINT*,SCAGE,NNTYPE(SCAGE)
PRINT*,NNTYPE

DO IT=1,IREF2-IREF1+1-TSKIP  !,TSKIP  !,TSKIP !10
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!GETTING POLY CORIDNATES AND!!!!!!!!!!!!CALCULATE ISEL FRAMES
JTAG=0
NRMAT=0
ATMDST=0
RMONI=0
RMESH=1        !JST TO AVOID SEGMENTAION FAULT
                DO I=SUM(NNTYPE(1:IDFF-1))+1,SUM(NNTYPE(1:IDFF))
                JTAG=JTAG+1
                PSTATA(RMESH,JTAG)=STATA(RMESH,JTAG)
                PATMST(JTAG)=ATMST(JTAG)   !SET ATOM LOCATION AT PREVISOUS TIME !SITE
                RCG(JTAG,:)=SUM(POS(IT:IT+TSKIP-1,I,:),DIM=1)/(MAX(TSKIP,1))          !COARSE GRAIN
                IF(IT==1)RCG(JTAG,:)=POS(1,I,:)
                RMAT(1:NCENTRE,:)=MATMUL(spread(RCG(JTAG,:),1,NCENTRE)-RCAGE(1:NCENTRE,:),ISLAT)                     !SITE TO ATOM DISTANCE
                !WHERE(RMAT.Le.-0.5)RMAT=RMAT-NINT(RMAT)
                !WHERE(RMAT.Ge.0.5)RMAT=RMAT-NINT(RMAT)
                !RMAT=RMAT-NINT(RMAT)
                RMAT=RMAT-NINT(RMAT)
                RMAT=MATMUL(RMAT,SLAT)
                NRMAT(1:NCENTRE)=NORM2(RMAT(1:NCENTRE,:),DIM=2)
                915 FORMAT(3F6.3,3x,F10.5,I5)
                ATMST(JTAG)=MINLOC(NRMAT(1:NCENTRE),DIM=1)                                               !FINDING NEAREST SITE
                ATMDST(JTAG)=MINVAL(NRMAT(1:NCENTRE),DIM=1)                                              !AND DISTANCE FROM SITE
                !PRINT 12356,ATMST(JTAG),ATMDST(JTAG),MATMUL(RCG(JTAG,:),ISLAT),MATMUL(RCAGE(ATMST(JTAG),:),ISLAT)
                12356 FORMAT(I7,F10.5,3F10.5,2x,3F10.5)

                8765 format(2I8,3f7.3,1x,3f7.3)
                IF(IT== 1)THEN
                 PATMST(JTAG)=ATMST(JTAG)
                 REFCAGE(JTAG,:)=RCAGE(CAGEID(ATMST(JTAG)),:)                                          !SET ATOM CAGE CENTER
                 PCAGEID(ATMST(JTAG))=CAGEID(ATMST(JTAG))                                              !SET ATOME CAGEID AT PREVISOU TIME
                ELSE
                 IF(CAGEID(PATMST(JTAG)).NE.0)PCAGEID(ATMST(JTAG))=CAGEID(PATMST(JTAG))                                              !SET ATOME CAGEID AT PREVISOU TIME
                 !PRINT*,JTAG,PATMST(JTAG),ATMST(JTAG)

                 RFRAC(JTAG,:)=MATMUL(RCG(JTAG,:)-REFCAGE(JTAG,:),ISLAT)
                ! PRINT*,RCG(JTAG,:) !RFRAC(JTAG,:)
                 WHERE(NINT(RFRAC(JTAG,:)).LE.-1)RFRAC(JTAG,:)=RFRAC(JTAG,:)-NINT(RFRAC(JTAG,:))
                 WHERE(NINT(RFRAC(JTAG,:)).GE.1.0)RFRAC(JTAG,:)=RFRAC(JTAG,:)-NINT(RFRAC(JTAG,:))
                 RMONI(JTAG)=NORM2(MATMUL(RFRAC(JTAG,:),SLAT))
                         RMESH=INT(RMONI(JTAG)/DR)
                  !      PRINT*,RMESH
                         IF(RMESH==0)RMESH=1
                         PRMESH(RMESH)=PRMESH(RMESH)+1
                 STATA(RMESH,JTAG)=RMESH
                 IF(RMONI(JTAG)>PRMONI(JTAG))ATTEMPT(RMESH,JTAG)=ATTEMPT(RMESH,JTAG)+1
                 TOCC(RMESH,JTAG)=TOCC(RMESH,JTAG)+1
                 PSTATA(RMESH,JTAG)=STATA(RMESH,JTAG)
                 PRMONI(JTAG)=RMONI(JTAG) !NORM2(MATMUL(RFRAC(JTAG,:),SLAT))
                 IF(RMONI(JTAG) .GT. RCUTOFF.AND.CAGEID(ATMST(JTAG)).NE.0 ) THEN
                 SUCCESS(JTAG)=SUCCESS(JTAG)+1
                 REFCAGE(JTAG,:)=RCAGE(CAGEID(ATMST(JTAG)),:)
                 END IF
                END IF
        END DO

9118 FORMAT(5I6,100F10.4)
                PRINT 9118,IT,ATMST(ICK),PATMST(ICK),SUCCESS(ICK),CAGEID(ATMST(ICK)),RMONI(ICK) 
                !CAGEID(PATMST(ICK)),PCAGEID(ATMST(ICK)) ,RMONI(ICK)! RCAGE(PCAGEID(ATMST(ICK)),:), RFRAC(ICK,:)!,REAL(TIMER(1)) !, REAL(RCG(1,:)),REAL(REFCAGE(1,:))

END DO



        DO IR=1,NMESH 
        SHELLVOL=1 !#DR      !4.0*3.14*(IR*IR*0.01*0.01)*0.01
        WRITE(987,987)IR*DR,REAL(SUM(ATTEMPT(IR,:)))/REAL(DELT*NNTYPE(IDFF)*(IREF2-IREF1+1-TSKIP)*SHELLVOL)  ,REAL(SUM(TOCC(IR,:)))/REAL(DELT*NNTYPE(IDFF)*(IREF2-IREF1+1-TSKIP)*SHELLVOL)
        END DO

        DO JTAG=1,NNTYPE(IDFF)
        WRITE(910,910)JTAG,SUM(ATTEMPT(35:100,JTAG)),SUCCESS(JTAG),REAL(SUCCESS(JTAG))   !/REAL(SUM(ATTEMPT(1:100,JTAG)))
        END DO
        WRITE(909,909)TSKIP,RCUTOFF,SUM(ATTEMPT(1:100,:)),SUM(SUCCESS),REAL(SUM(SUCCESS))/REAL(SUM(ATTEMPT(1:100,:)))
        WHERE(PRMESH==0)PRMESH=1
        DO IMESH=1,100
        WRITE(916,916)IMESH*DR,PRMESH(IMESH)/SUM(PRMESH),-0.08617328149741*TEMPER*ALOG(PRMESH(IMESH)/SUM( PRMESH))
        END DO
916 FORMAT(F10.5,3E15.5)
912 FORMAT(I8,1000(I7,1000I7))
918 FORMAT(5I6,100F10.4)
909 FORMAT(I8,F10.2,2I9,F10.4)
910 FORMAT(I8,2I9,F10.4)
987 FORMAT(F10.4,102F12.5)
END SUBROUTINE

SUBROUTINE JUMPRADIAL_POLY
use omp_lib
USE VARIABLES1
USE IFPORT
IMPLICIT NONE
INTEGER::IDFF,NSITE
INTEGER::SCAGE
INTEGER::NK
INTEGER::JTAG,TSKIP,ICK,INS,RMESH,IMESH
DOUBLE PRECISION::RIJ
DOUBLE PRECISION::RCUTOFF
INTEGER::NCENTRE,ISEL,STA
DOUBLE PRECISION::RANG
DOUBLE PRECISION::TOL1,TOL2
INTEGER::IR
DOUBLE PRECISION::SHELLVOL,DR
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::SITE
integer,ALLOCATABLE,dimension(:)::ATMST,PATMST
double precision,allocatable,dimension(:)::ATMDST
DOUBLE PRECISION,allocatable,DIMENSION(:,:)::RMAT
DOUBLE PRECISION,allocatable,DIMENSION(:)::NRMAT
INTEGER,DIMENSION(2)::NSTYP
DOUBLE PRECISION,allocatable,DIMENSION(:,:)::RCAGE
INTEGER,ALLOCATABLE,DIMENSION(:)::CAGEID,PCAGEID
INTEGER,allocatable,DIMENSION(:)::SUCCESS
INTEGER,allocatable,DIMENSION(:,:)::ATTEMPT,STATA,PSTATA,TOCC
DOUBLE PRECISION,allocatable,DIMENSION(:)::RMONI,PRMONI
DOUBLE PRECISION,allocatable,DIMENSION(:,:)::REFFF,RFRAC
DOUBLE PRECISION,allocatable,DIMENSION(:,:)::REFCAGE
DOUBLE PRECISION,allocatable,DIMENSION(:,:)::RCG,TETRA
integer,allocatable,dimension(:)::timer
REAL,dimension(1000)::PRMESH
DOUBLE PRECISION,DIMENSION(3)::AA
INTEGER,ALLOCATABLE,DIMENSION(:,:)::PICK,IPICK,IIPICK,OCCC
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::CENTRE,RPICK,RRPICK,DMATRIX
DOUBLE PRECISION,allocatable,DIMENSION(:,:,:)::AB
DOUBLE PRECISION::VOL,RPOLY
DOUBLE PRECISION,DIMENSION(3)::LOCAL
DOUBLE PRECISION,DIMENSION(3)::XX
REAL::ABCD
INTEGER::NMESH


INTEGER,ALLOCATABLE,DIMENSION(:)::AATTEMPT,SSTATA,PPSTATA
OPEN(89,FILE="TETRA")
OPEN(90,FILE="CAGEID")
OPEN(909,FILE='CHECK_TCOARSE_R_vsJUMP',ACCESS='APPEND')
OPEN(999,FILE="ATTEMPT_SUCCESS")
OPEN(916,FILE="R_vs_FREEENERGY")


TOL1=0.d0
TOL2=1.d0
RANG=0.5d0
STATA=0
PSTATA=0
SSTATA=0
PPSTATA=0
SUCCESS=0
ATTEMPT=0
IDFF=1
NMESH=1000
NTETRA=0
DO 
NTETRA=NTETRA+1
READ(89,*,END=99) !ABCD
END DO
99 CONTINUE
NCENTRE=0
DO 
NCENTRE=NCENTRE+1
READ(90,*,END=100)
END DO
100 CONTINUE
REWIND(89)
REWIND(90)
NTETRA=NTETRA-9
NCENTRE=NCENTRE-9
PRINT*,'No. of TetraHedral Site is ',NTETRA
PRINT*,'No. of Actual Sites/CAGE centres are ',NCENTRE 
ALLOCATE(ATMST(NNTYPE(IDFF)))
ALLOCATE(PATMST(NNTYPE(IDFF)))
ALLOCATE(ATMDST(NNTYPE(IDFF)))
ALLOCATE(RMAT(NCENTRE,3))
ALLOCATE(NRMAT(NCENTRE))
ALLOCATE(RCAGE(NCENTRE,3))
ALLOCATE(SUCCESS(NNTYPE(IDFF)))
ALLOCATE(ATTEMPT(1000,NNTYPE(IDFF)))
ALLOCATE(STATA(1000,NNTYPE(IDFF)))
ALLOCATE(PSTATA(1000,NNTYPE(IDFF)))
ALLOCATE(TOCC(1000,NNTYPE(IDFF)))
ALLOCATE(RMONI(NNTYPE(IDFF)))
ALLOCATE(PRMONI(NNTYPE(IDFF)))
ALLOCATE(REFFF(NNTYPE(IDFF),3))
ALLOCATE(RCG(NNTYPE(IDFF),3))
ALLOCATE(REFCAGE(NNTYPE(IDFF),3))
ALLOCATE(TIMER(NNTYPE(IDFF)))
ALLOCATE(PICK(NTETRA,12),RPICK(NTETRA,12),RRPICK(NTETRA,12),IIPICK(NTETRA,12),IPICK(NTETRA,12),CENTRE(NTETRA,3))
ALLOCATE(AB(NTETRA,3,3))
ALLOCATE(CAGEID(NTETRA))
ALLOCATE(PCAGEID(NTETRA))
ALLOCATE(TETRA(NTETRA,3))
ALLOCATE(RFRAC(NNTYPE(IDFF),3))
ALLOCATE(AATTEMPT(NNTYPE(IDFF)))
ALLOCATE(SSTATA(NNTYPE(IDFF)))
ALLOCATE(PPSTATA(NNTYPE(IDFF)))
PRINT*,'DR,RCUTOFF'
READ*,DR,RCUTOFF

TSKIP=1
!DR=0.02
!RCUTOFF=2.0
SITE=0
SCAGE=3
RPOLY=2.9
ISEL=0
ICK=1

DO I=1,8
READ(89,*)
READ(90,*)
END DO
!PRINT*,'TCG and RCUTOFF for jump and atmindex for print'
!PRINT*,'TSKIP,DR'
DO I=1,NCENTRE 
READ(90,*)RCAGE(I,:)
END DO
!!!!!!!!!!!!!!!!!!!!!!!!!ADD A SECTION FOR POLYHEDRAL DETECTION AROUND POLYHEDRAL CENTRE !!!!!!CHOSE LAST 128 cordinate from TETRA07JAN as a tetrahedral center for serach the surrounding Se
DO I=1,NTETRA 
CAGEID(I)=I
READ(89,*)TETRA(I,:)
END DO

DO I=1,NTETRA !CENTRE    !!!!!!!!!!!!!!!!!!!
        NK=0
             DO J=SUM(NNTYPE(1:SCAGE -1 )) +1, SUM(NNTYPE(1:SCAGE))
                !AA=TETRA(I,:)-MATMUL(ISLAT,POS(1 ,J,:))         !!!!!!!!!!CENTRE IS IN FRACTIONAL CORDINATE WHILE POS IS IN CARTESI
                AA=TETRA(I,:)-MATMUL(POS(1 ,J,:),ISLAT)         !!!!!!!!!!CENTRE IS IN FRACTIONAL CORDINATE WHILE POS IS IN CARTESI
                WHERE(AA.LT.-0.5)AA=AA+1
                WHERE(AA.GT.0.5)AA=AA-1
                !RIJ=NORM2(MATMUL(SLATORIG,AA))
                RIJ=NORM2(MATMUL(AA,SLATORIG))
                IF(RIJ.LE.RPOLY.AND.RIJ.GT.0.0)THEN
                NK=NK+1
                PICK(I,NK)=J
                RPICK(I,NK)=RIJ
                END IF
              END DO
            !  PRINT*,I
        DO IK=1,4 !!!!!!!!!!WE WANT TETRAHEDRAL SELECTION SO CHOOSE 4
        id=minloc(RPICK(I,:),MASK=RPICK(I,:).GT.0,DIM=1)
        RRPICK(I,IK)=RPICK(I,id)
        IPICK(I,IK)=PICK(I,ID)
        RPICK(I,id)=0
        END DO
        STA=0 !!!STATUS
        DO IK=1,I-1
        IF(ANY(IpiCK(I,:).GT.0) .AND. ANY(IPICK(IK,1:4)==IPICK(I,1)) .AND. ANY(IPICK(IK,1:4)==IPICK(I,2)) .AND.  ANY(IPICK(IK,1:4)==IPICK(I,3)) .AND. ANY(IPICK(IK,1:4)==IPICK(I,4)) )STA=1
        END DO
        IF(STA==0)THEN
        ISEL=ISEL+1
                 !!!!!!CHECK SENCE OF ROTATION!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                 AB(1,1,:)=MATMUL(POS(1,IPICK(I,2),:)-POS(1,IPICK(I,1),:),ISLATORIG )
                 AB(1,2,:)=MATMUL(POS(1,IPICK(I,3),:)-POS(1,IPICK(I,1),:),ISLATORIG )
                 AB(1,3,:)=MATMUL(POS(1,IPICK(I,4),:)-POS(1,IPICK(I,1),:),ISLATORIG )
                 WHERE(AB(1,1,:).GT.RANG)AB(1,1,:)=AB(1,1,:)-1
                 WHERE(AB(1,2,:).GT.RANG)AB(1,2,:)=AB(1,2,:)-1
                 WHERE(AB(1,3,:).GT.RANG)AB(1,3,:)=AB(1,3,:)-1
                 WHERE(AB(1,1,:).LT.-RANG)AB(1,1,:)=AB(1,1,:)+1
                 WHERE(AB(1,2,:).LT.-RANG)AB(1,2,:)=AB(1,2,:)+1
                 WHERE(AB(1,3,:).LT.-RANG)AB(1,3,:)=AB(1,3,:)+1
                 AB(1,1,:)=MATMUL(AB(1,1,:),SLATORIG)
                 AB(1,2,:)=MATMUL(AB(1,2,:),SLATORIG)
                 AB(1,3,:)=MATMUL(AB(1,3,:),SLATORIG)
                 CALL DETER(AB(1,:,:), VOL)
                 IF(VOL.GE.0)THEN
                 IIPICK(ISEL,1:4)=IPICK(I,1:4)
                 ELSE
                 IIPICK(ISEL,1)=IPICK(I,1)
                 IIPICK(ISEL,2)=IPICK(I,2)
                 IIPICK(ISEL,3)=IPICK(I,4)
                 IIPICK(ISEL,4)=IPICK(I,3)
                 END IF
        END IF
        8 FORMAT(I6,3x,4(F3.1,1x),3x,4I6,4x,I4)
938 FORMAT(4I8)
!PRINT*,IIPICK(ISEL,1:4)

END DO
RCAGE=MATMUL(RCAGE,SLAT)        !CARTESIAN
STATA=0
NSITE=NCENTRE
TETRA=MATMUL(TETRA,SLAT)
PRINT*,'RPOLY=',RPOLY
PRINT*,SCAGE,NNTYPE(SCAGE)
PRINT*,NNTYPE

DO IT=1,IREF2-IREF1+1-TSKIP  !,TSKIP  !,TSKIP !10
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!GETTING POLY CORIDNATES AND!!!!!!!!!!!!CALCULATE ISEL FRAMES
                DO I=1,ISEL
                AB(I,1,:)=MATMUL(POS(IT,IIPICK(I,2),:)-POS(IT,IIPICK(I,1),:),ISLATORIG )     !!!!!!!!TETEAHEDRAL EDGES  FORMED BY FOUR SE ATOM
                AB(I,2,:)=MATMUL(POS(IT,IIPICK(I,3),:)-POS(IT,IIPICK(I,1),:),ISLATORIG )
                AB(I,3,:)=MATMUL(POS(IT,IIPICK(I,4),:)-POS(IT,IIPICK(I,1),:),ISLATORIG )
                WHERE(AB(I,1,:).GT.RANG)AB(I,1,:)=AB(I,1,:)-1
                WHERE(AB(I,2,:).GT.RANG)AB(I,2,:)=AB(I,2,:)-1
                WHERE(AB(I,3,:).GT.RANG)AB(I,3,:)=AB(I,3,:)-1
                WHERE(AB(I,1,:).LT.-RANG)AB(I,1,:)=AB(I,1,:)+1
                WHERE(AB(I,2,:).LT.-RANG)AB(I,2,:)=AB(I,2,:)+1
                WHERE(AB(I,3,:).LT.-RANG)AB(I,3,:)=AB(I,3,:)+1
                AB(I,1,:)=MATMUL(AB(I,1,:),SLATORIG)
                AB(I,2,:)=MATMUL(AB(I,2,:),SLATORIG)
                AB(I,3,:)=MATMUL(AB(I,3,:),SLATORIG)
                CALL GAUSS(AB(I,:,:),3)
                END DO

JTAG=0
NRMAT=0
ATMDST=0
RMONI=0
RMESH=1        !JST TO AVOID SEGMENTAION FAULT
                DO I=SUM(NNTYPE(1:IDFF-1))+1,SUM(NNTYPE(1:IDFF))
                JTAG=JTAG+1
                PPSTATA(JTAG)=SSTATA(JTAG)
                SSTATA(JTAG)=0
                PSTATA(RMESH,JTAG)=STATA(RMESH,JTAG)
                        DO J=1,ISEL
                        LOCAL=MATMUL(POS(IT,I,:)-POS(IT,IIPICK(J,1),:),ISLATORIG)
                        LOCAL=LOCAL-NINT(LOCAL)
!                        WHERE(LOCAL.GT.0.5)LOCAL=LOCAL-1
!                        WHERE(LOCAL.LT.-0.5)LOCAL=LOCAL+1
                        LOCAL=MATMUL(LOCAL,SLATORIG)
                        !XX=MATMUL(LOCAL,AB(J,:,:))
                        XX=MATMUL(AB(J,:,:),LOCAL)
                        !IF(I==ICK)PRINT*,XX  !SSTATA(JTAG)
                        23 FORMAT(3F10.3,2x,3F10.3)
                        21 FORMAT(3F10.3)
                        IF(ANY(XX.LE.TOL1)==.FALSE..AND.ANY(XX.GT.TOL2) ==.FALSE..AND.SUM(XX).LE.1.0)THEN
                        SSTATA(JTAG)=2
                        EXIT
                        END IF
                ENDDO

                IF(SSTATA(JTAG)-PPSTATA(JTAG)>0)AATTEMPT(JTAG)=AATTEMPT(JTAG)+1
                PATMST(JTAG)=ATMST(JTAG)   !SET ATOM LOCATION AT PREVISOUS TIME !SITE
                RCG(JTAG,:)=SUM(POS(IT:IT+TSKIP-1,I,:),DIM=1)/(MAX(TSKIP,1))          !COARSE GRAIN
                IF(IT==1)RCG(JTAG,:)=POS(1,I,:)
                RMAT(1:NCENTRE,:)=MATMUL(spread(RCG(JTAG,:),1,NCENTRE)-RCAGE(1:NCENTRE,:),ISLAT)                     !SITE TO ATOM DISTANCE
                !WHERE(RMAT.Le.-0.5)RMAT=RMAT-NINT(RMAT)
                !WHERE(RMAT.Ge.0.5)RMAT=RMAT-NINT(RMAT)
                !RMAT=RMAT-NINT(RMAT)
                RMAT=RMAT-NINT(RMAT)
                RMAT=MATMUL(RMAT,SLAT)
                NRMAT(1:NCENTRE)=NORM2(RMAT(1:NCENTRE,:),DIM=2)
                915 FORMAT(3F6.3,3x,F10.5,I5)
                ATMST(JTAG)=MINLOC(NRMAT(1:NCENTRE),DIM=1)                                               !FINDING NEAREST SITE
                ATMDST(JTAG)=MINVAL(NRMAT(1:NCENTRE),DIM=1)                                              !AND DISTANCE FROM SITE
                !PRINT 12356,ATMST(JTAG),ATMDST(JTAG),MATMUL(RCG(JTAG,:),ISLAT),MATMUL(RCAGE(ATMST(JTAG),:),ISLAT)
                12356 FORMAT(I7,F10.5,3F10.5,2x,3F10.5)

                8765 format(2I8,3f7.3,1x,3f7.3)
                IF(IT== 1)THEN
                 PATMST(JTAG)=ATMST(JTAG)
                 REFCAGE(JTAG,:)=RCAGE(CAGEID(ATMST(JTAG)),:)                                          !SET ATOM CAGE CENTER
                 PCAGEID(ATMST(JTAG))=CAGEID(ATMST(JTAG))                                              !SET ATOME CAGEID AT PREVISOU TIME
                ELSE
                 IF(CAGEID(PATMST(JTAG)).NE.0)PCAGEID(ATMST(JTAG))=CAGEID(PATMST(JTAG))                                              !SET ATOME CAGEID AT PREVISOU TIME
                 !PRINT*,JTAG,PATMST(JTAG),ATMST(JTAG)

                 RFRAC(JTAG,:)=MATMUL(RCG(JTAG,:)-REFCAGE(JTAG,:),ISLAT)
                ! PRINT*,RCG(JTAG,:) !RFRAC(JTAG,:)
                 WHERE(NINT(RFRAC(JTAG,:)).LE.-1)RFRAC(JTAG,:)=RFRAC(JTAG,:)-NINT(RFRAC(JTAG,:))
                 WHERE(NINT(RFRAC(JTAG,:)).GE.1.0)RFRAC(JTAG,:)=RFRAC(JTAG,:)-NINT(RFRAC(JTAG,:))
                 RMONI(JTAG)=NORM2(MATMUL(RFRAC(JTAG,:),SLAT))
                         RMESH=INT(RMONI(JTAG)/DR)
                  !      PRINT*,RMESH
                         IF(RMESH==0)RMESH=1
                         PRMESH(RMESH)=PRMESH(RMESH)+1
                 STATA(RMESH,JTAG)=RMESH
                 IF(RMONI(JTAG)>PRMONI(JTAG))ATTEMPT(RMESH,JTAG)=ATTEMPT(RMESH,JTAG)+1
                 TOCC(RMESH,JTAG)=TOCC(RMESH,JTAG)+1
                 PSTATA(RMESH,JTAG)=STATA(RMESH,JTAG)
                 PRMONI(JTAG)=RMONI(JTAG) !NORM2(MATMUL(RFRAC(JTAG,:),SLAT))
                 IF(RMONI(JTAG) .GT. RCUTOFF.AND.CAGEID(ATMST(JTAG)).NE.0 ) THEN
                 SUCCESS(JTAG)=SUCCESS(JTAG)+1
                 REFCAGE(JTAG,:)=RCAGE(CAGEID(ATMST(JTAG)),:)
                 END IF
                END IF
        END DO

9118 FORMAT(5I6,100F10.4)
                !PRINT 9118,IT,AATTEMPT(ICK), SUCCESS(ICK) !,CAGEID(ATMST(ICK)),RMONI(ICK) 
                !CAGEID(PATMST(ICK)),PCAGEID(ATMST(ICK)) ,RMONI(ICK)! RCAGE(PCAGEID(ATMST(ICK)),:), RFRAC(ICK,:)!,REAL(TIMER(1)) !, REAL(RCG(1,:)),REAL(REFCAGE(1,:))
        WRITE(999,912)IT,SUM(AATTEMPT),SUM(SUCCESS)

END DO



        DO IR=1,NMESH 
        SHELLVOL=4.0*3.14*(IR*IR*DR*DR)*DR
        WRITE(987,987)IR*DR,REAL(SUM(ATTEMPT(IR,:)))/REAL(DELT*NNTYPE(IDFF)*(IREF2-IREF1+1-TSKIP)*SHELLVOL)  ,REAL(SUM(TOCC(IR,:)))/REAL(DELT*NNTYPE(IDFF)*(IREF2-IREF1+1-TSKIP)*SHELLVOL)
        END DO

        DO JTAG=1,NNTYPE(IDFF)
        WRITE(910,910)JTAG,SUM(ATTEMPT(35:100,JTAG)),SUCCESS(JTAG),REAL(SUCCESS(JTAG))   !/REAL(SUM(ATTEMPT(1:100,JTAG)))
        END DO
        WRITE(909,909)TSKIP,RCUTOFF,SUM(ATTEMPT(1:100,:)),SUM(SUCCESS),REAL(SUM(SUCCESS))/REAL(SUM(ATTEMPT(1:100,:)))
        WHERE(PRMESH==0)PRMESH=1
        DO IMESH=1,NMESH !100
        WRITE(916,916)IMESH*DR,PRMESH(IMESH)/SUM(PRMESH),-0.08617328149741*TEMPER*ALOG(PRMESH(IMESH)/SUM( PRMESH))
        END DO
916 FORMAT(F10.5,3E15.5)
912 FORMAT(I8,1000(I7,1000I7))
918 FORMAT(5I6,100F10.4)
909 FORMAT(I8,F10.2,2I9,F10.4)
910 FORMAT(I8,2I9,F10.4)
987 FORMAT(F10.4,3x,102F12.5)
!ALLOCATE(ATMST(NNTYPE(IDFF)))
!ALLOCATE(PATMST(NNTYPE(IDFF)))
!ALLOCATE(ATMDST(NNTYPE(IDFF)))
!ALLOCATE(RMAT(NCENTRE,3))
!ALLOCATE(NRMAT(NCENTRE))
!ALLOCATE(RCAGE(NCENTRE,3))
!ALLOCATE(SUCCESS(NNTYPE(IDFF)))
!ALLOCATE(ATTEMPT(100,NNTYPE(IDFF)))
!ALLOCATE(STATA(100,NNTYPE(IDFF)))
!ALLOCATE(PSTATA(100,NNTYPE(IDFF)))
!ALLOCATE(TOCC(100,NNTYPE(IDFF)))
!ALLOCATE(RMONI(NNTYPE(IDFF)))
!ALLOCATE(PRMONI(NNTYPE(IDFF)))
!ALLOCATE(REFFF(NNTYPE(IDFF),3))
!ALLOCATE(RCG(NNTYPE(IDFF),3))
!ALLOCATE(REFCAGE(NNTYPE(IDFF),3))
!ALLOCATE(TIMER(NNTYPE(IDFF)))
!ALLOCATE(PICK(NTETRA,12),RPICK(NTETRA,12),RRPICK(NTETRA,12),IIPICK(NTETRA,12),IPICK(NTETRA,12),CENTRE(NTETRA,3))
!ALLOCATE(AB(NTETRA,3,3))
!ALLOCATE(CAGEID(NTETRA))
!ALLOCATE(PCAGEID(NTETRA))
!!ALLOCATE(TETRA(NTETRA,3))
!ALLOCATE(RFRAC(NNTYPE(IDFF),3))
!ALLOCATE(AATTEMPT(NNTYPE(IDFF)))
!ALLOCATE(SSTATA(NNTYPE(IDFF)))
!ALLOCATE(PPSTATA(NNTYPE(IDFF)))
DEALLOCATE(ATMST,PATMST,ATMDST,RMAT,NRMAT,RCAGE,SUCCESS,ATTEMPT,STATA,PSTATA,TOCC,RMONI,PRMONI,REFFF,RCG,REFCAGE,TIMER,PICK,RPICK,RRPICK,IIPICK,IPICK,CENTRE,AB,CAGEID,PCAGEID,TETRA,RFRAC,AATTEMPT,SSTATA,PPSTATA)
END SUBROUTINE

SUBROUTINE CHGCAR2021(IIREF)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::NX,NY,NZ,IIREF
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::CHG
DOUBLE PRECISION,DIMENSION(NNTYPE(IIREF),3)::DPOS
DOUBLE PRECISION,DIMENSION(NNTYPE(IIREF))::FIRE !DPOS
INTEGER::I1,I2
DOUBLE PRECISION::DX,DY,DZ
DOUBLE PRECISION::DX1,DY1,DZ1
DOUBLE PRECISION::DX2,DY2,DZ2
INTEGER,DIMENSION(NNTYPE(IIREF),3)::NNBIN
INTEGER::IKK,INDDD
REAL::SIG
INTEGER::XI,YI,ZI
INTEGER::ISMEAR,NMAX
REAL,DIMENSION(3)::DMAT
REAL::RDIS
DOUBLE PRECISION,DIMENSION(1000)::RRDIS
INTEGER::RMESH

ISMEAR=1
SIG=1
PRINT*,ISLAT
NMAX=100
NX=NMAX  
NY=NMAX 
NZ=NMAX 
ALLOCATE(CHG(0:NX,0:NY,0:NZ))
CHG=0
I1=SUM(NNTYPE(1:IIREF-1))+1
I2=SUM(NNTYPE(1:IIREF))
OPEN(101,FILE="PROB.vasp")
OPEN(102,FILE="RPROB")
WRITE(101,*)'COMMENT PROBABILITY DENSITY'
WRITE(101,*)'1.0'
WRITE(101,102)SLAT(1,:)
WRITE(101,102)SLAT(2,:)
WRITE(101,102)SLAT(3,:)
WRITE(101,103)ATMNM !SLAT(1,:)
WRITE(101,*)NNTYPE !ATMNM !SLAT(1,:)
WRITE(101,*)'D' !SLAT(1,:)
DO I=1,NATOM
!WRITE(101,102)MATMUL(ISLAT,POS(1,I,:)) !ATMNM !SLAT(1,:)
!WRITE(101,102)MATMUL(ISLAT,POS(1,I,:)) !ATMNM !SLAT(1,:)
WRITE(101,102)MATMUL(POS(1,I,:),ISLAT) !ATMNM !SLAT(1,:)
!IF(ISOFT==3)WRITE(101,102) POS(1,I,:)  !MATMUL(ISLATORIG,POS(1,I,:)) !ATMNM !SLAT(1,:)
END DO
WRITE(101,*) !SLAT(1,:)
!WRITE(101,*)NX+1,NY+1,NZ+1
WRITE(101,*)NX,NY,NZ
102 FORMAT(3F20.15)
103 FORMAT(10A3)
!!$omp parallel do
        DO IT=1,IREF2-IREF1+1  !NSTEPORIG
        IKK=0
        DO IK=I1,I2
        IKK=IK-SUM(NNTYPE(1:IIREF-1))
        !DPOS(IKK,:)=MATMUL(ISLAT,POS(IT,IK,:))
        DPOS(IKK,:)=MATMUL(POS(IT,IK,:),ISLAT)
        !WHERE(DPOS(IKK,:).LT.0)DPOS(IKK,:)=DPOS(IKK,:)+1 
        !WHERE(DPOS(IKK,:).GT.1)DPOS(IKK,:)=DPOS(IKK,:)-1
        DPOS(IKK,:)=DPOS(IKK,:)-NINT(DPOS(IKK,:))
        WHERE(DPOS(IKK,:).LT.0)DPOS(IKK,:)=DPOS(IKK,:)+1
        111 FORMAT(3F10.5)
        NNBIN(IKK,1)=DPOS(IKK,1)*NX
        NNBIN(IKK,2)=DPOS(IKK,2)*NY
        NNBIN(IKK,3)=DPOS(IKK,3)*NZ
        XI=NNBIN(IKK,1)
        YI=NNBIN(IKK,2)
        ZI=NNBIN(IKK,3)

        IF(ANY(NNBIN(IKK,:)<0).EQ..FALSE..AND.ANY(NNBIN(IKK,:)>NMAX).EQ..FALSE.)THEN
		CHG(NNBIN(IKK ,1), NNBIN(IKK,2), NNBIN(IKK,3))= CHG(NNBIN(IKK,1), NNBIN(IKK,2), NNBIN(IKK,3))+1              
		IF(ISMEAR==1)THEN
		IF(XI+1.LE.NMAX)CHG(XI+1, YI,ZI)= CHG(XI+1,YI,ZI)+exp(-1.0/sig)  
		IF(XI+2.LE.NMAX)CHG(XI+2, YI,ZI)= CHG(XI+2,YI,ZI)+exp(-4.0/sig)  
		IF(XI+3.LE.NMAX)CHG(XI+3, YI,ZI)= CHG(XI+3,YI,ZI)+exp(-9.0/sig)  
		IF(XI-1.GE.0)CHG(XI-1, YI,ZI)= CHG(XI-1,YI,ZI)+exp(-1.0/sig)  
		IF(XI-2.GE.0)CHG(XI-2, YI,ZI)= CHG(XI-2,YI,ZI)+exp(-4.0/sig)  
		IF(XI-3.GE.0)CHG(XI-3, YI,ZI)= CHG(XI-3,YI,ZI)+exp(-9.0/sig)  


	        IF(YI+1.LE.NMAX)	CHG(XI, YI+1,ZI)= CHG(XI,YI+1,ZI)+exp(-1.0/sig)  
           	IF(YI+2.LE.NMAX)	CHG(XI, YI+2,ZI)= CHG(XI,YI+2,ZI)+exp(-4.0/sig)  
	        IF(YI+3.LE.NMAX)	CHG(XI, YI+3,ZI)= CHG(XI,YI+3,ZI)+exp(-9.0/sig)  
		IF(YI-1.GE.0)CHG(XI, YI-1,ZI)= CHG(XI,YI-1,ZI)+exp(-1.0/sig)  
		IF(YI-2.GE.0)CHG(XI, YI-2,ZI)= CHG(XI,YI-2,ZI)+exp(-4.0/sig)  
		IF(YI-3.GE.0)CHG(XI, YI-3,ZI)= CHG(XI,YI-3,ZI)+exp(-9.0/sig)  



		IF(ZI+1.LE.NMAX)CHG(XI, YI,ZI+1)= CHG(XI,YI,ZI+1)+exp(-1.0/sig)  
		IF(ZI+2.LE.NMAX)CHG(XI, YI,ZI+2)= CHG(XI,YI,ZI+2)+exp(-4.0/sig)  
		IF(ZI+3.LE.NMAX)CHG(XI, YI,ZI+3)= CHG(XI,YI,ZI+3)+exp(-9.0/sig)  
		IF(ZI-1.GE.0)CHG(XI, YI,ZI-1)= CHG(XI,YI,ZI-1)+exp(-1.0/sig)  
		IF(ZI-2.GE.0)CHG(XI, YI,ZI-2)= CHG(XI,YI,ZI-2)+exp(-4.0/sig)  
		IF(ZI-3.GE.0)CHG(XI, YI,ZI-3)= CHG(XI,YI,ZI-3)+exp(-9.0/sig)  
		END IF
!		CHG(NNBIN(IKK ,1), NNBIN(IKK,2), NNBIN(IKK,3))= CHG(NNBIN(IKK,1), NNBIN(IKK,2), NNBIN(IKK,3))+1              

	END IF

!        CHG(NNBIN(IKK,1), NNBIN(IKK,2), NNBIN(IKK,3))=CHG(NNBIN(IKK,1), NNBIN(IKK,2), NNBIN(IKK,3))+1
        END DO
        END DO
!!$omp end parallel do
        !CHG=CHG*1000/(NNTYPE(IIREF)*(IREF2-IREF1+1)) 
        CHG=CHG/SUM(CHG)  !*1000/(NNTYPE(IIREF)*(IREF2-IREF1+1)) 
print*,sum(CHG)

WRITE(101,101)(((CHG(I,J,K),I=0,NX-1),J=0,NY-1),K=0,NZ-1)
101 FORMAT(5E12.5)
PRINT*,'PROBABILITY DISTRIBUTION OF',ATMNM(IIREF),'IS CALCULATED OVER',IREF2-IREF1+1,'STEPS'
!!!!!!!!!!!!!!!!!FOLDING  THE STRUCTURE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
RRDIS=0
DO I=1,NX
DO J=1,NY
DO K=1,NZ
DMAT=(/REAL(I-1)/REAL(NX),REAL(J-1)/REAL(NY),REAL(K-1)/REAL(NZ)/)
RDIS=NORM2(MATMUL(DMAT,SLATORIG))
RMESH=RDIS/0.1
IF(RMESH.LE.1000.AND.RMESH.GT.0)RRDIS(RMESH)=RRDIS(RMESH)+ CHG(I,J,K)
!WRITE(102,1102)RDIS,CHG(I,J,K)
END DO
END DO
END DO
DO I=1,1000
WRITE(102,1102)0.1*I, RRDIS(I) !RDIS,CHG(I,J,K)
END DO
1102 FORMAT(F10.5,F13.5)
CLOSE(102)
END SUBROUTINE





SUBROUTINE VVACF4
use omp_lib
USE VARIABLES1
IMPLICIT NONE
COMPLEX,ALLOCATABLE,DIMENSION(:,:,:)::VELC
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DIFFUSION,DIFFUSIONC,CDIFFUSION
DOUBLE PRECISION::PHASE1
INTEGER::IFOR,IBAC,ISCHEME,PLAN
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::AAAA,BBBB,HR
INTEGER::II1,I1
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DOS,DOSB   !!!!DOSB BROADENED 
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DOST,DOSTB
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DOSTBS,DOSBS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DOSTBSS
COMPLEX,ALLOCATABLE,DIMENSION(:,:,:)::VACFC
COMPLEX,ALLOCATABLE,DIMENSION(:,:,:)::VACFCT,CDOS
DOUBLE PRECISION::TOTAL_WEIGHT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::WEIGHT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::NWPDOS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::SCALTYPE,DUMMY1,DUMMY2
DOUBLE PRECISION,DIMENSION(1000)::CV
DOUBLE PRECISION::FRE,TEMP,H ,KB  ,HH   
DOUBLE PRECISION,EXTERNAL::DNBOSE1
DOUBLE PRECISION,EXTERNAL::NBOSE1
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::U2E
ALLOCATE(U2E(NDOS,NTYP,3))
HH=6.626068E-26/1.66053886E-27
H=6.626069300000000159e-22   ! ORDER OF 12 LESS BECAUSE WHEN WE MULTIPLY W IT IS IN THZ
KB=1.380650500000000147e-23
!BETA1=47.99237243603648754
IF(IVACF==1)OPEN(8558,FILE='HAVEN_RATIO')
IF(IVACF==1)OPEN(8559,FILE='CROSS_DOS.DAT')
ALLOCATE(VELC(NSTEP,NATOM,3),DIFFUSION(NTYP,3),AAAA(2*NSTEP),DOS(NSTEP,NATOM,3),DOST(NSTEP,NTYP,3),DOSTB(NSTEP,NTYP,3),VACFC(NSTEP,NATOM,3),VACFCT(NSTEP,NTYP,3))
ALLOCATE(DOSB(NSTEP,NATOM,3))
ALLOCATE(DIFFUSIONC(NTYP,3))
ALLOCATE(CDIFFUSION(NTYP,3))
ALLOCATE(WEIGHT(NTYP))
ALLOCATE(NWPDOS(NSTEP,NTYP))
ALLOCATE(SCALTYPE(NTYP))
ALLOCATE(BBBB(2*NSTEP))
ALLOCATE(DOSTBS(NSTEP,NTYP),DOSBS(NSTEP,NATOM))
ALLOCATE(DOSTBSS(NSTEP))
ALLOCATE(DUMMY1(NDOS),DUMMY2(NDOS))
ALLOCATE(CDOS(NSTEP,NTYP,3))
ALLOCATE(HR(NTYP))
IFOR= 1
IBAC=-1
CDOS=0
!!!!!!!!!!!!!!!!!!!!!!!!!VACF!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
PRINT*, "I M IN VVACF1"
PRINT*,NSTEP
ITYP=1
        DO I=1,NATOM
                DO J=1,3 !!!!!!!!!CARTESIAN DEGREE OF FREEDOME

        		AAAA(1:2*NSTEP:2)=VEL(1:NSTEP,I,J)  !REAL(FQT(II1,I))
        		AAAA(2:2*NSTEP:2)=0 !VEL(II1,I,J) !AIMAG(FQT(II1,I))
                        CALL DFOUR1(AAAA,NSTEP,IFOR)
                        AAAA=AAAA/REAL(NSTEPORIG)

                		VELC(1:NSTEP,I,J)=CMPLX(AAAA(1:2*NSTEP:2),AAAA(2:2*NSTEP:2))   !!!!!!!
                                DOS(1:NSTEP,I,J)= (VELC(1:NSTEP,I,J)*CONJG(VELC(1:NSTEP,I,J)))
                                IF(I.LE.SUM(NNTYPE(1:ITYP)).AND.I.GT.SUM(NNTYPE(1:ITYP-1)))THEN
                                IITYP=ITYP
                                ELSE
                                IITYP=IITYP+1
                                ITYP=IITYP
                                END IF
                                DOST(1:NSTEP,IITYP,J)=DOST(1:NSTEP,IITYP,J)+DOS(1:NSTEP,I,J)/NNTYPE(IITYP)
                END DO
        END DO


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!VACF!!!!!!!!!!!!!!!!!!
ITYP=1
        DO I=1,NATOM
                DO J=1,3 !!!!!!!!!CARTESIAN DEGREE OF FREEDOME
                        AAAA(1:2*NSTEP:2)=DOS(1:NSTEP,I,J)  !REAL(FQT(II1,I))
        		AAAA(2:2*NSTEP:2)=0  !AIMAG(FQT(II1,I))
                        CALL dfour1(AAAA,NSTEP,IBAC)
        		VACFC(1:NSTEP,I,J)=CMPLX(AAAA(1:2*NSTEP:2),AAAA(2:2*NSTEP:2))   !!!!!!!
              END DO
        END DO
        
        DO I=1,NTYP
        VACFCT(:,I,:)=SUM(VACFC(:,SUM(NNTYPE(1:I-1)) +1: SUM(NNTYPE(1:I)),:)/NNTYPE(I),DIM=2)  !/NNTYPE(IITYP)
        END DO
        DO I=1,NTYP
        PRINT*, SUM((VEL(1,SUM(NNTYPE(1:I-1)) +1: SUM(NNTYPE(1:I)),:)**2)/NNTYPE(I),DIM=1)  !/NNTYPE(IITYP)
        END DO

        DO IT=1,NSTEP
        WRITE(80,80) REAL((IT-1)*DELT),(VACFCT(IT,ITYP,1:3),ITYP=1,NTYP)
        80 FORMAT(E15.5,2X,100(3(2E20.8,2x)3x)) 
        END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!CORRELATION CALCULATION
!!!!!!!!!!!!!!!!!!!!!!!!!CROSS VACF

        DO IT=1,NTYP
                DO I=SUM(NNTYPE(1:IT-1))+1 ,SUM(NNTYPE(1:IT))               
                DO J=SUM(NNTYPE(1:IT-1))+1 ,SUM(NNTYPE(1:IT))               
                !PRINT*,IT,I,J
                IF(I.NE.J) CDOS(:,IT,:)=CDOS(:,IT,:)+ (VELC(:,I,:)*CONJG(VELC(:,J,:)))
                END DO
                END DO
                CDOS(:,IT,:)=CDOS(:,IT,:)/(NNTYPE(IT)*(NNTYPE(IT)+1)/2.0)
        END DO
        DO I=1,NSTEP
        WRITE(8559,8559)4.136*REAL((I-1)/(DELT*NSTEP)),(SUM(REAL(CDOS(I,K,:))),K=1,NTYP)
        8559 FORMAT(3F10.6,100E15.5)
        END DO

        DO IT=1,NTYP
                !FOURIER STUFF        
                DO J=1,3
                AAAA(1:2*NSTEP:2)=CDOS(1:NSTEP,IT,J)  !REAL(FQT(II1,I))
                AAAA(2:2*NSTEP:2)=0  !AIMAG(FQT(II1,I))
                CALL dfour1(AAAA,NSTEP,IBAC)
                CDOS(1:NSTEP,IT,J)=CMPLX(AAAA(1:2*NSTEP:2),AAAA(2:2*NSTEP:2))   !!!!!!!
                END DO
                PRINT*,'CROSS VACF' 
                PRINT*, 1.0E-4*DELT*SUM(CDOS(:,IT,:),DIM=1)/2.0  !/NNTYPE(IITYP)
        END DO
        DO I=1,NSTEP
        WRITE(8560,8559)REAL(I-1)*DELT,(SUM(REAL(CDOS(I,K,:))),K=1,NTYP)
        END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
PRINT*,'DIFFUSION in cm2/sec,and Haven Ratio'
DO I=1,NTYP
PRINT*, ATMNM(I)
!DIFFUSION(I,1)=1.0E-4*DELT*SUM(REAL(VACFCT(1:NSTEP,I,1)))/2  !i/(3.0*NNTYPE(I))
!DIFFUSION(I,2)=1.0E-4*DELT*SUM(REAL(VACFCT(1:NSTEP,I,2)))/2 !/(3.0*NNTYPE(I))
!DIFFUSION(I,3)=1.0E-4*DELT*SUM(REAL(VACFCT(1:NSTEP,I,3)))/2  !/(3.0*NNTYPE(I))
!CDIFFUSION(I,1)= 1.0E-4*DELT*SUM(REAL(CDOS(1:NSTEP,I,1)))/2  !i/(3.0*NNTYPE(I))
!CDIFFUSION(I,2)= 1.0E-4*DELT*SUM(REAL(CDOS(1:NSTEP,I,2)))/2 !/(3.0*NNTYPE(I))
!CDIFFUSION(I,3)= 1.0E-4*DELT*SUM(REAL(CDOS(1:NSTEP,I,3)))/2  !/(3.0*NNTYPE(I))

DIFFUSION(I,1)=1.0E-4*DELT*( SUM(REAL(VACFCT(1:NSTEP/2,I,1))) - REAL(VACFCT(1,I,1))/2 - REAL(VACFCT(NSTEP/2,I,1))/2 ) !  /2  !i/(3.0*NNTYPE(I))
DIFFUSION(I,2)=1.0E-4*DELT*( SUM(REAL(VACFCT(1:NSTEP/2,I,2))) - REAL(VACFCT(1,I,2))/2 - REAL(VACFCT(NSTEP/2,I,2))/2 ) !/2 !/(3.0*NNTYPE(I))
DIFFUSION(I,3)=1.0E-4*DELT*( SUM(REAL(VACFCT(1:NSTEP/2,I,3))) - REAL(VACFCT(1,I,3))/2 - REAL(VACFCT(NSTEP/2,I,3))/2 ) !/2  !/(3.0*NNTYPE(I))
CDIFFUSION(I,1)= 1.0E-4*DELT*( SUM(REAL(CDOS(1:NSTEP/2,I,1))) - REAL(CDOS(1,I,1))/2 - REAL(CDOS(NSTEP/2,I,1))/2 ) ! /2  !i/(3.0*NNTYPE(I))
CDIFFUSION(I,2)= 1.0E-4*DELT*( SUM(REAL(CDOS(1:NSTEP/2,I,2))) - REAL(CDOS(1,I,2))/2 - REAL(CDOS(NSTEP/2,I,2))/2 ) ! !/(3.0*NNTYPE(I))
CDIFFUSION(I,3)= 1.0E-4*DELT*( SUM(REAL(CDOS(1:NSTEP/2,I,3))) - REAL(CDOS(1,I,3))/2 - REAL(CDOS(NSTEP/2,I,3))/2 ) !/2  !/(3.0*NNTYPE(I))
PRINT*,'SELF=',SUM(DIFFUSION(I,:))/3.0
PRINT*,'CROSS=',SUM(CDIFFUSION(I,:))/3.0
!,DIFFUSIONC(I,:)
62 FORMAT(3E10.3,2X,3E10.3)
HR(I)=SUM(DIFFUSION(I,:))/(SUM(DIFFUSION(I,:))+SUM(CDIFFUSION(I,:)))

PRINT*,'HAVEN  RATIO',HR(I)
WRITE(8558,*)HR(I)
END DO


!DIFFUSION(


!!!!!!!!!!!!!!!!!!!!!!!!!!!DEFINE DELE FOR BROADENING PURPOSE

!###################################################################################
        DELW=4.136*REAL(1/(DELT*NSTEP))                                           !#
        DO I=1,NTYP                                                               !# 
        DO J=1,3                                                                  !
        DOST(:,I,J)=DOST(:,I,J)/(DELW*SUM(DOST(1:NSTEP/2,I,J)))                   !
        END DO                                                                    !
        END DO                                                                    ! 
                                                                                  !
        DO I=1,NATOM                                                              !
        DO J=1,3                                                                  !
        DOS(:,I,J)=DOS(:,I,J)/(DELW*SUM(DOS(1:NSTEP/2,I,J)))                      !
        END DO                                                                    !
        END DO                                                                    !
!###################################################################################

DELE=4.136/REAL(DELT*NSTEP)
PRINT*,'DELE in meV=',DELE
PRINT*,NDOS

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!BROADENING THE DATA!!!!!!!!!!!!!!!!!!!!!!!
DO IJ=1,NTYP
DUMMY1=DOST(1:NDOS,IJ,1)
print*,'typ',IBROAD
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)

!#print*,'ityp',IJ
DOSTB(1:NDOS,IJ,1)=DUMMY2
DUMMY1=DOST(:,IJ,2)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSTB(1:NDOS,IJ,2)=DUMMY2

DUMMY1=DOST(1:NDOS,IJ,3)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSTB(1:NDOS,IJ,3)=DUMMY2
END DO
!PRINT*, 'FWHM in meV='
!READ*,FWHM
!FWHM=3.0 

!PRINT*, 'FWHM in meV=',FWHM0
!DELW=4.136*REAL(1/(DELT*NSTEP))

!DO I=1,NDOS  !NSTEP
!        OMEGA=4.136*REAL((I-1)/(DELT*NSTEP))
!        IF(OMEGA.GT.200)EXIT
!        FWHM=(FWHM0**2)  + ((FWHM1*OMEGA/100)**2)
!        DO IJ=1,NTYP   !!!!!!!!!! for dimension
!        SUMM=0
!                DO IK=0,NSTEP !1000
!                DELX=REAL(I-IK)*DELW
!                DELX=DELX*DELX
!                BROAD=EXP(-DELX/FWHM)
!                DOSTB(I,IJ,:)=DOSTB(I,IJ,:)+DOST(IK,IJ,:)*BROAD
!                SUMM=SUMM+BROAD
!                END DO
!                IF(SUMM.GT.0)DOSTB(I,IJ,:)=DOSTB(I,IJ,:)/SUMM
!        END DO
!END DO
!!!!!!!!!!!!!!!!!BROADENING OF INDIVIDUAL!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
IF(INDIVIDUAL==1)THEN
DO IJ=1,NATOM
DUMMY1=DOS(1:NDOS,IJ,1)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSB(1:NDOS,IJ,1)=DUMMY2

DUMMY1=DOS(1:NDOS,IJ,2)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSB(1:NDOS,IJ,2)=DUMMY2

DUMMY1=DOS(1:NDOS,IJ,3)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSB(1:NDOS,IJ,3)=DUMMY2
END DO
END IF
!DO I=1,NDOS  !NSTEP
!        OMEGA=4.136*REAL((I-1)/(DELT*NSTEP))
!        IF(OMEGA.GT.200)EXIT
!        FWHM=(FWHM0**2)  + ((FWHM1*OMEGA/100)**2)
!        DO IJ=1,NATOM   !!!!!!!!!! for dimension
!        SUMM=0
!                DO IK=0,NSTEP !1000
!                DELX=REAL(I-IK)*DELW
!                DELX=DELX*DELX
!                BROAD=EXP(-DELX/FWHM)
!                DOSB(I,IJ,:)=DOSB(I,IJ,:)+DOS(IK,IJ,:)*BROAD
!                SUMM=SUMM+BROAD
!                END DO
!                IF(SUMM.GT.0)DOSB(I,IJ,:)=DOSB(I,IJ,:)/SUMM
!        END DO
!END DO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!DELEE=4.136*REAL(1)/(DELT*NSTEP)
!NCUT=ECUT/DELEE

!!!!!!!!!!!!!!!!!!!!!!!!!NORMALIZATION 
!DO ITYP=1,NTYP
!ANORM1=SUM(ABS(DOSTB(1:NCUT,ITYP,1)))*DELW
!ANORM2=SUM(ABS(DOSTB(1:NCUT,ITYP,2)))*DELW
!ANORM3=SUM(ABS(DOSTB(1:NCUT,ITYP,3)))*DELW
!DOSTB(:,ITYP,1)=DOSTB(:,ITYP,1)/ANORM1
!DOSTB(:,ITYP,2)=DOSTB(:,ITYP,2)/ANORM1
!DOSTB(:,ITYP,3)=DOSTB(:,ITYP,3)/ANORM1
!DOSTBS(:,ITYP)=(DOSTB(:,ITYP,1)+DOSTB(:,ITYP,2)+DOSTB(:,ITYP,3))/3.0
!END DO
!DO ITYP=1,NATOM
!ANORM1=SUM(ABS(DOSB(1:NCUT,ITYP,1)))*DELW
!ANORM2=SUM(ABS(DOSB(1:NCUT,ITYP,2)))*DELW
!ANORM3=SUM(ABS(DOSB(1:NCUT,ITYP,3)))*DELW
!DOSB(:,ITYP,1)=DOSB(:,ITYP,1)/ANORM1
!DOSB(:,ITYP,2)=DOSB(:,ITYP,2)/ANORM1
!DOSB(:,ITYP,3)=DOSB(:,ITYP,3)/ANORM1
!DOSBS(:,ITYP)=(DOSB(:,ITYP,1)+DOSB(:,ITYP,2)+DOSB(:,ITYP,3))/3.0
!END DO


!!!!!!!!!!!!!!!!!!!!!REMOVE NEGATIVE DOS    SET TO ZERO!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
DO ITYP=1,NTYP
DO IIII=1,NDOS
IF(DOSTB(IIII,ITYP,1).LT.0)DOSTB(IIII,ITYP,1)=0
IF(DOSTB(IIII,ITYP,2).LT.0)DOSTB(IIII,ITYP,2)=0
IF(DOSTB(IIII,ITYP,3).LT.0)DOSTB(IIII,ITYP,3)=0
END DO
END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


DO ITYP=1,NTYP
ANORM1=SUM(ABS(DOSTB(1:NDOS,ITYP,1)))*DELW
ANORM2=SUM(ABS(DOSTB(1:NDOS,ITYP,2)))*DELW
ANORM3=SUM(ABS(DOSTB(1:NDOS,ITYP,3)))*DELW
DOSTB(:,ITYP,1)=DOSTB(:,ITYP,1)/ANORM1
DOSTB(:,ITYP,2)=DOSTB(:,ITYP,2)/ANORM1
DOSTB(:,ITYP,3)=DOSTB(:,ITYP,3)/ANORM1
DOSTBS(:,ITYP)=(DOSTB(:,ITYP,1)+DOSTB(:,ITYP,2)+DOSTB(:,ITYP,3))/3.0
END DO
DO ITYP=1,NATOM
ANORM1=SUM(ABS(DOSB(1:NDOS,ITYP,1)))*DELW
ANORM2=SUM(ABS(DOSB(1:NDOS,ITYP,2)))*DELW
ANORM3=SUM(ABS(DOSB(1:NDOS,ITYP,3)))*DELW
DOSB(:,ITYP,1)=DOSB(:,ITYP,1)/ANORM1
DOSB(:,ITYP,2)=DOSB(:,ITYP,2)/ANORM1
DOSB(:,ITYP,3)=DOSB(:,ITYP,3)/ANORM1
DOSBS(:,ITYP)=(DOSB(:,ITYP,1)+DOSB(:,ITYP,2)+DOSB(:,ITYP,3))/3.0
END DO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        

!        WRITE(81,*) '#ENE(meV), DOSXYZ_TYPE, DOSXYZIMG_TYPE'
!        WRITE(82,*) '#ENE(meV), DOS_TYPE_AS IN XDATCAR DOS_TOTAL'

        DO IT=1,NDOS
        OMEGA=4.136*REAL((IT-1)/(DELT*NSTEP))
        DOSTBSS(IT)=SUM(DOSTBS(IT,:)*NNTYPE(:))/(SUM(NNTYPE(:)))
        WRITE(81,81) OMEGA,(DOSTB(IT,ITYP,:),ITYP=1,NTYP)
        WRITE(82,81) OMEGA,(DOSTBS(IT,ITYP),ITYP=1,NTYP),DOSTBSS(IT)
        WRITE(821,81) OMEGA,(DOSBS(IT,ITYP),ITYP=1,NATOM)
        81 FORMAT(E15.5,2X,10000(3E20.8,2x)) 
        END DO


        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

        !!!!!!!!!!!!!!!!!!!NEUTRON WEIGHTED DOS!!!!!!!!!!!!!!!

PRINT*, ' I AM IN NEUTRON'
WEIGHT=NNTYPE*BBT2/MASST
TOTAL_WEIGHT=SUM(WEIGHT) 
PRINT*,'WEIGHT'
PRINT*, WEIGHT
NWPDOS=0

DO I=1,NDOS  !NSTEP
OMEGA=4.136*REAL((I-1)/(DELT*NSTEP))

        DO IJ=1,NTYP
        NWPDOS(I,IJ)=NWPDOS(I,IJ) +  (WEIGHT(IJ)*SUM(DOSTB(I,IJ,:))/(3.0*TOTAL_WEIGHT))
        END DO
WRITE(85,8)OMEGA,(NWPDOS(I,IJ),IJ=1,NTYP),(SUM(NWPDOS(I,1:NTYP)))
8 FORMAT(F10.4,1000E15.5)
!PRINT*,I
END DO
!!!!!!!!!!!!!!CALCULATE SPECIFIC HEAT!!!!!!!!!!
J=0
CV=0
DO TEMP=10,1000,10
J=J+1
DO I=1,NDOS
  FRE=REAL((I-1)/(DELT*NSTEP))
!  CV(J)= CV(J)+ 3*H*FRE*DOSTBSS(I)*(DNBOSE1(FRE,TEMP))*DELW* 6.023E23
  CV(J)= CV(J)+ H*FRE*DOSTBSS(I)*(DNBOSE1(FRE,TEMP))*DELW/KB !* 6.023E23
END DO
WRITE(86,86)TEMP,CV(J)
86 FORMAT(F10.5,3E15.5)
END DO
!/(V0*0.14824687E-30)



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!MSD FROM DOS UNDER HARMONIC  !APPROXIMATION!!!!!!!!!!!!!!!!!!!!!
IF(IMSD==1)OPEN(1002,FILE="U2EXYZ")
IF(IMSD==1)OPEN(1003,FILE="U2E")
DO I=1,NDOS  !POINTS
OMEGA=REAL((I-1)/(DELT*NSTEP))
FRE=OMEGA 
        DO J=1,NTYP
        U2e(I,J,:)=(NBOSE1(FRE,TEMPERATURE) +0.5)*HH*DOSTB(I,J,:)/(4*PI*PI*MASST(J)*FRE)
        END DO
IF(OMEGA.GE.0.001)WRITE(1002,2)4.136*OMEGA,(U2E(I,J,1:3),J=1,NTYP)
IF(OMEGA.GE.0.001)WRITE(1003,2)4.136*OMEGA,(SUM(U2E(I,J,1:3)),J=1,NTYP)
2 FORMAT(100F20.10)
ENDDO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


CLOSE(1002)
CLOSE(1003)
        DEALLOCATE(VELC,DIFFUSION,DOS,DOST,DOSTB,VACFC) 
        DEALLOCATE(NWPDOS,WEIGHT)
END SUBROUTINE        








SUBROUTINE DIFFUSE2021  !(IIREF)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::NX,NY,NZ !,IIREF
INTEGER::I1,I2
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::RM2
!COMPLEX,ALLOCATABLE,DIMENSION(:)::DIFF 
INTEGER::D1,D2,D3,DK,MAXDIM,NMAX
integer::id1,id2,id3
!DOUBLE PRECISION,DIMENSION(NATOM)::CCBBT
NMAX=100
DO ITYP=1,NTYP 
N1=SUM(NNTYPE(1:ITYP-1))+1
N2=SUM(NNTYPE(1:ITYP)) 
CCBBT(N1:N2)=CBBT(ITYP)
END DO
!NX=NMAX1 
!NY=NMAX2
!NZ=NMAX3
!MAXDIM=(NX+1)*(NY+1)*(NZ+1)
!ALLOCATE(DIFF(MAXDIM))
!ALLOCATE(RM2(NATOM))
!ALLOCATE(QQQ(0:NX,0:NY,0:NZ,3))
102 FORMAT(3F20.15)
103 FORMAT(10A3)
!!!!!!!!!!!!!!!!!!!!!!THINKING OF DIFFUSE SCATTERING!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
PRINT*,'Diffuse IT',IT
ID1=0
DO ITYP=1,NTYP
N1=SUM(NNTYPE(1:ITYP-1))+1
N2=SUM(NNTYPE(1:ITYP))
!$omp parallel do
  DO D1=NMAX11,NMAX12 !0,NX
  DO D2=NMAX21,NMAX22 !0,NY
  DO D3=NMAX31,NMAX32 !0,NZ 
  QQQ(ABS(D1-NMAX11)+1, ABS(D2-NMAX21)+1,ABS(D3-NMAX31)+1,:)=(/ D1,D2,D3/)
  !DIFF(ABS(D1-NMAX11)+1, ABS(D2-NMAX21)+1,ABS(D3-NMAX31)+1)=DIFF(ABS(D1-NMAX11)+1, ABS(D2-NMAX21)+1,ABS(D3-NMAX31)+1)+  ABS  (  CMPLX( SUM(CCBBT(:)*COS(2.0*PI*MATMUL(RR1(:,:),QQQ(ABS(D1-NMAX11)+1, ABS(D2-NMAX21)+1,ABS(D3-NMAX31)+1,:)))),  SUM(CCBBT(:)*SIN(2.0*PI*MATMUL(RR1(:,:),QQQ(ABS(D1-NMAX11)+1, ABS(D2-NMAX21)+1,ABS(D3-NMAX31)+1,:)))) )   )
  !DIFF(ABS(D1-NMAX11)+1, ABS(D2-NMAX21)+1,ABS(D3-NMAX31)+1,ITYP)=DIFF(ABS(D1-NMAX11)+1, ABS(D2-NMAX21)+1,ABS(D3-NMAX31)+1,ITYP)+  ABS  (  CMPLX( SUM(CCBBT(:)*COS(2.0*PI*MATMUL(RR1(N1:N2,:),QQQ(ABS(D1-NMAX11)+1, ABS(D2-NMAX21)+1,ABS(D3-NMAX31)+1,:)))),  SUM(CCBBT(:)*SIN(2.0*PI*MATMUL(RR1(N1:N2,:),QQQ(ABS(D1-NMAX11)+1, ABS(D2-NMAX21)+1,ABS(D3-NMAX31)+1,:)))) )   )
  DIFF(ABS(D1-NMAX11)+1, ABS(D2-NMAX21)+1,ABS(D3-NMAX31)+1,ITYP)=DIFF(ABS(D1-NMAX11)+1, ABS(D2-NMAX21)+1,ABS(D3-NMAX31)+1,ITYP)+  ABS  (  CMPLX( SUM(COS(2.0*PI*MATMUL(RR1(N1:N2,:),QQQ(ABS(D1-NMAX11)+1, ABS(D2-NMAX21)+1,ABS(D3-NMAX31)+1,:)))),  SUM(SIN(2.0*PI*MATMUL(RR1(N1:N2,:),QQQ(ABS(D1-NMAX11)+1, ABS(D2-NMAX21)+1,ABS(D3-NMAX31)+1,:)))) )   )
  END DO
  END DO
  END DO
!$omp end parallel do
END DO
104 FORMAT(3F10.2,2E15.5)
IF(IT==IREF2)THEN
OPEN(103,FILE="DIFFU.vasp")
WRITE(103,*)'COMMENT PROBABILITY DENSITY'
WRITE(103,*)'1.0'
WRITE(103,*)ABS(NMAX11-NMAX12)+1,'0 0 ' 
WRITE(103,*)'0', ABS(NMAX21-NMAX22)+1,'0' 
WRITE(103,*)'0 0',ABS(NMAX31-NMAX32)+1 
WRITE(103,103)'C'   
WRITE(103,*)'1'    
WRITE(103,*)'D' 
WRITE(103,*)'0 0 0'
WRITE(103,*)
WRITE(103,*)ABS(NMAX11-NMAX12)+1,ABS(NMAX21-NMAX22)+1,ABS(NMAX31-NMAX32)+1  
!WRITE(103,101)(ABS(DIFF(DK)),DK=1,MAXDIM)                 
!WRITE(103,101)(((ABS(DIFF(D1,D2,D3)),D1=0,NX),D2=0,NY),D3=0,NZ)                 
!WRITE(103,101)(((DIFF(D1,D2,D3),D1=NMAX11,NMAX12),D2=NMAX21,NMAX22),D3=NMAX31,NMAX32)                 
WRITE(103,101)  (   (  (     SUM(CBBT(1:NTYP)*DIFF(ID1,ID2,ID3,1:NTYP))   , ID1=1,ABS(NMAX11-NMAX12)+1),   ID2=1,ABS(NMAX21-NMAX22)+1),  ID3=1,ABS(NMAX31-NMAX32)+1)                 
PRINT*,'DONE DIFFUSE'
END IF
101 FORMAT(5E12.5)
IF (IT.GE.(IREF2-IREF1+1))THEN
OPEN(104,FILE='Neutron.txt')
OPEN(105,FILE='X_Ray.txt')
DO D1=1,ABS(nmax11-nmax12)+1
DO D2=1,ABS(nmax21-nmax22)+1
DO D3=1,ABS(nmax31-nmax32)+1
WRITE(104,106)INT(QQQ(D1,D2,D3,:)),SUM(DIFF(D1,D2,D3,1:NTYP)*CBBT(1:NTYP)),CBBT(1:NTYP)*DIFF(D1,D2,D3,1:NTYP)
WRITE(105,106)INT(QQQ(D1,D2,D3,:)),SUM(DIFF(D1,D2,D3,1:NTYP)*ZELE(1:NTYP)),ZELE(1:NTYP)*DIFF(D1,D2,D3,1:NTYP)
END DO
END DO
END DO
ENDIF
106 FORMAT(3I8,100E15.6)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!DEALLOCATE(QQQ)
END SUBROUTINE




SUBROUTINE VVACF5
use omp_lib
USE VARIABLES1
use ieee_arithmetic
IMPLICIT NONE
INCLUDE 'fftw3.f'
DOUBLE COMPLEX,ALLOCATABLE,DIMENSION(:,:,:)::VELC
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DIFFUSION,DIFFUSIONC,CDIFFUSION
DOUBLE PRECISION::PHASE1
INTEGER::IFOR,IBAC,ISCHEME,PLAN
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::AAAA,BBBB,HR
INTEGER::II1,I1
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DOS,DOSB   !!!!DOSB BROADENED 
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DOST,DOSTB
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DOSTBS,DOSBS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DOSTBSS
DOUBLE COMPLEX,ALLOCATABLE,DIMENSION(:,:,:)::VACFC,VACFCT,CDOS
!#DOUBLE COMPLEX,ALLOCATABLE,DIMENSION(:,:,:)::VACFCT,CDOS
DOUBLE PRECISION::TOTAL_WEIGHT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::WEIGHT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::NWPDOS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::SCALTYPE,DUMMY1,DUMMY2
DOUBLE PRECISION,DIMENSION(1000)::CV,FF

DOUBLE PRECISION::FRE,TEMP,H ,KB  ,HH   
DOUBLE PRECISION,EXTERNAL::DNBOSE1
DOUBLE PRECISION,EXTERNAL::NBOSE1
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::U2E

integer,dimension(NATOM,3)::pplan
integer::plann
DOUBLE PRECISION::BETAT,BETA1

ALLOCATE(U2E(NDOS,NTYP,3))
HH=6.626068E-26/1.66053886E-27
H=6.626069300000000159e-22   ! ORDER OF 12 LESS BECAUSE WHEN WE MULTIPLY W IT IS IN THZ
KB=1.380650500000000147e-23
!BETA1=47.99237243603648754
IF(IVACF==1)OPEN(8558,FILE='HAVEN_RATIO')
IF(IVACF==1)OPEN(8559,FILE='CROSS_DOS.DAT')
ALLOCATE(VELC(NSTEP,NATOM,3),DIFFUSION(NTYP,3),AAAA(2*NSTEP),DOS(NSTEP,NATOM,3),DOST(NSTEP,NTYP,3),DOSTB(NSTEP,NTYP,3),VACFC(NSTEP,NATOM,3),VACFCT(NSTEP,NTYP,3))
ALLOCATE(DOSB(NSTEP,NATOM,3))
ALLOCATE(DIFFUSIONC(NTYP,3))
ALLOCATE(CDIFFUSION(NTYP,3))
ALLOCATE(WEIGHT(NTYP))
ALLOCATE(NWPDOS(NSTEP,NTYP))
ALLOCATE(SCALTYPE(NTYP))
ALLOCATE(BBBB(2*NSTEP))
ALLOCATE(DOSTBS(NSTEP,NTYP),DOSBS(NSTEP,NATOM))
ALLOCATE(DOSTBSS(NSTEP))
ALLOCATE(DUMMY1(NDOS),DUMMY2(NDOS))
ALLOCATE(CDOS(NSTEP,NTYP,3))
ALLOCATE(HR(NTYP))
IFOR= 1
IBAC=-1
CDOS=0
VELC=VEL
!!!!!!!!!!!!!!!!!!!!!!!!!VACF!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
PRINT*, "I M IN VVACF5"
PRINT*,NSTEP
!PRINT*,VELC(:,1,1)


!$omp parallel do
DO I=1,NATOM
        DO J=1,3 !!!!!!!!!CARTESIAN DEGREE OF FREEDOME
        call dfftw_plan_dft_1d(pplan(I,J),NSTEP,VELC(:,I,J),VELC(:,I,J),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(pplan(I,J), VELC(:,I,J),VELC(:,I,J))
        call dfftw_destroy_plan(pplan(I,J))
        !call dfftw_plan_dft_1d(plann,NSTEP,VELC(:,I,J),VELC(:,I,J),IFOR,FFTW_ESTIMATE)
        !call dfftw_execute_dft(plann, VELC(:,I,J),VELC(:,I,J))
        !call dfftw_destroy_plan(plann)
        END DO
END DO
!$omp end parallel do
        VELC=VELC/REAL(NSTEPORIG)
!        where (VELC .ne.VELC)VELC=0
        !PRINT*,VEL(1024,:,1)
!        PRINT*,VELC(:,1,1)

        DOS= VELC*CONJG(VELC)
        DO ITYP=1,NTYP
        !N1=SUM(NNTYPE(1:ITYP-1))+1
        !N2=SUM(NNTYPE(1:ITYP))
        !PRINT*,N1,N2
        DOST(1:NSTEP,ITYP,:)=SUM(DOS(1:NSTEP,SUM(NNTYPE(1:ITYP-1))+1 : SUM(NNTYPE(1:ITYP)),:),DIM=2)/NNTYPE(ITYP)
        !DOST(1:NSTEP,ITYP,:)=SUM(DOS(1:NSTEP,N1:N2,:),DIM=2)/NNTYPE(ITYP)
        END DO
!        PRINT*,DOS(:,1,1)
VACFC=DOS
!!$omp parallel do
        DO I=1,NATOM
                DO J=1,3 !!!!!!!!!CARTESIAN DEGREE OF FREEDOME
                call dfftw_plan_dft_1d(pplan(I,J),NSTEP,VACFC(:,I,J),VACFC(:,I,J),IBAC,FFTW_ESTIMATE)
                call dfftw_execute_dft(pplan(I,J),VACFC(:,I,J),VACFC(:,I,J))
                call dfftw_destroy_plan(pplan(I,J))
              END DO
        END DO
!!$omp end parallel do
        DO I=1,NTYP
        VACFCT(:,I,:)=SUM(VACFC(:,SUM(NNTYPE(1:I-1)) +1: SUM(NNTYPE(1:I)),:)/NNTYPE(I),DIM=2)  !/NNTYPE(IITYP)
        END DO
        DO I=1,NTYP
        PRINT*, SUM((VEL(1,SUM(NNTYPE(1:I-1)) +1: SUM(NNTYPE(1:I)),:)**2)/NNTYPE(I),DIM=1)  !/NNTYPE(IITYP)
        END DO
        DO IT=1,NSTEP
        WRITE(80,80) REAL((IT-1)*DELT),(VACFCT(IT,ITYP,1:3),ITYP=1,NTYP)
        80 FORMAT(E15.5,2X,100(3(2E20.8,2x)3x)) 
        END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!CORRELATION CALCULATION!!!!!!!!!!!!!!!!!!!!!!!!!CROSS VACF



DO IT=1,NTYP
                !DO I=SUM(NNTYPE(1:IT-1))+1 ,SUM(NNTYPE(1:IT))               
                !DO J=SUM(NNTYPE(1:IT-1))+1 ,SUM(NNTYPE(1:IT))               
                !!PRINT*,IT,I,J
                !IF(I.NE.J) CDOS(:,IT,:)=CDOS(:,IT,:)+ (VELC(:,I,:)*CONJG(VELC(:,J,:)))
                !END DO
                !END DO
                !CDOS(:,IT,:)=CDOS(:,IT,:)/(NNTYPE(IT)*(NNTYPE(IT)+1)/2.0)

                !CDOS(:,IT,:)=  SUM(VELC(:,SUM(NNTYPE(1:IT-1))+1:SUM(NNTYPE(1:IT)),:),DIM=2) * CONJG(SUM(VELC(:,SUM(NNTYPE(1:IT-1))+1:SUM(NNTYPE(1:IT)),:),DIM=2))/(NNTYPE(IT)*NNTYPE(IT))
                CDOS(:,IT,:)=  (2*SUM(VELC(:,SUM(NNTYPE(1:IT-1))+1:SUM(NNTYPE(1:IT)),:),DIM=2) -SUM(VELC(:,:,:),DIM=2))*CONJG(2*SUM(VELC(:,SUM(NNTYPE(1:IT-1))+1:SUM(NNTYPE(1:IT)),:),DIM=2)- SUM(VELC(:,:,:),DIM=2))/(NNTYPE(IT))

END DO
!        DO I=1,NSTEP
!        WRITE(8559,8559)4.136*REAL((I-1)/(DELT*NSTEP)),(SUM(REAL(CDOS(I,K,:))),K=1,NTYP)
        8559 FORMAT(3F10.6,100E15.5)
!        END DO
 GOTO 234
        !$omp parallel do
        DO IT=1,NTYP
                !FOURIER STUFF        
                DO J=1,3
                call dfftw_plan_dft_1d(pplan(IT,J),NSTEP,CDOS(:,IT,J),CDOS(:,IT,J),IBAC,FFTW_ESTIMATE)
                call dfftw_execute_dft(pplan(IT,J),CDOS(:,IT,J),CDOS(:,IT,J))
                call dfftw_destroy_plan(pplan(IT,J))
                END DO
                !PRINT*,'CROSS VACF' 
                !PRINT*, 1.0E-4*DELT*SUM(CDOS(:,IT,:),DIM=1)/2.0  !/NNTYPE(IITYP)
        END DO
        !$omp end parallel do
 234  CONTINUE
        
        !        DO IT=1,NTYP
       DO I=1,NSTEP
       WRITE(8560,8559)REAL(I-1)*DELT,(SUM(REAL(CDOS(I,K,:))),K=1,NTYP)
       END DO
!        END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
PRINT*,'DIFFUSION in cm2/sec,and Haven Ratio'
DO I=1,NTYP
PRINT*, ATMNM(I)
DIFFUSION(I,1)=1.0E-4*DELT*( SUM(REAL(VACFCT(1:NSTEP/2,I,1))) - REAL(VACFCT(1,I,1))/2 - REAL(VACFCT(NSTEP/2,I,1))/2 ) !  /2  !i/(3.0*NNTYPE(I))
DIFFUSION(I,2)=1.0E-4*DELT*( SUM(REAL(VACFCT(1:NSTEP/2,I,2))) - REAL(VACFCT(1,I,2))/2 - REAL(VACFCT(NSTEP/2,I,2))/2 ) !/2 !/(3.0*NNTYPE(I))
DIFFUSION(I,3)=1.0E-4*DELT*( SUM(REAL(VACFCT(1:NSTEP/2,I,3))) - REAL(VACFCT(1,I,3))/2 - REAL(VACFCT(NSTEP/2,I,3))/2 ) !/2  !/(3.0*NNTYPE(I))
CDIFFUSION(I,1)= 1.0E-4*DELT*( SUM(REAL(CDOS(1:NSTEP/2,I,1))) - REAL(CDOS(1,I,1))/2 - REAL(CDOS(NSTEP/2,I,1))/2 ) ! /2  !i/(3.0*NNTYPE(I))
CDIFFUSION(I,2)= 1.0E-4*DELT*( SUM(REAL(CDOS(1:NSTEP/2,I,2))) - REAL(CDOS(1,I,2))/2 - REAL(CDOS(NSTEP/2,I,2))/2 ) ! !/(3.0*NNTYPE(I))
CDIFFUSION(I,3)= 1.0E-4*DELT*( SUM(REAL(CDOS(1:NSTEP/2,I,3))) - REAL(CDOS(1,I,3))/2 - REAL(CDOS(NSTEP/2,I,3))/2 ) !/2  !/(3.0*NNTYPE(I))
PRINT*,'SELF=',SUM(DIFFUSION(I,:))/3.0
!PRINT*,'CROSS=',SUM(CDIFFUSION(I,:))/3.0
62 FORMAT(3E10.3,2X,3E10.3)
!HR(I)=SUM(DIFFUSION(I,:))/(SUM(DIFFUSION(I,:))+SUM(CDIFFUSION(I,:)))
HR(I)=SUM(DIFFUSION(I,:))/SUM(CDIFFUSION(I,:))
!PRINT*,'HAVEN  RATIO',HR(I)
WRITE(8558,*)HR(I)
END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!DEFINE DELE FOR BROADENING PURPOSE

!###################################################################################
        DELW=4.136*REAL(1/(DELT*NSTEP))                                           !#
        DO I=1,NTYP                                                               !# 
        DO J=1,3                                                                  !
        DOST(:,I,J)=DOST(:,I,J)/(DELW*SUM(DOST(1:NSTEP/2,I,J)))                   !
        END DO                                                                    !
        END DO                                                                    ! 
                                                                                  !
        DO I=1,NATOM                                                              !
        DO J=1,3                                                                  !
        DOS(:,I,J)=DOS(:,I,J)/(DELW*SUM(DOS(1:NSTEP/2,I,J)))                      !
        END DO                                                                    !
        END DO                                                                    !
!###################################################################################

DELE=4.136/REAL(DELT*NSTEP)
PRINT*,'DELE in meV and No of Data points in DOS',DELE,NDOS
!PRINT*,NDOS

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!BROADENING THE DATA!!!!!!!!!!!!!!!!!!!!!!!
DO IJ=1,NTYP
DUMMY1=DOST(1:NDOS,IJ,1)
print*,'typ',IBROAD
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)

!#print*,'ityp',IJ
DOSTB(1:NDOS,IJ,1)=DUMMY2
DUMMY1=DOST(:,IJ,2)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSTB(1:NDOS,IJ,2)=DUMMY2

DUMMY1=DOST(1:NDOS,IJ,3)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSTB(1:NDOS,IJ,3)=DUMMY2
END DO
!!!!!!!!!!!!!!!!!BROADENING OF INDIVIDUAL!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
IF(INDIVIDUAL==1)THEN
DO IJ=1,NATOM
DUMMY1=DOS(1:NDOS,IJ,1)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSB(1:NDOS,IJ,1)=DUMMY2

DUMMY1=DOS(1:NDOS,IJ,2)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSB(1:NDOS,IJ,2)=DUMMY2

DUMMY1=DOS(1:NDOS,IJ,3)
IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
DOSB(1:NDOS,IJ,3)=DUMMY2
END DO
END IF

!!!!!!!!!!!!!!!!!!!!!REMOVE NEGATIVE DOS    SET TO ZERO!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
DO ITYP=1,NTYP
DO IIII=1,NDOS
IF(DOSTB(IIII,ITYP,1).LT.0)DOSTB(IIII,ITYP,1)=0
IF(DOSTB(IIII,ITYP,2).LT.0)DOSTB(IIII,ITYP,2)=0
IF(DOSTB(IIII,ITYP,3).LT.0)DOSTB(IIII,ITYP,3)=0
END DO
END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


DO ITYP=1,NTYP
ANORM1=SUM(ABS(DOSTB(1:NDOS,ITYP,1)))*DELW
ANORM2=SUM(ABS(DOSTB(1:NDOS,ITYP,2)))*DELW
ANORM3=SUM(ABS(DOSTB(1:NDOS,ITYP,3)))*DELW
PRINT*,ANORM1,ANORM2,ANORM3

DOSTB(:,ITYP,1)=DOSTB(:,ITYP,1)/ANORM1
DOSTB(:,ITYP,2)=DOSTB(:,ITYP,2)/ANORM1
DOSTB(:,ITYP,3)=DOSTB(:,ITYP,3)/ANORM1
DOSTBS(:,ITYP)=(DOSTB(:,ITYP,1)+DOSTB(:,ITYP,2)+DOSTB(:,ITYP,3))/3.0
END DO
DO ITYP=1,NATOM
ANORM1=SUM(ABS(DOSB(1:NDOS,ITYP,1)))*DELW
ANORM2=SUM(ABS(DOSB(1:NDOS,ITYP,2)))*DELW
ANORM3=SUM(ABS(DOSB(1:NDOS,ITYP,3)))*DELW
DOSB(:,ITYP,1)=DOSB(:,ITYP,1)/ANORM1
DOSB(:,ITYP,2)=DOSB(:,ITYP,2)/ANORM1
DOSB(:,ITYP,3)=DOSB(:,ITYP,3)/ANORM1
DOSBS(:,ITYP)=(DOSB(:,ITYP,1)+DOSB(:,ITYP,2)+DOSB(:,ITYP,3))/3.0
END DO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        DO IT=1,NDOS
        OMEGA=4.136*REAL((IT-1)/(DELT*NSTEP))
        DOSTBSS(IT)=SUM(DOSTBS(IT,:)*NNTYPE(:))/(SUM(NNTYPE(:)))
        WRITE(81,81) OMEGA,(DOSTB(IT,ITYP,:),ITYP=1,NTYP)
        WRITE(82,81) OMEGA,(NNTYPE(ITYP)*DOSTBS(IT,ITYP)/(SUM(NNTYPE)),ITYP=1,NTYP),DOSTBSS(IT)
        !WRITE(821,81) OMEGA,(DOSBS(IT,ITYP),ITYP=1,NATOM)
        81 FORMAT(E15.5,2X,10000(3E20.8,2x)) 
        END DO
        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        !!!!!!!!!!!!!!!!!!!NEUTRON WEIGHTED DOS!!!!!!!!!!!!!!!
PRINT*, ' I AM IN NEUTRON'
WEIGHT=NNTYPE*BBT2/MASST
TOTAL_WEIGHT=SUM(WEIGHT) 
PRINT*,'WEIGHT'
PRINT*, WEIGHT
NWPDOS=0
DO I=1,NDOS  !NSTEP
OMEGA=4.136*REAL((I-1)/(DELT*NSTEP))
        DO IJ=1,NTYP
        NWPDOS(I,IJ)=NWPDOS(I,IJ) +  (WEIGHT(IJ)*SUM(DOSTB(I,IJ,:))/(3.0*TOTAL_WEIGHT))
        END DO
WRITE(85,8)OMEGA,(NWPDOS(I,IJ),IJ=1,NTYP),(SUM(NWPDOS(I,1:NTYP)))
8 FORMAT(F10.4,1000E15.5)
!PRINT*,I
END DO

!!!!!!!!!!!!!!CALCULATE SPECIFIC HEAT!!!!!!!!!!
J=0
CV=0
DO TEMP=10,1000,10
J=J+1
DO I=1,NDOS
  FRE=REAL((I-1)/(DELT*NSTEP))
!  CV(J)= CV(J)+ 3*H*FRE*DOSTBSS(I)*(DNBOSE1(FRE,TEMP))*DELW* 6.023E23
  CV(J)= CV(J)+ H*FRE*DOSTBSS(I)*(DNBOSE1(FRE,TEMP))*DELW/KB !* 6.023E23
END DO
WRITE(86,86)TEMP,CV(J)
86 FORMAT(F10.5,3E15.5)
END DO
!/(V0*0.14824687E-30)



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!MSD FROM DOS UNDER HARMONIC  !APPROXIMATION!!!!!!!!!!!!!!!!!!!!!
OPEN(1002,FILE="U2EXYZ")
OPEN(1003,FILE="U2E")
OPEN(87,FILE="FREE_ENERGY")
DO I=1,NDOS  !POINTS
OMEGA=REAL((I-1)/(DELT*NSTEP))
FRE=OMEGA 
        DO J=1,NTYP
        U2e(I,J,:)=(NBOSE1(FRE,TEMPERATURE) +0.5)*HH*DOSTB(I,J,:)/(4*PI*PI*MASST(J)*4.136*FRE)
        END DO
IF(OMEGA.GE.0.001)WRITE(1002,2)4.136*OMEGA,(U2E(I,J,1:3),J=1,NTYP)
IF(OMEGA.GE.0.001)WRITE(1003,2)4.136*OMEGA,(SUM(U2E(I,J,1:3)),J=1,NTYP)
2 FORMAT(100F20.10)
ENDDO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

!!!!!!!!!!!CALCULATE FREE-ENERGY!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

BETA1=47.99237243603648754
J=0
FF=0
DO TEMP=10,1000,10
BETAT=BETA1/REAL(TEMP) !TT
J=J+1
  DO I=1,NDOS
  FRE=REAL((I-1)/(DELT*NSTEP))
  IF(FRE.NE.0)FF(J)=FF(J) + ( 0.5*H*FRE + KB*TEMP*(DLOG(1-DEXP(-BETAT*FRE)))  )*DOSTBSS(I)
  END DO
  WRITE(87,87)TEMP,FF(J)
  87 FORMAT(F10.5,3E15.5)

END DO


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
CLOSE(1002)
CLOSE(1003)
CLOSE(87)
PRINT*,' I M HERE'
        DEALLOCATE(VELC,DIFFUSION,DOS,DOST,DOSTB,VACFC) 
        DEALLOCATE(NWPDOS,WEIGHT)
END SUBROUTINE        


SUBROUTINE IIFQT3N(IQQQQ)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::FQT,FFQTTYP!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::CFFQTTYP !,SQWB
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
REAL,DIMENSION(NSTEP)::PHASE1
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::II1,I1,DT1,III
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DUMMY2,DUMMY4
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMYT
DOUBLE PRECISION::EE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK
INTEGER::ITYPPP,JTYPPP
INTEGER::IQQQQ,NNN2
CHARACTER::AA*9
INTEGER::NTYP2
INTEGER::IJ1,IJ2
INTEGER::IQTCAL
integer,allocatable,dimension(:)::plan
integer::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
IQTCAL=0         !!!!DO  NOT CALCLATE FQT
NTYP2=NTYP*(NTYP+1)/2
PRINT*,NTYP2
WRITE(AA,'("CSQWTOT",I2.2)')IQQQQ
OPEN(170,FILE=AA)
WRITE(AA,'("ISQWTOT",I2.2)')IQQQQ
OPEN(180,FILE=AA)
IF(IQTCAL==1)WRITE(AA,'("CIQTTOT",I2.2)')IQQQQ
IF(IQTCAL==1)OPEN(190,FILE=AA)
IF(IQTCAL==1)WRITE(AA,'("IIQTTOT",I2.2)')IQQQQ
IF(IQTCAL==1)OPEN(200,FILE=AA)
!OPEN(17,FILE="CSQ")
!OPEN(18,FILE="ISQ")
!IF(IQTCAL==1) OPEN(19,FILE="CIQ")
!IF(IQTCAL==1)OPEN(20,FILE="IIQ")
PRINT*,'I AM IN IFFQT'
ALLOCATE(FQT(1:NSTEP,NATOM))
ALLOCATE(FFQTTYP(1:NSTEP,NTYP))
ALLOCATE(CFFQTTYP(1:NSTEP,NTYP,NTYP))
allocate(plan(NATOM))
FQT=0
FFQTTYP=0
CFFQTTYP=0
IFOR= 1
IBAC=-1
PRINT*,AVGISLAT
PRINT*,NTYP
IF(ILIST.NE.3)THEN
WRITE(AA,'("KKLIST",I2.2)')IQQQQ
OPEN(44,FILE=AA)
I=0
DO  
I=I+1 
READ(44,*,END=100)KLIST(I,:)
END DO
100 CONTINUE
NQ=I-1
I=0
PRINT*,'NQ',NQ
ALLOCATE(QQ(NQ,3),QK(NQ,3))
ALLOCATE(DUMMY2(NQ,NTYP2+1,NSTEP),DUMMY4(NQ,NTYP2+1,NSTEP))
END IF
IF(ILIST.EQ.3)THEN
NQ=IQQQQ 
PRINT*,KLIST(NQ,:)
ALLOCATE(QQ(NQ,3),QK(NQ,3))
ALLOCATE(DUMMY2(NQ,NTYP2+1,NSTEP),DUMMY4(NQ,NTYP2+1,NSTEP))
END IF
ALLOCATE(DUMMYT(NSTEP),KSELF(NTYP))
PRINT*,'NSTEP',NSTEP
	FFQTTYP=0
	CFFQTTYP=0
DO IQ=1,NQ
	PRINT*,'IQ=',IQ
	QQ(IQ,:)=KLIST(IQ,:) !VEC
	IF(ICARTESIAN==1)THEN
        KVEC=KLIST(IQ,:)
        ELSE
        !KVEC=2.0*PI*MATMUL(KLIST(IQ,:),AVGISLAT)        !CHANGED AVGISLAT TO ISLAT
        KVEC=2.0*PI*MATMUL(AVGISLAT,KLIST(IQ,:))        !CHANGED AVGISLAT TO ISLAT
        END IF
	QK(IQ,:)=KVEC
        DO I=1,NATOM
		!$omp parallel do
        	DO IT=1,NSTEPORIG  
                PHASE1(IT)=DOT_PRODUCT(KVEC,POS(IT,I,:))
                FQT(IT,I)=CMPLX(COS(PHASE1(IT)),SIN(PHASE1(IT)))
                END DO
		!$omp end parallel do
        call dfftw_plan_dft_1d(plann,NSTEP,FQT(:,I),FQT(:,I),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, FQT(:,I),FQT(:,I))
        call dfftw_destroy_plan(plann)
        FQT(:,I)=FQT(:,I)/REAL(NSTEPORIG)
        END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!INCOHERENT CALCULATION 
!IF (ICOH==0.OR.ICOH==3)THEN               !INCOHRENT CASE
PRINT*,'I AM IN INCOHERENT'
        DO ITYPPP=1,NTYP
        FFQTTYP(1:NSTEP,ITYPPP)=FFQTTYP(1:NSTEP,ITYPPP) +  SUM(FQT(1:NSTEP, SUM(NNTYPE(1:ITYPPP-1))+1 : SUM(NNTYPE(1:ITYPPP))) * CONJG(FQT(1:NSTEP, SUM(NNTYPE(1:ITYPPP-1))+1 : SUM(NNTYPE(1:ITYPPP)))),DIM=2 )
        END DO
        !####!SQW SQW SQW SQW SQW SQW SQW SQW SQW SQW SQW SQWS SQWS SQW 
	!DO DT=1,NSTEP
	!WRITE(18,15)REAL(DT)*DELT,REAL(FFQTTYP(DT,1:NTYP))  ,SUM(REAL(FFQTTYP(DT,:))) , SUM(AIMAG(FFQTTYP(DT,:))) !/REAL(FFQTTYP(1,:)) !,SUM(REAL(FFQTTYP(DT,1:NTYP)))/SUM(REAL(FFQTTYP(1,1:NTYP))) !NATOM
	!END DO
	IF(IQTCAL==1)THEN
	!######IQT IQT IQT IQT!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	DO I=1,NTYP
        call dfftw_plan_dft_1d(plan(i),NSTEP,FFQTTYP(:,I),FFQTTYP(:,I),IBAC,FFTW_ESTIMATE)
        call dfftw_execute_dft(plan(i), FFQTTYP(:,I),FFQTTYP(:,I))
        call dfftw_destroy_plan(plan(i))
        FFQTTYP(:,I)=FFQTTYP(:,I)/REAL(NSTEPORIG)
	END DO
		!DO DT=1,NSTEP	
		!WRITE(20,15)REAL(DT)*DELT,REAL(FFQTTYP(DT,1:NTYP)) !/(REAL(FFQTTYP(1,:))) !,(SUM(REAL(FFQT(DT,:))))/SUM(REAL(FFQT(1,:)))
		!END DO
        END IF

!END IF
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!COHERENT CASE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!        IF (ICOH==1.or.ICOH==3)THEN               !COHRENT CASE
	PRINT*,'I AM IN COHERENT'
	!$omp parallel do
        DO ITYPPP=1,NTYP
        DO JTYPPP=1,NTYP
        DO I=SUM(NNTYPE(1:ITYPPP-1))+1,SUM(NNTYPE(1:ITYPPP)) !NATOM
!        DO J=SUM(NNTYPE(1:JTYPPP-1))+1,SUM(NNTYPE(1:JTYPPP)) !NATOM
	!CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP)=CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP) +   FQT(1:NSTEP,I) * CONJG(FQT(1:NSTEP, J) )
	CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP)=CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP) +   FQT(1:NSTEP,I) *   CONJG(SUM(FQT(1:NSTEP,SUM(NNTYPE(1:JTYPPP-1))+1 : SUM(NNTYPE(1:JTYPPP))),DIM=2 ) )
!	END DO
        END DO
        END DO
        END DO
	!$omp end parallel do
	!SQW SQW SQW SQW SQW SQW SQW 
	!IQT IQT IQT IQT IQT IQT IQT 
IF( IQTCAL==1)THEN
!	!$omp parallel do
	DO I=1,NTYP  !*(NTYP+1)/2
	 DO J=I,NTYP  !*(NTYP+1)/2
        	call dfftw_plan_dft_1d(plan(j),NSTEP,CFFQTTYP(:,I,J),CFFQTTYP(:,I,J),IBAC,FFTW_ESTIMATE)
	        call dfftw_execute_dft(plan(j), CFFQTTYP(:,I,J),CFFQTTYP(:,I,J))
	        call dfftw_destroy_plan(plan(j))
		CFFQTTYP(:,I,J)=CFFQTTYP(:,I,J)/REAL(NSTEPORIG) !CMPLX(AAA(I,1:2*NSTEP:2),AAA(I,2:2*NSTEP:2))
	 END DO
        END DO
!	!$omp end parallel do
END IF
!END IF
END DO    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!QLOOP ENDS
!REWIND(17)
!REWIND(18)
!REWIND(19)
!REWIND(20)

!IF(ICOH==0.OR.ICOH==3)THEN
	DO DT=1,NSTEP
	OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
	WRITE(180,15)OMEGA,REAL(FFQTTYP(DT,1:NTYP)),REAL(SUM(FFQTTYP(DT,:))) !   ( SUM(DUMMY2(1:NQ,ITYP,DT)) / NQ   ,ITYP=1,NTYP+1) !,SUM(DUMMY2(1:NQ,:,DT))/NQ
!	IF(IQTCAL==1)WRITE(200,15)REAL(DT-1)*DELT,((SUM(DUMMY4(1:NQ,ITYP,DT))/NQ ),ITYP=1,NTYP+1) !,SUM(DUMMY4(1:NQ,:,DT))/NQ
	END DO
!END IF

!IF(ICOH==1.OR.ICOH==3)THEN
	DO DT=1,NSTEP
	OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
	!WRITE(170,15)OMEGA,( ( REAL(CFFQTTYP(DT,IJ1,IJ2)) , IJ2=IJ1,NTYP ),IJ1=1,NTYP) ,REAL(SUM(CFFQTTYP(DT,:,:))) !                  (  SUM(DUMMY2(1:NQ,ITYP,DT) )/NQ,ITYP=1,NTYP2),DUMMYT(DT) 
	WRITE(170,15)OMEGA,( ( REAL(CFFQTTYP(DT,IJ1,IJ2)) , IJ2=1,NTYP ),IJ1=1,NTYP) ,REAL(SUM(CFFQTTYP(DT,:,:))) !                  (  SUM(DUMMY2(1:NQ,ITYP,DT) )/NQ,ITYP=1,NTYP2),DUMMYT(DT) 
	END DO


!END IF
	17 FORMAT(A12,2X,3F10.5)
        15 FORMAT(F15.4,1003E20.4)
	170 FORMAT(A12,100(3X,3F6.2,3X))
	172 FORMAT(A12,<NQ>(3X,3F6.2,3X),6X,'AVG OVER Q')
	171 FORMAT(A3,12X,<NTYP>(8X,'avg',A3,10X) )
	173 FORMAT(A3,12X,<NTYP2>(8X,'avg',2A3,10X) )
CLOSE(170)
CLOSE(180)
CLOSE(190)
CLOSE(200)
CLOSE(17)
CLOSE(18)
CLOSE(19)
CLOSE(20)
CLOSE(44)
!DEALLOCATE(FQT,FFQTTYP,CFFQTTYP,DUMMY1,DUMMY2,DUMMY3,DUMMY4, AAA)
!DEALLOCATE(FQT,FFQT,AAA)
END SUBROUTINE

SUBROUTINE DIFFUSE2022  !(IIREF)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::NX,NY,NZ !,IIREF
INTEGER::I1,I2,ID1,ID2,ID3
INTEGER,DIMENSION(NTYP)::NNN1,NNN2
!COMPLEX,DIMENSION(IQMAX,NSTEP/INTERVAL)::DUMMY

!$ call omp_set_num_threads(num_threads)
!DUMMY=0
102 FORMAT(3F20.15)
103 FORMAT(10A3)
!!!!!!!!!!!!!!!!!!!!!!THINKING OF DIFFUSE SCATTERING!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
DO IT=1,IREF2-IREF1+1,INTERVAL
!QQQ2=MATMUL(ISLAT,QQQ2)
!QQQ2=MATMUL(QQQ2,ISLAT)
QQQ2=MATMUL(ISLAT,QQQ2)
PRINT*,'Diffuse IT',IT
!$OMP PARALLEL DO 
DO ITYP=1,NTYP
NNN1(ITYP)=SUM(NNTYPE(1:ITYP-1))+1
NNN2(ITYP)=SUM(NNTYPE(1:ITYP))
DIFF2T(:,ITYP)=DIFF2T(:,ITYP) +  (  CMPLX( SUM( COS(2.0*PI*MATMUL(POS(IT,NNN1(ITYP):NNN2(ITYP),:) ,  QQQ2)),DIM=1),SUM(SIN(2.0*PI*MATMUL( POS(IT,NNN1(ITYP):NNN2(ITYP),:),QQQ2)),DIM=1)   ) )
END DO
!$OMP END PARALLEL DO


        QQQ2=MATMUL(SLAT,QQQ2)
        OPEN(104,FILE='Neutron.txt')
        OPEN(105,FILE='X_Ray.txt')
        OPEN(106,FILE='Unweighted')
        WRITE(104,*)'#',IT
        WRITE(105,*)'#',IT
        WRITE(106,*)'#',IT
        DO ID1=1,IQMAX !ABS(nmax11-nmax12)+1 * ABS(nmax21-nmax22)+1 *  ABS(nmax31-nmax32)+1
        WRITE(104,106)NINT(QQQ2(:,ID1)), ABS(SUM(BBT(1:NTYP)*DIFF2T(ID1,1:NTYP)))**2 /(NSTEP/INTERVAL + 1) , ABS(BBT(1:NTYP)*DIFF2T(ID1,1:NTYP))**2/(NSTEP/INTERVAL +1)
        WRITE(105,106)NINT(QQQ2(:,ID1)), ABS(SUM( ZELE(1:NTYP)*DIFF2T(ID1,1:NTYP)))**2/(NSTEP/INTERVAL +1), ABS(ZELE(1:NTYP)*DIFF2T(ID1,1:NTYP))**2/(NSTEP/INTERVAL +1 )
        WRITE(106,106)NINT(QQQ2(:,ID1)), ABS(SUM(DIFF2T(ID1,1:NTYP)))**2/(NSTEP/INTERVAL +1),ABS(DIFF2T(ID1,1:NTYP))**2 /(NSTEP/INTERVAL +1)
        END DO
        CLOSE(104)
        CLOSE(105)
        CLOSE(106)

END DO




104 FORMAT(3F10.2,2E15.5)

!DUMMY(:,IT/INTERVAL)=(  CMPLX( SUM( COS(2.0*PI*MATMUL(POS(IT,N1:N2,:) ,  QQQ2)),DIM=1),SUM(SIN(2.0*PI*MATMUL( POS(IT,N1:N2,:),QQQ2)),DIM=1)   ) )
!DIFF2T(:,ITYP)=SUM(DUMMY,DIM=2)
!END DO
!PRINT*,BBT(1:NTYP)
!IF(IT.GE.IREF2-IREF1-INTERVAL+1)THEN
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

OPEN(101,FILE="UNWEIGHTED.vasp")
WRITE(101,*)'COMMENT PROBABILITY DENSITY'
WRITE(101,*)'1.0'
WRITE(101,*)ABS(NMAX11-NMAX12)+1,'0 0 ' 
WRITE(101,*)'0', ABS(NMAX21-NMAX22)+1,'0' 
WRITE(101,*)'0 0',ABS(NMAX31-NMAX32)+1 
WRITE(101,103)'C'   
WRITE(101,*)'1'    
WRITE(101,*)'D' 
WRITE(101,*)'0 0 0'
WRITE(101,*)
WRITE(101,*)ABS(NMAX11-NMAX12)+1,ABS(NMAX21-NMAX22)+1,ABS(NMAX31-NMAX32)+1  
WRITE(101,101)    (   ABS(DIFF2T(ID1,1:NTYP)) , ID1=1, IQMAX )                 


OPEN(102,FILE="NEUTRON.vasp")
WRITE(102,*)'COMMENT PROBABILITY DENSITY'
WRITE(102,*)'1.0'
WRITE(102,*)ABS(NMAX11-NMAX12)+1,'0 0 ' 
WRITE(102,*)'0', ABS(NMAX21-NMAX22)+1,'0' 
WRITE(102,*)'0 0',ABS(NMAX31-NMAX32)+1 
WRITE(102,103)'C'   
WRITE(102,*)'1'    
WRITE(102,*)'D' 
WRITE(102,*)'0 0 0'
WRITE(102,*)
WRITE(102,*)ABS(NMAX11-NMAX12)+1,ABS(NMAX21-NMAX22)+1,ABS(NMAX31-NMAX32)+1  
WRITE(102,101)    (   ABS(DOT_PRODUCT(BBT(1:NTYP), DIFF2T(ID1,1:NTYP))) , ID1=1, IQMAX )


OPEN(103,FILE="X_RAY.vasp")
WRITE(103,*)'COMMENT PROBABILITY DENSITY'
WRITE(103,*)'1.0'
WRITE(103,*)ABS(NMAX11-NMAX12)+1,'0 0 ' 
WRITE(103,*)'0', ABS(NMAX21-NMAX22)+1,'0' 
WRITE(103,*)'0 0',ABS(NMAX31-NMAX32)+1 
WRITE(103,103)'C'   
WRITE(103,*)'1'    
WRITE(103,*)'D' 
WRITE(103,*)'0 0 0'
WRITE(103,*)
WRITE(103,*)ABS(NMAX11-NMAX12)+1,ABS(NMAX21-NMAX22)+1,ABS(NMAX31-NMAX32)+1  
WRITE(103,101)    (   ABS(DOT_PRODUCT(ZELE(1:NTYP), DIFF2T(ID1,1:NTYP))) , ID1=1, IQMAX )


101 FORMAT(5E12.5)



!
!
!ENDIF
106 FORMAT(3I8,100E15.6)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!DEALLOCATE(QQQ2)
END SUBROUTINE
!
SUBROUTINE PARALLEL_DIFFUSE2022  !(IIREF)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::NX,NY,NZ !,IIREF
INTEGER::I1,I2,ID1,ID2,ID3
INTEGER,DIMENSION(NTYP)::NNN1,NNN2
102 FORMAT(3F20.15)
103 FORMAT(10A3)
!!!!!!!!!!!!!!!!!!!!!!THINKING OF DIFFUSE SCATTERING!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
COMPLEX,DIMENSION(IQMAX)::DIFF2TEMP
QQQ2=MATMUL(ISLAT,QQQ2)
!QQQ2=MATMUL(QQQ2,ISLAT)
!QQQ2=MATMUL(QQQ2,ISLAT)



DO ITYP=1,NTYP
NNN1(ITYP)=SUM(NNTYPE(1:ITYP-1))+1
NNN2(ITYP)=SUM(NNTYPE(1:ITYP))
!PRINT*,N1,N2



!$omp parallel private(DIFF2TEMP) shared(DIFF2T,POS)
DIFF2TEMP=0
!$omp do
 DO IT=1,IREF2-IREF1+1,INTERVAL
 PRINT*,'Diffuse IT',IT
 !DIFF2T(:,ITYP)=DIFF2T(:,ITYP) +  (  CMPLX( SUM( COS(2.0*PI*MATMUL(POS(IT,NNN1(ITYP):NNN2(ITYP),:) ,  QQQ2)),DIM=1),SUM(SIN(2.0*PI*MATMUL( POS(IT,NNN1(ITYP):NNN2(ITYP),:),QQQ2)),DIM=1)   ) )
 DIFF2TEMP=DIFF2TEMP +  (  CMPLX( SUM( COS(2.0*PI*MATMUL(POS(IT,NNN1(ITYP):NNN2(ITYP),:) ,  QQQ2)),DIM=1),SUM(SIN(2.0*PI*MATMUL( POS(IT,NNN1(ITYP):NNN2(ITYP),:),QQQ2)),DIM=1)   ) )
 END DO
!$omp end do
!$omp critical
DIFF2T(:,ITYP)=DIFF2T(:,ITYP)+DIFF2TEMP
!$omp end critical
!$omp end parallel
END DO



104 FORMAT(3F10.2,2E15.5)
QQQ2=MATMUL(SLAT,QQQ2)

!DUMMY(:,IT/INTERVAL)=(  CMPLX( SUM( COS(2.0*PI*MATMUL(POS(IT,N1:N2,:) ,  QQQ2)),DIM=1),SUM(SIN(2.0*PI*MATMUL( POS(IT,N1:N2,:),QQQ2)),DIM=1)   ) )
!DIFF2T(:,ITYP)=SUM(DUMMY,DIM=2)
!END DO
!PRINT*,BBT(1:NTYP)
!IF(IT.GE.IREF2-IREF1-INTERVAL+1)THEN
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

OPEN(101,FILE="UNWEIGHTED.vasp")
WRITE(101,*)'COMMENT PROBABILITY DENSITY'
WRITE(101,*)'1.0'
WRITE(101,*)ABS(NMAX11-NMAX12)+1,'0 0 ' 
WRITE(101,*)'0', ABS(NMAX21-NMAX22)+1,'0' 
WRITE(101,*)'0 0',ABS(NMAX31-NMAX32)+1 
WRITE(101,103)'C'   
WRITE(101,*)'1'    
WRITE(101,*)'D' 
WRITE(101,*)'0 0 0'
WRITE(101,*)
WRITE(101,*)ABS(NMAX11-NMAX12)+1,ABS(NMAX21-NMAX22)+1,ABS(NMAX31-NMAX32)+1  
WRITE(101,101)    (   ABS(DIFF2T(ID1,1:NTYP)) , ID1=1, IQMAX )                 


OPEN(102,FILE="NEUTRON.vasp")
WRITE(102,*)'COMMENT PROBABILITY DENSITY'
WRITE(102,*)'1.0'
WRITE(102,*)ABS(NMAX11-NMAX12)+1,'0 0 ' 
WRITE(102,*)'0', ABS(NMAX21-NMAX22)+1,'0' 
WRITE(102,*)'0 0',ABS(NMAX31-NMAX32)+1 
WRITE(102,103)'C'   
WRITE(102,*)'1'    
WRITE(102,*)'D' 
WRITE(102,*)'0 0 0'
WRITE(102,*)
WRITE(102,*)ABS(NMAX11-NMAX12)+1,ABS(NMAX21-NMAX22)+1,ABS(NMAX31-NMAX32)+1  
WRITE(102,101)    (   ABS(DOT_PRODUCT(BBT(1:NTYP), DIFF2T(ID1,1:NTYP))) , ID1=1, IQMAX )


OPEN(103,FILE="X_RAY.vasp")
WRITE(103,*)'COMMENT PROBABILITY DENSITY'
WRITE(103,*)'1.0'
WRITE(103,*)ABS(NMAX11-NMAX12)+1,'0 0 ' 
WRITE(103,*)'0', ABS(NMAX21-NMAX22)+1,'0' 
WRITE(103,*)'0 0',ABS(NMAX31-NMAX32)+1 
WRITE(103,103)'C'   
WRITE(103,*)'1'    
WRITE(103,*)'D' 
WRITE(103,*)'0 0 0'
WRITE(103,*)
WRITE(103,*)ABS(NMAX11-NMAX12)+1,ABS(NMAX21-NMAX22)+1,ABS(NMAX31-NMAX32)+1  
WRITE(103,101)    (   ABS(DOT_PRODUCT(ZELE(1:NTYP), DIFF2T(ID1,1:NTYP))) , ID1=1, IQMAX )


101 FORMAT(5E12.5)
OPEN(104,FILE='Neutron.txt')
OPEN(105,FILE='X_Ray.txt')
OPEN(106,FILE='Unweighted')
DO ID1=1,IQMAX !ABS(nmax11-nmax12)+1 * ABS(nmax21-nmax22)+1 *  ABS(nmax31-nmax32)+1
WRITE(104,106)NINT(QQQ2(:,ID1)), ABS(SUM(BBT(1:NTYP)*DIFF2T(ID1,1:NTYP))), ABS(BBT(1:NTYP)*DIFF2T(ID1,1:NTYP))
WRITE(105,106)NINT(QQQ2(:,ID1)), ABS(SUM( ZELE(1:NTYP)*DIFF2T(ID1,1:NTYP))), ABS(ZELE(1:NTYP)*DIFF2T(ID1,1:NTYP))
WRITE(106,106)NINT(QQQ2(:,ID1)), ABS(SUM(DIFF2T(ID1,1:NTYP))),ABS(DIFF2T(ID1,1:NTYP))
END DO




!
!
!ENDIF
106 FORMAT(3I8,100E15.6)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!DEALLOCATE(QQQ2)
END SUBROUTINE
!





!###########################################################################################
SUBROUTINE NEWDIFFUSE2021  !(IIREF)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::NX,NY,NZ !,IIREF
INTEGER::I1,I2
INTEGER::D1,D2,D3,DK,MAXDIM,NMAX
integer::id1,id2,id3
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::RRR
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::RHO
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::TRHO
DOUBLE PRECISION::DRSTEP
COMPLEX,ALLOCATABLE,DIMENSION(:,:)::ADIFF2T
INTEGER::IPOINT
INTEGER::IR1,IR2,IR3,IRMAX
!COMPLEX,ALLOCATABLE,DIMENSION(:,:)::TEMP !ADIFF2T

ALLOCATE(ADIFF2T(IQMAX,NTYP))
DO ITYP=1,NTYP 
N1=SUM(NNTYPE(1:ITYP-1))+1
N2=SUM(NNTYPE(1:ITYP)) 
END DO
102 FORMAT(3F20.15)
103 FORMAT(10A3)
!!!!!!!!!!!!!!!!!!!!!!THINKING OF DIFFUSE SCATTERING!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
QQQ2=MATMUL(ISLAT,QQQ2)
IPOINT=0
DO IT=1,IREF2-IREF1+1,INTERVAL
	PRINT*,'Diffuse2 IT',IT
	IPOINT=IPOINT+1
	RR1=RR1+POS(IT,:,:)

        DO ITYP=1,NTYP
	N1=SUM(NNTYPE(1:ITYP-1))+1
	N2=SUM(NNTYPE(1:ITYP))
        ADIFF2T=0
        !$omp do  
        DO D1=1,IQMAX
	ADIFF2T(D1,ITYP)=ADIFF2T(D1,ITYP)+    CMPLX( SUM(COS(2.0*PI*MATMUL(POS(IT,N1:N2,:),QQQ2(:,D1)))),  SUM(SIN(2.0*PI*MATMUL(POS(IT,N1:N2,:),QQQ2(:,D1)))) )   
	!DIFF2T(D1,ITYP)=DIFF2T(D1,ITYP)+    CMPLX( SUM(COS(2.0*PI*MATMUL(POS(IT,N1:N2,:),QQQ2(:,D1)))),  SUM(SIN(2.0*PI*MATMUL(POS(IT,N1:N2,:),QQQ2(:,D1)))) )   
	END DO
        !$omp end do
        !$omp atomic
        DIFF2T(D1,ITYP)=DIFF2T(D1,ITYP)+ADIFF2T(D1,ITYP)
        END DO
END DO

ADIFF2T=0  !!!!RESET to zero
DIFF2T=DIFF2T/(NATOM*IPOINT)
RR1=RR1/IPOINT



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!AVERAGESTRUTUE!!!!!!!!!!!!!!!!!!!!!!!!!!SQSQSQSQSQQSQ
PRINT*,'Average Diffuse' 
DO ITYP=1,NTYP
	N1=SUM(NNTYPE(1:ITYP-1))+1
	N2=SUM(NNTYPE(1:ITYP))
	!$omp parallel do
	DO D1=1,IQMAX
	ADIFF2T(D1,ITYP)=CMPLX( SUM(COS(2.0*PI*MATMUL(RR1(N1:N2,:),QQQ2(:,D1)))),  SUM(SIN(2.0*PI*MATMUL(RR1(N1:N2,:),QQQ2(:,D1)))) )
	END DO
	!$omp end parallel do
END DO
ADIFF2T=ADIFF2T/NATOM
104 FORMAT(3F10.2,2E15.5)


!WRITING SQ!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!1
OPEN(101,FILE="Unweighted.vasp")
WRITE(101,*)'COMMENT PROBABILITY DENSITY'
WRITE(101,*)'1.0'
WRITE(101,*)ABS(NMAX11-NMAX12)+1,'0 0 ' 
WRITE(101,*)'0', ABS(NMAX21-NMAX22)+1,'0' 
WRITE(101,*)'0 0',ABS(NMAX31-NMAX32)+1 
WRITE(101,103)'C'   
WRITE(101,*)'1'    
WRITE(101,*)'D' 
WRITE(101,*)'0 0 0'
WRITE(101,*)
WRITE(101,*)ABS(NMAX11-NMAX12)/DN1 +1, ABS(NMAX21-NMAX22)/DN2 +1,ABS(NMAX31-NMAX32)/DN3 +1  
WRITE(101,101)  ( ABS(SUM(DIFF2T(ID1,1:NTYP)))   , ID1=1,IQMAX              )
PRINT*,'DONE DIFFUSE'
OPEN(102,FILE="NEUTRON.vasp")
WRITE(102,*)'COMMENT PROBABILITY DENSITY'
WRITE(102,*)'1.0'
WRITE(102,*)ABS(NMAX11-NMAX12)+1,'0 0 ' 
WRITE(102,*)'0', ABS(NMAX21-NMAX22)+1,'0' 
WRITE(102,*)'0 0',ABS(NMAX31-NMAX32)+1 
WRITE(102,103)'C'   
WRITE(102,*)'1'    
WRITE(102,*)'D' 
WRITE(102,*)'0 0 0'
WRITE(102,*)
WRITE(102,*)ABS(NMAX11-NMAX12)/DN1 +1,ABS(NMAX21-NMAX22)/DN2 +1,ABS(NMAX31-NMAX32)/DN3 +1  
WRITE(102,101)  (   ABS(SUM(BBT(1:NTYP)*DIFF2T(ID1,1:NTYP)))   , ID1=1,IQMAX)                 
PRINT*,'DONE DIFFUSE'
OPEN(103,FILE="X_RAY.vasp")
WRITE(103,*)'COMMENT PROBABILITY DENSITY'
WRITE(103,*)'1.0'
WRITE(103,*)ABS(NMAX11-NMAX12)+1,'0 0 ' 
WRITE(103,*)'0', ABS(NMAX21-NMAX22)+1,'0' 
WRITE(103,*)'0 0',ABS(NMAX31-NMAX32)+1 
WRITE(103,103)'C'   
WRITE(103,*)'1'    
WRITE(103,*)'D' 
WRITE(103,*)'0 0 0'
WRITE(103,*)
WRITE(103,*)ABS(NMAX11-NMAX12)/DN1 +1,ABS(NMAX21-NMAX22)/DN2 +1,ABS(NMAX31-NMAX32)/DN3 +1  
WRITE(103,101)  (  ABS(SUM(ZELE(1:NTYP)*DIFF2T(ID1,1:NTYP)))  , ID1=1,IQMAX)                 
PRINT*,'DONE DIFFUSE'
101 FORMAT(5E12.5)
OPEN(104,FILE='Neutron.txt')
OPEN(105,FILE='X_Ray.txt')
OPEN(106,FILE='Unweighted.txt')
OPEN(107,FILE='Patterson.txt')

DO D1=1,IQMAX
WRITE(104,106)INT(MATMUL(SLAT,QQQ2(:,D1))),ABS(SUM(DIFF2T(D1,1:NTYP)*BBT(1:NTYP))),ABS(BBT(1:NTYP)*DIFF2T(D1,1:NTYP))
WRITE(105,106)INT(MATMUL(SLAT,QQQ2(:,D1))),ABS(SUM(DIFF2T(D1,1:NTYP)*ZELE(1:NTYP))),ABS(ZELE(1:NTYP)*DIFF2T(D1,1:NTYP))
WRITE(106,106)INT(MATMUL(SLAT,QQQ2(:,D1))),ABS(SUM(DIFF2T(D1,1:NTYP))),ABS(DIFF2T(D1,1:NTYP))
END DO
106 FORMAT(3I8,100E15.6)
!#WRITING DONE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!





!!!!!!!!!!!!!!TOTAL PATTERSON FUNCTION!!!!!!!!!!!!!!STUFF###################################################################################################
!DEFINE STEP
DRSTEP=0.1    !0.1 Angstrom unit resolution
DRSTEP=DRSTEP/SLAT(1,1) !In fractional 
PRINT*,'DRSTEP',DRSTEP

!Define Range for Patterson      !THIS FOR CUBIC CASE with a 10x10x10 Supercell, Change accordingly
IR1=NINT(0.1/DRSTEP)
IR2=IR1
IR3=IR1
PRINT*,'IR1',IR1
IRMAX=IR1*IR2*IR3    
ALLOCATE(RRR(IRMAX,3))
ALLOCATE(RHO(IRMAX,NTYP))
ALLOCATE(TRHO(IRMAX))
IK=0
DO D1=0,IR1-1
DO D2=0,IR2-1
DO D3=0,IR3-1
IK=IK+1
RRR(IK,:)= (/REAL(D1), REAL(D2),REAL(D3)/) !0
END DO
END DO
END DO
RRR=RRR*DRSTEP
!!!!!!!!!!!!!Q IN FRACTIONAL!!!!!!!!!!!!!!
QQQ2=MATMUL(SLAT,QQQ2)
!CALCULATE PATTERSON
DO ITYP=1,NTYP
PRINT*,'ITYP=',ITYP
!$omp parallel do
DO D1=1,IRMAX
!RHO(D1,ITYP)= SUM(  (ABS(ZELE(ITYP)*DIFF2T(:,ITYP))**2)* COS(2.0*PI*MATMUL(RRR(D1,:),QQQ2)),DIM=1 )
RHO(D1,ITYP)= SUM(  (ABS(DIFF2T(:,ITYP))**2)* COS(2.0*PI*MATMUL(RRR(D1,:),QQQ2)),DIM=1 )
END DO
!$omp end parallel do
END DO
!$omp parallel do
DO D1=1,IRMAX
TRHO(D1)= SUM(      SUM(ABS(DIFF2T(:,:)**2),DIM=2)* COS(2.0*PI*MATMUL(RRR(D1,:),QQQ2)) )
END DO
!$omp end parallel do
PRINT*,'PATTERSON CALCULATION DONE'
DO D1=1,IRMAX
WRITE(107,107)NORM2(RRR(D1,:)),RRR(D1,:),TRHO(D1),RHO(D1,:)
END DO
107 FORMAT(4(F12.8,2x),100E15.6)

DO ITYP=1,NTYP
OPEN(108,FILE=trim(ATMNM(ITYP))//"_"//"PATTERSON.vasp")
WRITE(108,*)'COMMENT PROBABILITY DENSITY'
WRITE(108,*)'1.0'
WRITE(108,*) IR1,'0 0 ' 
WRITE(108,*)'0', IR2,'0' 
WRITE(108,*)'0 0',IR3 
WRITE(108,103)'C'   
WRITE(108,*)'1'    
WRITE(108,*)'D' 
WRITE(108,*)'0 0 0'
WRITE(108,*)
WRITE(108,*)IR1,IR2,IR3   
WRITE(108,101)
WRITE(108,101)(RHO(ID1,ITYP) ,ID1=1,IRMAX)                 
CLOSE(108)
END DO
OPEN(108,FILE="Total_PATTERSON.vasp")
WRITE(108,*)'COMMENT PROBABILITY DENSITY'
WRITE(108,*)'1.0'
WRITE(108,*) IR1,'0 0 ' 
WRITE(108,*)'0', IR2,'0' 
WRITE(108,*)'0 0',IR3 
WRITE(108,103)'C'   
WRITE(108,*)'1'    
WRITE(108,*)'D' 
WRITE(108,*)'0 0 0'
WRITE(108,*)
WRITE(108,*)IR1,IR2,IR3   
WRITE(108,101)  (  SUM(RHO(ID1,:)),ID1=1,IRMAX)                 
CLOSE(108)
PRINT*, 'PATTERSON DONE'
!#########################DELTA PATTERSON PDF########################
DIFF2T=DIFF2T-ADIFF2T
OPEN(1103,FILE="DELTA-SQ.vasp")
WRITE(1103,*)'COMMENT PROBABILITY DENSITY'
WRITE(1103,*)'1.0'
WRITE(1103,*)ABS(NMAX11-NMAX12)+1,'0 0 '
WRITE(1103,*)'0', ABS(NMAX21-NMAX22)+1,'0'
WRITE(1103,*)'0 0',ABS(NMAX31-NMAX32)+1
WRITE(1103,103)'C'
WRITE(1103,*)'1'
WRITE(1103,*)'D'
WRITE(1103,*)'0 0 0'
WRITE(1103,*)
WRITE(1103,*)ABS(NMAX11-NMAX12)/DN1 +1,ABS(NMAX21-NMAX22)/DN2 +1,ABS(NMAX31-NMAX32)/DN3 +1
WRITE(1103,101)  (  ABS(SUM(DIFF2T(ID1,1:NTYP)))  , ID1=1,IQMAX)
PRINT*,'DONE DIFFUSE'
DO D1=1,IQMAX
WRITE(1106,106)INT(QQQ2(:,D1)),ABS(SUM(DIFF2T(D1,1:NTYP))),ABS(DIFF2T(D1,1:NTYP))
END DO


DO ITYP=1,NTYP
PRINT*,'ITYP=',ITYP
!$omp parallel do
DO D1=1,IRMAX
RHO(D1,ITYP)= SUM((ABS(DIFF2T(:,ITYP)**2))* COS(2.0*PI*MATMUL(RRR(D1,:),QQQ2)),DIM=1 )
END DO
!$omp end parallel do
END DO

!$omp parallel do
DO D1=1,IRMAX
TRHO(D1)= SUM(    (ABS(SUM(DIFF2T(:,:),DIM=2))**2) *  COS(2.0*PI*MATMUL(RRR(D1,:),QQQ2)))
END DO
!$omp end parallel do



DO ITYP=1,NTYP
OPEN(1108,FILE=trim(atmnm(ITYP))//"_"//"DELTA-PATTERSON.vasp")
WRITE(1108,*)'COMMENT PROBABILITY DENSITY'
WRITE(1108,*)'1.0'
WRITE(1108,*) IR1,'0 0 ' 
WRITE(1108,*)'0', IR2,'0' 
WRITE(1108,*)'0 0',IR3 
WRITE(1108,103)'C'   
WRITE(1108,*)'1'    
WRITE(1108,*)'D' 
WRITE(1108,*)'0 0 0'
WRITE(1108,*)
WRITE(1108,*)IR1,IR2,IR3   
PRINT*,'PATTERSON VESTA FILE DONE'
WRITE(1108,101)
WRITE(1108,101)(RHO(ID1,ITYP) ,ID1=1,IRMAX)                 
WRITE(1108,101)  (  SUM(RHO(ID1,:)),ID1=1,IRMAX)                 
CLOSE(1108)
END DO

OPEN(1108,FILE="Total_DELTA-PATTERSON.vasp")
WRITE(1108,*)'COMMENT PROBABILITY DENSITY'
WRITE(1108,*)'1.0'
WRITE(1108,*) IR1,'0 0 ' 
WRITE(1108,*)'0', IR2,'0' 
WRITE(1108,*)'0 0',IR3 
WRITE(1108,103)'C'   
WRITE(1108,*)'1'    
WRITE(1108,*)'D' 
WRITE(1108,*)'0 0 0'
WRITE(1108,*)
WRITE(1108,*)IR1,IR2,IR3   
PRINT*,'PATTERSON VESTA FILE DONE'
WRITE(1108,101)
WRITE(1108,101)(RHO(ID1,ITYP) ,ID1=1,IRMAX)                 
WRITE(1108,101)  (  TRHO(ID1) ,ID1=1,IRMAX)                 


DEALLOCATE(RHO,RRR,TRHO,ADIFF2T)
END SUBROUTINE



SUBROUTINE PATTERSON        
use omp_lib
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::AA
DOUBLE PRECISION::MODA
DOUBLE PRECISION::R1,R2
INTEGER::IDR
INTEGER::K1,K2,K3,K4
INTEGER::NS,INS,NX,NY,NZ,I1
DOUBLE PRECISION::DV,AREA,XD,YD,ZD
INTEGER::JTYP
!INTEGER,DIMENSION(3)::NSS
DOUBLE PRECISION::DELFRAC
INTEGER,ALLOCATABLE,DIMENSION(:,:)::NNRI
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:,:,:)::PATT
INTEGER::D1,D2,D3

!ALLOCATE(PATT(-100:100,-100:100,-100:100,NTYP,NTYP),AA(NATOM,3),NNRI(NATOM,3))
ALLOCATE(PATT( 0:100,0:100,0:100,NTYP,NTYP),AA(NATOM,3),NNRI(NATOM,3))
DELFRAC=0.01
AA=0
PRINT*, "I M IN GRRFN LAMPPS2"
PRINT*,IT
WRITE(111,*)'# TIME=IT,LL',IT,LL

NSS(1)=10
NSS(2)=10
NSS(3)=10
PATT=0
DO IT=1,IREF2-IREF1+1,INTERVAL
PRINT*,IT
RR1=MATMUL(POS(IT,:,:),ISLAT)
DO ITYP=1,NTYP
DO JTYP=ITYP,NTYP
   DO I=SUM(NNTYPE(1:ITYP-1))+1, SUM(NNTYPE(1:ITYP))
        NNRI=0
	    !$omp parallel shared(PATT)
            DO J=SUM(NNTYPE(1:JTYP-1))+1, SUM(NNTYPE(1:JTYP))
            IF(I.NE.J)THEN
            AA(J,:)= RR1(I,:)-RR1(J,:)  !POS(IT,I,:)-POS(IT,J,:)
	    !WHERE(AA(J,:).LT.-0.5)AA(J,:)=AA(J,:)+1
	    !WHERE(AA(J,:).gT.0.5)AA(J,:)=AA(J,:)-1

!!!!!!!!!!!!!!!!!!!!SUPERCELL TO UNIT CELL FOLDING!!!!!!!!!!!!!!!!!!!!!!!!!!!
	    AA(J,:)=AA(J,:)*NSS
	    AA(J,:)=AA(J,:)-INT(AA(J,:))
            WHERE(AA(J,:).LT.0)AA(J,:)=AA(J,:)+1	
            WHERE(AA(J,:).GE.1)AA(J,:)=AA(J,:)-1	
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            NNRI(J,:)=INT( AA(J,:)/DELFRAC ) !
            !WHERE(NNRI(J,:)==0)NNRI(J,:)=NNRI(J,:)+1   
	    !PRINT*,AA(J,:)
	    !PRINT*,AA(J,:)/DELFRAC
	    ! PAUSE
	    PATT(NNRI(J,1),NNRI(J,2),NNRI(J,3),ITYP,JTYP)=PATT(NNRI(J,1),NNRI(J,2),NNRI(J,3),ITYP,JTYP) + 1.0

	    !PRINT*,PATT(NNRI(J,1),NNRI(J,2),NNRI(J,3),ITYP,JTYP)
	    !PAUSE
            END IF
            END DO
	    !$omp end parallel 
  END DO            
END DO
END DO
END DO
PATT=PATT*INTERVAL/((IREF2-IREF1+1)*NATOM)
!!!!!!!!!!!!!!!!!!!!!!!
102 FORMAT(3f20.10)
DO ITYP=1,NTYP
DO JTYP=ITYP,NTYP
OPEN(1101,FILE=trim(ATMNM(ITYP))//"_"//trim(ATMNM(JTYP))//'PATTERSON.vasp')
WRITE(1101,*)'COMMENT PROBABILITY DENSITY'
WRITE(1101,*)'1.0'
WRITE(1101,102)SLAT(1,:)/NSS(1)
WRITE(1101,102)SLAT(2,:)/NSS(2)
WRITE(1101,102)SLAT(3,:)/NSS(3)
WRITE(1101,*)'C' !ATMNM !SLAT(1,:)
!WRITE(101,*)NNTYPE !ATMNM !SLAT(1,:)
WRITE(1101,*)'D' !SLAT(1,:)
!DO I=1,NATOM
!WRITE(101,102)MATMUL(ISLAT,POS(1,I,:)) !ATMNM !SLAT(1,:)
WRITE(1101,*)'0 0 0' !MATMUL(ISLAT,POS(1,I,:)) !ATMNM !SLAT(1,:)
!IF(ISOFT==3)WRITE(101,102) POS(1,I,:)  !MATMUL(ISLATORIG,POS(1,I,:)) !ATMNM !SLAT(1,:)
!END DO
WRITE(1101,*) !SLAT(1,:)
WRITE(1101,*)'100 100 100' !NX+1,NY+1,NZ+1
!WRITE(1101,1101)(((PATT(D1,D2,D3,ITYP,JTYP),D1=0,100),D2=0,100),D3=0,100)
WRITE(1101,1101)(((PATT(D1,D2,D3,ITYP,JTYP),D1=0,99),D2=0,99),D3=0,99)
CLOSE(1101)
END DO
END DO
OPEN(1101,FILE='Total_PATTERSON.vasp')
WRITE(1101,*)'COMMENT PROBABILITY DENSITY'
WRITE(1101,*)'1.0'
WRITE(1101,102)SLAT(1,:)/NSS(1)
WRITE(1101,102)SLAT(2,:)/NSS(2)
WRITE(1101,102)SLAT(3,:)/NSS(3)
WRITE(1101,*)'C' !ATMNM !SLAT(1,:)
!WRITE(101,*)NNTYPE !ATMNM !SLAT(1,:)
WRITE(1101,*)'D' !SLAT(1,:)
!DO I=1,NATOM
!WRITE(101,102)MATMUL(ISLAT,POS(1,I,:)) !ATMNM !SLAT(1,:)
WRITE(1101,*)'0 0 0' !MATMUL(ISLAT,POS(1,I,:)) !ATMNM !SLAT(1,:)
!IF(ISOFT==3)WRITE(101,102) POS(1,I,:)  !MATMUL(ISLATORIG,POS(1,I,:)) !ATMNM !SLAT(1,:)
!END DO
WRITE(1101,*) !SLAT(1,:)
WRITE(1101,*)'100 100 100' !NX+1,NY+1,NZ+1
!WRITE(1101,1101)(((PATT(D1,D2,D3,ITYP,JTYP),D1=0,100),D2=0,100),D3=0,100)
WRITE(1101,1101)((((SUM(PATT(D1,D2,D3,:,:))),D1=0,99),D2=0,99),D3=0,99)
CLOSE(1101)
1101 FORMAT(5E14.6,1x)
!!!!!!!!!!!!!!!!!!!!!!!
DEALLOCATE(PATT,AA,NNRI)
END SUBROUTINE 


SUBROUTINE PATTERSON_Unfolded        
use omp_lib
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::AA
DOUBLE PRECISION::MODA
DOUBLE PRECISION::R1,R2
INTEGER::IDR
INTEGER::K1,K2,K3,K4
INTEGER::NS,INS,NX,NY,NZ,I1
DOUBLE PRECISION::DV,AREA,XD,YD,ZD
INTEGER::JTYP
!INTEGER,DIMENSION(3)::NSS
DOUBLE PRECISION::DELFRAC
INTEGER,ALLOCATABLE,DIMENSION(:,:)::NNRI
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:,:,:)::PATT
INTEGER::D1,D2,D3

!ALLOCATE(PATT(-100:100,-100:100,-100:100,NTYP,NTYP),AA(NATOM,3),NNRI(NATOM,3))
ALLOCATE(PATT( 0:1000,0:1000,0:1000,NTYP,NTYP),AA(NATOM,3),NNRI(NATOM,3))
DELFRAC=0.001
AA=0
PRINT*, "I M IN GRRFN LAMPPS2"
PRINT*,IT
WRITE(111,*)'# TIME=IT,LL',IT,LL

NSS(1)=1!0
NSS(2)=1! 0
NSS(3)=1 !0
PATT=0
DO IT=1,IREF2-IREF1+1,INTERVAL
PRINT*,IT
RR1=MATMUL(POS(IT,:,:),ISLAT)
DO ITYP=1,NTYP
DO JTYP=ITYP,NTYP
   DO I=SUM(NNTYPE(1:ITYP-1))+1, SUM(NNTYPE(1:ITYP))
        NNRI=0
	    !$omp parallel shared(PATT)
            DO J=SUM(NNTYPE(1:JTYP-1))+1, SUM(NNTYPE(1:JTYP))
            IF(I.NE.J)THEN
            AA(J,:)= RR1(I,:)-RR1(J,:)  !POS(IT,I,:)-POS(IT,J,:)
	    !WHERE(AA(J,:).LT.-0.5)AA(J,:)=AA(J,:)+1
	    !WHERE(AA(J,:).gT.0.5)AA(J,:)=AA(J,:)-1

!!!!!!!!!!!!!!!!!!!!SUPERCELL TO UNIT CELL FOLDING!!!!!!!!!!!!!!!!!!!!!!!!!!!
	    AA(J,:)=AA(J,:)*NSS
	    AA(J,:)=AA(J,:)-INT(AA(J,:))
            WHERE(AA(J,:).LT.0)AA(J,:)=AA(J,:)+1	
            WHERE(AA(J,:).GE.1)AA(J,:)=AA(J,:)-1	
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            NNRI(J,:)=INT( AA(J,:)/DELFRAC ) !
            !WHERE(NNRI(J,:)==0)NNRI(J,:)=NNRI(J,:)+1   
	    !PRINT*,AA(J,:)
	    !PRINT*,AA(J,:)/DELFRAC
	    ! PAUSE
	    PATT(NNRI(J,1),NNRI(J,2),NNRI(J,3),ITYP,JTYP)=PATT(NNRI(J,1),NNRI(J,2),NNRI(J,3),ITYP,JTYP) + 1.0

	    !PRINT*,PATT(NNRI(J,1),NNRI(J,2),NNRI(J,3),ITYP,JTYP)
	    !PAUSE
            END IF
            END DO
	    !$omp end parallel 
  END DO            
END DO
END DO
END DO
PATT=PATT*INTERVAL/((IREF2-IREF1+1)*NATOM)
!!!!!!!!!!!!!!!!!!!!!!!
102 FORMAT(3f20.10)
DO ITYP=1,NTYP
DO JTYP=ITYP,NTYP
OPEN(1101,FILE=trim(ATMNM(ITYP))//"_"//trim(ATMNM(JTYP))//'PATTERSON.vasp')
WRITE(1101,*)'COMMENT PROBABILITY DENSITY'
WRITE(1101,*)'1.0'
WRITE(1101,102)SLAT(1,:)/NSS(1)
WRITE(1101,102)SLAT(2,:)/NSS(2)
WRITE(1101,102)SLAT(3,:)/NSS(3)
WRITE(1101,*)'C' !ATMNM !SLAT(1,:)
!WRITE(101,*)NNTYPE !ATMNM !SLAT(1,:)
WRITE(1101,*)'D' !SLAT(1,:)
!DO I=1,NATOM
!WRITE(101,102)MATMUL(ISLAT,POS(1,I,:)) !ATMNM !SLAT(1,:)
WRITE(1101,*)'0 0 0' !MATMUL(ISLAT,POS(1,I,:)) !ATMNM !SLAT(1,:)
!IF(ISOFT==3)WRITE(101,102) POS(1,I,:)  !MATMUL(ISLATORIG,POS(1,I,:)) !ATMNM !SLAT(1,:)
!END DO
WRITE(1101,*) !SLAT(1,:)
WRITE(1101,*)'1000 1000 1000' !NX+1,NY+1,NZ+1
!WRITE(1101,1101)(((PATT(D1,D2,D3,ITYP,JTYP),D1=0,100),D2=0,100),D3=0,100)
WRITE(1101,1101)(((PATT(D1,D2,D3,ITYP,JTYP),D1=0,999),D2=0,999),D3=0,999)
CLOSE(1101)
END DO
END DO
OPEN(1101,FILE='Total_PATTERSON.vasp')
WRITE(1101,*)'COMMENT PROBABILITY DENSITY'
WRITE(1101,*)'1.0'
WRITE(1101,102)SLAT(1,:)/NSS(1)
WRITE(1101,102)SLAT(2,:)/NSS(2)
WRITE(1101,102)SLAT(3,:)/NSS(3)
WRITE(1101,*)'C' !ATMNM !SLAT(1,:)
!WRITE(101,*)NNTYPE !ATMNM !SLAT(1,:)
WRITE(1101,*)'D' !SLAT(1,:)
!DO I=1,NATOM
!WRITE(101,102)MATMUL(ISLAT,POS(1,I,:)) !ATMNM !SLAT(1,:)
WRITE(1101,*)'0 0 0' !MATMUL(ISLAT,POS(1,I,:)) !ATMNM !SLAT(1,:)
!IF(ISOFT==3)WRITE(101,102) POS(1,I,:)  !MATMUL(ISLATORIG,POS(1,I,:)) !ATMNM !SLAT(1,:)
!END DO
WRITE(1101,*) !SLAT(1,:)
WRITE(1101,*)'1000 1000 1000' !NX+1,NY+1,NZ+1
!WRITE(1101,1101)(((PATT(D1,D2,D3,ITYP,JTYP),D1=0,100),D2=0,100),D3=0,100)
WRITE(1101,1101)((((SUM(PATT(D1,D2,D3,:,:))),D1=0,999),D2=0,999),D3=0,999)
CLOSE(1101)
1101 FORMAT(5E14.6,1x)
!!!!!!!!!!!!!!!!!!!!!!!
DEALLOCATE(PATT,AA,NNRI)
END SUBROUTINE 


SUBROUTINE NEWVONHOVE_PAIR_ADV(IIREF1,IIREF2)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,IBAC,IFOR,II1,IIREF1,IIREF2
INTEGER::M
INTEGER::NSTEPORIG2
DOUBLE PRECISION::POSINT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::GRRT !!X
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::GRRTY
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::GRRTZ
DOUBLE PRECISION::RCUT,R1,R2 !,DR
INTEGER::IREF !,NRPOINTS
DOUBLE PRECISION::DRR
DOUBLE PRECISION::DR1
INTEGER::NBIN  !,NSTEPIV,NSTEPINT
INTEGER,ALLOCATABLE,DIMENSION(:,:,:)::NNBIN !X
!INTEGER,ALLOCATABLE,DIMENSION(:,:)::NNBINY
!INTEGER,ALLOCATABLE,DIMENSION(:,:)::NNBINZ
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DR
INTEGER::OFFSET
INTEGER::IIII2
CHARACTER*14::AAAA
!$ call omp_set_num_threads(num_threads)
WRITE(AAAA,'("VONHOVE_PAIR",I1.1,I1.1)')IIREF1,IIREF2
OPEN(109,FILE=AAAA//"X")
OPEN(110,FILE=AAAA//"Y")
OPEN(111,FILE=AAAA//"Z")
GRRT=0
!GRRTY=0
!GRRTZ=0
RCUT=0
DRR=0.05
!NRPOINTS=500
!PRINT*,'GIVE THE No. of ORIGIN FOR VON HOVE',NSTEPIV
!PRINT*,'GIVE THE No. of TIME STEP INTREVALS OVER WHICH THE VON HOVE WILL BE PRINTED INTERVALS',NSTEPINT
ALLOCATE(DR(0:1000,NSTEPIV,3))
ALLOCATE(GRRT(0:1000,0:NRPOINTS,3))
ALLOCATE(NNBIN(0:1000,NSTEPIV,3))
!ALLOCATE(GRRTY(0:1000,0:NRPOINTS))
!ALLOCATE(NNBINY(0:1000,NSTEPIV))
!ALLOCATE(GRRTZ(0:1000,0:NRPOINTS))
!ALLOCATE(NNBINZ(0:1000,NSTEPIV))

OFFSET=SUM(NNTYPE(1:IREF-1))
NSTEPORIG2=IREF2-IREF1+1
PRINT*,NSTEPORIG2
PRINT*, 'THE DISTINCT VON HOVE CALCULATION BETWEEN ',ATMNM(IIREF1),'-',ATMNM(IIREF2) !,'WILL BE PERFORMED  AVERAGED FOR',NSTEPIV,'LENGHT'

NSTEP1=NSTEPIV
NNBIN=0
!$omp parallel do private(IK)
DO DT=0,(NSTEPORIG-NSTEPINT)/NSTEPINT
!NSTEP2=NSTEPIV+DT
!IK=DT/NSTEPINT
IF(NSTEPIV+DT.LT.NSTEPORIG)THEN
DO IIII2=SUM(NNTYPE(1:IIREF1-1))+1,SUM(NNTYPE(1:IIREF1))
DO IIII=SUM(NNTYPE(1:IIREF2-1))+1,SUM(NNTYPE(1:IIREF2))
 IF(IIII2.NE.IIII)THEN
 DR(DT,1:NSTEPIV,:)=ABS(POS(1:NSTEPIV,IIII2,:)-POS(1+DT:NSTEPIV+DT,IIII,:))
 NNBIN(DT,:,1)=INT(DR(DT,:,1)/DRR)
 NNBIN(DT,:,2)=INT(DR(DT,:,2)/DRR)
 NNBIN(DT,:,3)=INT(DR(DT,:,3)/DRR)
 WHERE(NNBIN(DT,:,1).LT.NRPOINTS)GRRT(DT,NNBIN(DT,1:NSTEPIV,1),1)=GRRT(DT,NNBIN(DT,1:NSTEPIV,1),1)+1.0
 WHERE(NNBIN(DT,:,2).LT.NRPOINTS)GRRT(DT,NNBIN(DT,1:NSTEPIV,2),2)=GRRT(DT,NNBIN(DT,1:NSTEPIV,2),2)+1.0
 WHERE(NNBIN(DT,:,3).LT.NRPOINTS)GRRT(DT,NNBIN(DT,1:NSTEPIV,3),3)=GRRT(DT,NNBIN(DT,1:NSTEPIV,3),3)+1.0
 END IF
END DO
END DO
END IF
END DO
!$omp end parallel do

IK=NSTEP/NSTEPINT
DO K=0,NRPOINTS
R1=(K)*DRR 
R2=RCUT+(K+1)*DRR 
WRITE(109,109)R1,GRRT(0:IK,K,1)
WRITE(110,109)R1,GRRT(0:IK,K,2)
WRITE(111,109)R1,GRRT(0:IK,K,3)
END DO
109 FORMAT(F10.5,10000(E14.5,1x))
DEALLOCATE(GRRT,DR,NNBIN)
END SUBROUTINE


SUBROUTINE NEWVONHOVE_PAIR_ADV3d(IIREF1,IIREF2)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,IBAC,IFOR,II1,IIREF1,IIREF2
INTEGER::M
INTEGER::NSTEPORIG2
DOUBLE PRECISION::POSINT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::GRRT !!X
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::GRRTY
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::GRRTZ
DOUBLE PRECISION::RCUT,R1,R2 !,DR
INTEGER::IREF !,NRPOINTS
DOUBLE PRECISION::DRR
DOUBLE PRECISION::DR1
INTEGER::NBIN  !,NSTEPIV,NSTEPINT
INTEGER,ALLOCATABLE,DIMENSION(:,:,:)::BIN !X
!INTEGER,ALLOCATABLE,DIMENSION(:,:)::NNBINY
!INTEGER,ALLOCATABLE,DIMENSION(:,:)::NNBINZ
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DR
INTEGER::OFFSET
INTEGER::IIII2
CHARACTER*14::AAAA
PRINT*, 'I AM IN VAN-HOVE ADV 3d'
!$ call omp_set_num_threads(num_threads)
WRITE(AAAA,'("VONHOVE_PAIR",I1.1,I1.1)')IIREF1,IIREF2
OPEN(109,FILE=AAAA//"X")
OPEN(110,FILE=AAAA//"Y")
OPEN(111,FILE=AAAA//"Z")
GRRT=0
!GRRTY=0
!GRRTZ=0
RCUT=0
DRR=0.05
IK=(IREF2-IREF1+1)/NSTEPINT
PRINT*,'IK',IK

ALLOCATE(DR(0:NATOM,NSTEPIV,3))
ALLOCATE(GRRT(0:IK,0:NRPOINTS,3))
ALLOCATE(BIN(0:NATOM,NSTEPIV,3))
OFFSET=SUM(NNTYPE(1:IREF-1))
NSTEPORIG2=IREF2-IREF1+1
PRINT*,NSTEPORIG2
PRINT*, 'THE DISTINCT VON HOVE CALCULATION BETWEEN ',ATMNM(IIREF1),'-',ATMNM(IIREF2) !,'WILL BE PERFORMED  AVERAGED FOR',NSTEPIV,'LENGHT'
NSTEP1=NSTEPIV
!GRRT=0
!$omp parallel do  shared(GRRT) private(IK) 
DO DT=0,IREF2-IREF1, NSTEPINT
BIN=0
DR=0
IK=DT/NSTEPINT
IF(NSTEPIV+DT.LE.NSTEPORIG)THEN
!PRINT*,'IK=',IK ,DT,NSTEPINT 
DO IIII2=SUM(NNTYPE(1:IIREF1-1))+1,SUM(NNTYPE(1:IIREF1))
DO IIII=SUM(NNTYPE(1:IIREF2-1))+1,SUM(NNTYPE(1:IIREF2))
!PRINT*,'IK=',IK ,DT !,NSTEPINT 
 IF(IIII2.NE.IIII)THEN
 DR(IK,1:NSTEPIV,:)=ABS(POS(1:NSTEPIV,IIII2,:)-POS(1+DT:NSTEPIV+DT,IIII,:))
 BIN(IK,:,:)=INT(DR(IK,:,:)/DRR)
 where(BIN(IK,1:NSTEPIV,1).LT.NRPOINTS)GRRT(IK,BIN(IK,1:NSTEPIV,1),1)=GRRT(IK,BIN(IK,1:NSTEPIV,1),1)+1
 where(BIN(IK,1:NSTEPIV,2).LT.NRPOINTS)GRRT(IK,BIN(IK,1:NSTEPIV,2),2)=GRRT(IK,BIN(IK,1:NSTEPIV,2),2)+1
 where(BIN(IK,1:NSTEPIV,3).LT.NRPOINTS)GRRT(IK,BIN(IK,1:NSTEPIV,3),3)=GRRT(IK,BIN(IK,1:NSTEPIV,3),3)+1
! DR(IIII2,1:NSTEPIV,:)=ABS(POS(1:NSTEPIV,IIII2,:)-POS(1+DT:NSTEPIV+DT,IIII,:))
! BIN(IIII2,:,:)=INT(DR(IIII2,:,:)/DRR)
! where(BIN(IIII2,1:NSTEPIV,1).LT.NRPOINTS)GRRT(IK,BIN(IIII2,1:NSTEPIV,1),1)=GRRT(IK,BIN(IIII2,1:NSTEPIV,1),1)+1
! where(BIN(IIII2,1:NSTEPIV,2).LT.NRPOINTS)GRRT(IK,BIN(IIII2,1:NSTEPIV,2),2)=GRRT(IK,BIN(IIII2,1:NSTEPIV,2),2)+1
! where(BIN(IIII2,1:NSTEPIV,3).LT.NRPOINTS)GRRT(IK,BIN(IIII2,1:NSTEPIV,3),3)=GRRT(IK,BIN(IIII2,1:NSTEPIV,3),3)+1
         !where(BIN(IIII2,:,:).GT.NRPOINTS)BIN(IIII2,:,:)=NRPOINTS
         !     BIN(IIII2,:,:)=NRPOINTS
 !GRRT(IK,BIN(IIII2,1:NSTEPIV,1),1)=GRRT(IK,BIN(IIII2,1:NSTEPIV,1),1)+1
 !GRRT(IK,BIN(IIII2,1:NSTEPIV,2),2)=GRRT(IK,BIN(IIII2,1:NSTEPIV,2),2)+1
 !GRRT(IK,BIN(IIII2,1:NSTEPIV,3),3)=GRRT(IK,BIN(IIII2,1:NSTEPIV,3),3)+1
 END IF
END DO
END DO
END IF
!        DO K=1,NRPOINTS
!        WRITE(109,110)GRRT(K,1)
!        WRITE(110,110)GRRT(K,2)
!        WRITE(111,110)GRRT(K,3)
!        END DO
END DO
!$omp end parallel do
110 FORMAT(E16.7)
!IK=(NSTEPORIG-NSTEPINT)/NSTEPINT
IK=(IREF2-IREF1+1)/NSTEPINT
DO K=0,NRPOINTS-1
R1=(K)*DRR 
R2=RCUT+(K+1)*DRR 
WRITE(109,109)R1,GRRT(0:IK,K,1)
WRITE(110,109)R1,GRRT(0:IK,K,2)
WRITE(111,109)R1,GRRT(0:IK,K,3)
END DO
109 FORMAT(F10.5,20000(E17.7,1x))
DEALLOCATE(GRRT,DR,BIN)
END SUBROUTINE


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
SUBROUTINE VONHOVE_SELFADV(IREF)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,IBAC,IFOR,II1
INTEGER::M
INTEGER::NSTEPORIG2
DOUBLE PRECISION::POSINT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::GRRT
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DGRRT
DOUBLE PRECISION::RCUT,R1,R2 !,DR
INTEGER::IREF  !,NRPOINTS
DOUBLE PRECISION::DRR
DOUBLE PRECISION::DR1
INTEGER::NBIN !,NSTEPIV,NSTEPINT
!INTEGER,ALLOCATABLE,DIMENSION(:)::NNBIN
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DR
INTEGER,ALLOCATABLE,DIMENSION(:,:)::NNBIN
INTEGER,ALLOCATABLE,DIMENSION(:)::BIN
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DR
INTEGER::OFFSET
CHARACTER*14::AAAA
CHARACTER*16::AAAA2
!DOUBLE PRECISION::R0M
!$ call omp_set_num_threads(num_threads)
WRITE(AAAA,'("VANHOVE_SELF",I2.2)')IREF
OPEN(109,FILE=AAAA)
WRITE(AAAA2,'("VANHOVE_R2SELF",I2.2)')IREF
OPEN(110,FILE=AAAA)

!OPEN(109,FILE='VONHOVE_SELF')
!OPEN(110,FILE='VONHOVE_SELFR2')
GRRT=0
RCUT=0
DRR=0.05
PRINT*,'GIVE THE No. of ORIGIN FOR VON HOVE',NSTEPIV
PRINT*,'GIVE THE No. of TIME STEP INTREVALS OVER WHICH THE VON HOVE WILL BE PRINTED INTERVALS',NSTEPINT
ALLOCATE(GRRT(0:1000,0:NRPOINTS))
ALLOCATE(DR(NATOM,NSTEPIV))
!ALLOCATE(NNBIN(NATOM,NSTEPIV))
ALLOCATE(BIN(NSTEPIV))
OFFSET=SUM(NNTYPE(1:IREF-1))
NSTEPORIG2=IREF2-IREF1+1
PRINT*,NSTEPORIG2
PRINT*, 'THE SELF VON HOVE CALCULATION WILL BE PERFORMED  AVERAGED FOR',NSTEPIV,'LENGHT'
GRRT=0
DO DT=0,IREF2-IREF1+1,NSTEPINT
NSTEP1=NSTEPIV
NSTEP2=NSTEPIV+DT
IK=DT/NSTEPINT
IF(NSTEP2.LT.NSTEPORIG2)THEN

!PRINT*,IK
NNBIN=0 
BIN=0
IF(IK.LE.100)THEN
!$omp parallel do private (BIN)
DO IIII=SUM(NNTYPE(1:IREF-1))+1,SUM(NNTYPE(1:IREF))
DR(IIII,1:NSTEPIV)=NORM2(POS(1:NSTEP1,IIII,:)-POS(1+DT:NSTEP2,IIII,:),DIM=2)
!DR(IIII,:)=INT(DR(IIII,:)/DRR)
!NNBIN(IIII,:)=INT(DR(IIII,:)/DRR)

BIN(:)=INT(DR(IIII,:)/DRR)

!WHERE(NNBIN(IIII,:).LT.NRPOINTS)GRRT(DT,NNBIN(IIII,1:NSTEPIV))=GRRT(DT,NNBIN(IIII,1:NSTEPIV))+1
  !WHERE(NNBIN(IIII,:).LT.NRPOINTS)GRRT(IK,NNBIN(IIII,1:NSTEPIV))=GRRT(IK,NNBIN(IIII,1:NSTEPIV))+1
  !WHERE(INT(DR(IIII,:)).LT.NRPOINTS)GRRT(IK,INT(DR(IIII,:        )))=GRRT(IK,INT(DR(IIII,:        )))+1
  !WHERE(NNBIN(IIII,:).LT.NRPOINTS)GRRT(IK,NNBIN(IIII,: ))=GRRT(IK,NNBIN(IIII,:))+1
  WHERE(BIN(:).LT.NRPOINTS)GRRT(IK,BIN(: ))=GRRT(IK,BIN(:))+1
END DO
!$omp end parallel do 
END IF
END IF
END DO
!PAUSE
IK=NSTEPORIG2/NSTEPINT
!PRINT*,'IK',IK
GRRT=GRRT/(NSTEPIV*NNTYPE(IREF)*DRR)
DO K=0,NRPOINTS
R1=(K)*DRR 
R2=RCUT+(K+1)*DRR
RM=0.5*(R1+R2) 
WRITE(109,109)RM,GRRT(0:IK,K)
WRITE(110,109)RM,4*PI*RM*RM*GRRT(0:IK,K)
!WRITE(109,109)R1,GRRT(1:NSTEP:NSTEPINT,K)
109 FORMAT(F10.5,10000(E16.7,1x))
END DO
close(109)
close(110)
DEALLOCATE(GRRT,DR)
END SUBROUTINE
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
SUBROUTINE CHGCAR2022(IIREF)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::NX,NY,NZ,IIREF
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::CHG
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(NNTYPE(IIREF),3)::DPOS
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(NNTYPE(IIREF))::FIRE !DPOS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DPOS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::FIRE !DPOS
INTEGER::I1,I2
DOUBLE PRECISION::DX,DY,DZ
DOUBLE PRECISION::DX1,DY1,DZ1
DOUBLE PRECISION::DX2,DY2,DZ2,ANORM,DV,PVOLUME
!INTEGER,DIMENSION(NNTYPE(IIREF),3)::NNBIN
INTEGER,ALLOCATABLE,DIMENSION(:,:)::NNBIN
INTEGER::IKK,INDDD
REAL::SIG
INTEGER::XI,YI,ZI
INTEGER::ISMEAR,NMAX
CHARACTER*11::AAAA
CHARACTER*12::AAAAA
CHARACTER*100::ABC2
INTEGER::INDE
INTEGER,DIMENSION(1000)::PDIS
!INTEGER,DIMENSION(3)::NSS
DOUBLE PRECISION::PSTEP
INTEGER::IX,IY,IZ
DOUBLE PRECISION::NTIMES
OPEN(111,FILE="REF.vasp")
!NSS=(/10,10,10/)
!!!!!!!!!!!!!!!!!
IF(IIREF>0)THEN
ALLOCATE(DPOS(NNTYPE(IIREF),3))
ALLOCATE(FIRE(NNTYPE(IIREF)))
ALLOCATE(NNBIN(NNTYPE(IIREF) ,3))
END IF
IF(IIREF<0)THEN
ALLOCATE(DPOS(NATOM,3))
ALLOCATE(FIRE(NATOM))
ALLOCATE(NNBIN(NATOM,3))
END IF
!!!!!!!!!!!!!!!
ISMEAR=1
SIG=1
PRINT*,ISLAT
NMAX=100
NX=NMAX
NY=NMAX
NZ=NMAX
ALLOCATE(CHG(0:NX,0:NY,0:NZ))
CHG=0
I1=SUM(NNTYPE(1:IIREF-1))+1
I2=SUM(NNTYPE(1:IIREF))
WRITE(AAAA,'("PROB",I2.2,".vasp")')IIREF
OPEN(101,FILE=AAAA)
WRITE(AAAAA,'("RPROB",I2.2,".txt")')IIREF
OPEN(102,FILE=AAAAA)
!OPEN(101,FILE="PROB.vasp")

DO 
READ(111,112,END=99)ABC2
WRITE(101,*)ADJUSTL(trim(ABC2))
END DO
112 FORMAT(A100)
99 CONTINUE
CLOSE(111)
!WRITE(101,*)'COMMENT PROBABILITY DENSITY'
!WRITE(101,*)'1.0'
!WRITE(101,102)SLAT(1,:)/NSS(1)
!WRITE(101,102)SLAT(2,:)/NSS(2)
!WRITE(101,102)SLAT(3,:)/NSS(3)
!WRITE(101,103)'C' !SLAT(1,:)
!WRITE(101,*)'1' !NNTYPE !ATMNM !SLAT(1,:)
!WRITE(101,*)'D' !SLAT(1,:)
!WRITE(101,*)'0 0 0' !MATMUL(ISLAT,POS(1,I,:)) !ATMNM !SLAT(1,:)

WRITE(101,*) !SLAT(1,:)
WRITE(101,*)NX,NY,NZ
102 FORMAT(3F20.15)
103 FORMAT(10A3)
!!$omp parallel do
        DO IT=1,IREF2-IREF1+1  !NSTEPORIG
        IKK=0
        DO IK=I1,I2
        IKK=IK-SUM(NNTYPE(1:IIREF-1))
        DPOS(IKK,:)=MATMUL(POS(IT,IK,:),ISLAT)
        !DPOS(IKK,:)=DPOS(IKK,:)*NSS
        DPOS(IKK,:)=MATMUL(DPOS(IKK,:),NSSD)
        DPOS(IKK,:)=DPOS(IKK,:)-NINT(DPOS(IKK,:))
        WHERE(DPOS(IKK,:).LT.0)DPOS(IKK,:)=DPOS(IKK,:)+1
        WHERE(DPOS(IKK,:).GT.1)DPOS(IKK,:)=DPOS(IKK,:)-1
        111 FORMAT(3F10.5)
        NNBIN(IKK,1)=DPOS(IKK,1)*NX
        NNBIN(IKK,2)=DPOS(IKK,2)*NY
        NNBIN(IKK,3)=DPOS(IKK,3)*NZ
        XI=NNBIN(IKK,1)
        YI=NNBIN(IKK,2)
        ZI=NNBIN(IKK,3)
        !IF(ANY(NNBIN(IKK,:)<0).EQ..FALSE..AND.ANY(NNBIN(IKK,:)>NMAX).EQ..FALSE.)THEN
!        IF(ANY(NNBIN(IKK,:)>NMAX.EQ..FALSE.)THEN
                CHG(NNBIN(IKK ,1), NNBIN(IKK,2), NNBIN(IKK,3))= CHG(NNBIN(IKK,1), NNBIN(IKK,2), NNBIN(IKK,3))+1
                IF(ISMEAR==1)THEN
                IF(XI+1.LE.NMAX)CHG(XI+1, YI,ZI)= CHG(XI+1,YI,ZI)+exp(-1.0/sig)
                IF(XI+2.LE.NMAX)CHG(XI+2, YI,ZI)= CHG(XI+2,YI,ZI)+exp(-4.0/sig)
                IF(XI+3.LE.NMAX)CHG(XI+3, YI,ZI)= CHG(XI+3,YI,ZI)+exp(-9.0/sig)
                IF(XI-1.GE.0)CHG(XI-1, YI,ZI)= CHG(XI-1,YI,ZI)+exp(-1.0/sig)
                IF(XI-2.GE.0)CHG(XI-2, YI,ZI)= CHG(XI-2,YI,ZI)+exp(-4.0/sig)
                IF(XI-3.GE.0)CHG(XI-3, YI,ZI)= CHG(XI-3,YI,ZI)+exp(-9.0/sig)
                IF(YI+1.LE.NMAX)        CHG(XI, YI+1,ZI)= CHG(XI,YI+1,ZI)+exp(-1.0/sig)
                IF(YI+2.LE.NMAX)        CHG(XI, YI+2,ZI)= CHG(XI,YI+2,ZI)+exp(-4.0/sig)
                IF(YI+3.LE.NMAX)        CHG(XI, YI+3,ZI)= CHG(XI,YI+3,ZI)+exp(-9.0/sig)
                IF(YI-1.GE.0)CHG(XI, YI-1,ZI)= CHG(XI,YI-1,ZI)+exp(-1.0/sig)
                IF(YI-2.GE.0)CHG(XI, YI-2,ZI)= CHG(XI,YI-2,ZI)+exp(-4.0/sig)
                IF(YI-3.GE.0)CHG(XI, YI-3,ZI)= CHG(XI,YI-3,ZI)+exp(-9.0/sig)
                IF(ZI+1.LE.NMAX)CHG(XI, YI,ZI+1)= CHG(XI,YI,ZI+1)+exp(-1.0/sig)
                IF(ZI+2.LE.NMAX)CHG(XI, YI,ZI+2)= CHG(XI,YI,ZI+2)+exp(-4.0/sig)
                IF(ZI+3.LE.NMAX)CHG(XI, YI,ZI+3)= CHG(XI,YI,ZI+3)+exp(-9.0/sig)
                IF(ZI-1.GE.0)CHG(XI, YI,ZI-1)= CHG(XI,YI,ZI-1)+exp(-1.0/sig)
                IF(ZI-2.GE.0)CHG(XI, YI,ZI-2)= CHG(XI,YI,ZI-2)+exp(-4.0/sig)
                IF(ZI-3.GE.0)CHG(XI, YI,ZI-3)= CHG(XI,YI,ZI-3)+exp(-9.0/sig)
                END IF
        !               CHG(NNBIN(IKK ,1), NNBIN(IKK,2), NNBIN(IKK,3))= CHG(NNBIN(IKK,1), NNBIN(IKK,2), NNBIN(IKK,3))+1
!        END IF
        !        CHG(NNBIN(IKK,1), NNBIN(IKK,2), NNBIN(IKK,3))=CHG(NNBIN(IKK,1), NNBIN(IKK,2), NNBIN(IKK,3))+1
        END DO
        END DO
        !!$omp end parallel do
        !CHG=CHG*1000/(NNTYPE(IIREF)*(IREF2-IREF1+1))
        CALL DETER(NSSD,NTIMES)

        print*,NTIMES
        !CHG=NNTYPE(IIREF)*CHG/(SUM(CHG)*NSS(1)*NSS(2)*NSS(3))  !*1000/(NNTYPE(IIREF)*(IREF2-IREF1+1))
        CHG=NNTYPE(IIREF)*CHG/(SUM(CHG)*NTIMES)  !*1000/(NNTYPE(IIREF)*(IREF2-IREF1+1))
!       ANORM= SUM(CHG) * NSS(1)*NSS(2)*NSS(3)*1000 /(VOLUME)
        !CHG=CHG(NSS(1)*NSS(2)*NSS(3))/(1000*VOLUME*SUM(CHG))  !*1000/(NNTYPE(IIREF)*(IREF2-IREF1+1))
        print*,sum(CHG)
!CHG=NNTYPE(IIREF)*CHG/(NSS(1)*NSS(2)*NSS(3)*(IREF2-IREF1+1)) !ANORM !(NSS(1)*NSS(2)*NSS(3))/(1000*VOLUME*SUM(CHG))  !*1000/(NNTYPE(IIREF)*(IREF2-IREF1+1))

        !DV=1.88973*1.88973*1.88973*VOLUME/(1331*NSS(1)*NSS(2)*NSS(3)) 
        !CHG=NNTYPE(IIREF)*CHG/(NSS(1)*NSS(2)*NSS(3)*SUM(CHG)*dv)  !*1000/(NNTYPE(IIREF)*(IREF2-IREF1+1))
        !CHG=(VOLUME*CHG*1.88973*1.88973*1.88973)/(DV*NSS(1)*NSS(2)*NSS(3))
        !PVOLUME=1.88973*1.88973*1.88973*VOLUME/(NSS(1)*NSS(2)*NSS(3))
        PVOLUME=1.88973*1.88973*1.88973*VOLUME/(NTIMES)
        DV=PVOLUME/((NX+1)*(NY+1)*NZ+1) 
        CHG=CHG/dv  !*1000/(NNTYPE(IIREF)*(IREF2-IREF1+1))
        print*,sum(chg)*dv
        PSTEP=MAXVAL(CHG)/1000


PDIS=0
!CHECK#

DO IX=1,NX
DO IY=1,NY
DO IZ=1,NZ
INDE=INT(CHG(IX,IY,IZ)/PSTEP)
IF(INDE.GT.0)PDIS(INDE)=PDIS(INDE)+1
END DO
END DO
END DO
DO I=1,1000
WRITE(102,*)PSTEP*I,REAL(SUM(PDIS(1:I)))/REAL(SUM(PDIS))
END DO


        CHG=PVOLUME*CHG !/(NSS(1)*NSS(2)*NSS(3))
        print*, sum(chg)*DV/PVOLUME !/(VOLUME*1.88973*1.88973*1.88973/(NSS(1)*NSS(2)*NSS(3)))


!1000 grid points, each grid point have dv volume
!CHG=CHG*NNTYPE(IIREF)*1000*1.88973*1.88973*1.88973/(NSS(1)*NSS(2)*NSS(3)) !Volume in Bohr Unit
!VESTA plot shows CHG/VOL

WRITE(101,101)(((CHG(I,J,K),I=0,NX-1),J=0,NY-1),K=0,NZ-1)
101 FORMAT(5E12.5)
IF (IIREF>0) PRINT*,'PROBABILITY DISTRIBUTION OF',ATMNM(IIREF),'IS CALCULATED OVER',IREF2-IREF1+1,'STEPS'
IF (IIREF<0) PRINT*,'PROBABILITY DISTRIBUTION OF SYSTEM   IS CALCULATED OVER',IREF2-IREF1+1,'STEPS'
!!!!!!!!!!!!!!!!!FOLDING  THE STRUCTURE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
END SUBROUTINE


SUBROUTINE NEWVONHOVE_PAIR_ADV3dGrid(IIREF1,IIREF2)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,IBAC,IFOR,II1,IIREF1,IIREF2
INTEGER::M
INTEGER::NSTEPORIG2
DOUBLE PRECISION::POSINT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::GRRT !!X
DOUBLE PRECISION::RCUT,R1,R2 !,DR
INTEGER::IREF !,NRPOINTS
DOUBLE PRECISION::DRR
DOUBLE PRECISION::DR1
INTEGER::NBIN  !,NSTEPIV,NSTEPINT
INTEGER,ALLOCATABLE,DIMENSION(:,:,:)::BIN !X
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DR
INTEGER::OFFSET
INTEGER::IIII2
CHARACTER*14::AAAA
PRINT*, 'I AM IN VAN-HOVE ADV 3d Grid'
!$ call omp_set_num_threads(num_threads)
WRITE(AAAA,'("VONHOVE_PAIR",I1.1,I1.1)')IIREF1,IIREF2
OPEN(109,FILE=AAAA)
!PEN(110,FILE=AAAA//"Y")
!PEN(111,FILE=AAAA//"Z")
GRRT=0
!GRRTY=0
!GRRTZ=0
RCUT=0
DRR=0.05
IK=(IREF2-IREF1+1)/NSTEPINT
PRINT*,'IK',IK

ALLOCATE(DR(0:NATOM,NSTEPIV,3))
ALLOCATE(GRRT(0:NRPOINTS,3))
ALLOCATE(BIN(0:NATOM,NSTEPIV,3))
OFFSET=SUM(NNTYPE(1:IREF-1))
NSTEPORIG2=IREF2-IREF1+1
PRINT*,NSTEPORIG2
PRINT*, 'THE DISTINCT VON HOVE CALCULATION BETWEEN ',ATMNM(IIREF1),'-',ATMNM(IIREF2) !,'WILL BE PERFORMED  AVERAGED FOR',NSTEPIV,'LENGHT'
NSTEP1=NSTEPIV
DO DT=0,(IREF2-IREF1), NSTEPINT
BIN=0
DR=0
IK=DT/NSTEPINT
IF(NSTEPIV+DT.LE.NSTEPORIG)THEN
GRRT=0
!$omp parallel do  shared(GRRT) private(IK) 
DO IIII2=SUM(NNTYPE(1:IIREF1-1))+1,SUM(NNTYPE(1:IIREF1))
DO IIII=SUM(NNTYPE(1:IIREF2-1))+1,SUM(NNTYPE(1:IIREF2))
 IF(IIII2.NE.IIII)THEN
 DR(IIII2,1:NSTEPIV,:)=ABS(POS(1:NSTEPIV,IIII2,:)-POS(1+DT:NSTEPIV+DT,IIII,:))
 BIN(IIII2,:,:)=INT(DR(IIII2,:,:)/DRR)
 where(BIN(IIII2,1:NSTEPIV,1).LT.NRPOINTS)GRRT(BIN(IIII2,1:NSTEPIV,1),1)=GRRT(BIN(IIII2,1:NSTEPIV,1),1)+1
 where(BIN(IIII2,1:NSTEPIV,2).LT.NRPOINTS)GRRT(BIN(IIII2,1:NSTEPIV,2),2)=GRRT(BIN(IIII2,1:NSTEPIV,2),2)+1
 where(BIN(IIII2,1:NSTEPIV,3).LT.NRPOINTS)GRRT(BIN(IIII2,1:NSTEPIV,3),3)=GRRT(BIN(IIII2,1:NSTEPIV,3),3)+1
 END IF
END DO
END DO
!$omp end parallel do
END IF
        DO K=0,NRPOINTS-1
        WRITE(109,110)GRRT(K,:)
!        WRITE(110,110)GRRT(K,2)
!        WRITE(111,110)GRRT(K,3)
        END DO
END DO
110 FORMAT(3(E17.7,2x))
109 FORMAT(F10.5,10000(E17.7,1x))
DEALLOCATE(GRRT,DR,BIN)
END SUBROUTINE

SUBROUTINE NEWVONHOVE_PAIR_ADV3dGrid2(IIREF1,IIREF2)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,IBAC,IFOR,II1,IIREF1,IIREF2
INTEGER::M
INTEGER::NSTEPORIG2
DOUBLE PRECISION::POSINT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::GRRT !!X
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::GRRTY
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::GRRTZ
DOUBLE PRECISION::RCUT,R1,R2 !,DR
INTEGER::IREF !,NRPOINTS
DOUBLE PRECISION::DRR
DOUBLE PRECISION::DR1
INTEGER::NBIN  !,NSTEPIV,NSTEPINT
INTEGER,ALLOCATABLE,DIMENSION(:,:,:)::BIN !X
!INTEGER,ALLOCATABLE,DIMENSION(:,:)::NNBINY
!INTEGER,ALLOCATABLE,DIMENSION(:,:)::NNBINZ
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DR
INTEGER::OFFSET
INTEGER::IIII2
CHARACTER*14::AAAA
PRINT*, 'I AM IN VAN-HOVE ADV 3d'
!$ call omp_set_num_threads(num_threads)
WRITE(AAAA,'("VONHOVE_PAIR",I1.1,I1.1)')IIREF1,IIREF2
OPEN(109,FILE=AAAA)
GRRT=1
!GRRTY=0
!GRRTZ=0
RCUT=0
DRR=0.05
IK=(IREF2-IREF1+1)/NSTEPINT
PRINT*,'IK',IK

ALLOCATE(DR(0:NATOM,NSTEPIV,3))
ALLOCATE(GRRT(0:IK,0:NRPOINTS,3))
ALLOCATE(BIN(0:NATOM,NSTEPIV,3))
OFFSET=SUM(NNTYPE(1:IREF-1))
NSTEPORIG2=IREF2-IREF1+1
PRINT*,NSTEPORIG2
PRINT*, 'THE DISTINCT VON HOVE CALCULATION BETWEEN ',ATMNM(IIREF1),'-',ATMNM(IIREF2) !,'WILL BE PERFORMED  AVERAGED FOR',NSTEPIV,'LENGHT'
NSTEP1=NSTEPIV
!GRRT=0
!$omp parallel do  private(IK,GRRT)
DO DT=0,(IREF2-IREF1), NSTEPINT
BIN=0
DR=0
IK=DT/NSTEPINT
IF(NSTEPIV+DT.LE.NSTEPORIG)THEN
!PRINT*,'IK=',IK ,DT,NSTEPINT 
DO IIII2=SUM(NNTYPE(1:IIREF1-1))+1,SUM(NNTYPE(1:IIREF1))
DO IIII=SUM(NNTYPE(1:IIREF2-1))+1,SUM(NNTYPE(1:IIREF2))
!PRINT*,'IK=',IK ,DT !,NSTEPINT 
 IF(IIII2.NE.IIII)THEN
 DR(IK,1:NSTEPIV,:)=ABS(POS(1:NSTEPIV,IIII2,:)-POS(1+DT:NSTEPIV+DT,IIII,:))
 BIN(IK,:,:)=INT(DR(IK,:,:)/DRR)
 where(BIN(IK,1:NSTEPIV,1).LT.NRPOINTS)GRRT(IK,BIN(IK,1:NSTEPIV,1),1)=GRRT(IK,BIN(IK,1:NSTEPIV,1),1)+1
 where(BIN(IK,1:NSTEPIV,2).LT.NRPOINTS)GRRT(IK,BIN(IK,1:NSTEPIV,2),2)=GRRT(IK,BIN(IK,1:NSTEPIV,2),2)+1
 where(BIN(IK,1:NSTEPIV,3).LT.NRPOINTS)GRRT(IK,BIN(IK,1:NSTEPIV,3),3)=GRRT(IK,BIN(IK,1:NSTEPIV,3),3)+1
 END IF
END DO
END DO
END IF
!        DO K=1,NRPOINTS
!        WRITE(109,109)REAL(DT),GRRT(K,:)
!        WRITE(109,110)GRRT(K,1)
!        WRITE(110,110)GRRT(K,2)
!        WRITE(111,110)GRRT(K,3)
!        END DO
END DO
!$omp end parallel do
110 FORMAT(E16.7)
!IK=(NSTEPORIG-NSTEPINT)/NSTEPINT
DO IK=0,(NSTEPORIG-NSTEPINT)/NSTEPINT
DO K=0,NRPOINTS-1
R1=(K)*DRR 
R2=RCUT+(K+1)*DRR 
WRITE(109,109)R1,GRRT(IK,K,:)
!WRITE(110,109)R1,GRRT(0:IK,K,2)
!WRITE(111,109)R1,GRRT(0:IK,K,3)
END DO
END DO
109 FORMAT(F10.5,10000(E17.7,1x))
DEALLOCATE(GRRT,DR,BIN)
END SUBROUTINE

SUBROUTINE CALCULATE_FREE(IIFREE)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::IIFREE
DOUBLE PRECISION,DIMENSION(NNTYPE(IIFREE),3)::DRT
DOUBLE PRECISION,DIMENSION(NNTYPE(IIFREE))::DDRT
INTEGER::NORIGIN
!DOUBLE PRECISION,DIMENSION(64,3)::NPOS
INTEGER,DIMENSION(10000)::OCCUPY,OCCUPYX,OCCUPYY,OCCUPYZ
INTEGER::IDDRT,IDDRTX,IDDRTY,IDDRTZ
DOUBLE PRECISION::KB
KB=8.61732814974493E-05 
PRINT*,'I M CALC FREE'
OPEN(125,FILE="PROB_R_FREE_ENERGY")
OPEN(126,FILE="FREE_ENERGY")
OCCUPY=1
OCCUPYX=1
OCCUPYY=1
OCCUPYZ=1

DDRT=0
DRT=0
DO I=SUM(NNTYPE(1:IIFREE-1))+1,SUM(NNTYPE(1:IIFREE))  !152
!AVG(I,:)=SUM(POS(43:50,I,:),DIM=1)/8     
!DO J=129,165
       DO IT=1,IREF2-IREF1+1
       IDDRT=0
       DRT(1,:)= MATMUL( POS(IT,I,:) -POS(1,I,:) ,ISLAT)   
       DRT(1,:)=MATMUL(DRT(1,:),SLAT)
       DDRT=NORM2(DRT(1,:))
       IDDRT=INT(DDRT(1)/0.01)
       IDDRTX=INT(ABS(DRT(1,1))/0.01)
       IDDRTY=INT(ABS(DRT(1,2))/0.01)
       IDDRTZ=INT(ABS(DRT(1,3))/0.01)
       IF(IDDRT.NE.0.AND.IDDRT.LE.10000) OCCUPY(IDDRT)=OCCUPY(IDDRT)+1
       IF(IDDRTX.NE.0.AND.IDDRTX.LE.10000) OCCUPYX(IDDRTX)=OCCUPYX(IDDRTX)+1
       IF(IDDRTY.NE.0.AND.IDDRTY.LE.10000) OCCUPYY(IDDRTY)=OCCUPYY(IDDRTY)+1
       IF(IDDRTZ.NE.0.AND.IDDRTZ.LE.10000) OCCUPYZ(IDDRTZ)=OCCUPYZ(IDDRTZ)+1
        END DO
!AUSE
!END DO
END DO

PRINT*,'TEMPERATURE is ', TEMPER
DO I=1,2000
WRITE(125,125)REAL(I)*0.01,OCCUPY(I),OCCUPYX(I),OCCUPYY(I),OCCUPYZ(I)
WRITE(126,126)REAL(I)*0.01,-KB*TEMPER*log(REAL(OCCUPY(I))),-KB*TEMPER*log(REAL(OCCUPYX(I))),-KB*TEMPER*log(REAL(OCCUPYY(I))),-KB*TEMPER*log(REAL(OCCUPYZ(I)))

!WRITE(126,125)REAL(I)*0.01,OCCUPY(I)
125 FORMAT(F10.5,64I10)
126 FORMAT(F10.5,64E15.5)
END DO
END SUBROUTINE

SUBROUTINE GRRFN2LAMMPSNW

use omp_lib
USE VARIABLES1
IMPLICIT NONE
!DOUBLE PRECISION,DIMENSION(NATOM,3)::POSF
DOUBLE PRECISION,DIMENSION(NATOm,3)::AA
DOUBLE PRECISION::MODA
DOUBLE PRECISION,DIMENSION(NATOM,NATOM)::GRR
DOUBLE PRECISION,DIMENSION(1000,NTYP,NTYP)::GRRT
DOUBLE PRECISION::R1,R2
INTEGER::IDR
INTEGER::K1,K2,K3,K4
!DOUBLE PRECISION,DIMENSION(NATOM,27,3)::SPOS
INTEGER::NS,INS,NX,NY,NZ,I1
DOUBLE PRECISION::DV,AREA,XD,YD,ZD
DOUBLE PRECISION,DIMENSION(NATOM)::AMODA
AA=0
PRINT*, "I M IN GRRFN LAMPPS2 NW"
PRINT*,IT
WRITE(111,*)'# TIME=IT,LL',IT,LL
GRRT=0
DO IDR=1,NR
   R1=((IDR-1)*DELR)+R0
   R2=((IDR)*DELR)+R0
   RM=(R1+R2)*0.5
   GRR=0
!$omp parallel do
   DO I=1,NATOM
      DO J=I,NATOM
           
            AA(I,:)= RR1(I,:)-RR1(J,:)  !POS(IT,I,:)-POS(IT,J,:)
	    WHERE(AA(I,:).LE.-0.5)AA(I,:)=AA(I,:)+1
	    WHERE(AA(I,:).gE.0.5)AA(I,:)=AA(I,:)-1
            !AA(I,:)=MATMUL(TRANSPOSE(SLAT),AA(I,:))                       !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!CHECK
            AA(I,:)=MATMUL(AA(I,:),SLAT)                       !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!CHECK
            AMODA(I)=NORM2(AA(I,:))
            IF(AMODA(I).GT.R1.AND.AMODA(I).LE.R2)GRR(I,J)=GRR(I,J)+1
102       FORMAT(F3.1,2I4,F5.1)
          GRR(J,I)=GRR(I,J)
          GRTOTAL(IDR)=GRTOTAL(IDR)+ 4*CBBT(I)*CBBT(J)*GRR(I,J)/(CBBT(I)+CBBT(J))**2
      END DO
   END DO
!$omp end parallel do

   DO I=1,NTYP
      DO J=1,NTYP
        K1=SUM(NNTYPE(1:I-1))+1
        K2=SUM(NNTYPE(1:I))
        K3=SUM(NNTYPE(1:J-1))+1
        K4=SUM(NNTYPE(1:J))
        GRRT(IDR,I,J)=SUM(GRR(K1:K2,K3:K4))
        GRRT(IDR,I,J)=GRRT(IDR,I,J)/((K2-k1+1))
!        GRRT(IDR,J,I)=GRRT(IDR,I,J)
        END DO
   END DO
!!!!!$omp parallel do
!!!!$omp end parallel do
   AREA=4.0*PI*(RM**2)
   DV=AREA*DELR
   GRRT(IDR,:,:)=GRRT(IDR,:,:)/DV
   !GRTOTAL(IDR)=SUM(GRR(:,:))/(DV*NATOM)
   GRTOTAL(IDR)=GRTOTAL(IDR)/(DV*NATOM)
   WRITE(111,11)RM ,((GRRT(IDR,I,J),J=I,NTYP),I=1,NTYP),GRTOTAL(IDR) !,SUM(GRRT(IDR,:,:))
   11 FORMAT(F6.3,2x,100F8.4)
  ! WRITE(101,101)IDR*DELR, (INT((GRR(1,I1))),I1=1,64)
   101 format (F4.1,100I3)
END DO
!!!!!!!!!!!!!!!!!!
DO IDR=1,NR
   DO I=1,NTYP
      DO J=1,NTYP
      GRRTAVG(IDR,I,J)=GRRTAVG(IDR,I,J)+GRRT(IDR,I,J)
      END DO
   END DO
      GAVG(IDR)=GAVG(IDR)+GRTOTAL(IDR)
END DO
END SUBROUTINE



SUBROUTINE ADP
USE VARIABLES1
use omp_lib
IMPLICIT NONE
INTEGER::I1,IBAC,IFOR,II1
INTEGER::M
DOUBLE PRECISION::POSINT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::ADPX,ADPY,ADPZ
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::ADPXX,ADPXY,ADPXZ,ADPYY,ADPYZ,ADPZZ
ALLOCATE(ADPX(NATOM,NSTEPORIG))
ALLOCATE(ADPY(NATOM,NSTEPORIG))
ALLOCATE(ADPZ(NATOM,NSTEPORIG))
ALLOCATE(ADPXX(NTYP))
ALLOCATE(ADPXY(NTYP))
ALLOCATE(ADPXZ(NTYP))
ALLOCATE(ADPYY(NTYP))
ALLOCATE(ADPYZ(NTYP))
ALLOCATE(ADPZZ(NTYP))
PRINT*, 'THE ADP IS AVERAGED FOR', NSTEP
OPEN(1235,FILE="ADP_MATRIX")
DO I=1,NATOM
!PRINT*, 'ATOM NO',I,'has been done'
                ADPX(I,:)=POS(1:IREF2-IREF1+1,I,1)-SPREAD(POS(1,I,1),1,IREF2-IREF1+1)
                ADPY(I,:)=POS(1:IREF2-IREF1+1,I,2)-SPREAD(POS(1,I,2),1,IREF2-IREF1+1)
                ADPZ(I,:)=POS(1:IREF2-IREF1+1,I,3)-SPREAD(POS(1,I,3),1,IREF2-IREF1+1)

END DO

DO I=1,NTYP
N1=SUM(NNTYPE(1:I-1))+1
N2=SUM(NNTYPE(1:I))
PRINT*,N1,N2
!ADPXX(I)=DOT_PRODUCT(ADPX(N1:N2,:),ADPX(N1:N2,:))
!ADPXY(I)=DOT_PRODUCT(ADPX(N1:N2,:),ADPY(N1:N2,:))
!ADPXZ(I)=DOT_PRODUCT(ADPX(N1:N2,:),ADPZ(N1:N2,:))
!ADPYY(I)=DOT_PRODUCT(ADPY(N1:N2,:),ADPY(N1:N2,:))
!ADPYZ(I)=DOT_PRODUCT(ADPY(N1:N2,:),ADPZ(N1:N2,:))
!ADPZZ(I)=DOT_PRODUCT(ADPZ(N1:N2,:),ADPZ(N1:N2,:))
ADPXX(I)=SUM(ADPX(N1:N2,:)*ADPX(N1:N2,:))/(IREF2-IREF1+1)/NNTYPE(I)
ADPXY(I)=SUM(ADPX(N1:N2,:)*ADPY(N1:N2,:))/(IREF2-IREF1+1)/NNTYPE(I)
ADPXZ(I)=SUM(ADPX(N1:N2,:)*ADPZ(N1:N2,:))/(IREF2-IREF1+1)/NNTYPE(I)
ADPYY(I)=SUM(ADPY(N1:N2,:)*ADPY(N1:N2,:))/(IREF2-IREF1+1)/NNTYPE(I)
ADPYZ(I)=SUM(ADPY(N1:N2,:)*ADPZ(N1:N2,:))/(IREF2-IREF1+1)/NNTYPE(I)
ADPZZ(I)=SUM(ADPZ(N1:N2,:)*ADPZ(N1:N2,:))/(IREF2-IREF1+1)/NNTYPE(I)

PRINT*,'ADPMATRIX'
WRITE(1235,*)ATMNM(I)
WRITE(1235,1235)ADPXX(I),ADPXY(I),ADPXZ(I)
WRITE(1235,1235)ADPXY(I),ADPYY(I),ADPYZ(I)
WRITE(1235,1235)ADPXZ(I),ADPYZ(I),ADPZZ(I)
WRITE(1235,*)
1235 FORMAT(3F15.6)
END DO

DEALLOCATE(ADPX,ADPY,ADPZ,ADPXX,ADPXY,ADPXZ,ADPYY,ADPYZ,ADPZZ)

END SUBROUTINE

SUBROUTINE DIFFRACTION !(R,SMAT2)
USE VARIABLES2
USE VARIABLES1
USE omp_lib
IMPLICIT NONE
INTEGER::NSKIP,intindex
complex,allocatable,dimension(:)::intens
double precision::deldmax,dmax,fwhmd
double precision,allocatable,dimension(:)::dummy1,dummy2
!OPEN(11,FILE="INP_STF")
PRINT*, "I M IN DIFFRACTION"
INTENSITY=0
21 FORMAT(3F20.5)
PI=4.0*ATAN(1.0)
INTDIM=(2*HMAX+1)*(2*KMAX+1)*(2*LMAX+1)
!ALLOCATE(SPOS(NSIZE*NSIZE*NSIZE*NATOM,3))
ALLOCATE(DHKL(INTDIM),QQ(INTDIM),INTENSITY(INTDIM))
ALLOCATE(HKL(INTDIM,3),FHKL(INTDIM))

ALAT=NORM2(AVGSLAT(1,:))
BLAT=NORM2(AVGSLAT(2,:))
CLAT=NORM2(AVGSLAT(3,:))
AANGLE(1)=DOT_PRODUCT(AVGSLAT(2,:),AVGSLAT(3,:))/(BLAT*CLAT)
AANGLE(2)=DOT_PRODUCT(AVGSLAT(3,:),AVGSLAT(1,:))/(CLAT*ALAT)
AANGLE(3)=DOT_PRODUCT(AVGSLAT(1,:),AVGSLAT(2,:))/(ALAT*BLAT)
PRINT*,'STRUCTURE PARAMETERS' 
PRINT*,ALAT,BLAT,CLAT,180*ACOS(AANGLE)/PI
!PAUSE
DO I=1,NTYP
DO J=SUM(NNTYPE(1:I-1))+1,SUM(NNTYPE(1:I))
BB(J)=BBT(I) !/(4*PI))
END DO
END DO
NSKIP=10
PRINT*,'DIFFRACTION WILL BE CALUATED FROM', IREF1,'to',IREF2
!DO IT=IREF1,IREF2 !,NSKIP
II=0
DO H=-HMAX,HMAX
        DO K=-KMAX,KMAX
                DO L=-LMAX,LMAX
        IF(ABS(H)+ABS(K)+ABS(L).NE.0)THEN
                        II=II+1
                        HKL(II,:)=(/REAL(H),REAL(K),REAL(L)/)
                        CALL DDHKL  !(HKL(II,:))
                        DHKL(II)=DPLANE
                       ! PRINT*,DHKL(II)

                        !$omp parallel do
                        DO I=1,NATOM
                                RR1(I,:)=MATMUL(SUM(POS(1:IREF2-IREF1+1,I,:),DIM=1)/(IREF2-IREF1+1),ISLAT )
                                PHI=2.0*PI*DOT_PRODUCT(RR1(I,:),HKL(II,:))
                                FHKL(II)=FHKL(II)+BB(I)*(CMPLX(COS(PHI),SIN(PHI))) !/(IREF2-IREF1+1)
                        END DO
                        INTENSITY(II)=ABS(FHKL(II))**2
                        QCART=2.0*PI*MATMUL(HKL(II,:),ISLAT)
                        QQ(II)=NORM2(QCART)
                        2 FORMAT(1000(F16.4,1X))
        END IF
                        END DO
        END DO
END DO
!END DO
DO I=1,NATOM
WRITE(132,132)RR1(I,:)
132 FORMAT(3F15.6)
END DO
NMAX=II
!dmax=INT(MAXVAL(DHKL))
deldmax=20.0/2000
ALLOCATE(intens(2000))
intens=0
DO II=1,NMAX
INTINDEX=INT(2000*DHKL(II)/20.0)
if(INTINDEX.le.2000)intens(intindex)=intens(intindex)+ABS(FHKL(II))**2
!intens(intindex)=intens(intindex)+FHKL(II) !)**2
END DO
DO II=1,NMAX
IF(ABS(QQ(II)).GT.0.0001) WRITE(131,2) QQ(II),HKL(II,:), DHKL(II), FHKL(II),ABS(FHKL(II))**2 !INTENSITY(II)
END DO
!DUMMY1=REAL(intens)**2
ALLOCATE(DUMMY1(2000),DUMMY2(2000))
DUMMY1=intens
FWHMD=0.02
CALL BROAD_DIFF(FWHMD,DUMMY1,DUMMY2)
WRITE(130,*)'#Dhkl Qhkl I'
DO II=1,500
!WRITE(130,2)II*deldmax,REAL(intens(II))**2  ! QQ(II),HKL(II,:), DHKL(II),
!FHKL(II), ABS(FHKL(II))**2 !INTENSITY(II)
WRITE(130,2)II*deldmax,(2*PI/deldmax/II),DUMMY2(II) !REAL(intens(II))**2  ! QQ(II),HKL(II,:), DHKL(II), FHKL(II), ABS(FHKL(II))**2 !INTENSITY(II)
END DO
!close(131)
CALL SYSTEMQQ('sort -r  -n -k 5 fort.131 >HKL')
END  SUBROUTINE

SUBROUTINE BROAD_DIFF(FWHM00,AAA,BBB)
USE VARIABLES1
IMPLICIT NONE
!DOUBLE PRECISION,DIMENSION(NDOS)::AAA,BBB
DOUBLE PRECISION::FWHM00
DOUBLE PRECISION::R1,R2,R3,XX
DOUBLE PRECISION::ESTEP,ESTART
INTEGER::IGAIN,IRESOLUTION,ISIG
DOUBLE PRECISION::DELX,BROAD,SUMM
DOUBLE PRECISION::SIG,ANORMFACTOR,S1,S2
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::AAA,BBB
ALLOCATE(AAA(2000),BBB(2000))
!@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@APPLY BROADENNING IN
!NEUTRON WEIGTED DOS@@@@@@@@@@@@@@@@@@@@@@@@@@@@
!CALL BROAD(TOTAL_NEUTRON_DOS,BROAD_DOS,FWHM,NSTEP)
BBB=0
                 FWHM=FWHM00
         DO I=1,2000
                 SIG=FWHM/(2*1.1774)
                 ISIG=2*SIG+1
                 IF(FWHM.NE.0.0)S2= 0.5/SIG**2
                 BBB(I)=AAA(I) !!!!!!!!!!!!!!!!!!!!!!!!!HALT
                 IF(FWHM==0.0)GO TO 12
                 BBB(I)=0.0
                 SUMM=0
                 DO  J=-ISIG,ISIG
                 K=I+J
                 IF(K.LE.0)K=1
                 !IF(K.GT.NDOS)K=NDOS
                 S1=-S2*J**2
                 S1=DEXP(S1)
                 BBB(I)=BBB(I)+AAA(K)*S1
                 SUMM=SUMM+S1
                 END DO
12              CONTINUE
                 BBB(I)=BBB(I)/SUMM
         END DO
                                      ANORMFACTOR=SUM(BBB(:)*DELE)
                                       BBB=BBB/ANORMFACTOR
ANORMFACTOR=SUM(BBB(:)*dele)
8 FORMAT(F10.4,4X,F15.8)
DEALLOCATE(AAA,BBB)
END SUBROUTINE

SUBROUTINE DIFFUSE2022N  !(IIREF)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::NX,NY,NZ !,IIREF
INTEGER::I1,I2,ID1,ID2,ID3
INTEGER::NNN1,NNN2
COMPLEX,DIMENSION(IQMAX,NTYP)::DIFF2TT
!$ call omp_set_num_threads(num_threads)
102 FORMAT(3F20.15)
103 FORMAT(10A3)
QQQ2=MATMUL(ISLAT,QQQ2)
!QQQ2=MATMUL(QQQ2,ISLAT)



        DO ITYP=1,NTYP
        NNN1=SUM(NNTYPE(1:ITYP-1))+1
        NNN2=SUM(NNTYPE(1:ITYP))

        !$OMP PARALLEL PRIVATE(DIFF2TT) SHARED(DIFF2T) 
        DIFF2TT(:,ITYP)=0
        DIFF2T(:,ITYP)=0

        !$OMP DO
        DO IT=1,IREF2-IREF1+1,INTERVAL
        PRINT*,'Diffuse IT',IT
        DIFF2TT(:,ITYP )=  CMPLX( SUM( COS(2.0*PI*MATMUL(POS(IT,NNN1:NNN2,:) ,  QQQ2)),DIM=1),SUM(SIN(2.0*PI*MATMUL( POS(IT,NNN1:NNN2,:),QQQ2)),DIM=1)   ) 
        END DO
        !$OMP END DO

        !$OMP CRITICAL
        DIFF2T(:,ITYP)=DIFF2T(:,ITYP)+ DIFF2TT(:,ITYP)
        !$OMP END CRITICAL

        !$OMP END PARALLEL
        END DO
104 FORMAT(3F10.2,2E15.5)
QQQ2=MATMUL(SLAT,QQQ2)


        OPEN(104,FILE='Neutron.txt')
        OPEN(105,FILE='X_Ray.txt')
        OPEN(106,FILE='Unweighted')
        WRITE(104,*)'#',IT
        WRITE(105,*)'#',IT
        WRITE(106,*)'#',IT
        DO ID1=1,IQMAX !ABS(nmax11-nmax12)+1 * ABS(nmax21-nmax22)+1 *  ABS(nmax31-nmax32)+1
        WRITE(104,106)NINT(QQQ2(:,ID1)), ABS(SUM(BBT(1:NTYP)*DIFF2T(ID1,1:NTYP))), ABS(BBT(1:NTYP)*DIFF2T(ID1,1:NTYP))
        WRITE(105,106)NINT(QQQ2(:,ID1)), ABS(SUM( ZELE(1:NTYP)*DIFF2T(ID1,1:NTYP))), ABS(ZELE(1:NTYP)*DIFF2T(ID1,1:NTYP))
        WRITE(106,106)NINT(QQQ2(:,ID1)), ABS(SUM(DIFF2T(ID1,1:NTYP))),ABS(DIFF2T(ID1,1:NTYP))
        END DO
        CLOSE(104)
        CLOSE(105)
        CLOSE(106)



OPEN(101,FILE="UNWEIGHTED.vasp")
WRITE(101,*)'COMMENT PROBABILITY DENSITY'
WRITE(101,*)'1.0'
WRITE(101,*)ABS(NMAX11-NMAX12)+1,'0 0 ' 
WRITE(101,*)'0', ABS(NMAX21-NMAX22)+1,'0' 
WRITE(101,*)'0 0',ABS(NMAX31-NMAX32)+1 
WRITE(101,103)'C'   
WRITE(101,*)'1'    
WRITE(101,*)'D' 
WRITE(101,*)'0 0 0'
WRITE(101,*)
WRITE(101,*)ABS(NMAX11-NMAX12)+1,ABS(NMAX21-NMAX22)+1,ABS(NMAX31-NMAX32)+1  
WRITE(101,101)    (   ABS(DIFF2T(ID1,1:NTYP)) , ID1=1, IQMAX )                 


OPEN(102,FILE="NEUTRON.vasp")
WRITE(102,*)'COMMENT PROBABILITY DENSITY'
WRITE(102,*)'1.0'
WRITE(102,*)ABS(NMAX11-NMAX12)+1,'0 0 ' 
WRITE(102,*)'0', ABS(NMAX21-NMAX22)+1,'0' 
WRITE(102,*)'0 0',ABS(NMAX31-NMAX32)+1 
WRITE(102,103)'C'   
WRITE(102,*)'1'    
WRITE(102,*)'D' 
WRITE(102,*)'0 0 0'
WRITE(102,*)
WRITE(102,*)ABS(NMAX11-NMAX12)+1,ABS(NMAX21-NMAX22)+1,ABS(NMAX31-NMAX32)+1  
WRITE(102,101)    (   ABS(DOT_PRODUCT(BBT(1:NTYP), DIFF2T(ID1,1:NTYP))) , ID1=1, IQMAX )


OPEN(103,FILE="X_RAY.vasp")
WRITE(103,*)'COMMENT PROBABILITY DENSITY'
WRITE(103,*)'1.0'
WRITE(103,*)ABS(NMAX11-NMAX12)+1,'0 0 ' 
WRITE(103,*)'0', ABS(NMAX21-NMAX22)+1,'0' 
WRITE(103,*)'0 0',ABS(NMAX31-NMAX32)+1 
WRITE(103,103)'C'   
WRITE(103,*)'1'    
WRITE(103,*)'D' 
WRITE(103,*)'0 0 0'
WRITE(103,*)
WRITE(103,*)ABS(NMAX11-NMAX12)+1,ABS(NMAX21-NMAX22)+1,ABS(NMAX31-NMAX32)+1  
WRITE(103,101)    (   ABS(DOT_PRODUCT(ZELE(1:NTYP), DIFF2T(ID1,1:NTYP))) , ID1=1, IQMAX )


101 FORMAT(5E12.5)



!
!
!ENDIF
106 FORMAT(3I8,100E15.6)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!DEALLOCATE(QQQ2)
END SUBROUTINE




SUBROUTINE DIFFUSE2022NN  !(IIREF)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::NX,NY,NZ !,IIREF
INTEGER::I1,I2,ID1,ID2,ID3
INTEGER::NNN1,NNN2
!COMPLEX,DIMENSION(IQMAX,NTYP)::DIFF2TT
!$ call omp_set_num_threads(num_threads)
102 FORMAT(3F20.15)
103 FORMAT(10A3)
QQQ2=MATMUL(ISLAT,QQQ2)

DIFF2T=0
        DO IT=1,IREF2-IREF1+1,INTERVAL
        PRINT*,'Diffuse IT',IT
        DO ITYP=1,NTYP
        NNN1=SUM(NNTYPE(1:ITYP-1))+1
        NNN2=SUM(NNTYPE(1:ITYP))
        DIFF2T(:,ITYP )= DIFF2T(:,ITYP)+ CMPLX( SUM( COS(2.0*PI*MATMUL(POS(IT,NNN1:NNN2,:) ,  QQQ2)),DIM=1),SUM(SIN(2.0*PI*MATMUL( POS(IT,NNN1:NNN2,:),QQQ2)),DIM=1)   ) 
        END DO
104 FORMAT(3F10.2,2E15.5)
!QQQ2=MATMUL(SLAT,QQQ2)


        OPEN(104,FILE='Neutron.txt')
        OPEN(105,FILE='X_Ray.txt')
        OPEN(106,FILE='Unweighted')
        WRITE(104,*)'#',IT
        WRITE(105,*)'#',IT
        WRITE(106,*)'#',IT
        DO ID1=1,IQMAX !ABS(nmax11-nmax12)+1 * ABS(nmax21-nmax22)+1 *  ABS(nmax31-nmax32)+1
        WRITE(104,106)NINT(QQQ2(:,ID1)), ABS(SUM(BBT(1:NTYP)*DIFF2T(ID1,1:NTYP))), ABS(BBT(1:NTYP)*DIFF2T(ID1,1:NTYP))
        WRITE(105,106)NINT(QQQ2(:,ID1)), ABS(SUM( ZELE(1:NTYP)*DIFF2T(ID1,1:NTYP))), ABS(ZELE(1:NTYP)*DIFF2T(ID1,1:NTYP))
        WRITE(106,106)NINT(QQQ2(:,ID1)), ABS(SUM(DIFF2T(ID1,1:NTYP))),ABS(DIFF2T(ID1,1:NTYP))
        END DO
        CLOSE(104)
        CLOSE(105)
        CLOSE(106)
END DO


OPEN(101,FILE="UNWEIGHTED.vasp")
WRITE(101,*)'COMMENT PROBABILITY DENSITY'
WRITE(101,*)'1.0'
WRITE(101,*)ABS(NMAX11-NMAX12)+1,'0 0 ' 
WRITE(101,*)'0', ABS(NMAX21-NMAX22)+1,'0' 
WRITE(101,*)'0 0',ABS(NMAX31-NMAX32)+1 
WRITE(101,103)'C'   
WRITE(101,*)'1'    
WRITE(101,*)'D' 
WRITE(101,*)'0 0 0'
WRITE(101,*)
WRITE(101,*)ABS(NMAX11-NMAX12)+1,ABS(NMAX21-NMAX22)+1,ABS(NMAX31-NMAX32)+1  
WRITE(101,101)    (   ABS(DIFF2T(ID1,1:NTYP)) , ID1=1, IQMAX )                 


OPEN(102,FILE="NEUTRON.vasp")
WRITE(102,*)'COMMENT PROBABILITY DENSITY'
WRITE(102,*)'1.0'
WRITE(102,*)ABS(NMAX11-NMAX12)+1,'0 0 ' 
WRITE(102,*)'0', ABS(NMAX21-NMAX22)+1,'0' 
WRITE(102,*)'0 0',ABS(NMAX31-NMAX32)+1 
WRITE(102,103)'C'   
WRITE(102,*)'1'    
WRITE(102,*)'D' 
WRITE(102,*)'0 0 0'
WRITE(102,*)
WRITE(102,*)ABS(NMAX11-NMAX12)+1,ABS(NMAX21-NMAX22)+1,ABS(NMAX31-NMAX32)+1  
WRITE(102,101)    (   ABS(DOT_PRODUCT(BBT(1:NTYP), DIFF2T(ID1,1:NTYP))) , ID1=1, IQMAX )


OPEN(103,FILE="X_RAY.vasp")
WRITE(103,*)'COMMENT PROBABILITY DENSITY'
WRITE(103,*)'1.0'
WRITE(103,*)ABS(NMAX11-NMAX12)+1,'0 0 ' 
WRITE(103,*)'0', ABS(NMAX21-NMAX22)+1,'0' 
WRITE(103,*)'0 0',ABS(NMAX31-NMAX32)+1 
WRITE(103,103)'C'   
WRITE(103,*)'1'    
WRITE(103,*)'D' 
WRITE(103,*)'0 0 0'
WRITE(103,*)
WRITE(103,*)ABS(NMAX11-NMAX12)+1,ABS(NMAX21-NMAX22)+1,ABS(NMAX31-NMAX32)+1  
WRITE(103,101)    (   ABS(DOT_PRODUCT(ZELE(1:NTYP), DIFF2T(ID1,1:NTYP))) , ID1=1, IQMAX )


101 FORMAT(5E12.5)



!
!
!ENDIF
106 FORMAT(3I8,100E15.6)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!DEALLOCATE(QQQ2)
END SUBROUTINE


!!!!!!!!!!!!UPDATE POLY PROGRAM PREVISOUS VERSION HAD BUG
SUBROUTINE POLYN2021
use omp_lib
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(3)::DDD
DOUBLE PRECISION,DIMENSION(NNTYPE(CATOM),NCORD)::ANGLETHETA,ANGLEPHI,DDDD
!!!!!!the last index 4 due to tetrahedral cordination
DOUBLE PRECISION,DIMENSION(NNTYPE(CATOM),NCORD)::REFTHETA,REFPHI !!!!!!the lastindex 4 due to tetrahedral cordination
DOUBLE PRECISION::RXY
INTEGER,DIMENSION(500,NCORD)::BDIST
DOUBLE PRECISION::RTOPI
INTEGER::JJJJ,JK,IR,JKK,ISATOM
DOUBLE PRECISION::D2,DR1,DR2
DOUBLE PRECISION::PROJ1,PROJ2,TWOPI
DOUBLE PRECISION,DIMENSION(3,3)::IAXIS
DOUBLE PRECISION::X,Y,Z,R
DOUBLE PRECISION,DIMENSION(3,3)::NEWLAT
INTEGER::MATOM,JCu,ICAP
INTEGER,DIMENSION(1000)::INDEXI
INTEGER::MAXCAP,JTAG !,NCORD
DOUBLE PRECISION::AVGBOND
DOUBLE PRECISION,DIMENSION(NNTYPE(CATOM))::DISTORTION
REAL::RSEARCH
REAL,DIMENSION(3)::XYZ
REAL,DIMENSION(NNTYPE(CATOM),0:90,0:180)::PROBDENSITY
!REAL,DIMENSION(1,0:180,0:360)::PROBDENSITY
INTEGER::J1,I1
INTEGER,DIMENSION(NATOM,12,3)::PICK
REAL::RIJ,RJK
INTEGER::NC1,NK,NS1,NS2
DOUBLE PRECISION,DIMENSION(3)::AA
OPEN(4100,FILE="ANGLETHETA.DAT")
OPEN(4101,FILE="ANGLEPHI.DAT")
OPEN(4102,FILE="BONDLENGTHS.DAT")
OPEN(4103,FILE="BONDLENGTHDISTRIBUTION.DAT")
OPEN(4105,FILE="MOVINGIONINDEX.DAT")
OPEN(4106,FILE="DISTORTION.DAT")
OPEN(5000,FILE="PROBDENSITY_THETA_PHI")
!PAUSE
PRINT*,'I M IN POLYN'
PRINT*,CATOM,SATOM
PROBDENSITY=0
RSEARCH=4.0
MATOM=1
PRINT*,'MOBILE ATOM IS 1 and RSEARCH iS ', RSEARCH
MAXCAP=10
RTOPI=180/(4*ATAN(1.0))  !3.14
PI=4*ATAN(1.0)
TWOPI=8*ATAN(1.0)
AX3(1)=AX1(2)*AX2(3)-AX1(3)*AX2(2)
AX3(2)=AX1(3)*AX2(1)-AX1(1)*AX2(3)
AX3(3)=AX1(1)*AX2(2)-AX1(2)*AX2(1)
IAXIS(1,:)=AX1/NORM2(AX1)
IAXIS(2,:)=AX2/NORM2(AX2)
IAXIS(3,:)=AX3/NORM2(AX3)
NEWLAT=MATMUL(IAXIS,SLAT)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
ISLATORIG=ISLAT
SLATORIG=SLAT
DO I1=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
NC1=0
NK=0
   DO J1=SUM(NNTYPE(1:SATOM-1))+1,SUM(NNTYPE(1:SATOM))   !,NNTYPE(CATOM)
                AA=POS(1 ,I1,:)-POS(1 ,J1,:)
                !AA=MATMUL(ISLATORIG,AA)
                AA=MATMUL(AA,ISLATORIG)
                WHERE(AA.LT.-0.5)AA=AA+1
                WHERE(AA.GT.0.5)AA=AA-1
                !RIJ=NORM2(MATMUL(SLATORIG,AA))
                RIJ=NORM2(MATMUL(AA,SLATORIG))
                IF(RIJ.GT.0.AND.RIJ.LE.BOND)THEN
                 NC1=NC1+1       !!!!!!!!CORDINATION1
                 IF(NC1.GT.NCORD)EXIT
                 NK=NK+1
                 PICK(I1,NK,1)=I1
                 PICK(I1,NK,2)=J1
                END IF
        END DO
END DO
PRINT*,NK
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                    IT=1
                    DO I1=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))
!MATOM MOBILE ATOM NEAR Polyhedral centre
                    INDEX1=0
                    PRINT*,I1 !ICAP
                    ICAP=0
                    DO J1=SUM(NNTYPE(1:MATOM-1))+1,SUM(NNTYPE(1:MATOM))
!MATOM MOBILE ATOM NEAR Polyhedral centre
                    DDD=POS(IT,I1,:)-POS(IT,J1,:)
                    !DDD=MATMUL(ISLATORIG,DDD)
                    DDD=MATMUL(DDD,ISLATORIG)
!!!!!!!!FRACTIONAL POSITION
                     IF(DDD(1).LT. -0.5)DDD(1)=DDD(1)+1
                     IF(DDD(2).LT. -0.5)DDD(2)=DDD(2)+1
                     IF(DDD(3).LT. -0.5)DDD(3)=DDD(3)+1
                     IF(DDD(1).gT.  0.5)DDD(1)=DDD(1)-1
                     IF(DDD(2).gT.  0.5)DDD(2)=DDD(2)-1
                     IF(DDD(3).gT.  0.5)DDD(3)=DDD(3)-1
                    !DDD=MATMUL(SLATORIG,DDD)
                    DDD=MATMUL(DDD,SLATORIG)
!!!!!!!!FRACTIONAL POSITION
                    IF(NORM2(DDD).LT.RSEARCH)THEN
                    ICAP=ICAP+1
                    INDEXI(ICAP)=J1
                    END IF
                    END DO
                    !PAUSE
                    WRITE(4105,2105)INDEXI(1:MAXCAP)
                    2105 FORMAT(100I10)
                    END DO
                   !END IF
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
DO IT=1,(IREF2-IREF1)+1,INTERVAL2
  JJJJ=0
  JTAG=0
  DO J=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
   JTAG=JTAG+1         !!!!!!!!!EQUIVALENT TO RUN OVER J
   JJJJ=JJJJ+1
   !SEARCH SURROUNDING ATOM FOR TETRAHEDRAL OR POLYHEDRAL
   JK=0
   DO JK=1,NK  !SUM(NNTYPE(1:SATOM-1))+1,SUM(NNTYPE(1:SATOM))   !,NNTYPE(CATOM)
    DDD=(POS(IT,J,:)-POS(IT,PICK(J,JK,2),:))
    !DDD=MATMUL(ISLATORIG,DDD)                           !!!!!!!!FRACTIONAL POSITION
    DDD=MATMUL(DDD,ISLATORIG)                           !!!!!!!!FRACTIONAL POSITION
    WHERE(DDD.LT.-0.5)DDD=DDD+1.0
    WHERE(DDD.GT.0.5)DDD=DDD-1.0
    XYZ=MATMUL(DDD,NEWLAT)
    X=XYZ(1)
    Y=XYZ(2)
    Z=XYZ(3)
    D2=NORM2(XYZ)
      DDDD(JTAG,JK)=D2  !NORM2(DDD)
      RXY=SQRT(Y*Y + Z*Z)
      ANGLETHETA(JJJJ,JK)=ACOS(X/D2)
      IF(RXY==0)THEN
      ANGLEPHI(JJJJ,JK)=0
      ELSE
      ANGLEPHI(JJJJ,JK)=ACOS(Y/rxy)
      IF(Y.GT.0.AND.Z.LT.0)ANGLEPHI(JJJJ,JK)=ANGLEPHI(JJJJ,JK)+ 3*TWOPI/4.0
      IF(Y.LT.0.AND.Z.LT.0)ANGLEPHI(JJJJ,JK)=ANGLEPHI(JJJJ,JK)+ TWOPI/4.0
      END IF
        !!!!!!!!!       PROBABILITY DENSITY FUNCTION!!!!!!!!!!!!!!!!
        IF(ANGLETHETA(JJJJ,JK).GT.0.AND.ANGLEPHI(JJJJ,JK).GT.0)THEN
        PROBDENSITY(JTAG,INT(ANGLETHETA(JJJJ,JK)*RTOPI/2.0),INT(ANGLEPHI(JJJJ,JK)*RTOPI/2.0))=PROBDENSITY(JTAG,INT(ANGLETHETA(JJJJ,JK)*RTOPI/2.0),INT(ANGLEPHI(JJJJ,JK)*RTOPI/2.0))+1
        END IF
        !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
   END DO                !SURROUNDING SERACH ENDS
    AVGBOND=SUM(DDDD(JJJJ,:))/NCORD !JK
    DISTORTION(JTAG)=SQRT(DOT_PRODUCT(DDDD(JTAG,:),DDDD(JTAG,:))-NCORD*AVGBOND*AVGBOND)
    DISTORTION(JTAG)=DISTORTION(JTAG)/(NCORD*AVGBOND*AVGBOND)
!!!!!!!!!!BOND DISTRIBUTION!!!!!!!!!!!!!
    DO IR=1,500
    DR1=DR0+(IR-1)*RSTEP
    DR2=DR0+IR*RSTEP
     DO JKK=1,NCORD  !JK
     IF(DDDD(JJJJ,JKK).GT.DR1 .AND.DDDD(JJJJ,JKK).LE.DR2)BDIST(IR,JKK)=BDIST(IR,JKK)+1
     END DO
   END DO  !!END BOND DISTRI
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  END DO !CENTRE ATOM ENDS HERE
  WRITE(4106,2103)DELT*REAL(IT),DISTORTION(:)
  WRITE(4100,2100)DELT*REAL(IT),(ANGLETHETA(JJJJ,1:NCORD)*RTOPI,JJJJ=1,NNTYPE(CATOM))
  2100 FORMAT(F10.4,10000F7.1)
  WRITE(4101,2100)DELT*REAL(IT),(ANGLEPHI(JJJJ,1:NCORD)*RTOPI,JJJJ=1,NNTYPE(CATOM))
  WRITE(4102,2102)DELT*REAL(IT),(DDDD(JJJJ,1:NCORD),JJJJ=1,NNTYPE(CATOM))
END DO     !!!!!!!!!!!!!!!!TIME ENDS HERE
DO IR=1,500
DR1=DR0+(IR-1)*RSTEP
WRITE(4103,2101)DR1,BDIST(IR,1:NCORD)
END DO
2101 FORMAT(F9.4,10I12)
2102 FORMAT(F9.4,10000F10.3)
2103 FORMAT(F9.4,10000F10.4)
DO J=0,180
DO I=0,90
WRITE(5000,2104) 2*REAL(J),2*REAL(I), ((PROBDENSITY(J1,I,J)/SUM(PROBDENSITY(J1,:,:))), J1=1,NNTYPE(CATOM) )  !X axis is phi and Y axis is theta
2104 FORMAT(1003E16.5)
END DO
END DO
END SUBROUTINE

SUBROUTINE ANGULAR2021
use omp_lib
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(3)::DDD
DOUBLE PRECISION::RXY
INTEGER,DIMENSION(500,NCORD)::BDIST
DOUBLE PRECISION::RTOPI
INTEGER::JJJJ,JK,IR,JKK
DOUBLE PRECISION::D2,DR1,DR2
DOUBLE PRECISION::PROJ1,PROJ2,TWOPI
DOUBLE PRECISION,DIMENSION(3,3)::IAXIS
DOUBLE PRECISION::X,Y,Z,R
DOUBLE PRECISION,DIMENSION(3,3)::NEWLAT
INTEGER::MATOM,JCu,ICAP
INTEGER,DIMENSION(10000)::INDEXI
INTEGER::MAXCAP,JTAG !,NCORD
DOUBLE PRECISION::AVGBOND
INTEGER::J1
INTEGER,DIMENSION(NATOM,12,3)::PICK
REAL::RIJ,RJK
INTEGER::NC1,NK
DOUBLE PRECISION,DIMENSION(3)::AA
DOUBLE PRECISION,DIMENSION(10000,4,3)::RBR,RB
COMPLEX,DIMENSION(NSTEP)::CORR,CORRT
DOUBLE PRECISION,DIMENSION(2*NSTEP)::AAAA1, AAAA2,AAAA3
INTEGER::IFOR,IBAC
IFOR=1
IBAC=-1
OPEN(1505,FILE="ANGULAR")
OPEN(1506,FILE="FANGULAR")
PRINT*,'I M IN ANGULAR '
PRINT*,CATOM,SATOM
RTOPI=180/(4*ATAN(1.0))  !3.14
PI=4*ATAN(1.0)
TWOPI=8*ATAN(1.0)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
PRINT*,NCORD,BOND
DO I=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
        NC1=0
        NK=0
        DO J=SUM(NNTYPE(1:SATOM-1))+1,SUM(NNTYPE(1:SATOM))   !,NNTYPE(CATOM)
                AA=POS(1 ,I,:)-POS(1 ,J,:)
                AA=MATMUL(AA,ISLAT)
                WHERE(AA.LT.-0.5)AA=AA+1
                WHERE(AA.GT.0.5)AA=AA-1
                RIJ=NORM2(MATMUL(AA,SLAT))
                IF(RIJ.LE.BOND)THEN
                 NC1= NC1+1       !!!!!!!!CORDINATION1
                 NK = NK+1
                 IF(NC1.GT.NCORD)EXIT
                        PICK(I,NK,1)=I
                        PICK(I,NK,2)=J
                        PRINT*,PICK(I,NK,2) ,NK
                END IF
        END DO
!        IF(ANY(PICK(I,1:NCORD,2).LT.1))PRINT*,PICK(I,1:NCORD,2), I
END DO

PRINT*,'INDEXINGDONE'
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  CORRT=0
        DO I=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
        DO J=1,NCORD
        CORR=0
        AAAA1=0
        AAAA2=0
        AAAA3=0
                        DO IT=1,(IREF2-IREF1)+1   !,INTERVAL2
                        RB(I,J,:)=POS(IT,I,:)-POS(IT,PICK(I,J,2),:)
                        RB(I,J,:)=RB(I,J,:)/NORM2(RB(I,J,:))
                        AAAA1(2*IT-1)= RB(I,J,1)!CORR(1:NSTEP)  !REAL(FQT(II1,I))
                        AAAA2(2*IT-1)= RB(I,J,2)!CORR(1:NSTEP)  !REAL(FQT(II1,I))
                        AAAA3(2*IT-1)= RB(I,J,3)!CORR(1:NSTEP)  !REAL(FQT(II1,I))
                        END DO
                        !PRINT*,AAAA1
                        CALL dfour1(AAAA1,NSTEP,IFOR)
                        CALL dfour1(AAAA2,NSTEP,IFOR)
                        CALL dfour1(AAAA3,NSTEP,IFOR)
                        CORR(1:NSTEP)=CMPLX(AAAA1(1:2*NSTEP:2),AAAA1(2:2*NSTEP:2)) + CMPLX(AAAA2(1:2*NSTEP:2),AAAA2(2:2*NSTEP:2)) + CMPLX(AAAA3(1:2*NSTEP:2),AAAA3(2:2*NSTEP:2))
                        CORRT(1:NSTEP)=CORRT+ ABS(CORR(1:NSTEP)) 
                        !CORRT(1:NSTEP)=CORRT+ ABS(CORR(1:NSTEP)) 
        END DO
        END DO

        CORRT=CORRT/NSTEP

!######  Fourier Transform!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!VACF!!!!!!!!!!!!!!!!!!
        DO IT=1,NSTEP
        OMEGA=4.136*REAL((IT-1)/(DELT*NSTEP))
        WRITE(1506,80) OMEGA,CORRT(IT)
        80 FORMAT(E15.5,2X,100(3(2E20.8,2x)3x))
        END DO


        AAAA1=0
        AAAA1(1:2*NSTEP:2)= CORRT(1:NSTEP) !RB(I,J,1)
        CALL dfour1(AAAA1,NSTEP,IBAC)
        CORRT(1:NSTEP)=CMPLX(AAAA1(1:2*NSTEP:2),AAAA1(2:2*NSTEP:2))
        CORRT=CORRT/NSTEP
        DO IT=1,NSTEP
        WRITE(1505,80) IT*DELT ,CORRT(IT)
        END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
END SUBROUTINE



SUBROUTINE ANGULAR
use omp_lib
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(3)::DDD
DOUBLE PRECISION::RXY
INTEGER,DIMENSION(500,NCORD)::BDIST
DOUBLE PRECISION::RTOPI
INTEGER::JJJJ,JK,IR,JKK
DOUBLE PRECISION::D2,DR1,DR2
DOUBLE PRECISION::PROJ1,PROJ2,TWOPI
DOUBLE PRECISION,DIMENSION(3,3)::IAXIS
DOUBLE PRECISION::X,Y,Z,R
DOUBLE PRECISION,DIMENSION(3,3)::NEWLAT
INTEGER::MATOM,JCu,ICAP
INTEGER,DIMENSION(100)::INDEXI
INTEGER::MAXCAP,JTAG !,NCORD
DOUBLE PRECISION::AVGBOND
INTEGER::J1
INTEGER,DIMENSION(NATOM,12,3)::PICK
REAL::RIJ,RJK
INTEGER::NC1,NK
DOUBLE PRECISION,DIMENSION(3)::AA
DOUBLE PRECISION,DIMENSION(NSTEPORIG,NNTYPE(CATOM),NCORD,3)::RB
DOUBLE PRECISION,DIMENSION(NSTEPORIG,NNTYPE(CATOM))::CORR

DOUBLE PRECISION,DIMENSION(2*NSTEP)::AAAA
INTEGER::IFOR,IBAC
DOUBLE PRECISION,DIMENSION(NDOS)::DUMMY1,DUMMY2
INTEGER::NSTEPII
IFOR=1
IBAC=-1


OPEN(1505,FILE="ANGULAR_CORR")
OPEN(1506,FILE="FANGULAR_CORR")
PRINT*,'I M IN ANGULAR 2020'
PRINT*,CATOM,SATOM
RTOPI=180/(4*ATAN(1.0))  !3.14
PI=4*ATAN(1.0)
TWOPI=8*ATAN(1.0)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
DO I=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
        NC1=0
        NK=0
        DO J=SUM(NNTYPE(1:SATOM-1))+1,SUM(NNTYPE(1:SATOM))   !,NNTYPE(CATOM)
                AA=POS(1 ,I,:)-POS(1 ,J,:)
                AA=MATMUL(AA,ISLAT)
                WHERE(AA.LT.-0.5)AA=AA+1
                WHERE(AA.GT.0.5)AA=AA-1
                RIJ=NORM2(MATMUL(AA,SLAT))
                IF(RIJ.GT.0.AND.RIJ.LE.BOND)THEN
                 NC1=NC1+1       !!!!!!!!CORDINATION1
                 IF(NC1.GT.NCORD)EXIT
                        NK=NK+1
                        PICK(I,NK,1)=I
                        PICK(I,NK,2)=J
                END IF
        END DO
END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
RB=0
DO IT=1,(IREF2-IREF1)+1 !,INTERVAL2
        K=0
        do I=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
        K=K+1
        DO J=1,NCORD
        RB(IT,K,J,:)=POS(IT,I,:)-POS(IT,PICK(I,J,2),:)
        RB(IT,K,J,:)=RB(IT,K,J,:)/NORM2(RB(IT,K,J,:))
        END DO
        END DO
END DO


CORR=0

NSTEPII=MIN(1000,NSTEPI)

        !$omp  parallel do 
DO I=1, NNTYPE(CATOM) 
PRINT*, 'ATOM NO',I,'has been done'
        DO DT=1,NSTEPORIG-OINT
                NSTEP1=NSTEPII
                NSTEP2=NSTEPII+DT
                IF(NSTEPI+DT.GT.NSTEPORIG)NSTEP1=NSTEPORIG-DT
                IF(NSTEPI+DT.GT.NSTEPORIG)NSTEP2=NSTEP1+DT
                CORR(DT,I)=SUM( (RB(1:NSTEP1:OINT,I,:,:)*RB(1+DT:NSTEP2:OINT,I,:,:)) ) ! + &
                TAO=NSTEPII
                IF(NSTEPI+DT.GT.NSTEPORIG)TAO=NSTEPORIG-DT
                CORR(DT,I)=CORR(DT,I)/REAL((TAO/OINT))
                !PRINT*,CORR(DT,I)
                !PAUSE
                END DO
      END DO
      !$omp end parallel do


DO DT=1,NSTEPORIG-OINT
WRITE(1505,1505)DT*DELT,SUM(CORR(DT,:))/(NCORD*NNTYPE(CATOM))
1505 FORMAT(F10.5,1000(F12.5,1X))
END DO
AAAA=0
DO IT=1,NSTEP !ORIG
IF(IT.LE.NSTEPORIG)AAAA(2*IT-1)= SUM(CORR(IT,:))  !RB(I,J,3)!CORR(1:NSTEP)  !REAL(FQT(II1,I))
IF(IT.GT.NSTEPORIG)AAAA(2*IT-1)= SUM(CORR(NSTEPORIG,:))  !RB(I,J,3)!CORR(1:NSTEP)  !REAL(FQT(II1,I))
END DO


DUMMY1=0
DUMMY2=0
!AAAA=0
CALL dfour1(AAAA,NSTEP,IFOR)
!AAAA=AAAA/NSTEP
!DUMMY1=AAAA(1:2*NDOS:2) !(1:NDOS,IJ,1)
!CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
DO IT=1,NDOS !STEPORIG
OMEGA=4.136*REAL((IT-1)/(DELT*NSTEP))
WRITE(1506,1505) OMEGA ,AAAA(2*IT-1) !CORRT(IT)
!WRITE(1506,1505) OMEGA ,AAAA(2*IT-1),DUMMY2(IT)  !AAAA(2*IT-1) !CORRT(IT)
END DO


END SUBROUTINE




SUBROUTINE IIFQT7(IQQQQ,QHKL)   !!!!!!!!!!THIS IS with velcoity projection
use omp_lib
USE VARIABLES1, only :ICARTESIAN,PI,AVGISLAT,POS,MASS,VEL,NSTEPORIG,ICOH,IBROAD,FWHM0,FWHM1,NTYP,NSTEP,NATOM,DELT,ICUT,NDOS
IMPLICIT NONE
INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::EQT,EQL!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::MEQT,MEQL!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:)::IEQT,IEQL!,SQWB
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1,QHKL,kvecn
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2,DEN
DOUBLE PRECISION,DIMENSION(NSTEP)::PHASE
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::IQQQQ,NNN2
CHARACTER::AA*12
integer::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK
INTEGER::DT,IT
REAL::OMEGA
INTEGER::I,J

DOUBLE PRECISION,DIMENSION(NDOS)::DUMMY1,DUMMY2
PRINT*,'I M IN ACOUSTIC'
IF(ICUT==1)WRITE(AA,'("ACOUSTIC",I4.4)')IQQQQ
IF(ICUT==1)OPEN(IQQQQ,FILE=AA)
OPEN(9999,FILE='ACOUSTIC',ACCESS='APPEND')
PRINT*, QHKL
ALLOCATE(EQT(1:NSTEP,3))
ALLOCATE(EQL(1:NSTEP,3))
!ALLOCATE(DUMMY1(NDOS))
!ALLOCATE(DUMMY2(NDOS))
ALLOCATE(MEQT(1:NSTEP,3))
ALLOCATE(MEQL(1:NSTEP,3))
ALLOCATE(IEQL(1:NSTEP))
ALLOCATE(IEQT(1:NSTEP))
IFOR= 1
IBAC=-1
NQ=1
ALLOCATE(QQ(NQ,3),QK(NQ,3))
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        IQ=1
        QQ(IQ,:)=QHKL    !KLIST(IQ,:) !VEC
        IF(ICARTESIAN==1)THEN
        KVEC=QHKL        !KLIST(IQ,:)
        ELSE
        KVEC=2.0*PI*MATMUL(AVGISLAT,QHKL )        !CHANGED AVGISLAT TO ISLAT
        END IF
        QK(IQ,:)=KVEC
        EQT=0
        EQL=0

        DO I=1,NATOM
        PHASE(:)=KVEC(1)*POS(:,I,1) + KVEC(2)*POS(:,I,2) + KVEC(3)*POS(:,I,3)
        DEN=NORM2(KVEC)
        KVECN=KVEC/DEN !NORM2(KVEC) 
        EQT(:,1)=EQT(:,1) +   ( VEL(:,I,1) -  KVECN(1)*(VEL(:,I,1)*KVECN(1)+VEL(:,I,2)*KVECN(2)+VEL(:,I,3)*KVECN(3)))*CMPLX(COS(PHASE),SIN(PHASE))
        EQT(:,2)=EQT(:,2) +   ( VEL(:,I,2) -  KVECN(2)*(VEL(:,I,1)*KVECN(1)+VEL(:,I,2)*KVECN(2)+VEL(:,I,3)*KVECN(3)))*CMPLX(COS(PHASE),SIN(PHASE))
        EQT(:,3)=EQT(:,3) +   ( VEL(:,I,3) -  KVECN(3)*(VEL(:,I,1)*KVECN(1)+VEL(:,I,2)*KVECN(2)+VEL(:,I,3)*KVECN(3)))*CMPLX(COS(PHASE),SIN(PHASE))
        EQL(:,1)=EQL(:,1) +    KVECN(1)*(VEL(:,I,1)*KVECN(1)+VEL(:,I,2)*KVECN(2)+VEL(:,I,3)*KVECN(3))*CMPLX(COS(PHASE),SIN(PHASE))
        EQL(:,2)=EQL(:,2) +    KVECN(2)*(VEL(:,I,1)*KVECN(1)+VEL(:,I,2)*KVECN(2)+VEL(:,I,3)*KVECN(3))*CMPLX(COS(PHASE),SIN(PHASE))
        EQL(:,3)=EQL(:,3) +    KVECN(3)*(VEL(:,I,1)*KVECN(1)+VEL(:,I,2)*KVECN(2)+VEL(:,I,3)*KVECN(3))*CMPLX(COS(PHASE),SIN(PHASE))
        END DO
        IF(DEN==0)EQT=0 
        IF(DEN==0)EQL=0 
        IEQT=0
        IEQL=0
!        GO TO 121
        IF(DEN.NE.0)THEN
        call dfftw_plan_dft_1d(plann,NSTEP,EQT(:,1),EQT(:,1),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, EQT(:,1),EQT(:,1))
        call dfftw_destroy_plan(plann)
        call dfftw_plan_dft_1d(plann,NSTEP,EQT(:,2),EQT(:,2),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, EQT(:,2),EQT(:,2))
        call dfftw_destroy_plan(plann)
        call dfftw_plan_dft_1d(plann,NSTEP,EQT(:,3),EQT(:,3),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, EQT(:,3),EQT(:,3))
        call dfftw_destroy_plan(plann)
        call dfftw_plan_dft_1d(plann,NSTEP,EQL(:,1),EQL(:,1),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, EQL(:,1),EQL(:,1))
        call dfftw_destroy_plan(plann)
        call dfftw_plan_dft_1d(plann,NSTEP,EQL(:,2),EQL(:,2),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, EQL(:,2),EQL(:,2))
        call dfftw_destroy_plan(plann)
        call dfftw_plan_dft_1d(plann,NSTEP,EQL(:,3),EQL(:,3),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, EQL(:,3),EQL(:,3))
        call dfftw_destroy_plan(plann)
!        call dfftw_plan_dft_1d(plann,NSTEP,MEQT(:,1),MEQT(:,1),IFOR,FFTW_ESTIMATE)
!        call dfftw_execute_dft(plann, MEQT(:,1),MEQT(:,1))
!        call dfftw_destroy_plan(plann)
!        call dfftw_plan_dft_1d(plann,NSTEP,MEQT(:,2),MEQT(:,2),IFOR,FFTW_ESTIMATE)
!        call dfftw_execute_dft(plann, MEQT(:,2),MEQT(:,2))
!        call dfftw_destroy_plan(plann)
!        call dfftw_plan_dft_1d(plann,NSTEP,MEQT(:,3),MEQT(:,3),IFOR,FFTW_ESTIMATE)
!        call dfftw_execute_dft(plann, MEQT(:,3),MEQT(:,3))
!        call dfftw_destroy_plan(plann)

!        call dfftw_plan_dft_1d(plann,NSTEP,MEQL(:,1),MEQL(:,1),IFOR,FFTW_ESTIMATE)
!        call dfftw_execute_dft(plann, MEQL(:,1),MEQL(:,1))
!        call dfftw_destroy_plan(plann)
!        call dfftw_plan_dft_1d(plann,NSTEP,MEQL(:,2),MEQL(:,2),IFOR,FFTW_ESTIMATE)
!        call dfftw_execute_dft(plann, MEQL(:,2),MEQL(:,2))
!        call dfftw_destroy_plan(plann)
!        call dfftw_plan_dft_1d(plann,NSTEP,MEQL(:,3),MEQL(:,3),IFOR,FFTW_ESTIMATE)
!        call dfftw_execute_dft(plann, MEQL(:,3),MEQL(:,3))
!        call dfftw_destroy_plan(plann)

        EQT(:,:)=EQT(:,:)/REAL(NSTEPORIG)
        IEQT(:)=SUM(EQT*CONJG(EQT),DIM=2)
        EQL(:,:)=EQL(:,:)/REAL(NSTEPORIG)
        IEQL(:)=SUM(EQL*CONJG(EQL),DIM=2)
        DUMMY1=0
        DUMMY2=0

        DUMMY1=IEQT(1:NDOS)
        IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
        IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
        IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
        IEQT(1:NDOS)=DUMMY2

        DUMMY1=0
        DUMMY2=0
        DUMMY1=IEQL(1:NDOS)
        IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
        IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
        IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
        IEQL(1:NDOS)=DUMMY2

        END IF


        IF(ICUT==1)THEN
        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        WRITE(IQQQQ,15) OMEGA,IEQT(DT),IEQL(DT)
        END DO
        END IF
        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        WRITE(9999,15) OMEGA, IEQT(DT),IEQL(DT)
        END DO
        15 FORMAT(F15.4,2(2E20.2,4x))
        IF(ICUT==1)CLOSE(IQQQQ)
close(9999)
DEALLOCATE(EQT,IEQT)
!DEALLOCATE(DUMMY1,DUMMY2)
END SUBROUTINE


SUBROUTINE IIFQT33(IQQQQ)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::FQT,FFQTTYP!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::CFFQTTYP !,SQWB
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
REAL,DIMENSION(NSTEP)::PHASE1
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::II1,I1,DT1,III
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DUMMY2,DUMMY4
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMYT
DOUBLE PRECISION::EE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK
INTEGER::ITYPPP,JTYPPP
INTEGER::IQQQQ,NNN2
CHARACTER::AA*9
INTEGER::NTYP2
INTEGER::IJ1,IJ2
INTEGER::IQTCAL
integer,allocatable,dimension(:)::plan
integer::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
INTEGER::KTYPPP
INTEGER,ALLOCATABLE,DIMENSION(:,:)::IND2
IQTCAL=0         !!!!DO  NOT CALCLATE FQT
NTYP2=NTYP*(NTYP+1)/2
ALLOCATE(IND2(NTYP2,2))
print*,num_threads

PRINT*,NTYP2
WRITE(AA,'("CSQWTOT",I2.2)')IQQQQ
OPEN(170,FILE=AA)
WRITE(AA,'("ISQWTOT",I2.2)')IQQQQ
OPEN(180,FILE=AA)
IF(IQTCAL==1)WRITE(AA,'("CIQTTOT",I2.2)')IQQQQ
IF(IQTCAL==1)OPEN(190,FILE=AA)
IF(IQTCAL==1)WRITE(AA,'("IIQTTOT",I2.2)')IQQQQ
IF(IQTCAL==1)OPEN(200,FILE=AA)
!OPEN(17,FILE="CSQ")
!OPEN(18,FILE="ISQ")
IF(IQTCAL==1) OPEN(19,FILE="CIQ")
IF(IQTCAL==1)OPEN(20,FILE="IIQ")
PRINT*,'I AM IN FQT33'
ALLOCATE(FQT(1:NSTEP,NATOM))
ALLOCATE(FFQTTYP(1:NSTEP,NTYP))
ALLOCATE(CFFQTTYP(1:NSTEP,NTYP,NTYP))
allocate(plan(NATOM))
FQT=0
FFQTTYP=0
CFFQTTYP=0
IFOR= 1
IBAC=-1
PRINT*,AVGISLAT(1,:)
PRINT*,AVGISLAT(2,:)
PRINT*,AVGISLAT(3,:)
PRINT*,NTYP
IF(ILIST.NE.3)THEN
WRITE(AA,'("KKLIST",I2.2)')IQQQQ
OPEN(44,FILE=AA)
I=0
DO  
I=I+1 
READ(44,*,END=100)KLIST(I,:)
END DO
100 CONTINUE
NQ=I-1
I=0
PRINT*,'NQ',NQ
ALLOCATE(QQ(NQ,3),QK(NQ,3))
!ALLOCATE(DUMMY2(NQ,NTYP2+1,NSTEP),DUMMY4(NQ,NTYP2+1,NSTEP))
END IF

IF(ILIST.EQ.3)THEN
NQ=IQQQQ 
PRINT*,KLIST(NQ,:)
ALLOCATE(QQ(NQ,3),QK(NQ,3))
!ALLOCATE(DUMMY2(NQ,NTYP2+1,NSTEP),DUMMY4(NQ,NTYP2+1,NSTEP))
END IF
!ALLOCATE(DUMMYT(NSTEP),KSELF(NTYP))
PRINT*,'NSTEP',NSTEP
	FFQTTYP=0
	CFFQTTYP=0

        K=0
        DO I=1,NTYP
        DO J=I,NTYP
        K=K+1
        IND2(K,1)=I
        IND2(K,2)=J
        ENDDO
        ENDDO
        
        
        
        

DO IQ=1,NQ
        PRINT*,'IQ=',IQ
	QQ(IQ,:)=KLIST(IQ,:) !VEC
	!IF(ICARTESIAN==1)THEN
        !KVEC=KLIST(IQ,:)
        !ELSE
        !KVEC=2.0*PI*MATMUL(AVGISLAT,KLIST(IQ,:) )        !CHANGED AVGISLAT TO ISLAT
        !END IF

        KVEC=2.0*PI*MATMUL(AVGISLAT,KLIST(IQ,:) )        !CHANGED AVGISLAT TO ISLAT
        !KVEC=2.0*PI*MATMUL(KLIST(IQ,:),AVGISLAT)        !CHANGED AVGISLAT TO ISLAT
!	QK(IQ,:)=KVEC
        DO I=1,NATOM
	!$omp parallel do
        DO IT=1,NSTEPORIG  
        PHASE1(IT)=DOT_PRODUCT(KVEC,POS(IT,I,:))
        FQT(IT,I)=CMPLX(COS(PHASE1(IT)),SIN(PHASE1(IT)))
        END DO
	!$omp end parallel do
        call dfftw_plan_dft_1d(plann,NSTEP,FQT(:,I),FQT(:,I),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, FQT(:,I),FQT(:,I))
        call dfftw_destroy_plan(plann)
        FQT(:,I)=FQT(:,I)/REAL(NSTEPORIG)
        END DO

        PRINT*,'I AM IN INCOHERENT33'
        DO ITYPPP=1,NTYP
        FFQTTYP(1:NSTEP,ITYPPP)=FFQTTYP(1:NSTEP,ITYPPP) + IBBT2(ITYPPP)*IBBT2(ITYPPP)*  SUM(FQT(1:NSTEP, SUM(NNTYPE(1:ITYPPP-1))+1 : SUM(NNTYPE(1:ITYPPP))) * CONJG(FQT(1:NSTEP, SUM(NNTYPE(1:ITYPPP-1))+1 : SUM(NNTYPE(1:ITYPPP)))),DIM=2 )
        END DO
	!DO DT=1,NSTEP
	!WRITE(18,15)REAL(DT)*DELT,REAL(FFQTTYP(DT,1:NTYP))  ,SUM(REAL(FFQTTYP(DT,:))) , SUM(AIMAG(FFQTTYP(DT,:))) !/REAL(FFQTTYP(1,:)) !,SUM(REAL(FFQTTYP(DT,1:NTYP)))/SUM(REAL(FFQTTYP(1,1:NTYP))) !NATOM
	!END DO

	IF(IQTCAL==1)THEN
	DO I=1,NTYP
        call dfftw_plan_dft_1d(plan(i),NSTEP,FFQTTYP(:,I),FFQTTYP(:,I),IBAC,FFTW_ESTIMATE)
        call dfftw_execute_dft(plan(i), FFQTTYP(:,I),FFQTTYP(:,I))
        call dfftw_destroy_plan(plan(i))
        FFQTTYP(:,I)=FFQTTYP(:,I)/REAL(NSTEPORIG)
	END DO
	DO DT=1,NSTEP	
	WRITE(20,15)REAL(DT)*DELT,REAL(FFQTTYP(DT,1:NTYP)) !/(REAL(FFQTTYP(1,:))) !,(SUM(REAL(FFQT(DT,:))))/SUM(REAL(FFQT(1,:)))
	END DO
	END IF


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!COHERENT CASE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	PRINT*,'I AM IN COHERENT33'


        !ITYPPP=1
        !JTYPPP=0
        !$omp parallel do 
        DO KTYPPP=1,NTYP2
        !JTYPPP=JTYPPP+1
        !IF(JTYPPP.GT.NTYP)THEN
        !ITYPPP=ITYPPP+1
        !JTYPPP=ITYPPP
        !ITYPPP=IND2(KTYPPP,1)
        !JTYPPP=IND2(KTYPPP,2)
        PRINT*,IND2(KTYPPP,1),IND2(KTYPPP,2) !ITYPPP,JTYPPP
        !DO ITYPPP=1,NTYP
        !DO JTYPPP=1,NTYP
        DO I=SUM(NNTYPE(1:IND2(KTYPPP,1)-1))+1,SUM(NNTYPE(1:IND2(KTYPPP,1))) !NATOM
        !DO J=SUM(NNTYPE(1:JTYPPP-1))+1,SUM(NNTYPE(1:JTYPPP)) !NATOM
        !CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP)=CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP) +   FQT(1:NSTEP,I) * CONJG(FQT(1:NSTEP, J) )
        CFFQTTYP(1:NSTEP,IND2(KTYPPP,1),IND2(KTYPPP,2))=CFFQTTYP(1:NSTEP,IND2(KTYPPP,1),IND2(KTYPPP,2)) +        BBT(IND2(KTYPPP,1))*BBT(IND2(KTYPPP,2))* FQT(1:NSTEP,I) *CONJG(SUM(FQT(1:NSTEP,SUM(NNTYPE(1:IND2(KTYPPP,2)-1))+1 : SUM(NNTYPE(1:IND2(KTYPPP,2)))),DIM=2) )
	!END DO
        END DO
        !END DO
        !END DO
        END DO
	!$omp end parallel do

        DO I=1,NTYP
        DO J=I,NTYP        
        
        IF(i.ne.j)CFFQTTYP(1:NSTEP,J,I)=CFFQTTYP(1:NSTEP,I,J)
        END DO
        END DO
        
        
        
        
        
        
        
        
        
        
        
        !	DO DT=1,NSTEP
!        WRITE(17,15) REAL(DT)*DELT, ( ( REAL(CFFQTTYP(DT,IJ1,IJ2)) , IJ2=IJ1,NTYP ),IJ1=1,NTYP) ! ,SUM(REAL(CFFQTTYP(DT,:,:)))/SUM(REAL(CFFQTTYP(1,:,:))) !NATOM
!	END DO

        IF( IQTCAL==1)THEN
!	!$omp parallel do
	DO I=1,NTYP  !*(NTYP+1)/2
	DO J=I,NTYP  !*(NTYP+1)/2
        call dfftw_plan_dft_1d(plan(j),NSTEP,CFFQTTYP(:,I,J),CFFQTTYP(:,I,J),IBAC,FFTW_ESTIMATE)
	call dfftw_execute_dft(plan(j), CFFQTTYP(:,I,J),CFFQTTYP(:,I,J))
	call dfftw_destroy_plan(plan(j))
	CFFQTTYP(:,I,J)=CFFQTTYP(:,I,J)/REAL(NSTEPORIG) !CMPLX(AAA(I,1:2*NSTEP:2),AAA(I,2:2*NSTEP:2))
	END DO
        END DO
!	!$omp end parallel do
	DO DT=1,NSTEP	
        WRITE(19,15) REAL(DT)*DELT, ( ( REAL(CFFQTTYP(DT,IJ1,IJ2)) , IJ1=1,NTYP ),IJ2=IJ1,NTYP) ! ,SUM(REAL(CFFQTTYP(DT,:,:)))/SUM(REAL(CFFQTTYP(1,:,:))) !NATOM
	END DO
        END IF

END DO    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!QLOOP ENDS
!REWIND(17)
!REWIND(18)
REWIND(19)
REWIND(20)

		DO DT=1,NSTEP
		OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
		WRITE(180,15)OMEGA,REAL(FFQTTYP(DT,1:NTYP)),REAL(SUM(FFQTTYP(DT,:))) !   ( SUM(DUMMY2(1:NQ,ITYP,DT)) / NQ   ,ITYP=1,NTYP+1) !,SUM(DUMMY2(1:NQ,:,DT))/NQ
		END DO

	DO DT=1,NSTEP
	OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
	WRITE(170,15)OMEGA,( ( REAL(CFFQTTYP(DT,IJ1,IJ2)) , IJ2=IJ1,NTYP ),IJ1=1,NTYP) ,REAL(SUM(CFFQTTYP(DT,:,:))) !                  (  SUM(DUMMY2(1:NQ,ITYP,DT) )/NQ,ITYP=1,NTYP2),DUMMYT(DT) 
	END DO
	17 FORMAT(A12,2X,3F10.5)
        15 FORMAT(F15.4,1003E20.4)
	170 FORMAT(A12,100(3X,3F6.2,3X))
	172 FORMAT(A12,<NQ>(3X,3F6.2,3X),6X,'AVG OVER Q')
	171 FORMAT(A3,12X,<NTYP>(8X,'avg',A3,10X) )
	173 FORMAT(A3,12X,<NTYP2>(8X,'avg',2A3,10X) )
!CLOSE(170)
!CLOSE(180)
CLOSE(190)
CLOSE(200)
!CLOSE(17)
!CLOSE(18)
CLOSE(19)
CLOSE(20)
CLOSE(44)
!DEALLOCATE(FQT,FFQTTYP,CFFQTTYP,DUMMY1,DUMMY2,DUMMY3,DUMMY4, AAA)
!DEALLOCATE(FQT,FFQT,AAA)
END SUBROUTINE


SUBROUTINE DATAX(SNAME)
USE VARIABLES1
IMPLICIT NONE
CHARACTER*5::SNAME
CHARACTER*5,DIMENSION(220)::ELEMENT
DOUBLE PRECISION,DIMENSION(9,220)::X_ATT
INTEGER::IL

Element=(/ "H",  & 
"H'",            &
"D",             &
"H1-",           &
"He",            &
"Li",            &
"Li1+",          &
"Be",            &
"Be2+",          &
"B",             &
"C",             &
"Cval",          &
"N",             &
"O",             &
"O1-",           &
"O2-",           &
"F",             &
"F1-",           &
"Ne",            &
"Na",            &
"Na1+",          &
"Mg",            &
"Mg2+",          &
"Al",            &
"Al3+",          &
"Si",            &
"Siv",           &
"Sival",         &
"Si4+",          &
"P",             &
"S",             &
"Cl",            &
"Cl1-",          &
"Ar",            &
"K",             &
"K1+",           &
"Ca",            &
"Ca2+",          &
"Sc",            &
"Sc3+",          &
"Ti",            &
"Ti2+",          &
"Ti3+",          &
"Ti4+",          &
"V",             &
"V2+",           &
"V3+",           &
"V5+",           &
"Cr",            &
"Cr2+",          &
"Cr3+",          &
"Mn",            &
"Mn2+",          &
"Mn3+",          &
"Mn4+",          &
"Fe",            &
"Fe2+",          &
"Fe3+",          &
"Co",            &
"Co2+",          &
"Co3+",          &
"Ni",            &
"Ni2+",          &
"Ni3+",          &
"Cu",            &
"Cu1+",          &
"Cu2+",          &
"Zn",            &
"Zn2+",          &
"Ga",            &
"Ga3+",          &
"Ge",            &
"Ge4+",          &
"As",            &
"Se",            &
"Br",            &
"Br1-",          &
"Kr",            &
"Rb",            &
"Rb1+",          &
"Sr",            &
"Sr2+",          &
"Y",             &
"Y3+",           &
"Zr",            &
"Zr4+",          &
"Nb",            &
"Nb3+",          &
"Nb5+",          &
"Mo",            &
"Mo3+",          &
"Mo5+",          &
"Mo6+",          &
"Tc",            &
"Ru",            &
"Ru3+",          &
"Ru4+",          &
"Rh",            &
"Rh3+",          &
"Rh4+",          &
"Pd",            &
"Pd2+",          &
"Pd4+",          &
"Ag",            &
"Ag1+",          &
"Ag2+",          &
"Cd",            &
"Cd2+",          &
"In",            &
"In3+",          &
"Sn",            &
"Sn2+",          &
"Sn4+",          &
"Sb",            &
"Sb3+",          &
"Sb5+",          &
"Te",            &
"I",             &
"I1-",           &
"Xe",            &
"Cs",            &
"Cs1+",          &
"Ba",            &
"Ba2+",          &
"La",            &
"La3+",          &
"Ce",            &
"Ce3+",          &
"Ce4+",          &
"Pr",            &
"Pr3+",          &
"Pr4+",          &
"Nd",            &
"Nd3+",          &
"Pm",            &
"Pm3+",          &
"Sm",            &
"Sm3+",          &
"Eu",            &
"Eu2+",          &
"Eu3+",          &
"Gd",            &
"Gd3+",          &
"Tb",            &
"Tb3+",          &
"Dy",            &
"Dy3+",          &
"Ho",            &
"Ho3+",          &
"Er",            &
"Er3+",          &
"Tm",            &
"Tm3+",          &
"Yb",            &
"Yb2+",          &
"Yb3+",          &
"Lu",            &
"Lu3+",          &
"Hf",            &
"Hf4+",          &
"Ta",            &
"Ta5+",          &
"W",             &
"W6+",           &
"Re",            &
"Os",            &
"Os4+",          &
"Ir",            &
"Ir3+",          &
"Ir4+",          &
"Pt",            &
"Pt2+",          &
"Pt4+",          &
"Au",            &
"Au1+",          &
"Au3+",          &
"Hg",            &
"Hg1+",          &
"Hg2+",          &
"Tl",            &
"Tl1+",          &
"Tl3+",          &
"Pb",            &
"Pb2+",          &
"Pb4+",          &
"Bi",            &
"Bi3+",          &
"Bi5+",          &
"Po",            &
"At",            &
"Rn",            &
"Fr",            &
"Ra",            &
"Ra2+",          &
"Ac",            &
"Ac3+",          &
"Th",            &
"Th4+",          &
"Pa",            &
"U",             &
"U3+",           &
"U4+",           &
"U6+",           &
"Np",            &
"Np3+",          &
"Np4+",          &
"Np6+",          &
"Pu",            &
"Pu3+",          &
"Pu4+",          &
"Pu6+",          &
"Am",            &
"Cm",            &
"Bk",            &
"Cf",            & 
"Es",            &
"Fm",            &
"Md",            &
"No",            & 
"Lr" /)

X_Att=RESHAPE((/   0.493002, 0.322912, 0.140191, 0.040810  ,     10.5109, 26.1257, 3.14236, 57.7997  ,                 0.003038  ,     &
   0.489918, 0.262003, 0.196767, 0.049879  ,                20.6593, 7.74039, 49.5519, 2.20159  ,              0.001305  ,     &
   0.489918, 0.262003, 0.196767, 0.049879  ,                20.6593, 7.74039, 49.5519, 2.20159  ,              0.001305  ,     &
   0.897661, 0.565616, 0.415815, 0.116973  ,                53.1368, 15.1870, 186.576, 3.56709  ,              0.002389  ,     &
   0.873400, 0.630900, 0.311200, 0.178000  ,                9.10370, 3.35680, 22.9276, 0.982100  ,              0.006400  ,    &
   1.12820, 0.750800, 0.617500, 0.465300  ,                3.95460, 1.05240, 85.3905, 168.261  ,              0.037700  ,      &
   0.696800, 0.788800, 0.341400, 0.156300  ,                4.62370, 1.95570, 0.631600, 10.0953  ,              0.016700  ,    &
   1.59190, 1.12780, 0.539100, 0.702900  ,                43.6427, 1.86230, 103.483, 0.542000  ,              0.038500  ,      &
   6.26030, 0.884900, 0.799300, 0.164700  ,                0.002700, 0.831300, 2.27580, 5.11460  ,              -6.1092  ,     &
   2.05450, 1.33260, 1.09790, 0.706800  ,                23.2185, 1.02100, 60.3498, 0.140300  ,              -0.19320  ,       &
   2.31000, 1.02000, 1.58860, 0.865000  ,                20.8439, 10.2075, 0.568700, 51.6512  ,              0.215600  ,       &
   2.26069, 1.56165, 1.05075, 0.839259  ,                22.6907, 0.656665, 9.75618, 55.5949  ,              0.286977  ,       &
   12.2126, 3.13220, 2.01250, 1.16630  ,                0.005700, 9.89330, 28.9975, 0.582600  ,              -11.529  ,        &
   3.04850, 2.28680, 1.54630, 0.867000  ,                13.2771, 5.70110, 0.323900, 32.9089  ,              0.250800  ,       &
   4.19160, 1.63969, 1.52673, -20.307  ,                12.8573, 4.17236, 47.0179, -0.01404  ,              21.9412  ,         &
   3.75040, 2.84294, 1.54298, 1.62091  ,                16.5151, 6.59203, 0.319201, 43.3486  ,              0.242060  ,        &
   3.53920, 2.64120, 1.51700, 1.02430  ,                10.2825, 4.29440, 0.261500, 26.1476  ,              0.277600  ,        &
   3.63220, 3.51057, 1.26064, 0.940706  ,                5.27756, 14.7353, 0.442258, 47.3437  ,              0.653396  ,       &
   3.95530, 3.11250, 1.45460, 1.12510  ,                8.40420, 3.42620, 0.230600, 21.7184  ,              0.351500  ,        &
   4.76260, 3.17360, 1.26740, 1.11280  ,                3.28500, 8.84220, 0.313600, 129.424  ,              0.676000  ,        &
   3.25650, 3.93620, 1.39980, 1.00320  ,                2.66710, 6.11530, 0.200100, 14.0390  ,             0.404000  ,         &
   5.42040, 2.17350, 1.22690, 2.30730  ,                2.82750, 79.2611, 0.380800, 7.19370  ,              0.858400  ,        &
   3.49880, 3.83780, 1.32840, 0.849700  ,                2.16760, 4.75420, 0.185000, 10.1411  ,              0.485300  ,       &
   6.42020, 1.90020, 1.59360, 1.96460  ,                3.03870, 0.742600, 31.5472, 85.0886  ,              1.11510  ,         &
   4.17448, 3.38760, 1.20296, 0.528137  ,                1.93816, 4.14553, 0.228753, 8.28524  ,              0.706786  ,       &
   6.29150, 3.03530, 1.98910, 1.54100  ,                2.43860, 32.3337, 0.678500, 81.6937  ,              1.14070  ,         &
   6.29150, 3.03530, 1.98910, 1.54100  ,                2.43860, 32.3337, 0.678500, 81.6937  ,             1.14070  ,          &
   5.66269, 3.07164, 2.62446, 1.39320  ,                2.66520, 38.6634, 0.916946, 93.5458  ,              1.24707  ,         &
   4.43918, 3.20345, 1.19453, 0.416530  ,                1.64167, 3.43757, 0.214900, 6.65365  ,              0.746297  ,       &
   6.43450, 4.17910, 1.78000, 1.49080  ,                1.90670, 27.1570, 0.526000, 68.1645  ,              1.11490  ,         &
   6.90530, 5.20340, 1.43790, 1.58630  ,                1.46790, 22.2151, 0.253600, 56.1720  ,              0.866900  ,        &
   11.4604, 7.19640, 6.25560, 1.64550  ,                0.010400, 1.16620, 18.5194, 47.7784  ,              -9.5574  ,         &
   18.2915, 7.20840, 6.53370, 2.33860  ,                0.006600, 1.17170, 19.5424, 60.4486  ,              -16.378  ,         &
   7.48450, 6.77230, 0.653900, 1.64420  ,                0.907200, 14.8407, 43.8983, 33.3929  ,              1.44450  ,        &
   8.21860, 7.43980, 1.05190, 0.865900  ,                12.7949, 0.774800, 213.187, 41.6841  ,              1.42280  ,        &
   7.95780, 7.49170, 6.35900, 1.19150  ,                12.6331, 0.767400, -0.00200, 31.9128  ,              -4.9978  ,        &
   8.62660, 7.38730, 1.58990, 1.02110  ,                10.4421, 0.659900, 85.7484, 178.437  ,              1.37510  ,         &
   15.6348, 7.95180, 8.43720, 0.853700  ,                -0.00740, 0.608900, 10.3116, 25.9905  ,              -14.875  ,       &
   9.18900, 7.36790, 1.64090, 1.46800  ,                9.02130, 0.572900, 136.108, 51.3531  ,              1.33290  ,         &
   13.4008, 8.02730, 1.65943, 1.57936  ,                0.298540, 7.96290, -0.28604, 16.0662  ,              -6.6667  ,        &
   9.75950, 7.35580, 1.69910, 1.90210  ,                7.85080, 0.500000, 35.6338, 116.105  ,              1.28070  ,         &
   9.11423, 7.62174, 2.27930, 0.087899  ,                7.52430, 0.457585, 19.5361, 61.6558  ,              0.897155  ,       &
   17.7344, 8.73816, 5.25691, 1.92134  ,                0.220610, 7.04716, -0.15762, 15.9768  ,              -14.652  ,        &
   19.5114, 8.23473, 2.01341, 1.52080  ,                0.178847, 6.67018, -0.29263, 12.9464  ,              -13.280  ,        &
   10.2971, 7.35110, 2.07030, 2.05710  ,                6.86570, 0.438500, 26.8938, 102.478  ,              1.21990  ,         &
   10.1060, 7.35410, 2.28840, 0.022300  ,                6.88180, 0.440900, 20.3004, 115.122  ,              1.22980  ,        &
   9.43141, 7.74190, 2.15343, 0.016865  ,                6.39535, 0.383349, 15.1908, 63.9690  ,              0.656565  ,       &
   15.6887, 8.14208, 2.03081, -9.5760  ,                0.679003, 5.40135, 9.97278, 0.940464  ,              1.71430  ,        &
   10.6406, 7.35370, 3.32400, 1.49220  ,                6.10380, 0.392000, 20.2626, 98.7399  ,              1.18320  ,         &
   9.54034, 7.75090, 3.58274, 0.509107  ,                5.66078, 0.344261, 13.3075, 32.4224  ,              0.616898  ,       &
   9.68090, 7.81136, 2.87603, 0.113575  ,                5.59463, 0.334393, 12.8288, 32.8761  ,              0.518275  ,       &
   11.2819, 7.35730, 3.01930, 2.24410  ,                5.34090, 0.343200, 17.8674, 83.7543  ,              1.08960  ,         &
   10.8061, 7.36200, 3.52680, 0.218400  ,                5.27960, 0.343500, 14.3430, 41.3235  ,              1.08740  ,        &
   9.84521, 7.87194, 3.56531, 0.323613  ,                4.91797, 0.294393, 10.8171, 24.1281  ,              0.393974  ,       &
   9.96253, 7.97057, 2.76067, 0.054447  ,                4.84850, 0.283303, 10.4852, 27.5730  ,              0.251877  ,       &
   11.7695, 7.35730, 3.52220, 2.30450  ,                4.76110, 0.307200, 15.3535, 76.8805  ,              1.03690  ,         &
   11.0424, 7.37400, 4.13460, 0.439900  ,                4.65380, 0.305300, 12.0546, 31.2809  ,              1.00970  ,        &
   11.1764, 7.38630, 3.39480, 0.072400  ,                4.61470, 0.300500, 11.6729, 38.5566  ,              0.970700  ,       &
   12.2841, 7.34090, 4.00340, 2.34880  ,                4.27910, 0.278400, 13.5359, 71.1692  ,              1.01180  ,         &
   11.2296, 7.38830, 4.73930, 0.710800  ,                4.12310, 0.272600, 10.2443, 25.6466  ,              0.932400  ,       &
   10.3380, 7.88173, 4.76795, 0.725591  ,                3.90969, 0.238668, 8.35583, 18.3491  ,              0.286667  ,       &
   12.8376, 7.29200, 4.44380, 2.38000  ,                3.87850, 0.256500, 12.1763, 66.3421  ,              1.03410  ,         &
   11.4166, 7.40050, 5.34420, 0.977300  ,                3.67660, 0.244900, 8.87300, 22.1626  ,              0.861400  ,       &
   10.7806, 7.75868, 5.22746, 0.847114  ,                3.54770, 0.223140, 7.64468, 16.9673  ,              0.386044  ,       &
   13.3380, 7.16760, 5.61580, 1.67350  ,                3.58280, 0.247000, 11.3966, 64.8126  ,              1.19100  ,         &
   11.9475, 7.35730, 6.24550, 1.55780  ,                3.36690, 0.227400, 8.66250, 25.8487  ,              0.89000  ,         &
   11.8168, 7.11181, 5.78135, 1.14523  ,                3.37484, 0.244078, 7.98760, 19.8970  ,              1.14431  ,         &
   14.0743, 7.03180, 5.16520, 2.41000  ,                3.26550, 0.233300, 10.3163, 58.7097  ,              1.30410  ,         &
   11.9719, 7.38620, 6.46680, 1.39400  ,                2.99460, 0.203100, 7.08260, 18.0995  ,              0.780700  ,        &
   15.2354, 6.70060, 4.35910, 2.96230  ,                3.06690, 0.241200, 10.7805, 61.4135  ,              1.71890  ,         &
   12.6920, 6.69883, 6.06692, 1.00660  ,                2.81262, 0.227890, 6.36441, 14.4122  ,              1.53545  ,         &
   16.0816, 6.37470, 3.70680, 3.68300  ,                2.85090, 0.251600, 11.4468, 54.7625  ,              2.13130  ,         &
   12.9172, 6.70003, 6.06791, 0.859041  ,                2.53718, 0.205855, 5.47913, 11.6030  ,              1.45572  ,        &
   16.6723, 6.07010, 3.43130, 4.27790  ,                2.63450, 0.264700, 12.9479, 47.7972  ,              2.53100  ,         &
   17.0006, 5.81960, 3.97310, 4.35430  ,                2.40980, 0.272600, 15.2372, 43.8163  ,              2.84090  ,         &
   17.1789, 5.23580, 5.63770, 3.98510  ,                2.17230, 16.5796, 0.260900, 41.4328  ,              2.95570  ,         &
   17.1718, 6.33380, 5.57540, 3.72720  ,                2.20590, 19.3345, 0.287100, 58.1535  ,              3.17760  ,         &
   17.3555, 6.72860, 5.54930, 3.53750  ,                1.93840, 16.5623, 0.226100, 39.3972  ,              2.82500  ,         &
   17.1784, 9.64350, 5.13990, 1.52920  ,                1.78880, 17.3151, 0.274800, 164.934  ,              3.48730  ,         &
   17.5816, 7.65980, 5.89810, 2.78170  ,                1.71390, 14.7957, 0.160300, 31.2087  ,              2.07820  ,         &
   17.5663, 9.81840, 5.42200, 2.66940  ,                1.55640, 14.0988, 0.166400, 132.376  ,              2.50640  ,         &
   18.0874, 8.13730, 2.56540, -34.193  ,                1.49070, 12.6963, 24.5651, -0.01380  ,              41.4025  ,         &
   17.7760, 10.2946, 5.72629, 3.26588  ,                1.40290, 12.8006, 0.125599, 104.354  ,              1.91213  ,         &
   17.9268, 9.15310, 1.76795, -33.108  ,                1.35417, 11.2145, 22.6599, -0.01319  ,              40.2602  ,         &
   17.8765, 10.9480, 5.41732, 3.65721  ,                1.27618, 11.9160, 0.117622, 87.6627  ,              2.06929  ,         &
   18.1668, 10.0562, 1.01118, -2.6479  ,                1.21480, 10.1483, 21.6054, -0.10276  ,              9.41454  ,         &
   17.6142, 12.0144, 4.04183, 3.53346  ,                1.18865, 11.7660, 0.204785, 69.7957  ,              3.75591  ,         &
   19.8812, 18.0653, 11.0177, 1.94715  ,                0.019175, 1.13305, 10.1621, 28.3389  ,              -12.912  ,         &
   17.9163, 13.3417, 10.7990, 0.337905  ,                1.12446, 0.028781, 9.28206, 25.7228  ,              -6.3934  ,        &
   3.70250, 17.2356, 12.8876, 3.74290  ,                0.277200, 1.09580, 11.0040, 61.6584  ,              4.38750  ,         &
   21.1664, 18.2017, 11.7423, 2.30951  ,                0.014734, 1.03031, 9.53659, 26.6307  ,              -14.421  ,         &
   21.0149, 18.0992, 11.4632, 0.740625  ,                0.014345, 1.02238, 8.78809, 23.3452  ,              -14.316  ,        &
   17.8871, 11.1750, 6.57891, 0.000000  ,                1.03649, 8.48061, 0.058881, 0.000000  ,              0.344941  ,      &
   19.1301, 11.0948, 4.64901, 2.71263  ,                0.864132, 8.14487, 21.5707, 86.8472  ,              5.40428  ,         &
   19.2674, 12.9182, 4.86337, 1.56756  ,                0.808520, 8.43467, 24.7997, 94.2928  ,              5.37874  ,         &
   18.5638, 13.2885, 9.32602, 3.00964  ,                0.847329, 8.37164, 0.017662, 22.8870  ,              -3.1892  ,        &
   18.5003, 13.1787, 4.71304, 2.18535  ,                0.844582, 8.12534, 0.36495, 20.8504  ,              1.42357  ,         &
   19.2957, 14.3501, 4.73425, 1.28918  ,                0.751536, 8.21758, 25.8749, 98.6062  ,              5.32800  ,         &
   18.8785, 14.1259, 3.32515, -6.1989  ,                0.764252, 7.84438, 21.2487, -0.01036  ,              11.8678  ,        &
   18.8545, 13.9806, 2.53464, -5.6526  ,                0.760825, 7.62436, 19.3317, -0.01020  ,              11.2835  ,        &
   19.3319, 15.5017, 5.29537, 0.605844  ,                0.698655, 7.98929, 25.2052, 76.8986  ,              5.26593  ,        &
   19.1701, 15.2096, 4.32234, 0.000000  ,                0.696219, 7.55573, 22.5057, 0.000000  ,              5.29160  ,       &
   19.2493, 14.7900, 2.89289, -7.9492  ,                0.683839, 7.14833, 17.9144, 0.005127  ,              13.0174  ,        &
   19.2808, 16.6885, 4.80450, 1.04630  ,                0.644600, 7.47260, 24.6605, 99.8156  ,              5.17900  ,         &
   19.1812, 15.9719, 5.27475, 0.357534  ,                0.646179, 7.19123, 21.7326, 66.1147  ,              5.21572  ,        &
   19.1643, 16.2456, 4.37090, 0.000000  ,                0.645643, 7.18544, 21.4072, 0.000000  ,              5.21404  ,       &
   19.2214, 17.6444, 4.46100, 1.60290  ,                0.594600, 6.90890, 24.7008, 87.4825  ,              5.06940  ,         &
   19.1514, 17.2535, 4.47128, 0.000000  ,                0.597922, 6.80639, 20.2521, 0.000000  ,              5.11937  ,       &
   19.1624, 18.5596, 4.29480, 2.03960  ,                0.547600, 6.37760, 25.8499, 92.8029  ,              4.93910  ,         &
   19.1045, 18.1108, 3.78897, 0.000000  ,                0.551522, 6.32470, 17.3595, 0.000000  ,              4.99635  ,       &
   19.1889, 19.1005, 4.45850, 2.46630  ,                5.83030, 0.503100, 26.8909, 83.9571  ,              4.78210  ,         &
   19.1094, 19.0548, 4.56480, 0.487000  ,                0.503600, 5.83780, 23.3752, 62.2061  ,              4.78610  ,        &
   18.9333, 19.7131, 3.41820, 0.019300  ,                5.76400, 0.465500, 14.0049, -0.75830  ,              3.91820  ,       &
   19.6418, 19.0455, 5.03710, 2.68270  ,                5.30340, 0.460700, 27.9074, 75.2825  ,              4.59090  ,         &
   18.9755, 18.9330, 5.10789, 0.288753  ,                0.467196, 5.22126, 19.5902, 55.5113  ,              4.69626  ,        &
   19.8685, 19.0302, 2.41253, 0.000000  ,                5.44853, 0.467973, 14.1259, 0.000000  ,              4.69263  ,       &
   19.9644, 19.0138, 6.14487, 2.52390  ,                4.81742, 0.420885, 28.5284, 70.8403  ,              4.35200  ,         &
   20.1472, 18.9949, 7.51380, 2.27350  ,                4.34700, 0.381400, 27.7660, 66.8776  ,              4.07120  ,         &
   20.2332, 18.9970, 7.80690, 2.88680  ,                4.35790, 0.381500, 29.5259, 84.9304  ,              4.07140  ,         &
   20.2933, 19.0298, 8.97670, 1.99000  ,                3.92820, 0.344000, 26.4659, 64.2658  ,              3.71180  ,         &
   20.3892, 19.1062, 10.6620, 1.49530  ,                3.56900, 0.310700, 24.3879, 213.904  ,              3.33520  ,         &
   20.3524, 19.1278, 10.2821, 0.961500  ,                3.55200, 0.308600, 23.7128, 59.4565  ,              3.27910  ,        &
   20.3361, 19.2970, 10.8880, 2.69590  ,                3.21600, 0.275600, 20.2073, 167.202  ,              2.77310  ,         &
   20.1807, 19.1136, 10.9054, 0.77634  ,                3.21367, 0.283310, 20.0558, 51.7460  ,              3.02902  ,         &
   20.5780, 19.5990, 11.3727, 3.28719  ,                2.94817, 0.244475, 18.7726, 133.124  ,              2.14678  ,         &
   20.2489, 19.3763, 11.6323, 0.336048  ,                2.92070, 0.250698, 17.8211, 54.9453  ,              2.40860  ,        &
   21.1671, 19.7695, 11.8513, 3.33049  ,                2.81219, 0.226836, 17.6083, 127.113  ,              1.86264  ,         &
   20.8036, 19.5590, 11.9369, 0.612376  ,                2.77691, 0.231540, 16.5408, 43.1692  ,              2.09013  ,        &
   20.3235, 19.8186, 12.1233, 0.144583  ,                2.65941, 0.218850, 15.7992, 62.2355  ,              1.59180  ,        &
   22.0440, 19.6697, 12.3856, 2.82428  ,                2.77393, 0.222087, 16.7669, 143.644  ,              2.05830  ,         &
   21.3727, 19.7491, 12.1329, 0.975180  ,                2.64520, 0.214299, 15.3230, 36.4065  ,              1.77132  ,        &
   20.9413, 20.0539, 12.4668, 0.296689  ,                2.54467, 0.202481, 14.8137, 45.4643  ,              1.24285  ,        &
   22.6845, 19.6847, 12.7740, 2.85137  ,                2.66248, 0.210628, 15.8850, 137.903  ,              1.98486  ,         &
   21.9610, 19.9339, 12.1200, 1.51031  ,                2.52722, 0.199237, 14.1783, 30.8717  ,              1.47588  ,         &
   23.3405, 19.6095, 13.1235, 2.87516  ,                2.56270, 0.202088, 15.1009, 132.721  ,              2.02876  ,         &
   22.5527, 20.1108, 12.0671, 2.07492  ,                2.41740, 0.185769, 13.1275, 27.4491  ,              1.19499  ,         &
   24.0042, 19.4258, 13.4396, 2.89604  ,                2.47274, 0.196451, 14.3996, 128.007  ,              2.20963  ,         &
   23.1504, 20.2599, 11.9202, 2.71488  ,                2.31641, 0.174081, 12.1571, 24.8242  ,              0.954586  ,        &
   24.6274, 19.0886, 13.7603, 2.92270  ,                2.38790, 0.194200, 13.7546, 123.174  ,              2.57450  ,         &
   24.0063, 19.9504, 11.8034, 3.87243  ,                2.27783, 0.173530, 11.6096, 26.5156  ,              1.36389  ,         &
   23.7497, 20.3745, 11.8509, 3.26503  ,                2.22258, 0.163940, 11.3110, 22.9966  ,              0.759344  ,        &
   25.0709, 19.0798, 13.8518, 3.54545  ,                2.25341, 0.181951, 12.9331, 101.398  ,              2.41960  ,         &
   24.3466, 20.4208, 11.8708, 3.71490  ,                2.13553, 0.155525, 10.5782, 21.7029  ,              0.645089  ,        &
   25.8976, 18.2185, 14.3167, 2.95354  ,                2.24256, 0.196143, 12.6648, 115.362  ,              3.58324  ,         &
   24.9559, 20.3271, 12.2471, 3.77300  ,                2.05601, 0.149525, 10.0499, 21.2773  ,              0.691967  ,        &
   26.5070, 17.6383, 14.5596, 2.96577  ,                2.18020, 0.202172, 12.1899, 111.874  ,              4.29728  ,         &
   25.5395, 20.2861, 11.9812, 4.50073  ,                1.98040, 0.143384, 9.34972, 19.5810  ,              0.689690  ,        &
   26.9049, 17.2940, 14.5583, 3.63837  ,                2.07051, 0.197940, 11.4407, 92.6566  ,              4.56796  ,         &
   26.1296, 20.0994, 11.9788, 4.93676  ,                1.91072, 0.139358, 8.80018, 18.5908  ,              0.852795  ,        &
   27.6563, 16.4285, 14.9779, 2.98233  ,                2.07356, 0.223545, 11.3604, 105.703  ,              5.92046  ,         &
   26.7220, 19.7748, 12.1506, 5.17379  ,                1.84659, 0.137290, 8.36225, 17.8974  ,              1.17613  ,         &
   28.1819, 15.8851, 15.1542, 2.98706  ,                2.02859, 0.238849, 10.9975, 102.961  ,              6.75621  ,         &
   27.3083, 19.3320, 12.3339, 5.38348  ,                1.78711, 0.136974, 7.96778, 17.2922  ,              1.63929  ,         &
   28.6641, 15.4345, 15.3087, 2.98963  ,                1.98890, 0.257119, 10.6647, 100.417  ,              7.56672  ,         &
   28.1209, 17.6817, 13.3335, 5.14657  ,                1.78503, 0.159970, 8.18304, 20.3900  ,              3.70983  ,         &
   27.8917, 18.7614, 12.6072, 5.47647  ,                1.73272, 0.138790, 7.64412, 16.8153  ,              2.26001  ,         &
   28.9476, 15.2208, 15.1000, 3.71601  ,                1.90182, 9.98519, 0.261033, 84.3298  ,              7.97628  ,         &
   28.4628, 18.1210, 12.8429, 5.59415  ,                1.68216, 0.142292, 7.33727, 16.3535  ,              2.97573  ,         &
   29.1440, 15.1726, 14.7586, 4.30013  ,                1.83262, 9.59990, 0.275116, 72.0290  ,              8.58154  ,         &
   28.8131, 18.4601, 12.7285, 5.59927  ,                1.59136, 0.128903, 6.76232, 14.0366  ,              2.39699  ,         &
   29.2024, 15.2293, 14.5135, 4.76492  ,                1.77333, 9.37046, 0.295977, 63.3644  ,              9.24354  ,         &
   29.1587, 18.8407, 12.8268, 5.38695  ,                1.50711, 0.116741, 6.31524, 12.4244  ,              1.78555  ,         &
   29.0818, 15.4300, 14.4327, 5.11982  ,                1.72029, 9.22590, 0.321703, 57.0560  ,              9.88750  ,         &
   29.4936, 19.3763, 13.0544, 5.06412  ,                1.42755, 0.104621, 5.93667, 11.1972  ,              1.01074  ,         &
   28.7621, 15.7189, 14.5564, 5.44174  ,                1.67191, 9.09227, 0.350500, 52.0861  ,              10.4720  ,         &
   28.1894, 16.1550, 14.9305, 5.67589  ,                1.62903, 8.97948, 0.382661, 48.1647  ,              11.0005  ,         &
   30.4190, 15.2637, 14.7458, 5.06795  ,                1.37113, 6.84706, 0.165191, 18.0030  ,              6.49804  ,         &
   27.3049, 16.7296, 15.6115, 5.83377  ,                1.59279, 8.86553, 0.417916, 45.0011  ,              11.4722  ,         &
   30.4156, 15.8620, 13.6145, 5.82008  ,                1.34323, 7.10909, 0.204633, 20.3254  ,              8.27903  ,         &
   30.7058, 15.5512, 14.2326, 5.53672  ,                1.30923, 6.71983, 0.167252, 17.4911  ,              6.96824  ,         &
   27.0059, 17.7639, 15.7131, 5.78370  ,                1.51293, 8.81174, 0.424593, 38.6103  ,              11.6883  ,         &
   29.8429, 16.7224, 13.2153, 6.35234  ,                1.32927, 7.38979, 0.263297, 22.9426  ,              9.85329  ,         &
   30.9612, 15.9829, 13.7348, 5.92034  ,                1.24813, 6.60834, 0.168640, 16.9392  ,              7.39534  ,         &
   16.8819, 18.5913, 25.5582, 5.86000  ,                0.461100, 8.62160, 1.48260, 36.3956  ,              12.0658  ,         &
   28.0109, 17.8204, 14.3359, 6.58077  ,                1.35321, 7.73950, 0.356752, 26.4043  ,              11.2299  ,         &
   30.6886, 16.9029, 12.7801, 6.52354  ,                1.21990, 6.82872, 0.212867, 18.6590  ,              9.09680  ,         &
   20.6809, 19.0417, 21.6575, 5.96760  ,                0.545000, 8.44840, 1.57290, 38.3246  ,              12.6089  ,         &
   25.0853, 18.4973, 16.8883, 6.48216  ,                1.39507, 7.65105, 0.443378, 28.2262  ,              12.0205  ,         &
   29.5641, 18.0600, 12.8374, 6.89912  ,                1.21152, 7.05639, 0.284738, 20.7482  ,              10.6268  ,         &
   27.5446, 19.1584, 15.5380, 5.52593  ,                0.655150, 8.70751, 1.96347, 45.8149  ,              13.1746  ,         &
   21.3985, 20.4723, 18.7478, 6.82847  ,                1.47110, 0.517394, 7.43463, 28.8482  ,              12.5258  ,         &
   30.8695, 18.3841, 11.9328, 7.00574  ,                1.10080, 6.53852, 0.219074, 17.2114  ,              9.80270  ,         &
   31.0617, 13.0637, 18.4420, 5.96960  ,                0.690200, 2.35760, 8.61800, 47.2579  ,              13.4118  ,         &
   21.7886, 19.5682, 19.1406, 7.01107  ,                1.33660, 0.488383, 6.77270, 23.8132  ,              12.4734  ,         &
   32.1244, 18.8003, 12.0175, 6.96886  ,                1.00566, 6.10926, 0.147041, 14.7140  ,              8.08428  ,         &
   33.3689, 12.9510, 16.5877, 6.46920  ,                0.704000, 2.92380, 8.79370, 48.0093  ,              13.5782  ,         &
   21.8053, 19.5026, 19.1053, 7.10295  ,                1.23560, 6.24149, 0.469999, 20.3185  ,              12.4711  ,         &
   33.5364, 25.0946, 19.2497, 6.91555  ,                0.916540, 0.39042, 5.71414, 12.8285  ,              -6.7994  ,         &
   34.6726, 15.4733, 13.1138, 7.02588  ,                0.700999, 3.55078, 9.55642, 47.0045  ,              13.6770  ,         &
   35.3163, 19.0211, 9.49887, 7.42518  ,                0.685870, 3.97458, 11.3824, 45.4715  ,              13.7108  ,         &
   35.5631, 21.2816, 8.00370, 7.44330  ,                0.663100, 4.06910, 14.0422, 44.2473  ,              13.6905  ,         &
   35.9299, 23.0547, 12.1439, 2.11253  ,                0.646453, 4.17619, 23.1052, 150.645  ,              13.7247  ,         &
   35.7630, 22.9064, 12.4739, 3.21097  ,                0.616341, 3.87135, 19.9887, 142.325  ,              13.6211  ,         &
   35.2150, 21.6700, 7.91342, 7.65078  ,                0.604909, 3.57670, 12.6010, 29.8436  ,              13.5431  ,         &
   35.6597, 23.1032, 12.5977, 4.08655  ,                0.589092, 3.65155, 18.5990, 117.020  ,              13.5266  ,         &
   35.1736, 22.1112, 8.19216, 7.05545  ,                0.579689, 3.41437, 12.9187, 25.9443  ,              13.4637  ,         &
   35.5645, 23.4219, 12.7473, 4.80703  ,                0.563359, 3.46204, 17.8309, 99.1722  ,              13.4314  ,         &
   35.1007, 22.4418, 9.78554, 5.29444  ,                0.555054, 3.24498, 13.4661, 23.9533  ,              13.3760  ,         &
   35.8847, 23.2948, 14.1891, 4.17287  ,                0.547751, 3.41519, 16.9235, 105.251  ,              13.4287  ,         &
   36.0228, 23.4128, 14.9491, 4.18800  ,                0.529300, 3.32530, 16.0927, 100.613  ,              13.3966  ,         &
   35.5747, 22.5259, 12.2165, 5.37073  ,                0.520480, 3.12293, 12.7148, 26.3394  ,              13.3092  ,         &
   35.3715, 22.5326, 12.0291, 4.79840  ,                0.516598, 3.05053, 12.5723, 23.4582  ,              13.2671  ,         &
   34.8509, 22.7584, 14.0099, 1.21457  ,                0.507079, 2.89030, 13.1767, 25.2017  ,              13.1665  ,         &
   36.1874, 23.5964, 15.6402, 4.18550  ,                0.511929, 3.25396, 15.3622, 97.4908  ,              13.3573  ,         &
   35.7074, 22.6130, 12.9898, 5.43227  ,                0.502322, 3.03807, 12.1449, 25.4928  ,              13.2544  ,         &
   35.5103, 22.5787, 12.7766, 4.92159  ,                0.498626, 2.96627, 11.9484, 22.7502  ,              13.2116  ,         &
   35.0136, 22.7286, 14.3884, 1.75669  ,                0.489810, 2.81099, 12.3300, 22.6581  ,              13.1130  ,         &
   36.5254, 23.8083, 16.7707, 3.47947  ,                0.499384, 3.26371, 14.9455, 105.980  ,              13.3812  ,         &
   35.8400, 22.7169, 13.5807, 5.66016  ,                0.484938, 2.96118, 11.5331, 24.3992  ,              13.1991  ,         &
   35.6493, 22.6460, 13.3595, 5.18831  ,                0.481422, 2.89020, 11.3160, 21.8301  ,              13.1555  ,         &
   35.1736, 22.7181, 14.7635, 2.28678  ,                0.473204, 2.73848, 11.5530, 20.9303  ,              13.0582  ,         &
   36.6706, 24.0992, 17.3415, 3.49331  ,                0.483629, 3.20647, 14.3136, 102.273  ,              13.3592  ,         &
   36.6488, 24.4096, 17.3990, 4.21665  ,                0.465154, 3.08997, 13.4346, 88.4834  ,              13.2887  ,         &
   36.7881, 24.7736, 17.8919, 4.23284  ,                0.451018, 3.04619, 12.8946, 86.0030  ,              13.2754  ,         &
   36.9185, 25.1995, 18.3317, 4.24391  ,                0.437533, 3.00775, 12.4044, 83.7881  ,              13.2674  ,         &
   0.0, 0.0, 0.0, 0.0  ,                0.0, 0.0, 0.0, 0.0  ,              0.0  ,                                                       &
   0.0, 0.0, 0.0, 0.0  ,                0.0, 0.0, 0.0, 0.0  ,              0.0  ,                                                       &
   0.0, 0.0, 0.0, 0.0  ,                0.0, 0.0, 0.0, 0.0  ,              0.0  ,                                                       &
   0.0, 0.0, 0.0, 0.0  ,                0.0, 0.0, 0.0, 0.0  ,              0.0  ,                                                       &
   0.0, 0.0, 0.0, 0.0  ,                0.0, 0.0, 0.0, 0.0  ,              0.0  /) &
   ,(/9,220/) )


do il=1,220
if(trim(sname)==trim(Element(il)))f0=sum(x_att(1:4,il))+x_att(9,il)
if(trim(sname)==trim(Element(il)))print*,il
end do
print*,il,'x-ray f(0) is:',f0
END SUBROUTINE

SUBROUTINE NDIFFUSE2021  !(IIREF)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::NX,NY,NZ !,IIREF
INTEGER::I1,I2
INTEGER::D1,D2,D3,DK,MAXDIM,NMAX
integer::id1,id2,id3
INTEGER::KK
INTEGER,DIMENSION(IQMAX,3)::IND1
NMAX=100

DO ITYP=1,NTYP 
N1=SUM(NNTYPE(1:ITYP-1))+1
N2=SUM(NNTYPE(1:ITYP)) 
CCBBT(N1:N2)=CBBT(ITYP)
END DO
102 FORMAT(3F20.15)
103 FORMAT(10A3)
!!!!!!!!!!!!!!!!!!!!!!THINKING OF DIFFUSE SCATTERING!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
PRINT*,'Diffuse IT',IT
ID1=0
DO ITYP=1,NTYP
N1=SUM(NNTYPE(1:ITYP-1))+1
N2=SUM(NNTYPE(1:ITYP))
  DO D1=NMAX11,NMAX12 !0,NX
  DO D2=NMAX21,NMAX22 !0,NY
  DO D3=NMAX31,NMAX32 !0,NZ
  KK=KK+1
  IND1(KK,1)=D1
  IND1(KK,2)=D2
  IND1(KK,3)=D3
  END DO
  END DO
  END DO
!$omp  do private(D1,D2,D3)
  DO KK=1, IQMAX
  PRINT*, KK 
  D1=IND1(KK,1)
  D2=IND1(KK,2)
  D3=IND1(KK,3)
  QQQ(ABS(D1-NMAX11)+1, ABS(D2-NMAX21)+1,ABS(D3-NMAX31)+1,:)=(/ D1,D2,D3/)
  DIFF(ABS(D1-NMAX11)+1, ABS(D2-NMAX21)+1,ABS(D3-NMAX31)+1,ITYP)=DIFF(ABS(D1-NMAX11)+1, ABS(D2-NMAX21)+1,ABS(D3-NMAX31)+1,ITYP)+  ABS  (  CMPLX( SUM(COS(2.0*PI*MATMUL(RR1(N1:N2,:),QQQ(ABS(D1-NMAX11)+1, ABS(D2-NMAX21)+1,ABS(D3-NMAX31)+1,:)))),  SUM(SIN(2.0*PI*MATMUL(RR1(N1:N2,:),QQQ(ABS(D1-NMAX11)+1, ABS(D2-NMAX21)+1,ABS(D3-NMAX31)+1,:)))) )   )
  END DO
!$omp end  do
END DO
104 FORMAT(3F10.2,2E15.5)
IF(IT==IREF2)THEN
OPEN(103,FILE="DIFFU.vasp")
WRITE(103,*)'COMMENT PROBABILITY DENSITY'
WRITE(103,*)'1.0'
WRITE(103,*)ABS(NMAX11-NMAX12)+1,'0 0 ' 
WRITE(103,*)'0', ABS(NMAX21-NMAX22)+1,'0' 
WRITE(103,*)'0 0',ABS(NMAX31-NMAX32)+1 
WRITE(103,103)'C'   
WRITE(103,*)'1'    
WRITE(103,*)'D' 
WRITE(103,*)'0 0 0'
WRITE(103,*)
WRITE(103,*)ABS(NMAX11-NMAX12)+1,ABS(NMAX21-NMAX22)+1,ABS(NMAX31-NMAX32)+1  
WRITE(103,101)  (   (  (     SUM(CBBT(1:NTYP)*DIFF(ID1,ID2,ID3,1:NTYP))   , ID1=1,ABS(NMAX11-NMAX12)+1),   ID2=1,ABS(NMAX21-NMAX22)+1),  ID3=1,ABS(NMAX31-NMAX32)+1)                 
PRINT*,'DONE DIFFUSE'
END IF
101 FORMAT(5E12.5)
IF (IT.GE.(IREF2-IREF1+1))THEN
OPEN(104,FILE='Neutron.txt')
OPEN(105,FILE='X_Ray.txt')
DO D1=1,ABS(nmax11-nmax12)+1
DO D2=1,ABS(nmax21-nmax22)+1
DO D3=1,ABS(nmax31-nmax32)+1
WRITE(104,106)INT(QQQ(D1,D2,D3,:)),SUM(DIFF(D1,D2,D3,1:NTYP)*CBBT(1:NTYP)),CBBT(1:NTYP)*DIFF(D1,D2,D3,1:NTYP)
WRITE(105,106)INT(QQQ(D1,D2,D3,:)),SUM(DIFF(D1,D2,D3,1:NTYP)*ZELE(1:NTYP)),ZELE(1:NTYP)*DIFF(D1,D2,D3,1:NTYP)
END DO
END DO
END DO
ENDIF
106 FORMAT(3I8,100E15.6)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!DEALLOCATE(QQQ)
END SUBROUTINE




SUBROUTINE IIFQT333(IQQQQ)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::FQT,FFQTTYP!,SQWB
!COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::CFFQTTYP !,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::CFFQTTYP !,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:)::DUMMY !,SQWB
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
REAL,DIMENSION(NSTEP)::PHASE1
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::II1,I1,DT1,III
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DUMMY2,DUMMY4
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMYT
DOUBLE PRECISION::EE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK
INTEGER::ITYPPP,JTYPPP
INTEGER::IQQQQ,NNN2
CHARACTER::AA*9
INTEGER::NTYP2
INTEGER::IJ1,IJ2
INTEGER::IQTCAL
integer,allocatable,dimension(:)::plan
integer::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
INTEGER::KTYPPP
INTEGER,ALLOCATABLE,DIMENSION(:,:)::IND2
integer::i2,i3,i4,j2,j3,j4
integer::ityppp1,jtyppp1
IQTCAL=0         !!!!DO  NOT CALCLATE FQT
NTYP2=NTYP*(NTYP+1)/2
ALLOCATE(IND2(NTYP2,2))
print*,num_threads
PRINT*,NTYP2
WRITE(AA,'("CSQWTOT",I2.2)')IQQQQ
OPEN(170,FILE=AA)
WRITE(AA,'("ISQWTOT",I2.2)')IQQQQ
OPEN(180,FILE=AA)
IF(IQTCAL==1)WRITE(AA,'("CIQTTOT",I2.2)')IQQQQ
IF(IQTCAL==1)OPEN(190,FILE=AA)
IF(IQTCAL==1)WRITE(AA,'("IIQTTOT",I2.2)')IQQQQ
IF(IQTCAL==1)OPEN(200,FILE=AA)
!OPEN(17,FILE="CSQ")
!OPEN(18,FILE="ISQ")
IF(IQTCAL==1) OPEN(19,FILE="CIQ")
IF(IQTCAL==1)OPEN(20,FILE="IIQ")
PRINT*,'I AM IN FQT33'
ALLOCATE(FQT(1:NSTEP,NATOM))
ALLOCATE(FFQTTYP(1:NSTEP,NTYP))
!ALLOCATE(CFFQTTYP(1:NSTEP,NTYP,NTYP))
ALLOCATE(CFFQTTYP(1:NSTEP,NTYP2))
ALLOCATE(DUMMY(1:NSTEP))
allocate(plan(NATOM))
FQT=0
FFQTTYP=0
CFFQTTYP=0
IFOR= 1
IBAC=-1
PRINT*,AVGISLAT
PRINT*,NTYP
WRITE(AA,'("KKLIST",I2.2)')IQQQQ
OPEN(44,FILE=AA)
I=0
DO  
I=I+1 
READ(44,*,END=100)KLIST(I,:)
END DO
100 CONTINUE

PRINT*,'I M IN IIFQT333'
!####################################################################################
NQ=I-1
I=0
PRINT*,'NQ',NQ
ALLOCATE(QQ(NQ,3),QK(NQ,3))
PRINT*,'NSTEP',NSTEP
	FFQTTYP=0
	CFFQTTYP=0
        K=0
        DO I=1,NTYP
        DO J=I,NTYP
        K=K+1
        IND2(K,1)=I
        IND2(K,2)=J
        ENDDO
        ENDDO
!!!!!!!!!!!!!!!!!!!##########################################################################        
!$OMP PARALLEL DO PRIVATE(I,I2,FQT,plann,KTYPPP,ITYPPP,PHASE1,DUMMY) reduction(+:FFQTTYP) reduction(+:CFFQTTYP) 
DO IQ=1,NQ
        FQT=0
        QQ(IQ,:)=2.0*PI*MATMUL(AVGISLAT,KLIST(IQ,:)) !VEC
        !QQ(IQ,:)=2.0*PI*MATMUL(KLIST(IQ,:),AVGISLAT) !VEC
        DO I=1,NATOM
        PHASE1=QQ(IQ,1)*POS(1:NSTEPORIG,I,1) + QQ(IQ,2)*POS(1:NSTEPORIG,I,2)+ QQ(IQ,3)*POS(1:NSTEPORIG,I,3)
        FQT(1:NSTEPORIG,I)=CMPLX(COS(PHASE1(1:NSTEPORIG)),SIN(PHASE1(1:NSTEPORIG)))
        call dfftw_plan_dft_1d(plann,NSTEP,FQT(:,I),FQT(:,I),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, FQT(:,I),FQT(:,I))
        call dfftw_destroy_plan(plann)
        FQT(:,I)=FQT(:,I)/REAL(NSTEPORIG)
        END DO

        DO ITYPPP=1,NTYP
        FFQTTYP(1:NSTEP,ITYPPP)= IBBT2(ITYPPP)*IBBT2(ITYPPP)*SUM(FQT(1:NSTEP, SUM(NNTYPE(1:ITYPPP-1))+1 : SUM(NNTYPE(1:ITYPPP))) * CONJG(FQT(1:NSTEP, SUM(NNTYPE(1:ITYPPP-1))+1 : SUM(NNTYPE(1:ITYPPP)))),DIM=2 )
        END DO



        DO KTYPPP=1,NTYP2
        DO I2=SUM(NNTYPE(1:IND2(KTYPPP,1)-1))+1,SUM(NNTYPE(1:IND2(KTYPPP,1))) !NATOM
        DUMMY(1:NSTEP)=  FQT(1:NSTEP,I2) *CONJG(SUM(FQT(1:NSTEP,SUM(NNTYPE(1:IND2(KTYPPP,2)-1))+1 : SUM(NNTYPE(1:IND2(KTYPPP,2)))),DIM=2) )
        END DO
        !CFFQTTYP(1:NSTEP,IND2(KTYPPP,1),IND2(KTYPPP,2))=  DUMMY 
        CFFQTTYP(1:NSTEP,KTYPPP)=  BBT(IND2(KTYPPP,1))*BBT(IND2(KTYPPP,2))*DUMMY 
        END DO

END DO    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!QLOOP ENDS
!$omp end parallel do
		DO DT=1,NSTEP
		OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
		WRITE(180,15)OMEGA,REAL(FFQTTYP(DT,1:NTYP)),REAL(SUM(FFQTTYP(DT,:))) !   ( SUM(DUMMY2(1:NQ,ITYP,DT)) / NQ   ,ITYP=1,NTYP+1) !,SUM(DUMMY2(1:NQ,:,DT))/NQ
		END DO

	DO DT=1,NSTEP
	OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
	!WRITE(170,15)OMEGA,( ( REAL(CFFQTTYP(DT,IJ1,IJ2)) , IJ2=IJ1,NTYP ),IJ1=1,NTYP) ,REAL(SUM(CFFQTTYP(DT,:,:))) !                  (  SUM(DUMMY2(1:NQ,ITYP,DT) )/NQ,ITYP=1,NTYP2),DUMMYT(DT) 
	WRITE(170,15)OMEGA, ( REAL(CFFQTTYP(DT,IJ1)) ,IJ1=1,NTYP2) !,(REAL(SUM(CFFQTTYP(DT,:,:))) !                  (  SUM(DUMMY2(1:NQ,ITYP,DT) )/NQ,ITYP=1,NTYP2),DUMMYT(DT) 
	END DO
	17 FORMAT(A12,2X,3F10.5)
        15 FORMAT(F15.4,1003E20.4)
	170 FORMAT(A12,100(3X,3F6.2,3X))
	172 FORMAT(A12,<NQ>(3X,3F6.2,3X),6X,'AVG OVER Q')
	171 FORMAT(A3,12X,<NTYP>(8X,'avg',A3,10X) )
	173 FORMAT(A3,12X,<NTYP2>(8X,'avg',2A3,10X) )
CLOSE(190)
CLOSE(200)
!CLOSE(19)
!CLOSE(20)
CLOSE(44)
!DEALLOCATE(FQT,FFQTTYP,CFFQTTYP,DUMMY1,DUMMY2,DUMMY3,DUMMY4, AAA)
!DEALLOCATE(FQT,FFQT,AAA)
END SUBROUTINE


SUBROUTINE IIFQT8(IQQQQ,QHKL)   !!!!!!!!!!THIS IS with velcoity projection
use omp_lib
USE VARIABLES1, only :ICARTESIAN,PI,AVGISLAT,POS,MASS,VEL,NSTEPORIG,ICOH,IBROAD,FWHM0,FWHM1,NTYP,NSTEP,NATOM,DELT,ICUT,NDOS
IMPLICIT NONE
INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::EQT,EQL!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::MEQT,MEQL!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:)::IEQT,IEQL!,SQWB
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1,QHKL,kvecn
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2,DEN
DOUBLE PRECISION,DIMENSION(NSTEP)::PHASE
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::IQQQQ,NNN2
CHARACTER::AA*12
integer::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK
INTEGER::DT,IT
REAL::OMEGA
INTEGER::I,J

DOUBLE PRECISION,DIMENSION(NDOS)::DUMMY1,DUMMY2
PRINT*,'I M IN ACOUSTIC'
WRITE(AA,'("ACOUSTIC",I4.4)')IQQQQ
OPEN(100+IQQQQ,FILE=AA)
ALLOCATE(EQT(1:NSTEP,3))
ALLOCATE(EQL(1:NSTEP,3))
ALLOCATE(MEQT(1:NSTEP,3))
ALLOCATE(MEQL(1:NSTEP,3))
ALLOCATE(IEQL(1:NSTEP))
ALLOCATE(IEQT(1:NSTEP))
IFOR= 1
IBAC=-1
NQ=1
ALLOCATE(QQ(NQ,3),QK(NQ,3))
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        IQ=1
        QQ(IQ,:)=QHKL    !KLIST(IQ,:) !VEC
        !IF(ICARTESIAN==1)THEN
        !KVEC=QHKL        !KLIST(IQ,:)
        !ELSE
        !!KVEC=2.0*PI*MATMUL(AVGISLAT,QHKL )        !CHANGED AVGISLAT TO ISLAT
        !END IF
        !KVEC=2.0*PI*MATMUL(QHKL,AVGISLAT)        !CHANGED AVGISLAT TO ISLAT
        KVEC=2.0*PI*MATMUL(AVGISLAT,QHKL)        !CHANGED AVGISLAT TO ISLAT
        QK(IQ,:)=KVEC
        EQT=0
        EQL=0

        DO I=1,NATOM
        PHASE(:)=KVEC(1)*POS(:,I,1) + KVEC(2)*POS(:,I,2) + KVEC(3)*POS(:,I,3)
        DEN=NORM2(KVEC)
        KVECN=KVEC/DEN !NORM2(KVEC) 
        EQT(:,1)=EQT(:,1) +   ( VEL(:,I,1) -  KVECN(1)*(VEL(:,I,1)*KVECN(1)+VEL(:,I,2)*KVECN(2)+VEL(:,I,3)*KVECN(3)))*CMPLX(COS(PHASE),SIN(PHASE))
        EQT(:,2)=EQT(:,2) +   ( VEL(:,I,2) -  KVECN(2)*(VEL(:,I,1)*KVECN(1)+VEL(:,I,2)*KVECN(2)+VEL(:,I,3)*KVECN(3)))*CMPLX(COS(PHASE),SIN(PHASE))
        EQT(:,3)=EQT(:,3) +   ( VEL(:,I,3) -  KVECN(3)*(VEL(:,I,1)*KVECN(1)+VEL(:,I,2)*KVECN(2)+VEL(:,I,3)*KVECN(3)))*CMPLX(COS(PHASE),SIN(PHASE))
        EQL(:,1)=EQL(:,1) +    KVECN(1)*(VEL(:,I,1)*KVECN(1)+VEL(:,I,2)*KVECN(2)+VEL(:,I,3)*KVECN(3))*CMPLX(COS(PHASE),SIN(PHASE))
        EQL(:,2)=EQL(:,2) +    KVECN(2)*(VEL(:,I,1)*KVECN(1)+VEL(:,I,2)*KVECN(2)+VEL(:,I,3)*KVECN(3))*CMPLX(COS(PHASE),SIN(PHASE))
        EQL(:,3)=EQL(:,3) +    KVECN(3)*(VEL(:,I,1)*KVECN(1)+VEL(:,I,2)*KVECN(2)+VEL(:,I,3)*KVECN(3))*CMPLX(COS(PHASE),SIN(PHASE))
        END DO
        IF(DEN==0)EQT=0 
        IF(DEN==0)EQL=0 
        IEQT=0
        IEQL=0
        IF(DEN.NE.0)THEN
        call dfftw_plan_dft_1d(plann,NSTEP,EQT(:,1),EQT(:,1),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, EQT(:,1),EQT(:,1))
        call dfftw_destroy_plan(plann)
        call dfftw_plan_dft_1d(plann,NSTEP,EQT(:,2),EQT(:,2),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, EQT(:,2),EQT(:,2))
        call dfftw_destroy_plan(plann)
        call dfftw_plan_dft_1d(plann,NSTEP,EQT(:,3),EQT(:,3),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, EQT(:,3),EQT(:,3))
        call dfftw_destroy_plan(plann)
        call dfftw_plan_dft_1d(plann,NSTEP,EQL(:,1),EQL(:,1),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, EQL(:,1),EQL(:,1))
        call dfftw_destroy_plan(plann)
        call dfftw_plan_dft_1d(plann,NSTEP,EQL(:,2),EQL(:,2),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, EQL(:,2),EQL(:,2))
        call dfftw_destroy_plan(plann)
        call dfftw_plan_dft_1d(plann,NSTEP,EQL(:,3),EQL(:,3),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, EQL(:,3),EQL(:,3))
        call dfftw_destroy_plan(plann)
        EQT(:,:)=EQT(:,:)/REAL(NSTEPORIG)
        IEQT(:)=SUM(EQT*CONJG(EQT),DIM=2)
        EQL(:,:)=EQL(:,:)/REAL(NSTEPORIG)
        IEQL(:)=SUM(EQL*CONJG(EQL),DIM=2)
        DUMMY1=0
        DUMMY2=0
        DUMMY1=IEQT(1:NDOS)
        IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
        IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
        IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
        IEQT(1:NDOS)=DUMMY2
        DUMMY1=0
        DUMMY2=0
        DUMMY1=IEQL(1:NDOS)
        IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
        IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
        IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
        IEQL(1:NDOS)=DUMMY2
        END IF


        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        WRITE(100+IQQQQ,15) OMEGA,IEQT(DT),IEQL(DT)
        END DO
        15 FORMAT(F15.4,2(2E20.2,4x))
        CLOSE(100+IQQQQ)
DEALLOCATE(EQT,IEQT)
END SUBROUTINE

SUBROUTINE IIFQT88(NQ)   !!!!!!!!!!THIS IS with velcoity projection
use omp_lib
USE VARIABLES1, only :ICARTESIAN,PI,AVGISLAT,POS,MASS,VEL,NSTEPORIG,ICOH,IBROAD,FWHM0,FWHM1,NTYP,NSTEP,NATOM,DELT,ICUT,NDOS,KLIST
IMPLICIT NONE
INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::EQT,EQL!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::MEQT,MEQL!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:)::IEQT,IEQL!,SQWB
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1,QHKL,kvecn
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2,DEN
DOUBLE PRECISION,DIMENSION(NSTEP)::PHASE
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::IQQQQ,NNN2
CHARACTER::AA*12
integer::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK
INTEGER::DT,IT
REAL::OMEGA
INTEGER::I,J

DOUBLE PRECISION,DIMENSION(NDOS)::DUMMY1,DUMMY2
!OPEN(124,FILE="KVALUES")
!READ(124,*)NQ
!ALLOCATE(QQ(NQ,3),QK(NQ,3))
!DO I=1,NQ
!READ(124,*)QQ(I,:)
!END DO
!CLOSE(124)

ALLOCATE(EQT(1:NSTEP,3))
ALLOCATE(EQL(1:NSTEP,3))
ALLOCATE(MEQT(1:NSTEP,3))
ALLOCATE(MEQL(1:NSTEP,3))
ALLOCATE(IEQL(1:NSTEP))
ALLOCATE(IEQT(1:NSTEP))
IFOR= 1
IBAC=-1




!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

!$omp parallel do  private(AA,KVEC,EQT,EQL,DUMMY1,DUMMY2,plann,DEN,KVECN,PHASE,OMEGA)
DO      IQ=1,NQ
        PRINT*,'I M IN ACOUSTIC'
        WRITE(AA,'("ACOUSTIC",I4.4)')IQ
        OPEN(100+IQ,FILE=AA)
        KVEC=2.0*PI*MATMUL(AVGISLAT,KLIST(IQ,:) )        !CHANGED AVGISLAT TO ISLAT
        !KVEC=2.0*PI*MATMUL(KLIST(IQ,:),AVGISLAT )        !CHANGED AVGISLAT TO ISLAT
        EQT=0
        EQL=0
        DO I=1,NATOM
        PHASE(:)=KVEC(1)*POS(:,I,1) + KVEC(2)*POS(:,I,2) + KVEC(3)*POS(:,I,3)
        DEN=NORM2(KVEC)
        KVECN=KVEC/DEN !NORM2(KVEC) 
        EQT(:,1)=EQT(:,1) +   ( VEL(:,I,1) -  KVECN(1)*(VEL(:,I,1)*KVECN(1)+VEL(:,I,2)*KVECN(2)+VEL(:,I,3)*KVECN(3)))*CMPLX(COS(PHASE),SIN(PHASE))
        EQT(:,2)=EQT(:,2) +   ( VEL(:,I,2) -  KVECN(2)*(VEL(:,I,1)*KVECN(1)+VEL(:,I,2)*KVECN(2)+VEL(:,I,3)*KVECN(3)))*CMPLX(COS(PHASE),SIN(PHASE))
        EQT(:,3)=EQT(:,3) +   ( VEL(:,I,3) -  KVECN(3)*(VEL(:,I,1)*KVECN(1)+VEL(:,I,2)*KVECN(2)+VEL(:,I,3)*KVECN(3)))*CMPLX(COS(PHASE),SIN(PHASE))
        EQL(:,1)=EQL(:,1) +    KVECN(1)*(VEL(:,I,1)*KVECN(1)+VEL(:,I,2)*KVECN(2)+VEL(:,I,3)*KVECN(3))*CMPLX(COS(PHASE),SIN(PHASE))
        EQL(:,2)=EQL(:,2) +    KVECN(2)*(VEL(:,I,1)*KVECN(1)+VEL(:,I,2)*KVECN(2)+VEL(:,I,3)*KVECN(3))*CMPLX(COS(PHASE),SIN(PHASE))
        EQL(:,3)=EQL(:,3) +    KVECN(3)*(VEL(:,I,1)*KVECN(1)+VEL(:,I,2)*KVECN(2)+VEL(:,I,3)*KVECN(3))*CMPLX(COS(PHASE),SIN(PHASE))
        END DO
        IF(DEN==0)EQT=0 
        IF(DEN==0)EQL=0 
        IEQT=0
        IEQL=0
        IF(DEN.NE.0)THEN
        call dfftw_plan_dft_1d(plann,NSTEP,EQT(:,1),EQT(:,1),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, EQT(:,1),EQT(:,1))
        call dfftw_destroy_plan(plann)
        call dfftw_plan_dft_1d(plann,NSTEP,EQT(:,2),EQT(:,2),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, EQT(:,2),EQT(:,2))
        call dfftw_destroy_plan(plann)
        call dfftw_plan_dft_1d(plann,NSTEP,EQT(:,3),EQT(:,3),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, EQT(:,3),EQT(:,3))
        call dfftw_destroy_plan(plann)
        call dfftw_plan_dft_1d(plann,NSTEP,EQL(:,1),EQL(:,1),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, EQL(:,1),EQL(:,1))
        call dfftw_destroy_plan(plann)
        call dfftw_plan_dft_1d(plann,NSTEP,EQL(:,2),EQL(:,2),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, EQL(:,2),EQL(:,2))
        call dfftw_destroy_plan(plann)
        call dfftw_plan_dft_1d(plann,NSTEP,EQL(:,3),EQL(:,3),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, EQL(:,3),EQL(:,3))
        call dfftw_destroy_plan(plann)
        EQT(:,:)=EQT(:,:)/REAL(NSTEPORIG)
        IEQT(:)=SUM(EQT*CONJG(EQT),DIM=2)
        EQL(:,:)=EQL(:,:)/REAL(NSTEPORIG)
        IEQL(:)=SUM(EQL*CONJG(EQL),DIM=2)
        DUMMY1=0
        DUMMY2=0
        DUMMY1=IEQT(1:NDOS)
        IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
        IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
        IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
        IEQT(1:NDOS)=DUMMY2
        DUMMY1=0
        DUMMY2=0
        DUMMY1=IEQL(1:NDOS)
        IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
        IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY2)
        IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY2)
        IEQL(1:NDOS)=DUMMY2
        END IF


        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        WRITE(100+IQ,15) OMEGA,IEQT(DT),IEQL(DT)
        END DO
        15 FORMAT(F15.4,2(2E20.2,4x))
        CLOSE(100+IQ)

END DO
!$omp end parallel do
DEALLOCATE(EQT,IEQT)
END SUBROUTINE

SUBROUTINE IIFQT9(IQQQQ)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::FQT,FFQTTYP!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::CFFQTTYP !,SQWB
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
REAL,DIMENSION(NSTEP)::PHASE1
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::II1,I1,DT1,III
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DUMMY2,DUMMY4
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMYT
DOUBLE PRECISION::EE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK
INTEGER::ITYPPP,JTYPPP
INTEGER::IQQQQ,NNN2
CHARACTER::AA*9
INTEGER::NTYP2
INTEGER::IJ1,IJ2
INTEGER::IQTCAL
integer,allocatable,dimension(:)::plan
integer::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
INTEGER::KTYPPP
INTEGER,ALLOCATABLE,DIMENSION(:,:)::IND2
IQTCAL=0         !!!!DO  NOT CALCLATE FQT
NTYP2=NTYP*(NTYP+1)/2
ALLOCATE(IND2(NTYP2,2))
print*,num_threads

PRINT*,NTYP2
WRITE(AA,'("CSQWTOT",I2.2)')IQQQQ
OPEN(170,FILE=AA)
WRITE(AA,'("ISQWTOT",I2.2)')IQQQQ
OPEN(180,FILE=AA)
IF(IQTCAL==1)WRITE(AA,'("CIQTTOT",I2.2)')IQQQQ
IF(IQTCAL==1)OPEN(190,FILE=AA)
IF(IQTCAL==1)WRITE(AA,'("IIQTTOT",I2.2)')IQQQQ
IF(IQTCAL==1)OPEN(200,FILE=AA)
!OPEN(17,FILE="CSQ")
!OPEN(18,FILE="ISQ")
IF(IQTCAL==1) OPEN(19,FILE="CIQ")
IF(IQTCAL==1)OPEN(20,FILE="IIQ")
PRINT*,'I AM IN FQT33'
ALLOCATE(FQT(1:NSTEP,NATOM))
ALLOCATE(FFQTTYP(1:NSTEP,NTYP))
ALLOCATE(CFFQTTYP(1:NSTEP,NTYP,NTYP))
allocate(plan(NATOM))
FQT=0
FFQTTYP=0
CFFQTTYP=0
IFOR= 1
IBAC=-1
PRINT*,AVGISLAT
PRINT*,NTYP
NQ=1
ALLOCATE(QQ(NQ,3),QK(NQ,3))

PRINT*,'NSTEP',NSTEP
	FFQTTYP=0
	CFFQTTYP=0

        K=0
        DO I=1,NTYP
        DO J=I,NTYP
        K=K+1
        IND2(K,1)=I
        IND2(K,2)=J
        ENDDO
        ENDDO
        
IQ=IQQQQ
        PRINT*,'IQ=',IQ
	QQ(IQ,:)=KLIST(IQ,:) !VEC
        PRINT*,'QQ=',QQ(IQ,:)
	!IF(ICARTESIAN==1)THEN
        !KVEC=KLIST(IQ,:)
        !ELSE
        !KVEC=2.0*PI*MATMUL(AVGISLAT,KLIST(IQ,:) )        !CHANGED AVGISLAT TO ISLAT
        !END IF
        !KVEC=2.0*PI*MATMUL(KLIST(IQ,:),AVGISLAT )        !CHANGED AVGISLAT TO ISLAT
        KVEC=2.0*PI*MATMUL(AVGISLAT,KLIST(IQ,:) )        !CHANGED AVGISLAT TO ISLAT
	QK(IQ,:)=KVEC
        DO I=1,NATOM
	!$omp parallel do
        DO IT=1,NSTEPORIG  
        PHASE1(IT)=DOT_PRODUCT(KVEC,POS(IT,I,:))
        FQT(IT,I)=CMPLX(COS(PHASE1(IT)),SIN(PHASE1(IT)))
        END DO
	!$omp end parallel do
        call dfftw_plan_dft_1d(plann,NSTEP,FQT(:,I),FQT(:,I),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, FQT(:,I),FQT(:,I))
        call dfftw_destroy_plan(plann)
        FQT(:,I)=FQT(:,I)/REAL(NSTEPORIG)
        END DO

        PRINT*,'I AM IN INCOHERENT33'
        DO ITYPPP=1,NTYP
        FFQTTYP(1:NSTEP,ITYPPP)=FFQTTYP(1:NSTEP,ITYPPP) +  SUM(FQT(1:NSTEP, SUM(NNTYPE(1:ITYPPP-1))+1 : SUM(NNTYPE(1:ITYPPP))) * CONJG(FQT(1:NSTEP, SUM(NNTYPE(1:ITYPPP-1))+1 : SUM(NNTYPE(1:ITYPPP)))),DIM=2 )
        END DO
	!DO DT=1,NSTEP
	!WRITE(18,15)REAL(DT)*DELT,REAL(FFQTTYP(DT,1:NTYP))  ,SUM(REAL(FFQTTYP(DT,:))) , SUM(AIMAG(FFQTTYP(DT,:))) !/REAL(FFQTTYP(1,:)) !,SUM(REAL(FFQTTYP(DT,1:NTYP)))/SUM(REAL(FFQTTYP(1,1:NTYP))) !NATOM
	!END DO

	IF(IQTCAL==1)THEN
	DO I=1,NTYP
        call dfftw_plan_dft_1d(plan(i),NSTEP,FFQTTYP(:,I),FFQTTYP(:,I),IBAC,FFTW_ESTIMATE)
        call dfftw_execute_dft(plan(i), FFQTTYP(:,I),FFQTTYP(:,I))
        call dfftw_destroy_plan(plan(i))
        FFQTTYP(:,I)=FFQTTYP(:,I)/REAL(NSTEPORIG)
	END DO
	DO DT=1,NSTEP	
	WRITE(20,15)REAL(DT)*DELT,REAL(FFQTTYP(DT,1:NTYP)) !/(REAL(FFQTTYP(1,:))) !,(SUM(REAL(FFQT(DT,:))))/SUM(REAL(FFQT(1,:)))
	END DO
	END IF


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!COHERENT CASE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!COHERENT
!CASE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        !IF (ICOH==1.or.ICOH==3)THEN               !COHRENT CASE
        PRINT*,'I AM IN COHERENT'
!        CFFQTTYP=0
        !$omp parallel do
        DO ITYPPP=1,NTYP
        !DO JTYPPP=ITYPPP,NTYP
        DO JTYPPP=1,NTYP
        DO I=SUM(NNTYPE(1:ITYPPP-1))+1,SUM(NNTYPE(1:ITYPPP)) !NATOM
        DO J=SUM(NNTYPE(1:JTYPPP-1))+1,SUM(NNTYPE(1:JTYPPP)) !NATOM
!        CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP)=CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP)+(FQT(1:NSTEP,I))*CONJG(FQT(1:NSTEP,J))
!CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP)=CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP) +
!SUM(FQT(1:NSTEP, SUM(NNTYPE(1:ITYPPP-1))+1 : SUM(NNTYPE(1:ITYPPP))) *
!CONJG(FQT(1:NSTEP, SUM(NNTYPE(1:JTYPPP-1))+1 : SUM(NNTYPE(1:JTYPPP)))),DIM=2 )
CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP)=CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP) +FQT(1:NSTEP,I) * CONJG(FQT(1:NSTEP, J) )

        END DO
        END DO
        END DO
        END DO
        !$omp end parallel do
        !SQW SQW SQW SQW SQW SQW SQW
        DO DT=1,NSTEP
        WRITE(17,15) REAL(DT)*DELT, ( ( REAL(CFFQTTYP(DT,IJ1,IJ2)) ,IJ2=IJ1,NTYP ),IJ1=1,NTYP) !,SUM(REAL(CFFQTTYP(DT,:,:)))/SUM(REAL(CFFQTTYP(1,:,:))) !NATOM
        END DO



!	PRINT*,'I AM IN COHERENT33'


        !ITYPPP=1
        !JTYPPP=0
        !!$omp parallel do 
!        DO KTYPPP=1,NTYP2
        !JTYPPP=JTYPPP+1
        !IF(JTYPPP.GT.NTYP)THEN
        !ITYPPP=ITYPPP+1
        !JTYPPP=ITYPPP
        !ITYPPP=IND2(KTYPPP,1)
        !JTYPPP=IND2(KTYPPP,2)
!        PRINT*,IND2(KTYPPP,1),IND2(KTYPPP,2) !ITYPPP,JTYPPP
        !DO ITYPPP=1,NTYP
        !DO JTYPPP=1,NTYP
!        DO I=SUM(NNTYPE(1:IND2(KTYPPP,1)-1))+1,SUM(NNTYPE(1:IND2(KTYPPP,1))) !NATOM
        !DO J=SUM(NNTYPE(1:JTYPPP-1))+1,SUM(NNTYPE(1:JTYPPP)) !NATOM
        !CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP)=CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP) +   FQT(1:NSTEP,I) * CONJG(FQT(1:NSTEP, J) )
!        CFFQTTYP(1:NSTEP,IND2(KTYPPP,1),IND2(KTYPPP,2))=CFFQTTYP(1:NSTEP,IND2(KTYPPP,1),IND2(KTYPPP,2)) +   FQT(1:NSTEP,I) *CONJG(SUM(FQT(1:NSTEP,SUM(NNTYPE(1:IND2(KTYPPP,2)-1))+1 : SUM(NNTYPE(1:IND2(KTYPPP,2)))),DIM=2) )
	!END DO
!        END DO
        !END DO
        !END DO
!        END DO
	!!$omp end parallel do

        DO I=1,NTYP
        DO J=I,NTYP        
        
        IF(i.ne.j)CFFQTTYP(1:NSTEP,J,I)=CFFQTTYP(1:NSTEP,I,J)
        END DO
        END DO
        
        
        
        
        
        
        
        
        
        
        
        !	DO DT=1,NSTEP
!        WRITE(17,15) REAL(DT)*DELT, ( ( REAL(CFFQTTYP(DT,IJ1,IJ2)) , IJ2=IJ1,NTYP ),IJ1=1,NTYP) ! ,SUM(REAL(CFFQTTYP(DT,:,:)))/SUM(REAL(CFFQTTYP(1,:,:))) !NATOM
!	END DO

        IF( IQTCAL==1)THEN
!	!$omp parallel do
	DO I=1,NTYP  !*(NTYP+1)/2
	DO J=I,NTYP  !*(NTYP+1)/2
        call dfftw_plan_dft_1d(plan(j),NSTEP,CFFQTTYP(:,I,J),CFFQTTYP(:,I,J),IBAC,FFTW_ESTIMATE)
	call dfftw_execute_dft(plan(j), CFFQTTYP(:,I,J),CFFQTTYP(:,I,J))
	call dfftw_destroy_plan(plan(j))
	CFFQTTYP(:,I,J)=CFFQTTYP(:,I,J)/REAL(NSTEPORIG) !CMPLX(AAA(I,1:2*NSTEP:2),AAA(I,2:2*NSTEP:2))
	END DO
        END DO
!	!$omp end parallel do
	DO DT=1,NSTEP	
        WRITE(19,15) REAL(DT)*DELT, ( ( REAL(CFFQTTYP(DT,IJ1,IJ2)) , IJ1=1,NTYP ),IJ2=IJ1,NTYP) ! ,SUM(REAL(CFFQTTYP(DT,:,:)))/SUM(REAL(CFFQTTYP(1,:,:))) !NATOM
	END DO
        END IF

!REWIND(17)
!REWIND(18)
REWIND(19)
REWIND(20)

		DO DT=1,NSTEP
		OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
		WRITE(180,15)OMEGA,REAL(FFQTTYP(DT,1:NTYP)),REAL(SUM(FFQTTYP(DT,:))) !   ( SUM(DUMMY2(1:NQ,ITYP,DT)) / NQ   ,ITYP=1,NTYP+1) !,SUM(DUMMY2(1:NQ,:,DT))/NQ
		END DO

	DO DT=1,NSTEP
	OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
	WRITE(170,15)OMEGA,( ( REAL(CFFQTTYP(DT,IJ1,IJ2)) , IJ2=IJ1,NTYP ),IJ1=1,NTYP) ,REAL(SUM(CFFQTTYP(DT,:,:))) !                  (  SUM(DUMMY2(1:NQ,ITYP,DT) )/NQ,ITYP=1,NTYP2),DUMMYT(DT) 
	END DO
	17 FORMAT(A12,2X,3F10.5)
        15 FORMAT(F15.4,1003E20.4)
	170 FORMAT(A12,100(3X,3F6.2,3X))
	172 FORMAT(A12,<NQ>(3X,3F6.2,3X),6X,'AVG OVER Q')
	171 FORMAT(A3,12X,<NTYP>(8X,'avg',A3,10X) )
	173 FORMAT(A3,12X,<NTYP2>(8X,'avg',2A3,10X) )
!CLOSE(170)
!CLOSE(180)
CLOSE(190)
CLOSE(200)
!CLOSE(17)
!CLOSE(18)
CLOSE(19)
CLOSE(20)
CLOSE(44)
!DEALLOCATE(FQT,FFQTTYP,CFFQTTYP,DUMMY1,DUMMY2,DUMMY3,DUMMY4, AAA)
!DEALLOCATE(FQT,FFQT,AAA)
END SUBROUTINE


SUBROUTINE CHGCAR2022TOTAL
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::NX,NY,NZ,IIREF
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::CHG
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(NNTYPE(IIREF),3)::DPOS
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(NNTYPE(IIREF))::FIRE !DPOS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DPOS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::FIRE !DPOS
INTEGER::I1,I2
DOUBLE PRECISION::DX,DY,DZ
DOUBLE PRECISION::DX1,DY1,DZ1
DOUBLE PRECISION::DX2,DY2,DZ2
!INTEGER,DIMENSION(NNTYPE(IIREF),3)::NNBIN
INTEGER,ALLOCATABLE,DIMENSION(:,:)::NNBIN
INTEGER::IKK,INDDD
REAL::SIG
INTEGER::XI,YI,ZI
INTEGER::ISMEAR,NMAX
CHARACTER*11::AAAA
CHARACTER*100::ABC2

DOUBLE PRECISION::PVOLUME,DV
DOUBLE PRECISION::NTIMES
!INTEGER,DIMENSION(3)::NSS

OPEN(111,FILE="REF.vasp")
!NSS=(/10,10,10/)
!!!!!!!!!!!!!!!!!
ALLOCATE(DPOS(NATOM,3))
ALLOCATE(FIRE(NATOM))
ALLOCATE(NNBIN(NATOM,3))
!!!!!!!!!!!!!!!
ISMEAR=1
SIG=1
PRINT*,ISLAT(1,:)
PRINT*,ISLAT(2,:)
PRINT*,ISLAT(3,:)
NMAX=100
NX=NMAX
NY=NMAX
NZ=NMAX
ALLOCATE(CHG(0:NX,0:NY,0:NZ))
CHG=0
!I1=SUM(NNTYPE(1:IIREF-1))+1
!I2=SUM(NNTYPE(1:IIREF))
!WRITE(AAAA,'("PROB",I2.2,".vasp")')IIREF
OPEN(101,FILE='PROBTOTAL.vasp')
!OPEN(101,FILE="PROB.vasp")

DO 
READ(111,112,END=99)ABC2
WRITE(101,*)ADJUSTL(trim(ABC2))
END DO
112 FORMAT(A100)
99 CONTINUE
CLOSE(111)
!WRITE(101,*)'COMMENT PROBABILITY DENSITY'
!WRITE(101,*)'1.0'
!WRITE(101,102)SLAT(1,:)/NSS(1)
!WRITE(101,102)SLAT(2,:)/NSS(2)
!WRITE(101,102)SLAT(3,:)/NSS(3)
!WRITE(101,103)'C' !SLAT(1,:)
!WRITE(101,*)'1' !NNTYPE !ATMNM !SLAT(1,:)
!WRITE(101,*)'D' !SLAT(1,:)
!WRITE(101,*)'0 0 0' !MATMUL(ISLAT,POS(1,I,:)) !ATMNM !SLAT(1,:)
CALL DETER(NSSD,NTIMES)
WRITE(101,*) !SLAT(1,:)
WRITE(101,*)NX,NY,NZ
102 FORMAT(3F20.15)
103 FORMAT(10A3)
        DO IT=1,IREF2-IREF1+1  !NSTEPORIG
        IKK=0
        DO IK=1,NATOM
        IKK=IK  !-SUM(NNTYPE(1:IIREF-1))
        DPOS(IKK,:)=MATMUL(POS(IT,IK,:),ISLAT)
        DPOS(IKK,:)=MATMUL(DPOS(IKK,:),NSSD)
  
!      DPOS(IKK,:)=DPOS(IKK,:)*NSS
        DPOS(IKK,:)=DPOS(IKK,:)-NINT(DPOS(IKK,:))
        WHERE(DPOS(IKK,:).LT.0)DPOS(IKK,:)=DPOS(IKK,:)+1
        WHERE(DPOS(IKK,:).GT.1)DPOS(IKK,:)=DPOS(IKK,:)-1
!        111 FORMAT(3F10.5)
        NNBIN(IKK,1)=DPOS(IKK,1)*NX
        NNBIN(IKK,2)=DPOS(IKK,2)*NY
        NNBIN(IKK,3)=DPOS(IKK,3)*NZ
        XI=NNBIN(IKK,1)
        YI=NNBIN(IKK,2)
        ZI=NNBIN(IKK,3)
        IF(ANY(NNBIN(IKK,:)<0).EQ..FALSE..AND.ANY(NNBIN(IKK,:)>NMAX).EQ..FALSE.)THEN
                CHG(NNBIN(IKK ,1), NNBIN(IKK,2), NNBIN(IKK,3))= CHG(NNBIN(IKK,1), NNBIN(IKK,2), NNBIN(IKK,3))+1
                IF(ISMEAR==1)THEN
                IF(XI+1.LE.NMAX)CHG(XI+1, YI,ZI)= CHG(XI+1,YI,ZI)+exp(-1.0/sig)
                IF(XI+2.LE.NMAX)CHG(XI+2, YI,ZI)= CHG(XI+2,YI,ZI)+exp(-4.0/sig)
                IF(XI+3.LE.NMAX)CHG(XI+3, YI,ZI)= CHG(XI+3,YI,ZI)+exp(-9.0/sig)
                IF(XI-1.GE.0)CHG(XI-1, YI,ZI)= CHG(XI-1,YI,ZI)+exp(-1.0/sig)
                IF(XI-2.GE.0)CHG(XI-2, YI,ZI)= CHG(XI-2,YI,ZI)+exp(-4.0/sig)
                IF(XI-3.GE.0)CHG(XI-3, YI,ZI)= CHG(XI-3,YI,ZI)+exp(-9.0/sig)
                IF(YI+1.LE.NMAX)        CHG(XI, YI+1,ZI)= CHG(XI,YI+1,ZI)+exp(-1.0/sig)
                IF(YI+2.LE.NMAX)        CHG(XI, YI+2,ZI)= CHG(XI,YI+2,ZI)+exp(-4.0/sig)
                IF(YI+3.LE.NMAX)        CHG(XI, YI+3,ZI)= CHG(XI,YI+3,ZI)+exp(-9.0/sig)
                IF(YI-1.GE.0)CHG(XI, YI-1,ZI)= CHG(XI,YI-1,ZI)+exp(-1.0/sig)
                IF(YI-2.GE.0)CHG(XI, YI-2,ZI)= CHG(XI,YI-2,ZI)+exp(-4.0/sig)
                IF(YI-3.GE.0)CHG(XI, YI-3,ZI)= CHG(XI,YI-3,ZI)+exp(-9.0/sig)
                IF(ZI+1.LE.NMAX)CHG(XI, YI,ZI+1)= CHG(XI,YI,ZI+1)+exp(-1.0/sig)
                IF(ZI+2.LE.NMAX)CHG(XI, YI,ZI+2)= CHG(XI,YI,ZI+2)+exp(-4.0/sig)
                IF(ZI+3.LE.NMAX)CHG(XI, YI,ZI+3)= CHG(XI,YI,ZI+3)+exp(-9.0/sig)
                IF(ZI-1.GE.0)CHG(XI, YI,ZI-1)= CHG(XI,YI,ZI-1)+exp(-1.0/sig)
                IF(ZI-2.GE.0)CHG(XI, YI,ZI-2)= CHG(XI,YI,ZI-2)+exp(-4.0/sig)
                IF(ZI-3.GE.0)CHG(XI, YI,ZI-3)= CHG(XI,YI,ZI-3)+exp(-9.0/sig)
                END IF
        !               CHG(NNBIN(IKK ,1), NNBIN(IKK,2), NNBIN(IKK,3))= CHG(NNBIN(IKK,1), NNBIN(IKK,2), NNBIN(IKK,3))+1
        END IF
        !        CHG(NNBIN(IKK,1), NNBIN(IKK,2), NNBIN(IKK,3))=CHG(NNBIN(IKK,1), NNBIN(IKK,2), NNBIN(IKK,3))+1
        END DO
        END DO


        !CHG=NATOM*CHG/(SUM(CHG)*NSS(1)*NSS(2)*NSS(3))
        CHG=NATOM*CHG/(SUM(CHG)*NTIMES) !NSS(1)*NSS(2)*NSS(3))
        print*,sum(CHG)
        !PVOLUME=1.88973*1.88973*1.88973*VOLUME/(NSS(1)*NSS(2)*NSS(3))
        PVOLUME=1.88973*1.88973*1.88973*VOLUME/(NTIMES)
        DV=PVOLUME/((NX+1)*(NY+1)*NZ+1)
        CHG=CHG/dv  !*1000/(NNTYPE(IIREF)*(IREF2-IREF1+1))
        print*,sum(chg)*dv
        CHG=PVOLUME*CHG !/(NSS(1)*NSS(2)*NSS(3))
        print*, sum(chg)*DV/PVOLUME
!CHG=CHG*NATOM*VOLUME*1.88973*1.88973*1.88973/(NSS(1)*NSS(1)*NSS(2)*NSS(2)*NSS(3)*NSS(3)) !Volume in Bohr Unit
WRITE(101,101)(((CHG(I,J,K),I=0,NX-1),J=0,NY-1),K=0,NZ-1)
101 FORMAT(5E12.5)
PRINT*,'PROBABILITY DISTRIBUTION OF SYSTEM   IS CALCULATED OVER',IREF2-IREF1+1,'STEPS'
!!!!!!!!!!!!!!!!!FOLDING  THE STRUCTURE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
END SUBROUTINE

SUBROUTINE GPUMD2021            !!!!!!!!!!!!!!!!!!!!VASP XDATCAR READING 
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(3)::AA
CHARACTER*50::ABC2
INTEGER::L1,L2
INTEGER::IDR,ITH
DOUBLE PRECISION::A1,A2,B1,B2,C1,C2,A12,B12,C12
CHARACTER*50::FLNMPOSCAR
INTEGER::ID1,ID2
INTEGER::IND1,IND2,IND3
DOUBLE PRECISION::X1,X2,Y1,Y2,Z1,Z2,XY,XZ,YZ,XLO,XHI,YLO,YHI,ZLO,ZHI,zero
!!!!!!!!!!!!!!POLYTHINGS
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DDD
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::ANGLETHETA,ANGLEPHI,DDDD,REFTHETA,REFPHI
INTEGER,ALLOCATABLE,DIMENSION(:,:)::BDIST
INTEGER,ALLOCATABLE,DIMENSION(:)::INDEXI
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DISTORTION
REAL,ALLOCATABLE,DIMENSION(:,:,:)::PROBDENSITY
!!!!!!the last index 4 due to tetrahedral cordination
DOUBLE PRECISION::RXY
DOUBLE PRECISION::RTOPI
INTEGER::JJJJ,JK,IR,JKK
DOUBLE PRECISION::D2,DR1,DR2
DOUBLE PRECISION::PROJ1,PROJ2,TWOPI
DOUBLE PRECISION,DIMENSION(3,3)::IAXIS
DOUBLE PRECISION::X,Y,Z,R
DOUBLE PRECISION,DIMENSION(3,3)::NEWLAT
INTEGER::MATOM,JCu,ICAP
INTEGER::MAXCAP,JTAG !,NCORD
DOUBLE PRECISION::AVGBOND
REAL::RSEARCH
REAL,DIMENSION(3)::XYZ
!REAL,DIMENSION(1,0:180,0:360)::PROBDENSITY
INTEGER::J1
INTEGER,DIMENSION(NATOM,12,3)::PICK
REAL::RIJ,RJK
INTEGER::NC1,NK,IM
!DOUBLE PRECISION,DIMENSION(3)::AA

double precision,dimension(3,3)::test_array
character*25,dimension(7)::discr
character*2::ATM
integer::ic,io
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!VASP READING
zero=0.0
POS=0
test_array=0
ISKIP=0

!!!!!!!!!!!!!!!!!!!!!!!!!!POLY THINGS
IF (IPOLY==1.AND.ISOFT==3)THEN
ALLOCATE(DDD(3),ANGLETHETA(NNTYPE(CATOM),NCORD),ANGLEPHI(NNTYPE(CATOM),NCORD),DDDD(NNTYPE(CATOM),NCORD))
ALLOCATE(REFTHETA(NNTYPE(CATOM),NCORD),REFPHI(NNTYPE(CATOM),NCORD),BDIST(500,NCORD),INDEXI(100),DISTORTION(NNTYPE(CATOM)),PROBDENSITY(NNTYPE(CATOM),0:90,0:180))
OPEN(4100,FILE="ANGLETHETA.DAT")
OPEN(4101,FILE="ANGLEPHI.DAT")
OPEN(4102,FILE="BONDLENGTHS.DAT")
OPEN(4103,FILE="BONDLENGTHDISTRIBUTION.DAT")
OPEN(4105,FILE="MOVINGIONINDEX.DAT")
OPEN(4106,FILE="DISTORTION.DAT")
OPEN(5000,FILE="PROBDENSITY_THETA_PHI")
PRINT*,'I M IN POLY'
PRINT*,CATOM,SATOM,NK
PROBDENSITY=0
RSEARCH=8.0
MATOM=1
PRINT*,'MOBILE ATOM IS 1 and RSEARCH iS ', RSEARCH
MAXCAP=32
RTOPI=180/(4*ATAN(1.0))  !3.14
PI=4*ATAN(1.0)
TWOPI=8*ATAN(1.0)
    AX3(1)=AX1(2)*AX2(3)-AX1(3)*AX2(2)
    AX3(2)=AX1(3)*AX2(1)-AX1(1)*AX2(3)
    AX3(3)=AX1(1)*AX2(2)-AX1(2)*AX2(1)
IAXIS(1,:)=AX1/NORM2(AX1)
IAXIS(2,:)=AX2/NORM2(AX2)
IAXIS(3,:)=AX3/NORM2(AX3)
END IF
!!!!!!!!!!!!!!!!!!!!!!!!!





PRINT*,'I M GPUMD.........NVT ONLY'
!        PRINT*,'GRCUT'
!        READ*,GRCUT
IF(IWRITE==1)OPEN(3,FILE="XDATCARNEW.DAT")
IF(IDIFFUSE==0)OPEN(31,FILE="velocity.out")
TIME=0
3 FORMAT(3F18.10)
2 FORMAT(A40)
PRINT*,IREF1,NATOM,ATMNM,NNTYPE
PRINT*,FLNM,IREF1
PRINT*,NTYP
test_array=0
!READ(2,*)
!READ(2,*)
8686 FORMAT(3(E23.16,1x))
DO IT=1,IREF1-1
        TIME=TIME+1
        READ(2,*)
        READ(2,1222)SLAT(1,1),SLAT(1,2),SLAT(1,3),SLAT(2,1),SLAT(2,2),SLAT(2,3),SLAT(3,1),SLAT(3,2),SLAT(3,3)
        DO I=1,NATOM
        READ(2,*)
        IF(IVEL==1.AND.IDIFFUSE==0)READ(31,*)
        END DO
        SLATORIG=SLAT
        ISLATORIG=SLAT
        CALL GAUSS(ISLATORIG,3)
END DO

ISLAT=SLAT
CALL GAUSS(ISLAT,3)
IF(IT==1)ISLATORIG=ISLAT
!PRINT*,ISLAT
!!!!!!!!!!!!
IND1=1
IND2=1  !FOR DIFFUSE SCATTERING STUF
IND3=0
!!!!!!!!!!!!!!

!!!
LL=0
DO IT=1,IREF2-IREF1+1
!PRINT*,IT

        TIME=TIME+1
        READ(2,*)
        READ(2,1222)SLAT(1,1),SLAT(1,2),SLAT(1,3),SLAT(2,1),SLAT(2,2),SLAT(2,3),SLAT(3,1),SLAT(3,2),SLAT(3,3)
        1222 FORMAT(9x,9e15.7)
        !PRINT*,SLAT(1,1)
        IF(IT==1)PRINT*,'LAMMPS 1st step Lattice Vectors'
        IF(IT==1)PRINT*, SLAT(1,:)
        IF(IT==1)PRINT*, SLAT(2,:)
        IF(IT==1)PRINT*, SLAT(3,:)
        ISLAT=SLAT
        CALL GAUSS(ISLAT,3)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!TRICK FOR IND1 IND2 IND3!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        IND3=IND3+1
 	 IF(IND3.GT.NCUB)THEN
		IND3=IND3-NCUB
		IND2=IND2+1
		IF(IND2.GT.NCUB)THEN
		 IND2=IND2-NCUB
		 IND1=IND1+1
                 
		END IF
	 END IF
        LL=LL+1
        IF(IWRITE==1)WRITE(3,2)'D' !ABC2

        IF(NMOL.EQ.1)THEN
        DO I=1,NATOM
                READ(2,*)ATM,POS(LL,I,:)
                READ(31,*)VEL(LL,I,:)
         !       PRINT*,VEL(LL,I,:)
        !PAUSE
                !IF(ID==0)READ(2,*)POS(LL,I,:)
                !IF(ID==0.AND.IVEL==1.AND.IDIFFUSE==0)READ(31,*)VEL(LL,I,:)
                !IF(ID==1)READ(2,*)ID1,ID2,POS(LL,I,:)
                !IF(ID==1.AND.IVEL==1.AND.IDIFFUSE==0)READ(31,*)ID1,ID2,VEL(LL,I,:)
                !IF(ID==1.AND.IVEL==2.AND.IDIFFUSE==0)READ(31,*)VEL(LL,I,:)
                345 FORMAT(I5,3F10.5)
                !POS(LL,I,:)=MATMUL(ISLAT,POS(LL,I,:))
                POS(LL,I,:)=MATMUL(POS(LL,I,:),ISLAT)
                !RR1(I,:)=MATMUL(ISLAT,POS(LL,I,:))
                IF(IDIFFUSE==0)THEN
                RR1(I,:)=POS(LL,I,:)          !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!SAVED AS R1 FOR GRR CALCULATION 
                WHERE(RR1(I,:).LT.0.0)RR1(I,:)=RR1(I,:)+1
                WHERE(RR1(I,:).GE.1.0)RR1(I,:)=RR1(I,:)-1
                END IF
!               IF(IDIFFUSE==1)WHERE(RR1(I,:).LT.0.0)RR1(I,:)=RR1(I,:)+1
!               IF(IDIFFUSE==1)WHERE(RR1(I,:).GE.1.0)RR1(I,:)=RR1(I,:)-1
		!IF(IND1.LE.NCUB.AND.IDIFFUSE==1)TPOS(IND1,IND2,IND3,I,:)=RR1(I,:) + (/IND1-1, IND2-1,IND3-1 /)
                IF(LL.GE.2.AND.ISKIP.NE.1)THEN
                !POS(LL-1,I,:)=MATMUL(ISLAT,POS(LL-1,I,:))
                POS(LL-1,I,:)=MATMUL(POS(LL-1,I,:),ISLAT)
                AA=POS(LL,I,:)-POS(LL-1,I,:)
                WHERE(AA.LT.-0.5)POS(LL,I,:)=POS(LL,I,:)+1                
                WHERE(AA.GT.+0.5)POS(LL,I,:)=POS(LL,I,:)-1                
                !POS(LL-1,I,:)=MATMUL(SLAT,POS(LL-1,I,:))
                POS(LL-1,I,:)=MATMUL(POS(LL-1,I,:),SLAT)
                !POS(LL-1,I,:)=MATMUL(SLAT,POS(LL-1,I,:))
                ENDIF
                IF(IWRITE==1)WRITE(3,3)POS(LL,I,:)
                !POS(LL,I,:)=MATMUL(SLAT,POS(LL,I,:))
                POS(LL,I,:)=MATMUL(POS(LL,I,:),SLAT)
                !POS(LL,I,:)=MATMUL(POS(LL,I,:),SLAT)
                IF(IDIFFUSE==0.AND.IVEL.EQ.0.AND.LL.GE.2.0)THEN
                VEL(LL,I,:)=(POS(LL,I,:)-POS(LL-1,I,:))/DELT
                92 FORMAT(3F9.3,2x,3f9.3)
                END IF

        END DO
      END IF

 IF(NMOL.GT.1) THEN
        DO IM=1,NMOL
           DO ITYP=1,NTYP
             N1= SUM(NNTYPE(1:ITYP-1))  +1 +(IM-1)*(NNTYPE(ITYP)/NMOL)
             N2= N1+ NNTYPE(ITYP)/NMOL -1   !  + (IM-1)*(NATOM/NMOL)
               DO I=N1,N2
                READ(2,*)POS(LL,I,:)
                READ(31,*)VEL(LL,I,:)
                !IF(ID==0)READ(2,*)POS(LL,I,:)
                !IF(ID==0.AND.IVEL==1.AND.IDIFFUSE==0)READ(31,*)VEL(LL,I,:)
                !IF(ID==1)READ(2,*)ID1,ID2,POS(LL,I,:)
                !IF(ID==1.AND.IVEL==1.AND.IDIFFUSE==0)READ(31,*)ID1,ID2,VEL(LL,I,:)
                !IF(ID==1.AND.IVEL==2.AND.IDIFFUSE==0)READ(31,*)VEL(LL,I,:)
           !     PRINT 987,LL, IM,N1,N2,N2-N1
                987  FORMAT(I4,10I5)
!                345 FORMAT(I5,3F10.5)
                !POS(LL,I,:)=MATMUL(ISLAT,POS(LL,I,:))
                POS(LL,I,:)=MATMUL(POS(LL,I,:),ISLAT)
                RR1(I,:)=POS(LL,I,:)   !#MATMUL(ISLAT,POS(LL,I,:))
                !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!SAVED AS R1 FOR GRR CALCULATION
                WHERE(RR1(I,:).LT.0.0)RR1(I,:)=RR1(I,:)+1
                WHERE(RR1(I,:).GE.1.0)RR1(I,:)=RR1(I,:)-1
                !IF(IND1.LE.NCUB.AND.IDIFFUSE==1)TPOS(IND1,IND2,IND3,I,:)=RR1(I,:) + (/IND1-1, IND2-1,IND3-1 /)
                IF(LL.GE.2.AND.ISKIP.NE.1)THEN
                !POS(LL-1,I,:)=MATMUL(ISLAT,POS(LL-1,I,:))
                POS(LL-1,I,:)=MATMUL(POS(LL-1,I,:),ISLAT)
               ! IF(I==1)PRINT*,POS(LL-1,I,:)
               ! IF(I==1) PAUSE
                AA=POS(LL,I,:)-POS(LL-1,I,:)
                WHERE(AA.LT.-0.5)POS(LL,I,:)=POS(LL,I,:)+1
                WHERE(AA.GT.+0.5)POS(LL,I,:)=POS(LL,I,:)-1
                !POS(LL-1,I,:)=MATMUL(SLAT,POS(LL-1,I,:))
                POS(LL-1,I,:)=MATMUL(POS(LL-1,I,:),SLAT)
                ENDIF

                IF(IWRITE==1)WRITE(3,3)POS(LL,I,:)
                !POS(LL,I,:)=MATMUL(SLAT,POS(LL,I,:))
                POS(LL,I,:)=MATMUL(POS(LL,I,:),SLAT)
                IF(IVEL.EQ.0.AND.LL.GE.2.0)THEN
                IF(IDIFFUSE==0)VEL(LL,I,:)=(POS(LL,I,:)-POS(LL-1,I,:))/DELT
                !92 FORMAT(3F9.3,2x,3f9.3)
                END IF

           END DO
          END DO
        END DO
END IF


!###################################################
!       ##############################################
!       ##########################################
!       ##############        
        IINTERVAL=MOD(LL,INTERVAL)
        IF(IINTERVAL.EQ.0.AND.IT.LE.(IREF2-IREF1))THEN
        IPOINTS=IPOINTS+1
        IF(IGRR==1)CALL GRRFN4LAMMPS
!IF(IDIFFUSE==2) CALL NEWDIFFUSE2021 !#########################
!IF(IDIFFUSE==1) CALL DIFFUSE2022 !#########################

!        IF(ASTATUS.AND.IRECORD.LT.10)THEN
!        WRITE(FLNMPOSCAR,'("POSCAR",I4.4)')LL
!        PRINT*,FLNMPOSCAR
!        CALL PRINTPOSCAR(LL,FLNMPOSCAR)
!        IRECORD=IRECORD+1
!        END IF
!        PRINT*,'GOING TO ANGLE'
        IF(IANGLE==1)CALL ANGLECAL
        IF(IDIFF==1)CALL DIFFRACTION
        END IF
        103 FORMAT(I7,1000E10.3)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!POLY THINGS!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
IF (IT==1.AND.IPOLY==1)THEN
DO I=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
        NC1=0
        NK=0
        DO J=SUM(NNTYPE(1:SATOM-1))+1,SUM(NNTYPE(1:SATOM))   !,NNTYPE(CATOM)
                AA=RR1(I,:)-RR1(J,:)
                WHERE(AA.LT.-0.5)AA=AA+1
                WHERE(AA.GT.0.5)AA=AA-1
                RIJ=NORM2(MATMUL(AA,SLAT))
                !RIJ=NORM2(MATMUL(SLAT,AA))
                IF(RIJ.GT.0.AND.RIJ.LE.BOND)THEN
                 NC1=NC1+1       !!!!!!!!CORDINATION1
                 IF(NC1.GT.NCORD)EXIT
                        NK=NK+1
                        PICK(I,NK,1)=I
                        PICK(I,NK,2)=J
                END IF
        END DO
END DO
END IF


!!!!!!!!!!!!!!!!
IF(MOD(IT,INTERVAL2)==0.AND.IPOLY==1)THEN
    !PRINT*,iT
  NEWLAT=MATMUL(IAXIS,SLAT)
  JJJJ=0
  JTAG=0
  DO J=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
   JTAG=JTAG+1         !!!!!!!!!EQUIVALENT TO RUN OVER J
   JJJJ=JJJJ+1
   JK=0
   DO JK=1,NK  !SUM(NNTYPE(1:SATOM-1))+1,SUM(NNTYPE(1:SATOM))   !,NNTYPE(CATOM)
    !PRINT*,J,Jk !iT
    DDD=(RR1(J,:)-RR1(PICK(J,JK,2),:))
!    DDD=(POS(IT,J,:)-POS(IT,PICK(J,JK,2),:))
!    DDD=MATMUL(DDD,ISLAT)                           !!!!!!!!FRACTIONAL POSITION 
    WHERE(DDD.LT.-0.5)DDD=DDD+1.0
    WHERE(DDD.GT.0.5)DDD=DDD-1.0
    XYZ=MATMUL(DDD,NEWLAT)
    !XYZ=MATMUL(NEWLAT,DDD)
    X=XYZ(1)
    Y=XYZ(2)
    Z=XYZ(3)
    D2=NORM2(XYZ)
    !PRINT*,D2 !XYZ
    !PAUSE
      DDDD(JTAG,JK)=D2  !NORM2(DDD)
      RXY=SQRT(Y*Y + Z*Z)
      ANGLETHETA(JJJJ,JK)=ACOS(X/D2)
      IF(RXY==0)THEN
      ANGLEPHI(JJJJ,JK)=0
      ELSE
      ANGLEPHI(JJJJ,JK)=ACOS(Y/rxy)
      IF(Y.GT.0.AND.Z.LT.0)ANGLEPHI(JJJJ,JK)=ANGLEPHI(JJJJ,JK)+ 3*TWOPI/4.0
      IF(Y.LT.0.AND.Z.LT.0)ANGLEPHI(JJJJ,JK)=ANGLEPHI(JJJJ,JK)+ TWOPI/4.0
      END IF
      !!!!!!!!!       PROBABILITY DENSITY FUNCTION!!!!!!!!!!!!!!!!
       IF(ANGLETHETA(JJJJ,JK).GT.0.AND.ANGLEPHI(JJJJ,JK).GT.0)THEN
       PROBDENSITY(JTAG,INT(ANGLETHETA(JJJJ,JK)*RTOPI/2.0),INT(ANGLEPHI(JJJJ,JK)*RTOPI/2.0))=PROBDENSITY(JTAG,INT(ANGLETHETA(JJJJ,JK)*RTOPI/2.0),INT(ANGLEPHI(JJJJ,JK)*RTOPI/2.0))+1
       END IF
   END DO!SURROUNDING SERACH ENDS
    AVGBOND=SUM(DDDD(JJJJ,:))/NCORD !JK   
    DISTORTION(JTAG)=SQRT(DOT_PRODUCT(DDDD(JTAG,:),DDDD(JTAG,:)) -NCORD*AVGBOND*AVGBOND)
    DISTORTION(JTAG)=DISTORTION(JTAG)/(NCORD*AVGBOND*AVGBOND)
!!!!!!!!!!BOND DISTRIBUTION!!!!!!!!!!!!!   
   DO IR=1,500
   DR1=DR0+(IR-1)*RSTEP
   DR2=DR0+IR*RSTEP
   DO JKK=1,NCORD  !JK
   IF(DDDD(JJJJ,JKK).GT.DR1 .AND.DDDD(JJJJ,JKK).LE.DR2)BDIST(IR,JKK)=BDIST(IR,JKK)+1
   END DO
   END DO  !!END BOND DISTRI
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  END DO !CENTRE ATOM ENDS HERE
  WRITE(4106,2103)DELT*REAL(IT),DISTORTION(:)
  WRITE(4100,2100)DELT*REAL(IT),(ANGLETHETA(JJJJ,1:NCORD)*RTOPI,JJJJ=1,NNTYPE(CATOM))
  2100 FORMAT(F10.4,1000F7.1)
  WRITE(4101,2100)DELT*REAL(IT),(ANGLEPHI(JJJJ,1:NCORD)*RTOPI,JJJJ=1,NNTYPE(CATOM))
  WRITE(4102,2102)DELT*REAL(IT),(DDDD(JJJJ,1:NCORD),JJJJ=1,NNTYPE(CATOM))
END IF ! DO     !!!!!!!!!!!!!!!!TIME ENDS HERE
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
END DO   !!!!!!!!!!!!!!!TIME ENDS 



!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
IF(IGRR==1)THEN

WRITE(83,*)'#r0  pairs, GRTTOTAL, X-ray-weighted, neutron-weighted'
DO IDR=1,NR
!WRITE(83,83)R0+(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(IPOINTS),J=I,NTYP),I=1,NTYP),GAVG(IDR)/REAL(IPOINTS)
!WRITE(83,83)(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(IPOINTS),J=I,NTYP),I=1,NTYP),GAVG(IDR)/REAL(IPOINTS) , SUM(GRRTAVG(IDR,:,:))/REAL(IPOINTS), SUM(GRRTAVGXRAY(IDR,:,:))/REAL(IPOINTS)
WRITE(83,83)(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(IPOINTS),J=I,NTYP),I=1,NTYP), SUM(GRRTAVG(IDR,:,:))/REAL(IPOINTS), SUM(GRRTAVGXRAY(IDR,:,:))/REAL(IPOINTS), SUM(GRRTAVGNEUTRON(IDR,:,:))/REAL(IPOINTS)
!WRITE(831,83)(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(IPOINTS),J=I,NTYP),I=1,NTYP),GAVG(IDR)/REAL(IPOINTS)
END DO
83 FORMAT(F6.3,2x,100(E11.4,2x))
END IF



IF(IANGLE==1)THEN
OPEN(13,FILE="ANGLEVAR.DAT")
        DO ITH=-180,180
        !WRITE(13,13)THE0+ITH*DELTH, (THETA(ITH,INDEX1(I,1),INDEX1(I,2),INDEX1(I,3))/REAL(IPOINTS),I=1,MAXINDEX)
        WRITE(13,13)REAL(ITH), (THETA(ITH,INDEX1(I,1),INDEX1(I,2),INDEX1(I,3))/REAL(IPOINTS),I=1,MAXINDEX)
        13 FORMAT(20(F15.5,2X))
        END DO
CLOSE(13)

OPEN(14,FILE="AVGANGLE.DAT")
        DO I=1,NTYP
        DO J=1,NTYP
        DO K=1,NTYP
        WRITE(14,14)J,I,K,AVGANG(J,I,K)/REAL(IPOINTS)
        14 FORMAT(3I5,F10.5)
        END DO
        END DO
        END DO
CLOSE(14)
END IF
PRINT*,'USEFUL STEPS ARE',LL !IREF2-IREF1+1
PRINT*, "LAMMPS READING IS DONE, and no. of steps are:",NSTEP
CLOSE(2)
CLOSE(3)
AVGISLAT=ISLAT   !!!!!!!!!!!!!!!!!!NEED TO CHANGE FOR NPT SCHEME!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
199 FORMAT(3F15.9)







!#$$$$$$$$$$$$$$$$$$$$$




POSSTART(:,:)=POS(1,:,:)

!!!!!!!!!!!!!!POLY THINGS
IF(IPOLY==1)THEN
!!!!!!!!!!!!!!!!POLY
DO IR=1,500
DR1=DR0+(IR-1)*RSTEP
WRITE(4103,2101)DR1,BDIST(IR,1:NCORD)
END DO
2101 FORMAT(F9.4,10I12)
2102 FORMAT(F9.4,1000F10.3)
2103 FORMAT(F9.4,1000F10.4)
DO J=0,180
DO I=0,90
WRITE(5000,2104) 2*REAL(J),2*REAL(I),((PROBDENSITY(J1,I,J)/SUM(PROBDENSITY(J1,:,:))), J1=1,NNTYPE(CATOM) )  !X axisisphi and Y axis is theta
2104 FORMAT(1003E16.5)
END DO
END DO
END IF

!!!!!!!!!!!!!!!!!!!!!!!!AVERAGE STRUCTURE!!!!!!!!!!!!!!!!!!

!NX=10
!NY=10
!NZ=10

WRITE(199,*)'AVERAGE STRUCTURE'
WRITE(199,*)'1.0'
WRITE(199,199)SLAT(1,:)
WRITE(199,199)SLAT(2,:)
WRITE(199,199)SLAT(3,:)
WRITE(199,*)ATMNM
WRITE(199,*)NNTYPE !/(NX*NY*NZ)
WRITE(199,*)'D'



DO I=1,NATOM
WRITE(199,199)MATMUL(SUM(POS(IREF1:IREF2,I,:),DIM=1)/(IREF2-IREF1+1),ISLAT)
END DO
!199 FORMAT(3F20.10)
!
!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!
END SUBROUTINE







SUBROUTINE IIFQT44(IQQQQ,QHKL)   !!!!!!!!!!THIS IS with velcoity projection
use omp_lib
USE VARIABLES1, only :ICARTESIAN,PI,AVGISLAT,POSSTART,MASS,VEL,NSTEPORIG,ICOH,IBROAD,FWHM0,FWHM1,NTYP,NSTEP,NATOM,DELT,ICUT,NNTYPE
IMPLICIT NONE
INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::AFQT,AAFQT
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::tempd,cout !,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::CFFQTTYP !,SQWB
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1,QHKL
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
REAL,DIMENSION(NSTEP)::PHASE1
DOUBLE PRECISION,DIMENSION(NATOM)::PHASE11
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::II1,I1,DT1,III
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DUMMY2,DUMMY4
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMYT
DOUBLE PRECISION::EE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK !,tempd
INTEGER::ITYPPP,JTYPPP
INTEGER::IQQQQ,NNN2
CHARACTER::AA*10
INTEGER::NTYP2,NTYP3
INTEGER::IJ1,IJ2
INTEGER::IQTCAL
integer,allocatable,dimension(:)::plan
integer,dimension(natom)::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMY1,DUMMY5,DUMMY2,DUMMY6
INTEGER::DT,IT
REAL::OMEGA
INTEGER::I,J
integer,dimension(9)::desca,descb,descc
integer::ia,ja,ib,jb,ic,jc,m,n,k
integer,dimension(1,NATOM)::lda,ldb,ldc
real::alpha,beta
integer,allocatable,dimension(:,:)::ind
integer::n1,n2,n3,n4,ntotal
m=natom
n=natom
k=3
alpha=1
beta=0
PRINT*,'I M IN SED44'

IF(ICUT==1)WRITE(AA,'("SEDTOT",I4.4)')IQQQQ
IF(ICUT==1)OPEN(IQQQQ,FILE=AA)
OPEN(9999,FILE='SEDTOTAL',ACCESS='APPEND')
!WRITE(AA,'("VISQWTOT",I2.2)')IQQQQ
!OPEN(IQQQQ+1,FILE=AA)
!PRINT*,'I AM IN IFFQT'
!PRINT*,'RUNNING IQ',IQQQQ
PRINT*, QHKL
NTYP2=NTYP*(NTYP+1)/2
ALLOCATE(AFQT(1:NSTEP,NATOM,3))
ALLOCATE(AAFQT(1:NSTEP,NATOM,3))
ALLOCATE(CFFQTTYP(1:NSTEP,NTYP2))
ALLOCATE(DUMMY1(NSTEP),DUMMY5(NSTEP))
ALLOCATE(DUMMY2(NSTEP),DUMMY6(NSTEP))
allocate(plan(NATOM))
allocate(ind(ntyp2,3))

ind=0
AFQT=0
CFFQTTYP=0
IFOR= 1
IBAC=-1
NQ=1
ALLOCATE(QQ(NQ,3),QK(NQ,3))
ALLOCATE(COUT(NATOM,NATOM))
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!DO IQ=1,NQ            !NQ IS 1 Since we enter the manual hkl values
        IQ=1
        CFFQTTYP=0
        QQ(IQ,:)=QHKL    !KLIST(IQ,:) !VEC
        IF(ICARTESIAN==1)THEN
        KVEC=QHKL        !KLIST(IQ,:)
        ELSE
        !KVEC=2.0*PI*MATMUL(QHKL,AVGISLAT)        !CHANGED AVGISLAT TO ISLAT
        KVEC=2.0*PI*MATMUL(AVGISLAT,QHKL )        !CHANGED AVGISLAT TO ISLAT
        END IF
        QK(IQ,:)=KVEC
!        !$omp parallel do
        DO I=1,NATOM
        PHASE11(I)=DOT_PRODUCT(KVEC,POSSTART(I,:))
        AFQT(:,I,:)=SQRT(MASS(I))*VEL(:,I,:)*CMPLX(COS(PHASE11(I)),SIN(PHASE11(I)))
        call dfftw_plan_dft_1d(plann(i),NSTEP,AFQT(:,I,1),AFQT(:,I,1),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann(i), AFQT(:,I,1),AFQT(:,I,1))
        call dfftw_destroy_plan(plann(i))
        call dfftw_plan_dft_1d(plann(i),NSTEP,AFQT(:,I,2),AFQT(:,I,2),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann(i), AFQT(:,I,2),AFQT(:,I,2))
        call dfftw_destroy_plan(plann(i))
        call dfftw_plan_dft_1d(plann(i),NSTEP,AFQT(:,I,3),AFQT(:,I,3),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann(i), AFQT(:,I,3),AFQT(:,I,3))
        call dfftw_destroy_plan(plann(i))
        AFQT(:,I,:)=AFQT(:,I,:)/REAL(NSTEPORIG)
        END DO
!        !$omp end parallel do
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!INCOHERENT CALCULATION 
        K=0
        IND=0
        DO I=1,NTYP
        DO J=I,NTYP
        K=K+1
        IND(K,1)=I !NNTYPE(I)
        IND(K,2)=J !NNTYPE(J)
        IF (I==J)IND(K,3)=1
        END DO
        END DO
        CFFQTTYP=0
        DO I=1,NTYP2
        N1=SUM(NNTYPE(1:IND(I,1)-1))+1
        N2=SUM(NNTYPE(1:IND(I,1)))
        N3=SUM(NNTYPE(1:IND(I,2)-1))+1
        N4=SUM(NNTYPE(1:IND(I,2)))
        NTOTAL=N2-N1+1 + N4-N3+1
!        PRINT*,NTOTAL,N2-N1+2
        AAFQT(:,1:N2-N1+1,:) =AFQT(:,N1:N2,:)
        PRINT*,I !,N3,N4
        PRINT*,N2-N1+1 ,N1,N2
        IF (N1.NE.N3 .AND. N2.NE.N4) THEN
        PRINT*,N2-N1+2,NTOTAL,N3,N4
        AAFQT(:,N2-N1+2:NTOTAL,:) =AFQT(:,N3:N4,:)
        END IF



        !$omp parallel do
        DO IT=1,NSTEP

        !CFFQTTYP(IT,I)=REAL(SUM(AAFQT(IT,:,1)))**2   + AIMAG(SUM(AAFQT(IT,:,1)))**2 + REAL(SUM(AAFQT(IT,:,2)))**2   + AIMAG(SUM(AAFQT(IT,:,2)))**2 + REAL(SUM(AAFQT(IT,:,3)))**2   + AIMAG(SUM(AAFQT(IT,:,3)))**2 
        !CFFQTTYP(IT,I)=SUM(AAFQT(IT,:,1)) *CONJG(SUM(AAFQT(IT,:,1)))   + SUM(AAFQT(IT,:,2)) *CONJG(SUM(AAFQT(IT,:,2))) +        SUM(AAFQT(IT,:,3)) *CONJG(SUM(AAFQT(IT,:,3)))
        CFFQTTYP(IT,I)=SUM (AAFQT(IT,:,1)*CONJG(AAFQT(IT,:,1)))   + SUM(AAFQT(IT,:,2) *CONJG(AAFQT(IT,:,2))) +        SUM(AAFQT(IT,:,3) *CONJG(AAFQT(IT,:,3)))
        !CFFQTTYP(IT,I)=SUM (AAFQT(IT,:,1)) *CONJG(SUM(AAFQT(IT,:,1)))  +  SUM(AAFQT(IT,:,2)) *CONJG(SUM(AAFQT(IT,:,2))) +        SUM(AAFQT(IT,:,3)) *CONJG(SUM(AAFQT(IT,:,3)))
        !        + AIMAG(SUM(AAFQT(IT,:,1)))**2 + REAL(SUM(AAFQT(IT,:,2)))**2   + AIMAG(SUM(AAFQT(IT,:,2)))**2 + REAL(SUM(AAFQT(IT,:,3)))**2   + AIMAG(SUM(AAFQT(IT,:,3)))**2 
!        CFFQTTYP(IT,1,1)=REAL(SUM(AFQT(IT,:,1)))**2   + AIMAG(SUM(AFQT(IT,:,1)))**2 + REAL(SUM(AFQT(IT,:,2)))**2   + AIMAG(SUM(AFQT(IT,:,2)))**2 + REAL(SUM(AFQT(IT,:,3)))**2   + AIMAG(SUM(AFQT(IT,:,3)))**2 
        END DO
        !$omp end parallel do

 
        DUMMY1=  REAL(CFFQTTYP(:,I)) !      SUM(DUMMY2(1:NQ,1,:),DIM=1 ) /NQ
!        DUMMY2=  AIMAG(CFFQTTYP(:,I)) !      SUM(DUMMY2(1:NQ,1,:),DIM=1 ) /NQ
        IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY5)
        IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY5)
        IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY5)
!        IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY2,DUMMY6)
!        IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY2,DUMMY6)
!        IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY2,DUMMY6)
        WHERE(DUMMY5.LE.1.0E-10)DUMMY5=0
!        WHERE(DUMMY6.LE.1.0E-10)DUMMY6=0


        CFFQTTYP(:,I)=CMPLX(DUMMY5,DUMMY6)
        END DO











        IF(ICUT==1)THEN
        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        WRITE(IQQQQ,15) OMEGA, REAL(CFFQTTYP(DT,:))
        END DO
        END IF
        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        !WRITE(9999,15) OMEGA, REAL(CFFQTTYP(DT,:)),REAL(SUM(CFFQTTYP(DT,:)) - SUM(IND(:,3)*CFFQTTYP(DT,:))),        SUM(AFQT(DT,:,:)*CONJG(AFQT(DT,:,:)))
        WRITE(9999,15) OMEGA, REAL(CFFQTTYP(DT,:)), REAL(SUM(SUM(AFQT(DT,:,:),DIM=1)*CONJG(SUM(AFQT(DT,:,:),DIM=1))))
!        WRITE(9999,15) OMEGA, DUMMY5(DT)
        END DO
!END IF
        17 FORMAT(A12,2X,3F10.5)
        15 FORMAT(F15.4,1003(2E20.2,2x))
        170 FORMAT(A12,100(3X,3F6.2,3X))
        172 FORMAT(A12,<NQ>(3X,3F6.2,3X),6X,'AVG OVER Q')
        171 FORMAT(A3,12X,<NTYP>(8X,'avg',A3,10X) )
        173 FORMAT(A3,12X,<NTYP2>(8X,'avg',2A3,10X) )
        IF(ICUT==1)CLOSE(IQQQQ)
close(9999)
DEALLOCATE(DUMMY1,DUMMY5)
DEALLOCATE(DUMMY2,DUMMY6)
DEALLOCATE(AFQT)
DEALLOCATE(AAFQT)
END SUBROUTINE


SUBROUTINE IIFQT444(IQQQQ,QHKL)   !!!!!!!!!!THIS IS with velcoity projection
use omp_lib
USE VARIABLES1, only :ICARTESIAN,PI,AVGISLAT,POSSTART,MASS,VEL,NSTEPORIG,ICOH,IBROAD,FWHM0,FWHM1,NTYP,NSTEP,NATOM,DELT,ICUT,NNTYPE
IMPLICIT NONE
INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::AFQT!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::tempd,cout !,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::CFFQTTYP !,SQWB
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1,QHKL
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
REAL,DIMENSION(NSTEP)::PHASE1
DOUBLE PRECISION,DIMENSION(NATOM)::PHASE11
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::II1,I1,DT1,III
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DUMMY2,DUMMY4
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMYT
DOUBLE PRECISION::EE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK !,tempd
INTEGER::ITYPPP,JTYPPP
INTEGER::IQQQQ,NNN2
CHARACTER::AA*10
INTEGER::NTYP2,NTYP3
INTEGER::IJ1,IJ2
INTEGER::IQTCAL
integer,allocatable,dimension(:)::plan
integer,dimension(natom)::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMY1,DUMMY5
INTEGER::DT,IT
REAL::OMEGA
INTEGER::I,J
integer,dimension(9)::desca,descb,descc
integer::ia,ja,ib,jb,ic,jc,m,n,k
integer,dimension(1,NATOM)::lda,ldb,ldc
real::alpha,beta
m=natom
n=natom
k=3
alpha=1
beta=0
PRINT*,'I M IN SED444'

IF(ICUT==1)WRITE(AA,'("SEDTOT",I4.4)')IQQQQ
IF(ICUT==1)OPEN(IQQQQ,FILE=AA)
OPEN(9999,FILE='SEDTOTAL',ACCESS='APPEND')
!WRITE(AA,'("VISQWTOT",I2.2)')IQQQQ
!OPEN(IQQQQ+1,FILE=AA)
!PRINT*,'I AM IN IFFQT'
!PRINT*,'RUNNING IQ',IQQQQ
PRINT*, QHKL
ALLOCATE(AFQT(1:NSTEP,NATOM,3))
ALLOCATE(CFFQTTYP(1:NSTEP,NTYP))
ALLOCATE(DUMMY1(NSTEP),DUMMY5(NSTEP))
allocate(plan(NATOM))
AFQT=0
CFFQTTYP=0
IFOR= 1
IBAC=-1
NQ=1
ALLOCATE(QQ(NQ,3),QK(NQ,3))
!ALLOCATE(tempd(NSTEP,NATOM))
!ALLOCATE(COUT(NATOM,NATOM))
!PRINT*,'NSTEP',NSTEP
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!DO IQ=1,NQ            !NQ IS 1 Since we enter the manual hkl values
        IQ=1
        CFFQTTYP=0
        QQ(IQ,:)=QHKL    !KLIST(IQ,:) !VEC
        IF(ICARTESIAN==1)THEN
        KVEC=QHKL        !KLIST(IQ,:)
        ELSE
        !KVEC=2.0*PI*MATMUL(QHKL,AVGISLAT)        !CHANGED AVGISLAT TO ISLAT
        KVEC=2.0*PI*MATMUL(AVGISLAT,QHKL )        !CHANGED AVGISLAT TO ISLAT
        END IF
        QK(IQ,:)=KVEC

        CFFQTTYP=0
        DO J=1,NTYP
        AFQT=0
        DO I=SUM(NNTYPE(1:J-1))+1,SUM(NNTYPE(1:J))  
        PHASE11(I)=DOT_PRODUCT(KVEC,POSSTART(I,:))
        AFQT(:,I,:)=SQRT(MASS(I))*VEL(:,I,:)*CMPLX(COS(PHASE11(I)),SIN(PHASE11(I)))
        call dfftw_plan_dft_1d(plann(i),NSTEP,AFQT(:,I,1),AFQT(:,I,1),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann(i), AFQT(:,I,1),AFQT(:,I,1))
        call dfftw_destroy_plan(plann(i))
        call dfftw_plan_dft_1d(plann(i),NSTEP,AFQT(:,I,2),AFQT(:,I,2),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann(i), AFQT(:,I,2),AFQT(:,I,2))
        call dfftw_destroy_plan(plann(i))
        call dfftw_plan_dft_1d(plann(i),NSTEP,AFQT(:,I,3),AFQT(:,I,3),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann(i), AFQT(:,I,3),AFQT(:,I,3))
        call dfftw_destroy_plan(plann(i))
        AFQT(:,I,:)=AFQT(:,I,:)/REAL(NSTEPORIG)
        END DO
      
         !$omp parallel do
         DO IT=1,NSTEP
         !CFFQTTYP(IT,J)=REAL(SUM(AFQT(IT,:,1)))**2   + AIMAG(SUM(AFQT(IT,:,1)))**2 + REAL(SUM(AFQT(IT,:,2)))**2   + AIMAG(SUM(AFQT(IT,:,2)))**2 + REAL(SUM(AFQT(IT,:,3)))**2   + AIMAG(SUM(AFQT(IT,:,3)))**2 
         CFFQTTYP(IT,J)= SUM(AFQT(IT,SUM(NNTYPE(1:J-1))+1:SUM(NNTYPE(1:J)),:)*CONJG(AFQT(IT,SUM(NNTYPE(1:J-1))+1:SUM(NNTYPE(1:J)),:)) )
! +  SUM(AFQT(IT,SUM(NNTYPE(1:J-1))+1:SUM(NNTYPE(1:J)),2)*CONJG(AFQT(IT,SUM(NNTYPE(1:J-1))+1:SUM(NNTYPE(1:J)),2))) + SUM(AFQT(IT,SUM(NNTYPE(1:J-1))+1:SUM(NNTYPE(1:J)),3)*CONJG(AFQT(IT,SUM(NNTYPE(1:J-1))+1:SUM(NNTYPE(1:J)),3))
!)

         END DO
         !$omp end parallel do
        
 
        DUMMY1=  REAL(CFFQTTYP(:,J)) !      SUM(DUMMY2(1:NQ,1,:),DIM=1 ) /NQ
        IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY5)
        IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY5)
        IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY5)
        WHERE(DUMMY5.LE.1.0E-10)DUMMY5=0
        CFFQTTYP(:,J)=DUMMY5
        END DO


        IF(ICUT==1)THEN
        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        WRITE(IQQQQ,15) OMEGA, REAL(CFFQTTYP(DT,:))
        END DO
        END IF
        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        !WRITE(9999,15) OMEGA, REAL(CFFQTTYP(DT,:)), REAL( SUM(CFFQTTYP(DT,:))) !DUMMY5(DT)
        WRITE(9999,15) OMEGA, REAL(CFFQTTYP(DT,:)), SUM(AFQT(IT,:,:)*CONJG(AFQT(IT,:,:)))
!REAL( SUM(CFFQTTYP(DT,:))) !DUMMY5(DT)
        END DO
!END IF
        17 FORMAT(A12,2X,3F10.5)
        15 FORMAT(F15.4,1003E20.2)
        170 FORMAT(A12,100(3X,3F6.2,3X))
        172 FORMAT(A12,<NQ>(3X,3F6.2,3X),6X,'AVG OVER Q')
        171 FORMAT(A3,12X,<NTYP>(8X,'avg',A3,10X) )
        173 FORMAT(A3,12X,<NTYP2>(8X,'avg',2A3,10X) )
        IF(ICUT==1)CLOSE(IQQQQ)
close(9999)
DEALLOCATE(DUMMY1,DUMMY5)
DEALLOCATE(AFQT)
END SUBROUTINE

SUBROUTINE SED(IQQQQ,QHKL)   !!!!!!!!!!THIS IS with velcoity projection
use omp_lib
USE VARIABLES1, only: ICARTESIAN,PI,AVGISLAT,POSSTART,MASS,VEL,NSTEPORIG,ICOH,IBROAD,FWHM0,FWHM1,NTYP,NSTEP,NATOM,DELT,ICUT,NNTYPE,SNTYPE,PNTYPE,MAP,NDIM
IMPLICIT NONE
INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::AFQT,SAFQT,SSAFQT!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::tempd,cout !,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::CFFQTTYP !,SQWB
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1,QHKL
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
REAL,DIMENSION(NSTEP)::PHASE1
DOUBLE PRECISION,DIMENSION(NATOM)::PHASE11
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::II1,I1,DT1,III
DOUBLE PRECISION::EE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK !,tempd
INTEGER::ITYPPP,JTYPPP
INTEGER::IQQQQ,NNN2
CHARACTER::AA*10
INTEGER::NTYP2,NTYP3
INTEGER::IJ1,IJ2
INTEGER::IQTCAL
integer,allocatable,dimension(:)::plan
integer,dimension(natom)::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMY1,DUMMY5
INTEGER::DT,IT
REAL::OMEGA
INTEGER::I,J
integer,dimension(9)::desca,descb,descc
integer::ia,ja,ib,jb,ic,jc,m,n,k
integer,dimension(1,NATOM)::lda,ldb,ldc
real::alpha,beta
INTEGER::N1,N2
m=natom
n=natom
k=3
alpha=1
beta=0
PRINT*,'I M IN SEDSED'

IF(ICUT==1)WRITE(AA,'("SEDTOT",I4.4)')IQQQQ
IF(ICUT==1)OPEN(IQQQQ,FILE=AA)
OPEN(9999,FILE='SEDTOTAL',ACCESS='APPEND')
PRINT*, QHKL
ALLOCATE(AFQT(1:NSTEP,NDIM,3))
ALLOCATE(SAFQT(1:NSTEP,SUM(PNTYPE),3))
ALLOCATE(CFFQTTYP(1:NSTEP,NTYP))
ALLOCATE(DUMMY1(NSTEP),DUMMY5(NSTEP))
allocate(plan(NATOM))
AFQT=0
SAFQT=0
CFFQTTYP=0
IFOR= 1
IBAC=-1
NQ=1
ALLOCATE(QQ(NQ,3),QK(NQ,3))
!ALLOCATE(tempd(NSTEP,NATOM))
!ALLOCATE(COUT(NATOM,NATOM))
!PRINT*,'NSTEP',NSTEP
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!DO IQ=1,NQ            !NQ IS 1 Since we enter the manual hkl values
!DO J=1,SUM(PNTYPE)
!PRINT*,MAP(J,:)
!END DO

        IQ=1
        CFFQTTYP=0
        QQ(IQ,:)=QHKL    !KLIST(IQ,:) !VEC
        IF(ICARTESIAN==1)THEN
        KVEC=QHKL        !KLIST(IQ,:)
        ELSE
        KVEC=2.0*PI*MATMUL(AVGISLAT,QHKL )        !CHANGED AVGISLAT TO ISLAT
        END IF
        QK(IQ,:)=KVEC
        !PRINT*,QK(IQ,:)
        CFFQTTYP=0
        SAFQT=0
        DO J=1,SUM(PNTYPE)
        AFQT=0
        DO I=1,NDIM !SUM(SNTYPE)/SUM(PNTYPE) !SUM(NNTYPE(1:J-1))+1,SUM(NNTYPE(1:J))  
        IF(MAP(J,I).NE.0)THEN
        PHASE11(I)=DOT_PRODUCT(KVEC,POSSTART(MAP(J,I),:))
        AFQT(:,I,:)=SQRT(MASS(MAP(J,I)))*VEL(:,MAP(J,I),:)*CMPLX(COS(PHASE11(I)),SIN(PHASE11(I)))
        call dfftw_plan_dft_1d(plann(i),NSTEP,AFQT(:,I,1),AFQT(:,I,1),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann(i), AFQT(:,I,1),AFQT(:,I,1))
        call dfftw_destroy_plan(plann(i))
        call dfftw_plan_dft_1d(plann(i),NSTEP,AFQT(:,I,2),AFQT(:,I,2),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann(i), AFQT(:,I,2),AFQT(:,I,2))
        call dfftw_destroy_plan(plann(i))
        call dfftw_plan_dft_1d(plann(i),NSTEP,AFQT(:,I,3),AFQT(:,I,3),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann(i), AFQT(:,I,3),AFQT(:,I,3))
        call dfftw_destroy_plan(plann(i))
        AFQT(:,I,:)=AFQT(:,I,:)/REAL(NSTEPORIG)
        SAFQT(:,J,:)=SAFQT(:,J,:) +  AFQT(:,I,:) !*CONJG(AFQT(:,I,:))
        END IF
        END DO
!        SAFQT(:,J,:)= AFQT(:,1,:)*CONJG(AFQT(:,1,:))
        END DO
        

!         PRINT*, SAFQT(:,1,1)  
         DO J=1,NTYP
         N1=SUM(PNTYPE(1:J-1))+1
         N2=SUM(PNTYPE(1:J))
         PRINT*,N1,N2
         DO IT=1,NSTEP
         CFFQTTYP(IT,J)=SUM( SAFQT(IT,N1:N2,:) * CONJG(SAFQT(IT,N1:N2,:))) 
         !CFFQTTYP(IT,J)=SUM( SAFQT(IT,N1:N2,1) * CONJG(SAFQT(IT,N1:N2,1)))  + SUM( SAFQT(IT,N1:N2,2) * CONJG(SAFQT(IT,N1:N2,2)))  +         SUM( SAFQT(IT,N1:N2,3) * CONJG(SAFQT(IT,N1:N2,3))) 
!         + SUM(SAFQT(IT,N1:N2,2)) + SUM(SAFQT(IT,N1:N2,3))
         END DO
         DUMMY1=  REAL(CFFQTTYP(:,J)) !      SUM(DUMMY2(1:NQ,1,:),DIM=1 ) /NQ
         IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY5)
         IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY5)
         IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY5)
         WHERE(DUMMY5.LE.1.0E-10)DUMMY5=0
         CFFQTTYP(:,J)=DUMMY5
         END DO

        IF(ICUT==1)THEN
        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        WRITE(IQQQQ,15) OMEGA, REAL(CFFQTTYP(DT,:))
        END DO
        END IF
        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        WRITE(9999,15) OMEGA, REAL(CFFQTTYP(DT,:)), REAL( SUM(CFFQTTYP(DT,:))) !DUMMY5(DT)
        END DO
!END IF
        17 FORMAT(A12,2X,3F10.5)
        15 FORMAT(F15.4,1003E20.2)
        170 FORMAT(A12,100(3X,3F6.2,3X))
        172 FORMAT(A12,<NQ>(3X,3F6.2,3X),6X,'AVG OVER Q')
        171 FORMAT(A3,12X,<NTYP>(8X,'avg',A3,10X) )
        173 FORMAT(A3,12X,<NTYP2>(8X,'avg',2A3,10X) )
        IF(ICUT==1)CLOSE(IQQQQ)
close(9999)
DEALLOCATE(DUMMY1,DUMMY5)
DEALLOCATE(AFQT)
END SUBROUTINE




SUBROUTINE IIFQT55(IQQQQ,QHKL)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::FQT,FFQTTYP,AAFQT,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::CFFQTTYP,IFFQTTYP!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:)::TCFFQTTYP !,IFFQTTYP!,SQWB
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1,QHKL
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::tempd !,SQWB
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
REAL,DIMENSION(NSTEP)::PHASE1
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::II1,I1,DT1,III
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DUMMY2,DUMMY4
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMYT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMY1,DUMMY5
DOUBLE PRECISION::EE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK
INTEGER::ITYPPP,JTYPPP
INTEGER::IQQQQ,NNN2
CHARACTER::AA*11
INTEGER::NTYP2
INTEGER::IJ1,IJ2
INTEGER::IQTCAL
integer,allocatable,dimension(:)::plan
integer::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
integer,allocatable,dimension(:,:)::ind
integer::n3,n4,ntotal
!#IF(ICUT==1)WRITE(AA,'("CSQWTOT",I4.4)')IQQQQ
!#IF(ICUT==1)OPEN(IQQQQ,FILE=AA)
!IF(ICUT==1)WRITE(AA,'("ISQWTOT",I4.4)')IQQQQ
!IF(ICUT==1)OPEN(IQQQQ+100,FILE=AA)
IF(ICUT==1)WRITE(AA,'("TSQWTOT",I4.4)')IQQQQ
IF(ICUT==1)OPEN(IQQQQ+9999,FILE=AA)
OPEN(9999,FILE='SQETOTAL',ACCESS='APPEND')
!OPEN(9997,FILE='CSQETOTAL',ACCESS='APPEND')
!OPEN(9998,FILE='ISQETOTAL',ACCESS='APPEND')
PRINT*,'I AM IN IFFQT'

ALLOCATE(FQT(1:NSTEP,NATOM))
ALLOCATE(AAFQT(1:NSTEP,NATOM))
allocate(plan(NATOM))
!allocate(tempd(nstep,natom))
ALLOCATE(DUMMY1(NSTEP),DUMMY5(NSTEP))
FQT=0
CFFQTTYP=0
IFOR= 1
IBAC=-1
NQ=1
NTYP2=NTYP*NTYP
ALLOCATE(CFFQTTYP(1:NSTEP,NTYP2))
ALLOCATE(IFFQTTYP(1:NSTEP,NTYP2))
ALLOCATE(TCFFQTTYP(1:NSTEP))
ALLOCATE(IND(NTYP2,3))
PRINT*,QHKL
ALLOCATE(QQ(NQ,3),QK(NQ,3))
        CFFQTTYP=0
        IF(ICARTESIAN==1)THEN
        KVEC=QHKL
        ELSE
        !KVEC=2.0*PI*MATMUL(QHKL,AVGISLAT)        !CHANGED AVGISLAT TO ISLAT
        KVEC=2.0*PI*MATMUL(AVGISLAT,QHKL)        !CHANGED AVGISLAT TO ISLAT
        END IF
        DO I=1,NATOM
                !$omp parallel do
                DO IT=1,NSTEPORIG
                PHASE1(IT)=DOT_PRODUCT(KVEC,POS(IT,I,:))
                FQT(IT,I)=CMPLX(COS(PHASE1(IT)),SIN(PHASE1(IT)))
                END DO
                !$omp end parallel do

        call dfftw_plan_dft_1d(plann,NSTEP,FQT(:,I),FQT(:,I),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, FQT(:,I),FQT(:,I))
        call dfftw_destroy_plan(plann)
        FQT(:,I)=FQT(:,I)/REAL(NSTEPORIG)
        END DO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!COHERENT!CASE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

         K=0
         DO I=1,NTYP
         DO J=1,NTYP
         K=K+1
         IND(K,1)=I !NNTYPE(I)
         IND(K,2)=J !NNTYPE(J)
         IF (I==J)IND(K,3)=1
         END DO
         END DO


         CFFQTTYP=0
         DO I=1,NTYP2
         N1=SUM(NNTYPE(1:IND(I,1)-1))+1
         N2=SUM(NNTYPE(1:IND(I,1)))
         N3=SUM(NNTYPE(1:IND(I,2)-1))+1
         N4=SUM(NNTYPE(1:IND(I,2)))
         PRINT*,N1,N2,N3,N4
         NTOTAL=N2-N1+1 + N4-N3+1
         PRINT*,NTOTAL,N2-N1+2
         AAFQT(:,1:N2-N1+1) =FQT(:,N1:N2)
         IF (N1.NE.N3 .AND. N2.NE.N4) THEN
         AAFQT(:,N2-N1+2:NTOTAL) =FQT(:,N3:N4)
         END IF


         PRINT*,'I AM IN COHERENT SQE'
         cbbt=1
         !$omp parallel do
         DO IT=1,NSTEP
         CFFQTTYP(IT,I)=REAL(SUM(CBBT(:)*AAFQT(IT,:)))**2   + AIMAG(SUM(CBBT(:)*AAFQT(IT,:)))**2  
         END DO
         !$omp end parallel do
         DUMMY1=  REAL(CFFQTTYP(:,I)) !      SUM(DUMMY2(1:NQ,1,:),DIM=1 ) /NQ
         IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY5)
         IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY5)
         IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY5)
         WHERE(DUMMY5.LE.1.0E-20)DUMMY5=0
         !CFFQTTYP(:,I)=0.0 !DUMMY5
         CFFQTTYP(:,I)=DUMMY5

         END DO



        cbbt=1
         !$omp parallel do
         DO IT=1,NSTEP
         TCFFQTTYP(IT)=REAL(SUM(CBBT(:)*FQT(IT,:)))**2   + AIMAG(SUM(CBBT(:)*FQT(IT,:)))**2
         END DO
         !$omp end parallel do
         DUMMY1=  REAL(TCFFQTTYP(:)) !      SUM(DUMMY2(1:NQ,1,:),DIM=1 ) /NQ
         IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY5)
         IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY5)
         IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY5)
         WHERE(DUMMY5.LE.1.0E-20)DUMMY5=0
         !TCFFQTTYP(:)=0.0 !DUMMY5
         TCFFQTTYP(:)=DUMMY5


        PRINT*,'I AM IN INCOHERENT SQE'
        IFFQTTYP=0
        !$omp parallel do
        DO IT=1,NSTEP
        !IFFQTTYP(IT,1,1)=SUM(   IBBT(:)*IBBT(:)*FQT(IT,:)*CONJG(FQT(It,:)) )    
        IFFQTTYP(IT,1)=SUM(   SSINC(:)*FQT(IT,:)*CONJG(FQT(It,:)) )    
        END DO
        !$omp end parallel do
        DUMMY1=  REAL(IFFQTTYP(:,1)) !      SUM(DUMMY2(1:NQ,1,:),DIM=1 ) /NQ
        IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY5)
        IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY5)
        IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY5)
        WHERE(DUMMY5.LE.1.0E-20)DUMMY5=0
        IFFQTTYP(:,1)=0.0 
        IFFQTTYP(:,1)=DUMMY5


        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        WRITE(9999,15) (QHKL/NSS), OMEGA,CFFQTTYP(DT,:) ,TCFFQTTYP(DT)  !+REAL(IFFQTTYP(DT,1,1)),REAL(CFFQTTYP(DT,1,1)), REAL(IFFQTTYP(DT,1,1))
        !IF(ICUT==1)WRITE(IQQQQ+9999,15) OMEGA,REAL(CFFQTTYP(DT,1,1)) +REAL(IFFQTTYP(DT,1,1)),REAL(CFFQTTYP(DT,1,1)), REAL(IFFQTTYP(DT,1,1))
        END DO


        17 FORMAT(A12,2X,3F10.5)
        15 FORMAT(3F10.5, 2X, F15.4,1003E20.4)
        170 FORMAT(A12,100(3X,3F6.2,3X))
        172 FORMAT(A12,<NQ>(3X,3F6.2,3X),6X,'AVG OVER Q')
        171 FORMAT(A3,12X,<NTYP>(8X,'avg',A3,10X) )
        173 FORMAT(A3,12X,<NTYP2>(8X,'avg',2A3,10X) )
CLOSE(9999)
CLOSE(9997)
CLOSE(9998)
DEALLOCATE(AAFQT,FQT,CFFQTTYP)
END SUBROUTINE


SUBROUTINE IIFQT555(IQQQQ,QHKL)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::FQT,FFQTTYP,AAFQT,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::CFFQTTYP!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::IFFQTTYP!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:)::TCFFQTTYP,TIFFQTTYP !,IFFQTTYP!,SQWB
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1,QHKL
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::tempd !,SQWB
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
REAL,DIMENSION(NSTEP)::PHASE1
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::II1,I1,DT1,III
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DUMMY2,DUMMY4
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMYT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMY1,DUMMY5,DUMMY6
DOUBLE PRECISION::EE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK
INTEGER::ITYPPP,JTYPPP
INTEGER::IQQQQ,NNN2
CHARACTER::AA*11
INTEGER::NTYP2
INTEGER::IJ1,IJ2
INTEGER::IQTCAL
integer,allocatable,dimension(:)::plan
integer::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
integer,allocatable,dimension(:,:)::ind
integer::n3,n4,ntotal
INTEGER,ALLOCATABLE,DIMENSION(:,:)::IND2
integer::KTYPPP
!#IF(ICUT==1)WRITE(AA,'("CSQWTOT",I4.4)')IQQQQ
!#IF(ICUT==1)OPEN(IQQQQ,FILE=AA)
!IF(ICUT==1)WRITE(AA,'("ISQWTOT",I4.4)')IQQQQ
!IF(ICUT==1)OPEN(IQQQQ+100,FILE=AA)
IF(ICUT==1)WRITE(AA,'("TSQWTOT",I4.4)')IQQQQ
IF(ICUT==1)OPEN(IQQQQ+9999,FILE=AA)
OPEN(9999,FILE='SQETOTAL',ACCESS='APPEND')
!OPEN(9997,FILE='CSQETOTAL',ACCESS='APPEND')
!OPEN(9998,FILE='ISQETOTAL',ACCESS='APPEND')
PRINT*,'I AM IN IFFQT'

ALLOCATE(FQT(1:NSTEP,NATOM))
ALLOCATE(AAFQT(1:NSTEP,NATOM))
allocate(plan(NATOM))
!allocate(tempd(nstep,natom))
ALLOCATE(DUMMY1(NSTEP),DUMMY5(NSTEP))
ALLOCATE(DUMMY6(NSTEP))
FQT=0
CFFQTTYP=0
IFOR= 1
IBAC=-1
NQ=1
NTYP2=NTYP*NTYP
ALLOCATE(CFFQTTYP(1:NSTEP,NTYP,NTYP))
ALLOCATE(IFFQTTYP(1:NSTEP,NTYP))
ALLOCATE(TCFFQTTYP(1:NSTEP))
ALLOCATE(TIFFQTTYP(1:NSTEP))
ALLOCATE(IND2(NTYP2,2))
PRINT*,QHKL
ALLOCATE(QQ(NQ,3),QK(NQ,3))


        K=0
        DO I=1,NTYP
        DO J=I,NTYP
        K=K+1
        IND2(K,1)=I
        IND2(K,2)=J
        ENDDO
        ENDDO









        CFFQTTYP=0
        IFFQTTYP=0
        TCFFQTTYP=0
        TIFFQTTYP=0
        IF(ICARTESIAN==1)THEN
        KVEC=QHKL
        ELSE
        !KVEC=2.0*PI*MATMUL(QHKL,AVGISLAT)        !CHANGED AVGISLAT TO ISLAT
        KVEC=2.0*PI*MATMUL(AVGISLAT,QHKL)        !CHANGED AVGISLAT TO ISLAT
        END IF
        DO I=1,NATOM
                !$omp parallel do
                DO IT=1,NSTEPORIG
                PHASE1(IT)=DOT_PRODUCT(KVEC,POS(IT,I,:))
                FQT(IT,I)=CMPLX(COS(PHASE1(IT)),SIN(PHASE1(IT)))
                END DO
                !$omp end parallel do

        call dfftw_plan_dft_1d(plann,NSTEP,FQT(:,I),FQT(:,I),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, FQT(:,I),FQT(:,I))
        call dfftw_destroy_plan(plann)
        FQT(:,I)=FQT(:,I)/REAL(NSTEPORIG)
        END DO

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!COHERENT!CASE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!COHERENT
!CASE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        PRINT*,'I AM IN COHERENT33'


        !$omp parallel do
        DO KTYPPP=1,NTYP2
        PRINT*,IND2(KTYPPP,1),IND2(KTYPPP,2) !ITYPPP,JTYPPP
        DO I=SUM(NNTYPE(1:IND2(KTYPPP,1)-1))+1,SUM(NNTYPE(1:IND2(KTYPPP,1)))
        CFFQTTYP(1:NSTEP,IND2(KTYPPP,1),IND2(KTYPPP,2))=CFFQTTYP(1:NSTEP,IND2(KTYPPP,1),IND2(KTYPPP,2))+        BBT(IND2(KTYPPP,1))*BBT(IND2(KTYPPP,2))* FQT(1:NSTEP,I) *CONJG(SUM(FQT(1:NSTEP,SUM(NNTYPE(1:IND2(KTYPPP,2)-1))+1 : SUM(NNTYPE(1:IND2(KTYPPP,2)))),DIM=2) )
        END DO
        END DO
        !$omp end parallel do

        DO I=1,NTYP
        DO J=I,NTYP
        IF(i.ne.j)CFFQTTYP(1:NSTEP,J,I)=CFFQTTYP(1:NSTEP,I,J)
        END DO
        END DO


        DO I=1,NTYP
        DO J=1,NTYP

         DUMMY1=  REAL(CFFQTTYP(:,I,J)) 
         IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY5)
         IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY5)
         IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY5)
         WHERE(DUMMY5.LE.1.0E-20)DUMMY5=0

         DUMMY1=  AIMAG(CFFQTTYP(:,I,J)) 
         IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY6)
         IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY6)
         IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY6)
         WHERE(DUMMY6.LE.1.0E-20)DUMMY6=0


         !CFFQTTYP(:,I)=0.0 !DUMMY5
         CFFQTTYP(:,I,J)=CMPLX(DUMMY5,DUMMY6)
         END DO
         END DO


        PRINT*,'I AM IN INCOHERENT SQE'
        IFFQTTYP=0
        !$omp parallel do
        DO IT=1,NSTEP
        TIFFQTTYP(IT)=SUM(   SSINC(:)*FQT(IT,:)*CONJG(FQT(It,:)) )    
        END DO
        !$omp end parallel do
        DUMMY1=  REAL(TIFFQTTYP(:)) !      SUM(DUMMY2(1:NQ,1,:),DIM=1 ) /NQ
        IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY5)
        IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY5)
        IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY5)
        WHERE(DUMMY5.LE.1.0E-20)DUMMY5=0
        TIFFQTTYP(:)=0.0 
        TIFFQTTYP(:)=DUMMY5


        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        WRITE(9999,15) (QHKL/NSS), OMEGA,((CFFQTTYP(DT,I,J),I=1,NTYP),J=1,NTYP) !,TCFFQTTYP(DT)  !+REAL(IFFQTTYP(DT,1,1)),REAL(CFFQTTYP(DT,1,1)), REAL(IFFQTTYP(DT,1,1))
        !IF(ICUT==1)WRITE(IQQQQ+9999,15) OMEGA,REAL(CFFQTTYP(DT,1,1)) +REAL(IFFQTTYP(DT,1,1)),REAL(CFFQTTYP(DT,1,1)), REAL(IFFQTTYP(DT,1,1))
        END DO


        17 FORMAT(A12,2X,3F10.5)
        15 FORMAT(3F10.5, 2X, F15.4,1003E20.4)
        170 FORMAT(A12,100(3X,3F6.2,3X))
        172 FORMAT(A12,<NQ>(3X,3F6.2,3X),6X,'AVG OVER Q')
        171 FORMAT(A3,12X,<NTYP>(8X,'avg',A3,10X) )
        173 FORMAT(A3,12X,<NTYP2>(8X,'avg',2A3,10X) )
CLOSE(9999)
CLOSE(9997)
CLOSE(9998)
DEALLOCATE(AAFQT,FQT,CFFQTTYP)
END SUBROUTINE


SUBROUTINE SEDNEW(IQQQQ,QHKL)   !!!!!!!!!!THIS IS with velcoity projection
use omp_lib
USE VARIABLES1, only: ICARTESIAN,PI,AVGISLAT,POSSTART,MASS,VEL,NSTEPORIG,ICOH,IBROAD,FWHM0,FWHM1,NTYP,NSTEP,NATOM,DELT,ICUT,NNTYPE,SNTYPE,PNTYPE,MAP
IMPLICIT NONE
INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::AFQT !,SAFQT,SSAFQT!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::tempd,cout !,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::CFFQTTYP !,SQWB
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1,QHKL
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
REAL,DIMENSION(NSTEP)::PHASE1
DOUBLE PRECISION,DIMENSION(NATOM)::PHASE11
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::II1,I1,DT1,III
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DUMMY2,DUMMY4
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMYT
DOUBLE PRECISION::EE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK !,tempd
INTEGER::ITYPPP,JTYPPP
INTEGER::IQQQQ,NNN2
CHARACTER::AA*10
INTEGER::NTYP2,NTYP3
INTEGER::IJ1,IJ2
INTEGER::IQTCAL
integer,allocatable,dimension(:)::plan
integer,dimension(natom)::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMY1,DUMMY5,DUMMY6
INTEGER::DT,IT
REAL::OMEGA
INTEGER::I,J
integer,dimension(9)::desca,descb,descc
integer::ia,ja,ib,jb,ic,jc,m,n,k
integer,dimension(1,NATOM)::lda,ldb,ldc
real::alpha,beta
INTEGER::SDIM,N1,N2,KTYPPP
INTEGER,allocatable,DIMENSION(:,:)::IND2

m=natom
n=natom
k=3
alpha=1
beta=0
PRINT*,'I M IN SEDNEW'

IF(ICUT==1)WRITE(AA,'("SEDTOT",I4.4)')IQQQQ
IF(ICUT==1)OPEN(IQQQQ,FILE=AA)
OPEN(9999,FILE='SEDTOTAL',ACCESS='APPEND')
!WRITE(AA,'("VISQWTOT",I2.2)')IQQQQ
!OPEN(IQQQQ+1,FILE=AA)
!PRINT*,'I AM IN IFFQT'
!PRINT*,'RUNNING IQ',IQQQQ
PRINT*, QHKL
!SDIM=SUM(SNTYPE)/SUM(PNTYPE)
ALLOCATE(AFQT(1:NSTEP,NATOM,3))
!ALLOCATE(AFQT(1:NSTEP,SDIM,3))
!ALLOCATE(SAFQT(1:NSTEP,SUM(PNTYPE),3))
!ALLOCATE(SSAFQT(1:NSTEP,NTYP,3))
ALLOCATE(CFFQTTYP(1:NSTEP,NTYP,NTYP))
ALLOCATE(DUMMY1(NSTEP),DUMMY5(NSTEP))
ALLOCATE(DUMMY6(NSTEP))
allocate(plan(NATOM))
ALLOCATE(IND2(NTYP*(NTYP+1)/2,2))
AFQT=0
!SAFQT=0
CFFQTTYP=0
IFOR= 1
IBAC=-1
NQ=1
NTYP2=NTYP*(NTYP+1)/2
!ALLOCATE(QQ(NQ,3),QK(NQ,3))
!ALLOCATE(COUT(NATOM,NATOM))
        1234 FORMAT(3F10.5)


         K=0
         DO I=1,NTYP
         DO J=I,NTYP
         K=K+1
         IND2(K,1)=I !NNTYPE(I)
         IND2(K,2)=J !NNTYPE(J)
         END DO
         END DO


        IQ=1
        CFFQTTYP=0
        QQ(IQ,:)=QHKL    !KLIST(IQ,:) !VEC
        IF(ICARTESIAN==1)THEN
        KVEC=QHKL        !KLIST(IQ,:)
        ELSE
        KVEC=2.0*PI*MATMUL(AVGISLAT,QHKL )        !CHANGED AVGISLAT TO ISLAT
        END IF
        QK(IQ,:)=KVEC
        CFFQTTYP=0
        AFQT=0
        DO I=1,NATOM !SDIM !SUM(SNTYPE)/SUM(PNTYPE) !SUM(NNTYPE(1:J-1))+1,SUM(NNTYPE(1:J))  
        PHASE11(I)=DOT_PRODUCT(KVEC,POSSTART(I,:))
        AFQT(:,I,:)=SQRT(MASS(I))*VEL(:,I,:)*CMPLX(COS(PHASE11(I)),SIN(PHASE11(I)))
        call dfftw_plan_dft_1d(plann(i),NSTEP,AFQT(:,I,1),AFQT(:,I,1),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann(i), AFQT(:,I,1),AFQT(:,I,1))
        call dfftw_destroy_plan(plann(i))
        call dfftw_plan_dft_1d(plann(i),NSTEP,AFQT(:,I,2),AFQT(:,I,2),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann(i), AFQT(:,I,2),AFQT(:,I,2))
        call dfftw_destroy_plan(plann(i))
        call dfftw_plan_dft_1d(plann(i),NSTEP,AFQT(:,I,3),AFQT(:,I,3),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann(i), AFQT(:,I,3),AFQT(:,I,3))
        call dfftw_destroy_plan(plann(i))
        AFQT(:,I,:)=AFQT(:,I,:)/REAL(NSTEPORIG)
!        SAFQT(:,J,:)=SAFQT(:,J,:) +  AFQT(:,I,:) !*CONJG(AFQT(:,I,:))
        END DO
!        SAFQT(:,J,:)= AFQT(:,1,:)*CONJG(AFQT(:,1,:))
        


        !$omp parallel do
        DO KTYPPP=1,NTYP2
        PRINT*,IND2(KTYPPP,1),IND2(KTYPPP,2) !ITYPPP,JTYPPP
        DO I=SUM(NNTYPE(1:IND2(KTYPPP,1)-1))+1,SUM(NNTYPE(1:IND2(KTYPPP,1)))
       CFFQTTYP(1:NSTEP,IND2(KTYPPP,1),IND2(KTYPPP,2))=CFFQTTYP(1:NSTEP,IND2(KTYPPP,1),IND2(KTYPPP,2))+ & 
       AFQT(1:NSTEP,I,1)*CONJG(SUM(AFQT(1:NSTEP,SUM(NNTYPE(1:IND2(KTYPPP,2)-1))+1 :SUM(NNTYPE(1:IND2(KTYPPP,2))),1),DIM=2) ) + & 
       AFQT(1:NSTEP,I,2)*CONJG(SUM(AFQT(1:NSTEP,SUM(NNTYPE(1:IND2(KTYPPP,2)-1))+1 :SUM(NNTYPE(1:IND2(KTYPPP,2))),2),DIM=2) ) + & 
       AFQT(1:NSTEP,I,3)*CONJG(SUM(AFQT(1:NSTEP,SUM(NNTYPE(1:IND2(KTYPPP,2)-1))+1 :SUM(NNTYPE(1:IND2(KTYPPP,2))),3),DIM=2) )
        END DO
        END DO
        !$omp end parallel do

        DO I=1,NTYP
        DO J=I,NTYP
        IF(i.ne.j)CFFQTTYP(1:NSTEP,J,I)=CFFQTTYP(1:NSTEP,I,J)
        END DO
        END DO





         DO I=1,NTYP
         DO J=1,NTYP
         DUMMY1=  REAL(CFFQTTYP(:,I,J))
         IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY5)
         IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY5)
         IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY5)
         WHERE(DUMMY5.LE.1.0E-20)DUMMY5=0
         DUMMY1=  AIMAG(CFFQTTYP(:,I,J))
         IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY6)
         IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY6)
         IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY6)
         WHERE(DUMMY6.LE.1.0E-20)DUMMY6=0
         CFFQTTYP(:,I,J)=CMPLX(DUMMY5,DUMMY6)
         END DO
         END DO



        IF(ICUT==1)THEN
        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        WRITE(IQQQQ,15) OMEGA, REAL(CFFQTTYP(DT,:,:))
        END DO
        END IF
        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        !WRITE(9999,15) OMEGA, REAL(CFFQTTYP(DT,:,:))          !, REAL( SUM(CFFQTTYP(DT,:))) !DUMMY5(DT)
        WRITE(9999,15) OMEGA, CFFQTTYP(DT,:,:)          !, REAL( SUM(CFFQTTYP(DT,:))) !DUMMY5(DT)
        END DO
!END IF
        17 FORMAT(A12,2X,3F10.5)
        15 FORMAT(F15.4,1003E20.2)
        170 FORMAT(A12,100(3X,3F6.2,3X))
        172 FORMAT(A12,<NQ>(3X,3F6.2,3X),6X,'AVG OVER Q')
        171 FORMAT(A3,12X,<NTYP>(8X,'avg',A3,10X) )
        173 FORMAT(A3,12X,<NTYP2>(8X,'avg',2A3,10X) )
        IF(ICUT==1)CLOSE(IQQQQ)
close(9999)
DEALLOCATE(DUMMY1,DUMMY5,DUMMY6)
DEALLOCATE(AFQT,CFFQTTYP)
END SUBROUTINE



SUBROUTINE ANGULARDOS !2021
use omp_lib
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(3)::DDD
DOUBLE PRECISION::RXY
!INTEGER,DIMENSION(500,NCORD)::BDIST
DOUBLE PRECISION::RTOPI
INTEGER::JJJJ,JK,IR,JKK
DOUBLE PRECISION::D2,DR1,DR2
DOUBLE PRECISION::PROJ1,PROJ2,TWOPI
DOUBLE PRECISION,DIMENSION(3,3)::IAXIS
DOUBLE PRECISION::X,Y,Z,R
!DOUBLE PRECISION,DIMENSION(3,3)::NEWLAT
INTEGER::MATOM,JCu,ICAP
!INTEGER,DIMENSION(10000)::INDEXI
INTEGER::MAXCAP,JTAG !,NCORD
DOUBLE PRECISION::AVGBOND
INTEGER::J1
!INTEGER,DIMENSION(NATOM,12,3)::PICK
INTEGER,ALLOCATABLE,DIMENSION(:,:,:)::PICK
REAL::RIJ,RJK
INTEGER::NC1,NK
DOUBLE PRECISION,DIMENSION(3)::AA,VVEL
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::RBR,RB
COMPLEX,DIMENSION(NSTEP)::CORR,CORRT
DOUBLE PRECISION,DIMENSION(2*NSTEP)::AAAA1, AAAA2,AAAA3
INTEGER::IFOR,IBAC,kk
IFOR=1
IBAC=-1
!OPEN(1505,FILE="ANGULAR")
!OPEN(1506,FILE="FANGULAR")
ALLOCATE(RB(NNTYPE(CATOM),NCORD,3))
ALLOCATE(PICK(NATOM,NCORD,3))
PRINT*,'I M IN ANGULAR DOS'
PRINT*,CATOM,SATOM
RTOPI=180/(4*ATAN(1.0))  !3.14
PI=4*ATAN(1.0)
TWOPI=8*ATAN(1.0)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
PRINT*,NCORD,BOND
DO I=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
        NC1=0
        NK=0
        DO J=SUM(NNTYPE(1:SATOM-1))+1,SUM(NNTYPE(1:SATOM))   !,NNTYPE(CATOM)
                AA=POS(1 ,I,:)-POS(1 ,J,:)
                AA=MATMUL(AA,ISLAT)
                WHERE(AA.LT.-0.5)AA=AA+1
                WHERE(AA.GT.0.5)AA=AA-1
                RIJ=NORM2(MATMUL(AA,SLAT))
                IF(RIJ.LE.BOND)THEN
                 NC1= NC1+1       !!!!!!!!CORDINATION1
                 NK = NK+1
                 IF(NC1.GT.NCORD)EXIT
                        PICK(I,NK,1)=I
                        PICK(I,NK,2)=J
                        PRINT*,PICK(I,NK,2) ,NK
                END IF
        END DO
!        IF(ANY(PICK(I,1:NCORD,2).LT.1))PRINT*,PICK(I,1:NCORD,2), I
END DO

PRINT*,'INDEXINGDONE'
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  CORRT=0
  KK=0
        DO I=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
        KK=KK+1
        DO J=1,NCORD
        CORR=0
        AAAA1=0
        AAAA2=0
        AAAA3=0
                        DO IT=1,(IREF2-IREF1)+1   !,INTERVAL2
                        RB(KK,J,:)=POS(IT,I,:)-POS(IT,PICK(I,J,2),:)
                        RB(KK,J,:)=RB(KK,J,:)/(NORM2(RB(KK,J,:))**2)
                        VVEL=VEL(IT,PICK(I,J,2),:)-VEL(IT,I,:) 
                        RB(KK,J,1)=RB(KK,J,2)*VVEL(3) - RB(KK,J,3)*VVEL(2) 
                        RB(KK,J,2)=RB(KK,J,3)*VVEL(1) - RB(KK,J,1)*VVEL(3) 
                        RB(KK,J,3)=RB(KK,J,1)*VVEL(2) - RB(KK,J,2)*VVEL(1) 
                        !RB(KK,J,1)=(RB(KK,J,2)*VEL(IT,PICK(I,J,2),3)) - (RB(KK,J,3)*VEL(IT,PICK(I,J,2),2)) 
                        !RB(KK,J,2)=(RB(KK,J,3)*VEL(IT,PICK(I,J,2),1)) - (RB(KK,J,3)*VEL(IT,PICK(I,J,2),3)) 
                        !RB(KK,J,3)=(RB(KK,J,1)*VEL(IT,PICK(I,J,2),2)) - (RB(KK,J,3)*VEL(IT,PICK(I,J,2),1)) 
                        AAAA1(2*IT-1)= RB(KK,J,1)!CORR(1:NSTEP)  !REAL(FQT(II1,I))
                        AAAA2(2*IT-1)= RB(KK,J,2)!CORR(1:NSTEP)  !REAL(FQT(II1,I))
                        AAAA3(2*IT-1)= RB(KK,J,3)!CORR(1:NSTEP)  !REAL(FQT(II1,I))
                        END DO
                        !PRINT*,AAAA1
                        CALL dfour1(AAAA1,NSTEP,IFOR)
                        CALL dfour1(AAAA2,NSTEP,IFOR)
                        CALL dfour1(AAAA3,NSTEP,IFOR)
                        CORR(1:NSTEP)=CMPLX(AAAA1(1:2*NSTEP:2),AAAA1(2:2*NSTEP:2)) + CMPLX(AAAA2(1:2*NSTEP:2),AAAA2(2:2*NSTEP:2)) + CMPLX(AAAA3(1:2*NSTEP:2),AAAA3(2:2*NSTEP:2))
                        CORRT(1:NSTEP)=CORRT+ CORR*CONJG(CORR) 
                        !CORRT(1:NSTEP)=CORRT+ ABS(CORR(1:NSTEP)) 
        END DO
        END DO

        CORRT=CORRT/(NSTEP*NNTYPE(CATOM)*NCORD)

!######  Fourier Transform!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!VACF!!!!!!!!!!!!!!!!!!
        DO IT=1,NSTEP
        OMEGA=4.136*REAL((IT-1)/(DELT*NSTEP))
        WRITE(1506,80) OMEGA,CORRT(IT)
        80 FORMAT(E15.5,2X,100(3(2E20.8,2x)3x))
        END DO


        AAAA1=0
        AAAA1(1:2*NSTEP:2)= CORRT(1:NSTEP) !RB(I,J,1)
        CALL dfour1(AAAA1,NSTEP,IBAC)
        CORRT(1:NSTEP)=CMPLX(AAAA1(1:2*NSTEP:2),AAAA1(2:2*NSTEP:2))
        CORRT=CORRT/NSTEP
        DO IT=1,NSTEP
        WRITE(1505,80) IT*DELT ,CORRT(IT)
        END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
END SUBROUTINE



SUBROUTINE ANGULARDOS2
use omp_lib
USE VARIABLES1
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(3)::DDD
DOUBLE PRECISION::RXY
DOUBLE PRECISION::RTOPI
INTEGER::JJJJ,JK,IR,JKK
DOUBLE PRECISION::D2,DR1,DR2
DOUBLE PRECISION::PROJ1,PROJ2,TWOPI
DOUBLE PRECISION::X,Y,Z,R
DOUBLE PRECISION,DIMENSION(3,3)::NEWLAT
INTEGER::MATOM,JCu,ICAP
INTEGER::MAXCAP,JTAG !,NCORD
DOUBLE PRECISION::AVGBOND
INTEGER::J1
INTEGER,DIMENSION(NATOM,12,3)::PICK
REAL::RIJ,RJK
INTEGER::NC1,NK
DOUBLE PRECISION,DIMENSION(3)::AA
DOUBLE PRECISION,DIMENSION(NSTEPORIG,NNTYPE(CATOM),NCORD,3)::RB
DOUBLE PRECISION,DIMENSION(NSTEPORIG,NNTYPE(CATOM))::CORR

DOUBLE PRECISION,DIMENSION(2*NSTEP)::AAAA
INTEGER::IFOR,IBAC
DOUBLE PRECISION,DIMENSION(NDOS)::DUMMY1,DUMMY2
INTEGER::NSTEPII
IFOR=1
IBAC=-1


!OPEN(1505,FILE="ANGULAR_CORR")
!OPEN(1506,FILE="FANGULAR_CORR")
PRINT*,'I M IN ANGULAR 2020'
PRINT*,CATOM,SATOM
RTOPI=180/(4*ATAN(1.0))  !3.14
PI=4*ATAN(1.0)
TWOPI=8*ATAN(1.0)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
DO I=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
        NC1=0
        NK=0
        DO J=SUM(NNTYPE(1:SATOM-1))+1,SUM(NNTYPE(1:SATOM))   !,NNTYPE(CATOM)
                AA=POS(1 ,I,:)-POS(1 ,J,:)
                AA=MATMUL(AA,ISLAT)
                WHERE(AA.LT.-0.5)AA=AA+1
                WHERE(AA.GT.0.5)AA=AA-1
                RIJ=NORM2(MATMUL(AA,SLAT))
                IF(RIJ.GT.0.AND.RIJ.LE.BOND)THEN
                 NC1=NC1+1       !!!!!!!!CORDINATION1
                 IF(NC1.GT.NCORD)EXIT
                        NK=NK+1
                        PICK(I,NK,1)=I
                        PICK(I,NK,2)=J
                END IF
        END DO
END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
RB=0
DO IT=1,(IREF2-IREF1)+1 !,INTERVAL2
        K=0
        do I=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
        K=K+1
        DO J=1,NCORD
        RB(IT,K,J,:)=POS(IT,I,:)-POS(IT,PICK(I,J,2),:)
        RB(IT,K,J,:)=RB(IT,K,J,:)/(NORM2(RB(IT,K,J,:))**2)
RB(IT,K,J,1)=(RB(IT,K,J,2)*VEL(IT,PICK(I,J,2),3)) - (RB(IT,K,J,3)*VEL(IT,PICK(I,J,2),2))
RB(IT,K,J,2)=(RB(IT,K,J,3)*VEL(IT,PICK(I,J,2),1)) - (RB(IT,K,J,3)*VEL(IT,PICK(I,J,2),3))
RB(IT,K,J,3)=(RB(IT,K,J,1)*VEL(IT,PICK(I,J,2),2)) - (RB(IT,K,J,3)*VEL(IT,PICK(I,J,2),1))

        END DO
        END DO
END DO


CORR=0

NSTEPII=MIN(1000,NSTEPI)

        !$omp  parallel do 
DO I=1, NNTYPE(CATOM) 
PRINT*, 'ATOM NO',I,'has been done'
        DO DT=1,NSTEPORIG-OINT
                NSTEP1=NSTEPII
                NSTEP2=NSTEPII+DT
                IF(NSTEPI+DT.GT.NSTEPORIG)NSTEP1=NSTEPORIG-DT
                IF(NSTEPI+DT.GT.NSTEPORIG)NSTEP2=NSTEP1+DT
                CORR(DT,I)=SUM( (RB(1:NSTEP1:OINT,I,:,:)*RB(1+DT:NSTEP2:OINT,I,:,:)) ) ! + &
                TAO=NSTEPII
                IF(NSTEPI+DT.GT.NSTEPORIG)TAO=NSTEPORIG-DT
                CORR(DT,I)=CORR(DT,I)/REAL((TAO/OINT))
                !PRINT*,CORR(DT,I)
                !PAUSE
                END DO
      END DO
      !$omp end parallel do


DO DT=1,NSTEPORIG-OINT
WRITE(1505,1505)DT*DELT,SUM(CORR(DT,:))/(NCORD*NNTYPE(CATOM))
1505 FORMAT(F10.5,1000(F12.5,1X))
END DO
AAAA=0
DO IT=1,NSTEP !ORIG
IF(IT.LE.NSTEPORIG)AAAA(2*IT-1)= SUM(CORR(IT,:))  !RB(I,J,3)!CORR(1:NSTEP)  !REAL(FQT(II1,I))
IF(IT.GT.NSTEPORIG)AAAA(2*IT-1)= SUM(CORR(NSTEPORIG,:))  !RB(I,J,3)!CORR(1:NSTEP)  !REAL(FQT(II1,I))
END DO


DUMMY1=0
DUMMY2=0
!AAAA=0
CALL dfour1(AAAA,NSTEP,IFOR)
!AAAA=AAAA/NSTEP
!DUMMY1=AAAA(1:2*NDOS:2) !(1:NDOS,IJ,1)
!CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY2)
DO IT=1,NDOS !STEPORIG
OMEGA=4.136*REAL((IT-1)/(DELT*NSTEP))
WRITE(1506,1505) OMEGA ,AAAA(2*IT-1) !CORRT(IT)
!WRITE(1506,1505) OMEGA ,AAAA(2*IT-1),DUMMY2(IT)  !AAAA(2*IT-1) !CORRT(IT)
END DO


END SUBROUTINE



SUBROUTINE ANGULARDISPERSION !2021
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INCLUDE 'fftw3.f'
DOUBLE PRECISION,DIMENSION(3)::DDD
DOUBLE PRECISION::RXY
!INTEGER,DIMENSION(500,NCORD)::BDIST
DOUBLE PRECISION::RTOPI
INTEGER::JJJJ,JK,IR,JKK
DOUBLE PRECISION::D2,DR1,DR2
DOUBLE PRECISION::PROJ1,PROJ2,TWOPI
DOUBLE PRECISION,DIMENSION(3,3)::IAXIS
DOUBLE PRECISION::X,Y,Z,R
INTEGER::MATOM,JCu,ICAP
INTEGER::MAXCAP,JTAG !,NCORD
DOUBLE PRECISION::AVGBOND
INTEGER::J1
INTEGER,ALLOCATABLE,DIMENSION(:,:,:)::PICK
REAL::RIJ,RJK
INTEGER::NC1,NK
DOUBLE PRECISION,DIMENSION(3)::AA
DOUBLE PRECISION,DIMENSION(NSTEP,3)::VVEL
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::RBR,RB
COMPLEX*16,DIMENSION(NSTEP)::CORR
DOUBLE PRECISION,DIMENSION(2*NSTEP)::AAAA1, AAAA2,AAAA3
INTEGER::IFOR,IBAC,kk
INTEGER::IQV
DOUBLE PRECISION::PHASE11
DOUBLE PRECISION,DIMENSION(3)::KVEC !,KSTART,DIR1,QHKL
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::AFQT
integer,dimension(ncord)::plann
IFOR=1
IBAC=-1
!OPEN(1505,FILE="ANGULAR")
!OPEN(1506,FILE="FANGULAR")
ALLOCATE(RB(NSTEP,NCORD,3))
ALLOCATE(PICK(NATOM,NCORD,3))
ALLOCATE(AFQT(NSTEP,NCORD,3))
OPEN(9999,FILE='ANGDISP')

PRINT*,CATOM,SATOM
RTOPI=180/(4*ATAN(1.0))  !3.14
PI=4*ATAN(1.0)
TWOPI=8*ATAN(1.0)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
PRINT*,NCORD,BOND
DO I=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
        NC1=0
        NK=0
        DO J=SUM(NNTYPE(1:SATOM-1))+1,SUM(NNTYPE(1:SATOM))   !,NNTYPE(CATOM)
                AA=POS(1 ,I,:)-POS(1 ,J,:)
                AA=MATMUL(AA,ISLAT)
                WHERE(AA.LT.-0.5)AA=AA+1
                WHERE(AA.GT.0.5)AA=AA-1
                RIJ=NORM2(MATMUL(AA,SLAT))
                IF(RIJ.LE.BOND)THEN
                 NC1= NC1+1       !!!!!!!!CORDINATION1
                 NK = NK+1
                 IF(NC1.GT.NCORD)EXIT
                        PICK(I,NK,1)=I
                        PICK(I,NK,2)=J
!                        PRINT*,PICK(I,NK,2) ,NK
                END IF
        END DO
!        IF(ANY(PICK(I,1:NCORD,2).LT.1))PRINT*,PICK(I,1:NCORD,2), I
END DO

PRINT*,'INDEXINGDONE'
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
OPEN(123456,FILE="KVALUES")

DO IQV=1,10000
READ(123456,*,END=99)KVEC
PRINT*,KVEC 
PRINT*,'I M IN ANGULAR DSPERSION'
  CORR=0
        DO I=SUM(NNTYPE(1:CATOM-1))+1,SUM(NNTYPE(1:CATOM))   !,NNTYPE(CATOM)
        AFQT=0
        RB=0
        PHASE11=DOT_PRODUCT(KVEC,POSSTART(I,:))
        DO J=1,NCORD
!                        DO IT=1,(IREF2-IREF1)+1   !,INTERVAL2
                        RB(:,J,:)=POS(:,I,:)-POS(:,PICK(I,J,2),:)
                        RB(:,J,1)=RB(:,J,1)/(RB(:,J,1)*RB(:,J,1) + RB(:,J,2)*RB(:,J,2) + RB(:,J,3)*RB(:,J,3))
                        RB(:,J,2)=RB(:,J,2)/(RB(:,J,1)*RB(:,J,1) + RB(:,J,2)*RB(:,J,2) + RB(:,J,3)*RB(:,J,3))
                        RB(:,J,3)=RB(:,J,3)/(RB(:,J,1)*RB(:,J,1) + RB(:,J,2)*RB(:,J,2) + RB(:,J,3)*RB(:,J,3))
                        VVEL(:,:)=VEL(:,PICK(I,J,2),:)-VEL(:,I,:) 
                        RB(:,J,1)=RB(:,J,2)*VVEL(:,3) - RB(:,J,3)*VVEL(:,2) 
                        RB(:,J,2)=RB(:,J,3)*VVEL(:,1) - RB(:,J,1)*VVEL(:,3) 
                        RB(:,J,3)=RB(:,J,1)*VVEL(:,2) - RB(:,J,2)*VVEL(:,1) 
                        !RB(NSTEP,J,:)=RB(NSTEP-1,J,:)
                        !PRINT*,RB(:,J,1) !AFQT !CORR
                        AFQT(:,J,:)= RB(:,J,:)*CMPLX(COS(PHASE11),SIN(PHASE11)) 
                        AFQT(NSTEP,J,:)= AFQT(NSTEP-1,J,:) !RB(:,J,:)*CMPLX(COS(PHASE11),SIN(PHASE11)) 
 !                       END DO
                        call dfftw_plan_dft_1d(plann(j),NSTEP,AFQT(:,j,1),AFQT(:,j,1),IFOR,FFTW_ESTIMATE)
                        call dfftw_execute_dft(plann(j), AFQT(:,j,1),AFQT(:,j,1))
                        call dfftw_destroy_plan(plann(j))
                        call dfftw_plan_dft_1d(plann(j),NSTEP,AFQT(:,j,2),AFQT(:,j,2),IFOR,FFTW_ESTIMATE)
                        call dfftw_execute_dft(plann(j), AFQT(:,j,2),AFQT(:,j,2))
                        call dfftw_destroy_plan(plann(j))
                        call dfftw_plan_dft_1d(plann(j),NSTEP,AFQT(:,j,3),AFQT(:,j,3),IFOR,FFTW_ESTIMATE)
                        call dfftw_execute_dft(plann(j), AFQT(:,j,3),AFQT(:,j,3))
                        call dfftw_destroy_plan(plann(j))
                        AFQT(:,j,:)=AFQT(:,J,:)/NSTEP
!                        CORRT(1:NSTEP)=CORRT+ CORR*CONJG(CORR) 
                        CORR=CORR+  AFQT(:,j,1)*CONJG(AFQT(:,J,1)) + AFQT(:,j,2)*CONJG(AFQT(:,J,2)) +     AFQT(:,j,3)*CONJG(AFQT(:,J,3)) 
             !           PAUSE
        END DO
        END DO

        CORR=CORR/(NNTYPE(CATOM)*NCORD)

!######  Fourier Transform!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!VACF!!!!!!!!!!!!!!!!!!
        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        WRITE(9999,15) OMEGA, CORR(DT)
        END DO
        15 FORMAT(F15.4,1003E20.2)
        
        
        END DO
        99 CONTINUE
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
END SUBROUTINE




!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
SUBROUTINE VONHOVE_PAIRADV(IR1,IR2)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,IBAC,IFOR,II1
INTEGER::M
INTEGER::NSTEPORIG2
DOUBLE PRECISION::POSINT
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::GRRT
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::DGRRT
DOUBLE PRECISION::RCUT,R1,R2 !,DR
INTEGER::IREF !,NRPOINTS
DOUBLE PRECISION::DRR
DOUBLE PRECISION::DR1
INTEGER::NBIN  !,NSTEPIV,NSTEPINT
!INTEGER,ALLOCATABLE,DIMENSION(:)::NNBIN
!DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DR
INTEGER,ALLOCATABLE,DIMENSION(:,:)::NNBIN
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DR
INTEGER::OFFSET
INTEGER::IIII2
INTEGER::IR1,IR2
character*14::AAAA
DOUBLE PRECISION::DV,AREA

!$ call omp_set_num_threads(num_threads)
WRITE(AAAA,'("VANHOVE_PAIR",I1.1,I1.1)')IR1,IR2
OPEN(109,FILE=AAAA)

GRRT=0
RCUT=0
DRR=0.01
!NRPOINTS=500
PRINT*,'GIVE THE No. of ORIGIN FOR VON HOVE',NSTEPIV
PRINT*,'GIVE THE No. of TIME STEP INTREVALS OVER WHICH THE VON HOVE WILL BE PRINTED INTERVALS',NSTEPINT
!PRINT*,'GIVE THE No. of ORIGIN FOR VON HOVE'
!READ*,NSTEPIV
!PRINT*,'GIVE THE No. of TIME STEP INTREVALS OVER WHICH THE VON HOVE WILL BE PRINTED INTERVALS'
!READ*,NSTEPINT

ALLOCATE(GRRT(0:100,0:NRPOINTS))
!ALLOCATE(DR(NSTEP))
!ALLOCATE(NNBIN(NSTEP))
!ALLOCATE(DGRRT(NNTYPE(IREF),0:NRPOINTS))
ALLOCATE(DR(0:100,NSTEPIV,3))
ALLOCATE(NNBIN(0:100,NSTEPIV))

OFFSET=SUM(NNTYPE(1:IREF-1))
NSTEPORIG2=IREF2-IREF1+1
PRINT*,NSTEPORIG2
PRINT*, 'THE DISTINCT VON HOVE CALCULATION WILL BE PERFORMED  AVERAGED FOR',NSTEPIV,'LENGHT'
PRINT*,AVGSLAT
PRINT*,AVGISLAT

GRRT=0
NSTEP1=NSTEPIV
DO IIII2=SUM(NNTYPE(1:IR1-1))+1,SUM(NNTYPE(1:IR1))
DO IIII=SUM(NNTYPE(1:IR2-1))+1,SUM(NNTYPE(1:IR2))
IF(IIII2.NE.IIII)THEN
!$omp parallel do private (IK,NSTEP2)
DO DT=1,NSTEP,NSTEPINT

NSTEP2=NSTEPIV+DT
IK=DT/NSTEPINT
!PRINT*,IK
IF(IK.LE.100)THEN
NNBIN(IK,:)=0
IF(NSTEP2.LT.NSTEPORIG)THEN
 DR(IK,1:NSTEPIV,:)=POS(1:NSTEP1,IIII2,:)-POS(DT:NSTEP2,IIII,:)

!DR(IK,1:NSTEPIV,1)=sum(DR(IK,1:NSTEPIV,:)* spread(AVGISLAT(:,1),1,NSTEPIV),DIM=2) !(AVGISLAT(1,:))
!DR(IK,1:NSTEPIV,2)=sum(DR(IK,1:NSTEPIV,:)* spread(AVGISLAT(:,2),1,NSTEPIV),DIM=2) !(AVGISLAT(1,:))
!DR(IK,1:NSTEPIV,3)=sum(DR(IK,1:NSTEPIV,:)* spread(AVGISLAT(:,3),1,NSTEPIV),DIM=2) !(AVGISLAT(1,:))


 DR(IK,1:NSTEPIV,:)=MATMUL(DR(IK,1:NSTEPIV,:),AVGISLAT)
 !PRINT*,DR(IK,:,:) !~,DIM=2) 
 WHERE(DR(IK,:,:).LE.-0.5)DR(IK,:,:)=DR(IK,:,:)+1
 WHERE(DR(IK,:,:).GE.0.5)DR(IK,:,:)=DR(IK,:,:)-1
 DR(IK,1:NSTEPIV,:)=MATMUL(DR(IK,1:NSTEPIV,:),AVGSLAT)
 NNBIN(IK,:)=INT(NORM2(DR(IK,:,:),DIM=2)/DRR)
! PRINT*,DR(IK,:,:) !~,DIM=2) 
! PRINT*,NNBIN(IK,:)
! PAUSE
 WHERE(NNBIN(IK,:).LT.NRPOINTS)GRRT(IK,NNBIN(IK,1:NSTEPIV))=GRRT(IK,NNBIN(IK,1:NSTEPIV))+1
! GRRT(IK,NNBIN(IK,1:NSTEPIV))=GRRT(IK,NNBIN(IK,1:NSTEPIV))+1
 END IF
END IF
END DO
!$omp end parallel do
END IF
END DO
END DO


GRRT=GRRT/NSTEPIV

IK=NSTEP/NSTEPINT
IF(IK.GE.100)IK=100
!PAUSE
DO K=0,NRPOINTS
R1=(K)*DRR 
R2=RCUT+(K+1)*DRR 
   RM=(R1+R2)*0.5
   AREA=4.0*PI*(RM**2)
   DV=AREA*DRR

WRITE(109,109)R1,GRRT(0:IK,K)/DV  !/(NNTYPE(IR1)*NNTYPE(IR2)*DV)
!WRITE(109,109)R1,GRRT(1:NSTEP:NSTEPINT,K)
109 FORMAT(F10.5,10000(E12.5,1x))
END DO
DEALLOCATE(GRRT,DR,NNBIN)
END SUBROUTINE
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

SUBROUTINE IIFQT4444(IQQQQ,QHKL)   !!!!!!!!!!THIS IS with velcoity projection
use omp_lib
USE VARIABLES1, only :ICARTESIAN,PI,AVGISLAT,POSSTART,MASS,VEL,NSTEPORIG,ICOH,IBROAD,FWHM0,FWHM1,NTYP,NSTEP,NATOM,DELT,ICUT,NNTYPE
IMPLICIT NONE
INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::AFQT!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::tempd,cout !,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::CFFQTTYP !,SQWB
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1,QHKL
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
REAL,DIMENSION(NSTEP)::PHASE1
DOUBLE PRECISION,DIMENSION(NATOM)::PHASE11
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::II1,I1,DT1,III
DOUBLE PRECISION::EE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK !,tempd
INTEGER::ITYPPP,JTYPPP
INTEGER::IQQQQ,NNN2
CHARACTER::AA*10
INTEGER::NTYP2,NTYP3
INTEGER::IJ1,IJ2
INTEGER::IQTCAL
integer,allocatable,dimension(:)::plan
integer,dimension(natom)::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMY1,DUMMY5
INTEGER::DT,IT
REAL::OMEGA
INTEGER::I,J
integer,dimension(9)::desca,descb,descc
integer::ia,ja,ib,jb,ic,jc,m,n,k
integer,dimension(1,NATOM)::lda,ldb,ldc
real::alpha,beta
m=natom
n=natom
k=3
alpha=1
beta=0
PRINT*,'I M IN SED4444'

IF(ICUT==1)WRITE(AA,'("SEDTOT",I4.4)')IQQQQ
IF(ICUT==1)OPEN(IQQQQ,FILE=AA)
OPEN(9999,FILE='SEDTOTAL',ACCESS='APPEND')
PRINT*, QHKL
ALLOCATE(AFQT(1:NSTEP,NATOM,3))
ALLOCATE(CFFQTTYP(1:NSTEP,NTYP))
ALLOCATE(DUMMY1(NSTEP),DUMMY5(NSTEP))
allocate(plan(NATOM))
AFQT=0
CFFQTTYP=0
IFOR= 1
IBAC=-1
NQ=1
ALLOCATE(QQ(NQ,3),QK(NQ,3))
        IQ=1
        CFFQTTYP=0
        QQ(IQ,:)=QHKL    !KLIST(IQ,:) !VEC
        IF(ICARTESIAN==1)THEN
        KVEC=QHKL        !KLIST(IQ,:)
        ELSE
        !KVEC=2.0*PI*MATMUL(QHKL,AVGISLAT)        !CHANGED AVGISLAT TO ISLAT
        KVEC=2.0*PI*MATMUL(AVGISLAT,QHKL )        !CHANGED AVGISLAT TO ISLAT
        END IF
        QK(IQ,:)=KVEC
        CFFQTTYP=0
        AFQT=0
        DO I=1,NATOM !SUM(NNTYPE(1:J-1))+1,SUM(NNTYPE(1:J))  
        PHASE11(I)=DOT_PRODUCT(KVEC,POSSTART(I,:))
        AFQT(:,I,:)=SQRT(MASS(I))*VEL(:,I,:)*CMPLX(COS(PHASE11(I)),SIN(PHASE11(I)))
        call dfftw_plan_dft_1d(plann(i),NSTEP,AFQT(:,I,1),AFQT(:,I,1),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann(i), AFQT(:,I,1),AFQT(:,I,1))
        call dfftw_destroy_plan(plann(i))
        call dfftw_plan_dft_1d(plann(i),NSTEP,AFQT(:,I,2),AFQT(:,I,2),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann(i), AFQT(:,I,2),AFQT(:,I,2))
        call dfftw_destroy_plan(plann(i))
        call dfftw_plan_dft_1d(plann(i),NSTEP,AFQT(:,I,3),AFQT(:,I,3),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann(i), AFQT(:,I,3),AFQT(:,I,3))
        call dfftw_destroy_plan(plann(i))
        AFQT(:,I,:)=AFQT(:,I,:)/REAL(NSTEPORIG)
        END DO
     

         DO J=1,NTYP
         PRINT*,SUM(NNTYPE(1:J-1))+1,SUM(NNTYPE(1:J))
         !$omp parallel do
         DO IT=1,NSTEP
         !CFFQTTYP(IT,J)= SUM(AFQT(IT,SUM(NNTYPE(1:J-1))+1:SUM(NNTYPE(1:J)),:)*CONJG(AFQT(IT,SUM(NNTYPE(1:J-1))+1:SUM(NNTYPE(1:J)),:)) )
         CFFQTTYP(IT,J)=SUM( SUM(AFQT(IT,SUM(NNTYPE(1:J-1))+1:SUM(NNTYPE(1:J)),:),DIM=1)*CONJG(SUM(AFQT(IT,SUM(NNTYPE(1:J-1))+1:SUM(NNTYPE(1:J)),:),DIM=1) ) )
         END DO
         !$omp end parallel do
        
 
          DUMMY1=  REAL(CFFQTTYP(:,J)) !      SUM(DUMMY2(1:NQ,1,:),DIM=1 ) /NQ
          IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY5)
          IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY5)
          IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY5)
          WHERE(DUMMY5.LE.1.0E-10)DUMMY5=0
          CFFQTTYP(:,J)=DUMMY5
          END DO


        IF(ICUT==1)THEN
        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        WRITE(IQQQQ,15) OMEGA, REAL(CFFQTTYP(DT,:))
        END DO
        END IF
        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        WRITE(9999,15) OMEGA, REAL(CFFQTTYP(DT,:)),REAL( SUM(AFQT(IT,:,:)*CONJG(AFQT(IT,:,:))))
        END DO

        17 FORMAT(A12,2X,3F10.5)
        15 FORMAT(F15.4,1003E20.2)
        170 FORMAT(A12,100(3X,3F6.2,3X))
        172 FORMAT(A12,<NQ>(3X,3F6.2,3X),6X,'AVG OVER Q')
        171 FORMAT(A3,12X,<NTYP>(8X,'avg',A3,10X) )
        173 FORMAT(A3,12X,<NTYP2>(8X,'avg',2A3,10X) )
        IF(ICUT==1)CLOSE(IQQQQ)
close(9999)
DEALLOCATE(DUMMY1,DUMMY5)
DEALLOCATE(AFQT)
END SUBROUTINE

SUBROUTINE IIFQT33U(IQQQQ)  !Neutron Unweighted 
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::FQT,FFQTTYP!,SQWB
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::CFFQTTYP !,SQWB
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
REAL,DIMENSION(NSTEP)::PHASE1
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::II1,I1,DT1,III
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:,:)::DUMMY2,DUMMY4
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMYT
DOUBLE PRECISION::EE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK
INTEGER::ITYPPP,JTYPPP
INTEGER::IQQQQ,NNN2
CHARACTER::AA*9
INTEGER::NTYP2
INTEGER::IJ1,IJ2
INTEGER::IQTCAL
integer,allocatable,dimension(:)::plan
integer::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
INTEGER::KTYPPP
INTEGER,ALLOCATABLE,DIMENSION(:,:)::IND2
IQTCAL=0         !!!!DO  NOT CALCLATE FQT
NTYP2=NTYP*(NTYP+1)/2
ALLOCATE(IND2(NTYP2,2))
print*,num_threads

PRINT*,NTYP2
WRITE(AA,'("CSQWTOT",I2.2)')IQQQQ
OPEN(170,FILE=AA)
WRITE(AA,'("ISQWTOT",I2.2)')IQQQQ
OPEN(180,FILE=AA)
IF(IQTCAL==1)WRITE(AA,'("CIQTTOT",I2.2)')IQQQQ
IF(IQTCAL==1)OPEN(190,FILE=AA)
IF(IQTCAL==1)WRITE(AA,'("IIQTTOT",I2.2)')IQQQQ
IF(IQTCAL==1)OPEN(200,FILE=AA)
!OPEN(17,FILE="CSQ")
!OPEN(18,FILE="ISQ")
IF(IQTCAL==1) OPEN(19,FILE="CIQ")
IF(IQTCAL==1)OPEN(20,FILE="IIQ")
PRINT*,'I AM IN FQT33'
ALLOCATE(FQT(1:NSTEP,NATOM))
ALLOCATE(FFQTTYP(1:NSTEP,NTYP))
ALLOCATE(CFFQTTYP(1:NSTEP,NTYP,NTYP))
allocate(plan(NATOM))
FQT=0
FFQTTYP=0
CFFQTTYP=0
IFOR= 1
IBAC=-1
PRINT*,AVGISLAT(1,:)
PRINT*,AVGISLAT(2,:)
PRINT*,AVGISLAT(3,:)
PRINT*,NTYP
IF(ILIST.NE.3)THEN
WRITE(AA,'("KKLIST",I2.2)')IQQQQ
OPEN(44,FILE=AA)
I=0
DO  
I=I+1 
READ(44,*,END=100)KLIST(I,:)
END DO
100 CONTINUE
NQ=I-1
I=0
PRINT*,'NQ',NQ
ALLOCATE(QQ(NQ,3),QK(NQ,3))
!ALLOCATE(DUMMY2(NQ,NTYP2+1,NSTEP),DUMMY4(NQ,NTYP2+1,NSTEP))
END IF

IF(ILIST.EQ.3)THEN
NQ=IQQQQ 
PRINT*,KLIST(NQ,:)
ALLOCATE(QQ(NQ,3),QK(NQ,3))
!ALLOCATE(DUMMY2(NQ,NTYP2+1,NSTEP),DUMMY4(NQ,NTYP2+1,NSTEP))
END IF
!ALLOCATE(DUMMYT(NSTEP),KSELF(NTYP))
PRINT*,'NSTEP',NSTEP
	FFQTTYP=0
	CFFQTTYP=0

        K=0
        DO I=1,NTYP
        DO J=I,NTYP
        K=K+1
        IND2(K,1)=I
        IND2(K,2)=J
        ENDDO
        ENDDO
        
        
        
        

DO IQ=1,NQ
        PRINT*,'IQ=',IQ
	QQ(IQ,:)=KLIST(IQ,:) !VEC
	!IF(ICARTESIAN==1)THEN
        !KVEC=KLIST(IQ,:)
        !ELSE
        !KVEC=2.0*PI*MATMUL(AVGISLAT,KLIST(IQ,:) )        !CHANGED AVGISLAT TO ISLAT
        !END IF

        KVEC=2.0*PI*MATMUL(AVGISLAT,KLIST(IQ,:) )        !CHANGED AVGISLAT TO ISLAT
        !KVEC=2.0*PI*MATMUL(KLIST(IQ,:),AVGISLAT)        !CHANGED AVGISLAT TO ISLAT
!	QK(IQ,:)=KVEC
        DO I=1,NATOM
	!$omp parallel do
        DO IT=1,NSTEPORIG  
        PHASE1(IT)=DOT_PRODUCT(KVEC,POS(IT,I,:))
        FQT(IT,I)=CMPLX(COS(PHASE1(IT)),SIN(PHASE1(IT)))
        END DO
	!$omp end parallel do
        call dfftw_plan_dft_1d(plann,NSTEP,FQT(:,I),FQT(:,I),IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plann, FQT(:,I),FQT(:,I))
        call dfftw_destroy_plan(plann)
        FQT(:,I)=FQT(:,I)/REAL(NSTEPORIG)
        END DO

        PRINT*,'I AM IN INCOHERENT33'
        DO ITYPPP=1,NTYP
        FFQTTYP(1:NSTEP,ITYPPP)=FFQTTYP(1:NSTEP,ITYPPP) + SUM(FQT(1:NSTEP, SUM(NNTYPE(1:ITYPPP-1))+1 : SUM(NNTYPE(1:ITYPPP))) * CONJG(FQT(1:NSTEP, SUM(NNTYPE(1:ITYPPP-1))+1 : SUM(NNTYPE(1:ITYPPP)))),DIM=2 )
        !FFQTTYP(1:NSTEP,ITYPPP)=FFQTTYP(1:NSTEP,ITYPPP) + IBBT2(ITYPPP)*IBBT2(ITYPPP)*  SUM(FQT(1:NSTEP, SUM(NNTYPE(1:ITYPPP-1))+1 : SUM(NNTYPE(1:ITYPPP))) * CONJG(FQT(1:NSTEP, SUM(NNTYPE(1:ITYPPP-1))+1 : SUM(NNTYPE(1:ITYPPP)))),DIM=2 )
        END DO
	!DO DT=1,NSTEP
	!WRITE(18,15)REAL(DT)*DELT,REAL(FFQTTYP(DT,1:NTYP))  ,SUM(REAL(FFQTTYP(DT,:))) , SUM(AIMAG(FFQTTYP(DT,:))) !/REAL(FFQTTYP(1,:)) !,SUM(REAL(FFQTTYP(DT,1:NTYP)))/SUM(REAL(FFQTTYP(1,1:NTYP))) !NATOM
	!END DO

	IF(IQTCAL==1)THEN
	DO I=1,NTYP
        call dfftw_plan_dft_1d(plan(i),NSTEP,FFQTTYP(:,I),FFQTTYP(:,I),IBAC,FFTW_ESTIMATE)
        call dfftw_execute_dft(plan(i), FFQTTYP(:,I),FFQTTYP(:,I))
        call dfftw_destroy_plan(plan(i))
        FFQTTYP(:,I)=FFQTTYP(:,I)/REAL(NSTEPORIG)
	END DO
	DO DT=1,NSTEP	
	WRITE(20,15)REAL(DT)*DELT,REAL(FFQTTYP(DT,1:NTYP)) !/(REAL(FFQTTYP(1,:))) !,(SUM(REAL(FFQT(DT,:))))/SUM(REAL(FFQT(1,:)))
	END DO
	END IF


!!!!!!!!!!!!!!!!!!!!!!!!!!!!!COHERENT CASE!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
	PRINT*,'I AM IN COHERENT33'


        !ITYPPP=1
        !JTYPPP=0
        !$omp parallel do 
        DO KTYPPP=1,NTYP2
        !JTYPPP=JTYPPP+1
        !IF(JTYPPP.GT.NTYP)THEN
        !ITYPPP=ITYPPP+1
        !JTYPPP=ITYPPP
        !ITYPPP=IND2(KTYPPP,1)
        !JTYPPP=IND2(KTYPPP,2)
        PRINT*,IND2(KTYPPP,1),IND2(KTYPPP,2) !ITYPPP,JTYPPP
        !DO ITYPPP=1,NTYP
        !DO JTYPPP=1,NTYP
        DO I=SUM(NNTYPE(1:IND2(KTYPPP,1)-1))+1,SUM(NNTYPE(1:IND2(KTYPPP,1))) !NATOM
        !DO J=SUM(NNTYPE(1:JTYPPP-1))+1,SUM(NNTYPE(1:JTYPPP)) !NATOM
        !CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP)=CFFQTTYP(1:NSTEP,ITYPPP,JTYPPP) +   FQT(1:NSTEP,I) * CONJG(FQT(1:NSTEP, J) )
        !CFFQTTYP(1:NSTEP,IND2(KTYPPP,1),IND2(KTYPPP,2))=CFFQTTYP(1:NSTEP,IND2(KTYPPP,1),IND2(KTYPPP,2)) +        BBT(IND2(KTYPPP,1))*BBT(IND2(KTYPPP,2))* FQT(1:NSTEP,I) *CONJG(SUM(FQT(1:NSTEP,SUM(NNTYPE(1:IND2(KTYPPP,2)-1))+1 : SUM(NNTYPE(1:IND2(KTYPPP,2)))),DIM=2) )
        CFFQTTYP(1:NSTEP,IND2(KTYPPP,1),IND2(KTYPPP,2))=CFFQTTYP(1:NSTEP,IND2(KTYPPP,1),IND2(KTYPPP,2)) +  FQT(1:NSTEP,I) *CONJG(SUM(FQT(1:NSTEP,SUM(NNTYPE(1:IND2(KTYPPP,2)-1))+1 : SUM(NNTYPE(1:IND2(KTYPPP,2)))),DIM=2) )
	!END DO
        END DO
        !END DO
        !END DO
        END DO
	!$omp end parallel do

        DO I=1,NTYP
        DO J=I,NTYP        
        
        IF(i.ne.j)CFFQTTYP(1:NSTEP,J,I)=CFFQTTYP(1:NSTEP,I,J)
        END DO
        END DO
        
        
        
        
        
        
        
        
        
        
        
        !	DO DT=1,NSTEP
!        WRITE(17,15) REAL(DT)*DELT, ( ( REAL(CFFQTTYP(DT,IJ1,IJ2)) , IJ2=IJ1,NTYP ),IJ1=1,NTYP) ! ,SUM(REAL(CFFQTTYP(DT,:,:)))/SUM(REAL(CFFQTTYP(1,:,:))) !NATOM
!	END DO

        IF( IQTCAL==1)THEN
!	!$omp parallel do
	DO I=1,NTYP  !*(NTYP+1)/2
	DO J=I,NTYP  !*(NTYP+1)/2
        call dfftw_plan_dft_1d(plan(j),NSTEP,CFFQTTYP(:,I,J),CFFQTTYP(:,I,J),IBAC,FFTW_ESTIMATE)
	call dfftw_execute_dft(plan(j), CFFQTTYP(:,I,J),CFFQTTYP(:,I,J))
	call dfftw_destroy_plan(plan(j))
	CFFQTTYP(:,I,J)=CFFQTTYP(:,I,J)/REAL(NSTEPORIG) !CMPLX(AAA(I,1:2*NSTEP:2),AAA(I,2:2*NSTEP:2))
	END DO
        END DO
!	!$omp end parallel do
	DO DT=1,NSTEP	
        WRITE(19,15) REAL(DT)*DELT, ( ( REAL(CFFQTTYP(DT,IJ1,IJ2)) , IJ1=1,NTYP ),IJ2=IJ1,NTYP) ! ,SUM(REAL(CFFQTTYP(DT,:,:)))/SUM(REAL(CFFQTTYP(1,:,:))) !NATOM
	END DO
        END IF

END DO    !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!QLOOP ENDS
!REWIND(17)
!REWIND(18)
REWIND(19)
REWIND(20)

		DO DT=1,NSTEP
		OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
		WRITE(180,15)OMEGA,REAL(FFQTTYP(DT,1:NTYP)),REAL(SUM(FFQTTYP(DT,:))) !   ( SUM(DUMMY2(1:NQ,ITYP,DT)) / NQ   ,ITYP=1,NTYP+1) !,SUM(DUMMY2(1:NQ,:,DT))/NQ
		END DO

	DO DT=1,NSTEP
	OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
	WRITE(170,15)OMEGA,( ( REAL(CFFQTTYP(DT,IJ1,IJ2)) , IJ2=IJ1,NTYP ),IJ1=1,NTYP) ,REAL(SUM(CFFQTTYP(DT,:,:))) !                  (  SUM(DUMMY2(1:NQ,ITYP,DT) )/NQ,ITYP=1,NTYP2),DUMMYT(DT) 
	END DO
	17 FORMAT(A12,2X,3F10.5)
        15 FORMAT(F15.4,1003E20.4)
	170 FORMAT(A12,100(3X,3F6.2,3X))
	172 FORMAT(A12,<NQ>(3X,3F6.2,3X),6X,'AVG OVER Q')
	171 FORMAT(A3,12X,<NTYP>(8X,'avg',A3,10X) )
	173 FORMAT(A3,12X,<NTYP2>(8X,'avg',2A3,10X) )
!CLOSE(170)
!CLOSE(180)
CLOSE(190)
CLOSE(200)
!CLOSE(17)
!CLOSE(18)
CLOSE(19)
CLOSE(20)
CLOSE(44)
!DEALLOCATE(FQT,FFQTTYP,CFFQTTYP,DUMMY1,DUMMY2,DUMMY3,DUMMY4, AAA)
!DEALLOCATE(FQT,FFQT,AAA)
END SUBROUTINE


SUBROUTINE GRRFN5LAMMPS
use omp_lib
USE VARIABLES1
IMPLICIT NONE
!DOUBLE PRECISION,DIMENSION(NATOM,3)::POSF
DOUBLE PRECISION,DIMENSION(NATOm,3)::AA
DOUBLE PRECISION::MODA
!DOUBLE PRECISION,DIMENSION(NATOM,NATOM)::GRR
DOUBLE PRECISION,DIMENSION(0:1000,NTYP,NTYP)::GRRT
DOUBLE PRECISION::R1,R2
INTEGER::IDR
INTEGER::K1,K2,K3,K4
!DOUBLE PRECISION,DIMENSION(NATOM,27,3)::SPOS
INTEGER::NS,INS,NX,NY,NZ,I1
DOUBLE PRECISION::DV,AREA,XD,YD,ZD
DOUBLE PRECISION,DIMENSION(NATOM)::AMODA
INTEGER,DIMENSION(NATOM)::NRI
INTEGER::JTYP
AA=0
PRINT*, "I M IN GRRFN5 LAMPPS2"
PRINT*,IT
WRITE(111,*)'# TIME=IT,LL',IT,LL
GRRT=0

DO ITYP=1,NTYP
DO JTYP=ITYP,NTYP
   DO I=SUM(NNTYPE(1:ITYP-1))+1, SUM(NNTYPE(1:ITYP))
        NRI=0
!!!!!parallel  default(none) shared(GRRT), private(AA,AMODA,NRI) &
!!!!!!OMP REDUCTION(+:GRRT)
        !$omp do
        DO J=SUM(NNTYPE(1:JTYP-1))+1, SUM(NNTYPE(1:JTYP))
            IF(I.NE.J)THEN
            AA(J,:)= RR1(I,:)-RR1(J,:)  
	    WHERE(AA(J,:).LT.-0.5)AA(J,:)=AA(J,:)+1
	    WHERE(AA(J,:).gT.0.5)AA(J,:)=AA(J,:)-1
            !AA(J,:)=MATMUL(TRANSPOSE(SLAT),AA(J,:))                       !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!CHECK
            AA(J,:)=MATMUL(AA(J,:),SLAT)                       !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!CHECK
            AMODA(J)=NORM2(AA(J,:))
            NRI(J)=INT(AMODA(J)/DELR)
!            WHERE(NRI(J).LE.1000)GRRT(NRI(J),ITYP,JTYP)= GRRT(NRI(J),ITYP,JTYP) + 1
!OMP ATOMIC
IF(NRI(J).LE.1000) GRRT(NRI(J),ITYP,JTYP)= GRRT(NRI(J),ITYP,JTYP) + 1 ! SUM(GRR(K1:K2,K3:K4))
!            GRRT(NRI(J),ITYP,JTYP)= GRRT(NRI(J),ITYP,JTYP) + 1 ! SUM(GRR(K1:K2,K3:K4))
            END IF
        END DO
!$omp end do
  END DO            
END DO
END DO


   DO I=1,NTYP
      DO J=I,NTYP
!        K1=SUM(NNTYPE(1:I-1))+1
!        K2=SUM(NNTYPE(1:I))
!        K3=SUM(NNTYPE(1:J-1))+1
!        K4=SUM(NNTYPE(1:J))
!        GRRT(:,I,J)=GRRT(:,I,J)/NNTYPE(I)   !((K2-k1+1))
        GRRT(:,J,I)=GRRT(:,I,J) !/NNTYPE(I)   !((K2-k1+1))
        END DO
   END DO

GRRT=GRRT/NATOM   


RHO0=NATOM/VOLUME
DO IDR=1,1000 !NR
   R1=((IDR-1)*DELR) !+R0
   R2=((IDR)*DELR) !+R0
   RM=(R1+R2)*0.5
   AREA=4.0*PI*(RM**2)
   !DV=AREA*DELR
   GRRT(IDR,:,:)=GRRT(IDR,:,:)/DV
   
!   GRTOTAL(IDR)=GRTOTAL(IDR)/(DV*NATOM)
!   WRITE(111,11)RM ,((GRRT(IDR,I,J),J=I,NTYP),I=1,NTYP) !,GRTOTAL(IDR) !,SUM(GRRT(IDR,:,:))
   11 FORMAT(F6.3,2x,100F8.4)
   101 format (F4.1,100I3)
END DO

!!!!!!!!!!!!!!!!!!
!DO IDR=1,1000 !NR
   DO I=1,NTYP
      DO J=1,NTYP
      GRRTAVG(:,I,J)=GRRTAVG(:,I,J)+GRRT(:,I,J)
      !GRRTAVGXRAY(:,I,J)=GRRTAVG(:,I,J)*ZELE(I)*ZELE(J)  !+GRRT(:,I,J)
      GRRTAVGXRAY(:,I,J)=GRRTAVG(:,I,J)*XRAY(I)*XRAY(J)  !+GRRT(:,I,J)
      GRRTAVGNEUTRON(:,I,J)=GRRTAVG(:,I,J)*BBT(I)*BBT(J)  !+GRRT(:,I,J)
      END DO
   END DO
!     GAVG(IDR)=GAVG(IDR)+GRTOTAL(IDR)
!END DO


!RMAX=INT((GRCUT-R0)/DELR)
!ASTATUS=ANY(GRTOTAL(1:RMAX).GT.0,DIM = 1)
!PRINT*,RMAX,ASTATUS



!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!
!IF(IT.EQ.IREF2-IREF1)THEN
!DO IDR=1,NR
!WRITE(83,83)R0+(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(LL),J=I,NTYP),I=1,NTYP),GAVG(IDR)/REAL(LL)
!WRITE(83,83)R0+(2.0*IDR+1)*DELR*0.5 ,((GRRTAVG(IDR,I,J)/REAL(IPOINTS),J=I,NTYP),I=1,NTYP),GAVG(IDR)/REAL(IPOINTS)
!END DO
!END IF
!83 FORMAT(F6.3,2x,100F8.4)
END SUBROUTINE

SUBROUTINE MSD5
USE VARIABLES1
use omp_lib
IMPLICIT NONE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::MSDX,MSDY,MSDZ,MSDGX,MSDGY,MSDGZ,MMSDX,MMSDY,MMSDZ
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::CMMSDX,CMMSDY,CMMSDZ
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::TCMMSDX,TCMMSDY,TCMMSDZ
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::TTCMMSDX,TTCMMSDY,TTCMMSDZ
INTEGER::I1,IBAC,IFOR,II1
INTEGER::M
INTEGER::NSTEPORIG2
DOUBLE PRECISION::POSINT !,CORR2
DOUBLE PRECISION,DIMENSION(NATOM,3)::CORR
DOUBLE PRECISION,DIMENSION(NATOM)::CORR3,CORR1,CORR2
DOUBLE PRECISION,ALLOCAtaBle,DIMENSION(:,:,:)::UU
ALLOCATE(MSDX(NSTEPORIG,NATOM))
ALLOCATE(MSDY(NSTEPORIG,NATOM))
ALLOCATE(MSDZ(NSTEPORIG,NATOM))
ALLOCATE(MSDGX(NSTEPORIG,NTYP))
ALLOCATE(MSDGY(NSTEPORIG,NTYP))
ALLOCATE(MSDGZ(NSTEPORIG,NTYP))
ALLOCATE(UU(NSTEPORIG,NATOM,3))
ALLOCATE(MMSDX(NSTEPORIG,NTYP))
ALLOCATE(MMSDY(NSTEPORIG,NTYP))
ALLOCATE(MMSDZ(NSTEPORIG,NTYP))
ALLOCATE(CMMSDX(NSTEPORIG,NTYP))
ALLOCATE(CMMSDY(NSTEPORIG,NTYP))
ALLOCATE(CMMSDZ(NSTEPORIG,NTYP))
ALLOCATE(TCMMSDX(NSTEPORIG))
ALLOCATE(TCMMSDY(NSTEPORIG))
ALLOCATE(TCMMSDZ(NSTEPORIG))
ALLOCATE(TTCMMSDX(NSTEPORIG))
ALLOCATE(TTCMMSDY(NSTEPORIG))
ALLOCATE(TTCMMSDZ(NSTEPORIG))
OPEN(145,FILE="MSDXYZ")
OPEN(146,FILE="MSD")
MSDX=0
MSDY=0
MSDZ=0
MSDGX=0
MSDGY=0
MSDGZ=0
NSTEPORIG2=IREF2-IREF1+1 
PRINT*,NSTEPORIG2
PRINT*, 'THE U2 IS AVERAGED FOR',NSTEPI,'LENGHT, WITH ',OINT, 'INTERVAL'
!READ*,NSTEPI
IF(NSTEPI.GT.NSTEPORIG2)NSTEPI=NSTEPORIG2


GOTO 1258
!$omp parallel do
DO I=1,NATOM
PRINT*, 'ATOM NO',I,'has been done MSD4'
                DO DT=1,NSTEPORIG2-OINT
                NSTEP1=NSTEPI
                NSTEP2=NSTEPI+DT
                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP1=NSTEPORIG2-DT
                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP2=NSTEP1+DT
                MSDX(DT,I)=SUM((POS(1:NSTEP1:OINT,I,1)-POS(1+DT:NSTEP2:OINT,I,1))**2) ! + &
                MSDY(DT,I)=SUM((POS(1:NSTEP1:OINT,I,2)-POS(1+DT:NSTEP2:OINT,I,2))**2) !
                MSDZ(DT,I)=SUM((POS(1:NSTEP1:OINT,I,3)-POS(1+DT:NSTEP2:OINT,I,3))**2) !  )
                TAO=NSTEPI
                IF(NSTEPI+DT.GT.NSTEPORIG2)TAO=NSTEPORIG2-DT
                MSDX(DT,I)=MSDX(DT,I)/REAL((TAO/OINT))
                MSDY(DT,I)=MSDY(DT,I)/REAL((TAO/OINT))
                MSDZ(DT,I)=MSDZ(DT,I)/REAL((TAO/OINT))
                END DO
!                       MSD(DT,I)=sum( (PPOS(1:nstep,:) - PPOS(1+dt:nstep+dt,:))**2 ) /dble(nt)
END DO
!$omp end parallel do


                        N1=0
                        N2=0
                        DO M=1,NTYP

                                N1=N2+1
                                N2=N1+NNTYPE(M)-1
                                DO K=N1,N2
                                MSDGX(:,M)=MSDGX(:,M)+MSDX(:,K)
                                MSDGY(:,M)=MSDGY(:,M)+MSDY(:,K)
                                MSDGZ(:,M)=MSDGZ(:,M)+MSDZ(:,K)
                                END DO
                        MSDGX(:,M)=MSDGX(:,M)/NNTYPE(M)
                        MSDGY(:,M)=MSDGY(:,M)/NNTYPE(M)
                        MSDGZ(:,M)=MSDGZ(:,M)/NNTYPE(M)
                        END DO
DO I=1,NSTEPORIG2-OINT
                WRITE(195,98)DELT*REAL(I),((MSDX(I,K)+MSDY(I,K)+MSDZ(I,K)),K=1,NATOM)
                WRITE(196,98)DELT*REAL(I),((MSDGX(I,K)+MSDGY(I,K)+MSDGZ(I,K)),K=1,NTYP)
                WRITE(197,98)DELT*REAL(I),((MSDX(I,K),MSDY(I,K),MSDZ(I,K)),K=1,NATOM)
                WRITE(198,98)DELT*REAL(I),((MSDGX(I,K),MSDGY(I,K),MSDGZ(I,K)),K=1,NTYP)
98             FORMAT(F16.6,10000F16.5)
END DO
1258 CONTINUE



!!!!!!!!!!!!!!!!CROSS
                DO DT=1,NSTEPORIG2-OINT
                NSTEP1=NSTEPI
                NSTEP2=NSTEPI+DT
                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP1=NSTEPORIG2-DT
                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP2=NSTEP1+DT
                TAO=NSTEPI
                IF(NSTEPI+DT.GT.NSTEPORIG2)TAO=NSTEPORIG2-DT

                !TCMMSDX(DT)=SUM(MASS* ( SUM((POS(1:NSTEP1:OINT,:,1) ),DIM=1  ))) /(SUM(MASS))   ! + &
                !TCMMSDY(DT)=SUM(MASS* ( SUM((POS(1:NSTEP1:OINT,:,2) ),DIM=1  ))) /(SUM(MASS))   ! + &
                !TCMMSDZ(DT)=SUM(MASS* ( SUM((POS(1:NSTEP1:OINT,:,3) ),DIM=1 ))) /(SUM(MASS))   ! + &
                TCMMSDX(DT)=SUM(MASS*POS(DT,:,1) ) /(SUM(MASS))   ! + &
                TCMMSDY(DT)=SUM(MASS*POS(DT,:,2) ) /(SUM(MASS))   ! + &
                TCMMSDZ(DT)=SUM(MASS*POS(DT,:,3) ) /(SUM(MASS))   ! + &
                END DO

CMMSDX=0
CMMSDY=0
CMMSDZ=0


DO I=1,NTYP
N1=SUM(NNTYPE(1:I-1)) +1
N2=SUM(NNTYPE(1:I)) 
PRINT*,N1,N2
PRINT*, 'ATOM TYPE',I,'has been done'
                DO DT=1,NSTEPORIG2-OINT
                NSTEP1=NSTEPI
                NSTEP2=NSTEPI+DT
                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP1=NSTEPORIG2-DT
                IF(NSTEPI+DT.GT.NSTEPORIG2)NSTEP2=NSTEP1+DT
                TAO=NSTEPI
                IF(NSTEPI+DT.GT.NSTEPORIG2)TAO=NSTEPORIG2-DT



                TTCMMSDX(DT)=(SUM(MASS)*TCMMSDX(DT)-     SUM(MASS(N1:N2)*POS(DT,N1:N2,1)) ) /(SUM(MASS) -SUM(MASS(N1:N2)))
                TTCMMSDY(DT)=(SUM(MASS)*TCMMSDY(DT)-     SUM(MASS(N1:N2)*POS(DT,N1:N2,2)) ) /(SUM(MASS) -SUM(MASS(N1:N2)))
                TTCMMSDZ(DT)=(SUM(MASS)*TCMMSDZ(DT)-     SUM(MASS(N1:N2)*POS(DT,N1:N2,3)) ) /(SUM(MASS) -SUM(MASS(N1:N2)))

                
                !TTCMMSDY(DT)=SUM(MASS*POS(DT,:,2) ) /(SUM(MASS))   ! + &
                !TTCMMSDZ(DT)=SUM(MASS*POS(DT,:,3) ) /(SUM(MASS))   ! + &











                !CMMSDX(DT,I)=  SUM((POS(1:NSTEP1:OINT,N1:N2,1) -  POS(1+DT:NSTEP2:OINT,N1:N2,1))) /NNTYPE(I)  ! + &
                !CMMSDY(DT,I)=  SUM((POS(1:NSTEP1:OINT,N1:N2,2) -  POS(1+DT:NSTEP2:OINT,N1:N2,2))) /NNTYPE(I)  ! + &
                !CMMSDZ(DT,I)=  SUM((POS(1:NSTEP1:OINT,N1:N2,3) -  POS(1+DT:NSTEP2:OINT,N1:N2,3))) /NNTYPE(I)  ! + &
                
                CMMSDX(DT,I)= (SUM(POS(1,N1:N2,1)) - SUM(POS(DT,N1:N2,1))) /NNTYPE(I)  ! + &
                CMMSDY(DT,I)= (SUM(POS(1,N1:N2,2)) -SUM(POS(DT,N1:N2,2)) )/NNTYPE(I)  ! + &
                CMMSDZ(DT,I)= (SUM(POS(1,N1:N2,3)) -SUM(POS(DT,N1:N2,3)) )/NNTYPE(I)  ! + &
                
                !CMMSDX(DT,I)=(CMMSDX(DT,I)   )**2  
                !CMMSDY(DT,I)=(CMMSDY(DT,I)   )**2  
                !CMMSDZ(DT,I)=(CMMSDZ(DT,I)   )**2  
                CMMSDX(DT,I)=(CMMSDX(DT,I)-TTCMMSDX(DT))**2 !/REAL(TAO/OINT) 
                CMMSDY(DT,I)=(CMMSDY(DT,I)-TTCMMSDY(DT))**2 !/REAL(TAO/OINT) 
                CMMSDZ(DT,I)=(CMMSDZ(DT,I)-TTCMMSDZ(DT))**2 !/REAL(TAO/OINT) 
                
                
                !CMMSDX(DT,I)=(CMMSDX(DT,I))**2 /REAL(TAO/OINT) 
                !CMMSDY(DT,I)=(CMMSDY(DT,I))**2 /REAL(TAO/OINT) 
                !CMMSDZ(DT,I)=(CMMSDZ(DT,I))**2 /REAL(TAO/OINT) 
                END DO
!                       MSD(DT,I)=sum( (PPOS(1:nstep,:) - PPOS(1+dt:nstep+dt,:))**2 ) /dble(nt)
END DO


DO DT=1,NSTEPORIG2-OINT
                WRITE(194,98)DELT*REAL(DT),((CMMSDX(DT,K)+CMMSDY(DT,K)+CMMSDZ(DT,K)),K=1,NTYP)
END DO







DEALLOCATE(MSDX,MSDY,MSDZ,MSDGX,MSDGY,MSDGZ,UU,MMSDX,MMSDY,MMSDZ,CMMSDX,CMMSDY,CMMSDZ)
DEALLOCATE(TCMMSDX,TCMMSDY,TCMMSDZ)
END SUBROUTINE



SUBROUTINE CALCULATE_FREE2(IIFREE)
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::IIFREE
DOUBLE PRECISION,DIMENSION(NNTYPE(IIFREE),3)::DRT
DOUBLE PRECISION,DIMENSION(NNTYPE(IIFREE))::DDRT
INTEGER::NORIGIN
!DOUBLE PRECISION,DIMENSION(64,3)::NPOS
INTEGER,DIMENSION(-10000:10000)::OCCUPY,OCCUPYX,OCCUPYY,OCCUPYZ
INTEGER::IDDRT,IDDRTX,IDDRTY,IDDRTZ
DOUBLE PRECISION::KB
DOUBLE PRECISION,DIMENSION(3)::VEC1,VEC2,VEC3


KB=8.61732814974493E-05 
PRINT*,'I M CALC FREE'
OPEN(125,FILE="PROB_R_FREE_ENERGY")
OPEN(126,FILE="FREE_ENERGY")
OCCUPY=1
OCCUPYX=1
OCCUPYY=1
OCCUPYZ=1

DDRT=0
DRT=0
DO I=SUM(NNTYPE(1:IIFREE-1))+1,SUM(NNTYPE(1:IIFREE))  !152
       DO IT=1,IREF2-IREF1+1
       IDDRT=0
       DRT(1,:)= POS(IT,I,:) !MATMUL( POS(IT,I,:),ISLAT)   
       !DRT(1,:)=MATMUL(DRT(1,:),ISLAT)
       DDRT=NORM2(DRT(1,:))
       IDDRT=INT(DDRT(1)/0.01)
       IDDRTX=INT(ABS(DRT(1,1))/0.01)
       IDDRTY=INT(ABS(DRT(1,2))/0.01)
       IDDRTZ=INT(ABS(DRT(1,3))/0.01)
       IF(IDDRT.NE.0.AND.IDDRT.LE.10000) OCCUPY(IDDRT)=OCCUPY(IDDRT)+1
       IF(IDDRTX.NE.0.AND.IDDRTX.LE.10000) OCCUPYX(IDDRTX)=OCCUPYX(IDDRTX)+1
       IF(IDDRTY.NE.0.AND.IDDRTY.LE.10000) OCCUPYY(IDDRTY)=OCCUPYY(IDDRTY)+1
       IF(IDDRTZ.NE.0.AND.IDDRTZ.LE.10000) OCCUPYZ(IDDRTZ)=OCCUPYZ(IDDRTZ)+1
        END DO
!AUSE
!END DO
END DO

PRINT*,'TEMPERATURE is ', TEMPER
DO I=1,2000
WRITE(125,125)REAL(I)*0.01,OCCUPY(I),OCCUPYX(I),OCCUPYY(I),OCCUPYZ(I)
WRITE(126,126)REAL(I)*0.01,-KB*TEMPER*log(REAL(OCCUPY(I))),-KB*TEMPER*log(REAL(OCCUPYX(I))),-KB*TEMPER*log(REAL(OCCUPYY(I))),-KB*TEMPER*log(REAL(OCCUPYZ(I)))

!WRITE(126,125)REAL(I)*0.01,OCCUPY(I)
125 FORMAT(F10.5,64I10)
126 FORMAT(F10.5,64E15.5)
END DO
END SUBROUTINE




SUBROUTINE SEDADVANCED !(IQQQQ,QHKL)   !!!!!!!!!!THIS IS with velcoity projection
use omp_lib
USE VARIABLES1,only:ICARTESIAN,PI,AVGISLAT,POSSTART,MASS,VEL,NSTEPORIG,ICOH,IBROAD,FWHM0,FWHM1,NTYP,NSTEP,NATOM,DELT,ICUT,NNTYPE,SNTYPE,PNTYPE,MAP,NDIM,IREF2,IREF1,KLIST,POS
!USE VARIABLES3, only:KLIST
IMPLICIT NONE
DOUBLE PRECISION::QQMIN1,QQMAX1 !,QQSTEP
INTEGER::IQQQ,IILIST,KI
DOUBLE PRECISION,DIMENSION(3)::KEND,DELK
INTEGER::KN1,KN2,KN3,IP,IPATH,KI1,KI2,KI3,ISTART,NNQ


INCLUDE 'fftw3.f'
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:,:)::AFQT,SAFQT,SSAFQT
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::tempd,cout 
COMPLEX*16,ALLOCATABLE,DIMENSION(:,:)::CFFQTTYP 
DOUBLE PRECISION,DIMENSION(3)::KVEC,KSTART,DIR1,QHKL
INTEGER::NQ, IQ,NW
DOUBLE PRECISION::DELQ,FRE,PHASE2
REAL,DIMENSION(NSTEP)::PHASE1
!DOUBLE PRECISION,DIMENSION(NATOM)::PHASE11
COMPLEX::PHASEFACTOR
INTEGER::IFOR,IBAC,ISCHEME
INTEGER::II1,I1,DT1,III
DOUBLE PRECISION::EE
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::QQ,QK !,tempd
INTEGER::ITYPPP,JTYPPP
INTEGER::IQQQQ,NNN2
CHARACTER::AA*10
INTEGER::NTYP2,NTYP3
INTEGER::IJ1,IJ2
INTEGER::IQTCAL
integer,allocatable,dimension(:)::plan
integer,dimension(natom)::plann
INTEGER,ALLOCATABLE,DIMENSION(:)::KSELF
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::DUMMY1,DUMMY5
INTEGER::DT,IT
REAL::OMEGA
INTEGER::I,J
integer,dimension(9)::desca,descb,descc
integer::ia,ja,ib,jb,ic,jc,m,n,k
integer,dimension(1,NATOM)::lda,ldb,ldc
integer,dimension(NDIM)::MAPI !lda,ldb,ldc
real::alpha,beta
INTEGER::N1,N2
DOUBLE PRECISION,DIMENSION(NDIM)::PHASE11
DOUBLE PRECISION,DIMENSION(NDIM,3)::VELL,POSSS
DOUBLE PRECISION,DIMENSION(NDIM)::MASSS
COMPLEX*16,DIMENSION(NDIM)::PHASEE !VELL
m=natom
n=natom
k=3
alpha=1
beta=0
PRINT*,'I M IN SEDADV'

IF(ICUT==1)WRITE(AA,'("SEDTOT",I4.4)')IQQQQ
IF(ICUT==1)OPEN(IQQQQ,FILE=AA)
OPEN(9999,FILE='SEDTOTAL',ACCESS='APPEND')
PRINT*, QHKL
ALLOCATE(AFQT(1:NSTEP,NDIM,3))
!ALLOCATE(SAFQT(1:NSTEP,SUM(PNTYPE),3))
ALLOCATE(CFFQTTYP(1:NSTEP,NTYP))
ALLOCATE(DUMMY1(NSTEP),DUMMY5(NSTEP))
allocate(plan(NATOM))
AFQT=0
!SAFQT=0
!CFFQTTYP=0
IFOR= 1
IBAC=-1
NQ=1
!ALLOCATE(QQ(NQ,3),QK(NQ,3))
!ALLOCATE(COUT(NATOM,NATOM))

OPEN(123456,FILE='KVALUES')
!ALLOCATE(KLIST(50000,3))

ICARTESIAN=0
OPEN(119,FILE="KLISTMAN")
READ(119,*)IPATH
DO IP=1,IPATH
IQQQ=0
KN1=0
KN2=0
KN3=0
        READ(119,*)KSTART,KEND,DELK !LIST(IQQQ,:)
        IF(DELK(1).NE.0)        KN1=(KEND(1)-KSTART(1))/DELK(1)
        IF(DELK(2).NE.0)        KN2=(KEND(2)-KSTART(2))/DELK(2)
        IF(DELK(3).NE.0)        KN3=(KEND(3)-KSTART(3))/DELK(3)
        KN1=KN1+1
        KN2=KN2+1
        KN3=KN3+1
                DO IQQQ=1,MAX(KN1,MAX(KN2,KN3))
                KLIST(IQQQ,:)=KSTART+(IQQQ-1)*DELK
                WRITE(123456,1234)KLIST(IQQQ,:)
                1234 FORMAT(3F10.5)
                END DO
                PRINT*,'TOTAL Number of Q points is ',IQQQ-1

        PRINT*,AVGISLAT
        DO KI=1,IQQQ-1

        !CALL SEDADVANCED(KI,KLIST(KI,:))

        !IQ=1
        !CFFQTTYP=0
        !QQ(IQ,:)=QHKL    !KLIST(IQ,:) !VEC
        IF(ICARTESIAN==1)THEN
        KVEC=QHKL        !KLIST(IQ,:)
        ELSE
        KVEC=2.0*PI*MATMUL(AVGISLAT,KLIST(KI,:) )        !CHANGED AVGISLAT TO ISLAT
        END IF
        !QK(IQ,:)=KVEC
        CFFQTTYP=0
        !SAFQT=0
        AFQT=0

        DO IT=1,IREF2-IREF1+1
        CALL MAPPER(POS(IT,:,:)) !!!!!!!WILL WRITE PPOSCAR vs SPOSCAR Things 
                !PRINT*,'MAPPED', SUM(MAP)
                DO J=1,SUM(PNTYPE)
                MAPI=MAP(J,:)
                PHASE11=0
                MASSS=0
                VELL=0
                POSSS=0
                WHERE(MAPI.NE.0)POSSS(:,1)=POSSTART(MAPI,1)
                WHERE(MAPI.NE.0)POSSS(:,2)=POSSTART(MAPI,2)
                WHERE(MAPI.NE.0)POSSS(:,3)=POSSTART(MAPI,3)
                PHASE11=KVEC(1)*POSSS(:,1) + KVEC(2)*POSSS(:,2) + KVEC(3)*POSSS(:,3)
                WHERE(MAPI.NE.0)VELL(:,1)=VEL(IT,MAPI,1)
                WHERE(MAPI.NE.0)VELL(:,2)=VEL(IT,MAPI,2)
                WHERE(MAPI.NE.0)VELL(:,3)=VEL(IT,MAPI,3)
                WHERE(MAPI.NE.0)MASSS=MASS(MAPI)
                PHASEE=CMPLX(COS(PHASE11(:)),SIN(PHASE11(:)))
                AFQT(IT,J,1)=SUM (SQRT(MASSS)* VELL(:,1)*PHASEE)
                AFQT(IT,J,2)=SUM (SQRT(MASSS)* VELL(:,2)*PHASEE)
                AFQT(IT,J,3)=SUM (SQRT(MASSS)* VELL(:,3)*PHASEE)
                END DO        
        END DO

        DO J=1,SUM(PNTYPE)
                
                call dfftw_plan_dft_1d(plann(j),NSTEP,AFQT(:,j,1),AFQT(:,j,1),IFOR,FFTW_ESTIMATE)
                call dfftw_execute_dft(plann(j), AFQT(:,j,1),AFQT(:,j,1))
                call dfftw_destroy_plan(plann(j))
                call dfftw_plan_dft_1d(plann(j),NSTEP,AFQT(:,j,2),AFQT(:,j,2),IFOR,FFTW_ESTIMATE)
                call dfftw_execute_dft(plann(j), AFQT(:,j,2),AFQT(:,j,2))
                call dfftw_destroy_plan(plann(j))
                call dfftw_plan_dft_1d(plann(j),NSTEP,AFQT(:,j,3),AFQT(:,j,3),IFOR,FFTW_ESTIMATE)
                call dfftw_execute_dft(plann(j), AFQT(:,j,3),AFQT(:,j,3))
                call dfftw_destroy_plan(plann(j))
                AFQT(:,j,:)=AFQT(:,j,:)/REAL(NSTEPORIG)
        END DO





         DO J=1,NTYP
         N1=SUM(PNTYPE(1:J-1))+1
         N2=SUM(PNTYPE(1:J))
         !PRINT*,N1,N2
         DO IT=1,NSTEP
         CFFQTTYP(IT,J)=SUM( AFQT(IT,N1:N2,:) * CONJG(AFQT(IT,N1:N2,:))) 
         END DO
         DUMMY1=  REAL(CFFQTTYP(:,J)) !      SUM(DUMMY2(1:NQ,1,:),DIM=1 ) /NQ
         IF(IBROAD==1)CALL BROAD_NEW(FWHM0,FWHM1,DUMMY1,DUMMY5)
         IF(IBROAD==2)CALL BROAD2(FWHM0,FWHM1,DUMMY1,DUMMY5)
         IF(IBROAD==3)CALL BROAD3(FWHM0,FWHM1,DUMMY1,DUMMY5)
         WHERE(DUMMY5.LE.1.0E-10)DUMMY5=0
         CFFQTTYP(:,J)=DUMMY5
         END DO

        IF(ICUT==1)THEN
        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        WRITE(IQQQQ,15) OMEGA, REAL(CFFQTTYP(DT,:))
        END DO
        END IF
        DO DT=1,NSTEP/2
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP))
        WRITE(9999,15) OMEGA, REAL(CFFQTTYP(DT,:)), REAL( SUM(CFFQTTYP(DT,:))) !DUMMY5(DT)
        END DO
        17 FORMAT(A12,2X,3F10.5)
        15 FORMAT(F15.4,1003E20.2)
        170 FORMAT(A12,100(3X,3F6.2,3X))
        172 FORMAT(A12,<NQ>(3X,3F6.2,3X),6X,'AVG OVER Q')
        171 FORMAT(A3,12X,<NTYP>(8X,'avg',A3,10X) )
        173 FORMAT(A3,12X,<NTYP2>(8X,'avg',2A3,10X) )
        IF(ICUT==1)CLOSE(IQQQQ)
        


END DO   !!!!!!!!!!!! QPOINTS
END DO   !!!!!!!!     IPATH
close(9999)
DEALLOCATE(DUMMY1,DUMMY5)
DEALLOCATE(AFQT)
END SUBROUTINE



SUBROUTINE MAPPER(POSITIONS)
use omp_lib
USE VARIABLES1
USE VARIABLES3
IMPLICIT NONE
INTEGER::NNN1,NNN2,NNNN1,NNNN2
INTEGER::ITOTAL
DOUBLE PRECISION,DIMENSION(NATOM,3)::POSITIONS
!ALLOCATE(PNTYPE(NTYP),SNTYPE(NTYP))
OPEN(11,FILE="PPOSCAR")
OPEN(12,FILE="SPOSCAR")
READ(11,*)
READ(11,*)
READ(11,*)PLAT(1,:)
READ(11,*)PLAT(2,:)
READ(11,*)PLAT(3,:)
READ(11,*)
READ(11,*)PNTYPE
READ(11,*)
PVOLUME=PLAT(1,1)* (PLAT(2,2)*PLAT(3,3)-PLAT(2,3)*PLAT(3,2)) + PLAT(1,2)* (PLAT(2,3)*PLAT(3,1)-PLAT(2,1)*PLAT(3,3)) + PLAT(1,3)* (PLAT(2,1)*PLAT(3,2)-PLAT(2,2)*PLAT(3,1))
!PRINT*,SUM(PNTYPE)
!ALLOCATE(PRPOS(SUM(PNTYPE),3))
DO I=1,SUM(PNTYPE)
READ(11,*)PRPOS(I,:)
END DO
READ(12,*)
READ(12,*)
READ(12,*)SPLAT(1,:)
READ(12,*)SPLAT(2,:)
READ(12,*)SPLAT(3,:)
SVOLUME=SPLAT(1,1)* (SPLAT(2,2)*SPLAT(3,3)-SPLAT(2,3)*PLAT(3,2)) + SPLAT(1,2)* (SPLAT(2,3)*SPLAT(3,1)-SPLAT(2,1)*SPLAT(3,3)) + SPLAT(1,3)* (SPLAT(2,1)*SPLAT(3,2)-SPLAT(2,2)*SPLAT(3,1))
IPLAT=PLAT
CALL GAUSS(IPLAT,3)
ISPLAT=SPLAT
CALL GAUSS(ISPLAT,3)

SSIZE=NINT(MATMUL(IPLAT,SPLAT))
!PRINT*,SSIZE(1,:)
!PRINT*,SSIZE(2,:)
!PRINT*,SSIZE(3,:)
READ(12,*)
READ(12,*)SNTYPE
READ(12,*)
!ALLOCATE(POSS(SUM(SNTYPE),3))
DO I=1,SUM(SNTYPE)
!POSS(I,:)=MATMUL(POS(IT,I,:),ISPLAT)
POSS(I,:)=MATMUL(POSITIONS(I,:),ISPLAT)
!READ(12,*)POSS(I,:)
POSS(I,:)=MATMUL(SSIZE,POSS(I,:))
END DO
CLOSE(11)
close(12)
NDIM=NINT(SVOLUME/PVOLUME)
!ALLOCATE(MAP(SUM(PNTYPE),NDIM))
MAP=0

ITOTAL=0
DO K=1,NTYP
        NNN1=SUM(SNTYPE(1:K-1))+1
        NNN2=SUM(SNTYPE(1:K)) !+1
        NNNN1=SUM(PNTYPE(1:K-1))+1
        NNNN2=SUM(PNTYPE(1:K)) !+1
!        PRINT*,NNN1,NNN2
!        PRINT*,NNNN1,NNNN2
        DO I=NNNN1,NNNN2 !SUM(PNTYPE)
        KK=0
        DO J=NNN1,NNN2 !SUM(SNTYPE)
        RDEL=PRPOS(I,:)-POSS(J,:) + NINT(POSS(J,:))
        !RDEL=ABS(RDEL)
        !where(RDEL.GE.0.99)RDEL=RDEL-1
        !where(RDEL.GE.0.90)RDEL=RDEL-1
        where(RDEL.GT.0.5)RDEL=RDEL-1.0
        where(RDEL.LT.-0.5)RDEL=RDEL+1.0
        RDEL=MATMUL(RDEL,PLAT)
        !RCHECK=NORM2(RDEL)
        !PRINT*,RDEL ,I       
        !IF(RCHECK.LE.1.0e-2)THEN
        IF(NORM2(RDEL).LE.1.5)THEN
        ITOTAL=ITOTAL+1
                KK=KK+1 
        !PRINT*,KK,RDEL,I        
        MAP(I,KK)=J          !MAP(I,K)=J
!        PRINT*,I,MAP(I,KK)        
        END IF
        END DO
        END DO
END DO
PRINT*,'MAPPED',ITOTAL
!PAUSE

!RDEL=PRPOS(I,:)-POSS(J,:)+ INT(POSS(J,:))
!RDEL=ABS(RDEL)
!where(RDEL.GE.0.99)RDEL=RDEL-1
!RCHECK=NORM2(RDEL)
!!PRINT*,POSS(J,:)
!!PRINT*,RCHECK
!!PAUSE
!IF(RCHECK.LE.1.0e-2)THEN
!K=K+1
!MAP(I,K)=J !k=k+1

END SUBROUTINE 


SUBROUTINE SORTER(IT3,IDD1,IDD2,IDD3,IDD4,IDD5,IDD6,VTOT)
use omp_lib
USE VARIABLES1, only :POS,SLATORIG,ISLATORIG
IMPLICIT NONE
INTEGER::IT3,ID1,ID2,ID3,ID4,ID5,ID6 !IFREE
INTEGER::IDD1,IDD2,IDD3,IDD4,IDD5,IDD6 !IFREE
INTEGER,DIMENSION(1000,6)::INDEXER
DOUBLE PRECISION,DIMENSION(6,3)::cord !NNTYPE(IIFREE),3)::DRT
DOUBLE PRECISION,DIMENSION(1000)::VVOL
DOUBLE PRECISION,DIMENSION(12)::RDI !VVOL
DOUBLE PRECISION::VVVOL,VTOT
INTEGER::JMIN,JJMIN
INTEGER,DIMENSION(6)::ATMID,AATMID
INTEGER,DIMENSION(12,2)::PAIR
DOUBLE PRECISION,DIMENSION(3)::DDDDD
ATMID=(/IDD1,IDD2,IDD3,IDD4,IDD5,IDD6/)
VVOL=0
VTOT=0
VVVOL=0
ID5=0
DDDDD=0
!PRINT*,'I AM IN SORTER'
!PRINT*,ATMID
                        DO ID1=1,6
                        DO ID2=ID1+1,6
                        DO ID3=ID2+1,6
                        DO ID4=ID3+1,6
                        ID5=ID5+1
                   !     PRINT*, IT3,ID5
                        CALL CVOLUME2022(IT3,ATMID(ID1),ATMID(ID2),ATMID(ID3),ATMID(ID4),VVOL(ID5))
                        INDEXER(ID5,1:4)=(/ATMID(ID1),ATMID(ID2),ATMID(ID3),ATMID(ID4)/)
                        !     PRINT*, VVOL(ID5)
                        END DO
                        END DO
                        END DO
                        END DO
                        !print*,id5
                        JMIN=minloc(VVOL(1:ID5),DIM=1)
                        !print*,minval(VVOL(1:ID5))
                        !print*,INDEXER(JMIN,1:4)-96 !minval(VVOL(1:ID5))
                        CORD(1,:)=MATMUL(POS(IT3,INDEXER(JMIN,1),:),ISLATORIG)
                        CORD(2,:)=MATMUL(POS(IT3,INDEXER(JMIN,2),:),ISLATORIG)
                        CORD(3,:)=MATMUL(POS(IT3,INDEXER(JMIN,3),:),ISLATORIG)
                        CORD(4,:)=MATMUL(POS(IT3,INDEXER(JMIN,4),:),ISLATORIG)
                        ID2=4
                        DO ID1=1,6
                        IF(ANY(INDEXER(JMIN,:).eq.ATMID(ID1)).eq..FALSE.)THEN
                        ID2=ID2+1
                        INDEXER(JMIN,ID2)=ATMID(ID1)
                        !PRINT*,ID2,ATMID(ID1)
                        !PRINT*,ID2
                        CORD(ID2,:)=MATMUL(POS(IT3,ATMID(ID1),:),ISLATORIG)
                        END IF
                        END DO

DO ID1=2,6
where((CORD(ID1,:)-CORD(1,:)).LE.-0.5)CORD(ID1,:)=CORD(ID1,:)+1 !=MATMUL
where((CORD(ID1,:)-CORD(1,:)).GE. 0.5)CORD(ID1,:)=CORD(ID1,:)-1 !=MATMUL
END DO
                        ID5=0
                        DO ID1=1,4
                           DO ID2=ID1+1,4
                           ID5=ID5+1
                           DDDDD=CORD(ID1,:)-CORD(ID2,:)
                           WHERE(DDDDD.LT.-0.5)DDDDD=DDDDD+1.0
                           WHERE(DDDDD.GT.0.5)DDDDD=DDDDD-1.0
                           !RDI(ID5)= NORM2(MATMUL(  CORD(ID1,:)-CORD(ID2,:),SLATORIG))
                           RDI(ID5)= NORM2(MATMUL( DDDDD,SLATORIG))
                           PAIR(ID5,1)= INDEXER(JMIN,ID1)            !ATMID(ID1)
                           PAIR(ID5,2)= INDEXER(JMIN,ID2)             !ATMID(ID2)
                           END DO
                        END DO
                        JJMIN=maxloc(RDI(1:ID5),DIM=1)
                        PRINT 2356,PAIR(JJMIN,:)-96,RDI(1:ID5)
                        2356 FORMAT(2I6,100F10.4)
!                        PRINT*,RDI
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!COUNTING TETRA
ID3=0
DO ID1=1,2
     DO ID2=5,6
     ID3=ID3+1
     AATMID(1)=PAIR(JJMIN,ID1)
          ID5=1
          DO ID4=1,4
          IF(ANY(INDEXER(JMIN,ID4).EQ.PAIR(JJMIN,:)).EQ..FALSE.)THEN
          ID5=ID5+1
          AATMID(ID5)=INDEXER(JMIN,ID4)
          END IF
          END DO
          AATMID(4)=INDEXER(JMIN,ID2)
          PRINT 125,IT3,AATMID(1:4)-96
125 FORMAT(6I6)
!PAUSE
          CALL CVOLUME2022(IT3,AATMID(1),AATMID(2),AATMID(3),AATMID(4),VVVOL)
          VTOT=VTOT+VVVOL
          !PRINT 259,IT3,AATMID(1)-96,AATMID(2)-96,AATMID(3)-96,AATMID(4)-96,VVVOL
          259 FORMAT(I8,4I9,F10.5)
     END DO
END DO
!PRINT*,VTOT
END SUBROUTINE


SUBROUTINE INDEXER(IT4,SSID,NCCORD)
use omp_lib
USE VARIABLES1, only :POS,SLATORIG,ISLATORIG,CATOM,SATOM,NPOLY,NNTYPE,BOND,NCORD
IMPLICIT NONE
INTEGER,DIMENSION(NPOLY,6)::SSID !INDEXER
INTEGER,DIMENSION(NPOLY,1000)::SSSID !INDEXER
INTEGER::N11,N12,N21,N22,IT4,IND,L7,I7,K7,J7,M7
DOUBLE PRECISION,DIMENSION(3)::DR
DOUBLE PRECISION,DIMENSION(100)::DISID !INDEXER
DOUBLE PRECISION::DIST
INTEGER,DIMENSION(100)::ISORT
INTEGER,DIMENSION(NPOLY)::NCCORD

!
N11=SUM(NNTYPE(1:CATOM-1))+1
N12=SUM(NNTYPE(1:CATOM))
N21=SUM(NNTYPE(1:SATOM-1))+1
N22=SUM(NNTYPE(1:SATOM))
IND=0
L7=0
J7=0
I7=0
K7=0
M7=0
!PRINT*,DIST
!PRINT*,'I AM IN INDEXER'
SSID=0
SSSID=0
NCCORD=0
DO I7=N11,N12
   L7=L7+1
   !PRINT*,L7    
   K7=0
   ISORT=0
   DISID=0
      DIST=0
      DO J7=N21,N22
      DR=MATMUL(POS(IT4,I7,:)-POS(IT4,J7,:),ISLATORIG)
      DR=DR-NINT(DR)
      WHERE(DR.GT.0.5)DR=DR-1
      WHERE(DR.LT.-0.5)DR=DR+1
      DR=MATMUL(DR,SLATORIG)
      DIST=NORM2(DR)
      IF(DIST.GT.0)NCCORD(I7-N11+1)=NCCORD(I7-N11+1)+1
      IF(DIST.LE.BOND.AND.DIST.GT.0)THEN
          K7=K7+1
          SSSID(I7-N11+1,K7)=J7
          DISID(K7)=DIST
      END IF
      END DO

      M7=100
      CALL SORT(DISID,M7,ISORT)
      SSID(I7-N11+1,1:6)=SSSID(I7-N11+1,ISORT(1:6))
      !IF (L7==1)PRINT 236,IT4, SSID(L7,1:6)-96
      !IF (L7==1)PRINT 237,IT4, DISID(1:6)
      !IF (L7==1)PRINT 236,IT4, ISORT(1:6)
      236 FORMAT(7I7)
      237 FORMAT(I7,10F10.5,F10.5)
     ! PAUSE
END DO
END SUBROUTINE




SUBROUTINE SORTERN(IT3,IDD1,IDD2,IDD3,IDD4,IDD5,IDD6,VTOT)
use omp_lib
USE VARIABLES1, only :POS,SLATORIG,ISLATORIG,INDTRI
IMPLICIT NONE
INTEGER::IT3,ID1,ID2,ID3,ID4,ID5,ID6 !IFREE
INTEGER::IDD1,IDD2,IDD3,IDD4,IDD5,IDD6 !IFREE
INTEGER,DIMENSION(1000,6)::INDEXER
DOUBLE PRECISION,DIMENSION(6,3)::cord !NNTYPE(IIFREE),3)::DRT
DOUBLE PRECISION,DIMENSION(1000)::VVOL
DOUBLE PRECISION,DIMENSION(12)::RDI !VVOL
DOUBLE PRECISION::VVVOL,VTOT
INTEGER::JMIN,JJMIN
INTEGER,DIMENSION(6)::ATMID,AATMID
INTEGER,DIMENSION(12,2)::PAIR
DOUBLE PRECISION,DIMENSION(20)::AR1
INTEGER,DIMENSION(20)::IISORT
DOUBLE PRECISION,DIMENSION(3)::RCM,RCM3,DIC
DOUBLE PRECISION,DIMENSION(20)::DDIC
INTEGER,DIMENSION(3)::NINDEX


ATMID=(/IDD1,IDD2,IDD3,IDD4,IDD5,IDD6/)
VVOL=0
VTOT=0
VVVOL=0
ID5=0
AR1=0
INDTRI=0

PRINT*,'I AM IN SORTERN'
                        CALL CENTRE(IT3,ATMID(1),ATMID(2),ATMID(3),ATMID(4),ATMID(5),ATMID(6),RCM)
                        !PRINT*,MATMUL(RCM,ISLATORIG)
VTOT=0
                        DO ID1=1,6
                        DO ID2=ID1+1,6
                        DO ID3=ID2+1,6
                        ID5=ID5+1
                        NINDEX=(/ATMID(ID1),ATMID(ID2),ATMID(ID3)/)
                        !PRINT*,NINDEX-96
                        CALL CENTRE3(IT3,NINDEX,RCM3)
                        DIC=MATMUL(RCM3-RCM,ISLATORIG)
                        WHERE(DIC.LE.-0.5)DIC=DIC+1
                        WHERE(DIC.GE. 0.5)DIC=DIC-1
                        DIC=MATMUL(DIC,SLATORIG)
                        DDIC(ID5)=NORM2(DIC)
                        !        PRINT*,NORM2(DIC)
                        !PRINT *,RCM3
                        !PRINT*,MATMUL(RCM3,ISLATORIG)
                        !CALL DISTANCEP(IT3,RCM,NINDEX,VVVOL)
                        !PRINT 1245,NINDEX-96,VVVOL
        
                        CALL CAREA2022(IT3,ATMID(ID1),ATMID(ID2),ATMID(ID3),AR1(ID5))
                        INDTRI(ID5,:)=(/ATMID(ID1),ATMID(ID2),ATMID(ID3)/)
                        !PRINT 1245,INDTRI(ID5,:)-96,AR1(ID5),NORM2(DIC)
                        !CALL CCCVOLUME2022(IT3,RCM,NINDEX(1),NINDEX(2),NINDEX(3),VVVOL)
                        1245 FORMAT(3I8,2F15.5)

                        !VTOT=VTOT+VVVOL
                        END DO
                        END DO
                        END DO
                        !VTOT=ABS(VTOT)

!                        PRINT*,VTOT
!PAUSE
                        !CALL SORT(AR1,ID5,IISORT)
                        CALL SORT(DDIC,ID5,IISORT)
                        DO ID1=1,ID5
                        PRINT 258,DDIC(ID1),IISORT(ID1),INDTRI(IISORT(ID1),:)-96
                        END DO
                        258 FORMAT(F15.5,I7,3I10)
!VTOT=0
!                        DO ID1=1,8
!                        NINDEX=(/INDTRI(IISORT(ID1),1),INDTRI(IISORT(ID1),2),INDTRI(IISORT(ID1),3)/)
!                        CALL CCCVOLUME2022(IT3,RCM,NINDEX(1),NINDEX(2),NINDEX(3),VVVOL)
!                                PRINT*,VVVOL !TOT
!                        VTOT=VTOT+VVVOL
!                        END DO
                        

END SUBROUTINE



SUBROUTINE SORT(ARR,NNNN,ISORT)
        USE IFPORT
        IMPLICIT NONE

INTEGER::NNNN,INNN
DOUBLE PRECISION,DIMENSION(NNNN)::ARR
DOUBLE PRECISION,DIMENSION(NNNN)::BRR
INTEGER,DIMENSION(NNNN)::ISORT
INTEGER::IISRT
ISORT=1000
BRR=0.0D0
!DO INNN=1,NNNN
!PRINT*,BRR(INNN) !,ISORT(INNN)
!END DO
DO INNN=1,NNNN

ISORT(INNN)=MINLOC(ARR,DIM=1,MASK=ARR.GT.0.01)
!ISORT(INNN)=IISRT
BRR(INNN)=MINVAL(ARR,DIM=1,MASK=ARR.GT.0.01)
ARR(MINLOC(ARR,DIM=1,MASK=ARR.GT.0.01))=0.0D0
END DO
ARR=0
WHERE(BRR.GT.10.0)ISORT=1000
WHERE(BRR.GT.10.0)BRR=0
ARR(1:NNNN)=BRR(1:NNNN)

!DO INNN=1,6 
!PRINT*,BRR(INNN),ISORT(INNN)
!END DO

END SUBROUTINE


SUBROUTINE CENTRE(IT3,ID1,ID2,ID3,ID4,ID5,ID6,RRCM)
use omp_lib
USE VARIABLES1, only :POS,SLATORIG,ISLATORIG !,INDTRI
IMPLICIT NONE
INTEGER::IT3,ID1,ID2,ID3,ID4,ID5,ID6,ID7 !IFREE
DOUBLE PRECISION,DIMENSION(3)::RRCM
DOUBLE PRECISION,DIMENSION(6,3)::PP
!DO ID7=1,6

PP(1,:)=MATMUL(POS(IT3,ID1,:),ISLATORIG)
PP(2,:)=MATMUL(POS(IT3,ID2,:),ISLATORIG)
PP(3,:)=MATMUL(POS(IT3,ID3,:),ISLATORIG)
PP(4,:)=MATMUL(POS(IT3,ID4,:),ISLATORIG)
PP(5,:)=MATMUL(POS(IT3,ID5,:),ISLATORIG)
PP(6,:)=MATMUL(POS(IT3,ID6,:),ISLATORIG)
WHERE(PP(1,:).GT.0.5)PP(1,:)=PP(1,:)-1
WHERE(PP(2,:).GT.0.5)PP(2,:)=PP(2,:)-1
WHERE(PP(3,:).GT.0.5)PP(3,:)=PP(3,:)-1
WHERE(PP(4,:).GT.0.5)PP(4,:)=PP(4,:)-1
WHERE(PP(5,:).GT.0.5)PP(5,:)=PP(5,:)-1
WHERE(PP(6,:).GT.0.5)PP(6,:)=PP(6,:)-1

WHERE(PP(1,:).LT.-0.5)PP(1,:)=PP(1,:)+1
WHERE(PP(2,:).lT.-0.5)PP(2,:)=PP(2,:)+1
WHERE(PP(3,:).lT.-0.5)PP(3,:)=PP(3,:)+1
WHERE(PP(4,:).lT.-0.5)PP(4,:)=PP(4,:)+1
WHERE(PP(5,:).lT.-0.5)PP(5,:)=PP(5,:)+1
WHERE(PP(6,:).lT.-0.5)PP(6,:)=PP(6,:)+1


!END DO
RRCM=PP(1,:)+ PP(2,:) + PP(3,:) + PP(4,:) + PP(5,:) + PP(6,:)
RRCM=RRCM/6.0 
!WHERE(RRCM.LT.-0.5)RRCM=RRCM+1
!WHERE(RRCM.GT.0.5)RRCM=RRCM-1
RRCM=MATMUL(RRCM,SLATORIG)
END SUBROUTINE 



SUBROUTINE CCCVOLUME2022(IT2,RRCM,I2,I3,I4,volumec)
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,I2,I3,I4,IT2
DOUBLE PRECISION,DIMENSION(3)::AD,BD,CD,BDCROSSCD
DOUBLE PRECISION::AREAc,ttheta,volumec
INTEGER::TI,TJ,TK
DOUBLE PRECISION,DIMENSION(3)::RRCM
AD=MATMUL( POS(IT2,I2,:)-RRCM,ISLATORIG)
BD=MATMUL( POS(IT2,I3,:)-RRCM,ISLATORIG)
CD=MATMUL( POS(IT2,I4,:)-RRCM,ISLATORIG)
where(AD.GE.0.5)AD=AD-1
where(BD.GE.0.5)BD=BD-1
where(CD.GE.0.5)CD=CD-1
where(AD.LE.-0.5)AD=AD+1
where(BD.LE.-0.5)BD=BD+1
where(CD.LE.-0.5)CD=CD+1
AD=MATMUL(AD,SLATORIG)
BD=MATMUL(BD,SLATORIG)
CD=MATMUL(CD,SLATORIG)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!
DO TI=1,3
TJ=TI+1
TK=TI+2
IF(TJ.GT.3)TJ=TJ-3
IF(TK.GT.3)TK=TK-3
BDCROSSCD(TI)=BD(TJ)*CD(TK)-BD(TK)*CD(TJ)
END DO
!!!!!!!!!!!!!!!!!!!!!!!!!!
!volumec=ABS(DOT_PRODUCT(AD,BDCROSSCD))/6 !norm2(AB)*norm2(AC)*sin(ttheta)
volumec=DOT_PRODUCT(AD,BDCROSSCD)/6 !norm2(AB)*norm2(AC)*sin(ttheta)
print*,volumec
end subroutine
!



SUBROUTINE DISTANCEP(IT2,RM,NNINDEX,RC5)
use omp_lib
USE VARIABLES1, only :POS,SLATORIG,ISLATORIG !,INDTRI
IMPLICIT NONE
INTEGER::IT2,TI,TJ,TK
INTEGER,DIMENSION(3):: NNINDEX !!IFREE
DOUBLE PRECISION,DIMENSION(3)::AD,BD,CD,BDCROSSCD,RM
DOUBLE PRECISION::AREAc,ttheta,volumec
DOUBLE PRECISION::RC5,D0 
BD=MATMUL( POS(IT2,NNINDEX(1),:)-POS(IT2,NNINDEX(3),:),ISLATORIG)
CD=MATMUL( POS(IT2,NNINDEX(2),:)-POS(IT2,NNINDEX(3),:),ISLATORIG)
where(BD.GE.0.5)BD=BD-1
where(CD.GE.0.5)CD=CD-1
where(BD.LE.-0.5)BD=BD+1
where(CD.LE.-0.5)CD=CD+1
BD=MATMUL(BD,SLATORIG)
CD=MATMUL(CD,SLATORIG)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!
DO TI=1,3
TJ=TI+1
TK=TI+2
IF(TJ.GT.3)TJ=TJ-3
IF(TK.GT.3)TK=TK-3
BDCROSSCD(TI)=BD(TJ)*CD(TK)-BD(TK)*CD(TJ)
END DO
!PRINT*,NNINDEX
!PRINT*,POS(IT2,NNINDEX(1),:) !BDCROSSCD
!PRINT*,POS(IT2,NNINDEX(2),:) !BDCROSSCD
!PRINT*,POS(IT2,NNINDEX(3),:) !BDCROSSCD
D0=-NORM2(BDCROSSCD*POS(IT2,NNINDEX(3),:))
!PRINT*,BDCROSSCD/D0
!PAUSE


RC5=DOT_PRODUCT(BDCROSSCD,RM)+D0
RC5=RC5/NORM2(BDCROSSCD)
END SUBROUTINE





SUBROUTINE CENTRE3(IT3,NNINDEX,RRCM)
use omp_lib
USE VARIABLES1, only :POS,SLATORIG,ISLATORIG !,INDTRI
IMPLICIT NONE
INTEGER,DIMENSION(3):: NNINDEX !!IFREE
INTEGER::IT3,ID1,ID2,ID3,ID4,ID5,ID6,ID7 !IFREE
DOUBLE PRECISION,DIMENSION(3)::RRCM
DOUBLE PRECISION,DIMENSION(6,3)::PP
!DO ID7=1,6

PP(1,:)=MATMUL(POS(IT3,NNINDEX(1),:),ISLATORIG)
PP(2,:)=MATMUL(POS(IT3,NNINDEX(2),:),ISLATORIG)
PP(3,:)=MATMUL(POS(IT3,NNINDEX(3),:),ISLATORIG)
WHERE(PP(1,:).GT.0.5)PP(1,:)=PP(1,:)-1
WHERE(PP(2,:).GT.0.5)PP(2,:)=PP(2,:)-1
WHERE(PP(3,:).GT.0.5)PP(3,:)=PP(3,:)-1

WHERE(PP(1,:).LT.-0.5)PP(1,:)=PP(1,:)+1
WHERE(PP(2,:).lT.-0.5)PP(2,:)=PP(2,:)+1
WHERE(PP(3,:).lT.-0.5)PP(3,:)=PP(3,:)+1


!END DO
RRCM=PP(1,:)+ PP(2,:) + PP(3,:)
RRCM=RRCM/3.0 
RRCM=MATMUL(RRCM,SLATORIG)
END SUBROUTINE 

SUBROUTINE SORTERNN(IT3,IDD1,IDD2,IDD3,IDD4,IDD5,IDD6,VTOT)
use omp_lib
USE VARIABLES1, only :POS,SLATORIG,ISLATORIG
IMPLICIT NONE
INTEGER::IT3,ID1,ID2,ID3,ID4,ID5,ID6 !IFREE
INTEGER::IDD1,IDD2,IDD3,IDD4,IDD5,IDD6 !IFREE
INTEGER,DIMENSION(1000,6)::INDEXER
DOUBLE PRECISION,DIMENSION(6,3)::cord !NNTYPE(IIFREE),3)::DRT
DOUBLE PRECISION,DIMENSION(1000)::VVOL
DOUBLE PRECISION,DIMENSION(12)::RDI !VVOL
DOUBLE PRECISION::VVVOL,VTOT,RMAX
INTEGER::JMIN,JJMIN
INTEGER,DIMENSION(6)::ATMID,AATMID
INTEGER,DIMENSION(12,2)::PAIR
DOUBLE PRECISION,DIMENSION(3)::DDDDD
ATMID=(/IDD1,IDD2,IDD3,IDD4,IDD5,IDD6/)
VVOL=0
VTOT=0
VVVOL=0
ID5=0
DDDDD=0

DO ID1=1,6
!PRINT*, POS(IT3,ATMID(ID1),:)

DDDDD=MATMUL(POS(IT3,ATMID(ID1),:)-POS(IT3,ATMID(1),:),ISLATORIG)
where(DDDDD.LT.-0.5)DDDDD=DDDDD+1
where(DDDDD.GT. 0.5)DDDDD=DDDDD-1
AATMID(ID1)=ATMID(ID1)
DDDDD=MATMUL(DDDDD,SLATORIG)
RDI(ID1)=NORM2(DDDDD)
END DO
RMAX=MAXVAL(RDI,DIM=1)
ID2=0
DO ID1=1,6
IF(RDI(ID1).LT.RMAX.AND.RDI(ID1).GE.0.00001)THEN
ID2=ID2+1
INDEXER(1,ID2)=ATMID(ID1)
END IF        
END DO
!PAUSE
                        JMIN=1
                        CORD(1,:)=MATMUL(POS(IT3,INDEXER(JMIN,1),:),ISLATORIG)
                        CORD(2,:)=MATMUL(POS(IT3,INDEXER(JMIN,2),:),ISLATORIG)
                        CORD(3,:)=MATMUL(POS(IT3,INDEXER(JMIN,3),:),ISLATORIG)
                        CORD(4,:)=MATMUL(POS(IT3,INDEXER(JMIN,4),:),ISLATORIG)
                        !CORD(4,:)=MATMUL(POS(IT3,INDEXER(JMIN,4),:),ISLATORIG)
                        !CALL CVOLUME2022(IT3,INDEXER(JMIN,1),INDEXER(JMIN,2),INDEXER(JMIN,3),INDEXER(JMIN,4),VVVOL)
                        !PRINT*,'COM',VVVOL
                        ID2=4
                        DO ID1=1,6
                        IF(ANY(INDEXER(JMIN,:).eq.ATMID(ID1)).eq..FALSE.)THEN
                        ID2=ID2+1
                        INDEXER(JMIN,ID2)=ATMID(ID1)
                        !PRINT*,ID2,ATMID(ID1)
                        !PRINT*,ID2
                        CORD(ID2,:)=MATMUL(POS(IT3,ATMID(ID1),:),ISLATORIG)
                        END IF
                        END DO


DO ID1=2,6
where((CORD(ID1,:)-CORD(1,:)).LE.-0.5)CORD(ID1,:)=CORD(ID1,:)+1 !=MATMUL
where((CORD(ID1,:)-CORD(1,:)).GE. 0.5)CORD(ID1,:)=CORD(ID1,:)-1 !=MATMUL
END DO











                        
                        DO ID1=1,4
                           DO ID2=ID1+1,4
                           ID5=ID5+1
                           DDDDD=CORD(ID1,:)-CORD(ID2,:)
                           WHERE(DDDDD.LT.-0.5)DDDDD=DDDDD+1.0
                           WHERE(DDDDD.GT.0.5)DDDDD=DDDDD-1.0
                           RDI(ID5)= NORM2(MATMUL( DDDDD,SLATORIG))
                           PAIR(ID5,1)= INDEXER(JMIN,ID1)            !ATMID(ID1)
                           PAIR(ID5,2)= INDEXER(JMIN,ID2)             !ATMID(ID2)
                           END DO
                        END DO
                        JJMIN=maxloc(RDI(1:ID5),DIM=1,MASK=RDI.LT.4.0)
                        PRINT 2356,PAIR(JJMIN,:)-96,RDI(JJMIN),RDI(1:ID5)
                        2356 FORMAT(2I6,F10.4,4x,100F10.4)
!                        PRINT*,RDI
!
!                        PAUSE




!PRINT*,INDEXER(1,:) 
DO ID1=5,6
AATMID(1)=INDEXER(1,ID1) ! PAIR(JJMIN,ID1)
AATMID(2)=PAIR(JJMIN,1)
AATMID(3)=PAIR(JJMIN,2)
DO ID2=1,4
          IF(ANY(INDEXER(JMIN,ID2).EQ.PAIR(JJMIN,:)).EQ..FALSE.)THEN
          AATMID(4)=INDEXER(JMIN,ID2)
 CALL CVOLUME2022(IT3,AATMID(1),AATMID(2),AATMID(3),AATMID(4),VVVOL)
 VTOT=VTOT+VVVOL
 PRINT 259,IT3,AATMID(1)-96,AATMID(2)-96,AATMID(3)-96,AATMID(4)-96,VVVOL
          END IF
259 FORMAT(I8,4I9,F10.5)
 ENDDO
END DO

!pause
!ID3=0
!DO ID1=1,2
!     DO ID2=5,6
!     ID3=ID3+1
!     AATMID(1)=PAIR(JJMIN,ID1)
!          ID5=1
!          DO ID4=1,4
!          IF(ANY(INDEXER(JMIN,ID4).EQ.PAIR(JJMIN,:)).EQ..FALSE.)THEN
!          ID5=ID5+1
!          AATMID(ID5)=INDEXER(JMIN,ID4)
!          END IF
!          END DO
!    AATMID(4)=INDEXER(JMIN,ID2)
!!PRINT 125,AATMID(1:4)
!125 FORMAT(6I6)
!!PAUSE
! CALL CVOLUME2022(IT3,AATMID(1),AATMID(2),AATMID(3),AATMID(4),VVVOL)
! VTOT=VTOT+VVVOL
!PRINT 259,IT3,AATMID(1)-96,AATMID(2)-96,AATMID(3)-96,AATMID(4)-96,VVVOL
!259 FORMAT(I8,4I9,F10.5)
! END DO
!     END DO
!PRINT*,VTOT
END SUBROUTINE




SUBROUTINE SORTER4(IT3,IDD1,IDD2,IDD3,IDD4,IDD5,IDD6,VTOT)
use omp_lib
USE VARIABLES1, only :POS,SLATORIG,ISLATORIG,INDTRI
IMPLICIT NONE
INTEGER::IT3,ID1,ID2,ID3,ID4,ID5,ID6 !IFREE
INTEGER::IDD1,IDD2,IDD3,IDD4,IDD5,IDD6 !IFREE
INTEGER,DIMENSION(1000,6)::INDEXER
DOUBLE PRECISION,DIMENSION(6,3)::cord !NNTYPE(IIFREE),3)::DRT
DOUBLE PRECISION,DIMENSION(1000)::VVOL
DOUBLE PRECISION,DIMENSION(12)::RDI !VVOL
DOUBLE PRECISION::VVVOL,VTOT
INTEGER::JMIN,JJMIN
INTEGER,DIMENSION(6)::ATMID,AATMID
INTEGER,DIMENSION(12,2)::PAIR
DOUBLE PRECISION,DIMENSION(20)::AR1
INTEGER,DIMENSION(20)::IISORT
DOUBLE PRECISION,DIMENSION(3)::RCM,RCM3
INTEGER,DIMENSION(3)::NINDEX


ATMID=(/IDD1,IDD2,IDD3,IDD4,IDD5,IDD6/)
VVOL=0
VTOT=0
VVVOL=0
ID5=0
AR1=0
INDTRI=0

PRINT*,'I AM IN SORTERN'
                        CALL CENTRE(IT3,ATMID(1),ATMID(2),ATMID(3),ATMID(4),ATMID(5),ATMID(6),RCM)

VTOT=0
                        DO ID1=1,5
                        NINDEX=(/ATMID(ID1),ATMID(ID2),ATMID(ID3)/)
                        !PRINT*,NINDEX-96
                        !CALL CENTRE3(IT3,NINDEX,RCM3)
                        !PRINT *,RCM3
                        !PRINT*,MATMUL(RCM3,ISLATORIG)
                        !CALL DISTANCEP(IT3,RCM,NINDEX,VVVOL)
                        !PRINT 1245,NINDEX-96,VVVOL
        
                        !CALL CAREA2022(IT3,ATMID(ID1),ATMID(ID2),ATMID(ID3),AR1(ID5))
                        !INDTRI(ID5,:)=(/ATMID(ID1),ATMID(ID2),ATMID(ID3)/)
                        !CALL CCCVOLUME2022(IT3,RCM,NINDEX(1),NINDEX(2),NINDEX(3),VVVOL)
                        1245 FORMAT(3I8,F15.5)

                        !VTOT=VTOT+VVVOL
                        !END DO
                        !END DO
                        END DO
                        !VTOT=ABS(VTOT)

!                        PRINT*,VTOT
!PAUSE
                        !CALL SORT(AR1,ID5,IISORT)
                        !DO ID1=1,ID5
                        !PRINT 258,AR1(ID1),IISORT(ID1),INDTRI(IISORT(ID1),:)-96
                        !END DO
                        !258 FORMAT(F15.5,I7,3I10)
!VTOT=0
!                        DO ID1=1,8
!                        NINDEX=(/INDTRI(IISORT(ID1),1),INDTRI(IISORT(ID1),2),INDTRI(IISORT(ID1),3)/)
!                        CALL CCCVOLUME2022(IT3,RCM,NINDEX(1),NINDEX(2),NINDEX(3),VVVOL)
!                                PRINT*,VVVOL !TOT
!                        VTOT=VTOT+VVVOL
!                        END DO
                        

END SUBROUTINE

SUBROUTINE SORTERMAYA(IT3,IDD1,IDD2,IDD3,IDD4,IDD5,IDD6,VTOT)
use omp_lib
USE VARIABLES1, only :POS,SLATORIG,ISLATORIG
IMPLICIT NONE
INTEGER::IT3,ID1,ID2,ID3,ID4,ID5,ID6 !IFREE
INTEGER::IDD1,IDD2,IDD3,IDD4,IDD5,IDD6 !IFREE
INTEGER,DIMENSION(1000,6)::INDEXER
DOUBLE PRECISION,DIMENSION(6,3)::cord !NNTYPE(IIFREE),3)::DRT
DOUBLE PRECISION,DIMENSION(1000)::VVOL
INTEGER ,DIMENSION(1000,2)::IVV
DOUBLE PRECISION,DIMENSION(12)::RDI !VVOL
DOUBLE PRECISION::VVVOL,VTOT,RMAX
INTEGER::JMIN,JJMIN
INTEGER,DIMENSION(6)::ATMID,AATMID
INTEGER,DIMENSION(12,2)::PAIR
DOUBLE PRECISION,DIMENSION(3)::DDDDD,RCM,AB,AC,AD
DOUBLE PRECISION::TH1,TH2,TH3 
ATMID=(/IDD1,IDD2,IDD3,IDD4,IDD5,IDD6/)
VVOL=0
VTOT=0
VVVOL=0
ID5=0
DDDDD=0
RCM=0
IVV=0

        !                CALL CENTRE(IT3,ATMID(1),ATMID(2),ATMID(3),ATMID(4),ATMID(5),ATMID(6),RCM)
        !                PRINT*,IT3, MATMUL(RCM,ISLATORIG)
                        !PAUSE

                        
                        
DO ID1=1,6
DO ID2=1,6
ID5=ID5+1
DDDDD=MATMUL(POS(IT3,ATMID(ID1),:)-POS(IT3,ATMID(ID2),:),ISLATORIG)
where(DDDDD.LT.-0.5)DDDDD=DDDDD+1
where(DDDDD.GT. 0.5)DDDDD=DDDDD-1
!AATMID(ID1)=ATMID(ID1)
DDDDD=MATMUL(DDDDD,SLATORIG)
VVOL(ID5)=NORM2(DDDDD)
IVV(ID5,1)=ATMID(ID1)
IVV(ID5,2)=ATMID(ID2)
!print*,VVOL(ID5)
END DO
END DO

AATMID=0
!AATMID(1)=IVV(MAXLOC(VVOL,DIM=1),1)
!AATMID(2)=IVV(MAXLOC(VVOL,DIM=1),2)
INDEXER(1,1)=IVV(MAXLOC(VVOL,DIM=1),1) !AATMID(1)
INDEXER(1,2)=IVV(MAXLOC(VVOL,DIM=1),2) !AATMID(2)
vvol=0
ID5=2
DO ID1=1,6
        IF(ANY(ATMID(ID1).EQ.INDEXER(1,1:2)).EQ..FALSE.)THEN
        ID5=ID5+1
        !AATMID(ID5)=ATMID(ID5)
        INDEXER(1,ID5)=ATMID(ID1)
        END IF        
END DO
!PRINT*,INDEXER(1,:) !AATMID
!PAUSE
!
!
!
!
JMIN=1
                        CORD(1,:)=MATMUL(POS(IT3,INDEXER(JMIN,1),:),ISLATORIG)
                        CORD(2,:)=MATMUL(POS(IT3,INDEXER(JMIN,2),:),ISLATORIG)
                        CORD(3,:)=MATMUL(POS(IT3,INDEXER(JMIN,3),:),ISLATORIG)
                        CORD(4,:)=MATMUL(POS(IT3,INDEXER(JMIN,4),:),ISLATORIG)
                        CORD(5,:)=MATMUL(POS(IT3,INDEXER(JMIN,5),:),ISLATORIG)
                        CORD(6,:)=MATMUL(POS(IT3,INDEXER(JMIN,6),:),ISLATORIG)
DO ID1=2,6
where((CORD(ID1,:)-CORD(1,:)).LE.-0.5)CORD(ID1,:)=CORD(ID1,:)+1 !=MATMUL
where((CORD(ID1,:)-CORD(1,:)).GE. 0.5)CORD(ID1,:)=CORD(ID1,:)-1 !=MATMUL
END DO



!!!!!!!!!!!!!!!!!!!!!!!!!!!!FINIDING DIAGONAL !!!!!!!!!!!!!!!!!!!!!!!
!FIND AREA FROM FOUR POINTS
!DO ID1=1,3
!ID2=ID1+1
!IF (ID2.GT.3)ID2=ID2-3
!RXY(1,:)=(/CORD(3,ID1),CORD(3,ID2)/)
!RXY(2,:)=(/CORD(4,ID1),CORD(4,ID2)/)
!RXY(3,:)=(/CORD(5,ID1),CORD(5,ID2)/)
!RXY(4,:)=(/CORD(6,ID1),CORD(6,ID2)/)
!CALL AREA2D(RXY,AR2)
!
!END DO






!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

!GOTO 444

                        RDI=0
                        ID5=0
                        DO ID1=3,6
                           DO ID2=ID1+1,6
                           ID5=ID5+1
                           DDDDD=CORD(ID1,:)-CORD(ID2,:)
                           WHERE(DDDDD.LT.-0.5)DDDDD=DDDDD+1.0
                           WHERE(DDDDD.GT.0.5)DDDDD=DDDDD-1.0
                           RDI(ID5)= NORM2(MATMUL( DDDDD,SLATORIG))
                           PAIR(ID5,1)= INDEXER(1,ID1)            !ATMID(ID1)
                           PAIR(ID5,2)= INDEXER(1,ID2)             !ATMID(ID2)
                           END DO
                        END DO
                        JJMIN=maxloc(RDI(1:ID5),DIM=1)
                  !      PRINT 2356,INDEXER(1,1),PAIR(JJMIN,:)-96,RDI(1:ID5)
                        2356 FORMAT(2I6,100F10.4)
!                        PRINT*,RDI

                        AB=MATMUL(POS(IT3,PAIR(JJMIN,1),:)-POS(IT3,PAIR(JJMIN,2),:),ISLATORIG)
                        WHERE(AB.LT.-0.5)AB=AB+1 !=MATMUL(POS(IT3,PAIR(JJMIN,1),:)-POS(IT3,PAIR(JJMIN,2),:),ISLATORIG)
                        WHERE(AB.GT. 0.5)AB=AB-1 !=MATMUL(POS(IT3,PAIR(JJMIN,1),:)-POS(IT3,PAIR(JJMIN,2),:),ISLATORIG)
                        AB=MATMUL(AB,SLATORIG)
                        !PRINT*,AB

                        !PAUSE






!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!COUNTING TETRA
!PRINT*,INDEXER(1,:) 
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!COUNTING TRAINGLESSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSSS
DO ID1=1,2
AATMID(1)=INDEXER(1,ID1) ! PAIR(JJMIN,ID1)
DO ID2=1,2

        AATMID(2)=PAIR(JJMIN,ID2)
         DO ID3=3,6
          IF(ANY(INDEXER(1,ID3).EQ.PAIR(JJMIN,:)).EQ..FALSE.)THEN
          AATMID(3)=INDEXER(1,ID3)
!          CALL CVOLUME2022(IT3,AATMID(1),AATMID(2),AATMID(3),AATMID(4),VVVOL)
!          VTOT=VTOT+VVVOL
!          PRINT 259,IT3,AATMID(1)-96,AATMID(2)-96,AATMID(3)-96,AATMID(4)-96,VVVOL
          !PRINT*,AATMID(1:3)
          END IF
         END DO

         !PAUSE          
259 FORMAT(I8,4I9,F10.5)


ENDDO
ENDDO
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

!        PAUSE

!444  CONTINUE









GOTO 125
AB=MATMUL(CORD(4,:)-CORD(3,:),SLATORIG)
AC=MATMUL(CORD(5,:)-CORD(3,:),SLATORIG)
AD=MATMUL(CORD(6,:)-CORD(3,:),SLATORIG)

CALL CROSSPR(AB,AC,TH1)
CALL CROSSPR(AB,AD,TH2)
CALL CROSSPR(AC,AD,TH3)
!CALL CROSSPR(AB,AC,TH1)
!TABAC=DOT_PRODUCT(AB,AC)/(NORM2(AB)*NORM2(AC))
PRINT*,TH1,TH2,TH3
PAUSE
125 CONTINUE 
END SUBROUTINE


SUBROUTINE CROSSPR(VEC1,VEC2,THH)
IMPLICIT NONE
DOUBLE PRECISION,DIMENSION(3)::VEC1,VEC2,VEC3
INTEGER::TI,TJ,TK
DOUBLE PRECISION::THH

DO TI=1,3
TJ=TI+1
TK=TI+2
IF(TJ.GT.3)TJ=TJ-3
IF(TK.GT.3)TK=TK-3
VEC3(TI)=VEC1(TJ)*VEC2(TK)-VEC1(TK)*VEC2(TJ)
END DO

THH=ASIN(NORM2(VEC3)/(NORM2(VEC1)*NORM2(VEC2)))
END SUBROUTINE




SUBROUTINE JAYGURUDEV(IT3,IDD1,IDD2,IDD3,IDD4,IDD5,IDD6)
use omp_lib
!#USE IFPORT
USE VARIABLES1, only :POS,SLATORIG,ISLATORIG
IMPLICIT NONE
INTEGER::IT3,ID1,ID2,ID3,ID4,ID5,ID6 !IFREE
INTEGER::IDD1,IDD2,IDD3,IDD4,IDD5,IDD6 !IFREE
DOUBLE PRECISION,DIMENSION(6,3)::cord !NNTYPE(IIFREE),3)::DRT
DOUBLE PRECISION,DIMENSION(1000)::VVOL
DOUBLE PRECISION,DIMENSION(12)::RDI !VVOL
DOUBLE PRECISION::VVVOL,VTOT,RMAX
INTEGER::JMIN,JJMIN
INTEGER,DIMENSION(6)::ATMID,AATMID
INTEGER,DIMENSION(12,2)::PAIR
DOUBLE PRECISION,DIMENSION(3)::DDDDD
LOGICAL(4) result
ATMID=(/IDD1,IDD2,IDD3,IDD4,IDD5,IDD6/)
VVOL=0
VTOT=0
VVVOL=0
ID5=0
DDDDD=0


!PRINT 1258,IT3,ATMID
1258 FORMAT(8I7)
DO ID1=1,6
CORD(ID1,:)=MATMUL(POS(IT3,ATMID(ID1),:),ISLATORIG)
END DO
DO ID1=2,6
DDDDD=CORD(ID1,:)-CORD(1,:)
where(DDDDD.LT.-0.5)CORD(ID1,:)=CORD(ID1,:)+1
where(DDDDD.GT. 0.5)CORD(ID1,:)=CORD(ID1,:)-1
END DO

!print*,IT3
!result=SYSTEMQQ('rm fort.12589')
OPEN(12589,file='data')
write(12589,125)'3 rbox x 6'
125 FORMAT(A10)
write(12589,*)'6'

DO ID1=1,6
CORD(ID1,:)=MATMUL(CORD(ID1,:),SLATORIG)
WRITE(12589,*)CORD(ID1,:)
!
!3 rbox x 6
!6
!   12.1931000000000        1.87292000000000        5.60267000000000
!   11.4865000000000        1.66673000000000        1.10421000000000
!   15.7777804500000        1.05416000000000        1.42719000000000
!   16.3578504500000        1.70750000000000        5.72365000000000
!   14.8360204500000       -2.27210045000000        4.37531000000000
!   12.5138000000000       -2.31570045000000        2.14421000000000

!PRINT*,CORD(ID1,:)
END DO
!PRINT*
!result= SYSTEMQQ ("qconvex FA <data |tail -2|awk '{print $3}' >vol")
CALL SYSTEMQQ('sh run')
close(12589)
!PAUSE
END SUBROUTINE

SUBROUTINE RESIDENCE_FINAL
!RADIUS BASED ANALYSIS
use omp_lib
USE VARIABLES1
IMPLICIT NONE
INTEGER::I1,I2,J1,J2,K1,K2,ITH
INTEGER::II,JJ,KK
REAL::T2,T1
DOUBLE PRECISION,DIMENSION(3)::AA
REAL::RIJ,RJK
INTEGER::NC1,NC2
INTEGER::NCORD1,NCORD2,NK
REAL,DIMENSION(12)::ANGLEI
INTEGER::RBIN,TBIN
INTEGER,ALLOCATABLE,DIMENSION(:,:)::PICK,IPICK,IIPICK,OCCC
INTEGER::ISPACE,L
REAL::TST
DOUBLE PRECISION::VOL
INTEGER::CCAGE,SCAGE
REAL::RCAGE
REAL::XMAX,YMAX,ZMAX,XMIN,YMIN,ZMIN
DOUBLE PRECISION,DIMENSION(3,3)::DAB
INTEGER::JK,ISEL
DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:,:)::CENTRE,RPICK,RRPICK,DMATRIX
INTEGER::NCENTRE,STA
DOUBLE PRECISION,allocatable,DIMENSION(:,:,:)::AB
DOUBLE PRECISION,DIMENSION(3)::XX
REAL::RANG,DET
DOUBLE PRECISION,DIMENSION(3)::LOCAL
DOUBLE PRECISION::TOL1,TOL2
integer::jtag
integer,allocatable,dimension(:)::atmloc,patmloc,ppatmloc,njump,snjump
integer::ijump
DOUBLE PRECISION,DIMENSION(NATOM,3)::POSL !DMATRIX
double precision,DIMENSION(3)::rcm1,rcm2,rr
double precision,dimension(natom,3)::P1,P2,P3
double precision,dimension(natom)::rjump,rjump2
double precision,allocatable,dimension(:,:)::RSE
double precision,allocatable,dimension(:)::RRD
double precision,allocatable,dimension(:,:)::rd
                double precision,dimension(3)::dsecui,ddr
                integer::ise
                integer,allocatable,dimension(:)::timer !pprmincuseindx
                double precision::RTOT,RTOT2,RTOT3
                double precision,dimension(0:100):: RRTOT,RRTOT2
                integer::rind
                INTEGER,ALLOCATABLE,DIMENSION(:)::ATMJUMP
                DOUBLE PRECISION,ALLOCATABLE,DIMENSION(:)::RATMJUMP
                INTEGER::NTOTJ
NCENTRE=NTETRA
SCAGE=3
CCAGE=ITETRA!!!!!Cu ions at centre of the cage
allocate(rse(NNTYPE(ccage),3))
OPEN(23,FILE="SITE_OCC_ATM")
OPEN(24,FILE="SITE_OCC")
OPEN(25,FILE="SITE_SEL_ATM")
OPEN(26,FILE="JUMP_EVENT_ATM")
OPEN(27,FILE="JUMP_EVENT_INTRCLUSTER")
OPEN(28,FILE="JUMP_DST_P1_P2")
OPEN(29,FILE="JUMP_DST_P1_P3")
OPEN(30,FILE="CAGE_Cu_DIS")
OPEN(131,FILE="JUMP_LENGTH_DISTRIBUTION")
RSE(:,:)=POS(1,SUM(NNTYPE(1:SCAGE-1))+1 :SUM(NNTYPE(1:SCAGE)),:)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!INPUT
rind=0
TOL1=0.0000000000000000000000000000
TOL2=1.d0
occc=0
RANG=0.5
PICK=0
IPICK=0
SNJUMP=0
RTOT=0
RTOT2=0
RRTOT=0
RRTOT2=0
NTOTJ=0

!RMINCHECK=1.0


ALLOCATE(PICK(NCENTRE,12),RPICK(NCENTRE,12),RRPICK(NCENTRE,12),IIPICK(NCENTRE,12),IPICK(NCENTRE,12),CENTRE(NCENTRE,3),AB(NCENTRE,3,3),OCCC(NATOM,NCENTRE))
ALLOCATE(ATMLOC(NATOM),PATMLOC(NATOM),PPATMLOC(NATOM),NJUMP(NATOM),SNJUMP(NATOM),ATMJUMP(NNTYPE(ITETRA)))
ALLOCATE(RATMJUMP(NNTYPE(ITETRA)))
!allocate(rd(NNTYPE(CCAGE),3))
allocate(rd(NCENTRE,3))
allocate(rrd(NCENTRE))
allocate(timer(NCENTRE))
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
OPEN(31,FILE="TETRA")
DO I=1,8
READ(31,*)
END DO

DO I=1,NCENTRE
READ(31,*)CENTRE(I,:)
END DO

PRINT*, "I M IN RESIDENCE2"
PI=4*ATAN(1.0)
ISPACE=NNTYPE(INDEX1(1,1))
ISEL=0

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
P1(:,:)=POS(1,:,:) !!!!!!!!!!!
DO IT=1,IREF2-IREF1+1
ATMLOC=0
RD=0
        JTAG=0
        ATMJUMP=0
        RATMJUMP=0
        DO J=SUM (NNTYPE(1:CCAGE -1 )) +1, SUM(NNTYPE(1:CCAGE))
                JTAG=JTAG+1
                IJUMP=0
                RD(1:NCENTRE,1:3)= CENTRE(1:NCENTRE,1:3) - SPREAD(MATMUL(POS(IT,J,:),ISLATORIG),1,NCENTRE)
!                WHERE(RD(1:NCENTRE,:).GT.0.5)RD=RD-NINT(RD) !1
!                WHERE(RD(1:NCENTRE,:).LT.-0.5)RD=RD+NINT(RD) !1
RD=RD-NINT(RD) 
RD=RD+NINT(RD)                        
RD=MATMUL(RD,SLATORIG)
                RRD=NORM2(RD,DIM=2)   !MATMUL(RD,SLATORIG)
                ATMLOC(JTAG)=MINLOC(RRD,DIM=1,MASK=RRD.LT.RMINCHECK)
                RATMJUMP(JTAG)=MINVAL(RRD,DIM=1,MASK=RRD.LT.RMINCHECK)
                
                !ATMLOC(JTAG)=MINLOC(RRD,DIM=1)
                !RATMJUMP(JTAG)=MINVAL(RRD,DIM=1)
                !IF(JTAG==1)PRINT*,RATMJUMP(JTAG)
                IF(IT.EQ.1.AND.ATMLOC(JTAG).NE.0)PATMLOC(JTAG)=ATMLOC(JTAG)
                IF(IT.GT.1.and.patmloc(jtag).ne.atmloc(jtag).and.ATMLOC(JTAG).ne.0.and.RATMJUMP(JTAG).LE.RMINCHECK)then
                timer(jtag)=timer(jtag)+1
                ATMJUMP(JTAG)=1 !#MINLOC(NORM2(RD,DIM=2),DIM=1)
                !RATMJUMP(JTAG)=MINVAL(NORM2(RD,DIM=2),DIM=1,MASK=NORM2(RD,DIM=2).LT.RMINCHECK)
                 !RATMJUMP(JTAG)=MINVAL(NORM2(RD,DIM=2),DIM=1,MASK=NORM2(RD,DIM=2).LT.RMINCHECK)
                 !IF(TIMER(JTAG).GT.10.AND.PATMLOC(JTAG).ne.ATMLOC(JTAG))THEN
                 !P3(J,:)=P2(J,:)
                 !P2(J,:)=P1(J,:)
                 !P1(J,:)=POS(IT,J,:)
                 !DDR=CENTRE(ATMLOC(JTAG),:)-CENTRE(PATMLOC(JTAG),:)
                 !WHERE(DDR.LE.-0.5)DDR=DDR+1
                 !WHERE(DDR.GE.0.5)DDR=DDR-1
                 !RJUMP(J)=NORM2(MATMUL(DDR,SLATORIG))
                 !RIND=INT(real(RJUMP(J))/0.1) !!!!!!!!!!!!!!!!!!!Binning with 0.1 Angstrom
                 !NJUMP(JTAG)=NJUMP(JTAG)+1
                 !RTOT=RTOT+RJUMP(J)
                 !IF(RIND.LE.100)RRTOT(RIND)=RRTOT(RIND)+1
                 PATMLOC(JTAG)=ATMLOC(JTAG)
                 !timer(jtag)=0
                 !end if
                end if
        END DO
        NTOTJ=NTOTJ+SUM(ATMJUMP)
        WRITE(1245,1245)REAL(DELT*IT),ATMLOC
        WRITE(1246,1245)REAL(DELT*IT),ATMJUMP
        WRITE(1247,1246)REAL(DELT*IT),RATMJUMP
        WRITE(1248,1245)REAL(DELT*IT),NTOTJ !+SUM(ATMJUMP)
        1245 FORMAT(F10.5,10000I5)
        1246 FORMAT(F10.5,1000F5.1)
                !N1=SUM(NNTYPE(1:ccage-1))+1
                !N2=SUM(NNTYPE(1:ccage))
                !WRITE(28,28)REAL(DELT*IT),RJUMP(N1:N2)
                !WRITE(29,28)REAL(DELT*IT),RJUMP2(N1:N2)
                !WRITE(30,28)REAL(DELT*IT),rmincuse      
                !WRITE(25,25)IT*DELT,ATMLOC(1:NNTYPE(CCAGE))
                !25 FORMAT(F10.5,10000I7)
                !28 FORMAT(F10.5,10000E12.5)
                !24 FORMAT(4I5,2x,3F10.5)
                !WRITE(26,26)IT*DELT,NJUMP(:)
                !26 FORMAT(F12.5,1000I5)
                !WRITE(27,26)IT*DELT,SNJUMP(:)-1
END DO

!        JTAG=0
!        DO J=SUM (NNTYPE(1:CCAGE -1 )) +1, SUM(NNTYPE(1:CCAGE))
!        JTAG=JTAG+1
!        DO I=1,ISEL
!        WRITE(23,323)J,I,REAL(OCCC(JTAG,I))/REAL(NSTEPORIG)
!        END DO
!        323 FORMAT(2I10,E12.5)
!        324 FORMAT(I10,E12.5)
!        END DO

!        DO I=1,ISEL
!        WRITE(24,324)I,REAL(SUM(OCCC(:,I)))/REAL(SUM(OCCC))
!        END DO

!        DO I=0,100
!        WRITE(131,31)0.1*REAL(I),RRTOT(I)/REAL(SUM(NJUMP))  !,RRTOT2(I)/REAL(SUM(SNJUMP)-NNTYPE(CCAGE))
!        31 FORMAT(F10.5,2F20.10)
!        END DO

!        PRINT*,'SUM OF inter-cluster JUMP',SUM(NJUMP)  !-NNTYPE(CCAGE)
!        PRINT*,'SUM OF inter-cluster JUMPLENGTHS',RTOT !,RTOT3
!        PRINT*,'AVG inter-cluster RESIDENCETIME',(NSTEPORIG*DELT)*NNTYPE(CCAGE)/SUM(NJUMP)  !-NNTYPE(CCAGE))


END SUBROUTINE


SUBROUTINE DIFFRACTIONT  !(R,SMAT2)
USE VARIABLES2
USE VARIABLES1
USE omp_lib
IMPLICIT NONE
INTEGER::NSKIP,intindex
complex,allocatable,dimension(:)::intens
double precision::deldmax,dmax,fwhmd
double precision,allocatable,dimension(:)::dummy1,dummy2
!OPEN(11,FILE="INP_STF")
INTEGER::IT3
PRINT*, "I M IN DIFFRACTIONT"
INTENSITY=0
21 FORMAT(3F20.5)
PI=4.0*ATAN(1.0)
INTDIM=(2*HMAX+1)*(2*KMAX+1)*(2*LMAX+1)
ALLOCATE(DHKL(INTDIM),QQ(INTDIM),INTENSITY(INTDIM))
ALLOCATE(HKL(INTDIM,3),FHKL(INTDIM))
ALAT=NORM2(AVGSLAT(1,:))
BLAT=NORM2(AVGSLAT(2,:))
CLAT=NORM2(AVGSLAT(3,:))
AANGLE(1)=DOT_PRODUCT(AVGSLAT(2,:),AVGSLAT(3,:))/(BLAT*CLAT)
AANGLE(2)=DOT_PRODUCT(AVGSLAT(3,:),AVGSLAT(1,:))/(CLAT*ALAT)
AANGLE(3)=DOT_PRODUCT(AVGSLAT(1,:),AVGSLAT(2,:))/(ALAT*BLAT)
!PRINT*,'STRUCTURE PARAMETERS'
!PRINT*,ALAT,BLAT,CLAT,180*ACOS(AANGLE)/PI
!PAUSE
DO I=1,NTYP
DO J=SUM(NNTYPE(1:I-1))+1,SUM(NNTYPE(1:I))
BB(J)=BBT(I) !/(4*PI))
END DO
END DO
NSKIP=10


INTENSITY=0
DO IT3=1,IREF2-IREF1+1,INTERVAL !,IREF2,NSKIP
PRINT*,'DIFFRACTION WILL BE CALUATED FOR', IT3 ! IREF1,'to',IREF2
II=0
DO H=-HMAX,HMAX
        DO K=-KMAX,KMAX
                DO L=-LMAX,LMAX
                        IF(ABS(H)+ABS(K)+ABS(L).NE.0)THEN
                        II=II+1
                        HKL(II,:)=(/REAL(H),REAL(K),REAL(L)/)
                        CALL DDHKL  !(HKL(II,:))
                        DHKL(II)=DPLANE
                        !$omp parallel do
                        DO I=1,NATOM
                                !RR1(I,:)=MATMUL(SUM(POS(1:IREF2-IREF1+1,I,:),DIM=1)/(IREF2-IREF1+1),ISLAT
                                !)
                                RR1(I,:)=MATMUL(POS(IT3,I,:),ISLATORIG )
                                PHI=2.0*PI*DOT_PRODUCT(RR1(I,:),HKL(II,:))
                                FHKL(II)=FHKL(II)+BB(I)*(CMPLX(COS(PHI),SIN(PHI)))
!/(IREF2-IREF1+1)
                        END DO
                        INTENSITY(II)=INTENSITY(II)+ABS(FHKL(II))**2
                        QCART=2.0*PI*MATMUL(HKL(II,:),ISLATORIG)
                        QQ(II)=NORM2(QCART)
                        2 FORMAT(1000(F16.4,1X))
                        END IF
                 END DO
        END DO
END DO
END DO

NMAX=II
deldmax=20.0/2000
ALLOCATE(intens(2000))
intens=0

DO II=1,NMAX
INTINDEX=INT(2000*DHKL(II)/20.0)
if(INTINDEX.le.2000)intens(intindex)=intens(intindex)+ABS(FHKL(II))**2
END DO

DO II=1,NMAX
IF(ABS(QQ(II)).GT.0.0001) WRITE(131,2) QQ(II),HKL(II,:), DHKL(II),FHKL(II),ABS(FHKL(II))**2 !INTENSITY(II)
END DO

ALLOCATE(DUMMY1(2000),DUMMY2(2000))
DUMMY1=intens
FWHMD=0.02
CALL BROAD_DIFF(FWHMD,DUMMY1,DUMMY2)
WRITE(130,*)'#Dhkl Qhkl I'


DO II=1,500
WRITE(130,2)II*deldmax,(2*PI/deldmax/II),DUMMY2(II) !REAL(intens(II))**2  !QQ(II),HKL(II,:), DHKL(II), FHKL(II), ABS(FHKL(II))**2 !INTENSITY(II)
END DO
CALL SYSTEMQQ('sort -r  -n -k 5 fort.131 >HKL')
END  SUBROUTINE



SUBROUTINE DIFFRACTIONTS  !(R,SMAT2)
USE VARIABLES2
USE VARIABLES1
USE omp_lib
IMPLICIT NONE
INCLUDE 'fftw3.f'

INTEGER::NSKIP,intindex
complex,allocatable,dimension(:)::intens
double precision::deldmax,dmax,fwhmd
double precision,allocatable,dimension(:)::dummy1,dummy2
complex*16,allocatable,dimension(:)::IQT
!OPEN(11,FILE="INP_STF")
INTEGER::IT3,NSTEP3
integer::plan,IFOR

NSTEP3=2**NPOW

OPEN(1130,FILE="DIFF_vs_T")

PRINT*, "I M IN DIFFRACTIONTS"
PRINT*,NSTEP

INTENSITY=0
21 FORMAT(3F20.5)
PI=4.0*ATAN(1.0)
INTDIM=(2*HMAX+1)*(2*KMAX+1)*(2*LMAX+1)
ALLOCATE(DHKL(INTDIM),QQ(INTDIM),INTENSITY(INTDIM))
ALLOCATE(HKL(INTDIM,3),FHKL(INTDIM))
ALLOCATE(IQT(NSTEP3))
ALAT=NORM2(AVGSLAT(1,:))
BLAT=NORM2(AVGSLAT(2,:))
CLAT=NORM2(AVGSLAT(3,:))
AANGLE(1)=DOT_PRODUCT(AVGSLAT(2,:),AVGSLAT(3,:))/(BLAT*CLAT)
AANGLE(2)=DOT_PRODUCT(AVGSLAT(3,:),AVGSLAT(1,:))/(CLAT*ALAT)
AANGLE(3)=DOT_PRODUCT(AVGSLAT(1,:),AVGSLAT(2,:))/(ALAT*BLAT)
DO I=1,NTYP
DO J=SUM(NNTYPE(1:I-1))+1,SUM(NNTYPE(1:I))
BB(J)=BBT(I) !/(4*PI))
END DO
END DO
NSKIP=10
PRINT*,'PROVIDE (HKL)?'
READ*,H,K,L
INTENSITY=0



IQT=0
IFOR=1

DO IT3=1,IREF2-IREF1+1 !,INTERVAL !,IREF2,NSKIP
!PRINT*,'DIFFRACTION WILL BE CALCULATED FOR', IT3 ! IREF1,'to',IREF2
II=1
                        HKL(II,:)=(/REAL(H),REAL(K),REAL(L)/)
                        !CALL DDHKL  !(HKL(II,:))
                        !DHKL(II)=DPLANE
                        FHKL=0
                        DO I=1,NATOM
                                RR1(I,:)=MATMUL(POS(IT3,I,:),ISLATORIG )
                                PHI=2.0*PI*DOT_PRODUCT(RR1(I,:),HKL(II,:))
                                FHKL(II)=FHKL(II)+BB(I)*(CMPLX(COS(PHI),SIN(PHI)))
!/(IREF2-IREF1+1)
                                !FHKL(II)=FHKL(II)+CMPLX(COS(PHI),SIN(PHI))
                                !!/(IREF2-IREF1+1)
                                !FHKL(II)=FHKL(II)+CMPLX(COS(PHI),SIN(PHI))
                                !!/(IREF2-IREF1+1)
                        END DO
                        !PRINT*,REAL(FHKL(1)),AIMAG(FHKL(1))
                        !PAUSE

                        INTENSITY(II)=ABS(FHKL(II))**2
                        IQT(IT3)=INTENSITY(II)
                        WRITE(1130,2)REAL(IT3)*DELT,INTENSITY(II)
!REAL(intens(II))**2  ! QQ(II),HKL(II,:), DHKL(II), FHKL(II), ABS(FHKL(II))**2
!!INTENSITY(II)
                        2 FORMAT(2E16.4,1X)
END DO
IQT(IT3:)=INTENSITY(II)

PRINT*,NSTEP3


        call dfftw_plan_dft_1d(plan,NSTEP3,IQT,IQT,IFOR,FFTW_ESTIMATE)
        call dfftw_execute_dft(plan, IQT,IQT)
        call dfftw_destroy_plan(plan)

        IQT=IQT/REAL(NSTEPORIG)
        DO DT=1,NSTEP3
        OMEGA=4.136*REAL((DT-1)/(DELT*NSTEP3))
        WRITE(1131,*)OMEGA,ABS(IQT(DT))
12 FORMAT(F10.6,E20.5)
        END DO
print *,'done!'
END  SUBROUTINE

